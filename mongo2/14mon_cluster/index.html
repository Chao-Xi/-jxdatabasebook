
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Database 技术与实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../13mon_perf/">
      
      
        <link rel="next" href="../15mon_goonline/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.2">
    
    
      
        <title>14 高级集群设计 - Jacob DataBase Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7bf56d0a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#14" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob DataBase Book" class="md-header__button md-logo" aria-label="Jacob DataBase Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob DataBase Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              14 高级集群设计
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxdatabasebook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxdatabasebook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob DataBase Book" class="md-nav__button md-logo" aria-label="Jacob DataBase Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob DataBase Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxdatabasebook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxdatabasebook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          MySQL 基础篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          MySQL 基础篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1mysql_exec/" class="md-nav__link">
        第一节 基础架构：执行一条SQL查询语句
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/2mysql_logs/" class="md-nav__link">
        第二节 日志系统：执行一条SQL更新语句
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/3mysql_isolaion/" class="md-nav__link">
        第三节 事务隔离
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/4mysql_index/" class="md-nav__link">
        第四节 深入浅出索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/5mysql_lock/" class="md-nav__link">
        第五节 全局锁和表锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/6mysql_transaction_isolation/" class="md-nav__link">
        第六节 事务到底是隔离的还是不隔离的
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql1_innodb/" class="md-nav__link">
        第七节 "Shallow Dive" MySQL 和 InnoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql3_transaction/" class="md-nav__link">
        第八节 "Shallow Dive" MySQL 中事务的实现(`transaction`)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql2_index/" class="md-nav__link">
        第九节 "Shallow Dive" MySQL 索引设计概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql4_index_perf/" class="md-nav__link">
        第十节 "Shallow Dive" MySQL 索引性能分析概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/5DB_locc_mvcc/" class="md-nav__link">
        第十一节 浅谈数据库并发控制 - 锁和 MVCC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql4_index_perf/" class="md-nav__link">
        第十节 "Shallow Dive" MySQL 索引性能分析概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/5DB_locc_mvcc/" class="md-nav__link">
        第十一节 浅谈数据库并发控制 - 锁和 MVCC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql5_btree/" class="md-nav__link">
        第十二节 "Shallow Dive" MySQL 为何使用 B+ 树而非哈希或者B树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql_bia_review/" class="md-nav__link">
        MySQL 基础知识复习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          MySQL 实战篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          MySQL 实战篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/1table_design/" class="md-nav__link">
        L1 表结构设计篇 - 数据类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/2table_design/" class="md-nav__link">
        L2 表结构设计篇 - 表设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/3table_index/" class="md-nav__link">
        L3 索引优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/4table_query/" class="md-nav__link">
        L4 查询优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/5db_perf_replica/" class="md-nav__link">
        L5 高可用架构 - MySQL 复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/6db_ha/" class="md-nav__link">
        L6 MySQL高可用架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/7Dist_db/" class="md-nav__link">
        L7 分布式架构篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/9Mysql_copy/" class="md-nav__link">
        L8 MySQL的零拷贝技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/8opt_int/" class="md-nav__link">
        L8 Operation Interview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          AWS Aurora 技术与实战教程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          AWS Aurora 技术与实战教程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/1Intital_Explore/" class="md-nav__link">
        第一节 深入了解 Aurora 数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/2Aurora_Adv/" class="md-nav__link">
        第二节 揭秘 Aurora 底层存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/3Aurora_operation/" class="md-nav__link">
        第三节 Aurora Basic Operation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          MySQL on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MySQL on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_k8s/1Mysql_k8s/" class="md-nav__link">
        第一节 Kubernetes 部署 MySQL 主从服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_k8s/2mysql_Master_slave/" class="md-nav__link">
        第二节 在K8s中部署主从结构的MySQL服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          MySQL 基础操作篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          MySQL 基础操作篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/1db_intro/" class="md-nav__link">
        第一节 数据库简介、及常用数据库介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/2db_install/" class="md-nav__link">
        第二节 安装 MySQL Repository & Jam db install
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/3db_sql/" class="md-nav__link">
        第三节 结构化查询语言 SQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/4db_sql_ops1/" class="md-nav__link">
        第四节 MySQL 操作实例(上)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/5db_sql_ops2/" class="md-nav__link">
        第五节 MySQL 操作实例(中)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/6db_sql_ops3/" class="md-nav__link">
        第六节 Mysql操作实例(下)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/7db_type/" class="md-nav__link">
        第七节 MySQL 数据类型约束
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/8db_index/" class="md-nav__link">
        第八节 MySQL 索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/9db_mgt/" class="md-nav__link">
        第九节 MySQL 的用户管理和权限管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/10db_logs/" class="md-nav__link">
        第十节 MySQL 日志管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/11db_backup/" class="md-nav__link">
        第十一节 MySQL备份概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/13db_xtrabackup/" class="md-nav__link">
        第十二节 MySQL逻辑备份mysqldump
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/14mysql_replicate/" class="md-nav__link">
        第十四节 MySQL 主从复制原理介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/15mysql_master_slave/" class="md-nav__link">
        第十五节 MySQL 传统主从同步配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/16mysq_gtid/" class="md-nav__link">
        第十六节 MySQL 基于 GTID 的主从复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/17ops_review/" class="md-nav__link">
        Mysql OPS Review
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/18review_short/" class="md-nav__link">
        SQL操作精简版
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          MongoDB 操作实战教程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          MongoDB 操作实战教程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/1mongodb_intro/" class="md-nav__link">
        1 MongoDB介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/2mongodb_install/" class="md-nav__link">
        2 MongoDB 快速安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/3mongodb_k8s_cluster/" class="md-nav__link">
        3 在 Kubernetes 上编排 MongoDB 集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/4mongodb_opt/" class="md-nav__link">
        4 MongoDB文档操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/5mongodb_springbboot/" class="md-nav__link">
        5 MongoDB整合SpringBoot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/6mongodb_pip/" class="md-nav__link">
        6 MongoDB 聚合操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/7mongodb_pip2/" class="md-nav__link">
        7 MongoDB聚合操作高级操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/8mongodb_view/" class="md-nav__link">
        8 MongoDB视图
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/9mongodb_index/" class="md-nav__link">
        9 MongoDB索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/10mongodb_index_adv/" class="md-nav__link">
        10 索引属性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/11mongodb_explain/" class="md-nav__link">
        11 explain执行计划详解
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          MongoDB 高级实战教程(全)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          MongoDB 高级实战教程(全)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1mon_intro_install/" class="md-nav__link">
        1 认识文档数据库 MongoDB & 及数据安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2mon_command/" class="md-nav__link">
        2 MongoDB 基本操作及聚合操作实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3mon_rep/" class="md-nav__link">
        3 复制集机制及原理 & 实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4mon_tools/" class="md-nav__link">
        4 MongoDB 全家桶
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5mon_design/" class="md-nav__link">
        5 Mongo 模型设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../6mon_red_write/" class="md-nav__link">
        6 MongoDB 事务开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7mon_changestream_bestdesign/" class="md-nav__link">
        7 MongoDB Change Stream & 开发最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../8mon_shard/" class="md-nav__link">
        8 Mongo Shards分片技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../9mon_monitor/" class="md-nav__link">
        9 MongoDB 监控最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../10mon_bakup_restore/" class="md-nav__link">
        10 MongoDB 备份与恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../11mon_sec/" class="md-nav__link">
        11 MongoDB 安全设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../12mon_index/" class="md-nav__link">
        12 MongoDB 索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../13mon_perf/" class="md-nav__link">
        13 MongoDB 性能
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          14 高级集群设计
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        14 高级集群设计
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1 高级集群设计:两地三中心
  </a>
  
    <nav class="md-nav" aria-label="1 高级集群设计:两地三中心">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    容灾级别
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    双活的技术组件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    网络层解决方案
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    应用层解决方案
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    数据库解决方案 – 数据跨中心同步
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb" class="md-nav__link">
    MongoDB 三中心方案
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb_1" class="md-nav__link">
    MongoDB 集群两地三中心部署的考量点
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    实验:搭建两地三中心集群
  </a>
  
    <nav class="md-nav" aria-label="实验:搭建两地三中心集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    实验目标及流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-mongodb" class="md-nav__link">
    启动5个 MongoDB 实例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    初始化复制集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    配置选举优先级
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    启动持续写脚本(每2秒写一条记录)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    模拟从数据中心(第2台机器)故障
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    模拟主数据中心(第1台机器)故障
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb_2" class="md-nav__link">
    MongoDB 集群两地三中心部署
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    高级集群设计:全球多写
  </a>
  
    <nav class="md-nav" aria-label="高级集群设计:全球多写">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    全球化业务需求
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    远距离访问无法保证用户体验
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb_3" class="md-nav__link">
    MongoDB 复制集 – 只解决了读的问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zone-sharding" class="md-nav__link">
    Zone Sharding 设置步骤
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    独立集群模式 – 需要外部工具双向同步
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../15mon_goonline/" class="md-nav__link">
        15 MongoDB上线及升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../16mon_sample/" class="md-nav__link">
        16 MongoDB 应用实例和场景
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../17mon_dms/" class="md-nav__link">
        17 数据迁移
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../18mon_spark/" class="md-nav__link">
        18 MongoDB + Spark实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../19mon_sql/" class="md-nav__link">
        19 MongoDB SQL 套接件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../20MongoDB_mico_middle_service/" class="md-nav__link">
        20 MongoDB 与微服务 & 数据中台
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          PostgresSQL 12.6运维入门
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          PostgresSQL 12.6运维入门
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/2pg_intall/" class="md-nav__link">
        1 PostgreSQL介绍&安装&链接管理&用户权限管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/3pg_cmd/" class="md-nav__link">
        2 常用基础命令介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/4pg_logs/" class="md-nav__link">
        3 Online WAL[Write Head Log]日志（redo)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/4pg_stru/" class="md-nav__link">
        4 体系结构介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/5pg_bak/" class="md-nav__link">
        5 备份恢复恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/6pg_repl/" class="md-nav__link">
        6 Master-Slave流复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/7pg_ops/" class="md-nav__link">
        7 有用的系统函数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/1pg_int/" class="md-nav__link">
        PostgreSQL Interview Questions 2022
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          AWS DB OTHERs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          AWS DB OTHERs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aws/1aws_neptune/" class="md-nav__link">
        L1 深入了解 Amazon Neptune 图数据库技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aws/2dydb1/" class="md-nav__link">
        L2 分布式键值存储 Dynamo 的实现原理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          Extra 知识扩展
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          Extra 知识扩展
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extra/mkdoc_gitbook/" class="md-nav__link">
        GitHub+Travis+Mkdocs自动化构建文档库(DataBase)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    1 高级集群设计:两地三中心
  </a>
  
    <nav class="md-nav" aria-label="1 高级集群设计:两地三中心">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    容灾级别
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    双活的技术组件
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    网络层解决方案
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    应用层解决方案
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    数据库解决方案 – 数据跨中心同步
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb" class="md-nav__link">
    MongoDB 三中心方案
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb_1" class="md-nav__link">
    MongoDB 集群两地三中心部署的考量点
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    实验:搭建两地三中心集群
  </a>
  
    <nav class="md-nav" aria-label="实验:搭建两地三中心集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    实验目标及流程
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-mongodb" class="md-nav__link">
    启动5个 MongoDB 实例
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    初始化复制集
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    配置选举优先级
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    启动持续写脚本(每2秒写一条记录)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    模拟从数据中心(第2台机器)故障
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    模拟主数据中心(第1台机器)故障
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb_2" class="md-nav__link">
    MongoDB 集群两地三中心部署
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    高级集群设计:全球多写
  </a>
  
    <nav class="md-nav" aria-label="高级集群设计:全球多写">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    全球化业务需求
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    远距离访问无法保证用户体验
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mongodb_3" class="md-nav__link">
    MongoDB 复制集 – 只解决了读的问题
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zone-sharding" class="md-nav__link">
    Zone Sharding 设置步骤
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    独立集群模式 – 需要外部工具双向同步
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="14"><strong>14 高级集群设计</strong></h1>
<h2 id="1"><strong>1 高级集群设计:两地三中心</strong></h2>
<h3 id="_1"><strong>容灾级别</strong></h3>
<blockquote>
<p>RPO represents how fresh recovered data will be. In practice, the RPO indicates the amount of data (updated or created) that will be lost or need to be reentered after an outage. </p>
<p>Recovery Time Objective (RTO) is the amount of downtime a business can tolerate.</p>
</blockquote>
<ul>
<li><strong>L0 无备源中心</strong><ul>
<li>没有灾难恢复能力，只在本地进行数据备份</li>
<li>RPO  24小时</li>
<li>RTO  4小时</li>
</ul>
</li>
<li><strong>L1 本地备份+异地保存</strong><ul>
<li>本地将关键数据备份，然后送到异地保存。 </li>
<li>灾难发生后，按预定数据恢复程序恢复系统和数据</li>
<li>RPO 24小时</li>
<li>RTO  8小时</li>
</ul>
</li>
<li><strong>L2 双中心主备模式</strong><ul>
<li>在异地建立一个热备份点，通过网络进行数据备份</li>
<li><strong>当出现灾难时，备份站点接替主站点的业务，维护业务连续性</strong></li>
<li>RPO 秒级</li>
<li>RTO 数分钟到半小时</li>
</ul>
</li>
<li><strong>L3 双中心双活</strong><ul>
<li>在相隔较远的地方分别建立两个数据中心，进行相互数据备份。</li>
<li>当某个数据中心发生灾难时，另一个数据中心接替其工作任务。</li>
<li>RPO 秒级</li>
<li>RTO 秒级</li>
</ul>
</li>
<li><strong>双中心双活 + 异地热备 = 两地三中心</strong><ul>
<li>在同城分别建立两个数据中心，进行相互数据备份</li>
<li>当该城市的2个中心同时不可用(地震/大面积停电/网络等)，快速切换到异地</li>
<li>RPO 秒级</li>
<li>RTO 数分钟</li>
</ul>
</li>
</ul>
<h3 id="_2"><strong>双活的技术组件</strong></h3>
<p><img alt="Alt Image Text" src="../../images/mon2_14_1.png" title="Body image" /></p>
<h3 id="_3"><strong>网络层解决方案</strong></h3>
<p><img alt="Alt Image Text" src="../../images/mon2_14_2.png" title="Body image" /></p>
<ul>
<li>Server load balancing (SLB)</li>
<li>Global Server load balancing (GSLB)</li>
</ul>
<h3 id="_4"><strong>应用层解决方案</strong></h3>
<ul>
<li>使用负载均衡、虚拟IP</li>
<li>使用同一个Session</li>
<li>使用同一套数据</li>
</ul>
<p><img alt="Alt Image Text" src="../../images/mon2_14_3.png" title="Body image" /></p>
<h3 id="_5"><strong>数据库解决方案 – 数据跨中心同步</strong></h3>
<p><img alt="Alt Image Text" src="../../images/mon2_14_4.png" title="Body image" /></p>
<h3 id="mongodb"><strong>MongoDB 三中心方案</strong></h3>
<p><strong>复制集跨中心部署:</strong></p>
<p>正常运行状态集群内一个主节点接受写，<strong>其他节点只读</strong></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_5.png" title="Body image" /></p>
<p><strong>Failover</strong></p>
<p>主节点故障主数据中心内自动切主切换时间5-10秒</p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_6.png" title="Body image" /></p>
<p><strong>双中心双活，分流模式朝阳中心需要跨中心写到海淀中心同城双中心需要低延迟专线</strong></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_7.png" title="Body image" /></p>
<ul>
<li>Write: 写入同一个primary node</li>
<li>读：可以从多地的secondary node 读</li>
</ul>
<p><strong>正常运行 <code>writeConcern: majority</code> 需要等待朝阳中心返回</strong></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_8.png" title="Body image" /></p>
<p>需要oplog同步到多个shard，才能完成统一的写盘落地</p>
<h3 id="mongodb_1"><strong>MongoDB 集群两地三中心部署的考量点</strong></h3>
<ul>
<li>节点数量建议要5个，2+2+1模式</li>
<li>主数据中心的两个节点要设置高一点的优先级，减少跨中心换主节点</li>
<li>同城双中心之间的网络要保证低延迟和频宽，满足 <code>writeConcern: Majority</code> 的双中心写需求</li>
<li><strong>使用 Retryable Writes and Retryable Reads 来保证零下线时间</strong></li>
<li><strong>用户需要自行处理好业务层的双中心切换</strong></li>
</ul>
<h2 id="_6"><strong>实验:搭建两地三中心集群</strong></h2>
<h3 id="_7"><strong>实验目标及流程</strong></h3>
<ul>
<li>目标:学习如何搭建一个3中心部署的 MongoDB 复制集</li>
<li>环境:3台 Linux 虚拟机， 2 Core 4GB</li>
<li>步骤:<ul>
<li>配置域名解析</li>
<li>安装 MongoDB</li>
<li>配置复制集</li>
<li>配置优先级</li>
<li>启动持续写脚本</li>
<li>模拟从数据中心故障</li>
<li>模拟主数据中心故障</li>
</ul>
</li>
</ul>
<h3 id="5-mongodb"><strong>启动5个 MongoDB 实例</strong></h3>
<p>在虚拟机1上执行以下命令 (mem1, mem2)</p>
<pre><code>mkdir -p member1 member2
mongod --dbpath ~/member1 --replSet demo --bind_ip 0.0.0.0 --port 10001 --fork --logpath member1.log 
mongod --dbpath ~/member2 --replSet demo --bind_ip 0.0.0.0 --port 10002 --fork --logpath member2.log
</code></pre>
<p>在虚拟机2上执行以下命令(mem3, mem4)</p>
<pre><code>mkdir -p member3 member4
mongod --dbpath ~/member3 --replSet demo --bind_ip 0.0.0.0 --port 10003 --fork --logpath member3.log
mongod --dbpath ~/member4 --replSet demo --bind_ip 0.0.0.0 --port 10004 --fork --logpath member4.log
</code></pre>
<p>在虚拟机3上执行以下命令(mem5)</p>
<pre><code>mkdir -p member5
mongod --dbpath ~/member5 --replSet demo --bind_ip 0.0.0.0 --port 10005 --fork --logpath member5.log
</code></pre>
<h3 id="_8"><strong>初始化复制集</strong></h3>
<p>在虚拟机3上执行以下命令测试所有实例正常工作</p>
<pre><code>mongo member1.example.com:10001 
mongo member2.example.com:10002 
mongo member3.example.com:10003
mongo member2.example.com:10004 
mongo member3.example.com:10005
</code></pre>
<p>初始化复制集</p>
<pre><code>mongo member1.example.com:10001 
rs.initiate(
        {
        &quot;_id&quot; : &quot;demo&quot;, 
        &quot;version&quot; : 1, 
        &quot;members&quot; : [
            { &quot;_id&quot; : 0, &quot;host&quot; : &quot;member1.example.com:10001&quot; }, 
            { &quot;_id&quot; : 1, &quot;host&quot; : &quot;member2.example.com:10002&quot; }, 
            { &quot;_id&quot; : 2, &quot;host&quot; : &quot;member3.example.com:10003&quot; },
            { &quot;_id&quot; : 3, &quot;host&quot; : &quot;member4.example.com:10004&quot; }, 
            { &quot;_id&quot; : 4, &quot;host&quot; : &quot;member5.example.com:10005&quot; }
            ] 
        }
    )
</code></pre>
<h3 id="_9"><strong>配置选举优先级</strong></h3>
<p><strong>把第一台机器上的2个实例的选举优先级调高为5和10(默认为1)</strong></p>
<pre><code>mongo member1.example.com:10001

cfg = rs.conf() 
cfg.members[0].priority = 5 
cfg.members[1].priority = 10 
rs.reconfig(cfg)
</code></pre>
<blockquote>
<p>通常都有主备数据中心之分，我们希望给主数据中心更高的优先级</p>
</blockquote>
<h3 id="2"><strong>启动持续写脚本(每2秒写一条记录)</strong></h3>
<pre><code># mongo --retryWrites mongodb://member1.example.com:10001,member2.example.com:10002,member3.example.com:10003,member4. example.com:10004,member5.example.com:10005/test?replicaSet=demo ingest-script
</code></pre>
<p><strong><code>ingest-script</code></strong></p>
<pre><code>db.test.drop()
for(var i=1;i&lt;1000;i++){
    db.test.insert({item: i});
    inserted = db.test.findOne({item: i});
    if(inserted)
        print(&quot; Item &quot;+ i +&quot; was inserted ” + new Date().getTime()/1000 + );
    else
        print(&quot;Unexpected &quot;+ inserted)
    sleep(2000);
}
</code></pre>
<p><img alt="Alt Image Text" src="../../images/mon2_14_9.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_10.png" title="Body image" /></p>
<h3 id="2_1"><strong>模拟从数据中心(第2台机器)故障</strong></h3>
<p>停止第2台虚拟机上所有 mongodb 进程</p>
<pre><code>pkill mongod
</code></pre>
<p><img alt="Alt Image Text" src="../../images/mon2_14_11.png" title="Body image" /></p>
<p><strong>观察第3台虚拟机上的写入未受中断</strong></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_12.png" title="Body image" /></p>
<p>恢复第2台虚拟机上所有 mongodb 进程</p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_13.png" title="Body image" /></p>
<h3 id="1_1"><strong>模拟主数据中心(第1台机器)故障</strong></h3>
<p>停止第1台虚拟机上所有 mongodb 进程</p>
<pre><code>pkill mongod
</code></pre>
<p>观察第3台虚拟机上的写入未受中断</p>
<h3 id="mongodb_2"><strong>MongoDB 集群两地三中心部署</strong></h3>
<ul>
<li>搭建简单，使用复制集机制，无需第三方软件</li>
<li>使用Retryable Writes以后，即使出现数据中心故障，对前端业务没有任何中断 (Retryable Writes 在4.2以后就是默认设置)</li>
</ul>
<h2 id="_10"><strong>高级集群设计:全球多写</strong></h2>
<p>MongoDB 多中心部署的三种模式</p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_14.png" title="Body image" /></p>
<h3 id="_11"><strong>全球化业务需求</strong></h3>
<ul>
<li>某奢侈品牌厂商业务集中在大中华地区</li>
<li>2020年的目标是要进入美国市场</li>
<li>他们的主要业务系统都集中在香港</li>
<li>如何设计我们的业务系统来保证海外用户的最佳体验?</li>
</ul>
<h3 id="_12"><strong>远距离访问无法保证用户体验</strong></h3>
<p><img alt="Alt Image Text" src="../../images/mon2_14_15.png" title="Body image" /></p>
<h3 id="mongodb_3"><strong>MongoDB 复制集 – 只解决了读的问题</strong></h3>
<p><img alt="Alt Image Text" src="../../images/mon2_14_16.png" title="Body image" /></p>
<p><strong>MongoDB Zone Sharding – 全球集群</strong></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_17.png" title="Body image" /></p>
<h3 id="zone-sharding"><strong>Zone Sharding 设置步骤</strong></h3>
<ul>
<li>针对每个要分片的数据集合，模型中增加一个区域字段</li>
<li>给集群的每个分片加区域标签</li>
<li>给每个区域指定属于这个区域的分片块范围(chunk range)</li>
</ul>
<p><strong>1. 数据模型:增加区域字段</strong></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_18.png" title="Body image" /></p>
<p><strong>2. 给分片添加标签</strong></p>
<pre><code># mongo
&gt; sh.addShardTag(“shard0”, ”ASIA&quot;)

&gt; sh.addShardTag(“shard1”, ”AMERICA&quot;)
</code></pre>
<p><img alt="Alt Image Text" src="../../images/mon2_14_19.png" title="Body image" /></p>
<p><strong>3. 标签指定数据块范围</strong></p>
<pre><code>
# mongo
&gt; sh.addTagRange( ”crm.orders&quot;,
    { &quot;locationCode&quot; : &quot;CN&quot;, &quot;order_id&quot; : MinKey },
    { &quot;locationCode&quot; : &quot;CN&quot;, &quot;order_id&quot; : MaxKey } , &quot;ASIA&quot; )

&gt; sh.addTagRange( &quot;crm.orders&quot;,
    { &quot;locationCode&quot; : &quot;US&quot;, ”order_id&quot; : MinKey },
    { &quot;locationCode&quot; : &quot;US&quot;, ”order_id&quot; : MaxKey } , &quot;AMERICA&quot; )

&gt; sh.addTagRange( &quot;crm.orders&quot;,
    { &quot;locationCode&quot; : &quot;CA&quot;, &quot;order_id&quot; : MinKey },
    { &quot;locationCode&quot; : &quot;CA&quot;, &quot;order_id&quot; : MaxKey } , &quot;AMERICA&quot;  )
</code></pre>
<p><strong>MongoDB Zone Sharding 工作原理</strong></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_20.png" title="Body image" /></p>
<p><strong>读写场景分析</strong></p>
<p><img alt="Alt Image Text" src="../../images/mon2_14_21.png" title="Body image" /></p>
<h3 id="_13"><strong>独立集群模式 – 需要外部工具双向同步</strong></h3>
<p><img alt="Alt Image Text" src="../../images/mon2_14_22.png" title="Body image" /></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fc8c2696.min.js"></script>
      
    
  </body>
</html>