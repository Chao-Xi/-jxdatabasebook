
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Database 技术与实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../5mysql_lock/">
      
      
        <link rel="next" href="../mysql1_innodb/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.2">
    
    
      
        <title>第六节 事务到底是隔离的还是不隔离的 - Jacob DataBase Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7bf56d0a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob DataBase Book" class="md-header__button md-logo" aria-label="Jacob DataBase Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob DataBase Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第六节 事务到底是隔离的还是不隔离的
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxdatabasebook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxdatabasebook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob DataBase Book" class="md-nav__button md-logo" aria-label="Jacob DataBase Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob DataBase Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxdatabasebook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxdatabasebook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          MySQL 基础篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          MySQL 基础篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1mysql_exec/" class="md-nav__link">
        第一节 基础架构：执行一条SQL查询语句
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2mysql_logs/" class="md-nav__link">
        第二节 日志系统：执行一条SQL更新语句
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3mysql_isolaion/" class="md-nav__link">
        第三节 事务隔离
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4mysql_index/" class="md-nav__link">
        第四节 深入浅出索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5mysql_lock/" class="md-nav__link">
        第五节 全局锁和表锁
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          第六节 事务到底是隔离的还是不隔离的
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        第六节 事务到底是隔离的还是不隔离的
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1mysql" class="md-nav__link">
    1、MySQL中的视图
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-mvcc" class="md-nav__link">
    2、“快照”在 MVCC 里是怎么工作的？
  </a>
  
    <nav class="md-nav" aria-label="2、“快照”在 MVCC 里是怎么工作的？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1-transaction-id-row-trx_id" class="md-nav__link">
    2-1 transaction id &amp; row trx_id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-read-view" class="md-nav__link">
    2-2 一致性视图（read-view）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、更新逻辑
  </a>
  
    <nav class="md-nav" aria-label="3、更新逻辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3-1-current-read" class="md-nav__link">
    3-1 当前读（current read)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-2-select" class="md-nav__link">
    3-2 select 加锁 =&gt; 当前读
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-3" class="md-nav__link">
    3-3 可重复读加锁
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、本节小结
  </a>
  
    <nav class="md-nav" aria-label="4、本节小结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4-1" class="md-nav__link">
    4-1 全文总结
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-2" class="md-nav__link">
    4-2 思考题
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mysql1_innodb/" class="md-nav__link">
        第七节 "Shallow Dive" MySQL 和 InnoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mysql3_transaction/" class="md-nav__link">
        第八节 "Shallow Dive" MySQL 中事务的实现(`transaction`)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mysql2_index/" class="md-nav__link">
        第九节 "Shallow Dive" MySQL 索引设计概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mysql4_index_perf/" class="md-nav__link">
        第十节 "Shallow Dive" MySQL 索引性能分析概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5DB_locc_mvcc/" class="md-nav__link">
        第十一节 浅谈数据库并发控制 - 锁和 MVCC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mysql4_index_perf/" class="md-nav__link">
        第十节 "Shallow Dive" MySQL 索引性能分析概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5DB_locc_mvcc/" class="md-nav__link">
        第十一节 浅谈数据库并发控制 - 锁和 MVCC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mysql5_btree/" class="md-nav__link">
        第十二节 "Shallow Dive" MySQL 为何使用 B+ 树而非哈希或者B树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../mysql_bia_review/" class="md-nav__link">
        MySQL 基础知识复习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          MySQL 实战篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          MySQL 实战篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/1table_design/" class="md-nav__link">
        L1 表结构设计篇 - 数据类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/2table_design/" class="md-nav__link">
        L2 表结构设计篇 - 表设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/3table_index/" class="md-nav__link">
        L3 索引优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/4table_query/" class="md-nav__link">
        L4 查询优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/5db_perf_replica/" class="md-nav__link">
        L5 高可用架构 - MySQL 复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/6db_ha/" class="md-nav__link">
        L6 MySQL高可用架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/7Dist_db/" class="md-nav__link">
        L7 分布式架构篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/9Mysql_copy/" class="md-nav__link">
        L8 MySQL的零拷贝技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/8opt_int/" class="md-nav__link">
        L8 Operation Interview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          AWS Aurora 技术与实战教程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          AWS Aurora 技术与实战教程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/1Intital_Explore/" class="md-nav__link">
        第一节 深入了解 Aurora 数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/2Aurora_Adv/" class="md-nav__link">
        第二节 揭秘 Aurora 底层存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/3Aurora_operation/" class="md-nav__link">
        第三节 Aurora Basic Operation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          MySQL on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MySQL on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_k8s/1Mysql_k8s/" class="md-nav__link">
        第一节 Kubernetes 部署 MySQL 主从服务
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap_k8s/2mysql_Master_slave/" class="md-nav__link">
        第二节 在K8s中部署主从结构的MySQL服务
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          MySQL 基础操作篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          MySQL 基础操作篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/1db_intro/" class="md-nav__link">
        第一节 数据库简介、及常用数据库介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/2db_install/" class="md-nav__link">
        第二节 安装 MySQL Repository & Jam db install
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/3db_sql/" class="md-nav__link">
        第三节 结构化查询语言 SQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/4db_sql_ops1/" class="md-nav__link">
        第四节 MySQL 操作实例(上)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/5db_sql_ops2/" class="md-nav__link">
        第五节 MySQL 操作实例(中)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/6db_sql_ops3/" class="md-nav__link">
        第六节 Mysql操作实例(下)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/7db_type/" class="md-nav__link">
        第七节 MySQL 数据类型约束
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/8db_index/" class="md-nav__link">
        第八节 MySQL 索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/9db_mgt/" class="md-nav__link">
        第九节 MySQL 的用户管理和权限管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/10db_logs/" class="md-nav__link">
        第十节 MySQL 日志管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/11db_backup/" class="md-nav__link">
        第十一节 MySQL备份概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/13db_xtrabackup/" class="md-nav__link">
        第十二节 MySQL逻辑备份mysqldump
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/14mysql_replicate/" class="md-nav__link">
        第十四节 MySQL 主从复制原理介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/15mysql_master_slave/" class="md-nav__link">
        第十五节 MySQL 传统主从同步配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/16mysq_gtid/" class="md-nav__link">
        第十六节 MySQL 基于 GTID 的主从复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/17ops_review/" class="md-nav__link">
        Mysql OPS Review
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/18review_short/" class="md-nav__link">
        SQL操作精简版
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          MongoDB 操作实战教程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          MongoDB 操作实战教程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/1mongodb_intro/" class="md-nav__link">
        1 MongoDB介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/2mongodb_install/" class="md-nav__link">
        2 MongoDB 快速安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/3mongodb_k8s_cluster/" class="md-nav__link">
        3 在 Kubernetes 上编排 MongoDB 集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/4mongodb_opt/" class="md-nav__link">
        4 MongoDB文档操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/5mongodb_springbboot/" class="md-nav__link">
        5 MongoDB整合SpringBoot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/6mongodb_pip/" class="md-nav__link">
        6 MongoDB 聚合操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/7mongodb_pip2/" class="md-nav__link">
        7 MongoDB聚合操作高级操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/8mongodb_view/" class="md-nav__link">
        8 MongoDB视图
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/9mongodb_index/" class="md-nav__link">
        9 MongoDB索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/10mongodb_index_adv/" class="md-nav__link">
        10 索引属性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/11mongodb_explain/" class="md-nav__link">
        11 explain执行计划详解
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          MongoDB 高级实战教程(全)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          MongoDB 高级实战教程(全)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/1mon_intro_install/" class="md-nav__link">
        1 认识文档数据库 MongoDB & 及数据安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/2mon_command/" class="md-nav__link">
        2 MongoDB 基本操作及聚合操作实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/3mon_rep/" class="md-nav__link">
        3 复制集机制及原理 & 实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/4mon_tools/" class="md-nav__link">
        4 MongoDB 全家桶
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/5mon_design/" class="md-nav__link">
        5 Mongo 模型设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/6mon_red_write/" class="md-nav__link">
        6 MongoDB 事务开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/7mon_changestream_bestdesign/" class="md-nav__link">
        7 MongoDB Change Stream & 开发最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/8mon_shard/" class="md-nav__link">
        8 Mongo Shards分片技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/9mon_monitor/" class="md-nav__link">
        9 MongoDB 监控最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/10mon_bakup_restore/" class="md-nav__link">
        10 MongoDB 备份与恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/11mon_sec/" class="md-nav__link">
        11 MongoDB 安全设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/12mon_index/" class="md-nav__link">
        12 MongoDB 索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/13mon_perf/" class="md-nav__link">
        13 MongoDB 性能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/14mon_cluster/" class="md-nav__link">
        14 高级集群设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/15mon_goonline/" class="md-nav__link">
        15 MongoDB上线及升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/16mon_sample/" class="md-nav__link">
        16 MongoDB 应用实例和场景
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/17mon_dms/" class="md-nav__link">
        17 数据迁移
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/18mon_spark/" class="md-nav__link">
        18 MongoDB + Spark实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/19mon_sql/" class="md-nav__link">
        19 MongoDB SQL 套接件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/20MongoDB_mico_middle_service/" class="md-nav__link">
        20 MongoDB 与微服务 & 数据中台
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          PostgresSQL 12.6运维入门
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          PostgresSQL 12.6运维入门
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/2pg_intall/" class="md-nav__link">
        1 PostgreSQL介绍&安装&链接管理&用户权限管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/3pg_cmd/" class="md-nav__link">
        2 常用基础命令介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/4pg_logs/" class="md-nav__link">
        3 Online WAL[Write Head Log]日志（redo)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/4pg_stru/" class="md-nav__link">
        4 体系结构介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/5pg_bak/" class="md-nav__link">
        5 备份恢复恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/6pg_repl/" class="md-nav__link">
        6 Master-Slave流复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/7pg_ops/" class="md-nav__link">
        7 有用的系统函数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/1pg_int/" class="md-nav__link">
        PostgreSQL Interview Questions 2022
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          AWS DB OTHERs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          AWS DB OTHERs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aws/1aws_neptune/" class="md-nav__link">
        L1 深入了解 Amazon Neptune 图数据库技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aws/2dydb1/" class="md-nav__link">
        L2 分布式键值存储 Dynamo 的实现原理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          Extra 知识扩展
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          Extra 知识扩展
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extra/mkdoc_gitbook/" class="md-nav__link">
        GitHub+Travis+Mkdocs自动化构建文档库(DataBase)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1mysql" class="md-nav__link">
    1、MySQL中的视图
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-mvcc" class="md-nav__link">
    2、“快照”在 MVCC 里是怎么工作的？
  </a>
  
    <nav class="md-nav" aria-label="2、“快照”在 MVCC 里是怎么工作的？">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#2-1-transaction-id-row-trx_id" class="md-nav__link">
    2-1 transaction id &amp; row trx_id
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-2-read-view" class="md-nav__link">
    2-2 一致性视图（read-view）
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    3、更新逻辑
  </a>
  
    <nav class="md-nav" aria-label="3、更新逻辑">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3-1-current-read" class="md-nav__link">
    3-1 当前读（current read)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-2-select" class="md-nav__link">
    3-2 select 加锁 =&gt; 当前读
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-3" class="md-nav__link">
    3-3 可重复读加锁
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    4、本节小结
  </a>
  
    <nav class="md-nav" aria-label="4、本节小结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#4-1" class="md-nav__link">
    4-1 全文总结
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-2" class="md-nav__link">
    4-2 思考题
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="_1"><strong>第六节 事务到底是隔离的还是不隔离的</strong></h1>
<p><a href="https://chao-xi.github.io/jxdatabasebook/chap1/3mysql_isolaion/#1-2">事务隔离级别的时候提到过，如果是可重复读隔离级别</a>，事务 T 启动的时候会创建一个视图 <code>read-view</code>，之后事务 T 执行期间，<strong>即使有其他事务修改了数据，事务 T 看到的仍然跟在启动时看到的一样。</strong></p>
<p>上一篇文章中，行锁的时候又提到，一个事务要更新一行，如果刚好有另外一个事务拥有这一行的行锁，会被锁住，进入等待状态。</p>
<p>问题是，既然<strong>进入了等待状态，那么等到这个事务自己获取到行锁要更新数据的时候，它读到的值又是什么呢？</strong></p>
<pre><code>mysql&gt; CREATE TABLE `t` (
  `id` int(11) NOT NULL,
  `k` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB;

insert into t(id, k) values(1,1),(2,2);
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap2_6_1.png" title="Body image" /></p>
<p><strong>需要注意的是事务的启动时机</strong></p>
<p><strong><code>begin/start transaction</code> 命令并不是一个事务的起点，在执行到它们之后的第一个操作 InnoDB 表的语句，事务才真正启动。</strong></p>
<p><strong><span style="color:red">如果你想要马上启动一个事务，可以使用 <code>start transaction with consistent snapshot</code> 这个命令。</span></strong></p>
<blockquote>
<p>第一种启动方式，<strong>一致性视图是在执行第一个快照读语句时创建的；</strong></p>
<p>第二种启动方式，一致性视图是在执行 <code>start transaction with consistent snapshot</code> 时创建的。</p>
</blockquote>
<p><strong>都是默认 autocommit=1。</strong></p>
<ul>
<li>在这个例子中，事务 C 没有显式地使用 <code>begin/commit</code>，表示这个 update 语句本身就是一个事务，语句完成的时候会自动提交。</li>
<li>事务 B 在更新了行之后查询</li>
<li>事务 A 在一个只读事务中查询，并且时间顺序上是在事务 B 的查询之后。</li>
</ul>
<p><strong>答案是： 事务 B 查到的 k 的值是 3，而事务 A 查到的 k 的值是 1</strong></p>
<p>我们来一点点的解释这个原因</p>
<h2 id="1mysql"><strong>1、MySQL中的视图</strong></h2>
<p>在 MySQL 里，有两个“视图”的概念：</p>
<ul>
<li><strong>一个是 <code>view</code>。它是一个用查询语句定义的虚拟表，在调用的时候执行查询语句并生成结果</strong><ul>
<li>创建视图的语法是 <code>create view</code> … ，而它的查询方法与表一样。</li>
</ul>
</li>
<li>另一个是 <code>InnoDB</code> 在实现 <code>MVCC</code> 时用到的一致性读视图，<ul>
<li><strong>即 <code>consistent read view</code>，用于支持 <code>RC</code>（Read Committed，读提交）和 <code>RR</code>（Repeatable Read，可重复读）隔离级别的实现</strong>。</li>
</ul>
</li>
</ul>
<p>它没有物理结构，作用是事务执行期间用来定义“我能看到什么数据”。</p>
<h2 id="2-mvcc"><strong>2、“快照”在 MVCC 里是怎么工作的？</strong></h2>
<p>在可重复读隔离级别下，事务在启动的时候就“拍了个快照”。注意，<strong>这个快照是基于整库的</strong>。</p>
<blockquote>
<p>库快照，不是行快照。所以不会进行MDL读锁等待，而是获取所有已提交的数据</p>
</blockquote>
<p>看上去不太现实啊。如果一个库有 100G，那么我启动一个事务，MySQL 就要拷贝 100G 的数据出来，这个过程得多慢啊</p>
<p>实际上，我们并不需要拷贝出这 100G 的数据。</p>
<h3 id="2-1-transaction-id-row-trx_id"><strong>2-1 <code>transaction id</code> &amp; <code>row trx_id</code></strong></h3>
<p><strong>InnoDB 里面每个事务有一个唯一的事务 ID，叫作 <code>transaction id</code>。它是在事务开始的时候向 InnoDB 的事务系统申请的，是按申请顺序严格递增的。</strong></p>
<ul>
<li>每行数据也都是有多个版本的。<strong>每次事务更新数据的时候，都会生成一个新的数据版本，并且把 <code>transaction id</code> 赋值给这个数据版本的事务 ID，记为 <code>row trx_id</code></strong></li>
<li><code>transaction id</code> ==  <code>row trx_id</code></li>
<li>同时，旧的数据版本要保留，并且在新的数据版本中，能够有信息可以直接拿到它。</li>
</ul>
<p><span style="color:red">数据表中的一行记录，其实可能有多个版本 (row)，每个版本有自己的 <code>row trx_id</code>。</span></p>
<p>如图所示，就是一个记录被多个事务连续更新后的状态。</p>
<p><img alt="Alt Image Text" src="../../images/chap2_6_2.png" title="Body image" /></p>
<ul>
<li>虚线框里是同一行数据的 4 个版本，当前最新版本是 V4，k 的值是 22，它是被 <code>transaction id</code> 为 25 的事务更新的，因此它的 <code>row trx_id</code>也是 25。</li>
<li><strong>图 中的三个虚线箭头，就是 <code>undo log</code>；</strong></li>
<li><strong>而 V1、V2、V3 并不是物理上真实存在的</strong>，而是每次需要的时候根据当前版本和 <code>undo log</code> 计算出来的。<ul>
<li><strong>比如，需要 V2 的时候，就是通过 V4 依次执行 U3、U2 算出来。</strong></li>
</ul>
</li>
</ul>
<h3 id="2-2-read-view"><strong>2-2 一致性视图（read-view）</strong></h3>
<p>InnoDB 是怎么定义那个“100G”的快照的。</p>
<p><strong>按照可重复读的定义，一个事务启动的时候，能够看到所有已经提交的事务结果。但是之后，这个事务执行期间，其他事务的更新对它不可见。</strong></p>
<ul>
<li>一个事务只需要在启动的时候声明说，“以我启动的时刻为准，如果一个数据版本是在我启动之前生成的，就认；如果是我启动以后才生成的，我就不认，我必须要找到它的上一个版本”。</li>
<li>如果“上一个版本”也不可见，那就得继续往前找。</li>
<li><strong>还有，如果是这个事务自己更新的数据，它自己还是要认的。</strong></li>
</ul>
<p><strong>在实现上， InnoDB 为每个事务构造了一个数组，用来保存这个事务启动瞬间，当前正在“活跃”的所有事务 ID。“活跃”指的就是，启动了但还没提交</strong>。</p>
<p>数组里面事务 ID 的最小值记为低水位，当前系统里面已经创建过的事务 ID 的最大值加 1 记为高水位。</p>
<ul>
<li>低水位：数组内事务ID最小值。 </li>
<li>高水位：当前系统已经创建的事务id的最大值+1（并不是数组内的最大）</li>
</ul>
<p><strong>低水位是【数组内】 高水位【系统内】</strong></p>
<p><strong>这个视图数组和高水位，就组成了当前事务的一致性视图（read-view）。</strong></p>
<p>而数据版本的可见性规则，就是基于数据的 <code>row trx_id</code> 和这个一致性视图的对比结果得到的。</p>
<p>视图数组把所有的 <code>row trx_id</code> 分成了几种不同的情况。</p>
<p><img alt="Alt Image Text" src="../../images/chap2_6_3.png" title="Body image" /></p>
<p>对于当前事务的启动瞬间来说，一个数据版本的 <code>row trx_id</code>，有以下几种可能：</p>
<ol>
<li>如果落在绿色部分，表示这个版本是已提交的事务或者是当前事务自己生成的，这个数据是可见的；</li>
<li><strong>如果落在红色部分，表示这个版本是由将来启动的事务生成的，是肯定不可见的；</strong></li>
<li>如果落在黄色部分，那就包括两种情况<ul>
<li>a. 若 <code>row trx_id</code> 在数组中，<strong>表示这个版本是由还没提交的事务生成的，不可见</strong>； </li>
<li>b. 若 <code>row trx_id</code> 不在数组中，<strong>表示这个版本是已经提交了的事务生成的，可见</strong>。</li>
</ul>
</li>
</ol>
<p>对于图 2 中的数据来说，如果有一个事务，它的低水位是 18，那么当它访问这一行数据时，就会从 V4 通过 U3 计算出 V3，所以在它看来，这一行的值是 11。</p>
<p>有了这个声明后，系统里面随后发生的更新，是不是就跟这个事务看到的内容无关了呢？因为之后的更新，生成的版本一定属于上面的 2 或者 3(a) 的情况，而对它来说，这些新的数据版本是不存在的，所以这个事务的快照，就是“静态”的了。</p>
<p><strong>InnoDB 利用了“所有数据都有多个版本”的这个特性，实现了“秒级创建快照”的能力。</strong></p>
<p>接下来，我们继续看一下图 1 中的三个事务，分析下事务 A 的语句返回的结果，为什么是 k=1。</p>
<p>这里，我们不妨做如下假设：</p>
<ul>
<li>事务 A 开始前，系统里面只有一个活跃事务 ID 是 99；</li>
<li>事务 A、B、C 的版本号分别是 100、101、102，且当前系统里只有这四个事务；</li>
<li>三个事务开始前，<code>(1,1</code>）这一行数据的 <code>row trx_id</code> 是 90。</li>
</ul>
<hr />
<ul>
<li>事务 A 的视图数组就是[99,100], </li>
<li>事务 B 的视图数组是[99,100,101], </li>
<li>事务 C 的视图数组是[99,100,101,102]</li>
</ul>
<p>为了简化分析, 只画出跟事务 A 查询逻辑有关的操作：</p>
<p><img alt="Alt Image Text" src="../../images/chap2_6_4.png" title="Body image" /></p>
<ul>
<li>，第一个有效更新是事务 C，把数据从 (1,1) 改成了 (1,2)。这时候，这个数据的最新版本的 <code>row trx_id</code> 是 102，而 90 这个版本已经成为了历史版本。</li>
<li>第二个有效更新是事务 B，把数据从 (1,2) 改成了 (1,3)。这时候，这个数据的最新版本（即 <code>row trx_id</code>）是 101，而 102 又成为了历史版本。</li>
<li><strong>在事务 A 查询的时候，其实事务 B 还没有提交，但是它生成的 (1,3) 这个版本已经变成当前版本了。但这个版本对事务 A 必须是不可见的，否则就变成脏读了。</strong></li>
</ul>
<p>现在事务 A 要来读数据了，它的视图数组是<code>[99,100]</code>。当然了，读数据都是从当前版本读起的。所以，事务 A 查询语句的读数据流程是这样的：</p>
<ul>
<li>找到 (1,3) 的时候，判断出 <code>row trx_id=101</code>，比高水位大，处于红色区域，不可见；</li>
</ul>
<blockquote>
<p>100是高水位，创建事务A的时候，系统现有的最大事务id是99，99 + 1 = 100。</p>
</blockquote>
<ul>
<li>接着，找到上一个历史版本，一看 <code>row trx_id=102</code>，比高水位大，处于红色区域，不可见；</li>
<li>再往前找，终于找到了<code>（1,1)</code>，它的<code>row trx_id=90</code>，比低水位小，处于绿色区域，可见。</li>
</ul>
<p><strong>虽然期间这一行数据被修改过，但是事务 A 不论在什么时候查询，看到这行数据的结果都是一致的，所以我们称之为一致性读。</strong></p>
<p><strong>一个数据版本，对于一个事务视图来说，除了自己的更新总是可见以外，有三种情况：</strong></p>
<ul>
<li>版本未提交，不可见；</li>
<li><strong>版本已提交，但是是在视图创建后提交的，不可见</strong>；</li>
<li><strong>版本已提交，而且是在视图创建前提交的，可见。</strong></li>
</ul>
<p>图 4 中的查询结果，事务 A 的查询语句的视图数组是在事务 A 启动的时候生成的，这时候：</p>
<ul>
<li>(1,3) 还没提交，属于情况 1，不可见；</li>
<li>(1,2) 虽然提交了，但是是在视图数组创建之后提交的，属于情况 2，不可见；</li>
<li>(1,1) 是在视图数组创建之前提交的，可见。</li>
</ul>
<h2 id="3"><strong>3、更新逻辑</strong></h2>
<p><span style="color:red">事务 B 的 update 语句，如果按照一致性读，好像结果不对哦？</span></p>
<p><strong>事务 B 的视图数组是先生成的，之后事务 C 才提交，不是应该看不见 (1,2) 吗，怎么能算出 (1,3) 来？</strong></p>
<h3 id="3-1-current-read"><strong>3-1 当前读（current read)</strong></h3>
<p><img alt="Alt Image Text" src="../../images/chap2_6_5.png" title="Body image" /></p>
<ul>
<li>如果事务 B 在更新之前查询一次数据，这个查询返回的 k 的值确实是 1。</li>
<li>当它要去更新数据的时候，就不能再在历史版本上更新了，<strong>否则事务 C 的更新就丢失了。因此，事务 B 此时的 <code>set k=k+1</code> 是在（1,2）的基础上进行的操作。</strong></li>
<li><strong><span style="color:red">更新数据都是先读后写的，而这个读，只能读当前的值，称为“当前读”（current read）。</span></strong></li>
</ul>
<blockquote>
<p>事务与事务之间的隔离不应该影响最终数据的落地。</p>
<p>就是说事务C先更新了数据，而后事务B也更新了同一份数据，以数据库的眼光来看这份数据的变动就是事务C的更新跟着事务B的更新，必须延续在一块而不能分开。 </p>
<p>所以事务的更新必须是基于当前最新值来执行的，而读则是基于其视图，即可重复读的隔离，真的只是读层面的隔离。 </p>
<p>在这个例子中，就是因为事务C的更新在前，事务B的更新必须延续事务C的结果，所以只能读取当前值再更新。而事务本身的更新是能被看到的，所以事务B再查询就只能是得到当前最新值</p>
</blockquote>
<p><strong>因此，在更新的时候，当前读拿到的数据是 (1,2)，更新后生成了新版本的数据 (1,3)，这个新版本的 <code>row trx_id</code> 是 101。</strong></p>
<p>在执行事务 B 查询语句的时候，一看自己的版本号是 101，最新数据的版本号也是 101，是自己的更新，可以直接使用，所以查询得到的 k 的值是 3。</p>
<h3 id="3-2-select"><strong>3-2 select 加锁 =&gt; 当前读</strong></h3>
<p><strong>其实，除了 update 语句外，select 语句如果加锁，也是当前读。</strong></p>
<p>所以，如果把事务 A 的查询语句 <code>select * from t where id=1</code> 修改一下，加上 <code>lock in share mode</code> 或 <code>for update</code>，也都可以读到版本号是 101 的数据，返回的 k 的值是 3。</p>
<p><strong>下面这两个<code>select</code>语句，就是分别加了读锁（S 锁，共享锁）和写锁（X 锁，排他锁)</strong></p>
<pre><code>mysql&gt; select k from t where id=1 lock in share mode;
mysql&gt; select k from t where id=1 for update;
</code></pre>
<h3 id="3-3"><strong>3-3 可重复读加锁</strong></h3>
<p>假设事务 C 不是马上提交的，而是变成了下面的事务 <code>C’</code>，会怎么样呢？</p>
<p><img alt="Alt Image Text" src="../../images/chap2_6_6.png" title="Body image" /></p>
<p>事务<code>C’</code>的不同是，更新后并没有马上提交，在它提交前，事务 B 的更新语句先发起了。</p>
<p>虽然事务<code>C’</code>还没提交，但是<code>(1,2)</code>这个版本也已经生成了，并且是当前的最新版本</p>
<p>事务 B 的更新语句会怎么处理呢？</p>
<p>“两阶段锁协议”就要上场了。事务 <code>C’</code>没提交，也就是说 (1,2) 这个版本上的写锁还没释放。而事务 B 是当前读，必须要读最新版本，而且必须加锁，因此就被锁住了，必须等到事务 <code>C’</code>释放这个锁，才能继续它的当前读。</p>
<p><img alt="Alt Image Text" src="../../images/chap2_6_7.png" title="Body image" /></p>
<p><strong>到这里，我们把一致性读、当前读和行锁就串起来了。</strong></p>
<p><strong>事务的可重复读的能力是怎么实现的？</strong></p>
<ul>
<li>可重复读的核心就是一致性读（consistent read）；</li>
<li>而事务更新数据的时候，只能用当前读。</li>
<li>如果当前的记录的行锁被其他事务占用的话，就需要进入锁等待。</li>
</ul>
<p>而读提交的逻辑和可重复读的逻辑类似，它们最主要的区别是：</p>
<ul>
<li>在可重复读隔离级别下，只需要在事务开始的时候创建一致性视图，之后事务里的其他查询都共用这个一致性视图；</li>
<li>在读提交隔离级别下，每一个语句执行前都会重新算出一个新的视图。</li>
</ul>
<p>在读提交隔离级别下，事务 A 和事务 B 的查询语句查到的 k，分别应该是多少呢？</p>
<ul>
<li><code>“start transaction with consistent snapshot; ”</code> 的意思是从这个语句开始，创建一个持续整个事务的一致性快照。</li>
<li>所以，在读提交隔离级别下，这个用法就没意义了，等效于普通的 <code>start transaction</code>。</li>
</ul>
<p>读提交时的状态图，可以看到这两个查询语句的创建视图数组的时机发生了变化，就是图中的 <code>read view</code> 框 (( 注意：这里，我们用的还是事务 <code>C</code> 的逻辑直接提交，而不是事务<code>C’</code>))</p>
<p><img alt="Alt Image Text" src="../../images/chap2_6_8.png" title="Body image" /></p>
<p>这时，事务 A 的查询语句的视图数组是在执行这个语句的时候创建的，时序上 (1,2)、(1,3) 的生成时间都在创建这个视图数组的时刻之前。但是，在这个时刻：</p>
<ul>
<li>(1,3) 还没提交，属于情况 1，不可见；</li>
<li>(1,2) 提交了，属于情况 3，可见。</li>
</ul>
<p>所以，这时候事务 A 查询语句返回的是 k=2。 显然地，事务 B 查询结果 k=3。</p>
<h2 id="4"><strong>4、本节小结</strong></h2>
<ul>
<li>InnoDB 的行数据有多个版本，每个数据版本有自己的 <code>row trx_id</code>，每个事务或者语句有自己的一致性视图。</li>
<li>
<p>普通查询语句是一致性读，一致性读会根据 <code>row trx_id</code> 和一致性视图确定数据版本的可见性。</p>
</li>
<li>
<p><strong><span style="color:red">对于可重复读，查询只承认在事务启动前就已经提交完成的数据；</span></strong></p>
</li>
<li><strong><span style="color:red">对于读提交，查询只承认在语句启动前就已经提交完成的数据；</span></strong></li>
</ul>
<p><strong><span style="color:red">而当前读，总是读取已经提交完成的最新版本。</span></strong></p>
<p><strong><code>update</code>和<code>加锁的select</code>都是当前读，当前读，可能会遇到阻塞的情况，获取锁后，读的也是已提交的最新版本</strong></p>
<ul>
<li>为什么表结构不支持“可重复读”？这是因为表结构没有对应的行数据，也没有 row trx_id，因此只能遵循当前读的逻辑。</li>
<li>当然，MySQL 8.0 已经可以把表结构放在 InnoDB 字典里了，也许以后会支持表结构的可重复读。</li>
</ul>
<h3 id="4-1"><strong>4-1 全文总结</strong></h3>
<ol>
<li>innodb支持RC(Read commit)和RR(Repeatable Read)隔离级别实现是用的一致性视图(consistent read view)</li>
<li>事务在启动时会拍一个快照,这个快照是基于整个库的.
基于整个库的意思就是说一个事务内,整个库的修改对于该事务都是不可见的(对于快照读的情况)
如果在事务内select t表,另外的事务执行了DDL t表,根据发生时间,要嘛锁住要嘛报错</li>
<li>事务是如何实现的MVCC呢?<ul>
<li>每个事务都有一个事务ID,叫做<code>transaction id</code>(严格递增)</li>
<li>事务在启动时,找到已提交的最大事务ID记为<code>up_limit_id</code>。</li>
<li>事务在更新一条语句时,比如<code>id=1</code>改为了<code>id=2</code>.会把id=1和该行之前的<code>row trx_id</code>写到<code>undo log</code>里, 并且在数据页上把id的值改为2,并且把修改这条语句的<code>transaction id</code>记在该行行头</li>
<li>再定一个规矩,一个事务要查看一条数据时,必须先用该事务的<code>up_limit_id</code>与该行的<code>transaction id</code>做比对,</li>
<li>如果<code>up_limit_id&gt;=transaction id</code>,那么可以看.如果<code>up_limit_id&lt;transaction id</code>,则只能去<code>undo log</code>里去取。去<code>undo log</code>查找数据的时候,也需要做比对,必须<code>up_limit_id&gt;transaction id</code>,才返回数据</li>
</ul>
</li>
<li>什么是当前读,由于当前读都是先读后写,只能读当前的值,所以为当前读.会更新事务内的<code>up_limit_id</code>为该事务的<code>transaction id</code></li>
<li>为什么rr能实现可重复读而rc不能,分两种情况<ul>
<li>快照读的情况下,rr不能更新事务内的<code>up_limit_id</code>,
而rc每次会把<code>up_limit_id</code>更新为快照读之前最新已提交事务的<code>transaction id,</code>则rc不能可重复读</li>
<li>当前读的情况下,rr是利用<code>record lock+gap loc</code>k来实现的,而rc没有gap,所以rc不能可重复读</li>
</ul>
</li>
</ol>
<h3 id="4-2"><strong>4-2 思考题</strong></h3>
<p>我用下面的表结构和初始化语句作为试验环境，事务隔离级别是可重复读。现在，我要把所有“字段 c 和 id 值相等的行”的 c 值清零，但是却发现了一个“诡异”的、改不掉的情况。请你构造出这种情况，并说明其原理。</p>
<pre><code>mysql&gt; CREATE TABLE `t` ( 
    `id` int(11) NOT NULL, 
    `c` int(11) DEFAULT NULL, 
    PRIMARY KEY (`id`)
    ) ENGINE=InnoDB;


insert into t(id, c) values(1,1),(2,2),(3,3),(4,4);
</code></pre>
<p><img alt="Alt Image Text" src="../../images/chap2_6_9.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap2_6_10.png" title="Body image" /></p>
<p><img alt="Alt Image Text" src="../../images/chap2_6_11.png" title="Body image" /></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fc8c2696.min.js"></script>
      
    
  </body>
</html>