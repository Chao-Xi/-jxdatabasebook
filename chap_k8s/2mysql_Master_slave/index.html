
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Jacob's Database 技术与实战教程">
      
      
        <meta name="author" content="Jacob Xi">
      
      
      
        <link rel="prev" href="../1Mysql_k8s/">
      
      
        <link rel="next" href="../../db_ops/1db_intro/">
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.2">
    
    
      
        <title>第二节 在K8s中部署主从结构的MySQL服务 - Jacob DataBase Book</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7bf56d0a.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2-k8smysql" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Jacob DataBase Book" class="md-header__button md-logo" aria-label="Jacob DataBase Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jacob DataBase Book
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第二节 在K8s中部署主从结构的MySQL服务
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Chao-Xi/jxdatabasebook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxdatabasebook
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Jacob DataBase Book" class="md-nav__button md-logo" aria-label="Jacob DataBase Book" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Jacob DataBase Book
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Chao-Xi/jxdatabasebook.git" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    jxdatabasebook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          MySQL 基础篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          MySQL 基础篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/1mysql_exec/" class="md-nav__link">
        第一节 基础架构：执行一条SQL查询语句
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/2mysql_logs/" class="md-nav__link">
        第二节 日志系统：执行一条SQL更新语句
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/3mysql_isolaion/" class="md-nav__link">
        第三节 事务隔离
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/4mysql_index/" class="md-nav__link">
        第四节 深入浅出索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/5mysql_lock/" class="md-nav__link">
        第五节 全局锁和表锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/6mysql_transaction_isolation/" class="md-nav__link">
        第六节 事务到底是隔离的还是不隔离的
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql1_innodb/" class="md-nav__link">
        第七节 "Shallow Dive" MySQL 和 InnoDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql3_transaction/" class="md-nav__link">
        第八节 "Shallow Dive" MySQL 中事务的实现(`transaction`)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql2_index/" class="md-nav__link">
        第九节 "Shallow Dive" MySQL 索引设计概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql4_index_perf/" class="md-nav__link">
        第十节 "Shallow Dive" MySQL 索引性能分析概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/5DB_locc_mvcc/" class="md-nav__link">
        第十一节 浅谈数据库并发控制 - 锁和 MVCC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql4_index_perf/" class="md-nav__link">
        第十节 "Shallow Dive" MySQL 索引性能分析概要
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/5DB_locc_mvcc/" class="md-nav__link">
        第十一节 浅谈数据库并发控制 - 锁和 MVCC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql5_btree/" class="md-nav__link">
        第十二节 "Shallow Dive" MySQL 为何使用 B+ 树而非哈希或者B树
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap1/mysql_bia_review/" class="md-nav__link">
        MySQL 基础知识复习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          MySQL 实战篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          MySQL 实战篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/1table_design/" class="md-nav__link">
        L1 表结构设计篇 - 数据类型
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/2table_design/" class="md-nav__link">
        L2 表结构设计篇 - 表设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/3table_index/" class="md-nav__link">
        L3 索引优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/4table_query/" class="md-nav__link">
        L4 查询优化
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/5db_perf_replica/" class="md-nav__link">
        L5 高可用架构 - MySQL 复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/6db_ha/" class="md-nav__link">
        L6 MySQL高可用架构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/7Dist_db/" class="md-nav__link">
        L7 分布式架构篇
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/9Mysql_copy/" class="md-nav__link">
        L8 MySQL的零拷贝技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chap2_opt/8opt_int/" class="md-nav__link">
        L8 Operation Interview
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          AWS Aurora 技术与实战教程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          AWS Aurora 技术与实战教程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/1Intital_Explore/" class="md-nav__link">
        第一节 深入了解 Aurora 数据库
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/2Aurora_Adv/" class="md-nav__link">
        第二节 揭秘 Aurora 底层存储
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aurora/3Aurora_operation/" class="md-nav__link">
        第三节 Aurora Basic Operation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          MySQL on K8S
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MySQL on K8S
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1Mysql_k8s/" class="md-nav__link">
        第一节 Kubernetes 部署 MySQL 主从服务
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          第二节 在K8s中部署主从结构的MySQL服务
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        第二节 在K8s中部署主从结构的MySQL服务
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#01" class="md-nav__link">
    01 介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02-mysql" class="md-nav__link">
    02 部署mysql
  </a>
  
    <nav class="md-nav" aria-label="02 部署mysql">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configmap" class="md-nav__link">
    创建一个ConfigMap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mysql-root-secret" class="md-nav__link">
    创建一个MYSQL ROOT Secret
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pvpvc" class="md-nav__link">
    创建pv和pvc，写入稳定存储
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service" class="md-nav__link">
    创建 Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statefulset" class="md-nav__link">
    创建 StatefulSet
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03" class="md-nav__link">
    03 主从同步
  </a>
  
    <nav class="md-nav" aria-label="03 主从同步">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mysql-slave" class="md-nav__link">
    然后进入到mysql-slave内部
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#04" class="md-nav__link">
    04 结果验证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#05" class="md-nav__link">
    05 总结
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          MySQL 基础操作篇
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          MySQL 基础操作篇
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/1db_intro/" class="md-nav__link">
        第一节 数据库简介、及常用数据库介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/2db_install/" class="md-nav__link">
        第二节 安装 MySQL Repository & Jam db install
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/3db_sql/" class="md-nav__link">
        第三节 结构化查询语言 SQL
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/4db_sql_ops1/" class="md-nav__link">
        第四节 MySQL 操作实例(上)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/5db_sql_ops2/" class="md-nav__link">
        第五节 MySQL 操作实例(中)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/6db_sql_ops3/" class="md-nav__link">
        第六节 Mysql操作实例(下)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/7db_type/" class="md-nav__link">
        第七节 MySQL 数据类型约束
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/8db_index/" class="md-nav__link">
        第八节 MySQL 索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/9db_mgt/" class="md-nav__link">
        第九节 MySQL 的用户管理和权限管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/10db_logs/" class="md-nav__link">
        第十节 MySQL 日志管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/11db_backup/" class="md-nav__link">
        第十一节 MySQL备份概述
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/13db_xtrabackup/" class="md-nav__link">
        第十二节 MySQL逻辑备份mysqldump
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/14mysql_replicate/" class="md-nav__link">
        第十四节 MySQL 主从复制原理介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/15mysql_master_slave/" class="md-nav__link">
        第十五节 MySQL 传统主从同步配置
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/16mysq_gtid/" class="md-nav__link">
        第十六节 MySQL 基于 GTID 的主从复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/17ops_review/" class="md-nav__link">
        Mysql OPS Review
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../db_ops/18review_short/" class="md-nav__link">
        SQL操作精简版
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          MongoDB 操作实战教程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          MongoDB 操作实战教程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/1mongodb_intro/" class="md-nav__link">
        1 MongoDB介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/2mongodb_install/" class="md-nav__link">
        2 MongoDB 快速安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/3mongodb_k8s_cluster/" class="md-nav__link">
        3 在 Kubernetes 上编排 MongoDB 集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/4mongodb_opt/" class="md-nav__link">
        4 MongoDB文档操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/5mongodb_springbboot/" class="md-nav__link">
        5 MongoDB整合SpringBoot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/6mongodb_pip/" class="md-nav__link">
        6 MongoDB 聚合操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/7mongodb_pip2/" class="md-nav__link">
        7 MongoDB聚合操作高级操作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/8mongodb_view/" class="md-nav__link">
        8 MongoDB视图
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/9mongodb_index/" class="md-nav__link">
        9 MongoDB索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/10mongodb_index_adv/" class="md-nav__link">
        10 索引属性
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo1/11mongodb_explain/" class="md-nav__link">
        11 explain执行计划详解
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          MongoDB 高级实战教程(全)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          MongoDB 高级实战教程(全)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/1mon_intro_install/" class="md-nav__link">
        1 认识文档数据库 MongoDB & 及数据安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/2mon_command/" class="md-nav__link">
        2 MongoDB 基本操作及聚合操作实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/3mon_rep/" class="md-nav__link">
        3 复制集机制及原理 & 实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/4mon_tools/" class="md-nav__link">
        4 MongoDB 全家桶
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/5mon_design/" class="md-nav__link">
        5 Mongo 模型设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/6mon_red_write/" class="md-nav__link">
        6 MongoDB 事务开发
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/7mon_changestream_bestdesign/" class="md-nav__link">
        7 MongoDB Change Stream & 开发最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/8mon_shard/" class="md-nav__link">
        8 Mongo Shards分片技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/9mon_monitor/" class="md-nav__link">
        9 MongoDB 监控最佳实践
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/10mon_bakup_restore/" class="md-nav__link">
        10 MongoDB 备份与恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/11mon_sec/" class="md-nav__link">
        11 MongoDB 安全设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/12mon_index/" class="md-nav__link">
        12 MongoDB 索引
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/13mon_perf/" class="md-nav__link">
        13 MongoDB 性能
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/14mon_cluster/" class="md-nav__link">
        14 高级集群设计
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/15mon_goonline/" class="md-nav__link">
        15 MongoDB上线及升级
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/16mon_sample/" class="md-nav__link">
        16 MongoDB 应用实例和场景
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/17mon_dms/" class="md-nav__link">
        17 数据迁移
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/18mon_spark/" class="md-nav__link">
        18 MongoDB + Spark实战
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/19mon_sql/" class="md-nav__link">
        19 MongoDB SQL 套接件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongo2/20MongoDB_mico_middle_service/" class="md-nav__link">
        20 MongoDB 与微服务 & 数据中台
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          PostgresSQL 12.6运维入门
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          PostgresSQL 12.6运维入门
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/2pg_intall/" class="md-nav__link">
        1 PostgreSQL介绍&安装&链接管理&用户权限管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/3pg_cmd/" class="md-nav__link">
        2 常用基础命令介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/4pg_logs/" class="md-nav__link">
        3 Online WAL[Write Head Log]日志（redo)
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/4pg_stru/" class="md-nav__link">
        4 体系结构介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/5pg_bak/" class="md-nav__link">
        5 备份恢复恢复
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/6pg_repl/" class="md-nav__link">
        6 Master-Slave流复制
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/7pg_ops/" class="md-nav__link">
        7 有用的系统函数
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../pg1/1pg_int/" class="md-nav__link">
        PostgreSQL Interview Questions 2022
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          AWS DB OTHERs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          AWS DB OTHERs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aws/1aws_neptune/" class="md-nav__link">
        L1 深入了解 Amazon Neptune 图数据库技术
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../aws/2dydb1/" class="md-nav__link">
        L2 分布式键值存储 Dynamo 的实现原理
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          Extra 知识扩展
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          Extra 知识扩展
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../extra/mkdoc_gitbook/" class="md-nav__link">
        GitHub+Travis+Mkdocs自动化构建文档库(DataBase)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#01" class="md-nav__link">
    01 介绍
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#02-mysql" class="md-nav__link">
    02 部署mysql
  </a>
  
    <nav class="md-nav" aria-label="02 部署mysql">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configmap" class="md-nav__link">
    创建一个ConfigMap
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mysql-root-secret" class="md-nav__link">
    创建一个MYSQL ROOT Secret
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pvpvc" class="md-nav__link">
    创建pv和pvc，写入稳定存储
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#service" class="md-nav__link">
    创建 Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statefulset" class="md-nav__link">
    创建 StatefulSet
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#03" class="md-nav__link">
    03 主从同步
  </a>
  
    <nav class="md-nav" aria-label="03 主从同步">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mysql-slave" class="md-nav__link">
    然后进入到mysql-slave内部
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#04" class="md-nav__link">
    04 结果验证
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#05" class="md-nav__link">
    05 总结
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="2-k8smysql"><strong>2 在K8s中部署主从结构的MySQL服务</strong></h1>
<h2 id="01">01 介绍</h2>
<p>RC、Deployment、DaemonSet都是面向无状态的服务，它们所管理的Pod的IP、名字、启停顺序等都是随机分配的，而StatefulSet，管理所有有状态的服务。</p>
<p>StatefulSet为了解决有状态服务的问题，它所管理的Pod拥有固定的Pod名称，一定的启停顺序，在StatefulSet中，Pod名字称为网络标识(hostname)，还必须要用到共享存储。</p>
<p>在Deployment中，与之对应的服务是service，而在StatefulSet中与之对应的headless service。</p>
<p><strong>headless service，即无头服务，与service的区别就是它没有Cluster IP，解析它的名称时将返回该Headless Service对应的全部Pod的节点列表</strong>。</p>
<p><strong>除此之外，StatefulSet在Headless Service的基础上又为StatefulSet控制的每个Pod副本创建了一个DNS域名，这个域名的格式为</strong>：</p>
<pre><code>(podname).(headless server name).namespace.svc.cluster.local
</code></pre>
<h2 id="02-mysql">02 部署mysql</h2>
<p>MySQL 示例部署包含一个ConfigMap、两个存储挂载pv和pvc、两个 Service 与一个 StatefulSet。</p>
<h3 id="configmap"><strong>创建一个ConfigMap</strong></h3>
<p>使用以下的 YAML 配置文件创建 ConfigMap ：</p>
<p><strong><code>mysql-master-cnf.yaml</code></strong></p>
<pre><code>#master--my.cnf
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-master-cnf
  namespace: bc-cnp
data:
  my.cnf: |-
    [client]
    default-character-set=utf8
    [mysql]
    default-character-set=utf8
    [mysqld]
    init_connect='SET collation_connection = utf8_unicode_ci'
    init_connect='SET NAMES utf8'
    character-set-server=utf8
    collation-server=utf8_unicode_ci
    skip-character-set-client-handshake
    skip-name-resolve
    server_id=1
    log-bin=mysql-bin
    read-only=1
    replicate-ignore-db=mysql
    replicate-ignore-db=sys
    replicate-ignore-db=information_schema
    replicate-ignore-db=performance_schema
</code></pre>
<p><strong><code>mysql-slave-cnf.yaml</code></strong></p>
<pre><code>#slave--my.cnf
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-slave-cnf
  namespace: bc-cnp
data:
  my.cnf: |-
    [client]
    default-character-set=utf8
    [mysql]
    default-character-set=utf8
    [mysqld]
    init_connect='SET collation_connection = utf8_unicode_ci'
    init_connect='SET NAMES utf8'
    character-set-server=utf8
    collation-server=utf8_unicode_ci
    skip-character-set-client-handshake
    skip-name-resolve
    server_id=2
    log-bin=mysql-bin
    read-only=0
    replicate-ignore-db=mysql
    replicate-ignore-db=sys
    replicate-ignore-db=information_schema
    replicate-ignore-db=performance_schema
</code></pre>
<pre><code>$ kubectl create ns bc-cnp

$ kubectl apply -f mysql-master-cnf.yaml

$ kubectl apply -f mysql-slave-cnf.yaml
</code></pre>
<p>这个 ConfigMap 提供 <code>my.cnf</code> 覆盖设置，可以独立控制 MySQL 主服务器配置。</p>
<p>ConfigMap 本身没有什么特别之处，因而也不会出现不同部分应用于不同的 Pod 的情况。</p>
<p>每个 Pod 都会在初始化时基于 StatefulSet 控制器提供的信息决定要查看的部分。</p>
<p>slave从服务器配置和主服务器配置基本相同，需要修改</p>
<ul>
<li><code>metadata.name= mysql-slave-cnf</code></li>
<li><code>server_id=2</code></li>
<li><code>read-only=0</code></li>
</ul>
<p>获取<code>mysql-master-0</code>和<code>mysql-slave-0</code>的ConfigMap ：</p>
<pre><code>kubectl get cm -nbc-cnp

NAME               DATA   AGE
kube-root-ca.crt   1      2m24s
mysql-master-cnf   1      115s
mysql-slave-cnf    1      55s
</code></pre>
<h3 id="mysql-root-secret"><strong>创建一个MYSQL ROOT Secret</strong></h3>
<p><code>mysql-secret.yaml</code></p>
<pre><code>apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: bc-cnp
  labels:
    app: mysql
type: Opaque
data:
  MYSQL_ROOT_PASSWORD: MTIzNDU2 # echo -n &quot;123456&quot; | base64
</code></pre>
<pre><code>$ kubectl apply -f mysql-secret.yaml
</code></pre>
<h3 id="pvpvc"><strong>创建pv和pvc，写入稳定存储</strong></h3>
<p>使用以下 YAML 配置文件创建服务：</p>
<p><strong><code>master-pvc-pv.yaml</code></strong></p>
<pre><code>---
#master--pv
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv-master
spec:
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 1Gi
  local:
    path: /Users/i515190/k8s_test/mysql
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - docker-desktop 
---
#master--pvc
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc-master
  namespace: bc-cnp
spec:
  accessModes:
    - ReadWriteOnce
  # storageClassName: hostpath
  resources:
    requests:
      storage: 1Gi
  # volumeName: mysql-pv-master
</code></pre>
<p><strong><code>slave-pvc-pv.yaml</code></strong></p>
<pre><code>---
#slave--pv
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv-master
spec:
  accessModes:
    - ReadWriteOnce
  capacity:
    storage: 1Gi
  local:
    path: /Users/i515190/k8s_test/mysql
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - docker-desktop 
---
#master--pvc
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc-master
  namespace: bc-cnp
spec:
  accessModes:
    - ReadWriteOnce
  # storageClassName: hostpath
  resources:
    requests:
      storage: 1Gi
  # volumeName: mysql-pv-master
</code></pre>
<p>slave采用同样的方式创建pv及pvc，只名字修改为slave即可。</p>
<p><strong>获取master和slave的PersistentVolumeClaims</strong>：</p>
<pre><code>$ kubectl apply -f master-pvc-pv.yaml 

$ kubectl apply -f slave-pvc-pv.yaml 

kubectl get pvc -nbc-cnp
</code></pre>
<p>为StatefulSet 控制器创建了两个 PersistentVolumeClaims， 绑定到两个 PersistentVolumes。</p>
<p>Mysql 服务器默认会加载位于 <code>/var/lib/mysql-files</code> 的文件。</p>
<p><strong>StatefulSet spec 中的 volumeMounts 字段保证了<code>/var/lib/mysql-files</code> 文件夹由一个 PersistentVolume 卷支持</strong>。</p>
<h3 id="service">创建 Service</h3>
<p>使用以下 YAML 配置文件创建服务：</p>
<p><strong><code>mysql-master-services.yaml</code></strong></p>
<pre><code>#master--headless service
apiVersion: v1
kind: Service
metadata:
  namespace: bc-cnp
  labels:
    app: mysql-master
  annotations:
    kubesphere.io/serviceType: statefulservice
    kubesphere.io/alias-name: mysql-master
  name: mysql-master
spec:
  sessionAffinity: ClientIP
  selector:
    app: mysql-master
  ports:
    - name: tcp-3306
      protocol: TCP
      port: 3306
      targetPort: 3306
    - name: tcp-33060
      protocol: TCP
      port: 33060
      targetPort: 33060
  clusterIP: None
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

---
#master--nodePort service
apiVersion: v1
kind: Service
metadata:
  name: mysql-master-front
  labels:
    app: mysql-master
  namespace: bc-cnp
spec:
  selector:
    app: mysql-master
  type: NodePort
  ports:
    - name: ''
      port: 3306
      protocol: TCP
      targetPort: 3306
      nodePort: 30001  
  sessionAffinity: None
</code></pre>
<p><strong><code>mysql-slave-services.yaml</code></strong></p>
<pre><code>#master--headless service
apiVersion: v1
kind: Service
metadata:
  namespace: bc-cnp
  labels:
    app: mysql-slave
  annotations:
    kubesphere.io/serviceType: statefulservice
    kubesphere.io/alias-name: mysql-slave
  name: mysql-slave
spec:
  sessionAffinity: ClientIP
  selector:
    app: mysql-slave
  ports:
    - name: tcp-3306
      protocol: TCP
      port: 3306
      targetPort: 3306
    - name: tcp-33060
      protocol: TCP
      port: 33060
      targetPort: 33060
  clusterIP: None
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

---
#master--nodePort service
apiVersion: v1
kind: Service
metadata:
  name: mysql-slave-front
  labels:
    app: mysql-slave
  namespace: bc-cnp
spec:
  selector:
    app: mysql-slave
  type: NodePort
  ports:
    - name: ''
      port: 3306
      protocol: TCP
      targetPort: 3306
      nodePort: 30002  
  sessionAffinity: None
</code></pre>
<p>执行YAML：</p>
<p>slave同样执行类似yaml，名字需要修改为mysql-slave相关，暴露nodeport改为：30002。</p>
<p>输出类似于：</p>
<pre><code>$ kubectl apply -f mysql-master-services.yaml 

$ kubectl apply -f mysql-slave-services.yaml 

$ kubectl get svc -n bc-cnp 
NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)              AGE
mysql-master         ClusterIP   None             &lt;none&gt;        3306/TCP,33060/TCP   69s
mysql-master-front   NodePort    10.101.3.70      &lt;none&gt;        3306:30001/TCP       69s
mysql-slave          ClusterIP   None             &lt;none&gt;        3306/TCP,33060/TCP   62s
mysql-slave-front    NodePort    10.107.251.175   &lt;none&gt;        3306:30002/TCP       62s
</code></pre>
<p><strong>headless service 的 CNAME 指向 SRV 记录（记录每个 Running 和 Ready 状态的 Pod）。SRV 记录指向一个包含 Pod IP 地址的记录表项。</strong></p>
<p>headless service给 StatefulSet 控制器 为集合中每个 Pod 创建的 DNS 条目提供了一个宿主。</p>
<p>因为无头服务名为 mysql-master，所以可以通过在同一 Kubernetes 集群和命名空间中的任何其他 Pod 内解析 <code>&lt;Pod 名称&gt;.mysql-master</code> 来访问 Pod。</p>
<p>mysql-master-front是一种常规 Service，具有其自己的集群 IP。该集群 IP 在报告就绪的所有 MySQL Pod 之间分配连接。可能的端点集合包括 MySQL 主节点和从节点。</p>
<p>请注意，只有读查询才能使用负载平衡的客户端 Service。因为只有一个 MySQL 主服务器，所以客户端应直接连接到 MySQL 主服务器 Pod （通过其在headless service 中的 DNS 条目）以执行写入操作</p>
<h3 id="statefulset"><strong>创建 StatefulSet</strong></h3>
<p>最后，使用以下 YAML 配置文件创建 StatefulSet：</p>
<p><strong><code>mysql-master-statefulset.yaml</code></strong></p>
<pre><code>#master--statefulset
apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: bc-cnp
  labels:
    app: mysql-master
  name: mysql-master
  annotations:
    kubesphere.io/alias-name: mysql-master
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql-master
  template:
    metadata:
      labels:
        app: mysql-master
    spec:
      containers:
        - name: master-container
         # type: worker
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: '1'
              memory: 1Gi
            limits:
              cpu: '1'
              memory: 1Gi
          image: mysql:8.0.18
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: MYSQL_ROOT_PASSWORD
          volumeMounts:
            - name: master-cnf-volume
              readOnly: false
              mountPath: /etc/mysql
            - name: master-data-volume
              readOnly: false
              mountPath: /var/lib/mysql-files
      serviceAccount: default
      # affinity:
      #   podAntiAffinity:
      #     preferredDuringSchedulingIgnoredDuringExecution:
      #       - weight: 100
      #         podAffinityTerm:
      #           labelSelector:
      #             matchLabels:
      #               app: mysql-master
      #           topologyKey: kubernetes.io/hostname
      volumes:
        - name: master-cnf-volume
          configMap:
            name: mysql-master-cnf
            items:
              - key: my.cnf
                path: my.cnf
        - name: master-data-volume
          persistentVolumeClaim:
            claimName: mysql-pvc-master
  serviceName: mysql-master
</code></pre>
<p><strong><code>mysql-slave-statefulset.yaml</code></strong></p>
<pre><code>#slave--statefulset
apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: bc-cnp
  labels:
    app: mysql-slave
  name: mysql-slave
  annotations:
    kubesphere.io/alias-name: mysql slave
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql-slave
  template:
    metadata:
      labels:
        app: mysql-slave
    spec:
      containers:
        - name: slave-container
         # type: worker
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: '1'
              memory: 1Gi
            limits:
              cpu: '1'
              memory: 1Gi
          image: mysql:8.0.18
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: MYSQL_ROOT_PASSWORD
          volumeMounts:
            - name: slave-cnf-volume
              readOnly: false
              mountPath: /etc/mysql
            - name: slave-data-volume
              readOnly: false
              mountPath: /var/lib/mysql-files
      serviceAccount: default
      # affinity:
      #   podAntiAffinity:
      #     preferredDuringSchedulingIgnoredDuringExecution:
      #       - weight: 100
      #         podAffinityTerm:
      #           labelSelector:
      #             matchLabels:
      #               app: mysql-slave
      #           topologyKey: kubernetes.io/hostname
      volumes:
        - name: slave-cnf-volume
          configMap:
            name: mysql-slave-cnf
            items:
              - key: my.cnf
                path: my.cnf
        - name: slave-data-volume
          persistentVolumeClaim:
            claimName: mysql-pvc-slave
  serviceName: mysql-slave
</code></pre>
<p>通过运行以下命令查看启动进度：</p>
<p>可以看到所有 2 个 Pod 进入 Running 状态：</p>
<pre><code>$ kubectl apply -f mysql-master-statefulset.yaml
statefulset.apps/mysql-master created
$ kubectl apply -f mysql-slave-statefulset.yaml 
statefulset.apps/mysql-slave created


$ kubectl get pods -n bc-cnp 
NAME             READY   STATUS    RESTARTS   AGE
mysql-master-0   1/1     Running   0          67s
mysql-slave-0    1/1     Running   0          27s
</code></pre>
<p>StatefulSet 中的每个 Pod 拥有一个唯一的顺序索引和稳定的网络身份标识。</p>
<p>这个标志基于 StatefulSet 控制器分配给每个 Pod 的唯一顺序索引。Pod 名称的格式为 <code>&lt;statefulset 名称&gt;-&lt;序号索引&gt;</code>。</p>
<h2 id="03">03 主从同步</h2>
<p>进入mysql-master容器内部</p>
<pre><code>$ kubectl exec -it mysql-master-0 sh -n bc-cnp 
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.

# 1.进入mysql内部
$ kubectl exec -it mysql-master-0 sh -n bc-cnp 
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
# mysql -uroot -p123456

#切换到 mysql DB
mysql&gt; USE mysql;   

Database changed

# 查看root用户是否具备远程访问权限
mysql&gt; select Host,User,authentication_string,password_expired,password_last_changed from user;
+-----------+------------------+------------------------------------------------------------------------+------------------+-----------------------+
| Host      | User             | authentication_string                                                  | password_expired | password_last_changed |
+-----------+------------------+------------------------------------------------------------------------+------------------+-----------------------+
| %         | root             | $A$005$|`K{0M=_,;/x'-cRV#kTHWatUJJ7.ERa9WgkADdVtfvb4OzWkfa1qKjMwl/f1 | N                | 2023-03-12 06:15:14   |
| localhost | mysql.infoschema | $A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED | N                | 2023-03-12 06:15:08   |
| localhost | mysql.session    | $A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED | N                | 2023-03-12 06:15:08   |
| localhost | mysql.sys        | $A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED | N                | 2023-03-12 06:15:08   |
| localhost | root             | $A$005$
                                        gb.,#;t)4ZPy+!IKDjAJA9Yh1nOzdQ5mRnBRy5srJq.M6iZ0KNxGaX9P1 | N                | 2023-03-12 06:15:14   |
+-----------+------------------+------------------------------------------------------------------------+------------------+-----------------------+
5 rows in set (0.00 sec)

# 2.授权 root可以远程访问（主从无关，如root没有访问权限，执行以下命令，方便我们远程连接MySQL）

mysql&gt; grant all privileges on *.* to 'root'@'%';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; flush privileges;
Query OK, 0 rows affected (0.00 sec)

# 3.添加用来同步的用户
CREATE USER 'repl'@'%' IDENTIFIED BY 'Passw0rd';
GRANT REPLICATION SLAVE ON *.* to 'repl'@'%';

# 4.查看master状态
mysql&gt; show master status\G;
*************************** 1. row ***************************
             File: mysql-bin.000003
         Position: 1095
     Binlog_Do_DB: 
 Binlog_Ignore_DB: 
Executed_Gtid_Set: 
1 row in set (0.00 sec)
</code></pre>
<h3 id="mysql-slave">然后进入到mysql-slave内部</h3>
<pre><code>$ kubectl exec -it mysql-slave-0 sh -n bc-cnp 
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.

# mysql -uroot -p123456     
mysql: [Warning] Using a password on the command line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.18 MySQL Community Server - GPL

mysql&gt; 

change master to master_host='mysql-master.bc-cnp.svc.cluster.local',master_user='repl',master_password='Passw0rd',master_log_file='mysql_bin.000003',master_log_pos=0;

# 启动从库同步
start slave;
# 查看从从库状态
show slave status\G;
</code></pre>
<p><code>mysql -h mysql-master.bc-cnp.svc.cluster.local  -urepl -pPassw0rd</code></p>
<p>只有当以下两项都是yes，才意味着同步成功。</p>
<pre><code>mysql&gt; show slave status\G;
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: mysql-master.bc-cnp.svc.cluster.local
                  Master_User: repl
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000003
          Read_Master_Log_Pos: 1095
               Relay_Log_File: mysql-slave-0-relay-bin.000005
                Relay_Log_Pos: 1309
        Relay_Master_Log_File: mysql-bin.000003
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: mysql,sys,information_schema,performance_schema
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
</code></pre>
<p>如果同步不成功，尝试执行以下命令，再次查看。</p>
<pre><code>top slave;
reset slave;
start slave;
</code></pre>
<h2 id="04">04 结果验证</h2>
<p>最终验证结果，在master mysql创建一个database及table，插入数据，在slave中依然能够查看相关数据，确认主从同步成功</p>
<p>进入主的mysql-master容器内部，执行创建操作，如下：</p>
<pre><code>$ kubectl exec -it mysql-master-0 sh -n bc-cnp 
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
# mysql -uroot -p123456   

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
4 rows in set (0.00 sec)

create database repl_test;
use repl_test;

create table student(Sno int, name varchar(10));
insert into student(Sno, name) values (20230312, &quot;ubsjx&quot;);
show tables;

select * from student;

mysql&gt; create database repl_test;
Query OK, 1 row affected (0.01 sec)

mysql&gt; use repl_test;
Database changed
mysql&gt; create table student(Sno int, name varchar(10));
Query OK, 0 rows affected (0.02 sec)

mysql&gt; insert into student(Sno, name) values (20230312, &quot;ubsjx&quot;);
Query OK, 1 row affected (0.01 sec)

mysql&gt; show tables;
+---------------------+
| Tables_in_repl_test |
+---------------------+
| student             |
+---------------------+
1 row in set (0.00 sec)

mysql&gt; select * from student;
+----------+-------+
| Sno      | name  |
+----------+-------+
| 20230312 | ubsjx |
+----------+-------+
1 row in set (0.01 sec)
</code></pre>
<p>进入从的mysql-slave容器内部，执行创建操作，如下：</p>
<pre><code>$ kubectl exec -it mysql-slave-0 sh -n bc-cnp 
kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.
# mysql -uroot -p123456   

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| repl_test          |
| sys                |
+--------------------+
5 rows in set (0.00 sec)

mysql&gt; use repl_test;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
+---------------------+
| Tables_in_repl_test |
+---------------------+
| student             |
+---------------------+
1 row in set (0.01 sec)


mysql&gt; select * from student;
+----------+-------+
| Sno      | name  |
+----------+-------+
| 20230312 | ubsjx |
+----------+-------+
1 row in set (0.00 sec)
</code></pre>
<p>至此，确认从库中已有主库中数据，同步成功。</p>
<h2 id="05">05 总结</h2>
<p>StatefulSet 中每个 Pod 都拥有一个基于其顺序索引的稳定的主机名，如果pod发生故障，StatefulSet 重启他们，Pod 的序号、主机名、SRV 条目和记录名称没有改变，但和 Pod 相关联的 IP 地址可能发生了改变。这就是为什么不要在其他应用中使用 StatefulSet 中 Pod 的 IP 地址进行连接，这点很重要。</p>
<p>StatefulSet 的活动成员是和 CNAME 相关联的 SRV 记录，其中只会包含 StatefulSet 中处于 Running 和 Ready 状态的 Pod。</p>
<p>如果我们的应用已经实现了用于测试是否已存活（liveness）并就绪（readiness）的连接逻辑，我们可以使用 Pod 的 SRV 记录（mysql-master.default.svc.cluster.local）。并且当里面的 Pod 的状态变为 Running 和 Ready 时，我们的应用就能够发现各个pod的地址。</p>
<p>虽然 mysql-master-0 和 mysql-slave-0 有时候会被重新调度，但它们仍然继续监听各自的主机名，因为和它们的 PersistentVolumeClaim 相关联的 PersistentVolume 卷被重新挂载到了各自的 volumeMount 上。不管mysql-master-0 和 mysql-slave-0 被调度到了哪个节点上，它们的 PersistentVolume 卷将会被挂载到合适的挂载点上。</p>
<p>至此，以上分享只是其中的一种主从方式容器化部署，还有其他的方案，后面也会陆续的分享，希望大家持续的关注。</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021-9999 Jacob Xi
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fc8c2696.min.js"></script>
      
    
  </body>
</html>