{"config":{"lang":["ja"],"separator":"[\\s\\-\uff0c\u3002]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u624b\u6478\u624bDatabases\u5168\u5bb6\u6876\u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b","text":"<p>Started at 15th Jan.2021 By Jacob Xi</p> <p>MySQL, Aurora, MongoDB, PostgresSQL, AWS Neptune, AWS DynamoDB</p>"},{"location":"#jxs-chit-chat","title":"JX's chit-chat","text":"<p>Hi, this part is fucingk new and freshing\ud83e\udd14</p> <p>Well, believe it or not, today is 9th May 2022. I have been already locked down for stupid COVID-19 quarantine and isolation for the fucking 52 days from mid-March.  Saw too many unbelievable and fucking magical realism in Shanghai these days. Dont tell me \"C'est la vie\". Life should not be falling and yielding like this. I'm a peaceful man but I'm already outrageous for such a long time, really tired, really...</p> <p>\u8bf4\u70b9\u5f00\u5fc3\u7684\ud83e\udd20</p> <ul> <li>\u5c01\u95ed\u7684\u5c06\u8fd1\u4e24\u4e2a\u6708\uff0c\u6bcf\u5929\u53ef\u4ee5\u505a\u5230\u957f\u8dd115km, \u4f3c\u4e4e\u51cf\u80a5\u4e86\uff0c\u4f3c\u4e4e\ud83d\ude11</li> <li>\u770b\u4e86\u51e0\u90e8\u4e0d\u9519\u7684\u521b\u4e1a\u5267\uff0c\u6709\u8bb2 Travis Kalanick Uber CEO \u7684\u300aSuper Pumped: The Battle For Uber\u300b\uff0c\u6545\u4e8b\u91cd\u73b0Uber\u8fc7\u5c71\u8f66\u5f0f\u7684\u5174\u8870\u3001\u5f15\u8d77\u8bf8\u591a\u540e\u679c\u7684\u5185\u5916\u4ea4\u6218\uff0c\u4f53\u73b0\u7845\u8c37\u7684\u8d77\u8d77\u4f0f\u4f0f\u3002\u8bb2Adam Neumann Wework CEO \u7684\u300aWeCrashed: The Rise and Fall of WeWork\u300b\uff0c\u8bb2\u8ff0\u5171\u4eab\u529e\u516c\u5ba4\u516c\u53f8WeWork\u7684\u5d1b\u8d77\u4ee5\u53ca\u8870\u843d\u3002\u8fd8\u6709\u8bb2 Theranos CEO Elizabeth Holmes\u300aThe Dropout\u300b\u5229\u6b32\u718f\u5fc3\u4e0bElizabeth\u5f00\u59cb\u4e0d\u505c\u9020\u5047\u3002Nice shows \ud83e\udd20</li> <li>\u53e6\u5916 \u300a\u6708\u5149\u9a91\u58eb\u300b\u4e0d\u9519\uff0c \u300aslow horse\u300b\u4e0d\u77e5\u9053\u5728\u8bb2\u5565\uff0c \u300aHALO\u300b\u5783\u573e\uff0c\u767d\u778e\u4e86\u90a3\u4e48\u597d\u7684\u5236\u4f5c\uff0c\u767d\u5de6\u53bb\u6b7b\u3002 The last but not least, \u300a\u5927\u4fa6\u63a2\u6ce2\u6d1b\u300b\u771f\u7684\u662f\u4f20\u4e16\u7ecf\u5178</li> <li>\u4e24\u672c\u4e66\uff0c\u6700\u8fd1\u770b\u4e66\u6709\u70b9\u5c11 \u4e1c\u91ce\u572d\u543e\u7684\u300a\u957f\u957f\u7684\u56de\u5eca\u300b\uff0c\u5c3c\u5c14\u53f2\u8482\u82ac\u68ee\u7684\u300a\u96ea\u5d29\u300b, \u8d85\u6e90\u57df\u771f\u662f\u597d\u4e1c\u897f</li> <li>\u53c8\u5f00\u59cb\u770b\u6700\u65b0\u7684 \u300a\u5deb\u5e088\u300b\uff0c\u6211\u4eec\u7684\u730e\u9b54\u4eba\u53c8\u548c\u5973\u672f\u58eb\u641e\u5230\u4e00\u8d77\u4e86</li> <li>\u5927\u4e8b\u60c5\u8981\u53d1\u751f\u4e86\uff0c\u611f\u8c22\u81ea\u5df1\u7684\u8fd9\u4e00\u5e74\u7684\u52aa\u529b</li> </ul>"},{"location":"#_1","title":"\u5185\u5bb9\u7b80\u4ecb","text":"<p>\u672c\u4e66\u7ecf\u8fc7\u4e86\u6f2b\u957f\u7684\uff0c\u8d85\u8fc7\u4e00\u5e74\u534a\u7684\u7f16\u5199\u3002\u7ec8\u4e8e\u57282022\uff0c\u4e94\u6708\u4e2d\u65ec\u5b8c\u6210\u4e86\u9636\u6bb5\u6027\u7684\u6536\u5c3e\u5de5\u4f5c\u3002 \u672c\u4e66\u51719\u7ae0\uff08Temp) \u3002 \u5176\u4e2d\u4e94\u7ae0\u4ecb\u7ecdMySQL, \u4e24\u7ae0\u4ecb\u7ecdMongoDB, \u4e00\u7ae0PostgresSQL, \u4e00\u7ae0Aurora, \u4e00\u7ae0AWS DBs(Neptune+ DynamoDB)</p> <ul> <li>MySQL \u57fa\u7840\u7bc7: \u4ecb\u7ecd\u4e86MySQL\u7684\u5e95\u5c42\u903b\u8f91 \u9694\u79bb\uff0c\u7d22\u5f15\uff0c\u5e76\u53d1\u63a7\u5236\uff0c\u9501,B+\uff0c\u6811\uff0c\u4e8b\u52a1\uff0cMVCC</li> <li>MySQL \u5b9e\u6218\u7bc7(\u9762\u8bd5\u7528): \u4ece\u5b9e\u6218\u89d2\u5ea6\u4f18\u5316MYSQL, \u6570\u636e\u7c7b\u578b, \u8868\u8bbe\u8ba1\uff0c\u7d22\u5f15\u4f18\u5316\uff0c\u67e5\u8be2\u4f18\u5316\uff0c\u9ad8\u53ef\u7528\u67b6\u6784\uff0c\u5206\u5e03\u5f0f\u67b6\u6784\uff0c\u5b9e\u6218\u9762\u8bd5</li> <li>AWS Aurora: \u4ecb\u7ecd\u4e86AWS aurora\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u5e95\u5c42\u5b58\u50a8\u548c\u57fa\u672c\u64cd\u4f5c</li> <li>MySQL on K8S</li> <li>MySQL \u57fa\u7840\u64cd\u4f5c\u7bc7(\u64cd\u4f5c\u6307\u5357)\uff1a \u64cd\u4f5c\u5b9e\u4f8b\uff0c\u6570\u636e\u7ea6\u675f\uff0c\u7d22\u5f15\uff0c\u7528\u6237\u7ba1\u7406\uff0c\u65e5\u5fd7\uff0c\u5907\u4efd\u7ba1\u7406\uff0c\u4e3b\u4ece\u590d\u5236\uff0cGTID</li> <li>MongoDB\u64cd\u4f5c\u5b9e\u6218\uff1a\u5b89\u88c5\uff0c\u6587\u6863\u64cd\u4f5c\uff0c\u805a\u5408\u64cd\u4f5c\uff0c\u805a\u5408\u9ad8\u7ea7\u64cd\u4f5c\uff0c\u89c6\u56fe\uff0c\u7d22\u5f15</li> <li>MongoDB\u9ad8\u7ea7\u5b9e\u6218\uff1aMongoDB \u518d\u5165\u95e8\uff0c \u4ece\u719f\u7ec3\u5230\u7cbe\u901a\u7684\u5f00\u53d1\u4e4b\u8def\uff0c \u7247\u96c6\u7fa4\u4e0e\u9ad8\u7ea7\u8fd0\u7ef4\u4e4b\u9053\uff0c \u96c6\u4e2d\u5b9e\u6218\u638c\u63e1\u6846\u67b6\u6784\u5efa\u4e4b\u6cd5</li> <li>PostgresSQL 12.6\u8fd0\u7ef4(\u5b9e\u6218)\uff1a\u94fe\u63a5\u7ba1\u7406&amp;\u6743\u9650\u7ba1\u7406\uff0c\u5e38\u7528\u547d\u4ee4\uff0c\u7cfb\u7edf\u67b6\u6784\uff0c\u5907\u4efd\u6062\u590d\uff0cMS\u590d\u5236\uff0c\u7cfb\u7edf\u51fd\u6570</li> <li>AWS DB others:  Amazon Neptune \u56fe\u6570\u636e\u5e93\u6280\u672f,  \u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8 DynamoDB </li> </ul> <p></p>"},{"location":"#previous-on-my-technolog-book","title":"Previous on my Technolog book","text":"<p>\u624b\u6478\u624b Jenkins \u6218\u672f\u6559\u7a0b (\u5927\u5e08\u7248\uff09</p> <p>\u624b\u6478\u624b Elasticsearch7 \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Redis \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Chef &amp; Ansible \u6280\u672f\u4e0e\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b \u5206\u5e03\u5f0f\u4e0e\u6d41\u5f0f\u7cfb\u7edf (In progress)</p> <p>Azure 103&amp;900 Tutorial (In progress)</p> <p>\u624b\u6478\u624b Linux Performance &amp; \u9762\u8bd5\u5b9e\u6218\u6559\u7a0b</p> <p>\u624b\u6478\u624b Databases \u5168\u6559\u7a0b</p> <p>AWS Certified Data Analytics Tutorial</p> <p>Istio &amp; Service Mesh \u6218\u672f\u6559\u7a0b</p> <p>AWS Certification Solutions Architect Book</p> <p>Distributed Message System Book(Kafka)</p>"},{"location":"#salut-cest-moi","title":"Salut! C'est Moi","text":"<p>The man is not old as long as he is seeking something, A man is not old until regrets take the place of dreams.</p> <p>Hello, this is me, Jacob. Currently, I'm working as DevOps and Cloud Engineer in SAP, and I'm the certified AWS Solution Architect and Certified Azure Administrator, Kubernetes Specialist, Jenkins CI/CD and ElasticStack enthusiast. </p> <p>I was working as Backend Engineer in New York City and achieved my CS master degree in SIT, America. Believe it or not, I'll keep writing, more and more books will come out at such dramatic and unprecedented 2021. </p> <p>If you have anything want to talk to me directly, you can reach out for via email xichao2015@outlook.com\u3002</p> <p>Salute, c'est moi, Jacob. Actuellement, je travaille en tant qu'ing\u00e9nieur DevOps et Cloud dans SAP, et je suis architecte de solution AWS certifi\u00e9 et administrateur Azure certifi\u00e9, sp\u00e9cialiste Kubernetes et passionn\u00e9 de CI/CD.</p> <p>Je travaillais en tant qu'ing\u00e9nieur backend \u00e0 New York et j'ai obtenu mon master CS \u00e0 SIT, en Am\u00e9rique. Croyez-le ou non, je continuerai \u00e0 \u00e9crire, de plus en plus de livres sortiront cette ann\u00e9e.</p> <p></p>"},{"location":"#to-be-continue","title":"To be continue","text":"<p>I will start working on Prometheus book later on and in future, I will put more effort do finish \"Distributed Message System Book\".\ud83d\ude42</p>"},{"location":"aurora/1Intital_Explore/","title":"\u7b2c\u4e00\u8282 \u6df1\u5165\u4e86\u89e3 Aurora \u6570\u636e\u5e93","text":""},{"location":"aurora/1Intital_Explore/#1-amazon-aurora","title":"1\u3001\u4ec0\u4e48\u662f Amazon Aurora  \u4e13\u95e8\u4e3a\u4e91\u6253\u9020\u7684\u5173\u7cfb\u6570\u636e\u5e93","text":"<ul> <li>\u9ad8\u7aef\u5546\u7528\u6570\u636e\u5e93\u7684\u6027\u80fd\u548c\u53ef\u7528\u6027</li> <li>\u5f00\u6e90\u6570\u636e\u5e93\u7684\u7b80\u5355\u6027\u548c\u6210\u672c\u6548\u76ca</li> <li>\u5b8c\u5168\u517c\u5bb9 MySQL \u548c PostgreSQL \u5f00\u6e90\u6570\u636e\u5e93 </li> <li>\u6309\u4f7f\u7528\u91cf\u4ed8\u8d39\uff0cPay as you go</li> </ul> <p>\u5168\u6258\u7ba1\u7684\u6570\u636e\u5e93\uff1a \u7528\u6237\u4e0d\u7528\u8003\u8651\u7269\u7406\u7684\u8bbe\u5907\u7684\u7ba1\u7406</p>"},{"location":"aurora/1Intital_Explore/#2auroraaws","title":"2\u3001Aurora\u662fAWS\u53f2\u4e0a\u589e\u957f\u6700\u5feb\u7684\u670d\u52a1","text":"<p>\u5728\u524d\u767e\u5927AWS\u5ba2\u6237\u4e2d\uff0c\u6709\u56db\u5206\u4e4b\u4e09\u9009\u62e9\u4f7f\u7528Amazon Aurora</p>"},{"location":"aurora/1Intital_Explore/#3amazon-aurora","title":"3\u3001Amazon Aurora \u7684\u4f18\u52bf","text":"<p>\u517c\u5bb9 MySQL \u548c PostgreSQL \u7684\u5173\u7cfb\u6570\u636e\u5e93\u3002 \u6027\u80fd\u548c\u53ef\u7528\u6027\u4e0e\u5546\u7528\u6570\u636e\u5e93\u76f8\u5f53\uff0c\u6210\u672c\u53ea\u6709 1/10\u3002</p>"},{"location":"aurora/1Intital_Explore/#3-1","title":"3-1 \u9ad8\u6027\u80fd\u548c\u9ad8\u53ef\u6269\u5c55\u6027","text":"<ul> <li>5 \u500d\u4e8e\u6807\u51c6 MySQL \u7684\u541e\u5410\u91cf</li> <li>3 \u500d\u4e8ePostgreSQL \u7684\u541e\u5410\u91cf </li> <li>\u6027\u80fd\u76f8\u5f53\u800c\u6210\u672c\u4ec5\u4e3a\u5546\u7528DB\u76841/10 </li> <li>\u53ef\u4ee5\u8de83\u4e2aAZ,\u6700\u591a 15 \u4e2a\u53ef\u8bfb\u526f\u672c </li> <li>\u5b58\u50a8\u81ea\u589e\u957f\uff0c\u5355\u5b9e\u4f8b\u53ef\u8fbe 64TB</li> </ul>"},{"location":"aurora/1Intital_Explore/#3-2","title":"3-2 \u9ad8\u53ef\u7528\u6027\u548c\u9ad8\u8010\u7528\u6027","text":"<ul> <li>\u53ef\u7528\u6027\u9ad8\u4e8e 99.99% </li> <li>\u5177\u6709\u5bb9\u9519\u53ca\u81ea\u6211\u4fee\u590d\u80fd\u529b </li> <li>\u8de83\u4e2aAZ\u590d\u52366\u4e2a\u6570\u636e\u526f\u672c </li> <li>\u6570\u636e\u6301\u7eed\u5907\u4efd\u5230 S3 </li> <li>\u5b9e\u4f8b\u6545\u969c\u8f6c\u79fb\u5c0f\u4e8e30\u79d2</li> </ul>"},{"location":"aurora/1Intital_Explore/#3-3","title":"3-3 \u9ad8\u5ea6\u5b89\u5168","text":"<ul> <li>\u90e8\u7f72\u5728\u5ba2\u6237\u7684VPC, \u901a\u8fc7VPC\u8fdb\u884c\u7f51\u7edc\u7ea7\u9694\u79bb\uff0c</li> <li>\u652f\u6301\u9759\u6001\u5b58\u50a8\u53ca\u4f20\u8f93\u65f6\u52a0\u5bc6\uff0c</li> <li>\u96c6\u7fa4\u4e2d\u7684\u5907\u4efd\u3001\u5feb\u7167\u548c\u526f\u672c\u81ea\u52a8\u52a0\u5bc6</li> </ul>"},{"location":"aurora/1Intital_Explore/#3-4","title":"3-4 \u5b8c\u5168\u6258\u7ba1","text":"<ul> <li>\u65e0\u9700\u62c5\u5fc3\u786c\u4ef6\u3001\u8f6f\u4ef6\u8865\u4e01\u3001 \u8bbe\u7f6e\u3001\u914d\u7f6e\u6216\u5907\u4efd\u7b49\u6570\u636e\u5e93\u7ba1\u7406\u4efb\u52a1\u3002</li> <li>\u4f1a\u81ea\u52a8\u6301\u7eed\u76d1\u63a7\u5e76\u5c06\u5176\u5907\u4efd\u5230 S3\uff0c\u53ef\u4ee5\u5b9e\u73b0\u7cbe\u7ec6\u7684\u65f6\u95f4\u70b9\u6062\u590d\u3002</li> </ul>"},{"location":"aurora/1Intital_Explore/#3-5-aurora","title":"3-5 Aurora\u9002\u7528\u573a\u666f","text":"<p>\u4e3b\u8981\u573a\u666f </p> <ul> <li>\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u573a\u666f </li> <li>\u8bfb\u5199\u8bfb\u5199\u8d1f\u8f7d\u6781\u9ad8\u2014\u2014\u793e\u4ea4\u5e94\u7528\uff0c\u5927\u578b\u7f51\u7ad9\uff0c\u6e38\u620f\uff0c\u5e01\u5708\u4ea4\u6613\u7b49 </li> <li>\u6570\u636e\u5e93\u5bb9\u4e14\u5f88\u5927\uff0c\u5e76\u4e14\u589e\u957f\u8f83\u5feb </li> <li>\u6570\u636e\u5e93\u5e76\u5e76\u53d1\u91cf\u5458\u9ad8\uff0c\u5305\u542b\u4e86OLTP\u548c\u90e8\u5206\u6570\u636e\u5206\u6790\u573a\u666f </li> <li>\u9700\u8981sharding\u6570\u636e\u6216\u8005\u4f7f\u7528\u5206\u5e93\u5206\u8868\u4e2d\u95f4\u4ef6 </li> <li>\u5bf9\u6570\u636e\u5e93\u53ef\u7528\u6027\u8981\u6c42\u5f88\u9ad8\u7684\u573a\u666f\u3001</li> </ul> <p>\u53d7\u76ca </p> <ul> <li>\u9ad8\u53ef\u7528\u53ca\u6301\u4e45\u6027 </li> <li>\u9ad8\u5e76\u53d1\u53ca\u541e\u5410\u91cf</li> </ul>"},{"location":"aurora/1Intital_Explore/#4amazon-aurora","title":"4\u3001Amazon Aurora \u67b6\u6784\u4e4b\uff1a \u6027\u80fd","text":""},{"location":"aurora/1Intital_Explore/#4-1","title":"4-1 \u4f20\u7edf\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u7684\u5806\u6808","text":""},{"location":"aurora/1Intital_Explore/#4-1-1","title":"4-1-1 \u5206\u7247","text":"<ul> <li>\u5e94\u7528\u7a0b\u5e8f\u8fde\u63a5\u5230\u4e2d\u95f4\u4ef6\u7684\u5e73\u53f0\u4e0a</li> <li>\u4e2d\u95f4\u4ef6\u628a\u8bfb\u5199\u6570\u636e\u7684\u8bf7\u6c42\u8def\u7531\u5230\u4e0d\u540c\u7684\u6570\u636e\u5e93\u4e0a\u9762</li> <li>\u4e0d\u540c\u7684\u6570\u636e\u5e93\u5404\u81ea\u7ef4\u62a4\u4e00\u90e8\u5206\u7684\u6570\u636e\u5b58\u5728\u672c\u5730\u7684\u5b58\u50a8\u91cc</li> </ul>"},{"location":"aurora/1Intital_Explore/#4-1-2","title":"4-1-2 \u65e0\u5171\u4eab","text":"<ul> <li>\u6211\u4eec\u6709\u4e0d\u540c\u7684\uff0c\u5404\u81ea\u72ec\u7acb\u7684\u6570\u636e\u5e93\u670d\u52a1\u5668</li> <li>\u8fd9\u4e9b\u670d\u52a1\u5668\u52a0\u5165\u4e00\u4e2a\u7ec4\u91cc\u9762\u6765</li> <li>\u5e94\u7528\u7a0b\u5e8f\u5f80\u672c\u5730\u6570\u636e\u5e93\u5199\u4e8b\u52a1</li> <li>\u4e8b\u52a1\u5199\u5165\u540e\uff0c\u901a\u8fc7\u6570\u636e\u5e93\u5f15\u64ce\u5c42\u8fdb\u884c\u6570\u636e\u7684\u5206\u53d1\u548c\u540c\u6b65 =&gt; replication group</li> </ul>"},{"location":"aurora/1Intital_Explore/#4-1-3","title":"4-1-3 \u5171\u4eab\u78c1\u76d8","text":"<ul> <li>\u5171\u4eab\u78c1\u76d8 + \u5171\u4eab\u7f13\u5b58</li> <li>Oracle rac \u901a\u8fc7\u5171\u4eab\u5b58\u50a8\u7684\u65b9\u5f0f\u8ba9\u6bcf\u4e00\u4e2a\u6570\u636e\u5e93\u8282\u70b9\u6216\u8005\u5171\u4eab\u5b9e\u4f8b\u90fd\u80fd\u8bfb\u5230\u76f8\u540c\u7684\u6570\u636e</li> <li>\u5e94\u7528\u7a0b\u5e8f\u5f80\u4efb\u4f55\u4e00\u4e2a\u5b9e\u4f8b\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\uff0c\u6bcf\u4e2a\u6570\u636e\u5e93\u8282\u70b9\u90fd\u53ef\u4ee5\u770b\u5230\u6574\u4e2a\u96c6\u7fa4\u91cc\u7684\u6570\u636e\uff0c\u5305\u62ec\u5185\u5b58\u548c\u786c\u76d8\u4e0a\u7684</li> </ul>"},{"location":"aurora/1Intital_Explore/#4-2-amazon-aurora","title":"4-2 Amazon Aurora: \u6a2a\u5411\u6269\u5c55\uff0c\u5206\u5e03\u5f0f\u67b6\u6784","text":"<p>\u5e94\u7528\u4e8e\u6570\u636e\u5e93\u7684\u9762\u5411\u670d\u52a1\u7684\u4f53\u7cfb\u7ed3\u6784</p> <p></p> <ul> <li>\u5c06\u65e5\u5fd7\u548c\u5b58\u50a8\u5c42\u79fb\u52a8\u5230\u53ef\u6269\u5c55\u3001\u6570\u636e\u5e93\u4f18\u5316\u7684\u5b58\u50a8\u670d\u52a1\u4e2d <ul> <li>Aurora\u6570\u636e\u5e93\u5305\u542b\u4e0a\u5c42\u5b9e\u4f8b\u548c\u5e95\u5c42\u5b58\u50a8.\u8ba1\u7b97\u5b58\u50a8\u5206\u79bb\uff0c\u6613\u4e8e\u6a2a\u5411\u6269\u5c55</li> <li>\u5206\u79bb\u4e86\u7f13\u5b58\u548c\u8ba1\u7b97\uff0c\u5c31\u7b97\u6570\u636e\u5e93\u8fdb\u7a0b\u6302\u6389\uff0c\u91cd\u542f\u6570\u636e\u5e93\u8fdb\u7a0b\uff0c\u5b83\u7684\u7f13\u5b58\u8fd8\u5728\u3002\u6781\u5927\u7684\u63d0\u9ad8\u6570\u636e\u5e93\u7684\u6027\u80fd\u4ee5\u53ca\u5907\u4efd\u548c\u6062\u590d\u65b9\u9762\u8d77\u5230\u5e2e\u52a9</li> </ul> </li> <li>\u4e0eS3, VPC\u4ee5\u53caRoute 53\u7b49\u5176\u4ed6AWS\u670d \u52a1\u7d27\u5bc6\u7ed3\u5408\u5b8c\u6210\u63a7\u5236\u548c\u76d1\u89c6\u4efb\u52a1</li> <li>\u6258\u7ba1\u6570\u636e\u5e93\u670d\u52a1Amazon RDS. \u5b8c\u6210\u8fd0\u7ef4\u548c\u7ba1\u7406\u4efb\u52a1\uff0e </li> <li>\u6301\u7eed\u5907\u4efd\u4e0eS3\u96c6\u6210\uff0c\u5e76\u5177\u670911\u4e2a9\u7684\u6301\u4e45\u6027 </li> </ul> <p>\u5229\u7528AWS \u73b0\u6709\u670d\u52a1</p> <ul> <li>DynamoDB(Key-Value): \u5b58\u50a8\u539f\u6570\u636emetadata, exp, \u5b58\u50a8\u8282\u70b9\u7684\u6570\u636e\u5206\u90e8\uff0c\u8f6f\u4ef6\u7684\u60c5\u51b5</li> <li>Route53: DNS\u7684\u53d8\u5316</li> <li>EC2</li> <li>S3 \u5907\u4efd</li> </ul> <p></p> <ul> <li>\u5206\u5e03\u5f0f\u4f53\u73b0\u5728\u5b58\u50a8\u5c42\uff0c\u6570\u636e\u5206\u90e8\u5728\u5171\u4eab\u7684\u5b58\u50a8\u5377\u4e2d</li> <li>\u5b58\u50a8\u5377\u6a2a\u8de8\u4e09\u4e2aAZ</li> <li>\u6bcf\u4efd\u6570\u636e\u67096\u4efd\u62f7\u8d1d</li> <li>\u4e3b\u8282\u70b9\uff1a \u5f53\u6570\u636e\u5e93\u670d\u52a1\u5668\u53d1\u51fa\u4e00\u4e2a\u4fee\u6539\u64cd\u4f5c\uff08dml) ,\u53ea\u6709\u54cd\u5e94\u7684\u65e5\u5fd7\u6d41\u4f1a\u5199\u5165\u5171\u4eab\u5b58\u50a8\u5377</li> <li>\u4fee\u6539\u7684\u6570\u636e\u5757\uff08\u6216\u8005\u810f\u6570\u636e\u5757\uff09\u4e0d\u4f1a\u88ab\u5237\u65b0\u5230\u78c1\u76d8\u4e0a</li> </ul>"},{"location":"aurora/1Intital_Explore/#4-2-1","title":"4-2-1 \u6a2a\u5411\u6269\u5c55\u4e14\u57fa\u4e8e\u65e5\u5fd7\u7ed3\u6784\u7684\u5206\u5e03\u5f0f\u5b58\u50a8","text":"<ul> <li>\u5c06Log\u673a\u5236\u63a8\u9001\u81f3\u5b58\u50a8\u5c42 </li> <li>4/6\u5199\u5165\u4ef2\u88c1\u4e0e\u672c\u5730\u8ddf\u8e2a <ul> <li>\u5199\u5165\u6027\u80fd: \u53ea\u4fdd\u7559Log\u5199\u5165\u76d8\uff0c\u63d0\u9ad8\u4e86\u5e76\u53d1\u7684\u5199\u5165\u6027\u80fd</li> <li>\u8bfb\u53d6\u6a2a\u5411\u6269\u5c55\uff1a<ul> <li>\u8bfb\u526f\u672c\u548c\u4e3b\u8282\u70b9\u5171\u4eab\u5b58\u50a8\u5377</li> <li>\u8bfb\u526f\u672c\u4e0d\u9700\u8981\u50cf\u4f20\u7edf\u7684\u5173\u7cfb\u6570\u636e\u5e93\u901a\u8fc7\u5e94\u7528\u65e5\u5fd7\u53bb\u8ffd\u4e3b\u5e93\u7684\uff0c\u8bfb\u526f\u672c\u4e0d\u9700\u8981\u81ea\u5df1\u7ef4\u62a4\u4e00\u4e2a\u6570\u636e\u6587\u4ef6\uff0c\u5b83\u548c\u4e3b\u8282\u70b9\u5171\u4eab\u6570\u636e\u6587\u4ef6</li> <li>\u5f88\u65b9\u4fbf\u7684\u6dfb\u52a0\u8bfb\u526f\u672c\u8282\u70b9\uff0c\u63d0\u9ad8\u8bfb\u7684\u6548\u7387</li> </ul> </li> <li>\u53ef\u7528\u533a<code>+1</code> \u5bb9\u9519\u673a\u5236\uff1a 6\u4efd\u526f\u672c\u53ef\u4ee5\u65e0\u89c6AZ\u7684\u5d29\u6e83\u4ee5\u53ca\u4e00\u4e2a\u5b58\u50a8\u8282\u70b9\u7684\u5d29\u6e83</li> <li>\u5373\u65f6\u6570\u636e\u5e93\u91cd\u505a\u6062\u590d\uff1a 10Gb/segment \u4e3a\u5355\u4f4d\u53bb\u6062\u590d\uff0c\u5e76\u53d1\u64cd\u4f5c\uff0c\u6548\u7387\u975e\u5e38\u7684\u9ad8</li> </ul> </li> </ul>"},{"location":"aurora/1Intital_Explore/#5amazon-aurora","title":"5\u3001Amazon Aurora\u5b58\u50a8\u5f15\u64ce\u6982\u8ff0","text":"<ul> <li>\u6570\u636e\u57283 Availability Zones\u4e2d\u590d\u52366\u4efd(\u6bcf\u4e00\u4efd\u5b58\u5728\u4e00\u4efd\u5b58\u50a8\u8282\u70b9) </li> <li>\u6301\u7eed\u5907\u4efd\u5230Amazon S3 (11\u4e2a9\u7684\u6301\u4e45\u6027\uff09</li> <li>\u6301\u7eed\u76d1\u89c6\u8282\u70b9\u548c\u78c1\u76d8\u5e76\u81ea\u52a8\u4fee\u590d</li> <li>10GB\u7684\u533a\u6bb5\u4f5c\u4e3a\u4fee\u590d\u548c\u5b58\u50a8\u81ea\u52a8\u589e\u957f\u7684\u57fa\u7840\uff0c\u5b58\u50a8\u6700\u5927\u6269\u5c55\u523064TB </li> <li>4/6 \u5199\u5165\u4ef2\u88c1 </li> </ul>"},{"location":"aurora/1Intital_Explore/#6mysql-amzaon-aurora-io","title":"6\u3001MySQL \u4e0e Amzaon Aurora\u7684 I/O \u914d\u7f6e\u5dee\u5f02","text":""},{"location":"aurora/1Intital_Explore/#6-1-mysql","title":"6-1 \u4e3b\u4ece\u914d\u7f6emysql","text":"<ol> <li>\u6bcf\u6b21\u4e3b\u5b9e\u4f8b\u53d1\u751f\u4e8b\u52a1\uff0c\u6bcf\u6b21\u4e8b\u52a1\u4ea7\u751f\u7684\u65e5\u5fd7\u548c\u4e8b\u52a1\u4fee\u6539\u7684\u810f\u6570\u636e\uff0c\u90fd\u4f1a\u5237\u65b0\u5230\u78c1\u76d8\u4e0a</li> <li>\u540c\u65f6\u4e3b\u5b9e\u4f8b\u4e0a\u4ea7\u751f\u7684\u65e5\u5fd7\u4f1a\u901a\u8fc7\u590d\u5236\u7684\u6280\u672f\u4f20\u9012\u5230\u4ece\u8282\u70b9</li> <li>\u4ece\u8282\u70b9\u63a5\u6536\u5230\u65e5\u5fd7\u540e\uff0c\u4f1a\u628a\u4e3b\u8282\u70b9\u53d1\u751f\u7684\u4e8b\u60c5\u5168\u90e8replay\u4e00\u6b21\uff0c\u628a\u4ece\u8282\u70b9\u4e0a\u7684\u6570\u636e\u66f4\u65b0\u5230\u4e0e\u4e3b\u8282\u70b9\u4e00\u81f4</li> <li>\u6574\u4e2a\u8fc7\u7a0b\u6709\u5f88\u591a\u7684IO\u64cd\u4f5c\u5305\u62ec1\uff0c3\uff0c4</li> <li>\u5c24\u5176\u662f\u968f\u673aio(2,5), \u810f\u6570\u636e\u5757\u843d\u76d8\u4f1a\u4ea7\u751f\u5927\u91cf\u7684IO</li> </ol>"},{"location":"aurora/1Intital_Explore/#6-2-amazon-aurora","title":"6-2 Amazon Aurora","text":"<ol> <li>\u53ea\u6709\u65e5\u5fd7\u6d41\u4f1a\u843d\u76d8\uff0c\u6570\u636e\u672c\u8eab\u4e0d\u843d\u76d8</li> <li>\u65e5\u5fd7\u6d41\u843d\u76d8\u4ee5\u540e\uff0c\u5728\u5b58\u50a8\u5c42\u9762\u901a\u8fc7\u5f88\u591a\u7684\u5b58\u50a8\u8282\u70b9\u5e76\u884c\u7684\u751f\u6210\u810f\u6570\u636e</li> <li>Aurora \u65e5\u5fd7\u6d41\u4e5f\u4f1a\u4ece\u4e3b\u5b9e\u4f8b\u53d1\u9001\u5230\u526f\u5b9e\u4f8b\uff1a \u540c\u6b65\u4ee5\u53ca\u66f4\u65b0\u4ece\u8282\u70b9\u5185\u5b58\u91cc\u7684\u6570\u636e<ul> <li>\u4e3b\u8282\u70b9\u548c\u4ece\u8282\u70b9\u7684\u5185\u5b58\u91cc\u90fd\u6709\u4e00\u4e2a\u6570\u636e\u5757\u53eb\u505aA\uff0c\u4e3b\u8282\u70b9\u4e0a\u5bf9\u5b83\u8fdb\u884c\u4e86\u66f4\u65b0\u53d8\u6210\u4e86B\uff0c\u4ea7\u751f\u4e86\u65e5\u5fd7\uff0c\u90a3\u4e48\u65e5\u5fd7\u4f1a\u4f20\u5230\u4ece\u8282\u70b9\uff0c\u628a\u5185\u5b58\u4e2d\u7684\u6570\u636e\u5757\u4eceA\u53d8\u6210B </li> </ul> </li> </ol>"},{"location":"aurora/1Intital_Explore/#io","title":"\u4f20\u7edf\u6570\u636e\u5e93\u7684IO","text":"<ul> <li>\u65e5\u5fd7\u6570\u636e\u7684I/O\u843d\u76d8 </li> <li>\u810f\u6570\u636e\u901a\u8fc7\u68c0\u67e5\u70b9\u7684\u65b9\u5f0f\u843d\u76d8</li> <li>\u65e5\u5fd7\u6570\u636e\u7684I/O\u843d\u76d8 : \u6d41\u5f0f\u7684\u987a\u5e8f\u5199\u64cd\u4f5c\uff0c\u5bf9\u78c1\u76d8I/O\u6027\u80fd\u5f71\u54cd\u4e0d\u5927</li> <li>\u810f\u6570\u636e\u843d\u76d8\uff1a \u968f\u673aIO\uff0c\u6bd4\u8f83\u6d88\u8017\u78c1\u76d8I/O\u6027\u80fd</li> </ul> <p>IO\u6d41</p> <ul> <li>Issue write to EBS\u4e00EBS issues to mirror, ack when both done Stage write to standby Instance </li> <li>Issue write to EBS on standby instance </li> </ul> <p>\u89c2\u5bdf</p> <ul> <li>Stept 1,3,4 are sequentlat and synchronous </li> <li>This amptifies both latency and jitter </li> <li>Many Tpes of writes for each user operation </li> <li>Have to write data blocks twice to avoid torn writes</li> </ul>"},{"location":"aurora/1Intital_Explore/#aurora-io","title":"Aurora IO","text":"<ul> <li>\u53ea\u4fdd\u7559\u4e86\u65e5\u5fd7I/O\u843d\u76d8</li> <li>\u5229\u7528\u5e95\u5c42\u5927\u91cf\u7684\u5b58\u50a8\u8282\u70b9\uff0c\u5bf9\u4fee\u6539\u7684\u6570\u636e\u8fdb\u884c\u91cd\u73b0\uff0c\u5229\u7528\u5199\u5728\u6570\u636e\u5b58\u50a8\u5c42\u7684\u65e5\u5fd7\u590d\u73b0\u88ab\u4fee\u6539\u7684\u6570\u636e\u5757\uff0c </li> <li>\u6570\u636e\u5757\u4fdd\u5b586\u4efd\uff0c\u5206\u90e8\u57283\u4e2aAZ\u7684\u8282\u70b9</li> <li>\u91c7\u7528\u4ef2\u88c1\u673a\u5236\uff0c6\u4efd\u4e2d4\u4efd\u5199\u5165\uff0c\u89c6\u4e3a\u5199\u5165\u6210\u529f</li> </ul> <p>\u89c2\u5bdf</p> <ul> <li>Only write redo records; </li> <li>all seeps asynchronous </li> <li>No data block writes (checkpoint, cache replacenrent) 6X more log writes, but 9X less network traffic Tolerant of network and storage outlier latency </li> </ul>"},{"location":"aurora/1Intital_Explore/#6-3-aurora-mysqlmysql5","title":"6-3 \u5199\u5165\u4e0e\u8bfb\u53d6\u541e\u5410\u91cfAurora MySQL\u901f\u5ea6\u53ef\u8fbeMySQL5\u500d","text":""},{"location":"aurora/1Intital_Explore/#6-4-aurora-mysql-mysql-25","title":"6-4 Aurora MySQL \u636e\u52a0\u8f7d\u901f\u5ea6\u76f8\u5f53\u4e8eMySQL 2.5\u500d","text":""},{"location":"aurora/1Intital_Explore/#7amazon-aurora","title":"7\u3001Amazon Aurora\u53ea\u8bfb\u526f\u672c","text":"<p>\u53ef\u7528\u6027</p> <ul> <li>\u652f\u6301\u6700\u591a15\u4e2a\u53ea\u8bfb\u526f\u672c <ul> <li>\u53ea\u8bfb\u526f\u672c\u5ef6\u8fdf\u843d\u540e\u4e0e\u4e8e\u4e3b\u8282\u70b9\u7684\u65f6\u95f4\u7279\u522b\u7684\u5c0f\uff0c\u56e0\u4e3a\u5b83\u4e0d\u9700\u8981\u5e94\u7528\u65e5\u5fd7\u53bb\u8ffd\u4e3b\u8282\u70b9 </li> </ul> </li> <li>\u81ea\u52a8\u6dfb\u52a0\u6216\u5220\u9664\u53ea\u8bfb\u526f\u672c <ul> <li>\u8bfb\u526f\u672c\u4e0d\u9700\u8981\u7ef4\u62a4\u672c\u5730\u7684\u5b58\u50a8\uff0c\u6dfb\u52a0\u5220\u9664\u7279\u522b\u7684\u5feb\uff0c\u4e0d\u9700\u8981\u50cf\u4f20\u7edfMysql\u5efa\u7acb\u4ece\u8282\u70b9\u662f\u4ece\u4e3b\u8282\u70b9\u5907\u4efd\u518d\u6062\u590d\u7684\u3002 Aurora\u53ea\u9700\u8981\u90e8\u7f72\u4ece\u8282\u70b9\u7684CPU\u548c\u5185\u5b58\u5373\u53ef</li> </ul> </li> <li>Monitor\u68c0\u6d4b\u7a0b\u5e8f\u81ea\u52a8\u68c0\u6d4b\u5e76\u66ff\u6362\u5931\u8d25\u7684\u6570\u636e\u5e93\u8282\u70b9 \uff1a \u81ea\u52a8\u66ff\u6362\u574f\u6389\u7684\u53ea\u8bfb\u526f\u672c </li> <li>\u53ea\u8bfb\u526f\u672c\u5728\u4e3b\u8282\u70b9\u6545\u969c\u65f6\u81ea\u52a8\u63d0\u5347\u4e3a\u65b0\u7684\u4e3b\u5e93(failover) \uff1a \u7528\u6237\u53ef\u4ee5\u6307\u5b9a\u67d0\u4e2aread replicat\u63d0\u5347\u5230\u4e3b\u5e93</li> <li>\u5bb9\u6237\u53ef\u4ee5\u6307\u5b9a\u6545\u969c\u5207\u6362\u7684\u987a\u5e8f</li> </ul> <p>\u6027\u80fd</p> <ul> <li>\u5bb9\u6237\u7a0b\u5e8f\u53ef\u4ee5\u5c06\u8bfb\u6d41\u91cf\u6307\u5411\u53ea\u8bfb\u526f\u672c \uff1a\u5f53\u6709\u591a\u4e2areadreplica \u53ef\u4ee5\u8ba9\u7528\u6237\u6307\u5411\u4e00\u4e2aendpoint,readony endpoint \u53ef\u4ee5\u628a\u7528\u6237\u7684\u8bf7\u6c42\u8def\u7531\u7684\u6709readreplica\u7684\u8282\u70b9</li> <li>\u8bfb\u8d1f\u8f7d\u5728\u591a\u4e2a\u53ea\u8bfb\u526f\u672c\u95f4\u5747\u8861</li> </ul>"},{"location":"aurora/1Intital_Explore/#7-1-aurora","title":"7-1 Aurora \u96c6\u7fa4\u8bbf\u95ee","text":"<ul> <li>\u53ef\u4ee5\u5305\u542b\u4e00\u4e2a\u4e3b\u8282\u70b9\u548c15\u4e2a\u53ea\u8bfb\u526f\u672c\uff0c16\u4e2a\u8ba1\u7b97\u8282\u70b9</li> </ul> <ul> <li>\u5171\u66b4\u9732\u4e86\u4e09\u79cd\u8282\u70b9</li> <li>\u96c6\u7fa4\u8bbf\u95ee\u7aef\u70b9\uff0c\u7c7b\u4f3c\u4e8eJDBC\u8fd9\u79cdURL\uff0c\u4e5f\u5c31\u662f\u4e00\u4e2amaster\u8bbf\u95ee\u8282\u70b9 \uff08\u8bfb\u5199\u64cd\u4f5c\uff09</li> <li>\u53ea\u8bfb\u8bbf\u95ee\u7aef\u70b9\uff0c \u8bbf\u95ee\u6240\u6709\u7684\u53ea\u8bfb\u7684\u526f\u672c \uff08\u53ea\u8bfb\u64cd\u4f5c\uff09</li> <li>\u7ed3\u70b9\u8bbf\u95ee\u7aef\u70b9\uff0c\u8bbf\u95ee\u67d0\u7279\u5b9a\u5b9e\u4f8b\uff0c\u6216\u8005\u8bf4\u53ea\u8bfb\u526f\u672c</li> </ul>"},{"location":"aurora/1Intital_Explore/#7-2","title":"7-2 \u901a\u8fc7\u53ea\u8bfb\u526f\u672c\u5bf9\u8bfb\u53d6\u8fdb\u884c\u6a2a\u5411\u6269\u5c55","text":"<ul> <li>\u4f20\u7edfMysql \u4e3b\u8282\u70b9\u4e0a\u7684\u4e8b\u52a1\u901a\u8fc7log\u5728\u4ece\u8282\u70b9\u4e0a\u518d\u8dd1\u4e00\u904d</li> <li>Aurora \u4ece\u8282\u70b9\u53ea\u662f\u5237\u65b0\u5185\u5b58\u91cc\u7684\u6570\u636e\u5757\uff0c\u5982\u679c\u5185\u5b58\u4e2d\u6ca1\u6709\u7684\u6570\u636e\u5757\uff0c\u4e0d\u7528\u5237\u65b0\uff0c\u76f4\u63a5\u8bfb\u53d6\u4e3b\u8282\u70b9\u5171\u4eab\u5b58\u50a8\u4e2d\u7684\u6587\u4ef6</li> </ul>"},{"location":"aurora/1Intital_Explore/#7-3-aurora","title":"7-3 Aurora\u53ea\u8bfb\u526f\u672c\u81ea\u52a8\u4f38\u7f29\u6280\u672f","text":"<ul> <li>\u8de8\u591a\u4e2a\u53ef\u7528\u533a\u6700\u591a\u53ef\u63d0\u534715\u4e2a\u53ea\u8bfb\u526f\u672c </li> <li>\u57fa\u4e8e\u91cd\u505a\u65e5\u5fd7\u590d\u5236\u7684\u526f\u672c\u4f4e\u5ef6\u65f6\u4e00\u901a\u5e38&lt;10\u6beb\u79d2 </li> <li>\u8bfb\u53d6\u5668\u7aef\u70b9\u5177\u6709\u8d1f\u8f7d\u5e73\u8861\u548c\u81ea\u52a8\u7f29\u653e\uff08CPU\u53ca\u8fde\u63a5\u6570/read replica\u5e73\u5747\u8fde\u63a5\u6570\uff09</li> </ul>"},{"location":"aurora/1Intital_Explore/#7-4-amazon-aurora-mysql","title":"7-4 Amazon Aurora MySQL\u903b\u8f91\u4e0e\u7269\u7406\u590d\u5236\u5ef6\u8fdf","text":"<ul> <li>\u5728MySQL\u5f53\u4e2d12\u5206\u949f\uff0c\u6211\u4eec\u770b\u5230\u590d\u5236\u5ef6\u8fdf\u8fbe\u5230\u8fd112\u5206\u949f\u3002\u4ece\u5b9e\u9645\u5e94\u7528\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u8fd9\u663e\u7136\u662f\u79cd\u8fd1\u4e4e\u8352\u8c2c\u7684\u60c5\u51b5</li> <li>\u5229\u7528Aurora,4\u4e2a\u526f\u672c\u7684\u6700\u5927\u8bfb\u53d6\u5ef6\u8fdf\u4ece\u672a\u8d85\u8fc720\u6beb\u79d2</li> </ul>"},{"location":"aurora/1Intital_Explore/#8","title":"8\u3001\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u7684\u4ef2\u88c1\u4e0e\u672c\u5730\u8ddf\u8e2a \uff08\u4e8b\u52a1\u673a\u5236\uff09","text":"<p>\u4e3b\u8282\u70b9\u91cc\u5bf9\u6570\u636e\u5757\uff08page1\uff09\u8fdb\u884c\u4fee\u6539\uff0c\u56db\u4e2a\u4e8b\u52a1T1,T2,T3,T4\u6309\u7167\u65f6\u95f4\u987a\u5e8f\u5bf9\u5b83\u8fdb\u884c\u4fee\u6539</p> <p></p> <ol> <li>T1,T2,T3,T4\u56db\u4e2a\u4e8b\u52a1\u4ea7\u751f\u7684\u65e5\u5fd7\u4f1a\u5237\u65b0\u5230\u78c1\u76d8\u4e0a</li> <li>\u5b58\u50a8\u5c42\u5229\u7528\u65e5\u5fd7\u4ea7\u751f\u6570\u636e\u5757\uff0c\u5e76\u4e14\u4f1a\u590d\u52366\u4efd</li> <li>T1\u590d\u5236\u4e864\u4efd\u6807\u8bb0\u4e3a\u5df2\u63d0\u4ea4</li> <li>T2,T3\u5c0f\u4e8e6\u4efd\uff0c\u5904\u4e8e\u7b49\u5f85\u72b6\u6001</li> </ol> <p>\u5e76\u884c\u5237\u65b0\uff1a T3\u590d\u5236\u4e86\u66f4\u591a\u7684\u6570\u636e\u5757\uff0c\u8fbe\u52305\u4efd\u526f\u672c</p> <p></p> <ul> <li>T3\u4e0d\u4f1a\u88ab\u6807\u8bb0\u4e3a\u5df2\u63d0\u4ea4\uff0c\u56e0\u4e3aT2\u6ca1\u6709\u5b8c\u62104\u4efd\u526f\u672c\u7684\u751f\u6210</li> <li>\u867d\u7136\u5e76\u884c\u5237\u65b0,\u4f46\u662f\u8981\u5728\u65e5\u5fd7\u5c42\u9762\u4fdd\u8bc1\u4e00\u4e2a\u5148\u540e\u987a\u5e8f\u7684\uff0c\u4fdd\u8bc1\u6309\u7167T1,T2,T3,T4\u7684\u987a\u5e8f\u53bb\u8bb0\u5f55</li> <li>\u6240\u4ee5    T3  \u4ecd\u7136\u51fa\u4e8e\u7b49\u5f85\u63d0\u4ea4\u7684\u72b6\u6001</li> </ul> <p></p> <ul> <li>T1 \u5b8c\u62106\u4efd\u526f\u672c\uff0c T2 \u5b8c\u62104\u4efd\u526f\u672c\uff0c T3 \u5b8c\u62105\u4efd\u526f\u672c\uff0c T4 \u5b8c\u62106\u4efd\u526f\u672c\uff0c \u90fd\u5b8c\u6210\u4e864\u4efd\u526f\u672c\u7684\u590d\u5236\u3002 \u5168\u90e8\u6807\u8bb0\u6210\u5df2\u63d0\u4ea4\uff0c\u5e76\u6309\u7167T1,T2,T3,T4\u7684\u987a\u5e8f\u8bb0\u5f55\u5230\u65e5\u5fd7\u91cc</li> </ul> <p></p> <ul> <li>\u5168\u90e8\u5b8c\u6210\u516d\u4efd\u526f\u672c\u7684\u590d\u5236</li> </ul> <p>Aurora \u5e76\u6ca1\u6709\u4e00\u4e2a\u5206\u5e03\u5f0f\u63d0\u4ea4\u7684\u7b97\u6cd5</p>"},{"location":"aurora/1Intital_Explore/#9","title":"9\u3001\u4e3b\u4ece\u540c\u6b65\u7684\u8bb0\u5f55\u673a\u5236","text":""},{"location":"aurora/1Intital_Explore/#9-1-t1-t4-4","title":"9-1  T1-&gt;T4 4\u4e2a\u4e8b\u52a1\u5206\u522b\u5bf9\u6570\u636e\u5757\u8fdb\u884c\u64cd\u4f5c","text":""},{"location":"aurora/1Intital_Explore/#9-2-t1","title":"9-2 T1","text":"<ul> <li>T1 \u5df2\u7ecf\u5b8c\u6210\u4e86\u4e3b\u8282\u70b9\u516d\u5757\u526f\u672c\u7684\u590d\u5236</li> <li>T1\u7684 log \u5df2\u7ecf\u4ece\u4e3b\u8282\u70b9\u5f02\u6b65\u7684\u590d\u5236\u5230\u4e86\u4ece\u8282\u70b9</li> <li>\u4ece\u8282\u70b9\u5728\u5185\u5b58\u4e2d\u628a\u6570\u636e\u5757\u4fee\u6539\u6210\u4e86T1\u4e8b\u52a1\u5b8c\u6210\u4e4b\u540e\u7684\u72b6\u6001\uff0c\u4e3b\u4ece\u8282\u70b9\u7684\u5185\u5b58\u4f53\u73b0\u7684\u90fd\u662fT1\u4e8b\u52a1\u5b8c\u6210\u4e4b\u540e\u7684\u72b6\u6001</li> </ul>"},{"location":"aurora/1Intital_Explore/#9-3-t1t2t3t4","title":"9-3 T1,T2,T3,T4 \u6309\u987a\u5e8f\u5bf9\u4e3b\u8282\u70b9\u8fdb\u884c\u53d8\u66f4","text":"<p>\u4e3b\u8282\u70b9\u5185\u5b58\u73b0\u5728\u4f53\u73b0\u4e86\u6700\u65b0\u7684\u72b6\u6001\uff1a T4</p> <p></p> <ul> <li>\u5b58\u50a8\u5c42\u505c\u7559\u5728T2\u7684\u72b6\u6001\uff0cT2\u5b8c\u6210\u4e866\u4efd\u526f\u672c\u7684\u590d\u5236\u7684\u62f7\u8d1d</li> <li>T3,T4\u76f8\u5e94\u7684\u65e5\u5fd7\u8fd8\u6ca1\u6709\u5b8c\u6210\u6570\u636e\u5757\u7684\u5e94\u7528</li> <li>\u4e3b\u4ece\u65e5\u5fd7\u7684\u5f02\u6b65\u4f20\u8f93\uff0c\u73b0\u5728T2\u7684\u65e5\u5fd7\u521a\u521a\u590d\u5236\u5230\u4ece\u8282\u70b9\uff0c\u5e76\u5b8c\u6210\u5e94\u7528\uff0c\u6240\u4ee5\u4ece\u8282\u70b9\u7684page1\u7684\u72b6\u6001\u662f\u5e94\u7528\u5b8c\u4e8b\u52a1T2\u7684\u72b6\u6001\uff08\u7d2b\u8272\u7684\u72b6\u6001\uff09</li> </ul> <p></p> <ul> <li>\u5982\u679c\u5e94\u7528\u7a0b\u5e8f\u4ece\u4e3b\u5e93\u548c\u4ece\u5e93\u5206\u522b\u53bb\u8bfb\u8fd9\u4e2a\u6570\u636e\u5757\uff0c\u4e3b\u8282\u70b9\u4e00\u5b9a\u4ece\u5185\u5b58\u4e2d\u8bfb\u53d6\u6700\u65b0\u7684\u6570\u636e</li> <li>\u4ece\u8282\u70b9\u8bfb\u53d6\u7684\u662f\u5e94\u7528\u5b8cT2\u4e8b\u52a1\u7684\u6570\u636e</li> </ul> <p></p> <ul> <li>\u6700\u7ec8T3,T4\u4f1a\u5728\u4ece\u8282\u70b9\u7684\u5185\u5b58\u4e2d\u5b8c\u6210\u5e94\u7528\uff0c\u628a\u6570\u636e\u5757page1\u66f4\u65b0\u6210\u6700\u65b0\u7684\u72b6\u6001\uff08T4)</li> <li>\u8fd9\u65f6\u5019\u518d\u53bb\u8bfb\uff0c\u5c31\u53ef\u4ee5\u4ece\u4e3b\u4ece\u5206\u522b\u8bfb\u53d6\u5230\u6700\u65b0\u7684\u72b6\u6001\u4e86</li> <li>\u6700\u7ec8T3,T4\u7684\u5728\u5b58\u50a8\u5c42\u9762\u88ab\u5e94\u7528\u5230\u6570\u636e\u57576\u5757\u62f7\u8d1d\u4e2d\u53bb\uff0c\u5b58\u50a8\u5c42\u9762\u548c\u5185\u5b58\u5c42\u9762\u8fbe\u6210\u4e00\u81f4</li> </ul> <p></p>"},{"location":"aurora/1Intital_Explore/#9-4-amozon-aurora200","title":"9-4 \u8d1f\u8f7d\u6761\u4ef6\u4e0b\u7684\u6027\u80fd\u53d8\u5316 Amozon Aurora\uff1e\u4e00\u81f4\u6027\u63d0\u5347200\u500d","text":"<p>Aurora\u7684\u5199\u5165\u5ef6\u8fdf\u975e\u5e38\u7684\u7a33\u5b9a</p> <p>R4.16XL\u7684\u5b9e\u4f8b</p> <p></p> <p>Mysql\u7684\u6296\u52a8\u4e2d\u7684\u6ce2\u5cf0\u662f\u56e0\u4e3a\u5f53mysql\u7684\u5185\u5b58\u8fdb\u884ccheckpoint,\u5237\u65b0\u5185\u5b58\u4e2d\u7684\u810f\u6570\u636e\u5230\u78c1\u76d8\u4e0a\u7684\u65f6\u5019\uff0c\u5e26\u6765\u5185\u5b58\u7684\u6da8\u5e45\u5230\u8fbe\u6ce2\u5cf0 =&gt; \u5199\u5ef6\u8fdf\u5c31\u4f1a\u63d0\u9ad8</p>"},{"location":"aurora/1Intital_Explore/#10amazon-aurora","title":"10\u3001Amazon Aurora\u67b6\u6784\u4e4b\uff1a\u53ef\u7528\u6027\u4e0e\u6301\u4e45\u6027","text":""},{"location":"aurora/1Intital_Explore/#10-1-1","title":"10-1 \u201c\u53ef\u7528\u533a+1\u201d\u7684\u5bb9\u9519\u673a\u5236","text":"<ul> <li>\u5728\u5927\u89c4\u6a21\u96c6\u7fa4\u4f53\u7cfb\u4e2d\uff0c\u6545\u969c\u603b\u4f1a\u51fa\u73b0</li> <li> <p>\u53ef\u7528\u533a\u6545\u969c\u662f\u4e00\u79cd\u201c\u547d\u4e2d\u6ce8\u5b9a\u201c </p> </li> <li> <p>6\u4efd\u526f\u672c\uff0c\u6bcf\u53ef\u7528\u533a2\u4efd</p> </li> <li>2/3\u4ef2\u88c1\u65e0\u6cd5\u6ee1\u8db3\u9700\u6c42 </li> </ul> <p></p> <ul> <li>\u4e00\u4e2aAZ\u7684\u5d29\u6e83\uff0c4/6\u4ecd\u53ef\u4ee5\u4fdd\u8bc1\u5199\u5165\u6210\u529f</li> <li>3/6\u4fdd\u8bc1\u8bfb\u53d6\u6210\u529f\uff0c\u4e00\u4e2aAZ\u5d29\u6e83+\u4e00\u4e2a\u5b58\u50a8\u8282\u70b9\u5d29\u6e83\uff0c\u8bfb\u53d6\u64cd\u4f5c\u4ecd\u7136\u53ef\u4ee5\u53d1\u751f\uff0c\u4e09\u5206\u526f\u672c\u4e0d\u80fd\u6ee1\u8db3\u9700\u6c42</li> </ul>"},{"location":"aurora/1Intital_Explore/#10-2-aurora","title":"10-2 Aurora\u6570\u636e\u5e93\u5907\u4efd\u4e0e\u6062\u590d\u6280\u672f(\u6301\u7eed\u5907\u4efd)","text":"<ol> <li>Aurora \u4e0d\u9700\u8981\u914d\u7f6e\u5907\u4efd\u7a97\u53e3\uff0c\u800c\u4f20\u7edfRDS mysql \u662f\u9700\u8981\u914d\u7f6e\u5907\u4efd\u7a97\u53e3\u7684</li> <li>Aurora\u4e0d\u65ad\u7684\u505a\u5feb\u7167\u4fdd\u5b58\u5728S3\u4e0a\uff0c\u5feb\u7167\u4ee5\u5206\u533a\u4e3a\u5355\u4f4d\uff08segment:10GB)</li> <li>\u6bcf\u4e2asegment\u4e0d\u65ad\u7684\u505a\u5feb\u7167\u4fdd\u5b58\u5728S3\uff0c\u540c\u65f6\u65e5\u5fd7\u4e5f\u4f1a\u4fdd\u5b58\u5728S3\u4e0a</li> <li>\u5907\u4efd\u5229\u7528\u7684\u662f\u5b58\u50a8\u7684\u6280\u672f\u6765\u5b9e\u73b0\uff0c\u5bf9\u6570\u636e\u5e93\u670d\u52a1\u5668\u672c\u8eab\u7684CPU/MEMORY\u8d44\u6e90\u4e0d\u6d88\u8017\uff0c\u5bf9\u6570\u636e\u5e93\u670d\u52a1\u5668\u672c\u8eab\u4e0d\u5f71\u54cd\u6027\u80fd</li> </ol> <ul> <li>\u5e76\u884c\u4e3a\u6bcf\u4e2a\u6bb5\u5b9a\u671f\u62cd\u5feb\u7167\uff0c\u5c06\u91cd\u505a\u65e5\u5fd7\u6d41\u4f20\u8f93\u5230S3\u5b58\u50a8\u6876</li> <li>\u6301\u7eed\u8fdb\u884c\u5907\u4efd\uff0c\u5e76\u4e0d\u5f71\u54cd\u6027\u80fd\u6216\u53ef\u7528\u6027\u6c34\u5e73</li> <li>\u65f6\u95f4\u70b9\u6062\u590d</li> <li>\u5728\u8fd8\u539f\u65f6\uff0c\u4eceS3\u8fd4\u56de\u76f8\u5e94\u7684\u6bb5\u5feb\u7167\u4e0e\u91cd\u505a\u65e5\u5fd7\u6d41\u5230\u5b58\u50a8\u8282\u70b9</li> <li>\u4ee5\u5e76\u884c\u548c\u5f02\u6b65\u65b9\u5f0f\u5e94\u7528\u91cd\u505a\u65e5\u5fd7\u6d41\u5230\u6bb5\u5feb\u7167</li> </ul>"},{"location":"aurora/1Intital_Explore/#10-3","title":"10-3 \u6570\u636e\u5e93\u56de\u6eaf","text":"<p>PITR  Point-in-time recovery</p> <p>\u901a\u8fc7\u60c5\u51b5\u4e0b\uff0c\u6240\u8c13\u7684\u4ece\u5220\u9664\u5e93\u5230\u8dd1\u8def\uff0c\u4f20\u7edf\u7684\u65b9\u5f0f\u4ece\u5907\u4efd\u4e2d\uff0c\u6062\u590d\u6570\u636e\u5e93\uff0c\u6062\u590d\u5230\u4e00\u4e2a\u65f6\u95f4\u70b9\u3002\u628a\u8bef\u64cd\u4f5c\u7684\u5bf9\u8c61\u5bfc\u51fa\u6765\u653e\u5230\u65b0\u5e93\u91cc\uff0c\u65f6\u95f4\u4f1a\u5f88\u957f</p> <p>Aurora\u7684\u914d\u7f6e\u4e0d\u662f\u7b80\u5355\u7684\u5757\u8bbe\u5907\uff0c\u5b83\u7684\u6570\u636e\u5b58\u50a8\u5176\u5b9e\u662f\u6309\u7167version\u5b58\u50a8\u6570\u636e\uff0c\u8bef\u64cd\u4f5c\u7684\u65f6\u5019\u5757\u6570\u636e\u5e76\u6ca1\u6709\u88ab\u78e8\u6389\uff0c\u5b83\u53ea\u662f\u88ab\u8bbe\u7f6e\u6210\u5bf9\u5b9e\u4f8b\u4e0d\u53ef\u89c1\u4e86\uff0c\u6570\u636e\u5e93\u56de\u6eaf\u66f4\u591a\u7684\u662f\u66f4\u6539\u7684\u539f\u6570\u636emetadata\u7684\u72b6\u6001,\u6240\u4ee5\u6570\u636e\u5757\u8fd8\u5b58\u5728\uff0c\u53ea\u662f\u53ef\u89c1\u548c\u4e0d\u53ef\u89c1\u7684\u8f6c\u53d8\uff0c\u65f6\u95f4\u5f88\u5feb\uff0c\u901a\u5e3810s\u4ee5\u5185</p> <p></p> <ul> <li> <p>\u56de\u6eaf\u673a\u5236\u4ee3\u8868\u5c06\u6570\u636e\u5e93\u6062\u590d\u81f3\u67d0\u4e00\u65f6\u95f4\u70b9\uff0c\u65e0\u9700\u4f7f\u7528\u5907\u4efd\u8d44\u6e90</p> <ul> <li>\u5728\u6709DML\u6216\u8005DDL\u8bef\u64cd\u4f5c\u7684\u60c5\u51b5\u4e0b\uff0c\u56de\u6eaf\u53ef\u4ee5\u56de\u5230\u8fc7\u53bb\u65f6\u95f4\u70b9\u3002</li> <li>\u56de\u6eaf\u4e0d\u662f\u7834\u574f\u6027\u7684\uff0c\u53ef\u4ee5\u591a\u6b21\u56de\u6eaf\u5230\u6b63\u786e\u7684\u65f6\u95f4\u70b9\u3002</li> </ul> </li> <li> <p>\u4e0d\u9700\u8981\u50cf\u4f20\u7edf\u6570\u636e\u5e93\u5229\u7528\u5907\u4efd\u8fd8\u539f\u548c\u65e5\u5fd7\u6062\u590d\u5230\u67d0\u4e00\u65f6\u95f4\u70b9</p> </li> <li> <p>When you enable Aurora Backtrack in the RDS management console, you specify how long to retain data records, and you pay for the space these records use. For example, you could set up Backtrack to allow you to move your database up to 72 hours back.</p> </li> <li> <p>\u5b58\u50a8\u4f1a\u589e\u52a0\uff0c\u9875\u9762\u4e3a\u4e86\u4fdd\u8bc1\u56de\u6eaf\u7684\u901f\u5ea6\uff0c\u4e0d\u80fd\u90a3\u4e48\u5feb\u88ab\u56de\u6536\uff0c\u653e\u5728\u4e0a\u9762\uff0c\u53ef\u89c1\u6027\u6709\u53d8\u5316</p> </li> </ul>"},{"location":"aurora/1Intital_Explore/#10-4-caches","title":"10-4 \u5b58\u6d3b caches","text":"<ul> <li>\u6570\u636e\u5e93\u7f13\u5b58\u548c\u540e\u53f0\u8fdb\u7a0b\u662f\u72ec\u7acb\u51fa\u6765\u7684</li> <li>\u6570\u636e\u5e93\u91cd\u542f\u8fdb\u7a0b\u65f6\uff0c\u7f13\u5b58\u662f\u4e0d\u4f1a\u91cd\u542f\u7684\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u8bbf\u95ee\u6548\u7387</li> <li> <p>\u7f13\u5b58\u53ef\u4ee5\u5728\u91cd\u542f\u65f6\uff0c\u4efb\u7136\u4fdd\u5b58\u70ed\u6570\u636e\uff0c\u4e0d\u9700\u8981\u7b2c\u4e8c\u6b21\u7f13\u5b58\u7684\u52a0\u70ed\u4e86</p> </li> <li> <p>\u5c06cache\u4ece\u6570\u636e\u5e93\u8fdb\u7a0b\u4e2d\u5206\u79bb\u51fa\u6765 </p> </li> <li>\u6570\u636e\u5e93\u91cd\u542f\u65f6Cache\u53ef\u4ee5\u4f9d\u65e7\u4fdd\u6301\u70ed\u5ea6</li> <li>\u66f4\u5feb\u5730\u6062\u590d\u5168\u91cf\u52a0\u8f7d\u8f7d\u64cd\u4f5c </li> <li>\u5b9e\u4f8b\u5d29\u6e83\u6062\u590d\uff0b\u53ef\u5b58\u6d3b cache = \u66f4\u5feb\u901f\u5bb9\u6613\u5730\u4eceDB\u5931\u8d25\u4e2d\u6062\u590d </li> </ul> <p></p> <p>Caching process\u548c DB process \u5206\u79bb\u5f00\u6765\u5e76\u5728\u6570\u636e\u5e93\u91cd\u542f\u65f6\u4fdd\u6301warm</p>"},{"location":"aurora/1Intital_Explore/#10-5","title":"10-5 \u5373\u65f6\u5d29\u6e83\u91cd\u505a\u6062\u590d","text":"<p>\u4f20\u7edf\u6570\u636e\u5e93</p> <ul> <li>\u91cd\u653e\u81ea\u4e0a\u6b21\u68c0\u67e5\u70b9\u4e4b\u540e\u7684\u65e5\u5fd7 (undo log)</li> <li>\u5728\u5355\u7ebf\u7a0b\u4e2d\u6162\u901f\u91cd\u653e </li> </ul> <p></p> <p>Amazon Aurora</p> <ul> <li>\u65e0\u9700\u68c0\u67e5\u70b9 \uff08\u6ca1\u6709\u68c0\u67e5\u70b9\uff09</li> <li>\u65e0\u9700\u91cd\u653e\u542f\u52a8\u51c6\u5907 </li> </ul> <p>\u5f02\u6b65\u7684\u65b9\u5f0f\u5224\u65adsegment\u662f\u5426\u9700\u8981\u6062\u590d\uff0c\u5982\u8fc7\u9700\u8981\u6062\u590d\u591a\u4e2a\u5b58\u50a8\u70b9\uff0c\u591a\u4e2asegment\u5f02\u6b65\u7684\u65b9\u5f0f\u8fdb\u884c\u6062\u590d</p> <p></p>"},{"location":"aurora/1Intital_Explore/#10-6","title":"10-6 \u8bfb\u53d6\u526f\u8282\u70b9\u4e0e\u5feb\u901f\u6545\u969c\u8f6c\u79fb","text":"<ul> <li>\u5728\u591a\u53ef\u7528\u533a\u5185\u6700\u591a\u53ef\u63d0\u4f9b15\u4efd\u53ef\u5347\u7ea7\u7684\u53ea\u8bfb\u526f\u672c</li> <li>\u526f\u8282\u70b9\u4e0e\u4e3b\u8282\u70b9\u5171\u4eab\u5b58\u50a8\u2014\u2014\u4e0d\u4e22\u5931\u6570\u636e</li> <li>\u53ef\u914d\u7f6e\u6545\u969c\u8f6c\u79fb\u987a\u5e8f</li> </ul>"},{"location":"aurora/1Intital_Explore/#10-7-15","title":"10-7 \u591a\u8fbe15\u4e2a\u53ef\u63d0\u5347\u7684\u53ea\u8bfb\u526f\u672c","text":"<ul> <li>\u591a\u8fbe15\u4e2a\u8de8\u591a\u4e2a\u53ef\u7528\u533a\u7684\u53ea\u8bfb\u526f\u672c\uff0c\u81ea\u52a8\u6545\u969c\u8f6c\u79fb\uff0c\u901a\u5e38\u5c0f\u4e8e 30\u79d2</li> <li>\u57fa\u4e8e\u91cd\u505a\u65e5\u5fd7\u7684\u590d\u5236\uff0c\u4f4e\u5ef6\u65f6 \u2013 \u901a\u5e38\u5c0f\u4e8e 10 \u6beb\u79d2</li> <li>\u53ea\u8bfb\u8bbf\u95ee\u7aef\u70b9\u5177\u5907\u8d1f\u8f7d\u5747\u8861\u548c\u81ea\u52a8\u4f38\u7f29\u7684\u80fd\u529b</li> </ul>"},{"location":"aurora/1Intital_Explore/#10-8-aurora","title":"10-8 Aurora\u6570\u636e\u5e93\u514b\u9686\u6280\u672f","text":"<p>\u514b\u9686\u6570\u636e\u5e93\u800c\u4e0d\u590d\u5236\u6570\u636e =&gt; \u53ef\u4ee5\u5f88\u5feb\u521b\u5efa\u4e00\u4e2aclone</p> <p></p> <ul> <li>\u77ac\u95f4\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5e93\u514b\u9686<ul> <li>\u5feb\u7684\u539f\u56e0\u662f\u5e76\u4e0d\u4f1a\u62f7\u8d1d\u539f\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u5417\uff0c\u800c\u53ea\u662f\u5f88\u5feb\u901f\u7684\u751f\u6210\u6307\u9488 </li> <li>\u514b\u9686\u6570\u636e\u5e93\u5e76\u4e0d\u5305\u542b\u6570\u636e\uff0c\u800c\u662f\u5305\u542b\u4e00\u5806\u6307\u9488\u3002\u5f53\u7528\u6237\u8bbf\u95ee\u539f\u6570\u636e\u5e93\u662f\u662f\u901a\u8fc7\u6307\u9488\u53bb\u8bbf\u95ee\u539f\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e</li> <li>\u5f53\u6e90\u6570\u636e\u5e93\u53d1\u751f\u6539\u53d8\u65f6\uff0c\u6e90\u6570\u636e\u91cc\u7684\u6570\u636e\u4fdd\u7559\u4e0d\u53d8\uff0c\u88ab\u4fee\u6539\u7684\u6570\u636e\u5757\u62f7\u8d1d\u4e00\u4efd\u51fa\u6765\uff0c\u5728\u62f7\u8d1d\u51fa\u6765\u7684\u6570\u636e\u5feb\u505a\u4fee\u6539</li> <li>\u5bf9\u4e8e\u514b\u9686\u6570\u636e\u6765\u8bf4\uff0c\u59cb\u7ec8\u53ef\u4ee5\u770b\u5230\u521b\u5efa\u514b\u9686\u6570\u636e\u5e93\u65f6\u6e90\u6570\u636e\u5feb\u4e2d\u7684\u5185\u5bb9 \u6bd4\u59829\u70b9\u521b\u5efa\u7684\u514b\u9686\uff0c\u53ef\u4ee5\u770b\u5230\u9759\u6001\u7684\u4e5d\u70b9\u949f\u521b\u5efa\u7684\u514b\u9686\u7684\u5185\u5bb9</li> <li>\u6e90\u5e93\u7684\u53d8\u5316\u4e0d\u4f1a\u5f71\u54cd\u6e90\u6570\u636e\u6587\u4ef6\uff0c\u662f\u4f1a\u62f7\u8d1d\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u5757</li> <li>\u5bf9\u514b\u9686\u5e93\u4fee\u6539\u65f6\uff0c\u4e5f\u662f\u5bf9\u6e90\u6570\u636e\u8fdb\u884c\u62f7\u8d1d\uff0c\u8fdb\u884c\u4fee\u6539</li> </ul> </li> <li>\u4ec5\u5728\u53d1\u751f\u5199\u5165\u65f6\u590d\u5236\u6570\u636e(COW) \u2013 \u5f53\u539f\u59cb\u6570\u636e\u548c\u514b\u9686\u5377\u6570\u636e\u4e0d\u540c\u65f6</li> </ul> <p>\u5e94\u7528\u573a\u666f</p> <ul> <li>\u514b\u9686\u751f\u4ea7\u6570\u636e\u5e93\u4ee5\u8fd0\u884c\u6d4b\u8bd5</li> <li>\u6570\u636e\u5e93\u91cd\u7ec4</li> <li>\u4e3a\u5206\u6790\u63d0\u4f9b\u4e00\u4e2a\u65f6\u95f4\u70b9\u5feb\u7167\uff0c\u4e0d\u5f71\u54cd\u751f\u4ea7\u73af\u5883\uff0c\u53ef\u4ee5\u4ea7\u751f\u4e00\u4e2a\u7528\u4e8e\u5206\u6790\u7684\u9759\u6001\u5185\u5bb9</li> </ul>"},{"location":"aurora/1Intital_Explore/#10-9","title":"10-9 \u5168\u7403\u6570\u636e\u5e93\u66f4\u5feb\u7684\u707e\u96be\u6062\u590d\u901f\u5ea6\u4e0e\u6570\u636e\u4f4d\u7f6e\u5f3a\u5316","text":"<p>Aurora \u652f\u6301\u4e00\u4e2a\u53eb\u505aGloal DB\u7684\u529f\u80fd\uff0c\u4f9d\u6258\u4e8eAWS\u7684\u5168\u7403\u9aa8\u5e72\u7f51\u7edc\uff0c\u53ef\u4ee5\u5feb\u901f\u7684\uff0c\u8ba9\u6211\u4eec\u4e0d\u540c\u7684region\u91cc\u7684\u4ece\u8282\u70b9\u53bb\u548c\u4e3b\u8282\u70b9\u8fdb\u884c\u6570\u636e\u7684\u540c\u6b65</p> <p>\u6570\u636e\u7684\u540c\u6b65\u5e76\u4e0d\u662f\u901a\u8fc7binlog\u7684\u65b9\u5f0f\uff0c\u800c\u662f\u901a\u8fc7redolog\u7684\u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u540c\u6b65,\u4ece\u8282\u70b9\u548c\u4e3b\u8282\u70b9\u7684\u5ef6\u8fdf\u662f\u4e2a\u4f4d\u6570\u79d2\u7ea7\u4e3a\u5355\u4f4d</p>"},{"location":"aurora/1Intital_Explore/#11-aurora","title":"11\u3001 Aurora \u65b0\u7279\u6027","text":""},{"location":"aurora/1Intital_Explore/#11-1-aurora-multi-master","title":"11-1 Aurora Multi-Master","text":"<p>\u901a\u8fc7\u4f7f\u7528Amazon Aurora Multi-Master\uff0c\u53ef\u4ee5\u5728\u591a\u4e2a\u53ef\u7528\u533a\u4e2d\u521b\u5efa\u591a\u4e2a\u8bfb\u53d6/\u5199\u5165\u4e3b\u5b9e\u4f8b\u3002\u5e94\u7528\u7a0b\u5e8f\u5c31\u53ef\u4ee5\u5728\u96c6\u7fa4\u7684\u591a\u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u4e2d\u8bfb\u53d6\u548c\u5199\u5165\u6570\u636e\uff0c\u5c31\u50cf\u76ee\u524d\u53ef\u4ee5\u5728\u53ea\u8bfb\u526f\u672c\u4e2d\u8bfb\u53d6\u4e00\u6837\u3002</p> <p></p> <ul> <li>\u6765\u81ea\u4efb\u4f55\u5b9e\u4f8b\u5931\u8d25\u7684\u5e94\u7528\u7a0b\u5e8f\u96f6\u505c\u673a\u65f6\u95f4</li> <li>\u53ef\u7528\u533aA\u6545\u969c\u4e0d\u4f1a\u5bfc\u81f4\u5e94\u7528\u7a0b\u5e8f\u505c\u673a</li> <li>\u66f4\u5feb\u7684\u5199\u5165\u6027\u80fd\u548c\u66f4\u9ad8\u7684\u89c4\u6a21</li> <li>\u66f4\u5f3a\u5927\u7684\u6269\u5c55\u80fd\u529b</li> </ul> <p>https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-multi-master.html#aurora-multi-master-overview</p> <ul> <li>In a multi-master cluster, all DB instances can perform write operations. \u3001</li> <li>The notions of a single read/write primary instance and multiple read-only Aurora Replicas don't apply. </li> <li>There isn't any failover when a writer DB instance becomes unavailable, because another writer DB instance is immediately available to take over the work of the failed instance</li> </ul> <p>Currently, multi-master clusters require Aurora MySQL version 1, which is compatible with MySQL 5.6. When specifying the DB engine version in the AWS Management Console, AWS CLI, or RDS API, choose 5.6.10a.</p> <p>Multi-master clusters have no dedicated read-only nodes. </p> <ul> <li>Multi-master clusters keep track of all changes to data within all database instances. The unit of measurement is the data page, which has a fixed size of 16 KB</li> <li>If two DB instances attempt to modify the same data page at almost the same instant, a write conflict occurs. The earliest change request is approved using a quorum voting mechanism\u3002 That change is saved to permanent storage.</li> <li>The DB instance whose change isn't approved rolls back the entire transaction containing the attempted change. Rolling back the transaction ensures that data is kept in a consistent state, and applications always see a predictable view of the data</li> </ul>"},{"location":"aurora/1Intital_Explore/#11-1-recommended-workloads-for-multi-master-clusters","title":"11-1 Recommended workloads for multi-master clusters","text":"<p>Active-passive workloads</p> <p>With an active-passive workload, you perform all read and write operations on one DB instance at a time. You hold any other DB instances in the Aurora cluster in reserve. If the original active DB instance becomes unavailable, you immediately switch all read and write operations to the other DB instance. With this configuration, you minimize any downtime for write operations.</p> <p>Active-active workloads</p> <p>With an active-active workload, you perform read and write operations to all the DB instances at the same time. </p> <p>In this configuration, you typically segment the workload so that the different DB instances don't modify the same underlying data at the same time. Doing so minimizes the chance for write conflicts.</p> <p>Multi-master clusters work well with application logic that's designed for a segmented workload. </p> <p>In this type of workload, you divide write operations by database instance, database, table, or table partition</p> <p>For example, you can run multiple applications on the same cluster, each assigned to a specific DB instance. Alternatively, you can run an application that uses multiple small tables, such as one table for each user of an online service. Ideally, you design your schema so that write operations for different DB instances don't perform simultaneous updates to overlapping rows within the same tables.</p>"},{"location":"aurora/1Intital_Explore/#11-2-auroraserverless","title":"11-2 Aurora\u65e0\u670d\u52a1\u5668\u67b6\u6784(Serverless)","text":"<p>Serverless \u662f\u4e00\u79cd\u9762\u5411 Aurora \u7684\u6309\u9700\u6269\u5c55\u914d\u7f6e\uff0c\u6570\u636e\u5e93\u5c06\u6839\u636e\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u9700\u6c42\u6765\u81ea\u52a8\u542f\u52a8\u3001 \u5173\u95ed\u4ee5\u53ca\u7eb5\u5411\u548c\u6a2a\u5411\u6269\u5c55\u6570\u636e\u5e93\u5bb9\u91cf\u3002\u53ef\u5728\u4e91\u4e2d\u8fd0\u884c\u5173\u7cfb\u6570\u636e\u5e93\uff0c\u800c\u65e0\u9700\u7ba1\u7406\u6570\u636e\u5e93\u5b9e\u4f8b\u6216\u96c6\u7fa4</p> <ul> <li>\u53ef\u4ee5\u57282-3\u79d2 \u5c06\u6570\u636e\u5e93\u62c9\u8d77\u6765</li> <li> <p>\u65e0\u7f1d\u7684\u5f39\u6027\u6269\u5c55</p> </li> <li> <p>\u6309\u9700\u81ea\u52a8\u542f\u505c</p> </li> <li>\u65e0\u670d\u52a1\u5668\u5316\u3001\u81ea\u52a8\u6269\u5c55</li> <li>\u4f7f\u7528\u7684\u8d44\u6e90\u6309\u79d2\u4ed8\u8d39</li> </ul> <p></p>"},{"location":"aurora/1Intital_Explore/#11-3","title":"11-3 \u5e76\u884c\u67e5\u8be2","text":"<ul> <li>\u5c06\u67e5\u8be2\u5904\u7406\u4e0b\u79fb\u81f3 Aurora \u5b58\u50a8\u5c42</li> <li>\u8de8\u6570\u767e\u4e2a\u751a\u81f3\u6570\u5343\u4e2a\u5b58\u50a8\u8282\u70b9\u5e76\u884c\u8fd0\u884c\u67e5\u8be2</li> <li>\u51cf\u5c11\u4e86\u5bf9\u7f51\u7edc\u3001CPU \u548c\u7f13\u51b2\u6c60\u8d44\u6e90\u7684\u4e89\u593a</li> <li>\u63d0\u9ad8\u4e86\u5927\u578b\u5206\u6790\u67e5\u8be2\u7684\u6027\u80fd</li> </ul> <p>While some databases can parallelize query processing across CPUs in one or a handful of servers, Parallel Query takes advantage of Aurora\u2019s unique architecture to push down and parallelize query processing across thousands of CPUs in the Aurora storage layer. By offloading analytical query processing to the Aurora storage layer, Parallel Query reduces network, CPU, and buffer pool contention with the transactional workload.</p> <p></p>"},{"location":"aurora/1Intital_Explore/#11-4-aurora","title":"11-4 Aurora\u5168\u7403\u540c\u5e93\u8de8\u533a\u57df\u591a\u4e3b\u8282\u70b9","text":"<ul> <li>\u5e94\u7528\u8de8\u5168\u7403\u5206\u90e8\uff0c\u4e00\u4e2a\u6570\u636e\u5e93\u8de8\u5168\u7403\u7684\u9ad8\u6548\u7684\u8bbf\u95ee</li> <li>\u6bcf\u4e2a\u8282\u70b9\u8de8\u533a\u57df\u7684\u5199\u5165</li> </ul> <ul> <li>\u672c\u5730\u5199 </li> <li>\u4e50\u89c2\u9501\u5e76\u53d1\u63a7\u5236 \u2014\u2014 \u6ca1\u6709\u5206\u5e03\u5f0f\u9501\u7ba1\u7406\u5668\u4e0e\u5168\u5c40\u9501\u7ba1\u7406\u534f\u8bae </li> <li>\u5206\u5c42\u51b2\u7a81\u5904\u7406 \u2014\u2014 \u4e3b\u8282\u70b9\u3001\u5b58\u50a8\u8282\u70b9\u3001\u53ef\u7528\u533a\u3001\u533a\u57df\u7ea7\u522b\u4ef2\u88c1\uff0c\u5f53\u65e0\u6216\u4f4e\u51b2\u7a81\u7ea7\u522b\u65f6\u6027\u80fd\u6269\u5c55</li> </ul>"},{"location":"aurora/2Aurora_Adv/","title":"\u7b2c\u4e8c\u8282 \u63ed\u79d8 Aurora \u5e95\u5c42\u5b58\u50a8","text":""},{"location":"aurora/2Aurora_Adv/#1","title":"1\u3001\u5feb\u901f\u56de\u987e\uff1a \u6570\u636e\u5e93\u5185\u90e8\u7ed3\u6784","text":""},{"location":"aurora/2Aurora_Adv/#1-1-b","title":"1-1 \u6570\u636e\u5e93B+\u6811","text":"<ul> <li>\u6570\u636e\u5e93B+\u6811\uff0c\u6839\u8282\u70b9\uff0c \u4e2d\u95f4\u70b9\uff0c \u53f6\u5b50\u8282\u70b9\uff0c\u6570\u636e\u653e\u5728\u53f6\u5b50\u8282\u70b9</li> <li>\u6570\u636e\u5728\u5185\u5b58\u4e2d\u4ee5\u56fa\u5b9a\u5927\u5c0f\u8b6c\u598216KB\u7684\u201c\u9875\u9762\u201d \u5b58\u50a8\uff08aka \"buffer-pool\") </li> <li>\u5185\u5b58\u7684\u6570\u636e\u4ece\u6210\u672c\u7684\u8003\u8651\u548c\u9ad8\u53ef\u7528\u7684\u8003\u8651\u4e0d\u4f1a\u957f\u4e45\u7684\u5b58\u653e\uff0c\u6570\u636e\u4f1a\u88ab\u5b9a\u671f\u5199\u5165\u6301\u4e45\u7684\u5b58\u50a8\u4e2d\u53bb\uff08checkpoint)</li> </ul>"},{"location":"aurora/2Aurora_Adv/#1-2-do-redo-undo","title":"1-2 \u5feb\u901f\u56de\u987e\uff1aDO-REDO-UNDO\u534f\u8bae","text":"<ul> <li>\u6570\u636e\u5728buffer-pool\u4e2d\u901a\u8fc7Do/REDO/UNDO\u64cd\u4f5c\u5728\u201c\u539f\u4f4d\u2018\u2019\u4fee\u6539 </li> <li>\u5305\u542b\u524d\u50cf/\u540e\u50cf\u7684\u65e5\u5fd7\u8bb0\u5f55\u88ab\u5b58\u50a8\u5230<code>write-ahead Log (WAL)</code></li> </ul> <ul> <li>REDO: \u91cd\u653e\u64cd\u4f5c\uff0c\u5305\u542b\u524d\u50cf/\u540e\u50cf\uff0c\u53d8\u66f4\u7684\u4e1c\u897f</li> <li>UNDO\uff1a\u53cd\u8fc7\u6765\uff0c\u53d8\u66f4\u9519\u4e86\uff0c\u56de\u6eda\u64cd\u4f5c</li> </ul>"},{"location":"aurora/2Aurora_Adv/#1-3","title":"1-3 \u5feb\u901f\u56de\u987e\uff1a\u5d29\u6e83\u6062\u590d","text":"<ul> <li>\u4e8b\u52a11\uff1a \u63d0\u4ea4\u505a\u4e86checkpoint, \u65e5\u5fd7\u6709\uff0c\u6570\u636e\u810f\u5757\u843d\u76d8</li> <li>\u4e8b\u52a12\uff0c\u4e8b\u52a13\u5199\u4e86REDO\uff0c\u6ca1\u6709\u505acheckpoint</li> <li>\u4e8b\u52a14\u6ca1\u505a\u5b8c\uff0c\u7cfb\u7edf\u5d29\u6e83\u4e86</li> </ul> <ul> <li>REDO LOG\u91cd\u653e\uff0c\u4ececheckpoint \u91cd\u653e, \u4e8b\u52a11\u4e0d\u7528\u91cd\u653e</li> <li>\u4e8b\u52a12\uff0c\u4e8b\u52a13\u901a\u8fc7REDO\u91cd\u653e</li> <li>\u4e8b\u52a14\u6ca1\u6709\u63d0\u4ea4\uff0c\u6240\u4ee5\u8981\u901a\u8fc7UNDO\u56de\u6eda</li> </ul>"},{"location":"aurora/2Aurora_Adv/#1-4-io","title":"1-4 \u5feb\u901f\u56de\u987e\uff1a\u6301\u4e45\u5316\u6240\u9700\u7684IO","text":"<ul> <li>\u7528\u6237\u6570\u636e\u53d8\u5316\u7684\u5927\u8fdc\u8fdc\u5c0f\u4e8eI/O\u5927\u5c0f\uff0832KB+) </li> <li>\u6570\u636e\u5e93\u7684\u4e00\u5207\u90fd\u4e0eI/O\u76f8\u5173</li> </ul> <p>\u4f20\u7edf\u7684\u6570\u636e\u5e93\u4e0d\u662f\u6bcf\u4e2acheckpoint\u90fd\u53bb\u5199\uff0c\u6548\u7387\u592a\u4f4e\u4e86\uff0c\u9694\u4e00\u6bb5\u65f6\u95f4\u5199\u4e00\u4e0b\uff0c\u591a\u4e2a\u4e8b\u52a1\u5e76\u53d1\u52b2\u91cf\u5408\u5e76\u7684</p>"},{"location":"aurora/2Aurora_Adv/#io","title":"\u4f20\u7edf\u6570\u636e\u5e93\u7684\u76ee\u7684\u5c31\u662f\u51cf\u5c11IO","text":"<ul> <li>\u7f13\u5b58/\u67e5\u8be2\u4f18\u5316/ \u786c\u4ef6\u65b9\u9762\u63d0\u9ad8IO\u5e26\u5bbd</li> </ul>"},{"location":"aurora/2Aurora_Adv/#2","title":"2\u3001\u539f\u751f\u6570\u636e\u5e93\u7684\u67b6\u6784","text":""},{"location":"aurora/2Aurora_Adv/#2-1-amazon-aurora","title":"2-1 Amazon Aurora\u7684\u65b9\u5f0f\u65e5\u5fd7\u5373\u6570\u636e\u5e93","text":"<p>\u4ece\u6570\u636e\u5e93\u521b\u5efa\u5f00\u59cb\u7684\u65e5\u5fd7\u6d41 </p> <p></p> <ul> <li>\u4efb\u4f55\u7248\u672c\u7684\u6570\u636e\u5e93\u9875\u9762\u90fd\u53ef\u4ee5\u901a\u8fc7\u65e5\u5fd7\u6d41\u6784\u9020 </li> <li>\u7eff\u8272\u9875\u9762 t5 \u53ef\u4ee5\u901a\u8fc7 t1 \u5230 t5 \u7684\u65e5\u5fd7\u6765\u751f\u6210 </li> </ul> <p></p>"},{"location":"aurora/2Aurora_Adv/#2-2-amazon-aurora","title":"2-2 Amazon Aurora\u7684\u65b9\u5f0f\uff1a\u5c06\u9669\u67e5\u70b9\u5de5\u4f5c\u4e0b\u653e\u5230\u5b58\u50a8\u5c42","text":"<p>\u95ee\u98981:</p> <p>\u4ec5\u4ec5\u4f9d\u9760\u65e5\u5fd7\u6d41\u6765\u5e94\u4ed8\u8bfb\u53d6\u9875\u9762\u4e0d\u5b9e\u9645\uff08\u592a\u6162\uff09 \uff0c</p> <p>\u5efa\u5e93\u521a\u5f00\u59cb\u53ef\u4ee5\uff0c\u6784\u5efa\u4e24\u5e74\u540e\u7684\u6570\u636e\u5e93\u7684REDO log\u4e0d\u73b0\u5b9e</p> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <p>\u4f7f\u7528\u5b9a\u671f\u68c0\u67e5\u70b9</p> <p>\u95ee\u98982: </p> <p>\u68c0\u67e5\u70b9\u4efb\u52a1\u662f\u6570\u636e\u5e93\u7684\u91cd\u5927\u8d1f\u8377\uff0c\u611f\u89c9\u548c\u4f20\u7edf\u6ca1\u6709\u533a\u522b</p> <p>\u89e3\u51b3\u529e\u6cd5\uff1a</p> <ul> <li>\u4f7f\u7528\u5206\u5e03\u5f0f\u5b58\u50a8\u505a\u6301\u7eed\u7684\u68c0\u67e5\u70b9 </li> <li>\u4e0a\u5343\u4e2a\u8282\u70b9\u5728\u5468\u671f\u6027\uff0c\u5f02\u6b65\u7684\u505acheckpoint</li> </ul>"},{"location":"aurora/2Aurora_Adv/#2-3-amazon-aurora","title":"2-3 Amazon Aurora\u7684\u65b9\u5f0f\uff1a\u8ba1\u7b97\u4e0e\u5b58\u50a8\u5206\u79bb","text":"<p>\u8ba1\u7b97\u4e0e\u5b58\u50a8\u6709\u4e0d\u540c\u7684\u751f\u547d\u5468\u671f </p> <p>\u8ba1\u7b97\u5b9e\u4f8b </p> <ul> <li>\u635f\u574f\u540e\u88ab\u66ff\u6362</li> <li>\u505c\u673a\u8282\u7701\u8d39\u7528</li> <li>\u57fa\u4e8e\u8d1f\u8f7d\u6269\u5c55\u3001\u6536\u7f29 </li> </ul> <p>\u5b58\u50a8\uff0c\u4ece\u53e6\u4e00\u4e2a\u89d2\u5ea6\u6765\u8bf4\uff0c\u662f\u957f\u671f\u7684</p> <p>\u4e3a\u53ef\u4f38\u7f29\u6027\u3001\u53ef\u7528\u6027\u548c\u6301\u4e45\u6027\u89e3\u85d5\u8ba1\u7b97\u548c\u5b58\u50a8 </p>"},{"location":"aurora/2Aurora_Adv/#2-4-amazon-aurora","title":"2-4 Amazon Aurora\u4f7f\u7528\u9762\u5411\u670d\u52a1\u7684\u4f53\u7cfb\u7ed3\u6784","text":"<p>\u4e13\u95e8\u6784\u5efa\u4e00\u4e2a\u591a\u79df\u6237\uff0c\u591a\u9644\u52a0\u7684\u4e13\u95e8\u4e3a\u6570\u636e\u5e93\u6253\u9020\u7684\u65e5\u5fd7\u7ed3\u6784\u5206 \u5e03\u5f0f\u5b58\u50a8\u7cfb\u7edf </p> <p>\u591a\u79df\u6237</p> <p>\u4e0d\u662f\u4e3a\u6bcf\u4e00\u4e2a\u6570\u636e\u5e93\u7528\u6237\u5c31\u6784\u5efa\u4e00\u4e2a\u5b58\u50a8\u8282\u70b9</p> <p>\u591a\u9644\u52a0</p> <p>\u96c6\u7fa4\u4e2d\u7684\u5199\u8282\u70b9\u8bfb\u8282\u70b9\uff0c\u5176\u5b9e\u662fshare disk,\u5b58\u50a8\u7ed3\u6784\u8981\u540c\u65f6\u6302\u5230\u8fd9\u4e9b\u8282\u70b9\u4e0a</p> <p></p> <p>\u5229\u7528AWS \u73b0\u6709\u670d\u52a1</p> <ul> <li>DynamoDB(Key-Value): \u5b58\u50a8\u539f\u6570\u636emetadata, exp, \u5b58\u50a8\u8282\u70b9\u7684\u6570\u636e\u5206\u90e8\uff0c\u8f6f\u4ef6\u7684\u60c5\u51b5</li> <li>Route53: DNS\u7684\u53d8\u5316</li> <li>EC2</li> <li>S3 \u5907\u4efd</li> </ul>"},{"location":"aurora/2Aurora_Adv/#2-5-amazon-aurora-io","title":"2-5 Amazon Aurora \u5b58\u50a8\u8282\u70b9I/O\u6d41","text":"<ol> <li>\uff08\u5199\u5165\u65e5\u5fd7\u53d1\u5230\u5b58\u50a8\u8282\u70b9\uff09\u63a5\u6536\u65e5\u5fd7\u8bb0\u5f55\u653e\u5165\u5185\u5b58\u961f\u5217\u5e76\u6301\u4e45\u5316 <ul> <li>\u540c\u65f6\u5199\u51656\u4e2a\uff0c4\u4e2a\u6210\u529f\u53ca\u8868\u73b0\u4e3a\u6210\u529f</li> </ul> </li> <li>\u901a\u77e5\u6570\u636e\u5e93</li> <li>\u7ec4\u7ec7\u65e5\u5fd7\u5e76\u786e\u8ba4\u95f4\u9699 (\u5199\u5165\u7684\u65e5\u5fd7\u88ab\u7ec4\u7ec7\uff0c\u5e76\u67e5\u770b\u662f\u5426\u6709\u95f4\u9699) </li> <li>\u901a\u8fc7Gossip\u5230peers\u8865\u8db3\u95f4\u9699 <ul> <li>\u901a\u8fc7gossip \u5230\u5176\u4ed6peer\u8282\u70b9\u628a\u65e5\u5fd7\u62c9\u51fa\u6765\uff0c\u8865\u8db3\u95f4\u9699</li> </ul> </li> <li>\u5408\u5e76\u65e5\u5fd7\u8bb0\u5f55\u5f62\u6210\u65b0\u7684\u9875\u9762 <ul> <li>\u8865\u8db3\u95f4\u9699\u540e\uff0c\u65e7\u9875\u9762\u548c\u65e5\u5fd7\u5408\u6210\u65b0\u7684\u9875\u9762\u5b9a\u671f</li> </ul> </li> <li>\u5b9a\u671f\u5c06\u65e5\u5fd7\u548c\u5408\u5e76\u540e\u7684page\u653e\u5230s3 \uff08\u88ab\u4ee5\u540e\u7684\u67e5\u8be2\uff0c\u6062\u590d\u5229\u7528\uff09</li> <li>\u5b9a\u671f\u5783\u573e\u56de\u6536\uff0c\u6e05\u7406\u65e7\u9875\u9762 \uff08\u5f53\u4e3b\u8282\u70b9\u548c\u53ea\u8bfb\u8282\u70b9\u90fd\u4e0d\u5728\u9700\u8981\uff0c\u88ab\u56de\u6536\uff09</li> <li>\u5b9a\u671f\u68c0\u67e5\u9875\u9762\u4e00\u81f4\u6027 \uff08checksum) \u5982\u679c\u7f3a\u5931\uff0c\u53bb\u5176\u4ed6\u8282\u70b9\u53bb\u8981</li> </ol> <p>\u6ce8\u610f\uff1a </p> <ul> <li>\u6240\u6709\u6b65\u9aa4\u90fd\u662f\u5f02\u6b65\u7684 \uff08\u9664\u4e861\uff0c2\u6b65\uff09</li> <li>\u53ea\u6709\u7b2c\u4e00\u6b65\u548c\u7b2c\u4e8c\u6b65\u4f1a\u9020\u6210\u524d\u7aef\u5ef6\u8fdf </li> </ul>"},{"location":"aurora/2Aurora_Adv/#3","title":"3\u3001\u5927\u89c4\u6a21\u7684\u6301\u4e45\u6027","text":""},{"location":"aurora/2Aurora_Adv/#3-1-auroraaz1","title":"3-1 Aurora\u53ef\u4ee5\u5bb9\u5fcdAZ+1\u6545\u969c","text":"<ul> <li> <p>\u590d\u52366\u4efd\uff0c\u6bcf\u4e2aAZ\u67092\u4efd </p> <ul> <li>\u5f62\u6210quorum\uff0c\u8981\u6c426\u51994\u6210\u529f </li> </ul> </li> <li> <p>\u5982\u679c\u9762\u4e34AZ\u6545\u969c\uff1f </p> <ul> <li>\u4f9d\u7136\u53ef\u4ee5\u4fdd\u8bc14/6\u62f7\u8d1d </li> <li>\u4fdd\u6301\u53ef\u5199</li> </ul> </li> <li> <p>\u5982\u679c\u9762\u4e34AZ+1\u6545\u969c\u5462\uff1f </p> <ul> <li>\u4f9d\u7136\u67093\u4efd\u62f7\u8d1d </li> <li>\u4e0d\u4f1a\u6709\u6570\u636e\u4e22\u5931</li> <li>\u901a\u8fc7\u5e78\u5b58\u76843\u62f7\u8d1d\u6062\u590d\u635f\u574f\u7684\u62f7\u8d1d </li> <li>\u6062\u590d\u5199\u80fd\u7684\u529b </li> </ul> </li> </ul> <p></p>"},{"location":"aurora/2Aurora_Adv/#3-2-amazon-aurora","title":"3-2 Amazon Aurora\u4f7f\u7528\u6bb5\u5b58\u50a8","text":"<ul> <li> <p>\u5c06\u6570\u636e\u5206\u6210n\u4e2a\u56fa\u5b9a\u5927\u5c0f\u7684\u6bb5 </p> <ul> <li>\u5728\u4e00\u4e2aprotection group (PG\uff09\u4e2d\u5bf9\u6bcf\u4e2a\u6bb5\u590d\u52366\u4efd </li> </ul> </li> <li> <p>\u5728\u6545\u969c\u7387\u4ee5\u53ca\u4fee\u590d\u65f6\u95f4\u4e4b\u95f4\u5e73\u8861 </p> <ul> <li>\u5982\u679c\u6bb5\u592a\u5c0f\uff0c\u6545\u969c\u7387\u8fc7\u9ad8</li> <li>\u5982\u679c\u6bb5\u592a\u5927\uff0c\u5219\u4fee\u590d\u65f6\u95f4\u8fc7\u957f </li> </ul> </li> <li> <p>\u9009\u62e9\u5728\u4fdd\u8bc1\u201c\u8db3\u591f\u5feb\u201d\u4fee\u590d\u7684\u524d\u63d0\u4e0b\u7684\u6700\u5927\u5927\u5c0f \uff0e</p> <ul> <li>\u6211\u4eec\u73b0\u5728\u6bb5\u5927\u5c0f\u662f\u662f10GB\uff0c\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u57281\u5206\u949f\u4ee5\u5185\u4fee\u590d\u4e00\u4e2a10G\u7684\u6bb5</li> </ul> </li> </ul>"},{"location":"aurora/2Aurora_Adv/#3-3","title":"3-3 \u5feb\u901f\u548c\u53ef\u9006\u7684\u6210\u8bed\u53d8\u5316","text":"<ul> <li>\u4f7f\u7528 quorum sets \u4e0eepochs \u6765 <ul> <li>\u901a\u8fc7epoch\u5b9e\u73b0\u5feb\u901f\u66f4\u6539 </li> <li>\u5728\u6210\u5458\u53d8\u5316\u65f6\u521b\u5efa\u989d\u5916\u7684\u7684quorums </li> <li>\u7528\u591a\u4e2aquorum\u6765\u5feb\u901f\u9006\u8f6c\u66f4\u6539 </li> </ul> </li> </ul> <ul> <li>F \u53ef\u7591\uff1a \u7f51\u7edc\u7684\u5835\u585e</li> <li>\u4e24\u4e2aEpoch\u90fd\u53ef\u4ee5\u6ee1\u8db34/6\u5199\u5165\u6210\u529f</li> <li>\u65b0\u7684quorum\u8d77\u6765\u4ee5\u540e\uff0c\u4ece\u5176\u4ed6\u8282\u70b9\u62f7\u8d1d\u6570\u636e</li> <li>\u786e\u5b9e\u6709\u95ee\u9898\uff0c\u66f4\u65b0epochs\uff0c\u4fdd\u8bc1\u53ea\u5199\u5165quorum  G\u5c31\u597d\u4e86</li> </ul> <p>\u4e00\u8fb9\u4fee\u590d\u4e00\u8fb9\u89c2\u5bdf</p>"},{"location":"aurora/2Aurora_Adv/#4","title":"4\u3001\u6027\u80fd","text":""},{"location":"aurora/2Aurora_Adv/#4-1-amazon-aurora-io","title":"4-1 Amazon Aurora I/O\u6982\u51b5","text":""},{"location":"aurora/2Aurora_Adv/#5","title":"5\u3001\u5168\u5c40\u6570\u636e\u5e93","text":""},{"location":"aurora/2Aurora_Adv/#5-1","title":"5-1 \u5168\u5c40\u7269\u7406\u590d\u5236","text":"<p>\u4f20\u7edf\u7684\u6570\u636e\u5e93\u590d\u5236\u90fd\u662f\u901a\u8fc7binlog,\u5ef6\u8fdf\u6bd4\u8f83\u957f</p> <p></p> <ol> <li>\u4e3b\u5b9e\u4f8b\u5c06\u65e5\u5fd7\u8bb0\u5f55\u7528\u4e8e\u53d1\u9001\u5012\u5b58\u50a8\u8282\u70b9\uff0c\u53ea\u8bfb\u5b9e\u4f8b\u548c\u590d\u5236\u670d\u52a1\u5668</li> <li>\u590d\u5236\u670d\u52a1\u5668\u5c06\u65e5\u5fd7\u6d41\u53d1\u9001\u5230secondary region \u7684\u590d\u5236\u4ee3\u7406</li> <li>\u590d\u5236\u670d\u52a1\u5668\u5c06\u65e5\u5fd7\u5e76\u884c\u53d1\u9001\u7ed9\u5b58\u50a8\u8282\u70b9\u548c\u53ea\u8bfb\u526f\u672c</li> <li> <p>\u590d\u5236\u670d\u52a1\u5668\u53ef\u4ee5\u4ece\u5b58\u50a8\u8282\u70b9\u62c9\u65e5\u5fd7\u8bb0\u5f55\u4ee5\u5f25\u8865\u6545\u969c\u9020\u6210\u7684\u95f4\u9699</p> </li> <li> <p>\u9ad8\u541e\u5410\uff1a 150K writes/second\u7684\u8d1f\u8f7d\uff0c\u590d\u5236\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\u4e5f\u662f\u5fae\u4e4e\u5176\u5fae</p> </li> <li>\u4f4e\u590d\u5236\u5ef6\u8fdf\uff1a\u9ad8\u8d1f\u8f7d\u4e0b\u4f9d\u7136\u4fdd\u6301\u6b21\u79d2\u7ea7\u8de8\u533a\u57df\u590d\u5236\u5ef6\u8fdf</li> <li>\u5feb\u901f\u6062\u590d\uff1a\u533a\u57df\u6545\u969c\u540e1\u5206\u949f\u4ee5\u5185\u5373\u53ef\u627f\u62c5\u5168\u9762\u8bfb\u5199</li> </ol>"},{"location":"aurora/2Aurora_Adv/#5-2","title":"5-2 \u5168\u5c40\u590d\u5236\u6027\u80fd","text":"<p>QPS\u5bf9LAG\u7684\u5f71\u54cd</p>"},{"location":"aurora/2Aurora_Adv/#6","title":"6\u3001\u5feb\u901f\u6570\u636e\u5e93\u514b\u9686","text":""},{"location":"aurora/2Aurora_Adv/#6-1-aurora","title":"6-1 Aurora\u6570\u636e\u5e93\u514b\u9686\u6280\u672f","text":"<p>\u514b\u9686\u6570\u636e\u5e93\u800c\u4e0d\u590d\u5236\u6570\u636e =&gt; \u53ef\u4ee5\u5f88\u5feb\u521b\u5efa\u4e00\u4e2aclone</p> <p></p> <ul> <li>\u77ac\u95f4\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5e93\u514b\u9686<ul> <li>\u5feb\u7684\u539f\u56e0\u662f\u5e76\u4e0d\u4f1a\u62f7\u8d1d\u539f\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u5417\uff0c\u800c\u53ea\u662f\u5f88\u5feb\u901f\u7684\u751f\u6210\u6307\u9488 </li> <li>\u514b\u9686\u6570\u636e\u5e93\u5e76\u4e0d\u5305\u542b\u6570\u636e\uff0c\u800c\u662f\u5305\u542b\u4e00\u5806\u6307\u9488\u3002\u5f53\u7528\u6237\u8bbf\u95ee\u539f\u6570\u636e\u5e93\u662f\u662f\u901a\u8fc7\u6307\u9488\u53bb\u8bbf\u95ee\u539f\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e</li> <li>\u5f53\u6e90\u6570\u636e\u5e93\u53d1\u751f\u6539\u53d8\u65f6\uff0c\u6e90\u6570\u636e\u91cc\u7684\u6570\u636e\u4fdd\u7559\u4e0d\u53d8\uff0c\u88ab\u4fee\u6539\u7684\u6570\u636e\u5757\u62f7\u8d1d\u4e00\u4efd\u51fa\u6765\uff0c\u5728\u62f7\u8d1d\u51fa\u6765\u7684\u6570\u636e\u5feb\u505a\u4fee\u6539</li> <li>\u5bf9\u4e8e\u514b\u9686\u6570\u636e\u6765\u8bf4\uff0c\u59cb\u7ec8\u53ef\u4ee5\u770b\u5230\u521b\u5efa\u514b\u9686\u6570\u636e\u5e93\u65f6\u6e90\u6570\u636e\u5feb\u4e2d\u7684\u5185\u5bb9 \u6bd4\u59829\u70b9\u521b\u5efa\u7684\u514b\u9686\uff0c\u53ef\u4ee5\u770b\u5230\u9759\u6001\u7684\u4e5d\u70b9\u949f\u521b\u5efa\u7684\u514b\u9686\u7684\u5185\u5bb9</li> <li>\u6e90\u5e93\u7684\u53d8\u5316\u4e0d\u4f1a\u5f71\u54cd\u6e90\u6570\u636e\u6587\u4ef6\uff0c\u662f\u4f1a\u62f7\u8d1d\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u5757</li> <li>\u5bf9\u514b\u9686\u5e93\u4fee\u6539\u65f6\uff0c\u4e5f\u662f\u5bf9\u6e90\u6570\u636e\u8fdb\u884c\u62f7\u8d1d\uff0c\u8fdb\u884c\u4fee\u6539</li> </ul> </li> <li>\u4ec5\u5728\u53d1\u751f\u5199\u5165\u65f6\u590d\u5236\u6570\u636e(COW) \u2013 \u5f53\u539f\u59cb\u6570\u636e\u548c\u514b\u9686\u5377\u6570\u636e\u4e0d\u540c\u65f6</li> </ul> <p>\u5e94\u7528\u573a\u666f</p> <ul> <li>\u514b\u9686\u751f\u4ea7\u6570\u636e\u5e93\u4ee5\u8fd0\u884c\u6d4b\u8bd5</li> <li>\u6570\u636e\u5e93\u91cd\u7ec4</li> <li>\u4e3a\u5206\u6790\u63d0\u4f9b\u4e00\u4e2a\u65f6\u95f4\u70b9\u5feb\u7167\uff0c\u4e0d\u5f71\u54cd\u751f\u4ea7\u73af\u5883\uff0c\u53ef\u4ee5\u4ea7\u751f\u4e00\u4e2a\u7528\u4e8e\u5206\u6790\u7684\u9759\u6001\u5185\u5bb9</li> </ul>"},{"location":"aurora/2Aurora_Adv/#6-2","title":"6-2 \u6570\u636e\u5e93\u514b\u9686\uff1a\u600e\u4e48\u5de5\u4f5c\u7684\uff1f","text":"<p>\u5b8c\u5168\u4e0d\u9700\u8981\u6df1\u5ea6\u590d\u5236</p> <ul> <li>\u901f\u5ea6\u5feb</li> <li>\u8282\u7701\u7a7a\u95f4\u548c\u6210\u672c</li> </ul>"},{"location":"aurora/3Aurora_operation/","title":"\u7b2c\u4e09\u8282 Aurora Basic Operation","text":""},{"location":"aurora/3Aurora_operation/#1create-database","title":"1\u3001Create Database","text":""},{"location":"aurora/3Aurora_operation/#1-1-introduction","title":"1-1 Introduction","text":"<p>From this operartion guide, I will show simple and clear way to manage AWS Aurora cluster for MySQL from AWS console. Through this guide, you will learn:</p> <ul> <li>Create Amazon Aurora Cluster </li> <li>Operation and management on Amazon Aurora Cluster<ul> <li>Scalability</li> <li>Operation on Read replica </li> <li>Failover</li> <li>Database backtrack</li> </ul> </li> <li>Database backup and restoration</li> <li>Management and Monitoring on Database with Cloudwatch and Performance Insights</li> </ul>"},{"location":"aurora/3Aurora_operation/#1-2-create-amazon-aurora-database-cluster","title":"1-2 Create Amazon Aurora Database Cluster","text":"<p>This part will introduce how to create a MySQL based DataBase cluster, which includes one master db instance and cross three availability zones</p> <p>prerequisites:</p> <ul> <li>Possess one IAM user with proper access right,your AWS account must have IAM policies that grant the permissions required to perform Amazon RDS operations. (With right which can assign IAM roles)</li> </ul> <p>Currently our JAM DevOps IAM user which login from SSO link don't have full IAM rights (can't assign IAM roles) which will failed in creation on Aurora Cluster in assigning IAM rols to Cloudwatch to monitor the Aurora Cluster</p> <ul> <li>Default VPC, subnet or create brand new VPC and subnet for RDS Aurora</li> </ul> <p>Creating Aurora Mysql Database cluster</p> <ul> <li>.Sign in to the AWS Management Console and open the Amazon RDS console at https://console.aws.amazon.com/rds/</li> <li>In the upper-right corner of the AWS Management Console, choose the AWS Region in which you want to create the DB cluster. (Exp: EU(Ireland)) Aurora is not available in all AWS Regions. For a list of AWS Regions where Aurora is available, see Region availability.</li> <li>In the navigation pane, choose Databases.</li> <li>Choose Create database.</li> <li>In Choose a database creation method, choose Standard Create.</li> <li>In Engine options, choose Amazon Aurora.</li> </ul> <p></p> <ul> <li>In Edition, choose Amazon Aurora with MySQL compatibility</li> <li>If you chose Amazon Aurora with MySQL compatibility, choose Capacity type: Provisioned(You provision and manage the server instance sizes.)</li> <li>Choose Single-master as Replication features</li> <li>Choose Version: Aurora MySQL5.7</li> </ul> <p></p> <ul> <li>Settings\uff1a<ul> <li>DB cluster identifier\uff1a jamauroracluster</li> <li>Credentials Settings\uff1a<ul> <li>Master username: admin,   (A login ID for the master user of your DB instance)</li> <li>Master password and Confirm password: (At least 8 printable ASCII characters. Can't contain any of the following: / (slash), '(single quote), \"(double quote) and @ (at sign).)</li> </ul> </li> </ul> </li> <li>DB instance size<ul> <li>DB instance class: Memory Optimized classes (includes r classes)<ul> <li>db.r5.large (2vCPUs and 16GB RAM) (for JAM internal test only)</li> </ul> </li> </ul> </li> <li>Availability &amp; durability: <ul> <li>Multi-AZ deployment\uff1aCreate an Aurora Replica or Reader node in a different AZ (recommended for scaled availability)</li> </ul> </li> <li>Connectivity:<ul> <li>VPC: create new one or choose exist one vpc-025202ed238785f92</li> <li>Subnet group: default</li> <li>Public access: YES (Attention: This is only for test/demo purpose, set No for other circumstance)</li> <li>VPC security group: <ul> <li>Choose existing:<ul> <li>default</li> </ul> </li> </ul> </li> <li>Database port: 3306 (TCP/IP port that the database will use for application connections.)</li> </ul> </li> <li>Database authentication: Password authentication</li> <li>Additional configuration<ul> <li>Initial database name: dbtest (for test only and If you do not specify a database name, Amazon RDS does not create a database. You can create a DB with SQL: CREATE DATABASE) </li> <li>DB cluster parameter group: default (We will create an additional one for JAM database)</li> <li>Failover priority: No preference</li> <li>Backup:<ul> <li>Backup retention period:<ul> <li>1 day (Number of days that RDS should retain automatic backups for this instance.)</li> <li>The backup retention period determines the period for which you can perform a point-in-time recovery</li> <li>Aurora offers 1-day backup retention for free!</li> </ul> </li> </ul> </li> <li>Encryption\uff1a<ul> <li>Enable encryption\uff1a checked</li> <li>Master key: default</li> </ul> </li> <li>Backtrack: Backtrack lets you quickly recover from a user error. <ul> <li>Enabled: check </li> <li>Target Backtrack window: (The Backtrack window determines how far back in time you could go. Aurora will try to retain enough log information to support that window of time.): 1h<ul> <li>Typical user cost:   db.r5.large $ 1.20 USD / month 1h</li> <li>db.r5.large $ 86.28 USD / month 72h</li> </ul> </li> </ul> </li> <li>Performance Insights: enable<ul> <li>Retention period: 7days  (Retention determines the size of the rolling window of data history that Performance Insights stores and makes available)</li> </ul> </li> <li>Monitoring: <ul> <li>Enable Enhanced monitoring</li> <li>Granularity: 60s</li> <li>Monitoring Role: default<ul> <li>Clicking \"Create database\" will authorize RDS to create the IAM role rds-monitoring-role</li> </ul> </li> </ul> </li> <li>Log exports: (publish to Amazon CloudWatch Logs)<ul> <li>Audit log</li> <li>Error log</li> <li>Slow query log</li> </ul> </li> <li>Maintenance:<ul> <li>Maintenance window: No preference (Select the period you want pending modifications or maintenance applied to the database by Amazon RDS.)</li> </ul> </li> <li>Deletion protection:<ul> <li>Enable deletion protection</li> </ul> </li> </ul> </li> </ul> <p>Click Create database</p>"},{"location":"aurora/3Aurora_operation/#1-3-check-amazon-aurora-cluster","title":"1-3 Check AMAZON AURORA Cluster","text":"<ul> <li>Back to console, chose Databases: jamauroracluster, you will find two db instances is creating, after couple minutes, the master instance \"jamauroracluster-instance-1\"  will be changed to \"available\",  then the replica instance will changed to \"available\"</li> </ul> <p>Click cluster identifier: jamauroracluster, you will see the cluster configuration and settings</p> <ul> <li>Check connectivity &amp; security, you will see the cluster endpoint, one for writer endpoint and another one for reader endpoint</li> </ul> <p></p> <ul> <li>Check monitoring, you will see the Cloudwatch monitor the cluster and show stats of metrics for all instances</li> </ul> <p></p> <ul> <li> <p>check Detail, which include instance settings, Networking &amp; secruity, Instance class, Availability, Auto scaling policies &amp; Auto scaling activities, Maintenance, Backup, Backtrack, Snapshots, events, and Logs</p> </li> <li> <p>Cluster configuration: jamauroracluster</p> </li> </ul> <p></p> <ul> <li>Instance(Writer) configuration: <code>jamauroracluster-instance-1</code></li> </ul> <p></p>"},{"location":"aurora/3Aurora_operation/#1-4-use-mysql-workbench-connect-amazon-aurora-cluster","title":"1-4 Use Mysql workbench connect amazon AURORA Cluster","text":"<p>Since we already get cluster writer endpoint and the writer instance Public accessibility already set Yes , we can connect aurora cluster with Mysql workbench</p> <p></p> <pre><code>SHOW VARIABLES LIKE \"%version%\";\n+-------------------------+------------------------------+\n| Variable_name           | Value                        |\n+-------------------------+------------------------------+\n| innodb_version          | 5.7.30                       |\n| protocol_version        | 10                           |\n| slave_type_conversions  |                              |\n| tls_version             | TLSv1,TLSv1.1,TLSv1.2        |\n| version                 | 5.7.30-log                   |\n| version_comment         | MySQL Community Server (GPL) |\n| version_compile_machine | x86_64                       |\n| version_compile_os      | Linux                        |\n+-------------------------+------------------------------+\n8 rows in set (0.00 sec)\n\nshow databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| dbtest             |\n| mysql              |\n| performance_schema |\n| sys                |\n+--------------------+\n5 rows in set (0.68 sec)\n\nuse dbtest;\nReading table information for completion of table and column names\nYou can turn off this feature to get a quicker startup with -A\n\nDatabase changed\n\n\ncreate table ct_test(name text,age int);\ninsert into ct_test values ('cubetree','10');\ninsert into ct_test values ('David','40');\n\nmysql&gt; select * from ct_test;\n+----------+------+\n| name     | age  |\n+----------+------+\n| cubetree |   10 |\n| David    |   40 |\n+----------+------+\n2 rows in set (0.21 sec)\n</code></pre>"},{"location":"aurora/3Aurora_operation/#2-scalability-and-high-availability","title":"2 Scalability and High Availability","text":""},{"location":"aurora/3Aurora_operation/#2-1-verticalinstance-scaling","title":"2-1 Vertical(Instance) Scaling","text":"<p>You can scale your Aurora DB cluster as needed by modifying the DB instance class for each DB instance in the DB cluster. </p> <p>Aurora supports several DB instance classes optimized for Aurora, depending on database engine compatibility.</p> <p>You can scale your Aurora MySQL DB cluster by modifying the DB instance class for each DB instance in the DB cluster. Aurora MySQL supports several DB instance classes optimized for Aurora. Don't use db.t2 or db.t3 instance classes for larger Aurora clusters of size greater than 40 TB.</p> <p>In the following table, you can find details about supported Amazon Aurora DB instance classes for the Aurora DB engines compatible with MySQL.</p> <p></p> <p>The maximum number of connections allowed to an Aurora MySQL DB instance is determined by the <code>max_connections</code> parameter in the instance-level parameter group for the DB instance.</p> <p>If you create a new parameter group to customize your own default for the connection limit, you'll see that the default connection limit is derived using a formula based on the DBInstanceClassMemory value</p> <pre><code>GREATEST({log(DBInstanceClassMemory/805306368)*45},{log(DBInstanceClassMemory/8187281408)*1000})\n</code></pre> <p>As shown in the preceding table, the formula produces connection limits that increase by 1000 as the memory doubles between progressively larger R3, R4, and R5 instances, and by 45 for different memory sizes of T2 and T3 instances.</p> <p>You can increase the maximum number of connections to your Aurora MySQL DB instance by scaling the instance up to a DB instance class with more memory, or by setting a larger value for the <code>max_connections</code> parameter in the DB parameter group for your instance, up to 16,000.</p> <p>1.You can modify the aurora instance type direclty, but the modification will restart db instance, which will cause the suspend for service</p> <p></p> <p>2.Chose your correct and suitable instance type</p> <p></p> <p>3.Scheduling of modifications, will cause the pending</p> <p>Attentions: In productuon environment, recommend add a new read replica, then switch the new read plica, then do the modifcation and delete the old replica, which can help reduce the pending session</p> <p></p>"},{"location":"aurora/3Aurora_operation/#2-2-horizontal-scaling-read-scaling","title":"2-2 Horizontal scaling (Read scaling)","text":"<p>You can achieve read scaling for your Aurora DB cluster by creating up to 15 Aurora Replicas in a DB cluster that uses single-master replication. Each Aurora Replica returns the same data from the cluster volume with minimal replica lag\u2014usually considerably less than 100 milliseconds after the primary instance has written an update. As your read traffic increases, you can create additional Aurora Replicas and connect to them directly to distribute the read load for your DB cluster. </p> <p>Aurora Replicas don't have to be of the same DB instance class as the primary instance..</p> <p>1.Add reader replica (add reader or add Create cross region read replica)</p> <p></p> <p>2.Chose DB instance class and different region for read replica</p> <p>We recommend that you distribute the primary instance and Aurora Replicas in your DB cluster over multiple Availability Zones to improve the availability of your DB cluster. </p> <ul> <li>db.r5.large (Can be different from primary db)</li> <li>DB instance identifier:  (Must be unique) <ul> <li>Exp: <code>jamauroracluster-instance-1-eu-west-1b</code></li> <li>Not publicly accessible</li> </ul> </li> <li>Availability Zone: eu-west-1b</li> </ul> <p></p> <p></p> <ul> <li>Enable Enhanced monitoring: enabled</li> </ul> <p>3.Failover tier priority selection</p> <p>Choose a failover priority for the instance. If you don't select a value, the default is tier-1. This priority determines the order in which Aurora Replicas are promoted when recovering from a primary instance failure. </p> <p></p> <p>4.Create Read replciation(Need wait for like almost 5 minutes to be Available)</p> <p></p> <p>Read Replica SQL Test</p> <pre><code>mysql -h read-endpoint -u admin -p\n\nmysql&gt; use dbtest;\nReading table information for completion of table and column names\nYou can turn off this feature to get a quicker startup with -A\n\nDatabase changed\nmysql&gt; insert into ct_test values ('kim','30');\nERROR 1290 (HY000): The MySQL server is running with the --read-only option so it cannot execute this statement\n</code></pre>"},{"location":"aurora/3Aurora_operation/#2-3-failover","title":"2-3 failover","text":"<p>1.check cluster status and instance status</p> <p></p> <p></p> <p>2.Chose primary instance to failover (approximately 30s to finish the failover)</p> <p></p> <p>3.Check the failover status</p> <p></p>"},{"location":"aurora/3Aurora_operation/#2-4-cloning-an-aurora-db-cluster","title":"2-4 Cloning an Aurora DB cluster","text":"<p>https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Managing.Clone.html</p> <p>Aurora cloning uses a copy-on-write protocol. With this mechanism, a clone requires only minimal additional space when first created. </p> <p>In the beginning, Aurora maintains a single copy of the data, which is used by both the original and new DB clusters. Aurora allocates new storage only when data changes, either on the source cluster or the cloned cluster. You can make multiple clones from the same DB cluster.</p> <p>Limitations of Aurora cloning</p> <ul> <li>You cannot create clones across AWS Regions. Each clone must be created in the same Region as the source cluster.</li> <li>Currently, you are limited to 15 clones based on a copy, including clones based on other clones. After that, only copies can be created. However, each copy can also have up to 15 clones.</li> <li>Currently, you cannot clone from a cluster without the parallel query feature, to a cluster where parallel query is enabled. To bring data into a cluster that uses parallel query, create a snapshot of the original cluster and restore it to a cluster where the parallel query option is enabled.</li> <li>You can't create clones from clusters that have no DB instances. Cloning works only for clusters that have at least one database instance.</li> <li>You can provide a different virtual private cloud (VPC) for your clone. However, the subnets in those VPCs must map to the same set of Availability Zones.</li> </ul> <p>1.Creating an Aurora clone</p> <p></p> <p>2.Chose DB instance size and DB instance identifier(unique)</p> <ul> <li>jamauroracluster-clone1</li> <li>DB instance</li> <li>Can also enable backtrack for Clone DB</li> </ul> <p></p> <p></p> <p>3.check aurora  clone cluster status(Ready after 5 minustes)</p> <p></p>"},{"location":"aurora/3Aurora_operation/#2-5-backtracking-an-aurora-db-cluster","title":"2-5 Backtracking an Aurora DB cluster","text":"<p>With Amazon Aurora with MySQL compatibility, you can backtrack a DB cluster to a specific time, without restoring data from a backup.</p> <p>Backtracking \"rewinds\" the DB cluster to the time you specify. Backtracking is not a replacement for backing up your DB cluster so that you can restore it to a point in time. However, backtracking provides the following advantages over traditional backup and restore:</p> <ul> <li>You can easily undo mistakes. If you mistakenly perform a destructive action, such as a <code>DELETE</code> without a <code>WHERE</code> clause, you can backtrack the DB cluster to a time before the destructive action with minimal interruption of service.</li> <li>You can backtrack a DB cluster quickly. Restoring a DB cluster to a point in time launches a new DB cluster and restores it from backup data or a DB cluster snapshot, which can take hours. Backtracking a DB cluster doesn't require a new DB cluster and rewinds the DB cluster in minutes.</li> <li>You can explore earlier data changes. You can repeatedly backtrack a DB cluster back and forth in time to help determine when a particular data change occurred. For example, you can backtrack a DB cluster three hours and then backtrack forward in time one hour. In this case, the backtrack time is two hours before the original time.</li> </ul> <p>1. Configuring backtracking</p> <p>To use the Backtrack feature, you must enable backtracking and specify a target backtrack window. Otherwise, backtracking is disabled.</p> <p></p> <p>2.  Specify a Target</p> <p></p> <p>3. Check backtrack status</p> <p></p> <p></p>"},{"location":"aurora/3Aurora_operation/#3-backup-and-restoration","title":"3 Backup and Restoration","text":""},{"location":"aurora/3Aurora_operation/#3-1-backup","title":"3-1 Backup","text":"<p>Aurora backs up your cluster volume automatically and retains restore data for the length of the backup retention period. </p> <p>Aurora backups are continuous and incremental so you can quickly restore to any point within the backup retention period. No performance impact or interruption of database service occurs as backup data is being written. </p> <p>You can specify a backup retention period, from 1 to 35 days, when you create or modify a DB cluster. Aurora backups are stored in Amazon S3.</p> <p>If you want to retain a backup beyond the backup retention period, you can also take a snapshot of the data in your cluster volume. </p> <p>Because Aurora retains incremental restore data for the entire backup retention period, you only need to create a snapshot for data that you want to retain beyond the backup retention period. You can create a new DB cluster from the snapshot.</p> <p>You can recover your data by creating a new Aurora DB cluster from the backup data that Aurora retains, or from a DB cluster snapshot that you have saved. You can quickly restore a new copy of a DB cluster created from backup data to any point in time during your backup retention period. The continuous and incremental nature of Aurora backups during the backup retention period means you don't need to take frequent snapshots of your data to improve restore times.</p>"},{"location":"aurora/3Aurora_operation/#3-2-restoring-data","title":"3-2 Restoring data","text":"<p>To determine the latest or earliest restorable time for a DB instance, look for the <code>Latest Restorable Time</code> or <code>Earliest Restorable Time</code> values on the RDS console.</p> <ul> <li>The latest restorable time for a DB cluster is the most recent point at which you can restore your DB cluster, typically within 5 minutes of the current time.</li> <li>The earliest restorable time specifies how far back within the backup retention period that you can restore your cluster volume.</li> </ul> <p>You can determine when the restore of a DB cluster is complete by checking the <code>Latest Restorable Time</code>and<code>Earliest Restorable Time</code> values. </p> <p>The <code>Latest Restorable Time</code> and <code>Earliest Restorable Time</code> values return NULL until the restore operation is complete. You can't request a backup or restore operation if <code>Latest Restorable Time</code> or <code>Earliest Restorable Time</code> returns <code>NULL</code>.</p> <p>1.Restoring a DB cluster to a specified time</p> <p></p> <ul> <li><code>jamauroracluster-restoredb</code></li> <li>Latest restorable time</li> <li>Availability Zone: <code>eu-west-1a</code></li> </ul> <p></p> <p></p> <p>2.Launch DB instance</p> <p>A new cluster will be created in with <code>DB cluster identifier-cluster</code>, exp, <code>jamauroracluster-restoredb-cluster</code></p> <p></p>"},{"location":"aurora/3Aurora_operation/#3-3-creating-a-db-cluster-snapshot","title":"3-3 Creating a DB cluster snapshot","text":"<p>Amazon RDS creates a storage volume snapshot of your DB cluster, backing up the entire DB cluster and not just individual databases. When you create a DB cluster snapshot, you need to identify which DB cluster you are going to back up, and then give your DB cluster snapshot a name so you can restore from it later. </p> <p>The amount of time it takes to create a DB cluster snapshot varies with the size your databases. Since the snapshot includes the entire storage volume, the size of files, such as temporary files, also affects the amount of time it takes to create the snapshot.</p> <p>Unlike automated backups, manual snapshots aren't subject to the backup retention period. Snapshots don't expire.</p> <p>For very long-term backups, we recommend exporting snapshot data to Amazon S3. If the major version of your DB engine is no longer supported, you can't restore to that version from a snapshot</p> <p>1. Create snapshot</p> <ul> <li>In the list of DB instances, choose a writer instance for the DB cluster.</li> <li>Choose Actions, and then choose Take snapshot.</li> </ul> <p></p> <p></p>"},{"location":"aurora/3Aurora_operation/#3-4-restoring-from-a-db-cluster-snapshot","title":"3-4 Restoring from a DB cluster snapshot","text":"<p>Amazon RDS creates a storage volume snapshot of your DB cluster, backing up the entire DB instance and not just individual databases. You can create a DB cluster by restoring from this DB cluster snapshot. </p> <p>When you restore the DB cluster, you provide the name of the DB cluster snapshot to restore from, and then provide a name for the new DB cluster that is created from the restore. </p> <p>You can't restore from a DB cluster snapshot to an existing DB cluster; a new DB cluster is created when you restore.</p> <p></p> <p>Parameter group considerations</p> <p>We recommend that you retain the parameter group for any DB cluster snapshots you create, so that you can associate your restored DB cluster with the correct parameter group. You can specify the parameter group when you restore the DB cluster.</p> <p>Security group considerations</p> <p>When you restore a DB cluster, the default security group is associated with the restored cluster by default.</p>"},{"location":"aurora/3Aurora_operation/#4monitoring-on-aurora-db-cluster","title":"4\u3001Monitoring on Aurora DB Cluster","text":"<p>Handbook for Database monitoring, alarm and log collection on AWS RDS</p>"},{"location":"aurora/3Aurora_operation/#4-1-amazon-cloudwatch-metrics","title":"4-1 Amazon CloudWatch Metrics","text":"<p>To monitor the health and performance of your Aurora DB cluster, you can view some, but not all, of the metrics provided by Amazon Aurora in the Amazon RDS console.</p> <p>Cloudwatch \u2013 Shows a summary of CloudWatch metrics. Each metric includes a graph showing the metric monitored over a specific time span</p> <p>https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Monitoring.html</p> <ul> <li>Cluster-level metrics for Amazon Aurora</li> <li>Instance-level metrics for Amazon Aurora</li> </ul> <p></p> <p></p> <p></p> <p></p>"},{"location":"aurora/3Aurora_operation/#4-2-enhanced-monitoring","title":"4-2 Enhanced Monitoring","text":"<p>Amazon RDS provides metrics in real time for the operating system (OS) that your DB instance runs on. You can view the metrics for your DB instance using the console. </p> <p>Also, you can consume the Enhanced Monitoring JSON output from Amazon CloudWatch Logs in a monitoring system of your choice.</p> <p>By default, Enhanced Monitoring metrics are stored for 30 days in the CloudWatch Logs, which are different from typical CloudWatch metrics. To modify the amount of time the metrics are stored in the CloudWatch Logs, change the retention for the <code>RDSOSMetrics</code> log group in the CloudWatch console. </p> <ol> <li>Enable or disable Enhanced Monitoring </li> <li>Set the Monitoring Role property to the IAM role that you created to permit Amazon RDS to communicate with Amazon CloudWatch Logs for you, or choose Default to have RDS create a role for you named <code>rds-monitoring-role</code></li> <li>Set the Granularity property to the interval, in seconds, between points when metrics are collected for your DB instance or read replica. The Granularity property can be set to one of the following values: 1, 5, 10, 15, 30, or 60.</li> </ol> <p></p> <p>Viewing Enhanced Monitoring</p> <p>You can view OS metrics reported by Enhanced Monitoring in the RDS console by choosing Enhanced monitoring for Monitoring.</p> <p></p> <p></p> <p></p> <p>View OS process Monitoring</p> <p></p> <ul> <li>RDS child processes \u2013 Shows a summary of the RDS processes that support the DB instance, for example aurora for Amazon Aurora DB clusters.</li> <li>RDS processes \u2013 Shows a summary of the resources used by the RDS management agent, diagnostics monitoring processes, and other AWS processes that are required to support RDS DB instances.</li> <li>OS processes \u2013 Shows a summary of the kernel and system processes, which generally have minimal impact on performance.</li> </ul>"},{"location":"aurora/3Aurora_operation/#4-3-enhanced-monitoring","title":"4-3 Enhanced Monitoring","text":"<p>Performance Insights expands on existing Amazon RDS monitoring features to illustrate your database's performance and help you analyze any issues that affect it. With the Performance Insights dashboard, you can visualize the database load and filter the load by waits, SQL statements, hosts, or users.</p> <p>https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/USER_PerfInsights.Overview.html</p> <p>DB load</p> <p>The central metric for Performance Insights is <code>DB Load</code>. The <code>DB Load</code> metric is collected every second.</p> <ul> <li>Active Sessions</li> <li>Dimensions</li> <li>Wait events</li> <li>Top SQL</li> </ul> <p>Performance Insights is an advanced database performance monitoring feature that makes it easy to diagnose and solve performance challenges on Amazon RDS databases. It offers a free tier with 7 days of rolling data retention, and a paid long-term data retention option.</p> <p>1. Enabling and disabling Performance Insights</p> <p></p> <p>2. Enabling and disabling Performance Insights</p> <p></p>"},{"location":"aurora/3Aurora_operation/#5managing-an-amazon-aurora-db-cluster","title":"5\u3001Managing an Amazon Aurora DB cluster","text":""},{"location":"aurora/3Aurora_operation/#5-1-working-with-db-parameter-groups-and-db-cluster-parameter-groups","title":"5-1 Working with DB parameter groups and DB cluster parameter groups","text":"<ul> <li>https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/USER_WorkingWithParamGroups.html</li> <li>The RDS MySql DB Parameters need to be optimized for JAM702</li> </ul> <p>A DB parameter group</p> <p>A DB parameter group acts as a container for engine configuration values that are applied to one or more DB instances. DB parameter groups apply to DB instances in both Amazon RDS and Aurora. These configuration settings apply to properties that can vary among the DB instances within an Aurora cluster, such as the sizes for memory buffers.</p> <p>A DB cluster parameter group</p> <p>A DB cluster parameter group acts as a container for engine configuration values that are applied to every DB instance in an Aurora DB cluster. For example, the Aurora shared storage model requires that every DB instance in an Aurora cluster use the same setting for parameters such as <code>innodb_file_per_table</code>. </p> <p>Thus, parameters that affect the physical storage layout are part of the cluster parameter group. The DB cluster parameter group also includes default values for all the instance-level parameters</p> <p></p> <p>Create A DB parameter group</p> <ul> <li><code>jamaurora-db-pg</code></li> <li>Description: Test parameter group for jamaurora db</li> </ul> <p></p> <p>Create A DB cluster parameter group</p> <ul> <li><code>jamaurora-cluster-pg</code></li> <li>Description: Test parameter group for jamaurora cluster</li> </ul> <p></p>"},{"location":"aurora/3Aurora_operation/#5-2-using-aurora-auto-scaling-with-aurora-replicas","title":"5-2 Using Aurora Auto Scaling with Aurora replicas","text":"<p>To meet your connectivity and workload requirements, Aurora Auto Scaling dynamically adjusts the number of Aurora Replicas provisioned for an Aurora DB cluster using single-master replication. Aurora Auto Scaling is available for both Aurora MySQL and Aurora PostgreSQL. </p> <p>Aurora Auto Scaling enables your Aurora DB cluster to handle sudden increases in connectivity or workload. When the connectivity or workload decreases, Aurora Auto Scaling removes unnecessary Aurora Replicas so that you don't pay for unused provisioned DB instances.</p> <p>You define and apply a scaling policy to an Aurora DB cluster. The scaling policy defines the minimum and maximum number of Aurora Replicas that Aurora Auto Scaling can manage. </p> <p>Based on the policy, Aurora Auto Scaling adjusts the number of Aurora Replicas up or down in response to actual workloads, determined by using Amazon CloudWatch metrics and target values.</p> <p>Aurora Auto Scaling policies</p> <p>Aurora Auto Scaling uses a scaling policy to adjust the number of Aurora Replicas in an Aurora DB cluster. Aurora Auto Scaling has the following components:</p> <ul> <li>A service-linked role</li> <li>A target metric</li> <li>Minimum and maximum capacity</li> <li>A cooldown period</li> </ul> <p>Adding a scaling policy</p> <ul> <li>Average CPU utilization of Aurora Replicas to create a policy based on the average CPU utilization.</li> <li>Average connections of Aurora Replicas to create a policy based on the average number of connections to Aurora Replicas.</li> </ul> <p></p> <p>Policy details</p> <p></p> <p>Add Cluster capacity details</p> <p></p> <p></p>"},{"location":"aurora/3Aurora_operation/#5-3-rebooting-a-db-instance-in-a-db-cluster","title":"5-3 Rebooting a DB instance in a DB cluster","text":"<p>The time required to reboot your DB instance depends on the crash recovery process, database activity at the time of reboot, and the behavior of your specific DB engine. </p> <p>To improve the reboot time, we recommend that you reduce database activity as much as possible during the reboot process. Reducing database activity reduces rollback activity for in-transit transactions.</p> <p>Chose instance to reboot </p> <p></p> <p>reboot the instance</p> <p></p>"},{"location":"aurora/3Aurora_operation/#5-4-stopping-db-cluster","title":"5-4 Stopping DB cluster","text":"<p>While your DB cluster is stopped, you are charged only for cluster storage, manual snapshots, and automated backup storage within your specified retention window. You aren't charged for any DB instance hours. Aurora automatically starts your DB cluster after <code>seven days</code> so that it doesn't fall behind any required maintenance updates.</p> <p>To minimize charges for a lightly loaded Aurora cluster, you can stop the cluster instead of deleting all of its Aurora Replicas.</p>"},{"location":"aurora/3Aurora_operation/#5-5-starting-db-cluster","title":"5-5 Starting DB cluster","text":"<p>You always start an Aurora DB cluster beginning with an Aurora cluster that is already in the stopped state. </p> <p>When you start the cluster, all its DB instances become available again. The cluster keeps its configuration settings such as endpoints, parameter groups, and VPC security groups.</p>"},{"location":"aws/1aws_neptune/","title":"L1 \u6df1\u5165\u4e86\u89e3 Amazon Neptune \u56fe\u6570\u636e\u5e93\u6280\u672f","text":"<ul> <li>\u56fe\u6570\u636e\u5e93\u6982\u5ff5\u3001\u5e94\u7528\u573a\u666f\u53ca\u6570\u636e\u5efa\u6a21</li> <li>Amazon Neptune \u6280\u672f\u6982\u89c8</li> <li>Amazon Neptune \u90e8\u7f72\u67b6\u6784\u53ca\u6700\u4f73\u5b9e\u8df5</li> <li>Amazon Neptune Demo \u6f14\u793a\u53ca\u53c2\u8003\u8d44\u6e90</li> </ul>"},{"location":"aws/1aws_neptune/#1","title":"1 \u56fe\u6570\u636e\u5e93\u6982\u5ff5\u3001\u5e94\u7528\u573a\u666f\u53ca\u6570\u636e\u5efa\u6a21","text":"<p>\u56fe\u8bba (Graph Theory)</p> <ul> <li>\u67ef\u5c3c\u65af\u5821\u4e03\u6865\u95ee\u9898</li> <li>1736 \u5e74 \u83b1\u6602\u54c8\u5fb7\u00b7\u6b27\u62c9 \u5960\u5b9a\u4e86\u56fe\u8bba\u7684\u57fa\u7840</li> </ul> <p>https://zh.wikipedia.org/wiki/%E5%9B%BE%E8%AE%BA</p> <p></p> <p>\u6570\u636e\u7ed3\u6784:\u56fe(Graph)</p> <p>\u56feG \u7531\u4e24\u4e2a\u96c6\u5408\u6784\u6210\uff0c\u8bb0\u4f5c <code>G=&lt;V,E&gt;</code> \u5176\u4e2d <code>V</code> \u662f\u9876\u70b9\u7684\u975e\u7a7a\u6709\u9650\u96c6\u5408\uff0c<code>E</code> \u662f\u8fb9\u7684\u6709\u9650\u96c6\u5408\uff0c\u5176\u4e2d\u8fb9\u662f\u9876\u70b9 \u7684 \u65e0\u5e8f\u5bf9 \u6216 \u6709\u5e8f\u5bf9 \u96c6\u5408\u3002</p> <pre><code>G1=&lt;V,E&gt;\nV = { v0 ,v1,v2,v3,v4 }\nE = { (v0,v1),(v0,v3),(v1,v2),(v1,v4),(v2,v3)(v2,v4) }\n</code></pre> <p>\u56fe\u7684\u5b58\u50a8</p> <ul> <li>\u56fe\u7684\u6570\u7ec4(\u90bb\u63a5\u77e9\u9635)</li> <li>\u56fe\u7684\u90bb\u63a5\u8868</li> <li>\u6709\u5411\u56fe\u7684\u5341\u5b57\u94fe\u8868\u5b58\u50a8\u8868\u793a</li> <li>\u65e0\u5411\u56fe\u7684\u90bb\u63a5\u591a\u91cd\u8868\u5b58\u50a8\u8868\u793a</li> </ul> <p>\u56fe\u7684\u904d\u5386</p> <ul> <li>\u6df1\u5ea6\u4f18\u5148\u904d\u5386(DFS) </li> <li>\u5e7f\u5ea6\u4f18\u5148\u904d\u5386(BFS)</li> </ul> <pre><code>\u65e0\u5e8f\u5bf9(vi,vj):\n\u7528\u8fde\u63a5\u9876\u70b9vi\u3001vj\u7684\u7ebf\u6bb5 \u8868\u793a\uff0c\u79f0\u4e3a\u65e0\u5411\u8fb9\n</code></pre> <p></p>"},{"location":"aws/1aws_neptune/#_1","title":"\u4ec0\u4e48\u662f\u56fe\u6570\u636e\u5e93?","text":"<p>\u56fe\u6570\u636e\u5e93(<code>Graph Database</code>) \u5e76\u975e\u6307\u5b58\u50a8\u56fe\u7247 \u7684\u6570\u636e\u5e93\uff0c\u800c\u662f\u652f\u6301\u4ee5 \u56fe\u6570\u636e\u7ed3\u6784 \u5b58\u50a8\u548c\u67e5\u8be2\u6570\u636e\u7684\u6570\u636e\u5e93\u3002</p> <p>\u56fe\u6570\u636e\u5e93\u662f\u4e00\u79cd\u5728\u7ebf\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff0c\u5177\u6709\u5904\u7406\u56fe\u6570\u636e\u6a21\u578b\u7684\u521b\u5efa\u3001\u8bfb\u53d6\u3001\u66f4\u65b0\u548c\u5220\u9664(CRUD)\u64cd\u4f5c\u3002</p> <p></p> <p>\u56fe\u5b58\u50a8</p> <p>\u4e00\u4e9b\u56fe\u6570\u636e\u5e93\u4f7f\u7528 \u539f\u751f\u56fe\u5b58\u50a8\uff0c\u8fd9\u7c7b\u5b58\u50a8\u662f\u7ecf\u8fc7\u4f18\u5316\u7684\uff0c\u5e76\u4e14\u662f\u4e13\u95e8\u4e3a\u4e86\u5b58\u50a8\u548c\u7ba1\u7406\u56fe\u800c\u8bbe\u8ba1\u7684\u3002\u5e76\u4e0d\u662f\u6240\u6709\u56fe\u6570\u636e\u5e93\u90fd\u662f\u4f7f \u7528\u539f\u751f\u56fe\u5b58\u50a8\uff0c\u4e5f\u6709\u4e00\u4e9b\u56fe\u6570\u636e\u5e93\u5c06\u56fe\u6570\u636e\u5e8f\u5217\u5316\uff0c\u7136\u540e\u4fdd\u5b58\u5230\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6216\u8005\u9762\u5411\u5bf9\u8c61\u6570\u636e\u5e93\uff0c\u6216\u5176\u4ed6\u901a\u7528\u6570\u636e\u5b58\u50a8\u4e2d\u3002</p> <p>\u56fe\u5904\u7406\u5f15\u64ce</p> <p>\u539f\u751f\u56fe\u5904\u7406(\u4e5f\u79f0\u4e3a \u65e0\u7d22\u5f15\u90bb\u63a5)\u662f\u5904\u7406\u56fe\u6570\u636e\u7684\u6700\u6709\u6548\u65b9\u6cd5\uff0c\u56e0\u4e3a\u8fde\u63a5\u7684\u8282\u70b9\u5728\u6570\u636e\u5e93\u4e2d\u7269\u7406\u5730\u6307\u5411\u5f7c\u6b64\u3002\u975e\u539f\u751f\u56fe\u5904\u7406\u4f7f \u7528\u5176\u4ed6\u65b9\u6cd5\u6765\u5904\u7406 CRUD \u64cd\u4f5c\u3002</p>"},{"location":"aws/1aws_neptune/#_2","title":"\u9ad8\u5ea6\u5173\u8054\u7684\u6570\u636e","text":""},{"location":"aws/1aws_neptune/#_3","title":"\u9ad8\u5ea6\u5173\u8054\u6570\u636e\u7684\u5e94\u7528\u573a\u666f","text":"<ul> <li>\u793e\u4ea4\u7f51\u7edc</li> <li>\u63a8\u8350\u7cfb\u7edf </li> <li>\u77e5\u8bc6\u56fe\u8c31</li> <li>\u6b3a\u8bc8\u68c0\u6d4b </li> <li>\u751f\u547d\u79d1\u5b66 </li> <li>\u7f51\u7edc\u8fd0\u7ef4</li> </ul>"},{"location":"aws/1aws_neptune/#knowledge-graph","title":"\u77e5\u8bc6\u56fe\u8c31(Knowledge Graph)\u7684\u5e94\u7528","text":"<ul> <li>\u8499\u5a1c\u4e3d\u838e\u7684\u4f5c\u8005\u662f?</li> <li>Alice \u5728\u5df4\u9ece\u5e94\u8be5\u53c2\u89c2\u54ea\u4e2a\u535a\u7269\u9986?</li> <li>\u5362\u6d6e\u5bab\u4fdd\u5b58\u7740\u54ea\u4e9b\u827a\u672f\u5bb6\u7684\u4f5c\u54c1?</li> </ul>"},{"location":"aws/1aws_neptune/#_4","title":"\u56fe\u6570\u636e\u5e93\u7684\u5e94\u7528\u9886\u57df","text":"<p>\u968f\u7740\u793e\u4ea4\u3001\u7535\u5546\u3001\u91d1\u878d\u3001\u96f6\u552e\u3001\u7269\u8054\u7f51\u7b49\u884c\u4e1a\u7684\u5feb\u901f\u53d1\u5c55\uff0c\u73b0\u5b9e\u793e\u4f1a\u7ec7\u8d77\u4e86\u4e86\u4e00\u5f20\u5e9e\u5927\u800c\u590d\u6742\u7684\u5173\u7cfb\u7f51\uff0c\u4f20\u7edf\u6570\u636e\u5e93\u5f88\u96be\u5904\u7406\u5173 \u7cfb\u8fd0\u7b97\u3002\u5927\u6570\u636e\u884c\u4e1a\u9700\u8981\u5904\u7406\u7684\u6570\u636e\u4e4b\u95f4\u7684\u5173\u7cfb\u968f\u6570\u636e\u91cf\u5448\u51e0\u4f55\u7ea7\u6570\u589e\u957f\uff0c\u4e9f\u9700\u4e00\u79cd\u652f\u6301\u6d77\u91cf\u590d\u6742\u6570\u636e\u5173\u7cfb\u8fd0\u7b97\u7684\u6570\u636e\u5e93\uff0c \u56fe\u6570 \u636e\u5e93\u5e94\u8fd0\u800c\u751f\u3002</p> <ul> <li>\u793e\u4ea4\u9886\u57df:<ul> <li>Facebook, Twitter\uff0cLinkedin \u7528\u5b83\u6765\u7ba1\u7406\u793e\u4ea4\u5173\u7cfb\uff0c\u5b9e\u73b0\u597d\u53cb\u63a8\u8350</li> </ul> </li> <li>\u96f6\u552e\u9886\u57df: <ul> <li>eBay\uff0c\u6c83\u5c14\u739b\u4f7f\u7528\u5b83\u5b9e\u73b0\u5546\u54c1\u5b9e\u65f6\u63a8\u8350\uff0c\u7ed9\u4e70\u5bb6\u66f4\u597d\u7684\u8d2d\u7269\u4f53\u9a8c</li> </ul> </li> <li>\u91d1\u878d\u9886\u57df: <ul> <li>\u6469\u6839\u5927\u901a\uff0c\u82b1\u65d7\u548c\u745e\u94f6\u7b49\u94f6\u884c\u5728\u7528\u56fe\u6570\u636e\u5e93\u505a\u98ce\u63a7\u5904\u7406</li> </ul> </li> <li>\u6c7d\u8f66\u5236\u9020\u9886\u57df: <ul> <li>\u6c83\u5c14\u6c83\uff0c\u6234\u59c6\u52d2\u548c\u4e30\u7530\u7b49\u9876\u7ea7\u6c7d\u8f66\u5236\u9020\u5546\u4f9d\u9760\u56fe\u6570\u636e\u5e93\u63a8\u52a8\u521b\u65b0\u5236\u9020\u89e3\u51b3\u65b9\u6848</li> </ul> </li> <li>\u7535\u4fe1\u9886\u57df:<ul> <li>Verizon, Orange \u548c AT&amp;T \u7b49\u7535\u4fe1\u516c\u53f8\u4f9d\u9760\u56fe\u6570\u636e\u5e93\u6765\u7ba1\u7406\u7f51\u7edc</li> </ul> </li> <li>\u9152\u5e97\u9886\u57df: <ul> <li>\u4e07\u8c6a\u548c\u96c5\u9ad8\u9152\u5e97\u7b49\u9876\u7ea7\u9152\u5e97\u516c\u53f8\u4f9d\u4f7f\u7528\u56fe\u6570\u636e\u5e93\u6765\u7ba1\u7406\u590d\u6742\u4e14\u5feb\u901f\u53d8\u5316\u7684\u5e93\u5b58</li> </ul> </li> </ul>"},{"location":"aws/1aws_neptune/#_5","title":"\u9ad8\u5ea6\u5173\u8054\u6570\u636e\u7684\u4e0d\u540c\u5904\u7406\u65b9\u6cd5","text":"<p>\u57fa\u4e8e\u4e1a\u52a1\u6d41\u7a0b\u6784\u5efa</p> <p></p> <p>\u57fa\u4e8e\u5173\u8054\u5173\u7cfb\u67e5\u8be2\u6784\u5efa</p> <p></p>"},{"location":"aws/1aws_neptune/#_6","title":"\u5173\u7cfb\u578b\u6570\u636e\u5e93\u9762\u4e34\u7684\u6311\u6218 \u2013 \u6784\u5efa\u6570\u636e\u9ad8\u5ea6\u5173\u8054\u7684\u5e94\u7528","text":"<ul> <li>\u5e76\u975e\u9762\u5411\u56fe\u67e5\u8be2\u8bbe\u8ba1</li> <li>\u56fe\u5904\u7406\u6548\u7387\u4f4e\u4e0b </li> <li>\u4fee\u6539 Schema \u4e0d\u591f\u7075\u6d3b</li> </ul>"},{"location":"aws/1aws_neptune/#graph","title":"\u56fe (Graph) \u6a21\u578b\u548c\u6846\u67b6","text":"<p>\u5c5e\u6027\u56fe (Property Graph) \u5f00\u6e90\u7684 Apache TinkerPopTM Gremlin Traversal Language</p> <p></p> <p>\u8d44\u6e90\u63cf\u8ff0\u6846\u67b6 RDF (Resource Description Framework)</p> <p></p>"},{"location":"aws/1aws_neptune/#property-graph","title":"\u5c5e\u6027\u56fe (Property Graph)","text":"<p>\u5c5e\u6027\u56fe\u662f\u9876\u70b9\u3001\u8fb9\u53ca\u4ed6\u4eec\u5c5e\u6027\u6240\u6784\u6210\u7684\u96c6\u5408 </p> <ul> <li>\u9876\u70b9 \u8868\u793a\u5b9e\u4f53/\u57df</li> <li>\u8fb9 \u8868\u793a\u9876\u70b9\u4e4b\u95f4\u65b9\u5411\u6027\u7684\u5173\u7cfb. <ul> <li>\u6bcf\u6761\u8fb9\u6709\u4e00\u4e2a\u5173\u8054\u5173\u7cfb\u7684\u6807\u7b7e </li> </ul> </li> <li>\u6bcf\u4e2a\u9876\u70b9\u548c\u8fb9\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u7b26 </li> <li>\u9876\u70b9\u548c\u8fb9\u53ef\u4ee5\u6709\u5c5e\u6027</li> <li>\u5c5e\u6027\u8868\u793a\u9876\u70b9\u548c\u8fb9\u975e\u5173\u7cfb\u7684\u4fe1\u606f</li> </ul> <p></p>"},{"location":"aws/1aws_neptune/#rdf","title":"\u8d44\u6e90\u63cf\u8ff0\u6846\u67b6 (RDF)","text":"<ul> <li><code>RDF Graphs</code> \u662f\u7531\u4e3b\u4f53\u3001\u8c13\u8bed\u548c\u5ba2\u4f53\u7ec4\u6210\u7684\u4e00\u4e2a\u4e09\u5143\u7ec4\u7684\u96c6\u5408</li> </ul> <pre><code>\u4e3b\u4f53:     &lt;http://www.socialnetwork.com/person#1&gt; \n\u8c13\u8bed:     rdf:type contacts:User;\n\u5ba2\u4f53(\u6587\u5b57):     contact:name: \u201dBill\u201d \n</code></pre> <ul> <li>\u56fd\u9645\u8d44\u6e90\u6807\u8bc6\u7b26(IRI)\u552f\u4e00\u5730\u8bc6\u522b\u4e3b\u4f53</li> </ul> <pre><code>IRI     &lt;http://www.socialnetwork.com/person#1&gt;\n</code></pre> <ul> <li>\u5ba2\u4f53\u53ef\u4ee5\u662f\u4e00\u4e2aIRI \u6216\u8005 \u6587\u5b57.<ul> <li>\u5f53\u4e3a\u6587\u5b57\u65f6\uff0c\u5b83\u76f8\u5f53\u4e8e\u4e00\u4e2a\u5c5e\u6027\u503c\uff0cRDF\u652f\u6301XML\u7684\u6570\u636e\u7c7b\u578b </li> <li>\u5f53\u4e3a\u4e00\u4e2aIRI\u65f6\uff0c\u5b83\u8868\u793a\u56fe\u5f53\u4e2d\u7684\u4e00\u6761\u8fb9</li> </ul> </li> </ul> <pre><code>\u4e3b\u4f53  &lt;http://www.socialnetwork.com/person#1&gt;\n\u8c13\u8bed  contacts:friend\n\u5ba2\u4f53(IRI) &lt;http://www.socialnetwork.com/person#2&gt; .\n</code></pre>"},{"location":"aws/1aws_neptune/#vs","title":"\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6a21\u578b vs \u56fe\u6a21\u578b","text":""},{"location":"aws/1aws_neptune/#sql","title":"SQL \u5173\u7cfb\u578b\u6570\u636e\u5e93\u67e5\u8be2","text":"<ul> <li>\u627e\u5230\u8d2d\u4e70Echo\u7684\u516c\u53f8\u540d\u79f0</li> </ul> <pre><code>SELECT distinct c.CompanyName \nFROM customers AS c\n    JOIN orders AS o ON                     /* Join the customer from the order */ \n        (c.CustomerID = o.CustomerID)\n    JOIN order_details AS od                /* Join the order details from the order */ \n        ON (o.OrderID = od.OrderID)\n    JOIN products as p                      /* Join the products from the order details */\n     ON (od.ProductID = p.ProductID)\n    WHERE p.ProductName = \u2019Echo';   /* Find the product named \u2018Echo\u2019 */\n</code></pre>"},{"location":"aws/1aws_neptune/#gremlin","title":"Gremlin \u904d\u5386\u67e5\u8be2","text":"<pre><code>/* All products named \u201dEcho\u201d */\ng.V().hasLabel(\u2018Product\u2019).has('name',\u2019Echo')\n    .in(\u2019HAS_PRODUCT')  /* Traverse to order details */ \n    .in(\u2018HAS_DETAILS\u2019)  /* Traverse to order */ \n    .in(\u2019HAS_ORDER\u2019)    /* Traverse to Customer */ \n    .values(\u2019CompanyName\u2019).dedup()  /* Unique Company Name */\n</code></pre>"},{"location":"aws/1aws_neptune/#rdf-sparql","title":"RDF SPARQL \u67e5\u8be2","text":"<pre><code>PREFIX sales_db: &lt;http://sales.widget.com/&gt; \nSELECT distinct ?comp_name WHERE {\n    ?customer sales_db:HAS_ORDER ?order ;       #customer graph pattern \n        sales_db:CompanyName ?comp_name .\n    ?order sales_db:HAS_DETAILS?order_d.          #ordersgraphpattern\n    ?order_d sales_db:HAS_PRODUCT ?product .   #order details graph pattern \n    ?product sales_db:ProductName \u201cEcho\u201d .       #products graph pattern\n}\n</code></pre>"},{"location":"aws/1aws_neptune/#2-amazon-neptune","title":"2 Amazon Neptune \u6280\u672f\u6982\u89c8","text":""},{"location":"aws/1aws_neptune/#aws","title":"AWS \u6570\u636e\u5e93\u6258\u7ba1\u670d\u52a1","text":""},{"location":"aws/1aws_neptune/#_7","title":"\u73b0\u6709\u56fe\u6570\u636e\u5e93\u7684\u95ee\u9898","text":"<ul> <li>\u96be\u4ee5\u6269\u5c55 </li> <li>\u96be\u4ee5\u4fdd\u8bc1\u9ad8\u53ef\u7528 </li> <li>\u4ef7\u683c\u9ad8\u6602 </li> <li>\u5f00\u6e90\u6807\u51c6\u652f\u6301\u4e0d\u5b8c\u6574</li> </ul> <p>Amazon Neptune \u5b8c\u5168\u6258\u7ba1\u7684\u56fe\u6570\u636e\u5e93</p> <ul> <li>\u5feb\u901f <ul> <li>\u6beb\u79d2\u7ea7\u5ef6\u8fdf\u5185\u67e5\u8be2\u6570\u4ee5\u5341\u4ebf\u8ba1\u5173\u8054\u5173\u7cfb   </li> </ul> </li> <li>\u53ef\u9760 <ul> <li>\u6570\u636e\u5728 3 \u4e2a\u53ef\u7528\u533a\u5185\u67096\u4e2a\u5907\u4efd\u5b58\u50a8</li> </ul> </li> <li>\u7b80\u4fbf<ul> <li>\u652f\u6301 Gremlin \u548c SPARQL\u67e5\u8be2</li> </ul> </li> <li>\u5f00\u6e90<ul> <li>\u652f\u6301 Apache TinkerPop \u548c W3C \u56fe\u6a21\u578b</li> </ul> </li> </ul>"},{"location":"aws/1aws_neptune/#_8","title":"\u5b8c\u5168\u6258\u7ba1\u7684\u670d\u52a1","text":"<ul> <li>\u901a\u8fc7\u63a7\u5236\u53f0\u7b80\u4fbf\u914d\u7f6e </li> <li>\u8de8\u591a\u53ef\u7528\u533a\u7684\u9ad8\u53ef\u7528\u6027 </li> <li>\u652f\u6301\u6700\u591a 15 \u4e2a \u8bfb\u526f\u672c </li> <li>\u652f\u6301\u9759\u6001\u52a0\u5bc6 </li> <li>\u652f\u6301\u4f20\u8f93\u8fc7\u7a0b\u52a0\u5bc6 </li> <li>\u5907\u4efd\u3001\u8fd8\u539f\u3001\u65f6\u95f4\u70b9\u6062\u590d</li> </ul>"},{"location":"aws/1aws_neptune/#amazon-neptune","title":"Amazon Neptune \u4f53\u7cfb\u67b6\u6784","text":""},{"location":"aws/1aws_neptune/#amazon-neptune_1","title":"Amazon Neptune \u90e8\u7f72\u65b9\u5f0f","text":"<ul> <li>\u5b89\u5168\u5730\u90e8\u7f72\u5728 Amazon VPC</li> <li>\u5728\u4e24\u4e2a\u53ef\u7528\u533a\u7684\u5b50\u7f51\u4e2d\u90e8\u7f72\u589e\u52a0\u53ef\u7528\u6027</li> <li>\u96c6\u7fa4\u4f1a\u81ea\u52a8\u5730\u6269\u5c55\u5230\u4e09\u4e2a\u53ef\u7528\u533a \u5b58\u50a8\u4ee5\u589e\u52a0\u6301\u4e45\u6027</li> <li>\u66f4\u591a\u7ec6\u8282\u8bf7\u89c1 Amazon Neptune \u6587\u6863</li> </ul>"},{"location":"aws/1aws_neptune/#amazon-neptune_2","title":"Amazon Neptune \u4e91\u539f\u751f\u5b58\u50a8","text":"<ul> <li>\u6570\u636e\u4ee5 6 \u4e2a\u526f\u672c\u7684\u5f62\u5f0f\u5b58\u50a8\u5728 3 \u4e2a\u53ef\u7528\u533a</li> <li>\u6301\u7eed\u5907\u4efd\u5230 Amazon S3(\u62e5\u6709 11 \u4e2a 9 \u7684\u6301 \u4e45\u6027)</li> <li>\u6301\u7eed\u76d1\u63a7\u8282\u70b9\u548c\u78c1\u76d8\u662f\u5426\u635f\u574f</li> <li>10GB \u6bb5\u6570\u636e\u4f5c\u4e3a\u4fee\u590d\u6216\u8005\u70ed\u5e73\u8861\u91cd\u65b0\u5206\u914d\u7684\u5355\u5143</li> <li>\u5199\u56db\u8bfb\u4e09</li> <li>\u526f\u672c\u6570\u91cf\u7684\u53d8\u5316\u4e0d\u4f1a\u5f71\u54cd\u5199\u5165</li> <li>\u5b58\u50a8\u5bb9\u91cf\u6700\u591a\u80fd\u81ea\u52a8\u6269\u5c55\u5230 64TB</li> </ul>"},{"location":"aws/1aws_neptune/#amazon-neptune_3","title":"Amazon Neptune \u9ad8\u53ef\u7528\u548c\u5bb9\u9519","text":"<p>\u53ef\u4ee5\u5bb9\u5fcd\u7684\u6545\u969c\u7c7b\u578b? </p> <ul> <li>\u6bb5\u6570\u636e\u635f\u574f(\u78c1\u76d8)</li> <li>\u6570\u636e\u8282\u70b9\u635f\u574f(\u5b9e\u4f8b) </li> <li>\u53ef\u7528\u533a\u4e0d\u53ef\u7528(\u7f51\u7edc/\u6570\u636e\u4e2d\u5fc3)</li> </ul> <p>\u4f18\u5316</p> <ul> <li>\u5199\u5165 6 \u4efd\u4e2d\u7684 4 \u4efd</li> <li>\u5f53 6 \u4efd\u4e2d\u7684 3 \u4efd\u6709\u6548\u65f6\u5c31\u53ef\u4ee5\u8bfb\u53d6 </li> <li>\u5bf9\u7b49\u590d\u5236\u8fdb\u884c\u4fee\u590d</li> </ul> <p></p>"},{"location":"aws/1aws_neptune/#amazon-neptune_4","title":"Amazon Neptune \u53ea\u8bfb\u526f\u672c","text":"<p>\u53ef\u7528\u6027</p> <ul> <li>\u635f\u574f\u7684\u6570\u636e\u5e93\u8282\u70b9\u4f1a\u88ab\u81ea\u52a8\u68c0\u6d4b\u548c\u4ee3\u66ff</li> <li>\u635f\u574f\u7684\u6570\u636e\u5e93\u8282\u70b9\u4f1a\u88ab\u81ea\u52a8\u56de\u6536</li> <li>\u5728 Failover \u7684\u65f6\u5019\uff0c\u526f\u672c\u4f1a\u88ab\u81ea\u52a8\u63d0\u5347 \u4e3a\u4e3b\u8282\u70b9</li> <li>\u7528\u6237\u53ef\u4ee5\u81ea\u5b9a\u4e49 Failover \u987a\u5e8f</li> </ul> <p>\u6027\u80fd</p> <ul> <li>\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u901a\u8fc7\u8bfb\u526f\u672c\u6269\u5c55\u8bfb\u53d6\u5bb9\u91cf </li> <li>\u901a\u8fc7\u53ea\u8bfb\u7ec8\u7aef\u8282\u70b9\u505a\u8bfb\u53d6\u7684\u8d1f\u8f7d\u5747\u8861</li> </ul> <p></p>"},{"location":"aws/1aws_neptune/#amazon-neptune-30","title":"Amazon Neptune \u6545\u969c\u8f6c\u79fb\u4e00\u822c\u5c0f\u4e8e 30 \u79d2","text":""},{"location":"aws/1aws_neptune/#amazon-neptune_5","title":"Amazon Neptune \u6301\u7eed\u5907\u4efd","text":"<ul> <li>\u5b9a\u671f\u3001\u5e76\u884c\u5730\u5bf9\u6bb5\u6570\u636e\u62cd\u6444\u5feb\u7167\uff0c\u53e6\u5916\u4f1a\u6301\u7eed\u5730\u628a\u65e5\u5fd7\u6d41\u5b58\u5230 Amazon S3 </li> <li>\u5907\u4efd\u4e0d\u4f1a\u5f71\u54cd <code>Amazon Neptune</code> \u7684\u6027\u80fd\u548c\u53ef\u7528\u6027</li> <li>\u8fd8\u539f\u65f6\u4f1a\u68c0\u7d22\u6bb5\u5feb\u7167\u548c\u76f8\u5e94\u7684\u65e5\u5fd7\u6d41</li> <li>\u4ee5\u5f02\u6b65\u5e76\u884c\u7684\u65b9\u5f0f\u628a\u65e5\u5fd7\u6d41\u91cd\u65b0\u5e94\u7528\u5230\u6bb5\u5feb\u7167</li> </ul>"},{"location":"aws/1aws_neptune/#amazon-neptune-clone","title":"Amazon Neptune Clone \u514b\u9686","text":"<p>\u521b\u5efa\u6570\u636e\u5e93\u526f\u672c\u800c\u65e0\u91cd\u590d\u7684\u5b58\u50a8\u6210\u672c</p> <ul> <li>\u521b\u5efa\u514b\u9686\u51e0\u4e4e\u662f\u77ac\u95f4\u7684-\u6211\u4eec\u4e0d\u590d\u5236\u6570\u636e</li> <li>\u6570\u636e\u590d\u5236\u4ec5\u5728\u5199\u5165\u65f6\u53d1\u751f\u2013\u5f53\u539f\u59cb\u548c\u514b\u9686\u7684\u5377\u6570\u636e\u4e0d\u540c\u65f6</li> </ul> <p>\u5178\u578b\u7528\u4f8b:</p> <ul> <li>\u514b\u9686\u751f\u4ea7\u6570\u636e\u5e93\u4ee5\u8fd0\u884c\u6d4b\u8bd5</li> <li>\u6267\u884c\u5de5\u4f5c\u8d1f\u8f7d\u5bc6\u96c6\u578b\u64cd\u4f5c\uff0c\u4f8b\u5982\u5bfc\u51fa\u6570\u636e\u6216\u8fd0\u884c\u5206\u6790\u67e5\u8be2</li> <li>\u4fdd\u5b58\u65f6\u95f4\u70b9\u5feb\u7167\u4ee5\u8fdb\u884c\u5206\u6790\uff0c\u800c\u4e0d\u4f1a\u5f71\u54cd\u751f\u4ea7\u7cfb\u7edf</li> </ul> <p></p>"},{"location":"aws/1aws_neptune/#amazon-neptune_6","title":"Amazon Neptune \u6570\u636e\u52a0\u8f7d","text":"<ul> <li>API \u8c03\u7528<code>Insert</code>,<code>addVertex</code>,<code>addEdge</code> \u7b49</li> <li><code>Loader</code> \u547d\u4ee4\u66f4\u5feb\uff0c\u5360\u7528\u8d44\u6e90\u5c11\uff0c\u4e3a\u5927\u6570\u636e\u96c6\u505a\u4e86\u4f18\u5316</li> </ul> <p>\u6ce8:\u6240\u6709\u6587\u4ef6\u5fc5\u987b\u91c7\u7528 UTF-8 \u683c\u5f0f\u7f16\u7801\u3002\u5982\u679c\u975e UTF \u683c\u5f0f\uff0c\u5219Neptune \u4ecd\u5c06\u5176\u4f5c\u4e3a UTF-8 \u6570\u636e\u52a0\u8f7d</p> <p></p>"},{"location":"aws/1aws_neptune/#amazon-neptune_7","title":"Amazon Neptune \u76d1\u63a7\u7ba1\u7406","text":"<p>AWS CloudTrail:</p> <p>Log all Neptune API calls to S3 bucket</p> <p>Event Notifications</p> <p>Create AmazonSimple Notification Service (Amazon SNS) subscription via AWS Command Line Interface (AWS CLI) or AWS SDK</p> <p>Amazon CloudWatch</p> <p></p>"},{"location":"aws/1aws_neptune/#3-amazon-neptune","title":"3 Amazon Neptune \u90e8\u7f72\u67b6\u6784\u53ca\u6700\u4f73\u5b9e\u8df5","text":"<p>\u4f7f\u7528 NLB \u4ece VPC \u5916\u8fde\u63a5\u5230 Amazon Neptune</p> <p></p> <p>\u4f7f\u7528 ALB \u4ece VPC \u5916\u8fde\u63a5\u5230 Amazon Neptune</p> <p></p>"},{"location":"aws/1aws_neptune/#-s3","title":"\u6700\u4f73\u5b9e\u8df5 - \u4ece S3 \u6279\u91cf\u52a0\u8f7d\u6570\u636e","text":"<ul> <li>\u975e\u4e8b\u52a1\u6027\u7684\uff0c\u4e13\u4e3a\u4ec5 \u9644\u52a0\u5bfc\u5165 \u800c\u8bbe\u8ba1</li> <li>\u52a0\u8f7d\u7a0b\u5e8f\u53ef\u4ee5\u5728\u5355\u4e2a\u52a0\u8f7d\u4efb\u52a1\u4e2d\u4ece\u591a\u4e2a\u9876\u70b9\u6587\u4ef6\u548c\u591a\u4e2a\u8fb9\u7f18\u6587\u4ef6\u52a0\u8f7d<ul> <li>\u4f7f\u7528\u5927\u578b gzip \u538b\u7f29\u6587\u4ef6</li> </ul> </li> <li>\u4f7f\u7528\u5b9e\u4f8b\u7c7b\u578b\u8fdb\u884c\u5728\u7ebf\u6269\u5c55<ul> <li>\u6682\u65f6\u542f\u52a8 r4.8xlarge\uff0c\u5728\u521d\u59cb\u52a0\u8f7d\u5b8c\u6210\u540e\u6545\u969c\u8f6c\u79fb\u5230\u6240\u9700\u7684\u5b9e\u4f8b\u7c7b\u578b</li> </ul> </li> <li>\u53ef\u914d\u7f6e\uff0c\u8b6c\u5982failOnError\u3001updateSingleCardinalityProperties\u7b49</li> <li>\u652f\u6301\u5404\u79cd\u8f93\u5165\u683c\u5f0f<ul> <li>Gremlin \u7684 CSV</li> <li>\u7528\u4e8e SPARQL \u7684 NTriples / NQuads / Turtle / RDF + XML</li> </ul> </li> </ul>"},{"location":"aws/1aws_neptune/#_9","title":"\u6700\u4f73\u5b9e\u8df5 \u2013 \u5728\u7ebf\u67e5\u8be2 (\u8bfb/\u5199/\u63d2\u5165\u64cd\u4f5c)","text":"<ul> <li>\u5b8c\u5168\u652f\u6301\u4e8b\u52a1(<code>READ COMMITTED</code>)</li> <li>SPARQL \u548c Gremlin \u90fd\u652f\u6301\u53ea\u8bfb\u67e5\u8be2\u4e0e\u66f4\u6539\u67e5\u8be2</li> <li>\u5199\u5165\u5728 \u4e3b\u8282\u70b9 \u4e0a \u7acb\u5373\u53ef\u89c1(\u8bfb\u53d6\u526f\u672c\u53ef\u80fd\u5b58\u5728 \u5ef6\u8fdf ) </li> <li>\u53ef\u4ee5\u5728 Gremlin \u4e2d\u4f7f\u7528\u957f\u671f\u4f1a\u8bdd</li> </ul>"},{"location":"aws/1aws_neptune/#_10","title":"\u6700\u4f73\u5b9e\u8df5 \u2013 \u4f18\u5316\u5199\u64cd\u4f5c\u7684\u541e\u5410\u91cf","text":"<ul> <li>\u4f7f\u7528 \u5e76\u884c \u5199\u5165/\u5220\u9664 \u6765\u4f18\u5316\u541e\u5410\u91cf</li> <li>\u5927\u578b\u4e8b\u52a1\u652f\u6301 \u6700\u591a 150MB \u7684\u8bf7\u6c42\u5927\u5c0f </li> <li>\u652f\u6301 \u5927\u6279\u91cf\u5220\u9664<ul> <li>\u5e76\u884c\u5220\u9664 \u901a\u5e38\u66f4\u53ef\u53d6(\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u63d0\u9ad8\u6027\u80fd)</li> </ul> </li> <li>\u907f\u514d \u5e76\u53d1\u4fee\u6539(\u5199 - \u5199\u51b2\u7a81)</li> <li>\u8c03\u6574 <code>neptune_query_timeout</code> \u4ee5\u65b9\u4fbf\u66f4\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u67e5\u8be2<ul> <li>\u9ed8\u8ba4\u503c:2 \u5206\u949f</li> </ul> </li> </ul>"},{"location":"aws/1aws_neptune/#neptune","title":"\u6700\u4f73\u5b9e\u8df5 \u2013 Neptune \u5185\u5b58\u4f18\u5316","text":"<ul> <li> <p>\u6570\u636e\u7f13\u5b58\u5728 \u4e3b\u8282\u70b9 \u7684\u5185\u5b58\u4e2d</p> <ul> <li>\u53ef\u7528\u7684\u5185\u5b58\u91cf\u968f\u5b9e\u4f8b\u7c7b\u578b\u800c\u589e\u52a0<ul> <li>r4.large(15.25GB)\u9ad8\u8fbe r5.12xlarge(384GB)</li> </ul> </li> <li>\u589e\u52a0 #CPU\u6838\u5fc3 =&gt; \u6269\u5c55\u5e76\u884c\u5904\u7406 </li> </ul> </li> <li> <p>\u9488\u5bf9 \u5185\u5b58\u8bbf\u95ee\u4f18\u5316 \u7684\u67e5\u8be2\u8bc4\u4f30</p> <ul> <li>\u4ece\u5b58\u50a8\u5c42\u83b7\u53d6\u6570\u636e \u975e\u5e38\u6602\u8d35 <ul> <li>\u5ef6\u8fdf\u589e\u52a0</li> <li>IOPS \u6210\u672c</li> </ul> </li> <li>\u8ba1\u5212\u5c06\u70ed\u6570\u636e\u96c6\u586b\u5145\u5230\u4e3b\u5185\u5b58</li> </ul> </li> <li>\u5b58\u50a8\u5c42 CloudWatch \u6307\u6807<ul> <li>\u5728\u67e5\u8be2\u65f6\u5173\u6ce8ReadThroughput</li> </ul> </li> </ul>"},{"location":"aws/1aws_neptune/#_11","title":"\u6700\u4f73\u5b9e\u8df5 \u2013 \u591a\u79df\u6237","text":"<ul> <li> <p>Gremlin</p> <ul> <li>\u76ee\u524d\u652f\u6301\u5355\u56fe</li> <li>\u53ef\u4ee5\u5728\u5e94\u7528\u7a0b\u5e8f\u7ea7\u522b \u5efa\u6a21\u591a\u4e2a\u6570\u636e\u96c6(\u4f8b\u5982\u6807\u7b7e\u548c\u8282\u70b9/\u8fb9\u7f18\u5c5e\u6027)</li> </ul> </li> <li> <p>SPARQL</p> <ul> <li>\u652f\u6301\u547d\u540d\u56fe\u5f62</li> <li>\u6570\u636e\u52a0\u8f7d\u5668\u652f\u6301\u547d\u540d\u56fe\u5f62\u683c\u5f0f(NQuads)\u6216\u76ee\u6807\u547d\u540d\u56fe\u5f62\u7684\u89c4\u8303</li> <li>\u547d\u540d\u56fe\u7ea6\u675f\u53ef\u4ee5\u5305\u542b\u5728 SPARQL \u67e5\u8be2\u4e2d</li> </ul> </li> </ul>"},{"location":"aws/1aws_neptune/#_12","title":"\u6700\u4f73\u5b9e\u8df5 \u2013 \u5c5e\u6027\u4fee\u6539","text":"<p>\u66f4\u6539\u5c5e\u6027\u6216\u6dfb\u52a0\u5c5e\u6027(\u5982\u679c\u5c5e\u6027\u4e0d\u5b58\u5728)</p> <p><code>g.V('1').property(single, 'name', 'marko')</code>: </p> <p>\u6b64\u5904\u4ecb\u7ecd\u5982\u4f55\u66f4\u6539\u4e0a\u4e00\u6b65\u4e2d\u9876\u70b9\u7684 name \u5c5e\u6027\u3002\u8fd9\u4f1a\u4ece name \u5c5e\u6027\u5220\u9664\u73b0\u6709\u503c\u3002 \u5982\u679c\u60a8\u672a\u6307\u5b9a single\uff0c\u5219\u4f1a\u6539\u4e3a\u5c06\u503c\u9644\u52a0\u5230 name \u5c5e\u6027(\u5982\u679c\u5c1a\u672a\u9644\u52a0)\u3002</p> <p>\u6dfb\u52a0\u5c5e\u6027\uff0c\u4f46\u5728\u5c5e\u6027\u5df2\u6709\u503c\u65f6\u9644\u52a0\u5c5e\u6027</p> <p><code>g.V('1').property('age', 29)</code> </p> <p>Neptune \u4f7f\u7528\u96c6\u57fa\u6570<code>set cardinality</code>\u4f5c\u4e3a\u9ed8\u8ba4\u64cd\u4f5c\u3002 \u6b64\u547d\u4ee4\u6dfb\u52a0\u503c\u4e3a 29 \u7684 age \u5c5e\u6027\uff0c\u4f46\u4e0d\u66ff\u6362\u4efb\u4f55\u73b0\u6709\u503c\u3002</p> <p>\u5982\u679c age \u5c5e\u6027\u5df2\u6709\u503c\uff0c\u6b64\u547d\u4ee4\u5c06 29 \u9644\u52a0\u5230\u5c5e\u6027\u3002\u4f8b\u5982\uff0c\u5982\u679c age \u5c5e\u6027\u662f 27\uff0c\u5219 \u65b0\u503c\u5c06\u4e3a [ 27, 29 ]\u3002</p>"},{"location":"aws/1aws_neptune/#4-amazon-neptune","title":"4 Amazon Neptune \u5728\u7ebf\u6f14\u793a\u53ca\u53c2\u8003\u8d44\u6e90","text":"<p>Visualize data in Amazon Neptune using VIS.js library</p> <p></p>"},{"location":"aws/1aws_neptune/#usertweet","title":"User\u4e0eTweet\u7684\u6570\u636e","text":""},{"location":"aws/2dydb1/","title":"L2 \u5206\u5e03\u5f0f\u952e\u503c\u5b58\u50a8 Dynamo \u7684\u5b9e\u73b0\u539f\u7406","text":""},{"location":"aws/2dydb1/#1-bigtable-dynamo","title":"1 Bigtable \u548c Dynamo","text":"<p><code>Bigtable</code> \u548c <code>Dynamo</code> \u4e24\u8005\u5206\u522b\u662f <code>Google</code> \u548c <code>Amazon</code> \u4e24\u5927\u5de8\u5934\u7ed9\u51fa\u7684\u5b58\u50a8\u6d77\u91cf\u6570\u636e\u7684\u89e3\u51b3\u65b9\u6cd5\uff0c\u4f5c\u4e3a <code>NoSQL</code> \u4e24\u8005\u90fd\u5177\u6709\u5206\u5e03\u5f0f\u3001\u5bb9\u9519\u4ee5\u53ca\u53ef\u6269\u5c55\u7684\u51e0\u5927\u7279\u6027\u3002</p> <p></p> <p>\u867d\u7136\u4e24\u8005\u90fd\u662f <code>NoSQL</code>\uff0c\u5e76\u4e14\u6709\u7740\u76f8\u4f3c\u7684\u7279\u6027\uff0c\u4f46\u662f\u5b83\u4eec\u5728\u4fa7\u91cd\u7684\u65b9\u5411\u4e0a\u6709\u975e\u5e38\u660e\u663e\u7684\u4e0d\u540c\uff0c\u4ece\u4e24\u4e2a\u6570\u636e\u5e93\u8bba\u6587\u7684\u6807\u9898\u4e2d\uff0c</p> <ul> <li>\u6211\u4eec\u5c31\u80fd\u770b\u5230 <code>Amazon</code> \u7684 <code>Dynamo</code> \u8ffd\u6c42\u7684\u662f\u9ad8\u53ef\u7528\u6027\u5e76\u4e14\u63d0\u4f9b\u7684\u662f\u7c7b\u4f3c <code>MongoDB</code> \u7684 <code>Key-value</code> \u6587\u6863\u5b58\u50a8\uff0c</li> <li>\u800c <code>Bigtable</code> \u4e2d\u63cf\u8ff0\u7684\u6570\u636e\u5e93\u5374\u53ef\u4ee5\u7528\u4e8e\u7ed3\u6784\u5316\u7684\u6570\u636e\u5b58\u50a8\u3002</li> </ul> <p>\u7531\u4e8e <code>Bigtable</code> \u548c <code>Dynamo</code> \u90fd\u5c5e\u4e8e\u540c\u4e00\u4e2a\u7c7b\u522b - <code>NoSQL</code>\uff0c\u6240\u4ee5\u5b83\u4eec\u7ecf\u5e38\u4f1a\u88ab\u653e\u5728\u4e00\u8d77\u8fdb\u884c\u5bf9\u6bd4\uff0c\u8fd9\u7bc7\u6587\u7ae0\u4e0d\u4ec5\u4f1a\u4ecb\u7ecd <code>Dynamo</code>\u7684\u8bbe\u8ba1\u7406\u5ff5\u4ee5\u53ca\u67b6\u6784\u7b49\u95ee\u9898\uff0c\u8fd8\u4f1a\u5c31\u5176\u4e2d\u7684\u90e8\u5206\u95ee\u9898\u4e0e <code>Bigtable</code> \u4e2d\u76f8\u5bf9\u5e94\u7684\u6982\u5ff5\u8fdb\u884c\u5bf9\u6bd4\uff0c\u8fd9\u6837\u80fd\u591f\u8ba9\u6211\u4eec\u66f4\u52a0\u6e05\u695a\u5730\u4e86\u89e3\u4e0d\u540c\u7684\u6570\u636e\u5e93\u5bf9\u4e0d\u540c\u95ee\u9898\uff0c\u56e0\u8bbe\u8ba1\u7406\u5ff5\u7684\u5dee\u5f02\u505a\u51fa\u7684\u6743\u8861\u3002</p>"},{"location":"aws/2dydb1/#2","title":"2 \u67b6\u6784","text":"<p>\u5728\u6570\u636e\u5e93\u9886\u57df\u4e2d\u5c24\u5176\u662f\u5206\u5e03\u5f0f\u6570\u636e\u5e93\uff0c\u6700\u91cd\u8981\u7684\u5c31\u662f\u670d\u52a1\u7684\u67b6\u6784\uff0c\u591a\u6570\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u5728\u8bbe\u8ba1\u65f6\u90fd\u4f1a\u5047\u8bbe\u670d\u52a1\u8fd0\u884c\u5728\u5ec9\u4ef7\u7684\u8282\u70b9\u4e0a\uff0c\u5e76\u6ca1\u6709\u51fa\u4f17\u7684\u6027\u80fd\u548c\u4e5f\u4e0d\u80fd\u63d0\u4f9b\u7a33\u5b9a\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u6c34\u5e73\u6269\u5c55\u548c\u5bb9\u9519\u7684\u80fd\u529b\u662f\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u7684\u6807\u914d\uff1b</p> <p>\u4f46\u662f\u4e0d\u540c\u7684\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u9009\u7528\u4e86\u4e0d\u540c\u7684\u67b6\u6784\u6765\u7ec4\u7ec7\u5927\u91cf\u7684\u8282\u70b9\u3002</p> <p>\u5f88\u591a\u7684\u5206\u5e03\u5f0f\u670d\u52a1\u4f8b\u5982 <code>GFS</code> \u548c <code>Bigtable</code> \u90fd\u4f7f\u7528\u4e86\u5e26\u6709\u4e3b\u8282\u70b9\u7684\u67b6\u6784\u6765\u7ef4\u62a4\u6574\u4e2a\u7cfb\u7edf\u4e2d\u7684\u5143\u6570\u636e\uff0c\u5305\u62ec\u8282\u70b9\u7684\u4f4d\u7f6e\u7b49\u4fe1\u606f\uff0c</p> <p>\u800c <code>Dynamo</code> \u7684\u5b9e\u73b0\u4e0d\u540c\u4e8e\u8fd9\u4e9b\u4e2d\u5fc3\u5316\u7684\u5206\u5e03\u5f0f\u670d\u52a1\uff0c\u5728 <code>Dynamo</code>\u4e2d\u6240\u6709\u7684\u8282\u70b9\u90fd\u6709\u7740\u5b8c\u5168\u76f8\u540c\u7684\u804c\u8d23\uff0c\u4f1a\u5bf9\u5916\u754c\u63d0\u4f9b\u540c\u6837\u7684\u670d\u52a1\uff0c\u6240\u4ee5\u5728\u6574\u4e2a\u7cfb\u7edf\u4e2d\u5e76\u4e0d\u4f1a\u51fa\u73b0\u5355\u70b9\u6545\u969c\u7684\u95ee\u9898\u3002</p> <p></p> <p>\u53bb\u4e2d\u5fc3\u5316\u7684\u67b6\u6784\u4f7f\u5f97\u7cfb\u7edf\u7684\u6c34\u5e73\u6269\u5c55\u975e\u5e38\u5bb9\u6613\uff0c\u8282\u70b9\u53ef\u4ee5\u5728\u4efb\u4f55\u65f6\u5019\u76f4\u63a5\u52a0\u5165\u5230\u6574\u4e2a <code>Dynamo</code> \u7684\u96c6\u7fa4\u4e2d\uff0c\u5e76\u4e14\u53ea\u4f1a\u9020\u6210\u96c6\u7fa4\u4e2d\u5c11\u91cf\u6570\u636e\u7684\u8fc1\u79fb\u3002</p> <ul> <li><code>Bigtable</code> \u4f7f\u7528\u4e86\u4e2d\u5fc3\u5316\u7684\u67b6\u6784\uff0c\u901a\u8fc7\u4e3b\u8282\u70b9\u6765\u7ef4\u62a4\u6574\u4e2a\u7cfb\u7edf\u4e2d\u5168\u90e8\u7684\u5143\u6570\u636e\u4fe1\u606f\uff0c</li> <li>\u4f46\u662f <code>Bigtable</code> \u672c\u8eab\u5176\u5b9e\u5e76\u4e0d\u4f1a\u5904\u7406\u6765\u81ea\u5ba2\u6237\u7aef\u7684\u8bfb\u5199\u8bf7\u6c42\uff0c\u6240\u6709\u8bf7\u6c42\u90fd\u4f1a\u7531\u5ba2\u6237\u7aef\u76f4\u63a5\u548c\u4ece\u8282\u70b9\u901a\u4fe1\uff0c\u4e0d\u8fc7\u7531\u4e8e\u6709\u4e86\u4e2d\u5fc3\u5316\u7684\u4e3b\u8282\u70b9\uff0c\u6240\u4ee5\u4e3b\u8282\u70b9\u4e00\u65e6\u53d1\u751f\u6545\u969c\u5b95\u673a\u5c31\u4f1a\u9020\u6210\u670d\u52a1\u7684\u4e0d\u53ef\u7528\uff0c</li> <li>\u867d\u7136 <code>Bigtable</code> \u4ee5\u53ca\u7c7b\u4f3c\u7684\u670d\u52a1\u901a\u8fc7\u5176\u4ed6\u65b9\u5f0f\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u4f46\u662f\u8fd9\u4e2a\u95ee\u9898\u4ecd\u7136\u662f\u4e2d\u5fc3\u5316\u7684\u8bbe\u8ba1\u6240\u9020\u6210\u7684\u3002</li> </ul> <p></p> <p>\u4e2d\u5fc3\u5316\u6216\u8005\u53bb\u4e2d\u5fc3\u5316\u5e76\u4e0d\u662f\u4e00\u4e2a\u7edd\u5bf9\u597d\u6216\u8005\u7edd\u5bf9\u574f\u7684\u9009\u62e9\uff0c\u9009\u62e9\u4e2d\u5fc3\u5316\u7684\u89e3\u51b3\u65b9\u6848\u80fd\u591f\u964d\u4f4e\u7cfb\u7edf\u5b9e\u73b0\u7684\u590d\u6742\u5ea6\uff0c\u800c\u53bb\u4e2d\u5fc3\u5316\u7684\u65b9\u5f0f\u80fd\u591f\u907f\u514d\u5355\u70b9\u6545\u969c\uff0c\u8ba9\u7cfb\u7edf\u80fd\u591f\u66f4\u597d\u66f4\u5feb\u5730\u589e\u52a0\u65b0\u7684\u8282\u70b9\uff0c\u63d0\u4f9b\u4f18\u79c0\u7684\u6c34\u5e73\u6269\u5c55\u80fd\u529b\u3002</p>"},{"location":"aws/2dydb1/#3","title":"3 \u5206\u7247\u548c\u590d\u5236","text":"<p><code>Dynamo</code> \u5728\u8bbe\u8ba1\u4e4b\u521d\u5c31\u5b9a\u4e0b\u4e86\u589e\u91cf\u6269\u5c55\uff08<code>Incremental Scalability</code>\uff09\u7684\u6838\u5fc3\u9700\u6c42\uff0c\u8fd9\u4e5f\u5c31\u9700\u8981\u4e00\u79cd\u80fd\u591f\u5728\u4e00\u7ec4\u8282\u70b9\u4e2d\u52a8\u6001\u5206\u7247\u7684\u673a\u5236\uff0c</p> <p><code>Dynamo</code> \u7684\u5206\u7247\u7b56\u7565\u4f9d\u8d56\u4e8e\u4e00\u81f4\u6027\u54c8\u5e0c\uff0c\u901a\u8fc7\u8fd9\u79cd\u7b56\u7565 <code>Dynamo</code> \u80fd\u591f\u5c06\u8d1f\u8f7d\u5408\u7406\u7684\u5206\u914d\u5230\u4e0d\u540c\u7684\u5b58\u50a8\u8282\u70b9\u4e0a\u3002</p> <ul> <li>\u6240\u6709\u7684\u952e\u5728\u5b58\u50a8\u4e4b\u524d\u90fd\u4f1a\u901a\u8fc7\u54c8\u5e0c\u51fd\u6570\u5f97\u5230\u4e00\u4e2a\u552f\u4e00\u7684\u503c\uff0c</li> <li>\u54c8\u5e0c\u51fd\u6570\u7684\u8f93\u51fa\u88ab\u770b\u505a\u662f\u4e00\u4e2a\u56fa\u5b9a\u957f\u5ea6\u7684\u73af\uff0c</li> <li>\u4e5f\u5c31\u662f\u5176\u8f93\u51fa\u7684\u6700\u5927\u503c\u548c\u6700\u5c0f\u503c\u662f\u300e\u8fde\u63a5\u300f\u5230\u4e00\u8d77\u7684\uff1a</li> </ul> <p></p> <p>\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u4f1a\u88ab <code>Dynamo</code> \u5728\u8fd9\u4e2a\u73af\u4e2d\u5206\u914d\u4e00\u4e2a\u968f\u673a\u7684\u4f4d\u7f6e\uff0c\u800c\u8fd9\u4e2a\u8282\u70b9\u4f1a\u5904\u7406\u4ece\u54c8\u5e0c\u7684\u8f93\u51fa\u5728\u5f53\u524d\u8282\u70b9\u524d\u7684\u6240\u6709\u952e\uff1b</p> <ul> <li>\u5047\u8bbe\u6211\u4eec\u6709\u4e00\u4e2a\u952e\u503c\u5bf9<code>(draven, developer)</code>\uff0c</li> <li><code>Hash(draven)</code>\u7684\u7ed3\u679c\u4f4d\u4e8e\u4e0a\u56fe\u4e2d\u7684\u7eff\u8272\u533a\u57df\uff0c</li> <li>\u4ece\u73af\u4e2d\u7684\u4f4d\u7f6e\u5f00\u59cb\u6309\u7167\u987a\u65f6\u9488\u7684\u987a\u5e8f\u5bfb\u627e\uff0c\u627e\u5230\u7684\u4ee5\u7b2c\u4e00\u4e2a\u8282\u70b9 <code>B</code>\u5c31\u4f1a\u6210\u4e3a\u534f\u8c03\u8005\uff08coordinator\uff09\u8d1f\u8d23\u5904\u7406\u5f53\u524d\u7684\u952e\u503c\u5bf9\uff0c</li> <li>\u4e0a\u56fe\u4e2d\u7684\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u4f1a\u8d1f\u8d23\u4e0e\u5176\u989c\u8272\u76f8\u540c\u7684\u90e8\u5206\u3002</li> </ul> <p>\u7531\u4e8e <code>Dynamo</code> \u7cfb\u7edf\u4e2d\u7684\u6bcf\u4e00\u4e2a\u8282\u70b9\u5728\u521a\u521a\u52a0\u5165\u5f53\u524d\u7684\u96c6\u7fa4\u65f6\uff0c\u4f1a\u88ab\u5206\u914d\u4e00\u4e2a\u968f\u673a\u7684\u4f4d\u7f6e\uff0c\u6240\u4ee5\u7531\u4e8e\u7b97\u6cd5\u7684\u968f\u673a\u6027\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e0d\u540c\u8282\u70b9\u5904\u7406\u7684\u8303\u56f4\u6709\u6240\u4e0d\u540c\uff0c\u6700\u7ec8\u6bcf\u4e00\u4e2a\u8282\u70b9\u7684\u8d1f\u8f7d\u4e5f\u5e76\u4e0d\u76f8\u540c\uff1b</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c<code>Dynamo</code> \u4f7f\u7528\u4e86\u4e00\u81f4\u6027\u54c8\u5e0c\u7b97\u6cd5\u7684\u53d8\u79cd\uff0c\u5c06\u540c\u4e00\u4e2a\u7269\u7406\u8282\u70b9\u5206\u914d\u5230\u73af\u4e2d\u7684\u591a\u4e2a\u4f4d\u7f6e\uff08\u6807\u8bb0\uff09\uff0c\u6210\u4e3a\u591a\u4e2a\u865a\u62df\u8282\u70b9\uff0c</p> <p>\u4f46\u662f\u5728\u8fd9\u79cd\u7b56\u7565\u4e0b\uff0c\u5982\u679c\u5f53\u524d\u7684 <code>Dynamo</code> \u8282\u70b9\u4e00\u5929\u5904\u7406\u4e0a\u767e\u4e07\u7684\u8bf7\u6c42\uff0c\u90a3\u4e48\u65b0\u589e\u8282\u70b9\u4e3a\u4e86\u4e0d\u5f71\u54cd\u5df2\u6709\u8282\u70b9\u7684\u6027\u80fd\uff0c\u4f1a\u5728\u540e\u53f0\u8fdb\u884c\u542f\u52a8\uff0c\u6574\u4e2a\u8fc7\u7a0b\u5927\u7ea6\u4f1a\u6d88\u8017\u4e00\u6574\u5929\u7684\u65f6\u95f4\uff0c\u8fd9\u5176\u5b9e\u662f\u5f88\u96be\u63a5\u53d7\u7684\uff0c\u9664\u6b64\u4e4b\u5916\u8fd9\u79cd\u7b56\u7565\u8fd8\u4f1a\u9020\u6210\u7cfb\u7edf\u8fdb\u884c\u65e5\u5e38\u5f52\u6863\u6781\u5176\u7f13\u6162\u3002</p> <p></p> <p>\u4e3a\u4e86\u89e3\u51b3\u8d1f\u8f7d\u7684\u4e0d\u5747\u8861\u7684\u95ee\u9898\uff0c\u9664\u4e86\u4e0a\u9762\u4f7f\u7528\u865a\u62df\u8282\u70b9\u7684\u7b56\u7565\u4e4b\u5916\uff0c<code>Dynamo</code> \u8bba\u6587\u4e2d\u8fd8\u63d0\u4f9b\u4e86\u53e6\u5916\u4e24\u79cd\u7b56\u7565\uff0c</p> <ul> <li>\u5176\u4e2d\u6027\u80fd\u76f8\u5bf9\u8f83\u597d\u7684\u662f\u5c06\u6570\u636e\u7684\u54c8\u5e0c\u5206\u6210 <code>Q</code>\u4e2a\u5927\u5c0f\u76f8\u7b49\u7684\u533a\u57df\uff0c<code>S</code>\u4e2a\u8282\u70b9\u6bcf\u4e00\u4e2a\u5904\u7406 <code>Q/S</code> \u4e2a\u5206\u533a\uff0c\u5f53\u67d0\u4e00\u4e2a\u8282\u70b9\u56e0\u4e3a\u6545\u969c\u6216\u8005\u5176\u4ed6\u539f\u56e0\u9700\u8981\u9000\u51fa\u96c6\u7fa4\u65f6\uff0c\u4f1a\u5c06\u5b83\u5904\u7406\u7684\u6570\u636e\u5206\u7247\u968f\u673a\u5206\u914d\u7ed9\u5176\u5b83\u7684\u8282\u70b9\uff0c\u5f53\u6709\u8282\u70b9\u52a0\u5165\u7cfb\u7edf\u65f6\uff0c\u4f1a\u4ece\u5176\u5b83\u7684\u8282\u70b9\u4e2d\u300e\u63a5\u7ba1\u300f\u5bf9\u5e94\u7684\u6570\u636e\u5206\u7247\u3002\u4e0a\u56fe\u53ea\u662f\u5bf9\u8fd9\u79cd\u7b56\u7565\u4e0b\u7684\u5206\u7247\u60c5\u51b5\u7b80\u5355\u5c55\u793a\uff0c\u5728\u771f\u5b9e\u73af\u5883\u4e2d\u5206\u7247\u6570 <code>Q</code>\u7684\u503c\u8fdc\u8fdc\u5927\u4e8e\u8282\u70b9\u6570 <code>S</code>\u3002</li> </ul> <p><code>Dynamo</code>\u4e3a\u4e86\u8fbe\u5230\u9ad8\u53ef\u7528\u6027\u548c\u6301\u4e45\u6027\uff0c\u9632\u6b62\u7531\u4e8e\u8282\u70b9\u5b95\u673a\u6545\u969c\u6216\u8005\u6570\u636e\u4e22\u5931\uff0c\u5c06\u540c\u4e00\u4efd\u6570\u636e\u5728\u534f\u8c03\u8005\u548c\u968f\u540e\u7684 <code>N-1</code> \u4e2a\u8282\u70b9\u4e0a\u5907\u4efd\u4e86\u591a\u6b21\uff0c<code>N</code> \u662f\u4e00\u4e2a\u53ef\u4ee5\u914d\u7f6e\u7684\u503c\uff0c\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\u90fd\u4e3a <code>3</code>\u3002</p> <p></p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c</p> <ul> <li>\u4e0a\u56fe\u4e2d\u9ec4\u8272\u533a\u57df\u7684\u503c\u4f1a\u5b58\u50a8\u5728\u4e09\u4e2a\u8282\u70b9 <code>A</code>\u3001<code>B</code> \u548c <code>C</code> \u4e2d\uff0c</li> <li>\u7eff\u8272\u7684\u533a\u57df\u4f1a\u88ab <code>B</code>\u3001<code>C</code>\u3001<code>D</code> \u4e09\u4e2a\u8282\u70b9\u5904\u7406\uff0c</li> </ul> <p>\u4ece\u53e6\u4e00\u4e2a\u89d2\u5ea6\u6765\u770b\uff0cA \u8282\u70b9\u4f1a\u5904\u7406\u8303\u56f4\u5728<code>(C, A]</code>\u4e4b\u95f4\u7684\u503c\uff0c\u800c B \u8282\u70b9\u4f1a\u5904\u7406\u4ece <code>(D, B]</code>\u533a\u57df\u5185\u7684\u503c\u3002</p> <p></p> <ul> <li>\u8d1f\u8d23\u5b58\u50a8\u67d0\u4e00\u4e2a\u7279\u5b9a\u952e\u503c\u5bf9\u7684<code>\u8282\u70b9\u5217\u8868</code>\u53eb\u505a<code>\u504f\u597d\u5217\u8868</code>\uff08<code>preference list</code>\uff09\uff0c\u56e0\u4e3a\u865a\u62df\u8282\u70b9\u5728\u73af\u4e2d\u4f1a\u968f\u673a\u5b58\u5728\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u51fa\u73b0\u8282\u70b9\u6545\u969c\u65f6\u4e0d\u4f1a\u5f71\u54cd\u53ef\u7528\u6027\u548c\u6301\u4e45\u6027\uff0c<code>\u504f\u597d\u5217\u8868</code>\u4e2d\u7684<code>\u5168\u90e8\u8282\u70b9</code>\u5fc5\u987b\u90fd\u4e3a\u4e0d\u540c\u7684\u7269\u7406\u8282\u70b9\u3002</li> </ul> <p><code>Bigtable</code> \u4e2d\u5bf9\u5206\u7247\u548c\u590d\u5236\u7684\u5b9e\u73b0\u5176\u5b9e\u5c31\u4e0e <code>Dynamo</code> \u4e2d\u5b8c\u5168\u4e0d\u540c\uff0c\u8fd9\u4e0d\u4ec5\u662f\u56e0\u4e3a <code>Bigtable</code> \u7684\u8282\u70b9\u6709\u4e3b\u4ece\u4e4b\u5206\uff0c\u8fd8\u56e0\u4e3a <code>Bigtable</code> \u7684\u8bbe\u8ba1\u7406\u5ff5\u4e0e <code>Dynamo</code> \u5b8c\u5168\u4e0d\u540c\u3002</p> <p>\u5728 <code>Bigtable</code> \u4e2d\uff0c</p> <ul> <li>\u6570\u636e\u662f\u6309\u7167\u952e\u7684\u987a\u5e8f\u5b58\u50a8\u7684\uff0c</li> <li>\u6570\u636e\u5b58\u50a8\u7684\u5355\u4f4d\u90fd\u662f <code>tablet</code>\uff0c</li> <li>\u6bcf\u4e00\u5f20\u8868\u90fd\u7531\u591a\u4e2a <code>tablet</code> \u7ec4\u6210\uff0c</li> <li>\u800c\u6bcf\u4e00\u4e2a\u7684 <code>tablet</code> \u90fd\u6709\u4e00\u4e2a <code>tablet</code> \u670d\u52a1\u5668\u6765\u5904\u7406\uff0c</li> <li>\u800c <code>tablet</code> \u7684\u4f4d\u7f6e\u90fd\u5b58\u50a8\u5728 <code>METADATA</code> \u8868\u4e2d\u3002</li> </ul> <p></p> <p>\u5728 <code>Bigtable</code> \u4e2d\uff0c\u6240\u6709\u7684 <code>tablet</code> \u90fd\u5728 <code>GFS</code> \u4e2d\u4ee5 <code>SSTable</code> \u7684\u683c\u5f0f\u5b58\u50a8\u8d77\u6765\uff0c\u8fd9\u4e9b <code>SSTable</code> \u90fd\u88ab\u5206\u6210\u4e86\u56fa\u5b9a\u5927\u5c0f\u7684\u5757\u5728 <code>chunkserver</code> \u4e0a\u5b58\u50a8\uff0c\u800c\u6bcf\u4e00\u4e2a\u5757\u4e5f\u90fd\u4f1a\u5728\u5b58\u50a8\u5728\u591a\u4e2a <code>chunkserver</code> \u4e2d\u3002</p>"},{"location":"aws/2dydb1/#4","title":"4 \u8bfb\u5199\u8bf7\u6c42\u7684\u6267\u884c","text":"<p><code>Dynamo</code> \u96c6\u7fa4\u4e2d\u7684\u4efb\u610f\u8282\u70b9\u90fd\u80fd\u591f\u63a5\u53d7\u6765\u81ea\u5ba2\u6237\u7aef\u7684\u5bf9\u4e8e\u4efb\u610f\u952e\u7684\u8bfb\u5199\u8bf7\u6c42\uff0c\u6240\u6709\u7684\u8bf7\u6c42\u90fd\u901a\u8fc7 <code>RPC</code> \u8c03\u7528\u6267\u884c\uff0c\u5ba2\u6237\u7aef\u5728\u9009\u62e9\u8282\u70b9\u65f6\u6709\u4e24\u79cd\u4e0d\u540c\u7684\u7b56\u7565\uff1a</p> <ul> <li>\u4e00\u79cd\u662f\u901a\u8fc7\u4e00\u4e2a\u8d1f\u8f7d\u5747\u8861\u5668\u6839\u636e\u8d1f\u8f7d\u9009\u62e9\u4e0d\u540c\u7684\u8282\u70b9\uff0c</li> <li>\u53e6\u4e00\u79cd\u662f\u901a\u8fc7\u4e00\u4e2a\u6e05\u695a\u5f53\u524d\u96c6\u7fa4\u5206\u7247\u7684\u5e93\u76f4\u63a5\u8bf7\u6c42\u76f8\u5e94\u7684\u8282\u70b9\u3002</li> </ul> <p></p> <p>\u4ece\u4e0a\u9762\u6211\u4eec\u5c31\u5df2\u7ecf\u77e5\u9053\u4e86\u5904\u7406\u8bfb\u5199\u8bf7\u6c42\u7684\u8282\u70b9\u5c31\u53eb\u505a\u534f\u8c03\u8005\uff08<code>coordinator</code>\uff09\uff0c\u524d <code>N</code> \u4e2a\u300e\u5065\u5eb7\u300f\u7684\u8282\u70b9\u4f1a\u53c2\u4e0e\u8bfb\u5199\u8bf7\u6c42\u7684\u5904\u7406\uff1b</p> <ul> <li><code>Dynamo</code> \u4f7f\u7528\u4e86 <code>Quorum</code> \u4e00\u81f4\u6027\u534f\u8bae\u6765\u4fdd\u8bc1\u7cfb\u7edf\u4e2d\u7684\u4e00\u81f4\u6027\uff0c\u534f\u8bae\u4e2d\u6709\u4e24\u4e2a\u53ef\u4ee5\u914d\u7f6e\u7684\u503c\uff1a<code>R</code> \u548c <code>W</code>\uff0c</li> <li>\u5176\u4e2d <code>R</code> \u662f\u6210\u529f\u53c2\u4e0e\u4e00\u4e2a\u8bfb\u8bf7\u6c42\u7684\u6700\u5c0f\u8282\u70b9\u6570\uff0c</li> <li>\u800c <code>W</code> \u662f\u6210\u529f\u53c2\u4e0e\u5199\u8bf7\u6c42\u7684\u6700\u5c0f\u8282\u70b9\u6570\u3002</li> </ul> <p></p> <p>\u5f53 <code>R = 2</code> \u65f6\uff0c\u6240\u6709\u7684\u8bfb\u8bf7\u6c42\u5fc5\u987b\u7b49\u5f85\u4e24\u4e2a\u8282\u70b9\u6210\u529f\u8fd4\u56de\u5bf9\u5e94\u952e\u7684\u7ed3\u679c\uff0c\u624d\u8ba4\u4e3a\u5f53\u524d\u7684\u8bf7\u6c42\u7ed3\u675f\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4\u8bfb\u8bf7\u6c42\u7684\u65f6\u95f4\u53d6\u51b3\u4e8e\u8fd4\u56de\u6700\u6162\u7684\u8282\u70b9\uff0c\u5bf9\u4e8e\u5199\u8bf7\u6c42\u6765\u8bf4\u4e5f\u662f\u5b8c\u5168\u76f8\u540c\u7684\uff1b</p> <p>\u5f53\u534f\u8c03\u8005\u63a5\u6536\u5230\u4e86\u6765\u81ea\u5ba2\u6237\u7aef\u7684\u5199\u8bf7\u6c42 <code>put()</code> \u65f6\uff0c\u5b83\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u5411\u91cf\u65f6\u949f<code>\uff08vector clock\uff09</code>\uff0c\u7136\u540e\u5c06\u65b0\u7248\u672c\u7684\u4fe1\u606f\u5b58\u50a8\u5728\u672c\u5730\uff0c\u4e4b\u540e\u5411\u504f\u597d\u5217\u8868\uff08<code>preference list</code>\uff09\u4e2d\u7684\u524d <code>N-1</code> \u4e2a\u8282\u70b9\u53d1\u9001\u6d88\u606f\uff0c\u76f4\u5230\u5176\u4e2d\u7684 <code>W-1</code> \u4e2a\u8fd4\u56de\u8fd9\u6b21\u8bf7\u6c42\u624d\u6210\u529f\u7ed3\u675f\uff0c</p> <p>\u8bfb\u8bf7\u6c42 <code>get()</code> \u4e0e\u4e0a\u8ff0\u8bf7\u6c42\u7684\u552f\u4e00\u533a\u522b\u5c31\u662f\uff0c\u5982\u679c\u534f\u8c03\u8005\u53d1\u73b0\u8282\u70b9\u4e2d\u7684\u6570\u636e\u51fa\u73b0\u4e86\u51b2\u7a81\uff0c\u5c31\u4f1a\u5bf9\u51b2\u7a81\u5c1d\u8bd5\u8fdb\u884c\u89e3\u51b3\u5e76\u5c06\u7ed3\u679c\u91cd\u65b0\u5199\u56de\u5bf9\u5e94\u7684\u8282\u70b9\u3002</p>"},{"location":"aws/2dydb1/#5","title":"5 \u51b2\u7a81\u548c\u5411\u91cf\u65f6\u949f","text":"<p><code>Dynamo</code> \u4e0e\u76ee\u524d\u7684\u7edd\u5927\u591a\u6570\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e00\u6837\u90fd\u63d0\u4f9b\u4e86<code>\u6700\u7ec8\u4e00\u81f4\u6027</code>\uff0c\u6700\u7ec8\u4e00\u81f4\u6027\u80fd\u591f\u5141\u8bb8\u6211\u4eec\u5f02\u6b65\u7684\u66f4\u65b0\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9\uff0c</p> <p><code>put()</code> \u8bf7\u6c42\u53ef\u80fd\u4f1a\u5728\u6240\u6709\u7684\u8282\u70b9\u540e\u66f4\u65b0\u524d\u5c31\u8fd4\u56de\u5bf9\u5e94\u7684\u7ed3\u679c\u4e86\uff0c\u5728\u8fd9\u65f6\u968f\u540e\u7684 <code>get()</code>\u5c31\u53ef\u80fd\u83b7\u53d6\u5230\u8fc7\u671f\u7684\u6570\u636e\u3002</p> <p></p> <p>\u5982\u679c\u5728\u7cfb\u7edf\u4e2d\u51fa\u73b0\u4e86\u8282\u70b9\u6545\u969c\u5b95\u673a\uff0c\u90a3\u4e48\u6570\u636e\u7684\u66f4\u65b0\u53ef\u80fd\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\u90fd\u4e0d\u4f1a\u5230\u8fbe\u5931\u6548\u7684\u8282\u70b9\uff0c\u8fd9\u4e5f\u662f\u5728\u4f7f\u7528 <code>Dynamo</code> \u6216\u8005\u4f7f\u7528\u76f8\u4f3c\u539f\u7406\u7684\u7cfb\u7edf\u65f6\u4f1a\u9047\u5230\u7684\u95ee\u9898\uff0c</p> <p><code>Amazon</code> \u4e2d\u7684\u5f88\u591a\u5e94\u7528\u867d\u7136\u90fd\u80fd\u591f\u5fcd\u53d7\u8fd9\u79cd\u6570\u636e\u5c42\u9762\u53ef\u80fd\u53d1\u751f\u7684\u4e0d\u4e00\u81f4\u6027\uff0c\u4f46\u662f\u6709\u4e9b\u5bf9\u4e1a\u52a1\u6570\u636e\u4e00\u81f4\u6027\u975e\u5e38\u9ad8\u7684\u5e94\u7528\u5728\u9009\u62e9 <code>Dynamo</code> \u65f6\u5c31\u9700\u8981\u597d\u597d\u8003\u8651\u4e86\u3002</p> <p>\u56e0\u4e3a <code>Dynamo</code> \u5728\u5de5\u4f5c\u7684\u8fc7\u7a0b\u4e2d\u4e0d\u540c\u7684\u8282\u70b9\u53ef\u80fd\u4f1a\u53d1\u751f\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\uff0c\u8fd9\u79cd\u95ee\u9898\u80af\u5b9a\u662f\u9700\u8981\u89e3\u51b3\u7684\uff0c<code>Dynamo</code>\u80fd\u591f\u786e\u4fdd<code>\u4e00\u65e6\u6570\u636e\u4e4b\u95f4\u53d1\u751f\u4e86\u51b2\u7a81\u4e0d\u4f1a\u4e22\u5931</code>\uff0c\u4f46\u662f\u53ef\u80fd\u4f1a\u6709<code>\u5df2\u88ab\u5220\u9664\u7684\u6570\u636e\u91cd\u65b0\u51fa\u73b0</code>\u7684\u95ee\u9898\u3002</p> <p>\u5728\u591a\u6570\u60c5\u51b5\u4e0b\uff0c<code>Dynamo</code> \u4e2d\u7684\u6700\u65b0\u7248\u672c\u7684\u6570\u636e\u90fd\u4f1a\u53d6\u4ee3\u4e4b\u524d\u7684\u7248\u672c\uff0c\u7cfb\u7edf\u5728\u8fd9\u65f6\u53ef\u4ee5\u901a\u8fc7\u8bed\u6cd5\u8c03\u89e3\uff08<code>syntactic reconcile</code>\uff09\u6570\u636e\u5e93\u4e2d\u7684\u6b63\u786e\u7248\u672c\u3002</p> <p>\u4f46\u662f\u7248\u672c\u4e5f\u53ef\u80fd\u4f1a\u51fa\u73b0\u5206\u652f\uff0c\u5728\u8fd9\u65f6\uff0c<code>Dynamo</code> \u5c31\u4f1a\u8fd4\u56de\u6240\u6709\u5b83\u65e0\u6cd5\u5904\u7406\u7684\u6570\u636e\u7248\u672c\uff0c\u7531\u5ba2\u6237\u7aef\u5728\u591a\u4e2a\u7248\u672c\u7684\u6570\u636e\u4e2d\u9009\u62e9\u6216\u8005\u521b\u5efa\uff08<code>collapse</code>\uff09\u5408\u9002\u7684\u7248\u672c\u8fd4\u56de\u7ed9 <code>Dynamo</code>\uff0c\u5176\u5b9e\u8fd9\u4e2a\u8fc7\u7a0b\u6bd4\u8f83\u50cf\u51fa\u73b0\u51b2\u7a81\u7684 <code>git merge</code> \u64cd\u4f5c\uff0c<code>git</code> \u6ca1\u6709\u529e\u6cd5\u5224\u65ad\u5f53\u524d\u7684\u54ea\u4e2a\u7248\u672c\u662f\u5408\u9002\u7684\uff0c\u6240\u4ee5\u53ea\u80fd\u7531\u5f00\u53d1\u8005\u5bf9\u5206\u652f\u4e4b\u95f4\u7684\u51b2\u7a81\u8fdb\u884c\u5904\u7406\u3002</p> <p></p> <p>\u4e0a\u56fe\u4e2d\u7684\u6bcf\u4e00\u4e2a\u5bf9\u8c61\u7684\u7248\u672c <code>Dx</code> \u4e2d\u5b58\u50a8\u7740\u4e00\u4e2a\u6216\u591a\u4e2a\u5411\u91cf\u65f6\u949f <code>[Sn, N]</code>\uff0c\u6bcf\u6b21 <code>Dynamo</code> \u5bf9\u6570\u636e\u8fdb\u884c\u5199\u5165\u65f6\u90fd\u4f1a\u66f4\u65b0\u5411\u91cf\u65f6\u949f\u7684\u7248\u672c\uff0c</p> <ol> <li>\u8282\u70b9 <code>Sx</code> \u7b2c\u4e00\u6b21\u5199\u5165\u65f6\u5411\u91cf\u65f6\u949f\u4e3a <code>[Sx, 1]</code>\uff0c</li> <li>\u7b2c\u4e8c\u6b21\u4e3a<code>[Sx, 2]</code>\uff0c</li> <li>\u5728\u8fd9\u65f6\u5047\u8bbe\u8282\u70b9<code>Sy</code>\u548c<code>Sz</code> \u90fd\u4e0d\u77e5\u9053 <code>Sx</code> \u5df2\u7ecf\u5bf9\u8282\u70b9\u8fdb\u884c\u5199\u5165\u4e86\uff0c</li> <li>\u5b83\u4eec\u63a5\u6536\u5230\u4e86\u6765\u81ea\u5176\u4ed6\u5ba2\u6237\u7aef\u7684\u8bf7\u6c42\uff0c\u5728\u672c\u5730\u4e5f\u5bf9\u540c\u6837\u952e\u505a\u51fa\u4e86\u5199\u5165\u5e76\u5206\u522b\u751f\u6210\u4e86\u4e0d\u540c\u7684\u65f6\u949f <code>[Sy, 1]</code> \u548c <code>[Sz, 1]</code>\uff0c\u5f53</li> <li>\u5ba2\u6237\u7aef\u518d\u6b21\u4f7f\u7528 <code>get()</code>\u8bf7\u6c42\u65f6\u5c31\u4f1a\u53d1\u73b0\u6570\u636e\u51fa\u73b0\u4e86\u51b2\u7a81\uff0c\u7531\u4e8e <code>Dynamo</code> \u65e0\u6cd5\u6839\u636e\u5411\u91cf\u65f6\u949f\u81ea\u52a8\u89e3\u51b3\uff0c\u6240\u4ee5\u5b83\u9700\u8981\u624b\u52a8\u5408\u5e76\u4e09\u4e2a\u4e0d\u540c\u7684\u6570\u636e\u7248\u672c\u3002</li> </ol> <p>\u8bba\u6587\u4e2d\u5bf9 24 \u5c0f\u65f6\u5185\u7684\u8bf7\u6c42\u8fdb\u884c\u4e86\u7edf\u8ba1\uff0c\u5176\u4e2d 99.94% \u7684\u8bf7\u6c42\u4ec5\u4f1a\u8fd4\u56de\u4e00\u4e2a\u7248\u672c\uff0c0.00057% \u7684\u8bf7\u6c42\u4f1a\u8fd4\u56de\u4e24\u4e2a\u7248\u672c\uff0c0.00047 \u7684\u8bf7\u6c42\u4f1a\u8fd4\u56de\u4e09\u4e2a\u7248\u672c\uff0c0.000009% \u7684\u8bf7\u6c42\u4f1a\u8fd4\u56de\u56db\u4e2a\u7248\u672c\uff0c\u867d\u7136\u8bba\u6587\u4e2d\u8bf4\uff1a</p> <p>This shows that divergent versions are created rarely.</p> <p>\u4f46\u662f\u4f5c\u8005\u4ecd\u7136\u8ba4\u4e3a\u5728\u6d77\u91cf\u7684\u6570\u636e\u9762\u524d 99.94% \u5e76\u4e0d\u662f\u4e00\u4e2a\u7279\u522b\u9ad8\u7684\u767e\u5206\u6bd4\uff0c\u5904\u7406\u5206\u6b67\u7684\u6570\u636e\u7248\u672c\u4ecd\u7136\u4f1a\u5e26\u6765\u989d\u5916\u7684\u5de5\u4f5c\u91cf\u548c\u8d1f\u62c5\u3002\u867d\u7136\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6570\u636e\u5e93\u672c\u8eab\u786e\u5b9e\u6ca1\u6709\u8db3\u591f\u7684\u4fe1\u606f\u6765\u89e3\u51b3\u6570\u636e\u7684\u4e0d\u4e00\u81f4\u95ee\u9898\uff0c\u4e5f\u786e\u5b9e\u53ea\u80fd\u7531\u5ba2\u6237\u7aef\u53bb\u89e3\u51b3\u51b2\u7a81\uff0c\u4f46\u662f\u8fd9\u79cd\u5c06\u95ee\u9898\u629b\u7ed9\u4e0a\u5c42\u53bb\u89e3\u51b3\u7684\u65b9\u5f0f\u5e76\u4e0d\u53cb\u597d\uff0c\u8bba\u6587\u4e2d\u4e5f\u63d0\u5230\u4e86 Amazon \u4e2d\u4f7f\u7528 Dynamo \u7684\u5e94\u7528\u7a0b\u5e8f\u4e5f\u90fd\u662f\u80fd\u591f\u9002\u5e94\u5e76\u89e3\u51b3\u8fd9\u4e9b\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\u7684\uff0c\u4e0d\u8fc7\u5bf9\u4e8e\u4f5c\u8005\u6765\u8bf4\uff0c\u4ec5\u4ec5\u8fd9\u4e00\u4e2a\u95ee\u9898\u5c31\u6210\u4e3a\u4e0d\u9009\u62e9 Dynamo \u7684\u7406\u7531\u4e86\u3002</p>"},{"location":"aws/2dydb1/#6","title":"6 \u8282\u70b9\u7684\u589e\u5220","text":"<p>\u56e0\u4e3a\u5728\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u8282\u70b9\u7684\u5931\u6548\u662f\u975e\u5e38\u5e38\u89c1\u7684\u4e8b\u60c5\uff0c\u800c\u8282\u70b9\u4e5f\u5f88\u5c11\u4f1a\u56e0\u4e3a\u67d0\u4e9b\u539f\u56e0\u6c38\u4e45\u5931\u6548\uff0c\u5f80\u5f80\u5927\u90e8\u5206\u8282\u70b9\u4f1a\u4e34\u65f6\u5b95\u673a\u7136\u540e\u5feb\u901f\u91cd\u65b0\u52a0\u5165\u7cfb\u7edf\uff1b\u7531\u4e8e\u8fd9\u4e9b\u539f\u56e0\uff0c<code>Dynamo</code>\u9009\u62e9\u4f7f\u7528\u4e86\u663e\u5f0f\u7684\u673a\u5236\u5411\u7cfb\u7edf\u4e2d\u6dfb\u52a0\u548c\u79fb\u9664\u8282\u70b9\u3002</p> <p></p> <p>\u6dfb\u52a0\u8282\u70b9\u65f6\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4\u884c\u5de5\u5177\u6216\u8005\u6d4f\u89c8\u5668\u8fde\u63a5 <code>Dynamo</code> \u4e2d\u7684\u4efb\u610f\u8282\u70b9\u540e\u89e6\u53d1\u4e00\u4e2a\u6210\u5458\u53d8\u52a8\u7684\u4e8b\u4ef6\uff0c\u8fd9\u4e2a\u4e8b\u4ef6\u4f1a\u4ece\u5f53\u524d\u7684\u73af\u4e2d\u79fb\u9664\u6216\u8005\u5411\u73af\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u8282\u70b9\uff0c\u5f53\u8282\u70b9\u7684\u4fe1\u606f\u53d1\u751f\u6539\u53d8\u65f6\uff0c\u8be5\u8282\u70b9\u4f1a\u901a\u8fc7 <code>Gossip</code> \u534f\u8bae\u901a\u77e5\u5b83\u6240\u80fd\u901a\u77e5\u7684\u6700\u591a\u7684\u8282\u70b9\u3002</p> <p></p> <p>\u5728 <code>Gossip</code> \u534f\u8bae\u4e2d\uff0c\u6bcf\u6b21\u901a\u8baf\u7684\u4e24\u4e2a\u8282\u70b9\u4f1a\u5bf9\u5f53\u524d\u7cfb\u7edf\u4e2d\u7684\u8282\u70b9\u4fe1\u606f\u8fbe\u6210\u4e00\u81f4\uff1b</p> <p>\u901a\u8fc7\u8282\u70b9\u4e4b\u95f4\u4e92\u76f8\u4f20\u9012\u6210\u5458\u4fe1\u606f\uff0c\u6700\u7ec8\u6574\u4e2a Dyanmo \u7684\u96c6\u7fa4\u4e2d\u6240\u6709\u7684\u8282\u70b9\u90fd\u4f1a\u5c31\u6210\u5458\u4fe1\u606f\u8fbe\u6210\u4e00\u81f4\uff0c\u5982\u4e0a\u56fe\u6240\u793a\uff0c</p> <ul> <li>\u201dgossip\u201d \u9996\u5148\u4f1a\u88ab C \u8282\u70b9\u63a5\u6536\uff0c\u7136\u540e\u5b83\u4f1a\u4f20\u9012\u7ed9\u5b83\u80fd\u63a5\u89e6\u5230\u7684\u6700\u591a\u7684\u8282\u70b9 <code>A\u3001D\u3001F\u3001G</code> \u56db\u4e2a\u8282\u70b9\uff0c</li> <li>\u7136\u540e \u201cgossip\u201d \u4f1a\u8fdb\u884c\u4e8c\u6b21\u4f20\u64ad\u4f20\u9012\u7ed9\u7cfb\u7edf\u4e2d\u7684\u7070\u8272\u8282\u70b9\uff0c\u5230\u6b64\u4e3a\u6b62\u7cfb\u7edf\u4e2d\u7684\u6240\u6709\u8282\u70b9\u90fd\u5f97\u5230\u4e86\u6700\u65b0\u7684 \u201cgossip\u201d \u6d88\u606f\u3002</li> </ul> <p>\u5f53\u6211\u4eec\u5411 <code>Dynamo</code> \u4e2d\u52a0\u5165\u4e86\u65b0\u7684\u8282\u70b9\u65f6\uff0c\u4f1a\u53d1\u751f\u8282\u70b9\u4e4b\u95f4\u7684\u5206\u7247\u8f6c\u79fb\uff0c\u5047\u8bbe\u6211\u4eec\u8fde\u63a5\u4e0a\u4e86 <code>Dynamo</code> \u6570\u636e\u5e93\uff0c\u7136\u540e\u6dfb\u52a0\u4e86\u4e00\u4e2a <code>X</code>\u8282\u70b9\uff0c\u8be5\u8282\u70b9\u88ab\u5206\u914d\u5230\u4e86\u5982\u4e0b\u56fe\u6240\u793a\u7684<code>A</code>\u548c <code>B</code> \u8282\u70b9\u4e4b\u95f4\u3002</p> <p></p> <p>\u65b0\u5f15\u5165\u7684\u8282\u70b9 <code>X</code> \u4f1a\u4ece\u4e09\u4e2a\u8282\u70b9 <code>C\u3001D\u3001E</code> \u4e2d\u63a5\u53d7\u5b83\u4eec\u7ba1\u7406\u7684\u5206\u7247\u7684\u4e00\u90e8\u5206\uff0c\u4e5f\u5c31\u662f\u4e0a\u56fe\u4e2d\u5f69\u8272\u7684<code>(E, A]</code>\u3001<code>(A, B]</code> \u548c <code>(B, X]</code> \u4e09\u4e2a\u90e8\u5206\uff0c\u5728 <code>X</code> \u8282\u70b9\u52a0\u5165\u96c6\u7fa4\u4e4b\u524d\u5206\u522b\u5c5e\u4e8e\u4e0e\u5176\u989c\u8272\u76f8\u540c\u7684\u8282\u70b9\u7ba1\u7406\u3002</p> <p><code>Dynamo</code> \u7531\u4e8e\u5176\u53bb\u4e2d\u5fc3\u5316\u7684\u67b6\u6784\uff0c\u8282\u70b9\u589e\u5220\u7684\u4e8b\u4ef6\u90fd\u9700\u8981\u901a\u8fc7 <code>Gossip</code> \u534f\u8bae\u8fdb\u884c\u4f20\u9012\uff0c\u7136\u800c\u62e5\u6709\u4e3b\u4ece\u8282\u70b9\u4e4b\u5206\u7684 <code>Bigtable</code> \u5c31\u4e0d\u9700\u8981\u4e0a\u8ff0\u7684\u65b9\u5f0f\u5bf9\u96c6\u7fa4\u4e2d\u7684\u8282\u70b9\u8fdb\u884c\u589e\u5220\u4e86\uff0c\u5b83\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u7528\u4e8e\u7ba1\u7406\u5176\u4ed6\u4ece\u8282\u70b9\u7684\u670d\u52a1\u76f4\u63a5\u6ce8\u518c\u65b0\u7684\u8282\u70b9\u6216\u8005\u64a4\u4e0b\u5df2\u6709\u7684\u8282\u70b9\u3002</p>"},{"location":"aws/2dydb1/#7","title":"7 \u526f\u672c\u540c\u6b65","text":"<p>\u5728 Dynamo \u8fd0\u884c\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7531\u4e8e\u4e00\u4e9b\u60c5\u51b5\u4f1a\u9020\u6210\u4e0d\u540c\u8282\u70b9\u4e2d\u7684\u6570\u636e\u4e0d\u4e00\u81f4\u7684\u95ee\u9898\uff0cDynamo \u4f7f\u7528\u4e86\u53cd\u4fe1\u606f\u71b5\uff08anti-entropy\uff09\u7684\u7b56\u7565\u4fdd\u8bc1\u6240\u6709\u7684\u526f\u672c\u5b58\u50a8\u7684\u4fe1\u606f\u90fd\u662f\u540c\u6b65\u7684\u3002</p> <p>\u4e3a\u4e86\u5feb\u901f\u786e\u8ba4\u591a\u4e2a\u526f\u672c\u4e4b\u95f4\u7684\u6570\u636e\u7684\u4e00\u81f4\u6027\u5e76\u907f\u514d\u5927\u91cf\u7684\u6570\u636e\u4f20\u8f93\uff0c<code>Dynamo</code>\u4f7f\u7528\u4e86 Merkle tree \u5bf9\u4e0d\u540c\u8282\u70b9\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u5feb\u901f\u9a8c\u8bc1\u3002</p> <p></p> <p>\u5728 Merkle \u6811\u4e2d\uff0c\u6240\u6709\u7236\u8282\u70b9\u4e2d\u7684\u5185\u5bb9\u90fd\u662f\u53f6\u5b50\u8282\u70b9\u7684\u54c8\u5e0c\uff0c\u901a\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u6784\u5efa\u7684\u6811\u5f62\u7ed3\u6784\u80fd\u591f\u4fdd\u8bc1\u6574\u68f5\u6811\u4e0d\u4f1a\u88ab\u7be1\u6539\uff0c\u4efb\u4f55\u7684\u6539\u52a8\u90fd\u80fd\u88ab\u7acb\u523b\u53d1\u73b0\u3002</p> <p><code>Dynamo</code> \u4e2d\u7684\u6bcf\u4e00\u4e2a\u8282\u70b9\u90fd\u4e3a\u5176\u6301\u6709\u7684\u952e\u7684\u8303\u56f4\u7ef4\u62a4\u4e86\u4e00\u9897 <code>Merkle</code> \u6811\uff0c\u5728\u9a8c\u8bc1\u4e24\u4efd\u8282\u70b9\u4e2d\u7684\u6570\u636e\u662f\u5426\u76f8\u540c\u65f6\uff0c\u53ea\u9700\u8981\u53d1\u9001\u6839\u8282\u70b9\u4e2d\u7684\u54c8\u5e0c\u503c\uff0c\u5982\u679c\u76f8\u540c\u90a3\u4e48\u8bf4\u660e\u4e24\u68f5\u6811\u7684\u5185\u5bb9\u5168\u90e8\u76f8\u540c\uff0c\u5426\u5219\u5c31\u4f1a\u4f9d\u6b21\u5bf9\u6bd4\u4e0d\u540c\u5c42\u7ea7\u8282\u70b9\u4e2d\u7684\u5185\u5bb9\uff0c\u76f4\u5230\u627e\u51fa\u4e0d\u540c\u7684\u526f\u672c\uff0c\u8fd9\u79cd\u505a\u6cd5\u867d\u7136\u80fd\u591f\u51cf\u5c11\u6570\u636e\u7684\u4f20\u8f93\u5e76\u80fd\u591f\u5feb\u901f\u627e\u5230\u526f\u672c\u4e4b\u95f4\u7684\u4e0d\u540c\uff0c\u4f46\u662f\u5f53\u6709\u65b0\u7684\u8282\u70b9\u52a0\u5165\u6216\u8005\u65e7\u7684\u8282\u70b9\u9000\u51fa\u65f6\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684 <code>Merkle</code> \u6811\u91cd\u65b0\u8ba1\u7b97\u3002</p>"},{"location":"aws/2dydb1/#8","title":"8 \u603b\u7ed3","text":"<p>\u5728 Dynamo \u7684\u8bba\u6587\u516c\u5f00\u4e4b\u540e\uff0c\u6709\u4e00\u7bc7\u6587\u7ae0\u5c06 <code>Dynamo</code> \u7684\u8bbe\u8ba1\u79f0\u4f5c \u201cA flawed architecture\u201d\uff0c\u8fd9\u7bc7\u6587\u7ae0\u7684\u4f5c\u8005\u5728\u6587\u4e2d\u5bf9 Dynamo \u7684\u5b9e\u73b0\u8fdb\u884c\u4e86\u5206\u6790\uff0c\u4e3b\u8981\u5bf9\u5176\u6700\u7ec8\u4e00\u81f4\u6027\u548c <code>Quorom</code> \u673a\u5236\u8fdb\u884c\u4e86\u6279\u8bc4\uff0c\u800c Amazon \u7684 CTO \u5bf9\u4e8e\u8fd9\u7bc7\u6587\u7ae0\u4e5f\u53d1\u4e86\u4e00\u6761 Twitter\uff1a</p> <p></p> <p>\u4e0d\u7ba1\u5982\u4f55\uff0cDynamo \u4f5c\u4e3a\u652f\u6491\u4e9a\u9a6c\u900a\u4e1a\u52a1\u7684\u5e95\u5c42\u670d\u52a1\uff0c\u5176\u5b9e\u73b0\u539f\u7406\u548c\u601d\u60f3\u5bf9\u4e8e\u6574\u4e2a\u793e\u533a\u90fd\u662f\u975e\u5e38\u6709\u4ef7\u503c\u7684\uff0c\u7136\u800c\u5b83\u4f7f\u7528\u7684\u53bb\u4e2d\u5fc3\u5316\u7684\u7b56\u7565\u4e5f\u5e26\u4e86\u5f88\u591a\u95ee\u9898\uff0c\u867d\u7136\u4f5c\u8005\u53ef\u80fd\u4f1a\u56e0\u4e3a\u8fd9\u4e2a\u539f\u56e0\u5728\u9009\u62e9\u6570\u636e\u5e93\u65f6\u4e0d\u4f1a Dynamo\uff0c\u4e0d\u8fc7\u76f8\u4fe1\u5b83\u4e5f\u662f\u6709\u5408\u9002\u7684\u5e94\u7528\u573a\u666f\u7684\u3002</p>"},{"location":"chap1/1mysql_exec/","title":"\u7b2c\u4e00\u8282 \u57fa\u7840\u67b6\u6784\uff1a\u6267\u884c\u4e00\u6761SQL\u67e5\u8be2\u8bed\u53e5","text":"<p>\u5e73\u65f6\u6211\u4eec\u4f7f\u7528\u6570\u636e\u5e93\uff0c\u770b\u5230\u7684\u901a\u5e38\u90fd\u662f\u4e00\u4e2a\u6574\u4f53\u3002\u6bd4\u5982\uff0c\u4f60\u6709\u4e2a\u6700\u7b80\u5355\u7684\u8868\uff0c\u8868\u91cc\u53ea\u6709\u4e00\u4e2a ID \u5b57\u6bb5\uff0c\u5728\u6267\u884c\u4e0b\u9762\u8fd9\u4e2a\u67e5\u8be2\u8bed\u53e5\u65f6\uff1a</p> <pre><code>mysql&gt; select * from T where ID=10\uff1b\n</code></pre> <p>\u4e0b\u9762\u662f MySQL \u7684\u57fa\u672c\u67b6\u6784\u793a\u610f\u56fe\uff0c\u53ef\u4ee5\u770b\u5230 SQL \u8bed\u53e5\u5728 MySQL \u7684\u5404\u4e2a\u529f\u80fd\u6a21\u5757\u4e2d\u7684\u6267\u884c\u8fc7\u7a0b\u3002</p> <p></p> <p>MySQL \u7684\u903b\u8f91\u67b6\u6784\u56fe</p> <p>MySQL \u53ef\u4ee5\u5206\u4e3a Server \u5c42\u548c\u5b58\u50a8\u5f15\u64ce\u5c42\u4e24\u90e8\u5206\u3002</p> <p>Server \u5c42\u5305\u62ec\u8fde\u63a5\u5668\u3001\u67e5\u8be2\u7f13\u5b58\u3001\u5206\u6790\u5668\u3001\u4f18\u5316\u5668\u3001\u6267\u884c\u5668\u7b49\uff0c\u6db5\u76d6 MySQL \u7684\u5927\u591a\u6570\u6838\u5fc3\u670d\u52a1\u529f\u80fd\uff0c\u4ee5\u53ca\u6240\u6709\u7684\u5185\u7f6e\u51fd\u6570\uff08\u5982\u65e5\u671f\u3001\u65f6\u95f4\u3001\u6570\u5b66\u548c\u52a0\u5bc6\u51fd\u6570\u7b49\uff09\uff0c\u6240\u6709\u8de8\u5b58\u50a8\u5f15\u64ce\u7684\u529f\u80fd\u90fd\u5728\u8fd9\u4e00\u5c42\u5b9e\u73b0\uff0c\u6bd4\u5982\u5b58\u50a8\u8fc7\u7a0b\u3001\u89e6\u53d1\u5668\u3001\u89c6\u56fe\u7b49\u3002</p> <p>\u5b58\u50a8\u5f15\u64ce\u5c42\u8d1f\u8d23\u6570\u636e\u7684\u5b58\u50a8\u548c\u63d0\u53d6\u3002</p> <p>\u5176\u67b6\u6784\u6a21\u5f0f\u662f\u63d2\u4ef6\u5f0f\u7684\uff0c\u652f\u6301 InnoDB\u3001MyISAM\u3001Memory \u7b49\u591a\u4e2a\u5b58\u50a8\u5f15\u64ce\u3002</p> <p>\u73b0\u5728\u6700\u5e38\u7528\u7684\u5b58\u50a8\u5f15\u64ce\u662f InnoDB\uff0c\u5b83\u4ece MySQL 5.5.5 \u7248\u672c\u5f00\u59cb\u6210\u4e3a\u4e86\u9ed8\u8ba4\u5b58\u50a8\u5f15\u64ce\u3002</p> <ul> <li>\u6267\u884c create table \u5efa\u8868\u7684\u65f6\u5019\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u5f15\u64ce\u7c7b\u578b\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684\u5c31\u662f InnoDB\u3002</li> <li>\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6307\u5b9a\u5b58\u50a8\u5f15\u64ce\u7684\u7c7b\u578b\u6765\u9009\u62e9\u522b\u7684\u5f15\u64ce\uff0c\u6bd4\u5982\u5728 create table \u8bed\u53e5\u4e2d\u4f7f\u7528 engine=memory, \u6765\u6307\u5b9a\u4f7f\u7528\u5185\u5b58\u5f15\u64ce\u521b\u5efa\u8868\u3002</li> </ul> <p>\u4e0d\u540c\u7684\u5b58\u50a8\u5f15\u64ce\u5171\u7528\u4e00\u4e2a Server \u5c42\uff0c\u4e5f\u5c31\u662f\u4ece\u8fde\u63a5\u5668\u5230\u6267\u884c\u5668\u7684\u90e8\u5206</p>"},{"location":"chap1/1mysql_exec/#1","title":"1\u3001\u8fde\u63a5\u5668","text":"<p>\u7b2c\u4e00\u6b65\uff0c\u8fde\u63a5\u5668\u8d1f\u8d23\u8ddf\u5ba2\u6237\u7aef\u5efa\u7acb\u8fde\u63a5\u3001\u83b7\u53d6\u6743\u9650\u3001\u7ef4\u6301\u548c\u7ba1\u7406\u8fde\u63a5\u3002</p> <pre><code>mysql -h $ip -P $port -u $user -p\n</code></pre> <p>\u8fde\u63a5\u547d\u4ee4\u4e2d\u7684 mysql \u662f\u5ba2\u6237\u7aef\u5de5\u5177\uff0c\u7528\u6765\u8ddf\u670d\u52a1\u7aef\u5efa\u7acb\u8fde\u63a5\u3002\u5728\u5b8c\u6210\u7ecf\u5178\u7684 TCP \u63e1\u624b\u540e\uff0c\u8fde\u63a5\u5668\u5c31\u8981\u5f00\u59cb\u8ba4\u8bc1\u4f60\u7684\u8eab\u4efd\uff0c\u8fd9\u4e2a\u65f6\u5019\u7528\u7684\u5c31\u662f\u4f60\u8f93\u5165\u7684\u7528\u6237\u540d\u548c\u5bc6\u7801\u3002</p> <ul> <li>\u5982\u679c\u7528\u6237\u540d\u6216\u5bc6\u7801\u4e0d\u5bf9\uff0c\u4f60\u5c31\u4f1a\u6536\u5230\u4e00\u4e2a\"Access denied for user\"\u7684\u9519\u8bef\uff0c\u7136\u540e\u5ba2\u6237\u7aef\u7a0b\u5e8f\u7ed3\u675f\u6267\u884c\u3002</li> <li>\u5982\u679c\u7528\u6237\u540d\u5bc6\u7801\u8ba4\u8bc1\u901a\u8fc7\uff0c\u8fde\u63a5\u5668\u4f1a\u5230\u6743\u9650\u8868\u91cc\u9762\u67e5\u51fa\u4f60\u62e5\u6709\u7684\u6743\u9650\u3002\u4e4b\u540e\uff0c\u8fd9\u4e2a\u8fde\u63a5\u91cc\u9762\u7684\u6743\u9650\u5224\u65ad\u903b\u8f91\uff0c\u90fd\u5c06\u4f9d\u8d56\u4e8e\u6b64\u65f6\u8bfb\u5230\u7684\u6743\u9650\u3002</li> </ul> <p>\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u4e00\u4e2a\u7528\u6237\u6210\u529f\u5efa\u7acb\u8fde\u63a5\u540e\uff0c\u5373\u4f7f\u4f60\u7528\u7ba1\u7406\u5458\u8d26\u53f7\u5bf9\u8fd9\u4e2a\u7528\u6237\u7684\u6743\u9650\u505a\u4e86\u4fee\u6539\uff0c\u4e5f\u4e0d\u4f1a\u5f71\u54cd\u5df2\u7ecf\u5b58\u5728\u8fde\u63a5\u7684\u6743\u9650\u3002</p> <p>\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u53ea\u6709\u518d\u65b0\u5efa\u7684\u8fde\u63a5\u624d\u4f1a\u4f7f\u7528\u65b0\u7684\u6743\u9650\u8bbe\u7f6e\u3002</p> <p>\u8fde\u63a5\u5b8c\u6210\u540e\uff0c\u5982\u679c\u4f60\u6ca1\u6709\u540e\u7eed\u7684\u52a8\u4f5c\uff0c\u8fd9\u4e2a\u8fde\u63a5\u5c31\u5904\u4e8e\u7a7a\u95f2\u72b6\u6001\uff0c\u4f60\u53ef\u4ee5\u5728 <code>show processlist</code> \u547d\u4ee4\u4e2d\u770b\u5230\u5b83\u3002</p> <pre><code>show processlist;\n</code></pre> <p>\u6587\u672c\u4e2d\u8fd9\u4e2a\u56fe\u662f <code>show processlist</code> \u7684\u7ed3\u679c\uff0c\u5176\u4e2d\u7684 <code>Command</code> \u5217\u663e\u793a\u4e3a<code>\u201cSleep\u201d</code> \u7684\u8fd9\u4e00\u884c\uff0c\u5c31\u8868\u793a\u73b0\u5728\u7cfb\u7edf\u91cc\u9762\u6709\u4e00\u4e2a\u7a7a\u95f2\u8fde\u63a5\u3002</p> <p></p> <ul> <li>\u5ba2\u6237\u7aef\u5982\u679c\u592a\u957f\u65f6\u95f4\u6ca1\u52a8\u9759\uff0c\u8fde\u63a5\u5668\u5c31\u4f1a\u81ea\u52a8\u5c06\u5b83\u65ad\u5f00\u3002</li> <li>\u8fd9\u4e2a\u65f6\u95f4\u662f\u7531\u53c2\u6570 <code>wait_timeout</code> \u63a7\u5236\u7684\uff0c\u9ed8\u8ba4\u503c\u662f 8 \u5c0f\u65f6\u3002</li> </ul> <pre><code>mysql&gt; show variables like 'wait_timeout';\n</code></pre> <ul> <li>\u5982\u679c\u5728\u8fde\u63a5\u88ab\u65ad\u5f00\u4e4b\u540e\uff0c\u5ba2\u6237\u7aef\u518d\u6b21\u53d1\u9001\u8bf7\u6c42\u7684\u8bdd\uff0c\u5c31\u4f1a\u6536\u5230\u4e00\u4e2a\u9519\u8bef\u63d0\u9192\uff1a Lost connection to MySQL server during query\u3002\u8fd9\u65f6\u5019\u5982\u679c\u4f60\u8981\u7ee7\u7eed\uff0c\u5c31\u9700\u8981\u91cd\u8fde\uff0c\u7136\u540e\u518d\u6267\u884c\u8bf7\u6c42\u4e86\u3002</li> </ul> <p>\u957f\u77ed\u94fe\u63a5</p> <ul> <li>\u6570\u636e\u5e93\u91cc\u9762\uff0c\u957f\u8fde\u63a5\u662f\u6307\u8fde\u63a5\u6210\u529f\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u6301\u7eed\u6709\u8bf7\u6c42\uff0c\u5219\u4e00\u76f4\u4f7f\u7528\u540c\u4e00\u4e2a\u8fde\u63a5\u3002</li> <li>\u77ed\u8fde\u63a5\u5219\u662f\u6307\u6bcf\u6b21\u6267\u884c\u5b8c\u5f88\u5c11\u7684\u51e0\u6b21\u67e5\u8be2\u5c31\u65ad\u5f00\u8fde\u63a5\uff0c\u4e0b\u6b21\u67e5\u8be2\u518d\u91cd\u65b0\u5efa\u7acb\u4e00\u4e2a\u3002</li> <li>\u4f7f\u7528\u4e2d\u8981\u5c3d\u91cf\u51cf\u5c11\u5efa\u7acb\u8fde\u63a5\u7684\u52a8\u4f5c\uff0c\u4e5f\u5c31\u662f\u5c3d\u91cf\u4f7f\u7528\u957f\u8fde\u63a5\u3002</li> </ul> <p>\u6570\u636e\u5e93\u8fde\u63a5\u662f\u9ad8cost \u7684\uff0c\u5927\u90e8\u5206\u5e76\u53d1\u4e1a\u52a1\u5f71\u5efa\u8bae\u4e0d\u8981\u4f7f\u7528\u77ed\u94fe\u63a5</p> <p>\u4f46\u662f\u5168\u90e8\u4f7f\u7528\u957f\u8fde\u63a5\u540e\uff0c\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\uff0c\u6709\u4e9b\u65f6\u5019 MySQL \u5360\u7528\u5185\u5b58\u6da8\u5f97\u7279\u522b\u5feb\uff0c\u8fd9\u662f\u56e0\u4e3a MySQL \u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u4e34\u65f6\u4f7f\u7528\u7684\u5185\u5b58\u662f\u7ba1\u7406\u5728\u8fde\u63a5\u5bf9\u8c61\u91cc\u9762\u7684\u3002\u8fd9\u4e9b\u8d44\u6e90\u4f1a\u5728\u8fde\u63a5\u65ad\u5f00\u7684\u65f6\u5019\u624d\u91ca\u653e\u3002</p> <p>\u6240\u4ee5\u5982\u679c\u957f\u8fde\u63a5\u7d2f\u79ef\u4e0b\u6765\uff0c\u53ef\u80fd\u5bfc\u81f4\u5185\u5b58\u5360\u7528\u592a\u5927\uff0c\u88ab\u7cfb\u7edf\u5f3a\u884c\u6740\u6389\uff08OOM\uff09\uff0c\u4ece\u73b0\u8c61\u770b\u5c31\u662f MySQL \u5f02\u5e38\u91cd\u542f\u4e86\u3002</p> <p>mysql\u6267\u884c\u4e2d\u4e00\u4e9b\u6570\u636e\u7ed1\u5b9a\u5728\u8fde\u63a5\u5bf9\u8c61\u4e2d\uff0c\u56e0\u4e3a\u957f\u8fde\u63a5\u957f\u65f6\u95f4\u4e0d\u65ad\u5f00\u5bfc\u81f4\u5185\u5b58\u5360\u7528\u592a\u591a\u3002\u53ef\u4ee5\u4f7f\u7528\u5b9a\u65f6\u8d85\u65f6\u65ad\u5f00\uff0c\u6216\u901a\u8fc7\u91cd\u65b0\u521d\u59cb\u5316\u94fe\u63a5\u6765\u6e05\u7a7a\u3002</p> <p>\u4e24\u79cd\u65b9\u6848:</p> <ol> <li>\u5b9a\u671f\u65ad\u5f00\u957f\u8fde\u63a5\u3002\u4f7f\u7528\u4e00\u6bb5\u65f6\u95f4\uff0c\u6216\u8005\u7a0b\u5e8f\u91cc\u9762\u5224\u65ad\u6267\u884c\u8fc7\u4e00\u4e2a\u5360\u7528\u5185\u5b58\u7684\u5927\u67e5\u8be2\u540e\uff0c\u65ad\u5f00\u8fde\u63a5\uff0c\u4e4b\u540e\u8981\u67e5\u8be2\u518d\u91cd\u8fde\u3002(\u5b9a\u671f\u65ad\u5f00\u94fe\u63a5)</li> <li>\u5982\u679c\u4f60\u7528\u7684\u662f MySQL 5.7 \u6216\u66f4\u65b0\u7248\u672c\uff0c\u53ef\u4ee5\u5728\u6bcf\u6b21\u6267\u884c\u4e00\u4e2a\u6bd4\u8f83\u5927\u7684\u64cd\u4f5c\u540e\uff0c\u901a\u8fc7\u6267\u884c <code>mysql_reset_connection</code>  \u6765\u91cd\u65b0\u521d\u59cb\u5316\u8fde\u63a5\u8d44\u6e90\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e0d\u9700\u8981\u91cd\u8fde\u548c\u91cd\u65b0\u505a\u6743\u9650\u9a8c\u8bc1\uff0c\u4f46\u662f\u4f1a\u5c06\u8fde\u63a5\u6062\u590d\u5230\u521a\u521a\u521b\u5efa\u5b8c\u65f6\u7684\u72b6\u6001\u3002</li> </ol>"},{"location":"chap1/1mysql_exec/#2","title":"2\u3001\u67e5\u8be2\u7f13\u5b58","text":"<p>\u8fde\u63a5\u5efa\u7acb\u5b8c\u6210\u540e\uff0c\u4f60\u5c31\u53ef\u4ee5\u6267\u884c select \u8bed\u53e5\u4e86\u3002\u6267\u884c\u903b\u8f91\u5c31\u4f1a\u6765\u5230\u7b2c\u4e8c\u6b65\uff1a\u67e5\u8be2\u7f13\u5b58\u3002</p> <ul> <li>MySQL \u62ff\u5230\u4e00\u4e2a\u67e5\u8be2\u8bf7\u6c42\u540e\uff0c\u4f1a\u5148\u5230\u67e5\u8be2\u7f13\u5b58\u770b\u770b\uff0c\u4e4b\u524d\u662f\u4e0d\u662f\u6267\u884c\u8fc7\u8fd9\u6761\u8bed\u53e5</li> <li>\u4e4b\u524d\u6267\u884c\u8fc7\u7684\u8bed\u53e5\u53ca\u5176\u7ed3\u679c\u53ef\u80fd\u4f1a\u4ee5 <code>key-value</code> \u5bf9\u7684\u5f62\u5f0f\uff0c\u88ab\u76f4\u63a5\u7f13\u5b58\u5728\u5185\u5b58\u4e2d <ul> <li>key \u662f\u67e5\u8be2\u7684\u8bed\u53e5\uff0cvalue \u662f\u67e5\u8be2\u7684\u7ed3\u679c</li> <li>\u5982\u679c\u4f60\u7684\u67e5\u8be2\u80fd\u591f\u76f4\u63a5\u5728\u8fd9\u4e2a\u7f13\u5b58\u4e2d\u627e\u5230 key\uff0c\u90a3\u4e48\u8fd9\u4e2a value \u5c31\u4f1a\u88ab\u76f4\u63a5\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ul> </li> </ul> <p>8.0 \u5df2\u7ecf\u6ca1\u6709\u67e5\u8be2\u7f13\u5b58\u7684\u673a\u5236\u4e86</p> <p>\u5982\u679c\u8bed\u53e5\u4e0d\u5728\u67e5\u8be2\u7f13\u5b58\u4e2d\uff0c\u5c31\u4f1a\u7ee7\u7eed\u540e\u9762\u7684\u6267\u884c\u9636\u6bb5\u3002\u6267\u884c\u5b8c\u6210\u540e\uff0c\u6267\u884c\u7ed3\u679c\u4f1a\u88ab\u5b58\u5165\u67e5\u8be2\u7f13\u5b58\u4e2d\u3002</p> <p>\u5982\u679c\u67e5\u8be2\u547d\u4e2d\u7f13\u5b58\uff0cMySQL \u4e0d\u9700\u8981\u6267\u884c\u540e\u9762\u7684\u590d\u6742\u64cd\u4f5c\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c\uff0c\u8fd9\u4e2a\u6548\u7387\u4f1a\u5f88\u9ad8\u3002</p> <p>\u4f46\u662f\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u6211\u4f1a\u5efa\u8bae\u4f60\u4e0d\u8981\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\uff0c\u4e3a\u4ec0\u4e48\u5462\uff1f\u56e0\u4e3a\u67e5\u8be2\u7f13\u5b58\u5f80\u5f80\u5f0a\u5927\u4e8e\u5229\u3002</p> <ul> <li>\u7f13\u5b58\u9700\u8981\u8bed\u53e5\u5b8c\u5168\u76f8\u7b49\uff0c\u5305\u62ec\u53c2\u6570</li> <li>\u8868\u66f4\u65b0\u540e\u5c31\u4f1a\u5931\u6548 \u56e0\u6b64\uff0c\u53ea\u6709\u5728\u8868\u66f4\u65b0\u9891\u7387\u4e0d\u9ad8\uff0c\u67e5\u8be2\u8bed\u53e5\u5b8c\u5168\u4e00\u81f4\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u624b\u52a8\u5f00\u542f\u7f13\u5b58\uff0c\u5176\u4ed6\u4e00\u5f8b\u5173\u95ed\u3002</li> <li>mysql8\u4e4b\u540e\uff0c\u53d6\u6d88\u4e86\u7f13\u5b58\u529f\u80fd\u3002</li> </ul> <p>\u67e5\u8be2\u7f13\u5b58\u7684\u5931\u6548\u975e\u5e38\u9891\u7e41\uff0c\u53ea\u8981\u6709\u5bf9\u4e00\u4e2a\u8868\u7684\u66f4\u65b0\uff0c\u8fd9\u4e2a\u8868\u4e0a\u6240\u6709\u7684\u67e5\u8be2\u7f13\u5b58\u90fd\u4f1a\u88ab\u6e05\u7a7a,\u5bf9\u4e8e\u66f4\u65b0\u538b\u529b\u5927\u7684\u6570\u636e\u5e93\u6765\u8bf4\uff0c\u67e5\u8be2\u7f13\u5b58\u7684\u547d\u4e2d\u7387\u4f1a\u975e\u5e38\u4f4e\u3002\u9664\u975e\u4f60\u7684\u4e1a\u52a1\u5c31\u662f\u6709\u4e00\u5f20\u9759\u6001\u8868\uff0c\u5f88\u957f\u65f6\u95f4\u624d\u4f1a\u66f4\u65b0\u4e00\u6b21\u3002\u6bd4\u5982\uff0c\u4e00\u4e2a\u7cfb\u7edf\u914d\u7f6e\u8868\uff0c\u90a3\u8fd9\u5f20\u8868\u4e0a\u7684\u67e5\u8be2\u624d\u9002\u5408\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u3002</p> <p>\u597d\u5728 MySQL \u4e5f\u63d0\u4f9b\u4e86\u8fd9\u79cd\u201c\u6309\u9700\u4f7f\u7528\u201d\u7684\u65b9\u5f0f\u3002</p> <ul> <li>\u4f60\u53ef\u4ee5\u5c06\u53c2\u6570 <code>query_cache_type</code> \u8bbe\u7f6e\u6210 <code>DEMAND</code>\uff0c\u8fd9\u6837\u5bf9\u4e8e\u9ed8\u8ba4\u7684 <code>SQL</code> \u8bed\u53e5\u90fd\u4e0d\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u3002</li> <li>\u800c\u5bf9\u4e8e\u4f60\u786e\u5b9a\u8981\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u7684\u8bed\u53e5\uff0c\u53ef\u4ee5\u7528 <code>SQL_CACHE</code> \u663e\u5f0f\u6307\u5b9a\uff0c\u50cf\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\u4e00\u6837\uff1a</li> </ul> <pre><code>\nmysql&gt; select SQL_CACHE * from T where ID=10\uff1b\n</code></pre>"},{"location":"chap1/1mysql_exec/#3","title":"3\u3001\u5206\u6790\u5668","text":"<p>\u5982\u679c\u6ca1\u6709\u547d\u4e2d\u67e5\u8be2\u7f13\u5b58\uff0c\u5c31\u8981\u5f00\u59cb\u771f\u6b63\u6267\u884c\u8bed\u53e5\u4e86\u3002\u9996\u5148\uff0cMySQL \u9700\u8981\u77e5\u9053\u4f60\u8981\u505a\u4ec0\u4e48\uff0c\u56e0\u6b64\u9700\u8981\u5bf9 SQL \u8bed\u53e5\u505a\u89e3\u6790\u3002</p> <p>\u5206\u6790\u5668\u5148\u4f1a\u505a\u201c\u8bcd\u6cd5\u5206\u6790\u201d\u3002\u4f60\u8f93\u5165\u7684\u662f\u7531\u591a\u4e2a\u5b57\u7b26\u4e32\u548c\u7a7a\u683c\u7ec4\u6210\u7684\u4e00\u6761 SQL \u8bed\u53e5\uff0cMySQL \u9700\u8981\u8bc6\u522b\u51fa\u91cc\u9762\u7684\u5b57\u7b26\u4e32\u5206\u522b\u662f\u4ec0\u4e48\uff0c\u4ee3\u8868\u4ec0\u4e48\u3002</p> <p><code>MySQL</code> \u4ece\u4f60\u8f93\u5165\u7684\"select\"\u8fd9\u4e2a\u5173\u952e\u5b57\u8bc6\u522b\u51fa\u6765\uff0c\u8fd9\u662f\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u3002</p> <p>\u5b83\u4e5f\u8981\u628a\u5b57\u7b26\u4e32\u201cT\u201d\u8bc6\u522b\u6210\u201c\u8868\u540d T\u201d\uff0c\u628a\u5b57\u7b26\u4e32\u201cID\u201d\u8bc6\u522b\u6210\u201c\u5217 ID\u201d\u3002</p> <ul> <li>\u89e3\u6790\u8bed\u53e5\uff0c\u751f\u6210\u89e3\u6790\u6811 </li> <li>\u68c0\u67e5\u8bed\u53e5\u4e2d\u7684\u5173\u952e\u8bcd\uff0c\u8868\uff0c\u5b57\u6bb5\u662f\u5426\u5b58\u5728</li> </ul> <p>\u5982\u679c\u4f60\u7684\u8bed\u53e5\u4e0d\u5bf9\uff0c\u5c31\u4f1a\u6536\u5230<code>\u201cYou have an error in your SQL syntax\u201d</code>\u7684\u9519\u8bef\u63d0\u9192\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5 select \u5c11\u6253\u4e86\u5f00\u5934\u7684\u5b57\u6bcd\u201cs\u201d\u3002</p> <pre><code>mysql&gt; elect * from t where ID=1;\n\nERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'elect * from t where ID=1' at line 1\n</code></pre> <p><code>use near 'elect * from t where ID=1' at line 1</code></p> <p>\u4e00\u822c\u8bed\u6cd5\u9519\u8bef\u4f1a\u63d0\u793a\u7b2c\u4e00\u4e2a\u51fa\u73b0\u9519\u8bef\u7684\u4f4d\u7f6e\uff0c\u6240\u4ee5\u4f60\u8981\u5173\u6ce8\u7684\u662f\u7d27\u63a5\u201cuse near\u201d\u7684\u5185\u5bb9\u3002</p>"},{"location":"chap1/1mysql_exec/#4","title":"4\u3001\u4f18\u5316\u5668","text":"<p>\u7ecf\u8fc7\u4e86\u5206\u6790\u5668\uff0cMySQL \u5c31\u77e5\u9053\u4f60\u8981\u505a\u4ec0\u4e48\u4e86\u3002\u5728\u5f00\u59cb\u6267\u884c\u4e4b\u524d\uff0c\u8fd8\u8981\u5148\u7ecf\u8fc7\u4f18\u5316\u5668\u7684\u5904\u7406\u3002</p> <ul> <li>\u4f18\u5316\u5668\u662f\u5728\u8868\u91cc\u9762\u6709\u591a\u4e2a\u7d22\u5f15\u7684\u65f6\u5019\uff0c\u51b3\u5b9a\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\uff1b</li> <li>\u6216\u8005\u5728\u4e00\u4e2a\u8bed\u53e5\u6709\u591a\u8868\u5173\u8054\uff08join\uff09\u7684\u65f6\u5019\uff0c\u51b3\u5b9a\u5404\u4e2a\u8868\u7684\u8fde\u63a5\u987a\u5e8f\u3002</li> </ul> <p>\u5c3d\u53ef\u80fd\u626b\u63cf\u5c11\u7684\u6570\u636e\u5e93\u884c\u7eaa\u5f55</p> <pre><code>mysql&gt; select * from t1 join t2 using(ID)  where t1.c=10 and t2.d=20;\n</code></pre> <ul> <li>\u65e2\u53ef\u4ee5\u5148\u4ece\u8868 t1 \u91cc\u9762\u53d6\u51fa c=10 \u7684\u8bb0\u5f55\u7684 ID \u503c\uff0c\u518d\u6839\u636e ID \u503c\u5173\u8054\u5230\u8868 t2\uff0c\u518d\u5224\u65ad t2 \u91cc\u9762 d \u7684\u503c\u662f\u5426\u7b49\u4e8e 20\u3002</li> <li>\u4e5f\u53ef\u4ee5\u5148\u4ece\u8868 t2 \u91cc\u9762\u53d6\u51fa d=20 \u7684\u8bb0\u5f55\u7684 ID \u503c\uff0c\u518d\u6839\u636e ID \u503c\u5173\u8054\u5230 t1\uff0c\u518d\u5224\u65ad t1 \u91cc\u9762 c \u7684\u503c\u662f\u5426\u7b49\u4e8e 10\u3002</li> </ul> <p>\u8fd9\u4e24\u79cd\u6267\u884c\u65b9\u6cd5\u7684\u903b\u8f91\u7ed3\u679c\u662f\u4e00\u6837\u7684\uff0c\u4f46\u662f\u6267\u884c\u7684\u6548\u7387\u4f1a\u6709\u4e0d\u540c\uff0c\u800c\u4f18\u5316\u5668\u7684\u4f5c\u7528\u5c31\u662f\u51b3\u5b9a\u9009\u62e9\u4f7f\u7528\u54ea\u4e00\u4e2a\u65b9\u6848\u3002</p>"},{"location":"chap1/1mysql_exec/#5","title":"5\u3001\u6267\u884c\u5668","text":"<p>Mysql\u6267\u884c\u7684\u6d41\u7a0b\u5305\u62ec\u5206\u6790\u5668\u9636\u6bb5\u7684\u8bcd\u6cd5\u5206\u6790\u548c\u8bed\u6cd5\u5206\u6790\uff0c\u4f18\u5316\u5668\u9636\u6bb5\u7684\u7d22\u5f15\u548c\u8fde\u63a5\u987a\u5e8f\u4f18\u5316\uff0c\u6700\u540e\u7531\u6267\u884c\u5668\u5f00\u59cb\u6267\u884c\u3002 </p> <ul> <li>\u5206\u6790\u5668\u89e3\u91ca\u51fa\u4f60\u8981\u505a\u4ec0\u4e48\uff1b</li> <li>\u4f18\u5316\u5668\u89e3\u91ca\u51fa\u4f60\u9700\u8981\u8be5\u600e\u4e48\u505a\uff1b </li> <li>\u6267\u884c\u5668\u8d1f\u8d23\u6267\u884c\u3002</li> </ul> <p>\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\uff0c\u8981\u5148\u5224\u65ad\u4e00\u4e0b\u4f60\u5bf9\u8fd9\u4e2a\u8868 T \u6709\u6ca1\u6709\u6267\u884c\u67e5\u8be2\u7684\u6743\u9650\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5c31\u4f1a\u8fd4\u56de\u6ca1\u6709\u6743\u9650\u7684\u9519\u8bef\uff0c\u5982\u4e0b\u6240\u793a (\u5728\u5de5\u7a0b\u5b9e\u73b0\u4e0a\uff0c\u5982\u679c\u547d\u4e2d\u67e5\u8be2\u7f13\u5b58\uff0c\u4f1a\u5728\u67e5\u8be2\u7f13\u5b58\u8fd4\u56de\u7ed3\u679c\u7684\u65f6\u5019\uff0c\u505a\u6743\u9650\u9a8c\u8bc1\u3002\u67e5\u8be2\u4e5f\u4f1a\u5728\u4f18\u5316\u5668\u4e4b\u524d\u8c03\u7528 precheck \u9a8c\u8bc1\u6743\u9650)\u3002</p> <p>\u6743\u9650\u9a8c\u8bc1\u4e0d\u4ec5\u4ec5\u5728\u6267\u884c\u5668\u8fd9\u90e8\u5206\u4f1a\u505a\uff0c\u5728\u5206\u6790\u5668\u4e4b\u540e\uff0c\u4e5f\u5c31\u662f\u77e5\u9053\u4e86\u8be5\u8bed\u53e5\u8981\u201c\u5e72\u4ec0\u4e48\u201d\u4e4b\u540e\uff0c\u4e5f\u4f1a\u5148\u505a\u4e00\u6b21\u6743\u9650\u9a8c\u8bc1\u3002\u53eb\u505aprecheck\u3002\u800cprecheck\u662f\u65e0\u6cd5\u5bf9\u8fd0\u884c\u65f6\u6d89\u53ca\u5230\u7684\u8868\u8fdb\u884c\u6743\u9650\u9a8c\u8bc1\u7684\uff0c\u6bd4\u5982\u4f7f\u7528\u4e86\u89e6\u53d1\u5668\u7684\u60c5\u51b5\u3002\u56e0\u6b64\u5728\u6267\u884c\u5668\u8fd9\u91cc\u4e5f\u8981\u505a\u4e00\u6b21\u6267\u884c\u65f6\u7684\u6743\u9650\u9a8c\u8bc1\u3002</p> <pre><code>mysql&gt; select * from T where ID=10;\n\nERROR 1142 (42000): SELECT command denied to user 'b'@'localhost' for table 'T'\n</code></pre> <p>\u5982\u679c\u6709\u6743\u9650\uff0c\u5c31\u6253\u5f00\u8868\u7ee7\u7eed\u6267\u884c\u3002\u6253\u5f00\u8868\u7684\u65f6\u5019\uff0c\u6267\u884c\u5668\u5c31\u4f1a\u6839\u636e\u8868\u7684\u5f15\u64ce\u5b9a\u4e49\uff0c\u53bb\u4f7f\u7528\u8fd9\u4e2a\u5f15\u64ce\u63d0\u4f9b\u7684\u63a5\u53e3\u3002</p> <p>\u6bd4\u5982\u6211\u4eec\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\u7684\u8868 T \u4e2d\uff0cID \u5b57\u6bb5\u6ca1\u6709\u7d22\u5f15\uff0c\u90a3\u4e48\u6267\u884c\u5668\u7684\u6267\u884c\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ol> <li>\u8c03\u7528 InnoDB \u5f15\u64ce\u63a5\u53e3\u53d6\u8fd9\u4e2a\u8868\u7684\u7b2c\u4e00\u884c\uff0c\u5224\u65ad ID \u503c\u662f\u4e0d\u662f 10\uff0c\u5982\u679c\u4e0d\u662f\u5219\u8df3\u8fc7\uff0c\u5982\u679c\u662f\u5219\u5c06\u8fd9\u884c\u5b58\u5728\u7ed3\u679c\u96c6\u4e2d\uff1b</li> <li>\u8c03\u7528\u5f15\u64ce\u63a5\u53e3\u53d6\u201c\u4e0b\u4e00\u884c\u201d\uff0c\u91cd\u590d\u76f8\u540c\u7684\u5224\u65ad\u903b\u8f91\uff0c\u76f4\u5230\u53d6\u5230\u8fd9\u4e2a\u8868\u7684\u6700\u540e\u4e00\u884c\u3002</li> <li>\u6267\u884c\u5668\u5c06\u4e0a\u8ff0\u904d\u5386\u8fc7\u7a0b\u4e2d\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u884c\u7ec4\u6210\u7684\u8bb0\u5f55\u96c6\u4f5c\u4e3a\u7ed3\u679c\u96c6\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u3002</li> </ol> <p>\u5bf9\u4e8e\u6709\u7d22\u5f15\u7684\u8868\uff0c\u6267\u884c\u7684\u903b\u8f91\u4e5f\u5dee\u4e0d\u591a\u3002\u7b2c\u4e00\u6b21\u8c03\u7528\u7684\u662f\u201c\u53d6\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u884c\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u4e4b\u540e\u5faa\u73af\u53d6\u201c\u6ee1\u8db3\u6761\u4ef6\u7684\u4e0b\u4e00\u884c\u201d\u8fd9\u4e2a\u63a5\u53e3\uff0c\u8fd9\u4e9b\u63a5\u53e3\u90fd\u662f\u5f15\u64ce\u4e2d\u5df2\u7ecf\u5b9a\u4e49\u597d\u7684\u3002</p> <ul> <li>\u4f60\u4f1a\u5728\u6570\u636e\u5e93\u7684\u6162\u67e5\u8be2\u65e5\u5fd7\u4e2d\u770b\u5230\u4e00\u4e2a <code>rows_examined</code> \u7684\u5b57\u6bb5\uff0c\u8868\u793a\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u8fc7\u7a0b\u4e2d\u626b\u63cf\u4e86\u591a\u5c11\u884c\u3002</li> <li>\u8fd9\u4e2a\u503c\u5c31\u662f\u5728\u6267\u884c\u5668\u6bcf\u6b21\u8c03\u7528\u5f15\u64ce\u83b7\u53d6\u6570\u636e\u884c\u7684\u65f6\u5019\u7d2f\u52a0\u7684\u3002</li> </ul> <p>\u4e00\u4e2a\u662f\u6267\u884c\u5668\u8c03\u7528\u7684\u6b21\u6570\u3002 \u4e00\u4e2a\u662f\u5f15\u64ce\u603b\u5171\u626b\u63cf\u884c\u6570\u3002</p> <p>\u5728\u6709\u4e9b\u573a\u666f\u4e0b\uff0c\u6267\u884c\u5668\u8c03\u7528\u4e00\u6b21\uff0c\u5728\u5f15\u64ce\u5185\u90e8\u5219\u626b\u63cf\u4e86\u591a\u884c\uff0c\u56e0\u6b64\u5f15\u64ce\u626b\u63cf\u884c\u6570\u8ddf <code>rows_examined</code> \u5e76\u4e0d\u662f\u5b8c\u5168\u76f8\u540c\u7684\u3002</p>"},{"location":"chap1/1mysql_exec/#6","title":"6\u3001\u5c0f\u8282\u603b\u7ed3","text":""},{"location":"chap1/1mysql_exec/#6-1","title":"6-1 \u63d0\u95ee","text":"<p>\u5982\u679c\u8868 T \u4e2d\u6ca1\u6709\u5b57\u6bb5 k\uff0c\u800c\u4f60\u6267\u884c\u4e86\u8fd9\u4e2a\u8bed\u53e5 <code>select * from T where k=1</code>, \u90a3\u80af\u5b9a\u662f\u4f1a\u62a5\u201c\u4e0d\u5b58\u5728\u8fd9\u4e2a\u5217\u201d\u7684\u9519\u8bef\uff1a<code>\u201cUnknown column \u2018k\u2019 in \u2018where clause\u2019\u201d</code>\u3002</p> <p>\u4f60\u89c9\u5f97\u8fd9\u4e2a\u9519\u8bef\u662f\u5728\u6211\u4eec\u4e0a\u9762\u63d0\u5230\u7684\u54ea\u4e2a\u9636\u6bb5\u62a5\u51fa\u6765\u7684\u5462\uff1f</p> <p>\u5206\u6790\u5668\u3002</p> <ul> <li>\u89e3\u6790\u8bed\u53e5\uff0c\u751f\u6210\u89e3\u6790\u6811 </li> <li>\u68c0\u67e5\u8bed\u53e5\u4e2d\u7684\u5173\u952e\u8bcd\uff0c\u8868\uff0c\u5b57\u6bb5\u662f\u5426\u5b58\u5728</li> </ul>"},{"location":"chap1/2mysql_logs/","title":"\u7b2c\u4e8c\u8282 \u65e5\u5fd7\u7cfb\u7edf\uff1a\u6267\u884c\u4e00\u6761SQL\u66f4\u65b0\u8bed\u53e5","text":"<p>\u4e00\u6761\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\u4e00\u822c\u662f\u7ecf\u8fc7\u8fde\u63a5\u5668\u3001\u5206\u6790\u5668\u3001\u4f18\u5316\u5668\u3001\u6267\u884c\u5668\u7b49\u529f\u80fd\u6a21\u5757\uff0c\u6700\u540e\u5230\u8fbe\u5b58\u50a8\u5f15\u64ce</p> <p>\u90a3\u4e48\uff0c\u4e00\u6761\u66f4\u65b0\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\u53c8\u662f\u600e\u6837\u7684\u5462\uff1f</p> <p>\u4e0b\u9762\u662f\u8fd9\u4e2a\u8868\u7684\u521b\u5efa\u8bed\u53e5\uff0c\u8fd9\u4e2a\u8868\u6709\u4e00\u4e2a\u4e3b\u952e ID \u548c\u4e00\u4e2a\u6574\u578b\u5b57\u6bb5 c\uff1a</p> <pre><code>mysql&gt; create table T(ID int primary key, c int);\n</code></pre> <p>\u5982\u679c\u8981\u5c06 <code>ID=2</code> \u8fd9\u4e00\u884c\u7684\u503c\u52a0 1\uff0c<code>SQL</code> \u8bed\u53e5\u5c31\u4f1a\u8fd9\u4e48\u5199\uff1a</p> <pre><code>mysql&gt; update T set c=c+1 where ID=2;\n</code></pre> <p></p> <p>\u5728\u4e00\u4e2a\u8868\u4e0a\u6709\u66f4\u65b0\u7684\u65f6\u5019\uff0c\u8ddf\u8fd9\u4e2a\u8868\u6709\u5173\u7684\u67e5\u8be2\u7f13\u5b58\u4f1a\u5931\u6548\uff0c\u6240\u4ee5\u8fd9\u6761\u8bed\u53e5\u5c31\u4f1a\u628a\u8868 T \u4e0a\u6240\u6709\u7f13\u5b58\u7ed3\u679c\u90fd\u6e05\u7a7a\u3002\u8fd9\u4e5f\u5c31\u662f\u6211\u4eec\u4e00\u822c\u4e0d\u5efa\u8bae\u4f7f\u7528\u67e5\u8be2\u7f13\u5b58\u7684\u539f\u56e0\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cMySQL 8.0 \u7248\u672c\u76f4\u63a5\u5c06\u67e5\u8be2\u7f13\u5b58\u7684\u6574\u5757\u529f\u80fd\u5220\u6389\u4e86\uff0c\u4e5f\u5c31\u662f\u8bf4 8.0 \u5f00\u59cb\u5f7b\u5e95\u6ca1\u6709\u8fd9\u4e2a\u529f\u80fd\u4e86\u3002</p> <ul> <li>\u63a5\u4e0b\u6765\uff0c\u5206\u6790\u5668\u4f1a\u901a\u8fc7\u8bcd\u6cd5\u548c\u8bed\u6cd5\u89e3\u6790\u77e5\u9053\u8fd9\u662f\u4e00\u6761\u66f4\u65b0\u8bed\u53e5\u3002</li> <li>\u4f18\u5316\u5668\u51b3\u5b9a\u8981\u4f7f\u7528 ID \u8fd9\u4e2a\u7d22\u5f15\u3002</li> <li>\u7136\u540e\uff0c\u6267\u884c\u5668\u8d1f\u8d23\u5177\u4f53\u6267\u884c\uff0c\u627e\u5230\u8fd9\u4e00\u884c\uff0c\u7136\u540e\u66f4\u65b0\u3002</li> </ul> <p>\u4e0e\u67e5\u8be2\u6d41\u7a0b\u4e0d\u4e00\u6837\u7684\u662f\uff0c\u66f4\u65b0\u6d41\u7a0b\u8fd8\u6d89\u53ca\u4e24\u4e2a\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff0c\u5b83\u4eec\u6b63\u662f\u6211\u4eec\u4eca\u5929\u8981\u8ba8\u8bba\u7684\u4e3b\u89d2\uff1aredo log\uff08\u91cd\u505a\u65e5\u5fd7\uff09\u548c binlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u3002</p>"},{"location":"chap1/2mysql_logs/#1redo-log","title":"1\u3001\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff1aredo log","text":"<p>\u5728 MySQL \u91cc\u4e5f\u6709\u8fd9\u4e2a\u95ee\u9898\uff0c\u5982\u679c\u6bcf\u4e00\u6b21\u7684\u66f4\u65b0\u64cd\u4f5c\u90fd\u9700\u8981\u5199\u8fdb\u78c1\u76d8\uff0c\u7136\u540e\u78c1\u76d8\u4e5f\u8981\u627e\u5230\u5bf9\u5e94\u7684\u90a3\u6761\u8bb0\u5f55\uff0c\u7136\u540e\u518d\u66f4\u65b0\uff0c\u6574\u4e2a\u8fc7\u7a0b IO \u6210\u672c\u3001\u67e5\u627e\u6210\u672c\u90fd\u5f88\u9ad8\u3002</p> <p>IO\u6210\u672c\u5c31\u662f\u5bfb\u5740\u65f6\u95f4\u548c\u4e0a\u7ebf\u6587\u5207\u6362\u6240\u9700\u8981\u7684\u65f6\u95f4\uff0c\u6700\u4e3b\u8981\u662f\u7528\u6237\u6001\u548c\u5185\u6838\u6001\u7684\u4e0a\u4e0b\u6587\u5207\u6362</p> <p>MySQL \u91cc\u7ecf\u5e38\u8bf4\u5230\u7684 WAL \u6280\u672f\uff0cWAL \u7684\u5168\u79f0\u662f <code>Write-Ahead Logging</code>\uff0c\u5b83\u7684\u5173\u952e\u70b9\u5c31\u662f\u5148\u5199\u65e5\u5fd7\uff0c\u518d\u5199\u78c1\u76d8\u3002</p> <p>\u5177\u4f53\u6765\u8bf4\uff0c\u5f53\u6709\u4e00\u6761\u8bb0\u5f55\u9700\u8981\u66f4\u65b0\u7684\u65f6\u5019\uff0cInnoDB \u5f15\u64ce\u5c31\u4f1a\u5148\u628a\u8bb0\u5f55\u5199\u5230 redo log\u91cc\u9762\uff0c\u5e76\u66f4\u65b0\u5185\u5b58\uff0c\u8fd9\u4e2a\u65f6\u5019\u66f4\u65b0\u5c31\u7b97\u5b8c\u6210\u4e86\u3002</p> <p>\u540c\u65f6\uff0cInnoDB \u5f15\u64ce\u4f1a\u5728\u9002\u5f53\u7684\u65f6\u5019\uff0c\u5c06\u8fd9\u4e2a\u64cd\u4f5c\u8bb0\u5f55\u66f4\u65b0\u5230\u78c1\u76d8\u91cc\u9762\uff0c\u800c\u8fd9\u4e2a\u66f4\u65b0\u5f80\u5f80\u662f\u5728\u7cfb\u7edf\u6bd4\u8f83\u7a7a\u95f2\u7684\u65f6\u5019\u505a\u3002</p> <p>InnoDB\u5f15\u64ce\u5148\u628a\u8bb0\u5f55\u5199\u5230redo log \u4e2d\uff0credo log \u5728\u54ea\uff0c\u4ed6\u4e5f\u662f\u5728\u78c1\u76d8\u4e0a\uff0c\u8fd9\u4e5f\u662f\u4e00\u4e2a\u5199\u78c1\u76d8\u7684\u8fc7\u7a0b\uff0c\u4f46\u662f\u4e0e\u66f4\u65b0\u8fc7\u7a0b\u4e0d\u4e00\u6837\u7684\u662f\uff0c\u66f4\u65b0\u8fc7\u7a0b\u662f\u5728\u78c1\u76d8\u4e0a\u968f\u673aIO\uff0c\u8d39\u65f6\u3002 \u800c\u5199redo log \u662f\u5728\u78c1\u76d8\u4e0a\u987a\u5e8fIO\u3002\u6548\u7387\u8981\u9ad8\u3002</p> <p><code>InnoDB</code> \u7684 <code>redo log</code> \u662f\u56fa\u5b9a\u5927\u5c0f\u7684\uff0c\u6bd4\u5982\u53ef\u4ee5\u914d\u7f6e\u4e3a\u4e00\u7ec4 <code>4</code>\u4e2a\u6587\u4ef6\uff0c\u6bcf\u4e2a\u6587\u4ef6\u7684\u5927\u5c0f\u662f <code>1GB</code>\uff0c\u90a3\u4e48\u603b\u5171\u5c31\u53ef\u4ee5\u8bb0\u5f55 4GB \u7684\u64cd\u4f5c\u3002</p> <p>redo log \u662f\u5faa\u73af\u5199\u7684\uff0c\u7a7a\u95f4\u56fa\u5b9a\u4f1a\u7528\u5b8c\uff1b</p> <p>binlog \u662f\u53ef\u4ee5\u8ffd\u52a0\u5199\u5165\u7684\u3002\u201c\u8ffd\u52a0\u5199\u201d\u662f\u6307 binlog \u6587\u4ef6\u5199\u5230\u4e00\u5b9a\u5927\u5c0f\u540e\u4f1a\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\uff0c\u5e76\u4e0d\u4f1a\u8986\u76d6\u4ee5\u524d\u7684\u65e5\u5fd7\u3002</p> <p>\u4ece\u5934\u5f00\u59cb\u5199\uff0c\u5199\u5230\u672b\u5c3e\u5c31\u53c8\u56de\u5230\u5f00\u5934\u5faa\u73af\u5199\uff0c\u5982\u4e0b\u9762\u8fd9\u4e2a\u56fe\u6240\u793a\u3002</p> <p></p> <ul> <li><code>write pos</code> \u662f\u5f53\u524d\u8bb0\u5f55\u7684\u4f4d\u7f6e\uff0c\u4e00\u8fb9\u5199\u4e00\u8fb9\u540e\u79fb\uff0c\u5199\u5230\u7b2c 3 \u53f7\u6587\u4ef6\u672b\u5c3e\u540e\u5c31\u56de\u5230 0 \u53f7\u6587\u4ef6\u5f00\u5934</li> <li>checkpoint \u662f\u5f53\u524d\u8981\u64e6\u9664\u7684\u4f4d\u7f6e\uff0c\u4e5f\u662f\u5f80\u540e\u63a8\u79fb\u5e76\u4e14\u5faa\u73af\u7684\uff0c\u64e6\u9664\u8bb0\u5f55\u524d\u8981\u628a\u8bb0\u5f55\u66f4\u65b0\u5230\u6570\u636e\u6587\u4ef6\u3002</li> </ul> <p>\u64e6\u9664\u8bb0\u5f55\u4e4b\u524d\u8981\u628a\u8bb0\u5f55\u66f4\u65b0\u5230\u6570\u636e\u6587\u4ef6\uff0c\u4e5f\u5c31\u662f\u628a\u8bb0\u5f55\u66f4\u65b0\u5230\u78c1\u76d8\u6587\u4ef6\u4e0a\uff0c\u8fd9\u4e2a\u4e8b\u60c5\u662f\u5728\u7cfb\u7edf\u6bd4\u8f83\u7a7a\u95f2\u7684\u65f6\u5019\u53bb\u505a\u7684\u3002</p> <p>\u4e5f\u6709\u53ef\u80fd\uff1a \u64e6\u9664\u8bb0\u5f55\u662f\u56e0\u4e3a\u5199\u6ee1\u4e86\uff0c\u5c31\u7b97\u7cfb\u7edf\u7e41\u5fd9\u4e5f\u8981\u628a\u8bb0\u5f55\u66f4\u65b0\u5230\u78c1\u76d8\u4e0a\u5427</p> <p><code>write pos</code> \u548c <code>checkpoint</code> \u4e4b\u95f4\u7684\u662f\u8bb0\u5f55\u4e0a\u8fd8\u7a7a\u7740\u7684\u90e8\u5206\uff0c\u53ef\u4ee5\u7528\u6765\u8bb0\u5f55\u65b0\u7684\u64cd\u4f5c\u3002\u5982\u679c <code>write pos</code> \u8ffd\u4e0a <code>checkpoint</code>\uff0c\u8868\u793a\u8bb0\u5f55\u6ee1\u4e86\uff0c\u8fd9\u65f6\u5019\u4e0d\u80fd\u518d\u6267\u884c\u65b0\u7684\u66f4\u65b0\uff0c\u5f97\u505c\u4e0b\u6765\u5148\u64e6\u6389\u4e00\u4e9b\u8bb0\u5f55\uff0c\u628a <code>checkpoint</code> \u63a8\u8fdb\u4e00\u4e0b\u3002</p> <p>\u6709\u4e86 <code>redo log</code>\uff0cInnoDB \u5c31\u53ef\u4ee5\u4fdd\u8bc1\u5373\u4f7f\u6570\u636e\u5e93\u53d1\u751f\u5f02\u5e38\u91cd\u542f\uff0c\u4e4b\u524d\u63d0\u4ea4\u7684\u8bb0\u5f55\u90fd\u4e0d\u4f1a\u4e22\u5931\uff0c\u8fd9\u4e2a\u80fd\u529b\u79f0\u4e3a <code>crash-safe</code>\u3002</p>"},{"location":"chap1/2mysql_logs/#2binlog","title":"2\u3001\u91cd\u8981\u7684\u65e5\u5fd7\u6a21\u5757\uff1abinlog","text":""},{"location":"chap1/2mysql_logs/#2-1-binlog","title":"2-1 Binlog \u4e24\u79cd\u6a21\u5f0f","text":"<ul> <li> <p>Binlog\u6709\u4e24\u79cd\u6a21\u5f0f\uff1a</p> <ul> <li>statement \u683c\u5f0f\u7684\u8bdd\u662f\u8bb0sql\u8bed\u53e5\uff0c </li> <li>row\u683c\u5f0f\u4f1a\u8bb0\u5f55\u884c\u7684\u5185\u5bb9\uff0c\u8bb0\u4e24\u6761\uff0c\u66f4\u65b0\u524d\u548c\u66f4\u65b0\u540e\u90fd\u6709\u3002 </li> </ul> </li> <li> <p>\u5982\u4f55\u67e5\u770b binlog\uff1a </p> <ul> <li>\u641c\u7d22 log \u540d\u79f0\uff1a<code>show variables like '%log_bin%';</code> </li> <li>\u67e5\u770b log \u5185\u5bb9\uff1a<ul> <li><code>show binlog events in 'binlog.000009'</code> </li> <li>\u4f7f\u7528\u547d\u4ee4\u884c\u5de5\u5177\uff1a<code>mysqlbinlog binlog.000009</code></li> </ul> </li> </ul> </li> </ul>"},{"location":"chap1/2mysql_logs/#2-2-binlog","title":"2-2 \u4ec0\u4e48\u662fbinlog","text":"<p>MySQL \u6574\u4f53\u6765\u770b\uff0c\u5176\u5b9e\u5c31\u6709\u4e24\u5757\uff1a</p> <ul> <li>\u4e00\u5757\u662f Server \u5c42\uff0c\u5b83\u4e3b\u8981\u505a\u7684\u662f MySQL \u529f\u80fd\u5c42\u9762\u7684\u4e8b\u60c5\uff1b</li> <li>\u8fd8\u6709\u4e00\u5757\u662f\u5f15\u64ce\u5c42\uff0c\u8d1f\u8d23\u5b58\u50a8\u76f8\u5173\u7684\u5177\u4f53\u4e8b\u5b9c\u3002</li> </ul> <p><code>redo log</code> \u662f InnoDB \u5f15\u64ce\u7279\u6709\u7684\u65e5\u5fd7\uff0c\u800c Server \u5c42\u4e5f\u6709\u81ea\u5df1\u7684\u65e5\u5fd7\uff0c\u79f0\u4e3a binlog\uff08\u5f52\u6863\u65e5\u5fd7\uff09\u3002</p>"},{"location":"chap1/2mysql_logs/#2-3","title":"2-3 \u4e3a\u4ec0\u4e48\u4f1a\u6709\u4e24\u4efd\u65e5\u5fd7\u5462\uff1f","text":"<p>\u56e0\u4e3a\u6700\u5f00\u59cb MySQL \u91cc\u5e76\u6ca1\u6709 InnoDB \u5f15\u64ce\u3002</p> <ul> <li>MySQL \u81ea\u5e26\u7684\u5f15\u64ce\u662f MyISAM\uff0c\u4f46\u662f MyISAM \u6ca1\u6709 <code>crash-safe</code> \u7684\u80fd\u529b\uff0cbinlog \u65e5\u5fd7\u53ea\u80fd\u7528\u4e8e\u5f52\u6863\u3002</li> <li>\u800c InnoDB \u662f\u53e6\u4e00\u4e2a\u516c\u53f8\u4ee5\u63d2\u4ef6\u5f62\u5f0f\u5f15\u5165 MySQL \u7684\uff0c\u65e2\u7136\u53ea\u4f9d\u9760 binlog \u662f\u6ca1\u6709 crash-safe \u80fd\u529b\u7684\uff0c\u6240\u4ee5 InnoDB \u4f7f\u7528\u53e6\u5916\u4e00\u5957\u65e5\u5fd7\u7cfb\u7edf\u2014\u2014\u4e5f\u5c31\u662f redo log \u6765\u5b9e\u73b0 crash-safe \u80fd\u529b\u3002</li> </ul>"},{"location":"chap1/2mysql_logs/#2-4","title":"2-4 \u8fd9\u4e24\u79cd\u65e5\u5fd7\u6709\u4ee5\u4e0b\u4e09\u70b9\u4e0d\u540c\u3002","text":"<ol> <li>redo log \u662f InnoDB \u5f15\u64ce\u7279\u6709\u7684\uff1bbinlog \u662f MySQL \u7684 Server \u5c42\u5b9e\u73b0\u7684\uff0c\u6240\u6709\u5f15\u64ce\u90fd\u53ef\u4ee5\u4f7f\u7528\u3002</li> <li><code>redo log</code> \u662f\u7269\u7406\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u201c\u5728\u67d0\u4e2a\u6570\u636e\u9875\u4e0a\u505a\u4e86\u4ec0\u4e48\u4fee\u6539\u201d\uff1b<code>binlog</code> \u662f\u903b\u8f91\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u8fd9\u4e2a\u8bed\u53e5\u7684\u539f\u59cb\u903b\u8f91\uff0c\u6bd4\u5982\u201c\u7ed9 ID=2 \u8fd9\u4e00\u884c\u7684 c \u5b57\u6bb5\u52a0 1 \u201d\u3002</li> <li>redo log \u662f\u5faa\u73af\u5199\u7684\uff0c\u7a7a\u95f4\u56fa\u5b9a\u4f1a\u7528\u5b8c\uff1bbinlog \u662f\u53ef\u4ee5\u8ffd\u52a0\u5199\u5165\u7684\u3002\u201c\u8ffd\u52a0\u5199\u201d\u662f\u6307 binlog \u6587\u4ef6\u5199\u5230\u4e00\u5b9a\u5927\u5c0f\u540e\u4f1a\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\uff0c\u5e76\u4e0d\u4f1a\u8986\u76d6\u4ee5\u524d\u7684\u65e5\u5fd7\u3002</li> </ol> <p>\u6709\u4e86\u5bf9\u8fd9\u4e24\u4e2a\u65e5\u5fd7\u7684\u6982\u5ff5\u6027\u7406\u89e3\uff0c\u6211\u4eec\u518d\u6765\u770b\u6267\u884c\u5668\u548c InnoDB \u5f15\u64ce\u5728\u6267\u884c\u8fd9\u4e2a\u7b80\u5355\u7684 update \u8bed\u53e5\u65f6\u7684\u5185\u90e8\u6d41\u7a0b\u3002</p> <ol> <li>\u6267\u884c\u5668\u5148\u627e\u5f15\u64ce\u53d6 <code>ID=2</code> \u8fd9\u4e00\u884c\u3002<ul> <li>ID \u662f\u4e3b\u952e\uff0c\u5f15\u64ce\u76f4\u63a5\u7528\u6811\u641c\u7d22\u627e\u5230\u8fd9\u4e00\u884c\u3002</li> <li>\u5982\u679c ID=2 \u8fd9\u4e00\u884c\u6240\u5728\u7684\u6570\u636e\u9875\u672c\u6765\u5c31\u5728\u5185\u5b58\u4e2d\uff0c\u5c31\u76f4\u63a5\u8fd4\u56de\u7ed9\u6267\u884c\u5668\uff1b</li> <li>\u5426\u5219\uff0c\u9700\u8981\u5148\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58\uff0c\u7136\u540e\u518d\u8fd4\u56de\u3002</li> <li><code>show variables like 'innodb_page_size';</code></li> </ul> </li> <li>\u6267\u884c\u5668\u62ff\u5230\u5f15\u64ce\u7ed9\u7684\u884c\u6570\u636e\uff0c\u628a\u8fd9\u4e2a\u503c\u52a0\u4e0a 1\uff0c\u6bd4\u5982\u539f\u6765\u662f N\uff0c\u73b0\u5728\u5c31\u662f N+1\uff0c\u5f97\u5230\u65b0\u7684\u4e00\u884c\u6570\u636e\uff0c\u518d\u8c03\u7528\u5f15\u64ce\u63a5\u53e3\u5199\u5165\u8fd9\u884c\u65b0\u6570\u636e\u3002</li> <li>\u5f15\u64ce\u5c06\u8fd9\u884c\u65b0\u6570\u636e\u66f4\u65b0\u5230\u5185\u5b58\u4e2d\uff0c\u540c\u65f6\u5c06\u8fd9\u4e2a\u66f4\u65b0\u64cd\u4f5c\u8bb0\u5f55\u5230 <code>redo log</code> \u91cc\u9762\uff0c\u6b64\u65f6 <code>redo log</code>\u5904\u4e8e prepare \u72b6\u6001\u3002\u7136\u540e\u544a\u77e5\u6267\u884c\u5668\u6267\u884c\u5b8c\u6210\u4e86\uff0c\u968f\u65f6\u53ef\u4ee5\u63d0\u4ea4\u4e8b\u52a1\u3002</li> <li>\u6267\u884c\u5668\u751f\u6210\u8fd9\u4e2a\u64cd\u4f5c\u7684 binlog\uff0c\u5e76\u628a binlog \u5199\u5165\u78c1\u76d8\u3002</li> <li> <p>\u6267\u884c\u5668\u8c03\u7528\u5f15\u64ce\u7684\u63d0\u4ea4\u4e8b\u52a1\u63a5\u53e3\uff0c\u5f15\u64ce\u628a\u521a\u521a\u5199\u5165\u7684 <code>redo log</code> \u6539\u6210\u63d0\u4ea4\uff08<code>commit</code>\uff09\u72b6\u6001\uff0c\u66f4\u65b0\u5b8c\u6210\u3002</p> </li> <li> <p>binlog\u53ea\u6709\u5728\u4e8b\u52a1commit\u7684\u65f6\u5019\u624d\u4f1a\u5199\u5165\uff1b </p> </li> <li>\u5f53<code>prepare log</code> \u5199\u5165\u6210\u529f\u4e14<code>binglog</code>\u5199\u5165\u6210\u529f\u540e\u53d1\u9001<code>crash</code>\uff0c\u5728mysql\u542f\u52a8\u65f6\u5019\uff0c\u4f1a\u81ea\u52a8<code>commit</code>\u8fd9\u4e2a\u4e8b\u7269\uff1b </li> <li>\u5f53<code>prepare log</code>\u5199\u5165\u6210\u529f\uff0c<code>binlog</code>\u5199\u5165\u5931\u8d25\uff0c\u6b64\u65f6\u53d1\u751f<code>crash</code>\uff0c<code>mysql</code>\u542f\u52a8\u4f1a\u81ea\u52a8\u56de\u6eda\u6389\u8fd9\u4e2a\u4e8b\u7269\u3002</li> </ol> <p></p> <p>\u6700\u540e\u4e09\u6b65\u770b\u5c06 <code>redo log</code> \u7684\u5199\u5165\u62c6\u6210\u4e86\u4e24\u4e2a\u6b65\u9aa4\uff1a<code>prepare</code> \u548c <code>commit</code>\uff0c\u8fd9\u5c31\u662f \"\u4e24\u9636\u6bb5\u63d0\u4ea4\"\u3002</p>"},{"location":"chap1/2mysql_logs/#2-5","title":"2-5 \u5d29\u6e83\u56de\u6eda\u5206\u6790","text":"<ol> <li>prepare\u9636\u6bb5 </li> <li>\u5199binlog </li> <li> <p>commit </p> </li> <li> <p>\u5f53\u57282\u4e4b\u524d\u5d29\u6e83\u65f6 \u91cd\u542f\u6062\u590d\uff1a\u540e\u53d1\u73b0\u6ca1\u6709commit\uff0c\u56de\u6eda\u3002\u5907\u4efd\u6062\u590d\uff1a\u6ca1\u6709binlog \u3002</p> </li> <li>\u5f53\u57283\u4e4b\u524d\u5d29\u6e83 \u91cd\u542f\u6062\u590d\uff1a\u867d\u6ca1\u6709commit\uff0c\u4f46\u6ee1\u8db3prepare\u548cbinlog\u5b8c\u6574\uff0c\u6240\u4ee5\u91cd\u542f\u540e\u4f1a\u81ea\u52a8commit\u3002</li> </ol>"},{"location":"chap1/2mysql_logs/#3","title":"3\u3001\u4e24\u9636\u6bb5\u63d0\u4ea4","text":"<p>\u4e3a\u4ec0\u4e48\u5fc5\u987b\u6709\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u5462\uff1f\u8fd9\u662f\u4e3a\u4e86\u8ba9\u4e24\u4efd\u65e5\u5fd7\u4e4b\u95f4\u7684\u903b\u8f91\u4e00\u81f4</p>"},{"location":"chap1/2mysql_logs/#3-1","title":"3-1 \u600e\u6837\u8ba9\u6570\u636e\u5e93\u6062\u590d\u5230\u534a\u4e2a\u6708\u5185\u4efb\u610f\u4e00\u79d2\u7684\u72b6\u6001\uff1f","text":"<p>binlog \u4f1a\u8bb0\u5f55\u6240\u6709\u7684\u903b\u8f91\u64cd\u4f5c\uff0c\u5e76\u4e14\u662f\u91c7\u7528\u201c\u8ffd\u52a0\u5199\u201d\u7684\u5f62\u5f0f\u3002\u5982\u679c\u4f60\u7684 DBA \u627f\u8bfa\u8bf4\u534a\u4e2a\u6708\u5185\u53ef\u4ee5\u6062\u590d\uff0c\u90a3\u4e48\u5907\u4efd\u7cfb\u7edf\u4e2d\u4e00\u5b9a\u4f1a\u4fdd\u5b58\u6700\u8fd1\u534a\u4e2a\u6708\u7684\u6240\u6709 binlog\uff0c\u540c\u65f6\u7cfb\u7edf\u4f1a\u5b9a\u671f\u505a\u6574\u5e93\u5907\u4efd</p> <p>\u901a\u8fc7\u5b9a\u671f\u7684\u6574\u5e93\u5907\u4efd\u52a0\u4e0abinlog\u7684\u64cd\u4f5c\u56de\u653e\u53ef\u4ee5\u4fdd\u8bc1\u6570\u636e\u7684\u5b89\u5168\u6027\u3002</p> <p>\u56e0\u4e3abinlog\u8bb0\u5f55\u7684\u662f\u6570\u636e\u7684\u903b\u8f91\u64cd\u4f5c\uff08\u539f\u59cbsql\u8bed\u53e5\uff09\uff0c\u800credolog\u662f\u6570\u636e\u7684\u7269\u7406\u64cd\u4f5c\u65e5\u5fd7\uff0c\u5e76\u4e14\u975einnodb\u7684\u5f15\u64ce\u6ca1\u6709redolog\u3002\u56e0\u6b64\u56de\u653e\u7684\u65f6\u5019\u56de\u4f7f\u7528binlog\u8fdb\u884c\u56de\u653e</p> <p>\u5f53\u9700\u8981\u6062\u590d\u5230\u6307\u5b9a\u7684\u67d0\u4e00\u79d2\u65f6</p> <ul> <li>\u9996\u5148\uff0c\u627e\u5230\u6700\u8fd1\u7684\u4e00\u6b21\u5168\u91cf\u5907\u4efd\uff0c\u5982\u679c\u4f60\u8fd0\u6c14\u597d\uff0c\u53ef\u80fd\u5c31\u662f\u6628\u5929\u665a\u4e0a\u7684\u4e00\u4e2a\u5907\u4efd\uff0c\u4ece\u8fd9\u4e2a\u5907\u4efd\u6062\u590d\u5230\u4e34\u65f6\u5e93\uff1b</li> <li>\u7136\u540e\uff0c\u4ece\u5907\u4efd\u7684\u65f6\u95f4\u70b9\u5f00\u59cb\uff0c\u5c06\u5907\u4efd\u7684 binlog \u4f9d\u6b21\u53d6\u51fa\u6765\uff0c\u91cd\u653e\u5230\u4e2d\u5348\u8bef\u5220\u8868\u4e4b\u524d\u7684\u90a3\u4e2a\u65f6\u523b\u3002</li> <li>\u8fd9\u6837\u4f60\u7684\u4e34\u65f6\u5e93\u5c31\u8ddf\u8bef\u5220\u4e4b\u524d\u7684\u7ebf\u4e0a\u5e93\u4e00\u6837\u4e86\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u628a\u8868\u6570\u636e\u4ece\u4e34\u65f6\u5e93\u53d6\u51fa\u6765\uff0c\u6309\u9700\u8981\u6062\u590d\u5230\u7ebf\u4e0a\u5e93\u53bb\u3002</li> </ul>"},{"location":"chap1/2mysql_logs/#3-2","title":"3-2 \u4e3a\u4ec0\u4e48\u65e5\u5fd7\u9700\u8981\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d","text":"<p>\u5982\u679c\u4e0d\u4f7f\u7528\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u7684\u72b6\u6001\u5c31\u6709\u53ef\u80fd\u548c\u7528\u5b83\u7684\u65e5\u5fd7\u6062\u590d\u51fa\u6765\u7684\u5e93\u7684\u72b6\u6001\u4e0d\u4e00\u81f4\u3002</p> <p>\u7531\u4e8e redo log \u548c binlog \u662f\u4e24\u4e2a\u72ec\u7acb\u7684\u903b\u8f91\uff0c\u5982\u679c\u4e0d\u7528\u4e24\u9636\u6bb5\u63d0\u4ea4\uff0c\u8981\u4e48\u5c31\u662f\u5148\u5199\u5b8c redo log \u518d\u5199 binlog\uff0c\u6216\u8005\u91c7\u7528\u53cd\u8fc7\u6765\u7684\u987a\u5e8f\u3002</p> <p>\u4ecd\u7136\u7528\u524d\u9762\u7684 update \u8bed\u53e5\u6765\u505a\u4f8b\u5b50\u3002\u5047\u8bbe\u5f53\u524d ID=2 \u7684\u884c\uff0c\u5b57\u6bb5 c \u7684\u503c\u662f 0\uff0c\u518d\u5047\u8bbe\u6267\u884c update \u8bed\u53e5\u8fc7\u7a0b\u4e2d\u5728\u5199\u5b8c\u7b2c\u4e00\u4e2a\u65e5\u5fd7\u540e\uff0c\u7b2c\u4e8c\u4e2a\u65e5\u5fd7\u8fd8\u6ca1\u6709\u5199\u5b8c\u671f\u95f4\u53d1\u751f\u4e86 crash\uff0c\u4f1a\u51fa\u73b0\u4ec0\u4e48\u60c5\u51b5\u5462\uff1f</p>"},{"location":"chap1/2mysql_logs/#3-2-1-redo-log-binlog","title":"3-2-1 \u5148\u5199 redo log \u540e\u5199 binlog","text":"<ul> <li>\u5047\u8bbe\u5728 redo log \u5199\u5b8c\uff0cbinlog \u8fd8\u6ca1\u6709\u5199\u5b8c\u7684\u65f6\u5019\uff0cMySQL \u8fdb\u7a0b\u5f02\u5e38\u91cd\u542f\u3002\u7531\u4e8e\u6211\u4eec\u524d\u9762\u8bf4\u8fc7\u7684\uff0credo log \u5199\u5b8c\u4e4b\u540e\uff0c\u7cfb\u7edf\u5373\u4f7f\u5d29\u6e83\uff0c\u4ecd\u7136\u80fd\u591f\u628a\u6570\u636e\u6062\u590d\u56de\u6765\uff0c\u6240\u4ee5\u6062\u590d\u540e\u8fd9\u4e00\u884c c \u7684\u503c\u662f 1\u3002</li> <li>\u4f46\u662f\u7531\u4e8e binlog \u6ca1\u5199\u5b8c\u5c31 crash \u4e86\uff0c\u8fd9\u65f6\u5019 binlog \u91cc\u9762\u5c31\u6ca1\u6709\u8bb0\u5f55\u8fd9\u4e2a\u8bed\u53e5\u3002</li> <li>\u56e0\u6b64\uff0c\u4e4b\u540e\u5907\u4efd\u65e5\u5fd7\u7684\u65f6\u5019\uff0c\u5b58\u8d77\u6765\u7684 binlog \u91cc\u9762\u5c31\u6ca1\u6709\u8fd9\u6761\u8bed\u53e5\u3002</li> <li>\u7136\u540e\u4f60\u4f1a\u53d1\u73b0\uff0c\u5982\u679c\u9700\u8981\u7528\u8fd9\u4e2a binlog \u6765\u6062\u590d\u4e34\u65f6\u5e93\u7684\u8bdd\uff0c\u7531\u4e8e\u8fd9\u4e2a\u8bed\u53e5\u7684 binlog \u4e22\u5931\uff0c\u8fd9\u4e2a\u4e34\u65f6\u5e93\u5c31\u4f1a\u5c11\u4e86\u8fd9\u4e00\u6b21\u66f4\u65b0\uff0c\u6062\u590d\u51fa\u6765\u7684\u8fd9\u4e00\u884c c \u7684\u503c\u5c31\u662f 0\uff0c\u4e0e\u539f\u5e93\u7684\u503c\u4e0d\u540c\u3002</li> </ul>"},{"location":"chap1/2mysql_logs/#3-2-2-binlog-redo-log","title":"3-2-2 \u5148\u5199 binlog \u540e\u5199 redo log","text":"<ul> <li>\u5982\u679c\u5728 binlog \u5199\u5b8c\u4e4b\u540e crash\uff0c\u7531\u4e8e redo log \u8fd8\u6ca1\u5199\uff0c\u5d29\u6e83\u6062\u590d\u4ee5\u540e\u8fd9\u4e2a\u4e8b\u52a1\u65e0\u6548\uff0c\u6240\u4ee5\u8fd9\u4e00\u884c c \u7684\u503c\u662f 0\u3002</li> <li>\u4f46\u662f binlog \u91cc\u9762\u5df2\u7ecf\u8bb0\u5f55\u4e86\u201c\u628a c \u4ece 0 \u6539\u6210 1\u201d\u8fd9\u4e2a\u65e5\u5fd7\u3002\u6240\u4ee5\uff0c\u5728\u4e4b\u540e\u7528 binlog \u6765\u6062\u590d\u7684\u65f6\u5019\u5c31\u591a\u4e86\u4e00\u4e2a\u4e8b\u52a1\u51fa\u6765\uff0c\u6062\u590d\u51fa\u6765\u7684\u8fd9\u4e00\u884c c \u7684\u503c\u5c31\u662f 1\uff0c\u4e0e\u539f\u5e93\u7684\u503c\u4e0d\u540c\u3002</li> </ul> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u4e0d\u4f7f\u7528\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u7684\u72b6\u6001\u5c31\u6709\u53ef\u80fd\u548c\u7528\u5b83\u7684\u65e5\u5fd7\u6062\u590d\u51fa\u6765\u7684\u5e93\u7684\u72b6\u6001\u4e0d\u4e00\u81f4\u3002</p> <p>\u672c\u8d28\u4e0a\u662f\u56e0\u4e3a redo log \u8d1f\u8d23\u4e8b\u52a1\uff1b binlog\u8d1f\u8d23\u5f52\u6863\u6062\u590d\uff1b \u5404\u53f8\u5176\u804c\uff0c\u76f8\u4e92\u914d\u5408\uff0c\u624d\u63d0\u4f9b(\u4fdd\u8bc1)\u4e86\u73b0\u6709\u529f\u80fd\u7684\u5b8c\u6574\u6027\uff1b</p>"},{"location":"chap1/2mysql_logs/#3-3-redologbinlog","title":"3-3 redolog\u548cbinlog\u5177\u6709\u5173\u8054\u884c","text":"<p>redolog\u548cbinlog\u5177\u6709\u5173\u8054\u884c\uff0c\u5728\u6062\u590d\u6570\u636e\u65f6\uff0credolog\u7528\u4e8e\u6062\u590d\u4e3b\u673a\u6545\u969c\u65f6\u7684\u672a\u66f4\u65b0\u7684\u7269\u7406\u6570\u636e\uff0cbinlog\u7528\u4e8e\u5907\u4efd\u64cd\u4f5c\u3002</p> <p>\u6bcf\u4e2a\u9636\u6bb5\u7684log\u64cd\u4f5c\u90fd\u662f\u8bb0\u5f55\u5728\u78c1\u76d8\u7684\uff0c\u5728\u6062\u590d\u6570\u636e\u65f6\uff0credolog \u72b6\u6001\u4e3acommit\u5219\u8bf4\u660ebinlog\u4e5f\u6210\u529f\uff0c\u76f4\u63a5\u6062\u590d\u6570\u636e\uff1b</p> <p>\u5982\u679credolog\u662fprepare\uff0c\u5219\u9700\u8981\u67e5\u8be2\u5bf9\u5e94\u7684binlog\u4e8b\u52a1\u662f\u5426\u6210\u529f\uff0c\u51b3\u5b9a\u662f\u56de\u6eda\u8fd8\u662f\u6267\u884c\u3002</p>"},{"location":"chap1/2mysql_logs/#4","title":"4\u3001\u5c0f\u8282\u603b\u7ed3","text":""},{"location":"chap1/2mysql_logs/#4-1-redo-log-crash-safe","title":"4-1 redo log \u7528\u4e8e\u4fdd\u8bc1 <code>crash-safe</code> \u80fd\u529b\u3002","text":"<ul> <li><code>innodb_flush_log_at_trx_commit</code> \u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 <code>1</code> \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684 <code>redo log</code>\u90fd\u76f4\u63a5\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u4e2a\u53c2\u6570\u6211\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210 <code>1</code>\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1 MySQL \u5f02\u5e38\u91cd\u542f\u4e4b\u540e\u6570\u636e\u4e0d\u4e22\u5931\u3002</li> <li><code>sync_binlog</code> \u8fd9\u4e2a\u53c2\u6570\u8bbe\u7f6e\u6210 1 \u7684\u65f6\u5019\uff0c\u8868\u793a\u6bcf\u6b21\u4e8b\u52a1\u7684 <code>binlog</code> \u90fd\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u8fd9\u4e2a\u53c2\u6570\u6211\u4e5f\u5efa\u8bae\u4f60\u8bbe\u7f6e\u6210 <code>1</code>\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1 <code>MySQL</code> \u5f02\u5e38\u91cd\u542f\u4e4b\u540e <code>binlog</code> \u4e0d\u4e22\u5931\u3002</li> </ul> <p>\u4e24\u9636\u6bb5\u63d0\u4ea4\u662f\u8de8\u7cfb\u7edf\u7ef4\u6301\u6570\u636e\u903b\u8f91\u4e00\u81f4\u6027\u65f6\u5e38\u7528\u7684\u4e00\u4e2a\u65b9\u6848</p>"},{"location":"chap1/2mysql_logs/#4-2","title":"4-2 \u63d0\u95ee","text":"<p>\u5b9a\u671f\u5168\u91cf\u5907\u4efd\u7684\u5468\u671f\u201c\u53d6\u51b3\u4e8e\u7cfb\u7edf\u91cd\u8981\u6027\uff0c\u6709\u7684\u662f\u4e00\u5929\u4e00\u5907\uff0c\u6709\u7684\u662f\u4e00\u5468\u4e00\u5907\u201d\u3002\u90a3\u4e48\u5728\u4ec0\u4e48\u573a\u666f\u4e0b\uff0c\u4e00\u5929\u4e00\u5907\u4f1a\u6bd4\u4e00\u5468\u4e00\u5907\u66f4\u6709\u4f18\u52bf\u5462\uff1f\u6216\u8005\u8bf4\uff0c\u5b83\u5f71\u54cd\u4e86\u8fd9\u4e2a\u6570\u636e\u5e93\u7cfb\u7edf\u7684\u54ea\u4e2a\u6307\u6807\uff1f</p> <p>\u4e3b\u8981\u5f71\u54cd\u6570\u636e\u5e93\u7684\u786c\u76d8\u5b58\u50a8\u3002 \u9700\u8981\u5bf9\u6570\u636e\u5907\u4efd\u6709\u5f3a\u9700\u6c42\u7684\u60c5\u51b5\u4e0b\uff0c1\u59291\u5907\u80af\u5b9a\u66f4\u52a0\u6ee1\u8db3\u9700\u8981</p>"},{"location":"chap1/2mysql_logs/#4-3-binlog-vs-redolog","title":"4-3 binlog vs redolog","text":"<ul> <li>Redo log \u8bb0\u5f55\u8fd9\u4e2a\u9875 \u201c\u505a\u4e86\u4ec0\u4e48\u6539\u52a8\u201d\u3002<ul> <li>redo log\u8bb0\u5f55\u7684\u662f\u5f53\u65f6\u7684\u6570\u636e\u662f\u600e\u4e48\u53d8\u5316\u7684\uff0c\u6bd4\u5982\u5907\u4efd\u7684\u65f6\u5019\u8bb0\u5f55table\u8868\u4e2d\u5b57\u6bb5a\u7684\u503c\u662f1\u21923\uff08\u75311\u53d8\u62103\uff09</li> </ul> </li> <li>Binlog\u6709\u4e24\u79cd\u6a21\u5f0f\uff0c<ul> <li>statement \u683c\u5f0f\u7684\u8bdd\u662f\u8bb0sql\u8bed\u53e5</li> <li>row\u683c\u5f0f\u4f1a\u8bb0\u5f55\u884c\u7684\u5185\u5bb9\uff0c\u8bb0\u4e24\u6761\uff0c\u66f4\u65b0\u524d\u548c\u66f4\u65b0\u540e\u90fd\u6709\u3002</li> <li>binlog\u91cc\u9762\u8bb0\u5f55\u53ef\u80fd\u5c31\u662f\u591a\u6761SQL\u6267\u884c\u4e4b\u540ea\u7684\u503c\u624d\u7b49\u4e8e3\uff0c\u6bd4\u5982<code>update table set a =1 where ID=1\uff1b</code>,<code>update table set a=3 where ID=1\uff1b</code>\u6216\u8005\u6267\u884c\u8fc7\u66f4\u591aSQL\u624d\u53d8\u62103\u3002</li> </ul> </li> </ul>"},{"location":"chap1/3mysql_isolaion/","title":"\u7b2c\u4e09\u8282 \u4e8b\u52a1\u9694\u79bb","text":"<p>\u4e8b\u52a1\u5c31\u662f\u8981\u4fdd\u8bc1\u4e00\u7ec4\u6570\u636e\u5e93\u64cd\u4f5c\uff0c\u8981\u4e48\u5168\u90e8\u6210\u529f\uff0c\u8981\u4e48\u5168\u90e8\u5931\u8d25\u3002</p> <p>\u5728 MySQL \u4e2d\uff0c\u4e8b\u52a1\u652f\u6301\u662f\u5728\u5f15\u64ce\u5c42\u5b9e\u73b0\u7684\u3002\u4f60\u73b0\u5728\u77e5\u9053\uff0cMySQL \u662f\u4e00\u4e2a\u652f\u6301\u591a\u5f15\u64ce\u7684\u7cfb\u7edf\uff0c\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5f15\u64ce\u90fd\u652f\u6301\u4e8b\u52a1\u3002\u6bd4\u5982 MySQL \u539f\u751f\u7684 MyISAM \u5f15\u64ce\u5c31\u4e0d\u652f\u6301\u4e8b\u52a1\uff0c\u8fd9\u4e5f\u662f MyISAM \u88ab InnoDB \u53d6\u4ee3\u7684\u91cd\u8981\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"chap1/3mysql_isolaion/#1","title":"1\u3001\u9694\u79bb\u6027\u4e0e\u9694\u79bb\u7ea7\u522b","text":""},{"location":"chap1/3mysql_isolaion/#1-1","title":"1-1 \u9694\u79bb\u6027","text":"<p>\u63d0\u5230\u4e8b\u52a1\uff0c\u4f60\u80af\u5b9a\u4f1a\u60f3\u5230 ACID\uff08Atomicity\u3001Consistency\u3001Isolation\u3001Durability\uff0c\u5373\u539f\u5b50\u6027\u3001\u4e00\u81f4\u6027\u3001\u9694\u79bb\u6027\u3001\u6301\u4e45\u6027\uff09\uff0c\u4eca\u5929\u6211\u4eec\u5c31\u6765\u8bf4\u8bf4\u5176\u4e2d I\uff0c\u4e5f\u5c31\u662f\u201c\u9694\u79bb\u6027\u201d\u3002</p> <p>\u5f53\u6570\u636e\u5e93\u4e0a\u6709\u591a\u4e2a\u4e8b\u52a1\u540c\u65f6\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u810f\u8bfb\uff08dirty read\uff09\u3001\u4e0d\u53ef\u91cd\u590d\u8bfb\uff08non-repeatable read\uff09\u3001\u5e7b\u8bfb\uff08phantom read\uff09\u7684\u95ee\u9898\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u5c31\u6709\u4e86\u201c\u9694\u79bb\u7ea7\u522b\u201d\u7684\u6982\u5ff5\u3002</p> <ul> <li>\u810f\u8bfb:   \u8bfb\u5230\u5176\u4ed6\u4e8b\u52a1\u672a\u63d0\u4ea4\u7684\u6570\u636e\uff1b </li> <li>\u4e0d\u53ef\u91cd\u590d\u8bfb\uff1a\u524d\u540e\u8bfb\u53d6\u7684\u8bb0\u5f55\u5185\u5bb9\u4e0d\u4e00\u81f4\uff1b </li> <li>\u5e7b\u8bfb\uff1a\u524d\u540e\u8bfb\u53d6\u7684\u8bb0\u5f55\u6570\u91cf\u4e0d\u4e00\u81f4\u3002</li> </ul>"},{"location":"chap1/3mysql_isolaion/#1-2","title":"1-2 \u9694\u79bb\u7ea7\u522b","text":"<p>\u5728\u8c08\u9694\u79bb\u7ea7\u522b\u4e4b\u524d</p> <p>\u4f60\u9996\u5148\u8981\u77e5\u9053\uff0c\u9694\u79bb\u5f97\u8d8a\u4e25\u5b9e\uff0c\u6548\u7387\u5c31\u4f1a\u8d8a\u4f4e\u3002\u56e0\u6b64\u5f88\u591a\u65f6\u5019\uff0c\u6211\u4eec\u90fd\u8981\u5728\u4e8c\u8005\u4e4b\u95f4\u5bfb\u627e\u4e00\u4e2a\u5e73\u8861\u70b9\u3002</p> <p>SQL \u6807\u51c6\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u5305\u62ec\uff1a\u8bfb\u672a\u63d0\u4ea4\uff08read uncommitted\uff09\u3001\u8bfb\u63d0\u4ea4\uff08read committed\uff09\u3001\u53ef\u91cd\u590d\u8bfb\uff08repeatable read\uff09\u548c\u4e32\u884c\u5316\uff08serializable \uff09\u3002\u4e0b\u9762\u6211\u9010\u4e00\u4e3a\u4f60\u89e3\u91ca\uff1a</p> <ul> <li>\u8bfb\u672a\u63d0\u4ea4\u662f\u6307\uff0c\u4e00\u4e2a\u4e8b\u52a1\u8fd8\u6ca1\u63d0\u4ea4\u65f6\uff0c\u5b83\u505a\u7684\u53d8\u66f4\u5c31\u80fd\u88ab\u522b\u7684\u4e8b\u52a1\u770b\u5230\u3002</li> <li>\u8bfb\u63d0\u4ea4\u662f\u6307\uff0c\u4e00\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u540e\uff0c\u5b83\u505a\u7684\u53d8\u66f4\u624d\u4f1a\u88ab\u5176\u4ed6\u4e8b\u52a1\u770b\u5230\u3002</li> <li>\u53ef\u91cd\u590d\u8bfb\u662f\u6307\uff0c\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u770b\u5230\u7684\u6570\u636e\uff0c\u603b\u662f\u8ddf\u8fd9\u4e2a\u4e8b\u52a1\u5728\u542f\u52a8\u65f6\u770b\u5230\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\u3002\u5f53\u7136\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u672a\u63d0\u4ea4\u53d8\u66f4\u5bf9\u5176\u4ed6\u4e8b\u52a1\u4e5f\u662f\u4e0d\u53ef\u89c1\u7684\u3002</li> <li>\u4e32\u884c\u5316\uff0c\u987e\u540d\u601d\u4e49\u662f\u5bf9\u4e8e\u540c\u4e00\u884c\u8bb0\u5f55\uff0c\u201c\u5199\u201d\u4f1a\u52a0\u201c\u5199\u9501\u201d\uff0c\u201c\u8bfb\u201d\u4f1a\u52a0\u201c\u8bfb\u9501\u201d\u3002\u5f53\u51fa\u73b0\u8bfb\u5199\u9501\u51b2\u7a81\u7684\u65f6\u5019\uff0c\u540e\u8bbf\u95ee\u7684\u4e8b\u52a1\u5fc5\u987b\u7b49\u524d\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u5b8c\u6210\uff0c\u624d\u80fd\u7ee7\u7eed\u6267\u884c\u3002</li> </ul> <p>\u5176\u4e2d\u201c\u8bfb\u63d0\u4ea4\u201d\u548c\u201c\u53ef\u91cd\u590d\u8bfb\u201d\u6bd4\u8f83\u96be\u7406\u89e3\uff0c\u5047\u8bbe\u6570\u636e\u8868 T \u4e2d\u53ea\u6709\u4e00\u5217\uff0c\u5176\u4e2d\u4e00\u884c\u7684\u503c\u4e3a 1\uff0c\u4e0b\u9762\u662f\u6309\u7167\u65f6\u95f4\u987a\u5e8f\u6267\u884c\u4e24\u4e2a\u4e8b\u52a1\u7684\u884c\u4e3a\u3002</p> <pre><code>mysql&gt; create table T(c int) engine=InnoDB;\ninsert into T(c) values(1);\n</code></pre> <p></p> <p>\u540c\u7684\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u4e8b\u52a1 A \u4f1a\u6709\u54ea\u4e9b\u4e0d\u540c\u7684\u8fd4\u56de\u7ed3\u679c:</p> <ul> <li>\u82e5\u9694\u79bb\u7ea7\u522b\u662f\u201c\u8bfb\u672a\u63d0\u4ea4\u201d\uff0c \u5219 V1 \u7684\u503c\u5c31\u662f 2\u3002\u8fd9\u65f6\u5019\u4e8b\u52a1 B \u867d\u7136\u8fd8\u6ca1\u6709\u63d0\u4ea4\uff0c\u4f46\u662f\u7ed3\u679c\u5df2\u7ecf\u88ab A \u770b\u5230\u4e86\u3002\u56e0\u6b64\uff0cV2\u3001V3 \u4e5f\u90fd\u662f 2\u3002<ul> <li>V1, V2, V3: 2</li> </ul> </li> <li>\u82e5\u9694\u79bb\u7ea7\u522b\u662f\u201c\u8bfb\u63d0\u4ea4\u201d\uff0c\u5219 V1 \u662f 1\uff0cV2 \u7684\u503c\u662f 2\u3002\u4e8b\u52a1 B \u7684\u66f4\u65b0\u5728\u63d0\u4ea4\u540e\u624d\u80fd\u88ab A \u770b\u5230\u3002\u6240\u4ee5\uff0c V3 \u7684\u503c\u4e5f\u662f 2\u3002<ul> <li>\u4e00\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u540e\uff0c\u5b83\u505a\u7684\u53d8\u66f4\u624d\u4f1a\u88ab\u5176\u4ed6\u4e8b\u52a1\u770b\u5230\u3002</li> <li>V1: 1  </li> <li>V2, V3: 2</li> </ul> </li> <li>\u82e5\u9694\u79bb\u7ea7\u522b\u662f\u201c\u53ef\u91cd\u590d\u8bfb\u201d\uff0c\u5219 V1\u3001V2 \u662f 1\uff0cV3 \u662f 2\u3002\u4e4b\u6240\u4ee5 V2 \u8fd8\u662f 1\uff0c\u9075\u5faa\u7684\u5c31\u662f\u8fd9\u4e2a\u8981\u6c42\uff1a\u4e8b\u52a1\u5728\u6267\u884c\u671f\u95f4\u770b\u5230\u7684\u6570\u636e\u524d\u540e\u5fc5\u987b\u662f\u4e00\u81f4\u7684\u3002<ul> <li>\u4e8b\u52a1\u5728\u6267\u884c\u671f\u95f4\u770b\u5230\u7684\u6570\u636e\u524d\u540e\u5fc5\u987b\u662f\u4e00\u81f4\u7684</li> <li>V1, V2: 1</li> <li>V3: 2</li> </ul> </li> <li>\u82e5\u9694\u79bb\u7ea7\u522b\u662f\u201c\u4e32\u884c\u5316\u201d\uff0c\u5219\u5728\u4e8b\u52a1 B \u6267\u884c\u201c\u5c06 1 \u6539\u6210 2\u201d\u7684\u65f6\u5019\uff0c\u4f1a\u88ab\u9501\u4f4f\u3002\u76f4\u5230\u4e8b\u52a1 A \u63d0\u4ea4\u540e\uff0c\u4e8b\u52a1 B \u624d\u53ef\u4ee5\u7ee7\u7eed\u6267\u884c\u3002\u6240\u4ee5\u4ece A \u7684\u89d2\u5ea6\u770b\uff0c V1\u3001V2 \u503c\u662f 1\uff0cV3 \u7684\u503c\u662f 2\u3002<ul> <li>\u4e8b\u52a1A\u4e00\u5f00\u59cb\u67e5\u8be2\u503c1\u7684\u65f6\u5019\u5c31\u83b7\u5f97\u4e86\u8bfb\u9501\uff0c\u6839\u636e\u4e24\u9636\u6bb5\u52a0\u9501\uff0c\u4e8b\u52a1A\u83b7\u5f97\u7684\u9501\u8981\u5728commit\u7684\u65f6\u5019\u624d\u91ca\u653e\uff0c</li> <li>\u6240\u4ee5\u4e8b\u52a1B\u5728\u4fee\u65391\u4e3a2\u7684\u65f6\u5019\u7533\u8bf7\u5199\u9501\u4f1a\u963b\u585e\u76f4\u5230\u4e8b\u52a1A\u63d0\u4ea4\uff0c</li> <li>\u4e8b\u52a1A\u63d0\u4ea4\u4e4b\u524d\u83b7\u53d6\u7684\u503c\u90fd\u662f1\uff0c\u6240\u4ee5V1 V2\u90fd\u662f1\uff0c</li> <li>\u4e8b\u52a1A\u63d0\u4ea4\u540e\u4e8b\u52a1B\u83b7\u53d6\u5230\u5199\u9501\u5b8c\u6210\u66f4\u65b0\u64cd\u4f5c\uff0c\u6240\u4ee5V3\u662f2</li> </ul> </li> </ul>"},{"location":"chap1/3mysql_isolaion/#1-3","title":"1-3 \u9694\u79bb\u89c6\u56fe","text":"<p>\u6570\u636e\u5e93\u91cc\u9762\u4f1a\u521b\u5efa\u4e00\u4e2a\u89c6\u56fe\uff0c\u8bbf\u95ee\u7684\u65f6\u5019\u4ee5\u89c6\u56fe\u7684\u903b\u8f91\u7ed3\u679c\u4e3a\u51c6\u3002</p> <ul> <li>\u5728\u201c\u53ef\u91cd\u590d\u8bfb\u201d\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u8fd9\u4e2a\u89c6\u56fe\u662f\u5728\u4e8b\u52a1\u542f\u52a8\u65f6\u521b\u5efa\u7684\uff0c\u6574\u4e2a\u4e8b\u52a1\u5b58\u5728\u671f\u95f4\u90fd\u7528\u8fd9\u4e2a\u89c6\u56fe</li> <li>\u5728\u201c\u8bfb\u63d0\u4ea4\u201d\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u8fd9\u4e2a\u89c6\u56fe\u662f\u5728\u6bcf\u4e2a SQL \u8bed\u53e5\u5f00\u59cb\u6267\u884c\u7684\u65f6\u5019\u521b\u5efa\u7684\u3002</li> <li>\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u201c\u8bfb\u672a\u63d0\u4ea4\u201d\u9694\u79bb\u7ea7\u522b\u4e0b\u76f4\u63a5\u8fd4\u56de\u8bb0\u5f55\u4e0a\u7684\u6700\u65b0\u503c\uff0c\u6ca1\u6709\u89c6\u56fe\u6982\u5ff5\uff1b</li> <li>\u800c\u201c\u4e32\u884c\u5316\u201d\u9694\u79bb\u7ea7\u522b\u4e0b\u76f4\u63a5\u7528\u52a0\u9501\u7684\u65b9\u5f0f\u6765\u907f\u514d\u5e76\u884c\u8bbf\u95ee\u3002\uff08\u6ca1\u6709\u89c6\u56fe\u7684\u6982\u5ff5\uff09</li> </ul> <p>\u6570\u636e\u5e93\u884c\u4e3a\u662f\u6709\u6240\u4e0d\u540c\u7684\u3002Oracle \u6570\u636e\u5e93\u7684\u9ed8\u8ba4\u9694\u79bb\u7ea7\u522b\u5176\u5b9e\u5c31\u662f\u201c\u8bfb\u63d0\u4ea4\u201d\uff0c\u56e0\u6b64\u5bf9\u4e8e\u4e00\u4e9b\u4ece Oracle \u8fc1\u79fb\u5230 MySQL \u7684\u5e94\u7528\uff0c\u4e3a\u4fdd\u8bc1\u6570\u636e\u5e93\u9694\u79bb\u7ea7\u522b\u7684\u4e00\u81f4\uff0c\u4f60\u4e00\u5b9a\u8981\u8bb0\u5f97\u5c06 MySQL \u7684\u9694\u79bb\u7ea7\u522b\u8bbe\u7f6e\u4e3a\u201c\u8bfb\u63d0\u4ea4\u201d</p>"},{"location":"chap1/3mysql_isolaion/#1-4","title":"1-4 \u542f\u52a8\u53c2\u6570","text":"<p>\u5c06\u542f\u52a8\u53c2\u6570 <code>transaction-isolation</code> \u7684\u503c\u8bbe\u7f6e\u6210 <code>READ-COMMITTED</code>\u3002</p> <pre><code>\nmysql&gt; show variables like 'transaction_isolation';\n\n+-----------------------+----------------+\n\n| Variable_name | Value |\n\n+-----------------------+----------------+\n\n| transaction_isolation | READ-COMMITTED |\n\n+-----------------------+----------------+\n</code></pre> <p>\u6709\u4e9b\u7248\u672c\u662f\uff1a<code>tx_isolation</code></p> <p>5.7\u7248\u672c\u5c31\u662f@@tx_isolation  /   </p>"},{"location":"chap1/3mysql_isolaion/#1-5","title":"1-5 \u4ec0\u4e48\u65f6\u5019\u9700\u8981\u201c\u53ef\u91cd\u590d\u8bfb\u201d\u7684\u573a\u666f","text":"<p>\u7ba1\u7406\u4e00\u4e2a\u4e2a\u4eba\u94f6\u884c\u8d26\u6237\u8868\u3002\u4e00\u4e2a\u8868\u5b58\u4e86\u8d26\u6237\u4f59\u989d\uff0c\u4e00\u4e2a\u8868\u5b58\u4e86\u8d26\u5355\u660e\u7ec6\u3002\u5230\u4e86\u6708\u5e95\u4f60\u8981\u505a\u6570\u636e\u6821\u5bf9\uff0c\u4e5f\u5c31\u662f\u5224\u65ad\u4e0a\u4e2a\u6708\u7684\u4f59\u989d\u548c\u5f53\u524d\u4f59\u989d\u7684\u5dee\u989d\uff0c\u662f\u5426\u4e0e\u672c\u6708\u7684\u8d26\u5355\u660e\u7ec6\u4e00\u81f4\u3002\u4f60\u4e00\u5b9a\u5e0c\u671b\u5728\u6821\u5bf9\u8fc7\u7a0b\u4e2d\uff0c\u5373\u4f7f\u6709\u7528\u6237\u53d1\u751f\u4e86\u4e00\u7b14\u65b0\u7684\u4ea4\u6613\uff0c\u4e5f\u4e0d\u5f71\u54cd\u4f60\u7684\u6821\u5bf9\u7ed3\u679c\u3002</p>"},{"location":"chap1/3mysql_isolaion/#2","title":"2\u3001\u4e8b\u52a1\u9694\u79bb\u7684\u5b9e\u73b0","text":""},{"location":"chap1/3mysql_isolaion/#2-1","title":"2-1 \u53ef\u91cd\u590d\u8bfb\u7684\u56de\u6eda\u64cd\u4f5c","text":"<p>\u8fd9\u91cc\u6211\u4eec\u5c55\u5f00\u8bf4\u660e\u201c\u53ef\u91cd\u590d\u8bfb\u201d\u3002</p> <p>\u5728 MySQL \u4e2d\uff0c\u5b9e\u9645\u4e0a\u6bcf\u6761\u8bb0\u5f55\u5728\u66f4\u65b0\u7684\u65f6\u5019\u90fd\u4f1a\u540c\u65f6\u8bb0\u5f55\u4e00\u6761\u56de\u6eda\u64cd\u4f5c\u3002\u8bb0\u5f55\u4e0a\u7684\u6700\u65b0\u503c\uff0c\u901a\u8fc7\u56de\u6eda\u64cd\u4f5c\uff0c\u90fd\u53ef\u4ee5\u5f97\u5230\u524d\u4e00\u4e2a\u72b6\u6001\u7684\u503c\u3002</p> <p>\u610f\u601d\u5c31\u662f\u9664\u4e86\u8bb0\u5f55\u53d8\u66f4\u8bb0\u5f55\uff0c\u8fd8\u4f1a\u8bb0\u5f55\u4e00\u6761\u53d8\u66f4\u76f8\u53cd\u7684\u56de\u6eda\u64cd\u4f5c\u8bb0\u5f55\uff0c\u524d\u8005\u8bb0\u5f55\u5728redo log\uff0c\u540e\u8005\u8bb0\u5f55\u5728undo log</p> <p>\u5047\u8bbe\u4e00\u4e2a\u503c\u4ece 1 \u88ab\u6309\u987a\u5e8f\u6539\u6210\u4e86 2\u30013\u30014\uff0c\u5728\u56de\u6eda\u65e5\u5fd7\u91cc\u9762\u5c31\u4f1a\u6709\u7c7b\u4f3c\u4e0b\u9762\u7684\u8bb0\u5f55\u3002</p> <p></p> <ul> <li>\u5f53\u524d\u503c\u662f 4\uff0c\u4f46\u662f\u5728\u67e5\u8be2\u8fd9\u6761\u8bb0\u5f55\u7684\u65f6\u5019\uff0c\u4e0d\u540c\u65f6\u523b\u542f\u52a8\u7684\u4e8b\u52a1\u4f1a\u6709\u4e0d\u540c\u7684 read-view\u3002</li> <li>\u5728\u89c6\u56fe A\u3001B\u3001C \u91cc\u9762\uff0c\u8fd9\u4e00\u4e2a\u8bb0\u5f55\u7684\u503c\u5206\u522b\u662f 1\u30012\u30014\uff0c\u540c\u4e00\u6761\u8bb0\u5f55\u5728\u7cfb\u7edf\u4e2d\u53ef\u4ee5\u5b58\u5728\u591a\u4e2a\u7248\u672c\uff0c\u5c31\u662f\u6570\u636e\u5e93\u7684\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff08MVCC\uff09\u3002</li> </ul> <p>\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e2d\uff0c\u8868\u4e2d\u7684\u6570\u636e\u5176\u5b9e\u5df2\u7ecf\u6539\u53d8\uff0c\u5728\u524d\u9762\u7684\u89c6\u56fe\u91cc\uff0c\u9700\u8981\u67e5\u627e\u67d0\u6761\u8bb0\u5f55\u65f6\uff0c\u662f\u901a\u8fc7\u53d6\u5f53\u524d\u6570\u636e\uff0c\u518d\u53d6\u89c6\u56fe\u5bf9\u5e94\u7684\u56de\u6eda\u6bb5\u56de\u6eda\u5230\u8be5\u89c6\u56fe\u7684\u503c\u3002</p> <ul> <li>\u5bf9\u4e8e read-view A\uff0c\u8981\u5f97\u5230 1\uff0c\u5c31\u5fc5\u987b\u5c06\u5f53\u524d\u503c\u4f9d\u6b21\u6267\u884c\u56fe\u4e2d\u6240\u6709\u7684\u56de\u6eda\u64cd\u4f5c\u5f97\u5230\u3002</li> <li>\u5373\u4f7f\u73b0\u5728\u6709\u53e6\u5916\u4e00\u4e2a\u4e8b\u52a1\u6b63\u5728\u5c06 4 \u6539\u6210 5\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u8ddf read-view A\u3001B\u3001C \u5bf9\u5e94\u7684\u4e8b\u52a1\u662f\u4e0d\u4f1a\u51b2\u7a81\u7684</li> </ul>"},{"location":"chap1/3mysql_isolaion/#2-2","title":"2-2 \u56de\u6eda\u65e5\u5fd7\u7684\u5220\u9664","text":"<p>\u4ec0\u4e48\u65f6\u5019\u5220\u9664\u5462\uff1f\u7b54\u6848\u662f\uff0c\u5728\u4e0d\u9700\u8981\u7684\u65f6\u5019\u624d\u5220\u9664\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7cfb\u7edf\u4f1a\u5224\u65ad\uff0c\u5f53\u6ca1\u6709\u4e8b\u52a1\u518d\u9700\u8981\u7528\u5230\u8fd9\u4e9b\u56de\u6eda\u65e5\u5fd7\u65f6\uff0c\u56de\u6eda\u65e5\u5fd7\u4f1a\u88ab\u5220\u9664</p> <p>\u4ec0\u4e48\u65f6\u5019\u624d\u4e0d\u9700\u8981\u4e86\u5462\uff1f\u5c31\u662f\u5f53\u7cfb\u7edf\u91cc\u6ca1\u6709\u6bd4\u8fd9\u4e2a\u56de\u6eda\u65e5\u5fd7\u66f4\u65e9\u7684 read-view \u7684\u65f6\u5019\u3002</p> <p>\u6ca1\u6709\u5176\u5b83\u4e8b\u7269\u7ebf\u7a0b\u8fd8\u5728\u4f7f\u7528\u5f53\u524d\u7248\u672c\u7684undo\u65f6\u5019\uff0cpurge\u8fdb\u7a0b\u8fdb\u884c\u56de\u6536\u3002</p> <p>\u5f53\u6ca1\u6709\u6bd4\u56de\u6eda\u65e5\u5fd7\u66f4\u65e9\u7684\u8bfb\u89c6\u56fe\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u6570\u636e\u4e0d\u4f1a\u518d\u6709\u8c01\u9a71\u4f7f\u5b83\u56de\u6eda\u4e86\uff0c\u8fd9\u4e2a\u56de\u6eda\u65e5\u5fd7\u4e5f\u5c31\u5931\u53bb\u4e86\u7528\u6b66\u4e4b\u5730\uff0c\u53ef\u4ee5\u5220\u9664\u4e86</p>"},{"location":"chap1/3mysql_isolaion/#2-3","title":"2-3 \u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u957f\u4e8b\u52a1","text":"<p>\u957f\u4e8b\u52a1\u610f\u5473\u7740\u7cfb\u7edf\u91cc\u9762\u4f1a\u5b58\u5728\u5f88\u8001\u7684\u4e8b\u52a1\u89c6\u56fe\u3002</p> <p>\u7531\u4e8e\u8fd9\u4e9b\u4e8b\u52a1\u968f\u65f6\u53ef\u80fd\u8bbf\u95ee\u6570\u636e\u5e93\u91cc\u9762\u7684\u4efb\u4f55\u6570\u636e\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u524d\uff0c\u6570\u636e\u5e93\u91cc\u9762\u5b83\u53ef\u80fd\u7528\u5230\u7684\u56de\u6eda\u8bb0\u5f55\u90fd\u5fc5\u987b\u4fdd\u7559\uff0c\u8fd9\u5c31\u4f1a\u5bfc\u81f4\u5927\u91cf\u5360\u7528\u5b58\u50a8\u7a7a\u95f4\u3002</p> <p>\u957f\u4e8b\u52a1\u5bfc\u81f4\u5bf9\u5e94\u7684\u4e8b\u52a1\u89c6\u56fe\u957f\u65f6\u95f4\u5b58\u5728\uff0c\u90a3\u4e48\u5bf9\u5e94\u7684\u56de\u6eda\u65e5\u5fd7\u4e5f\u662f\u4f1a\u4e00\u76f4\u5b58\u5728\u7684</p> <p>\u5728 MySQL 5.5 \u53ca\u4ee5\u524d\u7684\u7248\u672c\uff0c\u56de\u6eda\u65e5\u5fd7\u662f\u8ddf\u6570\u636e\u5b57\u5178\u4e00\u8d77\u653e\u5728 ibdata \u6587\u4ef6\u91cc\u7684\uff0c\u5373\u4f7f\u957f\u4e8b\u52a1\u6700\u7ec8\u63d0\u4ea4\uff0c\u56de\u6eda\u6bb5\u88ab\u6e05\u7406\uff0c\u6587\u4ef6\u4e5f\u4e0d\u4f1a\u53d8\u5c0f\u3002</p> <p>\u9664\u4e86\u5bf9\u56de\u6eda\u6bb5\u7684\u5f71\u54cd\uff0c\u957f\u4e8b\u52a1\u8fd8\u5360\u7528\u9501\u8d44\u6e90\uff0c\u4e5f\u53ef\u80fd\u62d6\u57ae\u6574\u4e2a\u5e93\uff0c\u8fd9\u4e2a\u6211\u4eec\u4f1a\u5728\u540e\u9762\u8bb2\u9501\u7684\u65f6\u5019\u5c55\u5f00\u3002</p>"},{"location":"chap1/3mysql_isolaion/#3","title":"3\u3001\u4e8b\u52a1\u7684\u542f\u52a8\u65b9\u5f0f","text":"<p>MySQL \u7684\u4e8b\u52a1\u542f\u52a8\u65b9\u5f0f\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p>"},{"location":"chap1/3mysql_isolaion/#3-1","title":"3-1 \u663e\u5f0f\u542f\u52a8\u4e8b\u52a1\u8bed\u53e5","text":"<p>begin \u6216 start transaction\u3002\u914d\u5957\u7684\u63d0\u4ea4\u8bed\u53e5\u662f commit\uff0c\u56de\u6eda\u8bed\u53e5\u662f rollback\u3002</p>"},{"location":"chap1/3mysql_isolaion/#3-2-set-autocommit0","title":"3-2 <code>set autocommit=0</code>","text":"<ul> <li><code>set autocommit=0</code>\uff0c\u8fd9\u4e2a\u547d\u4ee4\u4f1a\u5c06\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u81ea\u52a8\u63d0\u4ea4\u5173\u6389\u3002</li> <li>\u610f\u5473\u7740\u5982\u679c\u4f60\u53ea\u6267\u884c\u4e00\u4e2a select \u8bed\u53e5\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u5c31\u542f\u52a8\u4e86\uff0c\u800c\u4e14\u5e76\u4e0d\u4f1a\u81ea\u52a8\u63d0\u4ea4\u3002</li> <li>\u8fd9\u4e2a\u4e8b\u52a1\u6301\u7eed\u5b58\u5728\u76f4\u5230\u4f60\u4e3b\u52a8\u6267\u884c <code>commit</code> \u6216 <code>rollback</code> \u8bed\u53e5\uff0c\u6216\u8005\u65ad\u5f00\u8fde\u63a5\u3002</li> </ul> <p>\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u9a8c\u8bc1\u4e86\uff0c\u7684\u786e\u53ea\u662f\u6267\u884c\u4e00\u4e2a\u67e5\u8be2\uff0c<code>innodb_trx</code>\u8868\u4e2d\u5c31\u591a\u4e86\u4e00\u6761<code>RUNNING</code>\u7684\u4e8b\u52a1 </p> <pre><code>select * from information_schema.innodb_trx ; \n\nset autocommit=0 \nselect * from user; \nselect * from information_schema.innodb_trx \n</code></pre> <p>\u6709\u4e9b\u5ba2\u6237\u7aef\u8fde\u63a5\u6846\u67b6\u4f1a\u9ed8\u8ba4\u8fde\u63a5\u6210\u529f\u540e\u5148\u6267\u884c\u4e00\u4e2a <code>set autocommit=0</code> \u7684\u547d\u4ee4\u3002\u8fd9\u5c31\u5bfc\u81f4\u63a5\u4e0b\u6765\u7684\u67e5\u8be2\u90fd\u5728\u4e8b\u52a1\u4e2d\uff0c\u5982\u679c\u662f\u957f\u8fde\u63a5\uff0c\u5c31\u5bfc\u81f4\u4e86\u610f\u5916\u7684\u957f\u4e8b\u52a1\u3002</p>"},{"location":"chap1/3mysql_isolaion/#3-3-set-autocommit1","title":"3-3 <code>set autocommit=1</code>\uff08\u63a8\u8350\uff09","text":"<p>\u56e0\u6b64\uff0c\u6211\u4f1a\u5efa\u8bae\u4f60\u603b\u662f\u4f7f\u7528 <code>set autocommit=1</code>, \u901a\u8fc7\u663e\u5f0f\u8bed\u53e5\u7684\u65b9\u5f0f\u6765\u542f\u52a8\u4e8b\u52a1\u3002</p> <p><code>autocommit=1;</code> \u8868\u793aMySQL\u81ea\u52a8\u5f00\u542f\u548c\u63d0\u4ea4\u4e8b\u52a1\u3002 </p> <p>\u6bd4\u5982\u6267\u884c\u4e00\u4e2aupdate\u8bed\u53e5\uff0c\u8bed\u53e5\u53ea\u5b8c\u6210\u540e\u5c31\u81ea\u52a8\u63d0\u4ea4\u4e86\u3002\u4e0d\u9700\u8981\u663e\u793a\u7684\u4f7f\u7528begin\u3001commit\u6765\u5f00\u542f\u548c\u63d0\u4ea4\u4e8b\u52a1\u3002 \u6240\u4ee5\uff0c\u5f53\u6211\u4eec\u9700\u8981\u5bf9\u67d0\u4e9b\u64cd\u4f5c\u4f7f\u7528\u4e8b\u52a1\u7684\u65f6\u5019\uff0c\u624b\u52a8\u7684\u7528begin\u3001commit\u6765\u5f00\u542f\u548c\u63d0\u4ea4\u4e8b\u52a1\u3002</p> <p>\u5728 autocommit \u4e3a 1 \u7684\u60c5\u51b5\u4e0b\uff0c\u7528 begin \u663e\u5f0f\u542f\u52a8\u7684\u4e8b\u52a1\uff0c\u5982\u679c\u6267\u884c commit \u5219\u63d0\u4ea4\u4e8b\u52a1\u3002</p> <p>\u5982\u679c\u6267\u884c <code>commit work and chain</code>\uff0c\u5219\u662f\u63d0\u4ea4\u4e8b\u52a1\u5e76\u81ea\u52a8\u542f\u52a8\u4e0b\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8fd9\u6837\u4e5f\u7701\u53bb\u4e86\u518d\u6b21\u6267\u884c begin \u8bed\u53e5\u7684\u5f00\u9500\u3002\u540c\u65f6\u5e26\u6765\u7684\u597d\u5904\u662f\u4ece\u7a0b\u5e8f\u5f00\u53d1\u7684\u89d2\u5ea6\u660e\u786e\u5730\u77e5\u9053\u6bcf\u4e2a\u8bed\u53e5\u662f\u5426\u5904\u4e8e\u4e8b\u52a1\u4e2d\u3002</p> <p>\u4f60\u53ef\u4ee5\u5728 <code>information_schema</code> \u5e93\u7684 <code>innodb_trx</code> \u8fd9\u4e2a\u8868\u4e2d\u67e5\u8be2\u957f\u4e8b\u52a1\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u4e2a\u8bed\u53e5\uff0c\u7528\u4e8e\u67e5\u627e\u6301\u7eed\u65f6\u95f4\u8d85\u8fc7 60s \u7684\u4e8b\u52a1\u3002</p> <pre><code>select * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))&gt;60\n</code></pre>"},{"location":"chap1/3mysql_isolaion/#4","title":"4\u3001\u5c0f\u8282\u603b\u7ed3","text":"<p>\u7cfb\u7edf\u91cc\u9762\u5e94\u8be5\u907f\u514d\u957f\u4e8b\u52a1\uff0c\u5982\u679c\u4f60\u662f\u4e1a\u52a1\u5f00\u53d1\u8d1f\u8d23\u4eba\u540c\u65f6\u4e5f\u662f\u6570\u636e\u5e93\u8d1f\u8d23\u4eba\uff0c\u4f60\u4f1a\u6709\u4ec0\u4e48\u65b9\u6848\u6765\u907f\u514d\u51fa\u73b0\u6216\u8005\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\u5462\uff1f</p>"},{"location":"chap1/3mysql_isolaion/#4-1","title":"4-1 \u9996\u5148\uff0c\u4ece\u5e94\u7528\u5f00\u53d1\u7aef\u6765\u770b\uff1a","text":"<ol> <li>\u786e\u8ba4\u662f\u5426\u4f7f\u7528\u4e86 <code>set autocommit=0</code>\u3002\u8fd9\u4e2a\u786e\u8ba4\u5de5\u4f5c\u53ef\u4ee5\u5728\u6d4b\u8bd5\u73af\u5883\u4e2d\u5f00\u5c55\uff0c\u628a MySQL \u7684 <code>general_log</code> \u5f00\u8d77\u6765\uff0c\u7136\u540e\u968f\u4fbf\u8dd1\u4e00\u4e2a\u4e1a\u52a1\u903b\u8f91\uff0c\u901a\u8fc7 <code>general_log</code> \u7684\u65e5\u5fd7\u6765\u786e\u8ba4\u3002\u4e00\u822c\u6846\u67b6\u5982\u679c\u4f1a\u8bbe\u7f6e\u8fd9\u4e2a\u503c\uff0c\u4e5f\u5c31\u4f1a\u63d0\u4f9b\u53c2\u6570\u6765\u63a7\u5236\u884c\u4e3a\uff0c\u4f60\u7684\u76ee\u6807\u5c31\u662f\u628a\u5b83\u6539\u6210 1\u3002</li> <li>\u786e\u8ba4\u662f\u5426\u6709\u4e0d\u5fc5\u8981\u7684\u53ea\u8bfb\u4e8b\u52a1\u3002\u6709\u4e9b\u6846\u67b6\u4f1a\u4e60\u60ef\u4e0d\u7ba1\u4ec0\u4e48\u8bed\u53e5\u5148\u7528 <code>begin/commit</code> \u6846\u8d77\u6765\u3002\u6211\u89c1\u8fc7\u6709\u4e9b\u662f\u4e1a\u52a1\u5e76\u6ca1\u6709\u8fd9\u4e2a\u9700\u8981\uff0c\u4f46\u662f\u4e5f\u628a\u597d\u51e0\u4e2a<code>select</code> \u8bed\u53e5\u653e\u5230\u4e86\u4e8b\u52a1\u4e2d\u3002\u8fd9\u79cd\u53ea\u8bfb\u4e8b\u52a1\u53ef\u4ee5\u53bb\u6389\u3002</li> <li>\u4e1a\u52a1\u8fde\u63a5\u6570\u636e\u5e93\u7684\u65f6\u5019\uff0c\u6839\u636e\u4e1a\u52a1\u672c\u8eab\u7684\u9884\u4f30\uff0c\u901a\u8fc7 <code>SET MAX_EXECUTION_TIME</code> \u547d\u4ee4\uff0c\u6765\u63a7\u5236\u6bcf\u4e2a\u8bed\u53e5\u6267\u884c\u7684\u6700\u957f\u65f6\u95f4\uff0c\u907f\u514d\u5355\u4e2a\u8bed\u53e5\u610f\u5916\u6267\u884c\u592a\u957f\u65f6\u95f4\u3002</li> </ol>"},{"location":"chap1/3mysql_isolaion/#4-2","title":"4-2 \u5176\u6b21\uff0c\u4ece\u6570\u636e\u5e93\u7aef\u6765\u770b\uff1a","text":"<ol> <li>\u76d1\u63a7 <code>information_schema.Innodb_trx</code> \u8868\uff0c\u8bbe\u7f6e\u957f\u4e8b\u52a1\u9608\u503c\uff0c\u8d85\u8fc7\u5c31\u62a5\u8b66 / \u6216\u8005 kill\uff1b</li> <li>Percona \u7684 <code>pt-kill</code> \u8fd9\u4e2a\u5de5\u5177\u4e0d\u9519\uff0c\u63a8\u8350\u4f7f\u7528\uff1b\u5728\u4e1a\u52a1\u529f\u80fd\u6d4b\u8bd5\u9636\u6bb5\u8981\u6c42\u8f93\u51fa\u6240\u6709\u7684 <code>general_log</code>\uff0c\u5206\u6790\u65e5\u5fd7\u884c\u4e3a\u63d0\u524d\u53d1\u73b0\u95ee\u9898\uff1b</li> <li>\u5982\u679c\u4f7f\u7528\u7684\u662f MySQL 5.6 \u6216\u8005\u66f4\u65b0\u7248\u672c\uff0c\u628a i<code>nnodb_undo_tablespaces</code> \u8bbe\u7f6e\u6210 <code>2</code>\uff08\u6216\u66f4\u5927\u7684\u503c\uff09\u3002\u5982\u679c\u771f\u7684\u51fa\u73b0\u5927\u4e8b\u52a1\u5bfc\u81f4\u56de\u6eda\u6bb5\u8fc7\u5927\uff0c\u8fd9\u6837\u8bbe\u7f6e\u540e\u6e05\u7406\u8d77\u6765\u66f4\u65b9\u4fbf\u3002</li> </ol>"},{"location":"chap1/4mysql_index/","title":"\u7b2c\u56db\u8282 \u6df1\u5165\u6d45\u51fa\u7d22\u5f15","text":"<p>\u7d22\u5f15\u7684\u51fa\u73b0\u5176\u5b9e\u5c31\u662f\u4e3a\u4e86\u63d0\u9ad8\u6570\u636e\u67e5\u8be2\u7684\u6548\u7387\uff0c\u5c31\u50cf\u4e66\u7684\u76ee\u5f55\u4e00\u6837\u3002\u540c\u6837\uff0c\u5bf9\u4e8e\u6570\u636e\u5e93\u7684\u8868\u800c\u8a00\uff0c\u7d22\u5f15\u5176\u5b9e\u5c31\u662f\u5b83\u7684\u201c\u76ee\u5f55\u201d\u3002</p>"},{"location":"chap1/4mysql_index/#1","title":"1\u3001\u7d22\u5f15\u7684\u5e38\u89c1\u6a21\u578b","text":"<p>\u7d22\u5f15\u7684\u51fa\u73b0\u662f\u4e3a\u4e86\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\uff0c\u4f46\u662f\u5b9e\u73b0\u7d22\u5f15\u7684\u65b9\u5f0f\u5374\u6709\u5f88\u591a\u79cd\uff0c\u6240\u4ee5\u8fd9\u91cc\u4e5f\u5c31\u5f15\u5165\u4e86\u7d22\u5f15\u6a21\u578b\u7684\u6982\u5ff5\u3002</p> <p>\u4e09\u79cd\u5e38\u89c1\u3001\u4e5f\u6bd4\u8f83\u7b80\u5355\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5b83\u4eec\u5206\u522b\u662f\u54c8\u5e0c\u8868\u3001\u6709\u5e8f\u6570\u7ec4\u548c\u641c\u7d22\u6811\u3002</p>"},{"location":"chap1/4mysql_index/#1-1","title":"1-1 \u54c8\u5e0c\u8868","text":"<p>\u54c8\u5e0c\u8868\u662f\u4e00\u79cd\u4ee5\u952e - \u503c\uff08key-value\uff09\u5b58\u50a8\u6570\u636e\u7684\u7ed3\u6784\uff0c\u6211\u4eec\u53ea\u8981\u8f93\u5165\u5f85\u67e5\u627e\u7684\u952e\u5373 key\uff0c\u5c31\u53ef\u4ee5\u627e\u5230\u5176\u5bf9\u5e94\u7684\u503c\u5373 Value\u3002</p> <p>\u54c8\u5e0c\u7684\u601d\u8def\u5f88\u7b80\u5355\uff0c\u628a\u503c\u653e\u5728\u6570\u7ec4\u91cc\uff0c\u7528\u4e00\u4e2a\u54c8\u5e0c\u51fd\u6570\u628a key \u6362\u7b97\u6210\u4e00\u4e2a\u786e\u5b9a\u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u628a value \u653e\u5728\u6570\u7ec4\u7684\u8fd9\u4e2a\u4f4d\u7f6e\u3002</p> <p>\u591a\u4e2a key \u503c\u7ecf\u8fc7\u54c8\u5e0c\u51fd\u6570\u7684\u6362\u7b97\uff0c\u4f1a\u51fa\u73b0\u540c\u4e00\u4e2a\u503c\u7684\u60c5\u51b5\u3002\u5904\u7406\u8fd9\u79cd\u60c5\u51b5\u7684\u4e00\u79cd\u65b9\u6cd5\u662f\uff0c\u62c9\u51fa\u4e00\u4e2a\u94fe\u8868</p> <p>Key value\u90fd\u653e\u5728\u94fe\u8868\u91cc\u9762\uff0c\u7528key\u7b97\u51fa\u7684\u54c8\u5e0c\u503c\u653e\u5728\u6570\u7ec4\u91cc\u3002\u5f53\u9700\u8981\u7528key\u67e5value\u65f6\uff0c\u5148\u7b97\u51fa\u54c8\u5e0c\u503c\uff0c\u627e\u5230\u6307\u5b9a\u6570\u7ec4\uff0c\u518d\u7528key\u53bb\u904d\u5386\u540e\u9762\u7684\u94fe\u8868\uff0c\u56e0\u4e3a\u94fe\u8868\u4e2d\u540c\u65f6\u5305\u542bkey value\uff0c\u5c31\u53ef\u4ee5\u627e\u5230\u6307\u5b9a\u7684value\u4e86\u3002</p> <p>\u5047\u8bbe\uff0c\u4f60\u73b0\u5728\u7ef4\u62a4\u7740\u4e00\u4e2a\u8eab\u4efd\u8bc1\u4fe1\u606f\u548c\u59d3\u540d\u7684\u8868\uff0c\u9700\u8981\u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u67e5\u627e\u5bf9\u5e94\u7684\u540d\u5b57\uff0c\u8fd9\u65f6\u5bf9\u5e94\u7684\u54c8\u5e0c\u7d22\u5f15\u7684\u793a\u610f\u56fe\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <ul> <li>User2 \u548c User4 \u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u7b97\u51fa\u6765\u7684\u503c\u90fd\u662f N\uff0c\u4f46\u6ca1\u5173\u7cfb\uff0c\u540e\u9762\u8fd8\u8ddf\u4e86\u4e00\u4e2a\u94fe\u8868\u3002</li> <li>\u5047\u8bbe\uff0c\u8fd9\u65f6\u5019\u4f60\u8981\u67e5 <code>ID_card_n2</code> \u5bf9\u5e94\u7684\u540d\u5b57\u662f\u4ec0\u4e48\uff0c\u5904\u7406\u6b65\u9aa4\u5c31\u662f\uff1a</li> <li>\u9996\u5148\uff0c\u5c06 <code>ID_card_n2</code> \u901a\u8fc7\u54c8\u5e0c\u51fd\u6570\u7b97\u51fa <code>N</code>\uff1b</li> <li>\u7136\u540e\uff0c\u6309\u987a\u5e8f\u904d\u5386\uff0c\u627e\u5230 User2\u3002</li> </ul> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u56fe\u4e2d\u56db\u4e2a <code>ID_card_n</code> \u7684\u503c\u5e76\u4e0d\u662f\u9012\u589e\u7684\uff0c\u8fd9\u6837\u505a\u7684\u597d\u5904\u662f\u589e\u52a0\u65b0\u7684 <code>User</code> \u65f6\u901f\u5ea6\u4f1a\u5f88\u5feb\uff0c\u53ea\u9700\u8981\u5f80\u540e\u8ffd\u52a0\u3002</p> <p>\u4f46\u7f3a\u70b9\u662f\uff0c\u56e0\u4e3a\u4e0d\u662f\u6709\u5e8f\u7684\uff0c\u6240\u4ee5\u54c8\u5e0c\u7d22\u5f15\u505a\u533a\u95f4\u67e5\u8be2\u7684\u901f\u5ea6\u662f\u5f88\u6162\u7684\u3002</p> <p>\u4f60\u53ef\u4ee5\u8bbe\u60f3\u4e0b\uff0c\u5982\u679c\u4f60\u73b0\u5728\u8981\u627e\u8eab\u4efd\u8bc1\u53f7\u5728<code>[ID_card_X, ID_card_Y]</code>\u8fd9\u4e2a\u533a\u95f4\u7684\u6240\u6709\u7528\u6237\uff0c\u5c31\u5fc5\u987b\u5168\u90e8\u626b\u63cf\u4e00\u904d</p> <p>\u6240\u4ee5\uff0c\u54c8\u5e0c\u8868\u8fd9\u79cd\u7ed3\u6784\u9002\u7528\u4e8e\u53ea\u6709\u7b49\u503c\u67e5\u8be2\u7684\u573a\u666f\uff0c\u6bd4\u5982 Memcached \u53ca\u5176\u4ed6\u4e00\u4e9b NoSQL \u5f15\u64ce\u3002</p> <p>\u800c\u6709\u5e8f\u6570\u7ec4\u5728\u7b49\u503c\u67e5\u8be2\u548c\u8303\u56f4\u67e5\u8be2\u573a\u666f\u4e2d\u7684\u6027\u80fd\u5c31\u90fd\u975e\u5e38\u4f18\u79c0\u3002</p>"},{"location":"chap1/4mysql_index/#1-2","title":"1-2 \u6709\u5e8f\u6570\u7ec4","text":"<p>\u8fd8\u662f\u4e0a\u9762\u8fd9\u4e2a\u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u67e5\u540d\u5b57\u7684\u4f8b\u5b50\uff0c\u5982\u679c\u6211\u4eec\u4f7f\u7528\u6709\u5e8f\u6570\u7ec4\u6765\u5b9e\u73b0\u7684\u8bdd\uff0c</p> <p></p> <p>\u5047\u8bbe\u8eab\u4efd\u8bc1\u53f7\u6ca1\u6709\u91cd\u590d\uff0c\u8fd9\u4e2a\u6570\u7ec4\u5c31\u662f\u6309\u7167\u8eab\u4efd\u8bc1\u53f7\u9012\u589e\u7684\u987a\u5e8f\u4fdd\u5b58\u7684\u3002\u8fd9\u65f6\u5019\u5982\u679c\u4f60\u8981\u67e5 <code>ID_card_n2</code> \u5bf9\u5e94\u7684\u540d\u5b57\uff0c\u7528\u4e8c\u5206\u6cd5\u5c31\u53ef\u4ee5\u5feb\u901f\u5f97\u5230\uff0c\u8fd9\u4e2a\u65f6\u95f4\u590d\u6742\u5ea6\u662f <code>O(log(N))</code>\u3002</p> <p>\u6570\u7ec4\u5df2\u6392\u5e8f\u65f6\u7528\u4e8c\u5206\u6cd5\u67e5\u8be2\u6700\u5feb</p> <p>\u540c\u65f6\u5f88\u663e\u7136\uff0c\u8fd9\u4e2a\u7d22\u5f15\u7ed3\u6784\u652f\u6301\u8303\u56f4\u67e5\u8be2\u3002</p> <p>\u4f60\u8981\u67e5\u8eab\u4efd\u8bc1\u53f7\u5728<code>[ID_card_X, ID_card_Y]</code>\u533a\u95f4\u7684 <code>User</code>\uff0c\u53ef\u4ee5\u5148\u7528\u4e8c\u5206\u6cd5\u627e\u5230 <code>ID_card_X</code>\uff08\u5982\u679c\u4e0d\u5b58\u5728<code>ID_card_X</code>\uff0c\u5c31\u627e\u5230\u5927\u4e8e <code>ID_card_X</code> \u7684\u7b2c\u4e00\u4e2a User\uff09\uff0c\u7136\u540e\u5411\u53f3\u904d\u5386\uff0c\u76f4\u5230\u67e5\u5230\u7b2c\u4e00\u4e2a\u5927\u4e8e <code>ID_card_Y</code> \u7684\u8eab\u4efd\u8bc1\u53f7\uff0c\u9000\u51fa\u5faa\u73af\u3002</p> <ul> <li>\u5982\u679c\u4ec5\u4ec5\u770b\u67e5\u8be2\u6548\u7387\uff0c\u6709\u5e8f\u6570\u7ec4\u5c31\u662f\u6700\u597d\u7684\u6570\u636e\u7ed3\u6784\u4e86\u3002</li> <li>\u4f46\u662f\uff0c\u5728\u9700\u8981\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\u5c31\u9ebb\u70e6\u4e86\uff0c\u4f60\u5f80\u4e2d\u95f4\u63d2\u5165\u4e00\u4e2a\u8bb0\u5f55\u5c31\u5fc5\u987b\u5f97\u632a\u52a8\u540e\u9762\u6240\u6709\u7684\u8bb0\u5f55\uff0c\u6210\u672c\u592a\u9ad8\u3002</li> </ul> <p>\u6709\u5e8f\u6570\u7ec4\u7d22\u5f15\u53ea\u9002\u7528\u4e8e\u9759\u6001\u5b58\u50a8\u5f15\u64ce</p> <p>\u6709\u5e8f\u6570\u7ec4\u4e0d\u7ba1\u662f\u7b49\u503c\u67e5\u627e\u548c\u8303\u56f4\u67e5\u627e\u90fd\u5f88\u4f18\u79c0\uff0c\u53ef\u662f\u6709\u5e8f\u6570\u7ec4\u4e0d\u9002\u5408\u66f4\u65b0\u5220\u9664\u589e\u52a0\u3002\u6bd4\u8f83\u9002\u5408\u9759\u6001\u6570\u7ec4\u9759\u6001\u6570\u636e\u3002</p>"},{"location":"chap1/4mysql_index/#1-3","title":"1-3 \u4e8c\u53c9\u641c\u7d22\u6811","text":"<p>\u4e8c\u53c9\u641c\u7d22\u6811\u7684\u7279\u70b9\u662f\uff1a</p> <p>\u7236\u8282\u70b9\u5de6\u5b50\u6811\u6240\u6709\u7ed3\u70b9\u7684\u503c\u5c0f\u4e8e\u7236\u8282\u70b9\u7684\u503c\uff0c\u53f3\u5b50\u6811\u6240\u6709\u7ed3\u70b9\u7684\u503c\u5927\u4e8e\u7236\u8282\u70b9\u7684\u503c\u3002</p> <p>\u8fd9\u6837\u5982\u679c\u4f60\u8981\u67e5 <code>ID_card_n2</code> \u7684\u8bdd\uff0c\u6309\u7167\u56fe\u4e2d\u7684\u641c\u7d22\u987a\u5e8f\u5c31\u662f\u6309\u7167 <code>UserA -&gt; UserC -&gt; UserF -&gt; User2</code> \u8fd9\u4e2a\u8def\u5f84\u5f97\u5230\u3002\u8fd9\u4e2a\u65f6\u95f4\u590d\u6742\u5ea6\u662f <code>O(log(N))</code>\u3002</p> <p>\u5f53\u7136\u4e3a\u4e86\u7ef4\u6301 O(log(N)) \u7684\u67e5\u8be2\u590d\u6742\u5ea6\uff0c\u4f60\u5c31\u9700\u8981\u4fdd\u6301\u8fd9\u68f5\u6811\u662f\u5e73\u8861\u4e8c\u53c9\u6811\u3002\u4e3a\u4e86\u505a\u8fd9\u4e2a\u4fdd\u8bc1\uff0c\u66f4\u65b0\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e5f\u662f O(log(N))\u3002</p> <p>\u67e5\u8be2\u548c\u66f4\u65b0\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u90fd\u662fO(logN)</p> <p>\u3002\u4e8c\u53c9\u6811\u662f\u641c\u7d22\u6548\u7387\u6700\u9ad8\u7684\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u5927\u591a\u6570\u7684\u6570\u636e\u5e93\u5b58\u50a8\u5374\u5e76\u4e0d\u4f7f\u7528\u4e8c\u53c9\u6811\u3002\u5176\u539f\u56e0\u662f\uff0c\u7d22\u5f15\u4e0d\u6b62\u5b58\u5728\u5185\u5b58\u4e2d\uff0c\u8fd8\u8981\u5199\u5230\u78c1\u76d8\u4e0a\u3002</p> <p>\u4e3a\u4ec0\u4e48\u6570\u636e\u5e93\u5b58\u50a8\u4f7f\u7528b+\u6811 \u800c\u4e0d\u662f\u4e8c\u53c9\u6811\uff0c\u56e0\u4e3a\u4e8c\u53c9\u6811\u6811\u9ad8\u8fc7\u9ad8\uff0c\u6bcf\u6b21\u67e5\u8be2\u90fd\u9700\u8981\u8bbf\u95ee\u8fc7\u591a\u8282\u70b9\uff0c\u5373\u8bbf\u95ee\u6570\u636e\u5757\u8fc7\u591a\uff0c\u800c\u4ece\u78c1\u76d8\u968f\u673a\u8bfb\u53d6\u6570\u636e\u5757\u8fc7\u4e8e\u8017\u65f6\u3002</p> <p>\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\u4e00\u68f5 100 \u4e07\u8282\u70b9\u7684\u5e73\u8861\u4e8c\u53c9\u6811\uff0c\u6811\u9ad8 20\u3002\u4e00\u6b21\u67e5\u8be2\u53ef\u80fd\u9700\u8981\u8bbf\u95ee 20 \u4e2a\u6570\u636e\u5757\u3002\u5728\u673a\u68b0\u786c\u76d8\u65f6\u4ee3\uff0c\u4ece\u78c1\u76d8\u968f\u673a\u8bfb\u4e00\u4e2a\u6570\u636e\u5757\u9700\u8981 10 ms \u5de6\u53f3\u7684\u5bfb\u5740\u65f6\u95f4\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bf9\u4e8e\u4e00\u4e2a 100 \u4e07\u884c\u7684\u8868\uff0c\u5982\u679c\u4f7f\u7528\u4e8c\u53c9\u6811\u6765\u5b58\u50a8\uff0c\u5355\u72ec\u8bbf\u95ee\u4e00\u4e2a\u884c\u53ef\u80fd\u9700\u8981 20 \u4e2a 10 ms \u7684\u65f6\u95f4\uff0c\u8fd9\u4e2a\u67e5\u8be2\u53ef\u771f\u591f\u6162\u7684\u3002</p> <p>\u4e3a\u4e86\u8ba9\u4e00\u4e2a\u67e5\u8be2\u5c3d\u91cf\u5c11\u5730\u8bfb\u78c1\u76d8\uff0c\u5c31\u5fc5\u987b\u8ba9\u67e5\u8be2\u8fc7\u7a0b\u8bbf\u95ee\u5c3d\u91cf\u5c11\u7684\u6570\u636e\u5757\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u5c31\u4e0d\u5e94\u8be5\u4f7f\u7528\u4e8c\u53c9\u6811\uff0c\u800c\u662f\u8981\u4f7f\u7528\u201cN \u53c9\u201d\u6811\u3002\u8fd9\u91cc\uff0c\u201cN \u53c9\u201d\u6811\u4e2d\u7684\u201cN\u201d\u53d6\u51b3\u4e8e\u6570\u636e\u5757\u7684\u5927\u5c0f\u3002</p> <p>\u4ee5 InnoDB \u7684\u4e00\u4e2a\u6574\u6570\u5b57\u6bb5\u7d22\u5f15\u4e3a\u4f8b\uff0c\u8fd9\u4e2a N \u5dee\u4e0d\u591a\u662f 1200\u3002 N \u53c9\u6811\u7531\u4e8e\u5728\u8bfb\u5199\u4e0a\u7684\u6027\u80fd\u4f18\u70b9\uff0c\u4ee5\u53ca\u9002\u914d\u78c1\u76d8\u7684\u8bbf\u95ee\u6a21\u5f0f\uff0c\u5df2\u7ecf\u88ab\u5e7f\u6cdb\u5e94\u7528\u5728\u6570\u636e\u5e93\u5f15\u64ce\u4e2d\u4e86\u3002</p> <p>\u5728 MySQL \u4e2d\uff0c\u7d22\u5f15\u662f\u5728\u5b58\u50a8\u5f15\u64ce\u5c42\u5b9e\u73b0\u7684\uff0c\u6240\u4ee5\u5e76\u6ca1\u6709\u7edf\u4e00\u7684\u7d22\u5f15\u6807\u51c6\uff0c\u5373\u4e0d\u540c\u5b58\u50a8\u5f15\u64ce\u7684\u7d22\u5f15\u7684\u5de5\u4f5c\u65b9\u5f0f\u5e76\u4e0d\u4e00\u6837\u3002</p>"},{"location":"chap1/4mysql_index/#2innodb","title":"2\u3001InnoDB \u7684\u7d22\u5f15\u6a21\u578b","text":"<p>\u5728 InnoDB \u4e2d\uff0c\u8868\u90fd\u662f\u6839\u636e\u4e3b\u952e\u987a\u5e8f\u4ee5\u7d22\u5f15\u7684\u5f62\u5f0f\u5b58\u653e\u7684\uff0c\u8fd9\u79cd\u5b58\u50a8\u65b9\u5f0f\u7684\u8868\u79f0\u4e3a\u7d22\u5f15\u7ec4\u7ec7\u8868\u3002</p> <p>\u53c8\u56e0\u4e3a\u524d\u9762\u6211\u4eec\u63d0\u5230\u7684\uff0cInnoDB \u4f7f\u7528\u4e86 B+ \u6811\u7d22\u5f15\u6a21\u578b\uff0c\u6240\u4ee5\u6570\u636e\u90fd\u662f\u5b58\u50a8\u5728 B+ \u6811\u4e2d\u7684\u3002</p> <p>\u6bcf\u4e00\u4e2a\u7d22\u5f15\u5728 InnoDB \u91cc\u9762\u5bf9\u5e94\u4e00\u68f5 B+ \u6811\u3002</p> <p>\u5047\u8bbe\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u4e3b\u952e\u5217\u4e3a ID \u7684\u8868\uff0c\u8868\u4e2d\u6709\u5b57\u6bb5 k\uff0c\u5e76\u4e14\u5728 k \u4e0a\u6709\u7d22\u5f15\u3002</p> <pre><code>mysql&gt; create table T(\nid int primary key, \nk int not null, \nname varchar(16),\nindex (k)) engine=InnoDB;\n</code></pre> <p>\u8868\u4e2d <code>R1~R5</code> \u7684 (ID,k) \u503c\u5206\u522b\u4e3a (100,1)\u3001(200,2)\u3001(300,3)\u3001(500,5) \u548c (600,6)\uff0c\u4e24\u68f5\u6811\u7684\u793a\u4f8b\u793a\u610f\u56fe\u5982\u4e0b\u3002</p> <p></p> <p>\u7d22\u5f15\u7c7b\u578b\u5206\u4e3a\u4e3b\u952e\u7d22\u5f15\u548c\u975e\u4e3b\u952e\u7d22\u5f15\u3002</p> <p>\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u5b58\u8be5\u884c\u7684\u6570\u636e\uff0c\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u7ed3\u70b9\u4fdd\u5b58\u7684\u662f\u4e3b\u952e\u7d22\u5f15\u7684\u5f15\u7528\u3002</p> <ul> <li>\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5b58\u7684\u662f\u6574\u884c\u6570\u636e\u3002\u5728 InnoDB \u91cc\uff0c\u4e3b\u952e\u7d22\u5f15\u4e5f\u88ab\u79f0\u4e3a\u805a\u7c07\u7d22\u5f15\uff08clustered index\uff09\u3002</li> <li>\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5185\u5bb9\u662f\u4e3b\u952e\u7684\u503c\u3002\u5728 InnoDB \u91cc\uff0c\u975e\u4e3b\u952e\u7d22\u5f15\u4e5f\u88ab\u79f0\u4e3a\u4e8c\u7ea7\u7d22\u5f15\uff08secondary index\uff09\u3002</li> </ul> <p>key:\u4e3b\u952e\u7684\u503c\uff0cvalue:\u6574\u884c\u6570\u636e\u3002 \u666e\u901a\u5217\u7d22\u5f15\uff1a key\uff1a\u7d22\u5f15\u5217\u7684\u503c\uff0c value:\u4e3b\u952e\u7684\u503c\u3002</p> <p>\u57fa\u4e8e\u4e3b\u952e\u7d22\u5f15\u548c\u666e\u901a\u7d22\u5f15\u7684\u67e5\u8be2\u6709\u4ec0\u4e48\u533a\u522b\uff1f</p> <ul> <li>\u5982\u679c\u8bed\u53e5\u662f <code>select * from T where ID=500</code>\uff0c\u5373\u4e3b\u952e\u67e5\u8be2\u65b9\u5f0f\uff0c\u5219\u53ea\u9700\u8981\u641c\u7d22 ID \u8fd9\u68f5 B+ \u6811\uff1b</li> <li>\u5982\u679c\u8bed\u53e5\u662f <code>select * from T where k=5</code>\uff0c\u5373\u666e\u901a\u7d22\u5f15\u67e5\u8be2\u65b9\u5f0f\uff0c\u5219\u9700\u8981\u5148\u641c\u7d22 <code>k</code>\u7d22\u5f15\u6811\uff0c\u5f97\u5230 <code>ID</code> \u7684\u503c\u4e3a <code>500</code>\uff0c\u518d\u5230 <code>ID</code> \u7d22\u5f15\u6811\u641c\u7d22\u4e00\u6b21\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u56de\u8868\u3002</li> </ul> <p>\u666e\u901a\u7d22\u5f15\u6216\u8005\u53c8\u53eb\u4e8c\u7ea7\u7d22\u5f15\u67e5\u8be2\u65b9\u5f0f: \u9700\u8981\u5148\u67e5\u4e8c\u7ea7\u7d22\u5f15\u6811,\u67e5\u5230id,\u7136\u540e\u6839\u636eid\u67e5\u8be2\u4e3b\u952e\u7d22\u5f15\u6811</p>"},{"location":"chap1/4mysql_index/#3","title":"3\u3001\u7d22\u5f15\u7ef4\u62a4","text":"<p>B+ \u6811\u4e3a\u4e86\u7ef4\u62a4\u7d22\u5f15\u6709\u5e8f\u6027\uff0c\u5728\u63d2\u5165\u65b0\u503c\u7684\u65f6\u5019\u9700\u8981\u505a\u5fc5\u8981\u7684\u7ef4\u62a4\u3002</p> <p>\u4ee5\u4e0a\u9762\u8fd9\u4e2a\u56fe\u4e3a\u4f8b\uff0c\u5982\u679c\u63d2\u5165\u65b0\u7684\u884c ID \u503c\u4e3a 700\uff0c\u5219\u53ea\u9700\u8981\u5728 R5 \u7684\u8bb0\u5f55\u540e\u9762\u63d2\u5165\u4e00\u4e2a\u65b0\u8bb0\u5f55\u3002\u5982\u679c\u65b0\u63d2\u5165\u7684 ID \u503c\u4e3a 400\uff0c\u5c31\u76f8\u5bf9\u9ebb\u70e6\u4e86\uff0c\u9700\u8981\u903b\u8f91\u4e0a\u632a\u52a8\u540e\u9762\u7684\u6570\u636e\uff0c\u7a7a\u51fa\u4f4d\u7f6e</p> <p>\u800c\u66f4\u7cdf\u7684\u60c5\u51b5\u662f\uff0c\u5982\u679c <code>R5</code> \u6240\u5728\u7684\u6570\u636e\u9875\u5df2\u7ecf\u6ee1\u4e86\uff0c\u6839\u636e <code>B+</code> \u6811\u7684\u7b97\u6cd5\uff0c\u8fd9\u65f6\u5019\u9700\u8981\u7533\u8bf7\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u9875\uff0c\u7136\u540e\u632a\u52a8\u90e8\u5206\u6570\u636e\u8fc7\u53bb\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u79f0\u4e3a\u9875\u5206\u88c2\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6027\u80fd\u81ea\u7136\u4f1a\u53d7\u5f71\u54cd\u3002</p> <ul> <li>\u9664\u4e86\u6027\u80fd\u5916\uff0c\u9875\u5206\u88c2\u64cd\u4f5c\u8fd8\u5f71\u54cd\u6570\u636e\u9875\u7684\u5229\u7528\u7387\u3002\u539f\u672c\u653e\u5728\u4e00\u4e2a\u9875\u7684\u6570\u636e\uff0c\u73b0\u5728\u5206\u5230\u4e24\u4e2a\u9875\u4e2d\uff0c\u6574\u4f53\u7a7a\u95f4\u5229\u7528\u7387\u964d\u4f4e\u5927\u7ea6 50%\u3002</li> <li>\u5f53\u7136\u6709\u5206\u88c2\u5c31\u6709\u5408\u5e76\u3002\u5f53\u76f8\u90bb\u4e24\u4e2a\u9875\u7531\u4e8e\u5220\u9664\u4e86\u6570\u636e\uff0c\u5229\u7528\u7387\u5f88\u4f4e\u4e4b\u540e\uff0c\u4f1a\u5c06\u6570\u636e\u9875\u505a\u5408\u5e76\u3002\u5408\u5e76\u7684\u8fc7\u7a0b\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u662f\u5206\u88c2\u8fc7\u7a0b\u7684\u9006\u8fc7\u7a0b\u3002</li> </ul> <p>\u5c0f\u7ed3\uff1a \u4e00\u4e2a\u6570\u636e\u9875\u6ee1\u4e86\uff0c\u6309\u7167B+Tree\u7b97\u6cd5\uff0c\u65b0\u589e\u52a0\u4e00\u4e2a\u6570\u636e\u9875\uff0c\u53eb\u505a\u9875\u5206\u88c2\uff0c\u4f1a\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d\u3002\u7a7a\u95f4\u5229\u7528\u7387\u964d\u4f4e\u5927\u698250%\u3002\u5f53\u76f8\u90bb\u7684\u4e24\u4e2a\u6570\u636e\u9875\u5229\u7528\u7387\u5f88\u4f4e\u7684\u65f6\u5019\u4f1a\u505a\u6570\u636e\u9875\u5408\u5e76\uff0c\u5408\u5e76\u7684\u8fc7\u7a0b\u662f\u5206\u88c2\u8fc7\u7a0b\u7684\u9006\u8fc7\u7a0b\u3002</p> <p>\u81ea\u589e\u4e3b\u952e\u9632\u6b62\u9875\u5206\u88c2\uff0c\u903b\u8f91\u5220\u9664\u5e76\u975e\u7269\u7406\u5220\u9664\u9632\u6b62\u9875\u5408\u5e76</p> <p>\u81ea\u589e\u4e3b\u952e\u662f\u6307\u81ea\u589e\u5217\u4e0a\u5b9a\u4e49\u7684\u4e3b\u952e\uff0c\u5728\u5efa\u8868\u8bed\u53e5\u4e2d\u4e00\u822c\u662f\u8fd9\u4e48\u5b9a\u4e49\u7684\uff1a</p> <p><code>NOT NULL PRIMARY KEY AUTO_INCREMENT</code></p> <ul> <li>\u63d2\u5165\u65b0\u8bb0\u5f55\u7684\u65f6\u5019\u53ef\u4ee5\u4e0d\u6307\u5b9a ID \u7684\u503c\uff0c\u7cfb\u7edf\u4f1a\u83b7\u53d6\u5f53\u524d ID \u6700\u5927\u503c\u52a0 1 \u4f5c\u4e3a\u4e0b\u4e00\u6761\u8bb0\u5f55\u7684 ID \u503c\u3002</li> <li>\u81ea\u589e\u4e3b\u952e\u7684\u63d2\u5165\u6570\u636e\u6a21\u5f0f\uff0c\u6b63\u7b26\u5408\u4e86\u6211\u4eec\u524d\u9762\u63d0\u5230\u7684\u9012\u589e\u63d2\u5165\u7684\u573a\u666f\u3002\u6bcf\u6b21\u63d2\u5165\u4e00\u6761\u65b0\u8bb0\u5f55\uff0c\u90fd\u662f\u8ffd\u52a0\u64cd\u4f5c\uff0c\u90fd\u4e0d\u6d89\u53ca\u5230\u632a\u52a8\u5176\u4ed6\u8bb0\u5f55\uff0c\u4e5f\u4e0d\u4f1a\u89e6\u53d1\u53f6\u5b50\u8282\u70b9\u7684\u5206\u88c2\u3002</li> </ul> <p>\u800c\u6709\u4e1a\u52a1\u903b\u8f91\u7684\u5b57\u6bb5\u505a\u4e3b\u952e\uff0c\u5219\u5f80\u5f80\u4e0d\u5bb9\u6613\u4fdd\u8bc1\u6709\u5e8f\u63d2\u5165\uff0c\u8fd9\u6837\u5199\u6570\u636e\u6210\u672c\u76f8\u5bf9\u8f83\u9ad8\u3002</p> <p>\u53ef\u4ee5\u81ea\u5df1\u6839\u636e\u4e1a\u52a1\u9700\u8981\uff0c\u81ea\u5df1\u751f\u6210\u552f\u4e00\u7684\u81ea\u589e\u7684ID\uff0c\u8fd9\u6837\u65e2\u53ef\u4ee5\u80fd\u6ee1\u8db3\u4e1a\u52a1\u9700\u8981\uff0c\u53c8\u80fd\u4fdd\u8bc1\u63d2\u5165\u7684\u6027\u80fd\u3002 \u751f\u6210\u552f\u4e00ID\u7684\u7b97\u6cd5\uff1a\u96ea\u82b1\u7b97\u6cd5\u7b49\u3002</p> <p>\u4ece\u6027\u80fd\u548c\u5b58\u50a8\u7a7a\u95f4\u65b9\u9762\u8003\u91cf\uff0c\u81ea\u589e\u4e3b\u952e\u5f80\u5f80\u662f\u66f4\u5408\u7406\u7684\u9009\u62e9\u3002</p> <p>\u7531\u4e8e\u6bcf\u4e2a\u975e\u4e3b\u952e\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u4e0a\u90fd\u662f\u4e3b\u952e\u7684\u503c\u3002\u5982\u679c\u7528\u8eab\u4efd\u8bc1\u53f7\u505a\u4e3b\u952e\uff0c\u90a3\u4e48\u6bcf\u4e2a\u4e8c\u7ea7\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5360\u7528\u7ea6 20 \u4e2a\u5b57\u8282\uff0c\u800c\u5982\u679c\u7528\u6574\u578b\u505a\u4e3b\u952e\uff0c\u5219\u53ea\u8981 4 \u4e2a\u5b57\u8282\uff0c\u5982\u679c\u662f\u957f\u6574\u578b\uff08bigint\uff09\u5219\u662f 8 \u4e2a\u5b57\u8282\u3002</p> <p>\u663e\u7136\uff0c\u4e3b\u952e\u957f\u5ea6\u8d8a\u5c0f\uff0c\u666e\u901a\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5c31\u8d8a\u5c0f\uff0c\u666e\u901a\u7d22\u5f15\u5360\u7528\u7684\u7a7a\u95f4\u4e5f\u5c31\u8d8a\u5c0f\u3002</p> <p>\u6bcf\u4e00\u5f20\u8868\u5176\u5b9e\u5c31\u662f\u597d\u51e0\u68f5<code>B+</code>\u6811\uff0c\u6811\u7ed3\u70b9\u7684<code>key</code>\u503c\u5c31\u662f\u67d0\u4e00\u884c\u7684\u4e3b\u952e\uff0c<code>value</code>\u662f\u8be5\u884c\u7684\u5176\u4ed6\u6570\u636e\u3002\u65b0\u5efa\u7d22\u5f15\u5c31\u662f\u65b0\u589e\u4e00\u4e2aB+\u6811\uff0c\u67e5\u8be2\u4e0d\u8d70\u7d22\u5f15\u5c31\u662f\u904d\u5386\u4e3bB+\u6811\u3002</p>"},{"location":"chap1/4mysql_index/#41","title":"4\u3001\u601d\u8003\u98981","text":"<p>\u5bf9\u4e8e\u4e0a\u9762\u4f8b\u5b50\u4e2d\u7684 InnoDB \u8868 T\uff0c\u5982\u679c\u4f60\u8981\u91cd\u5efa\u7d22\u5f15 k\uff0c\u4f60\u7684\u4e24\u4e2a SQL \u8bed\u53e5\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p> <pre><code>alter table T drop index k;\nalter table T add index(k);\n</code></pre> <p>\u5982\u679c\u4f60\u8981\u91cd\u5efa\u4e3b\u952e\u7d22\u5f15\uff0c\u4e5f\u53ef\u4ee5\u8fd9\u4e48\u5199\uff1a</p> <pre><code>alter table T drop primary key;\nalter table T add primary key(id);\n</code></pre> <p>\u6211\u7684\u95ee\u9898\u662f\uff0c\uff0c\u901a\u8fc7\u4e24\u4e2a alter \u8bed\u53e5\u91cd\u5efa\u7d22\u5f15 k\uff0c\u4ee5\u53ca\u901a\u8fc7\u4e24\u4e2a alter \u8bed\u53e5\u91cd\u5efa\u4e3b\u952e\u7d22\u5f15\u662f\u5426\u5408\u7406\u3002</p> <ul> <li>\u91cd\u5efa\u7d22\u5f15 k \u7684\u505a\u6cd5\u662f\u5408\u7406\u7684\uff0c\u53ef\u4ee5\u8fbe\u5230\u7701\u7a7a\u95f4\u7684\u76ee\u7684\u3002</li> <li>\u4f46\u662f\uff0c\u91cd\u5efa\u4e3b\u952e\u7684\u8fc7\u7a0b\u4e0d\u5408\u7406\u3002\u4e0d\u8bba\u662f\u5220\u9664\u4e3b\u952e\u8fd8\u662f\u521b\u5efa\u4e3b\u952e\uff0c\u90fd\u4f1a\u5c06\u6574\u4e2a\u8868\u91cd\u5efa\u3002</li> </ul>"},{"location":"chap1/4mysql_index/#5","title":"5\u3001\u8986\u76d6\u7d22\u5f15","text":"<p>\u5728\u4e0b\u9762\u8fd9\u4e2a\u8868 T \u4e2d\uff0c\u5982\u679c\u6211\u6267\u884c <code>select * from T where k between 3 and 5</code>\uff0c\u9700\u8981\u6267\u884c\u51e0\u6b21\u6811\u7684\u641c\u7d22\u64cd\u4f5c\uff0c\u4f1a\u626b\u63cf\u591a\u5c11\u884c\uff1f</p> <pre><code>mysql&gt; create table T (\nID int primary key,\nk int NOT NULL DEFAULT 0, \ns varchar(16) NOT NULL DEFAULT '',\nindex k(k))\nengine=InnoDB;\n\ninsert into T values(100,1, 'aa'),(200,2,'bb'),(300,3,'cc'),(500,5,'ee'),(600,6,'ff'),(700,7,'gg');\n</code></pre> <p></p> <p>\u73b0\u5728\uff0c\u6211\u4eec\u4e00\u8d77\u6765\u770b\u770b\u8fd9\u6761 SQL \u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u6d41\u7a0b\uff1a</p> <ol> <li>\u5728 k \u7d22\u5f15\u6811\u4e0a\u627e\u5230 k=3 \u7684\u8bb0\u5f55\uff0c\u53d6\u5f97 ID = 300\uff1b</li> <li>\u518d\u5230 ID \u7d22\u5f15\u6811\u67e5\u5230 ID=300 \u5bf9\u5e94\u7684 R3\uff1b</li> <li>\u5728 k \u7d22\u5f15\u6811\u53d6\u4e0b\u4e00\u4e2a\u503c k=5\uff0c\u53d6\u5f97 ID=500\uff1b</li> <li>\u518d\u56de\u5230 ID \u7d22\u5f15\u6811\u67e5\u5230 ID=500 \u5bf9\u5e94\u7684 R4\uff1b</li> <li>\u5728 k \u7d22\u5f15\u6811\u53d6\u4e0b\u4e00\u4e2a\u503c k=6\uff0c\u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u5faa\u73af\u7ed3\u675f\u3002</li> </ol> <p>\u56de\u5230\u4e3b\u952e\u7d22\u5f15\u6811\u641c\u7d22\u7684\u8fc7\u7a0b\uff0c\u6211\u4eec\u79f0\u4e3a\u56de\u8868</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8fd9\u4e2a\u67e5\u8be2\u8fc7\u7a0b\u8bfb\u4e86 k \u7d22\u5f15\u6811\u7684 3 \u6761\u8bb0\u5f55\uff08\u6b65\u9aa4 1\u30013 \u548c 5\uff09\uff0c\u56de\u8868\u4e86\u4e24\u6b21\uff08\u6b65\u9aa4 2 \u548c 4\uff09\u3002</p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u7531\u4e8e\u67e5\u8be2\u7ed3\u679c\u6240\u9700\u8981\u7684\u6570\u636e\u53ea\u5728\u4e3b\u952e\u7d22\u5f15\u4e0a\u6709\uff0c\u6240\u4ee5\u4e0d\u5f97\u4e0d\u56de\u8868\u3002</p> <p>\u5982\u679c\u6267\u884c\u7684\u8bed\u53e5\u662f</p> <pre><code>select ID from T where k between 3 and 5\n</code></pre> <p>\u8fd9\u65f6\u53ea\u9700\u8981\u67e5 ID \u7684\u503c\uff0c\u800c ID \u7684\u503c\u5df2\u7ecf\u5728 k \u7d22\u5f15\u6811\u4e0a\u4e86\uff0c\u56e0\u6b64\u53ef\u4ee5\u76f4\u63a5\u63d0\u4f9b\u67e5\u8be2\u7ed3\u679c\uff0c\u4e0d\u9700\u8981\u56de\u8868</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5728\u8fd9\u4e2a\u67e5\u8be2\u91cc\u9762\uff0c\u7d22\u5f15 k \u5df2\u7ecf\u201c\u8986\u76d6\u4e86\u201d\u6211\u4eec\u7684\u67e5\u8be2\u9700\u6c42\uff0c\u6211\u4eec\u79f0\u4e3a\u8986\u76d6\u7d22\u5f15\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5f15\u64ce\u5185\u90e8\u4f7f\u7528\u8986\u76d6\u7d22\u5f15\u5728\u7d22\u5f15 k \u4e0a\u5176\u5b9e\u8bfb\u4e86\u4e09\u4e2a\u8bb0\u5f55\uff0cR3~R5\uff08\u5bf9\u5e94\u7684\u7d22\u5f15 k \u4e0a\u7684\u8bb0\u5f55\u9879\uff09\uff0c\u4f46\u662f\u5bf9\u4e8e MySQL \u7684 Server \u5c42\u6765\u8bf4\uff0c\u5b83\u5c31\u662f\u627e\u5f15\u64ce\u62ff\u5230\u4e86\u4e24\u6761\u8bb0\u5f55\uff0c\u56e0\u6b64 MySQL \u8ba4\u4e3a\u626b\u63cf\u884c\u6570\u662f 2\u3002</p> <p>\u5728\u4e00\u4e2a\u5e02\u6c11\u4fe1\u606f\u8868\u4e0a\uff0c\u662f\u5426\u6709\u5fc5\u8981\u5c06\u8eab\u4efd\u8bc1\u53f7\u548c\u540d\u5b57\u5efa\u7acb\u8054\u5408\u7d22\u5f15\uff1f</p> <p>\u4e00\u822c\u4e0d\u5efa\u8bae\u4f7f\u7528\u4e1a\u52a1\u76f8\u5173\u5b57\u6bb5\u4f5c\u4e3a\u4e3b\u952e\uff0c\u5373\u4f7f\u5176\u5177\u6709\u552f\u4e00\u6027\u7279\u6027\uff08\u5982\u8eab\u4efd\u8bc1\uff09\u3002\u56e0\u4e3a\uff0c\u5f53\u4e1a\u52a1\u53d8\u66f4\uff08\u5982\u8eab\u4efd\u8bc1\u5347\u4f4d\uff09\uff0c\u5c31\u4f1a\u5e26\u6765\u707e\u96be\u3002</p> <pre><code>\nCREATE TABLE `tuser` (\n  `id` int(11) NOT NULL,\n  `id_card` varchar(32) DEFAULT NULL,\n  `name` varchar(32) DEFAULT NULL,\n  `age` int(11) DEFAULT NULL,\n  `ismale` tinyint(1) DEFAULT NULL,\n  PRIMARY KEY (`id`),\n  KEY `id_card` (`id_card`),\n  KEY `name_age` (`name`,`age`)\n) ENGINE=InnoDB\n</code></pre> <p>\u6211\u4eec\u77e5\u9053\uff0c\u8eab\u4efd\u8bc1\u53f7\u662f\u5e02\u6c11\u7684\u552f\u4e00\u6807\u8bc6\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u6709\u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u5e02\u6c11\u4fe1\u606f\u7684\u9700\u6c42\uff0c\u6211\u4eec\u53ea\u8981\u5728\u8eab\u4efd\u8bc1\u53f7\u5b57\u6bb5\u4e0a\u5efa\u7acb\u7d22\u5f15\u5c31\u591f\u4e86\u3002\u800c\u518d\u5efa\u7acb\u4e00\u4e2a\uff08\u8eab\u4efd\u8bc1\u53f7\u3001\u59d3\u540d\uff09\u7684\u8054\u5408\u7d22\u5f15\uff0c\u662f\u4e0d\u662f\u6d6a\u8d39\u7a7a\u95f4\uff1f</p> <p>\u7ed9<code>id_card</code> \u548c <code>name</code> \u5efa\u7acb\u8054\u5408\u7d22\u5f15\u540e\uff0c<code>name</code> \u7684\u503c\u4e5f\u4f1a\u88ab\u4fdd\u5b58\u5728<code>id_card</code>\u7d22\u5f15\u6811\u7684\u8282\u70b9\u4e0a\uff0c\u8fd9\u6837\u6839\u636e\u7ed9\u5b9a<code>id_card</code>\u7684\u503c\u627e\u5230\u7684\u5bf9\u5e94\u884c\u65f6\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u83b7\u53d6\u5230<code>name</code>\u4e86\uff0c\u800c\u4e0d\u9700\u8981\u62ff\u7740\u5bf9\u5e94\u7684\u4e3b\u952e\u518d\u8fdb\u884c\u56de\u8868\u64cd\u4f5c\u3002</p> <p>\u5982\u679c\u73b0\u5728\u6709\u4e00\u4e2a\u9ad8\u9891\u8bf7\u6c42\uff0c\u8981\u6839\u636e\u5e02\u6c11\u7684\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u4ed6\u7684\u59d3\u540d\uff0c\u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u5c31\u6709\u610f\u4e49\u4e86\u3002\u5b83\u53ef\u4ee5\u5728\u8fd9\u4e2a\u9ad8\u9891\u8bf7\u6c42\u4e0a\u7528\u5230\u8986\u76d6\u7d22\u5f15\uff0c\u4e0d\u518d\u9700\u8981\u56de\u8868\u67e5\u6574\u884c\u8bb0\u5f55\uff0c\u51cf\u5c11\u8bed\u53e5\u7684\u6267\u884c\u65f6\u95f4\u3002</p> <p>\u5728\u8054\u5408\u7d22\u5f15\u4e0a\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u907f\u514d\u56de\u8868\u3002\u8fd9\u4e2a\u4e5f\u53ef\u4ee5\u5e94\u7528\u5230\u9879\u76ee\u5f00\u53d1\u4e2d\u3002</p> <p>\u5f53\u7136\uff0c\u7d22\u5f15\u5b57\u6bb5\u7684\u7ef4\u62a4\u603b\u662f\u6709\u4ee3\u4ef7\u7684\u3002\u56e0\u6b64\uff0c\u5728\u5efa\u7acb\u5197\u4f59\u7d22\u5f15\u6765\u652f\u6301\u8986\u76d6\u7d22\u5f15\u65f6\u5c31\u9700\u8981\u6743\u8861\u8003\u8651\u4e86</p>"},{"location":"chap1/4mysql_index/#6","title":"6\u3001\u6700\u5de6\u524d\u7f00\u539f\u5219","text":"<p>\u770b\u5230\u8fd9\u91cc\u4f60\u4e00\u5b9a\u6709\u4e00\u4e2a\u7591\u95ee\uff0c\u5982\u679c\u4e3a\u6bcf\u4e00\u79cd\u67e5\u8be2\u90fd\u8bbe\u8ba1\u4e00\u4e2a\u7d22\u5f15\uff0c\u7d22\u5f15\u662f\u4e0d\u662f\u592a\u591a\u4e86\u3002</p> <p>B+ \u6811\u8fd9\u79cd\u7d22\u5f15\u7ed3\u6784\uff0c\u53ef\u4ee5\u5229\u7528\u7d22\u5f15\u7684\u201c\u6700\u5de6\u524d\u7f00\u201d\uff0c\u6765\u5b9a\u4f4d\u8bb0\u5f55\u3002</p> <p>\u4e3a\u4e86\u76f4\u89c2\u5730\u8bf4\u660e\u8fd9\u4e2a\u6982\u5ff5\uff0c\u6211\u4eec\u7528\uff08name\uff0cage\uff09\u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u6765\u5206\u6790\u3002</p> <p></p> <p>\u8054\u5408\u7d22\u5f15\u5148\u6839\u636e\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u6392\u5e8f\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u6709\u76f8\u540c\u7684\uff0c\u5c31\u6309\u7167\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\u6392\u5e8f\uff0c\u6ce8\u610f\uff0c\u8fd9\u91cc\u4ec5\u4ec5\u6709\u76f8\u540c\u7684\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u60c5\u51b5\u4e0b\uff0c\u624d\u4f1a\u6839\u636e\u7b2c\u4e8c\u4e2a\u5b57\u6bb5\u6392\u5e8f\u3002</p> <ul> <li>\u5f53\u4f60\u7684\u903b\u8f91\u9700\u6c42\u662f\u67e5\u5230\u6240\u6709\u540d\u5b57\u662f\u201c\u5f20\u4e09\u201d\u7684\u4eba\u65f6\uff0c\u53ef\u4ee5\u5feb\u901f\u5b9a\u4f4d\u5230 ID4\uff0c\u7136\u540e\u5411\u540e\u904d\u5386\u5f97\u5230\u6240\u6709\u9700\u8981\u7684\u7ed3\u679c\u3002</li> <li>\u5982\u679c\u4f60\u8981\u67e5\u7684\u662f\u6240\u6709\u540d\u5b57\u7b2c\u4e00\u4e2a\u5b57\u662f\u201c\u5f20\u201d\u7684\u4eba\uff0c\u4f60\u7684 SQL \u8bed\u53e5\u7684\u6761\u4ef6\u662f<code>\"where name like \u2018\u5f20 %\u2019\"</code>\u3002\u8fd9\u65f6\uff0c\u4f60\u4e5f\u80fd\u591f\u7528\u4e0a\u8fd9\u4e2a\u7d22\u5f15\uff0c\u67e5\u627e\u5230\u7b2c\u4e00\u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u8bb0\u5f55\u662f ID3\uff0c\u7136\u540e\u5411\u540e\u904d\u5386\uff0c\u76f4\u5230\u4e0d\u6ee1\u8db3\u6761\u4ef6\u4e3a\u6b62\u3002</li> </ul> <p>like aa%\u540e\u6a21\u7cca\u67e5\u8be2\u7d22\u5f15\u6709\u6548\uff0clike %aa\u6a21\u7cca\u67e5\u8be2\u7d22\u5f15\u65e0\u6548</p> <ul> <li>\u4e0d\u53ea\u662f\u7d22\u5f15\u7684\u5168\u90e8\u5b9a\u4e49\uff0c\u53ea\u8981\u6ee1\u8db3\u6700\u5de6\u524d\u7f00\uff0c\u5c31\u53ef\u4ee5\u5229\u7528\u7d22\u5f15\u6765\u52a0\u901f\u68c0\u7d22\u3002\u8fd9\u4e2a\u6700\u5de6\u524d\u7f00\u53ef\u4ee5\u662f\u8054\u5408\u7d22\u5f15\u7684\u6700\u5de6 N \u4e2a\u5b57\u6bb5\uff0c\u4e5f\u53ef\u4ee5\u662f\u5b57\u7b26\u4e32\u7d22\u5f15\u7684\u6700\u5de6 M \u4e2a\u5b57\u7b26\u3002</li> </ul> <p>\u5728\u5efa\u7acb\u8054\u5408\u7d22\u5f15\u7684\u65f6\u5019\uff0c\u5982\u4f55\u5b89\u6392\u7d22\u5f15\u5185\u7684\u5b57\u6bb5\u987a\u5e8f\u3002</p> <p>\u8fd9\u91cc\u6211\u4eec\u7684\u8bc4\u4f30\u6807\u51c6\u662f\uff0c\u7d22\u5f15\u7684\u590d\u7528\u80fd\u529b\u3002\u56e0\u4e3a\u53ef\u4ee5\u652f\u6301\u6700\u5de6\u524d\u7f00\uff0c\u6240\u4ee5\u5f53\u5df2\u7ecf\u6709\u4e86 (a,b) \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u540e\uff0c\u4e00\u822c\u5c31\u4e0d\u9700\u8981\u5355\u72ec\u5728 a \u4e0a\u5efa\u7acb\u7d22\u5f15\u4e86</p> <p>\u7b2c\u4e00\u539f\u5219\u662f\uff0c\u5982\u679c\u901a\u8fc7\u8c03\u6574\u987a\u5e8f\uff0c\u53ef\u4ee5\u5c11\u7ef4\u62a4\u4e00\u4e2a\u7d22\u5f15\uff0c\u90a3\u4e48\u8fd9\u4e2a\u987a\u5e8f\u5f80\u5f80\u5c31\u662f\u9700\u8981\u4f18\u5148\u8003\u8651\u91c7\u7528\u7684\u3002</p> <p>\u6240\u4ee5\u6211\u4eec\u8981\u4e3a\u9ad8\u9891\u8bf7\u6c42\u521b\u5efa (\u8eab\u4efd\u8bc1\u53f7\uff0c\u59d3\u540d\uff09\u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\uff0c\u5e76\u7528\u8fd9\u4e2a\u7d22\u5f15\u652f\u6301\u201c\u6839\u636e\u8eab\u4efd\u8bc1\u53f7\u67e5\u8be2\u5730\u5740\u201d\u7684\u9700\u6c42\u3002</p> <p>\u5982\u679c\u65e2\u6709\u8054\u5408\u67e5\u8be2\uff0c\u53c8\u6709\u57fa\u4e8e a\u3001b \u5404\u81ea\u7684\u67e5\u8be2\u5462\uff1f\u67e5\u8be2\u6761\u4ef6\u91cc\u9762\u53ea\u6709 b \u7684\u8bed\u53e5\uff0c\u662f\u65e0\u6cd5\u4f7f\u7528 (a,b) \u8fd9\u4e2a\u8054\u5408\u7d22\u5f15\u7684\uff0c\u8fd9\u65f6\u5019\u4f60\u4e0d\u5f97\u4e0d\u7ef4\u62a4\u53e6\u5916\u4e00\u4e2a\u7d22\u5f15\uff0c\u4e5f\u5c31\u662f\u8bf4\u4f60\u9700\u8981\u540c\u65f6\u7ef4\u62a4 (a,b)\u3001(b) \u8fd9\u4e24\u4e2a\u7d22\u5f15\u3002</p> <p>\u8fd9\u65f6\u5019\uff0c\u6211\u4eec\u8981\u8003\u8651\u7684\u539f\u5219\u5c31\u662f\u7a7a\u95f4\u4e86\u3002\u6bd4\u5982\u4e0a\u9762\u8fd9\u4e2a\u5e02\u6c11\u8868\u7684\u60c5\u51b5\uff0cname \u5b57\u6bb5\u662f\u6bd4 age \u5b57\u6bb5\u5927\u7684 \uff0c\u90a3\u6211\u5c31\u5efa\u8bae\u4f60\u521b\u5efa\u4e00\u4e2a\uff08name,age) \u7684\u8054\u5408\u7d22\u5f15\u548c\u4e00\u4e2a (age) \u7684\u5355\u5b57\u6bb5\u7d22\u5f15\u3002</p> <p>(a,b)\u3001(b) \u8fd8\u662f (b,a)\u3001(a)\uff1f\u8003\u8651\u7a7a\u95f4\uff0c\u5b57\u6bb5\u957f\u7684\u53ea\u5efa\u7acb\u4e00\u6b21\uff0c\u77ed\u7684\u5efa\u7acb\u4e24\u6b21\u3002</p>"},{"location":"chap1/4mysql_index/#7","title":"7\u3001\u7d22\u5f15\u4e0b\u63a8","text":"<p>\u90a3\u4e9b\u4e0d\u7b26\u5408\u6700\u5de6\u524d\u7f00\u7684\u90e8\u5206\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f</p> <p>\u6211\u4eec\u8fd8\u662f\u4ee5\u5e02\u6c11\u8868\u7684\u8054\u5408\u7d22\u5f15\uff08name, age\uff09\u4e3a\u4f8b\u3002\u5982\u679c\u73b0\u5728\u6709\u4e00\u4e2a\u9700\u6c42\uff1a\u68c0\u7d22\u51fa\u8868\u4e2d\u201c\u540d\u5b57\u7b2c\u4e00\u4e2a\u5b57\u662f\u5f20\uff0c\u800c\u4e14\u5e74\u9f84\u662f 10 \u5c81\u7684\u6240\u6709\u7537\u5b69\u201d\u3002\u90a3\u4e48\uff0cSQL \u8bed\u53e5\u662f\u8fd9\u4e48\u5199\u7684\uff1a</p> <pre><code>mysql&gt; select * from tuser where name like '\u5f20%' and age=10 and ismale=1;\n</code></pre> <p>\u6839\u636e\u524d\u7f00\u7d22\u5f15\u89c4\u5219\uff0c\u6240\u4ee5\u8fd9\u4e2a\u8bed\u53e5\u5728\u641c\u7d22\u7d22\u5f15\u6811\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u7528 \u201c\u5f20\u201d\uff0c\u627e\u5230\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55 ID3\u3002</p> <p>\u5728 MySQL 5.6 \u4e4b\u524d\uff0c\u53ea\u80fd\u4ece ID3 \u5f00\u59cb\u4e00\u4e2a\u4e2a\u56de\u8868\u3002\u5230\u4e3b\u952e\u7d22\u5f15\u4e0a\u627e\u51fa\u6570\u636e\u884c\uff0c\u518d\u5bf9\u6bd4\u5b57\u6bb5\u503c\u3002</p> <p>\u800c MySQL 5.6 \u5f15\u5165\u7684\u7d22\u5f15\u4e0b\u63a8\u4f18\u5316\uff08index condition pushdown)\uff0c \u53ef\u4ee5\u5728\u7d22\u5f15\u904d\u5386\u8fc7\u7a0b\u4e2d\uff0c\u5bf9\u7d22\u5f15\u4e2d\u5305\u542b\u7684\u5b57\u6bb5\u5148\u505a\u5224\u65ad\uff0c\u76f4\u63a5\u8fc7\u6ee4\u6389\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\uff0c\u51cf\u5c11\u56de\u8868\u6b21\u6570\u3002</p> <p>\u65e0\u7d22\u5f15\u4e0b\u63a8\u6267\u884c\u6d41\u7a0b</p> <p></p> <p>\u5728 (name,age) \u7d22\u5f15\u91cc\u9762\u6211\u7279\u610f\u53bb\u6389\u4e86 age \u7684\u503c\uff0c\u8fd9\u4e2a\u8fc7\u7a0b InnoDB \u5e76\u4e0d\u4f1a\u53bb\u770b age \u7684\u503c\uff0c\u53ea\u662f\u6309\u987a\u5e8f\u628a\u201cname \u7b2c\u4e00\u4e2a\u5b57\u662f\u2019\u5f20\u2019\u201d\u7684\u8bb0\u5f55\u4e00\u6761\u6761\u53d6\u51fa\u6765\u56de\u8868\u3002\u56e0\u6b64\uff0c\u9700\u8981\u56de\u8868 4 \u6b21\u3002</p> <p>\u7d22\u5f15\u4e0b\u63a8\u6267\u884c\u6d41\u7a0b</p> <p></p> <ul> <li>\u6bcf\u4e00\u4e2a\u865a\u7ebf\u7bad\u5934\u8868\u793a\u56de\u8868\u4e00\u6b21\u3002</li> </ul> <p>InnoDB \u5728 (name,age) \u7d22\u5f15\u5185\u90e8\u5c31\u5224\u65ad\u4e86 age \u662f\u5426\u7b49\u4e8e 10\uff0c\u5bf9\u4e8e\u4e0d\u7b49\u4e8e 10 \u7684\u8bb0\u5f55\uff0c\u76f4\u63a5\u5224\u65ad\u5e76\u8df3\u8fc7\u3002\u5728\u6211\u4eec\u7684\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u53ea\u9700\u8981\u5bf9 ID4\u3001ID5 \u8fd9\u4e24\u6761\u8bb0\u5f55\u56de\u8868\u53d6\u6570\u636e\u5224\u65ad\uff0c\u5c31\u53ea\u9700\u8981\u56de\u8868 2 \u6b21\u3002</p>"},{"location":"chap1/4mysql_index/#82","title":"8\u3001\u601d\u8003\u98982","text":"<p>\u6709\u8fd9\u4e48\u4e00\u4e2a\u8868\uff0c\u8868\u7ed3\u6784\u5b9a\u4e49\u7c7b\u4f3c\u8fd9\u6837\u7684\uff1a</p> <pre><code>\nCREATE TABLE `test` (\n  `a` int(11) NOT NULL,\n  `b` int(11) NOT NULL,\n  `c` int(11) NOT NULL,\n  `d` int(11) NOT NULL,\n  PRIMARY KEY (`a`,`b`),\n  KEY `c` (`c`),\n  KEY `ca` (`c`,`a`),\n  KEY `cb` (`c`,`b`)\n) ENGINE=InnoDB;\n</code></pre> <p>\u7531\u4e8e\u5386\u53f2\u539f\u56e0\uff0c\u8fd9\u4e2a\u8868\u9700\u8981 a\u3001b \u505a\u8054\u5408\u4e3b\u952e</p> <p>\u65e2\u7136\u4e3b\u952e\u5305\u542b\u4e86 a\u3001b \u8fd9\u4e24\u4e2a\u5b57\u6bb5\uff0c\u90a3\u610f\u5473\u7740\u5355\u72ec\u5728\u5b57\u6bb5 c \u4e0a\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\uff0c\u5c31\u5df2\u7ecf\u5305\u542b\u4e86\u4e09\u4e2a\u5b57\u6bb5\u4e86\u5440\uff0c\u4e3a\u4ec0\u4e48\u8981\u521b\u5efa\u201cca\u201d\u201ccb\u201d\u8fd9\u4e24\u4e2a\u7d22\u5f15\uff1f</p> <p>\u662f\u56e0\u4e3a\u4ed6\u4eec\u7684\u4e1a\u52a1\u91cc\u9762\u6709\u8fd9\u6837\u7684\u4e24\u79cd\u8bed\u53e5\uff1a</p> <pre><code>select * from test where c=N order by a limit 1;\nselect * from test where c=N order by b limit 1;\n</code></pre> <p>\u4e3a\u4e86\u8fd9\u4e24\u4e2a\u67e5\u8be2\u6a21\u5f0f\uff0c\u8fd9\u4e24\u4e2a\u7d22\u5f15\u662f\u5426\u90fd\u662f\u5fc5\u987b\u7684\uff1f\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u7b54\u6848\uff1a \u5bf9\u4e8e\u4e8c\u7ea7\u7d22\u5f15C\uff0c\u4f1a\u9ed8\u8ba4\u548c\u4e3b\u952e\u505a\u8054\u5408\u7d22\u5f15\u3002\u6240\u4ee5\u7d22\u5f15c\u7684\u6392\u5e8f\u4e3acab\uff0c\u7d22\u5f15cb\u7684\u6392\u5e8f\u987a\u5e8f\u4e3acba\u3002\u6240\u4ee5\uff0c\u7ed3\u8bba\u662f ca \u53ef\u4ee5\u53bb\u6389\uff0ccb \u9700\u8981\u4fdd\u7559\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/","title":"\u7b2c\u5341\u4e00\u8282 \u6d45\u8c08\u6570\u636e\u5e93\u5e76\u53d1\u63a7\u5236 - \u9501\u548c MVCC","text":"<p>\u6570\u636e\u5e93\u5728\u5e76\u53d1\u6027\u80fd\u548c\u53ef\u4e32\u884c\u5316\u4e4b\u95f4\u505a\u7684\u6743\u8861\u548c\u59a5\u534f - \u5e76\u53d1\u63a7\u5236\u673a\u5236\u3002</p> <p></p> <p>\u5982\u679c\u6570\u636e\u5e93\u4e2d\u7684\u6240\u6709\u4e8b\u52a1\u90fd\u662f\u4e32\u884c\u6267\u884c\u7684\uff0c\u90a3\u4e48\u5b83\u975e\u5e38\u5bb9\u6613\u6210\u4e3a\u6574\u4e2a\u5e94\u7528\u7684\u6027\u80fd\u74f6\u9888\uff0c\u867d\u7136\u8bf4\u6ca1\u6cd5\u6c34\u5e73\u6269\u5c55\u7684\u8282\u70b9\u5728\u6700\u540e\u90fd\u4f1a\u6210\u4e3a\u74f6\u9888\uff0c\u4f46\u662f\u4e32\u884c\u6267\u884c\u4e8b\u52a1\u7684\u6570\u636e\u5e93\u4f1a\u52a0\u901f\u8fd9\u4e00\u8fc7\u7a0b\uff1b</p> <p>\u800c\u5e76\u53d1\uff08<code>Concurrency</code>\uff09\u4f7f\u4e00\u5207\u4e8b\u60c5\u7684\u53d1\u751f\u90fd\u6709\u4e86\u53ef\u80fd\uff0c\u5b83\u80fd\u591f\u89e3\u51b3\u4e00\u5b9a\u7684\u6027\u80fd\u95ee\u9898\uff0c\u4f46\u662f\u5b83\u4f1a\u5e26\u6765\u66f4\u591a\u8be1\u5f02\u7684\u9519\u8bef\u3002</p> <p>\u5f15\u5165\u4e86\u5e76\u53d1\u4e8b\u52a1\u4e4b\u540e\uff0c\u5982\u679c\u4e0d\u5bf9\u4e8b\u52a1\u7684\u6267\u884c\u8fdb\u884c\u63a7\u5236\u5c31\u4f1a\u51fa\u73b0\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u4f60\u53ef\u80fd\u6ca1\u6709\u4eab\u53d7\u5230\u5e76\u53d1\u5e26\u6765\u7684\u6027\u80fd\u63d0\u5347\u5c31\u5df2\u7ecf\u88ab\u5404\u79cd\u5947\u602a\u7684\u95ee\u9898\u6298\u78e8\u7684\u6b32\u4ed9\u6b32\u6b7b\u4e86\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#1","title":"1 \u6982\u8ff0","text":"<p>\u5e38\u89c1\u7684\u4e09\u79cd\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff1a</p> <p></p> <p>\u5206\u522b\u662f</p> <ul> <li>\u60b2\u89c2\u5e76\u53d1\u63a7\u5236: \u5176\u4e2d\u60b2\u89c2\u5e76\u53d1\u63a7\u5236\u5176\u5b9e\u662f\u6700\u5e38\u89c1\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u4e5f\u5c31\u662f\u9501</li> <li>\u4e50\u89c2\u5e76\u53d1\u63a7\u5236\uff1a\u800c\u4e50\u89c2\u5e76\u53d1\u63a7\u5236\u5176\u5b9e\u4e5f\u6709\u53e6\u4e00\u4e2a\u540d\u5b57\uff1a\u4e50\u89c2\u9501\uff0c\u4e50\u89c2\u9501\u5176\u5b9e\u5e76\u4e0d\u662f\u4e00\u79cd\u771f\u5b9e\u5b58\u5728\u7684\u9501</li> <li>\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff0c\u6700\u540e\u5c31\u662f\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff08<code>MVCC</code>\uff09\u4e86\uff0c\u4e0e\u524d\u4e24\u8005\u5bf9\u7acb\u7684\u547d\u540d\u4e0d\u540c\uff0c<code>MVCC</code> \u53ef\u4ee5\u4e0e\u524d\u4e24\u8005\u4e2d\u7684\u4efb\u610f\u4e00\u79cd\u673a\u5236\u7ed3\u5408\u4f7f\u7528\uff0c\u4ee5\u63d0\u9ad8\u6570\u636e\u5e93\u7684\u8bfb\u6027\u80fd\u3002</li> </ul>"},{"location":"chap1/5DB_locc_mvcc/#2","title":"2 \u60b2\u89c2\u5e76\u53d1\u63a7\u5236","text":"<p>\u63a7\u5236\u4e0d\u540c\u7684\u4e8b\u52a1\u5bf9\u540c\u4e00\u4efd\u6570\u636e\u7684\u83b7\u53d6\u662f\u4fdd\u8bc1\u6570\u636e\u5e93\u7684\u4e00\u81f4\u6027\u7684\u6700\u6839\u672c\u65b9\u6cd5\uff0c\u5982\u679c\u6211\u4eec\u80fd\u591f\u8ba9\u4e8b\u52a1\u5728\u540c\u4e00\u65f6\u95f4\u5bf9\u540c\u4e00\u8d44\u6e90\u6709\u7740\u72ec\u5360\u7684\u80fd\u529b\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u4fdd\u8bc1\u64cd\u4f5c\u540c\u4e00\u8d44\u6e90\u7684\u4e0d\u540c\u4e8b\u52a1\u4e0d\u4f1a\u76f8\u4e92\u5f71\u54cd\u3002</p> <p></p> <p>\u6700\u7b80\u5355\u7684\u3001\u5e94\u7528\u6700\u5e7f\u7684\u65b9\u6cd5\u5c31\u662f\u4f7f\u7528\u9501\u6765\u89e3\u51b3\uff0c\u5f53\u4e8b\u52a1\u9700\u8981\u5bf9\u8d44\u6e90\u8fdb\u884c\u64cd\u4f5c\u65f6\u9700\u8981\u5148\u83b7\u5f97\u8d44\u6e90\u5bf9\u5e94\u7684\u9501\uff0c\u4fdd\u8bc1\u5176\u4ed6\u4e8b\u52a1\u4e0d\u4f1a\u8bbf\u95ee\u8be5\u8d44\u6e90\u540e\uff0c\u5728\u5bf9\u8d44\u6e90\u8fdb\u884c\u5404\u79cd\u64cd\u4f5c\uff1b</p> <p>\u5728\u60b2\u89c2\u5e76\u53d1\u63a7\u5236\u4e2d\uff0c\u6570\u636e\u5e93\u7a0b\u5e8f\u5bf9\u4e8e\u6570\u636e\u88ab\u4fee\u6539\u6301\u60b2\u89c2\u7684\u6001\u5ea6\uff0c\u5728\u6570\u636e\u5904\u7406\u7684\u8fc7\u7a0b\u4e2d\u90fd\u4f1a\u88ab\u9501\u5b9a\uff0c\u4ee5\u6b64\u6765\u89e3\u51b3\u7ade\u4e89\u7684\u95ee\u9898\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#3","title":"3 \u8bfb\u5199\u9501","text":"<p>\u4e3a\u4e86\u6700\u5927\u5316\u6570\u636e\u5e93\u4e8b\u52a1\u7684\u5e76\u53d1\u80fd\u529b\uff0c\u6570\u636e\u5e93\u4e2d\u7684\u9501\u88ab\u8bbe\u8ba1\u4e3a\u4e24\u79cd\u6a21\u5f0f\uff0c\u5206\u522b\u662f\u5171\u4eab\u9501\u548c\u4e92\u65a5\u9501\u3002</p> <ul> <li>\u5f53\u4e00\u4e2a\u4e8b\u52a1\u83b7\u5f97\u5171\u4eab\u9501\u4e4b\u540e\uff0c\u5b83\u53ea\u53ef\u4ee5\u8fdb\u884c\u8bfb\u64cd\u4f5c\uff0c\u6240\u4ee5\u5171\u4eab\u9501\u4e5f\u53eb\u8bfb\u9501\uff1b</li> <li>\u800c\u5f53\u4e00\u4e2a\u4e8b\u52a1\u83b7\u5f97\u4e00\u884c\u6570\u636e\u7684\u4e92\u65a5\u9501\u65f6\uff0c\u5c31\u53ef\u4ee5\u5bf9\u8be5\u884c\u6570\u636e\u8fdb\u884c\u8bfb\u548c\u5199\u64cd\u4f5c\uff0c\u6240\u4ee5\u4e92\u65a5\u9501\u4e5f\u53eb\u5199\u9501\u3002</li> </ul> <p></p> <p>\u5171\u4eab\u9501\u548c\u4e92\u65a5\u9501\u9664\u4e86\u9650\u5236\u4e8b\u52a1\u80fd\u591f\u6267\u884c\u7684\u8bfb\u5199\u64cd\u4f5c\u4e4b\u5916\uff0c\u5b83\u4eec\u4e4b\u95f4\u8fd8\u6709<code>\u5171\u4eab</code>\u548c<code>\u4e92\u65a5</code>\u7684\u5173\u7cfb\uff0c</p> <p>\u4e5f\u5c31\u662f\u591a\u4e2a\u4e8b\u52a1\u53ef\u4ee5\u540c\u65f6\u83b7\u5f97\u67d0\u4e00\u884c\u6570\u636e\u7684\u5171\u4eab\u9501\uff0c\u4f46\u662f\u4e92\u65a5\u9501\u4e0e\u5171\u4eab\u9501\u548c\u5176\u4ed6\u7684\u4e92\u65a5\u9501\u5e76\u4e0d\u517c\u5bb9\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u81ea\u7136\u5730\u7406\u89e3\u8fd9\u4e48\u8bbe\u8ba1\u7684\u539f\u56e0\uff1a\u591a\u4e2a\u4e8b\u52a1\u540c\u65f6\u5199\u5165\u540c\u4e00\u6570\u636e\u96be\u514d\u4f1a\u53d1\u751f\u5404\u79cd\u8be1\u5f02\u7684\u95ee\u9898\u3002</p> <p></p> <p>\u5982\u679c\u5f53\u524d\u4e8b\u52a1\u6ca1\u6709\u529e\u6cd5\u83b7\u53d6\u8be5\u884c\u6570\u636e\u5bf9\u5e94\u7684\u9501\u65f6\u5c31\u4f1a\u9677\u5165\u7b49\u5f85\u7684\u72b6\u6001\uff0c\u76f4\u5230\u5176\u4ed6\u4e8b\u52a1\u5c06\u5f53\u524d\u6570\u636e\u5bf9\u5e94\u7684\u9501\u91ca\u653e\u624d\u53ef\u4ee5\u83b7\u5f97\u9501\u5e76\u6267\u884c\u76f8\u5e94\u7684\u64cd\u4f5c\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#4","title":"4 \u4e24\u9636\u6bb5\u9501\u534f\u8bae","text":"<p>\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff08<code>2PL</code>\uff09\u662f\u4e00\u79cd\u80fd\u591f\u4fdd\u8bc1\u4e8b\u52a1\u53ef\u4e32\u884c\u5316\u7684\u534f\u8bae\uff0c\u5b83\u5c06\u4e8b\u52a1\u7684\u83b7\u53d6\u9501\u548c\u91ca\u653e\u9501\u5212\u5206\u6210\u4e86\u589e\u957f\uff08Growing\uff09\u548c\u7f29\u51cf\uff08Shrinking\uff09\u4e24\u4e2a\u4e0d\u540c\u7684\u9636\u6bb5\u3002</p> <p></p> <ul> <li>\u5728\u589e\u957f\u9636\u6bb5\uff0c\u4e00\u4e2a\u4e8b\u52a1\u53ef\u4ee5\u83b7\u5f97\u9501\u4f46\u662f\u4e0d\u80fd\u91ca\u653e\u9501\uff1b</li> <li>\u5728\u7f29\u51cf\u9636\u6bb5\u4e8b\u52a1\u53ea\u53ef\u4ee5\u91ca\u653e\u9501\uff0c\u5e76\u4e0d\u80fd\u83b7\u5f97\u65b0\u7684\u9501\uff0c</li> </ul> <p>\u5982\u679c\u53ea\u770b <code>2PL</code> \u7684\u5b9a\u4e49\uff0c\u90a3\u4e48\u5230\u8fd9\u91cc\u5c31\u5df2\u7ecf\u4ecb\u7ecd\u5b8c\u4e86\uff0c\u4f46\u662f\u5b83\u8fd8\u6709\u4e24\u4e2a\u53d8\u79cd\uff1a</p> <ol> <li>Strict 2PL\uff1a\u4e8b\u52a1\u6301\u6709\u7684\u4e92\u65a5\u9501\u5fc5\u987b\u5728\u63d0\u4ea4\u540e\u518d\u91ca\u653e\uff1b</li> <li>Rigorous 2PL\uff1a\u4e8b\u52a1\u6301\u6709\u7684\u6240\u6709\u9501\u5fc5\u987b\u5728\u63d0\u4ea4\u540e\u91ca\u653e\uff1b</li> </ol> <p></p> <p>\u867d\u7136\u9501\u7684\u4f7f\u7528\u80fd\u591f\u4e3a\u6211\u4eec\u89e3\u51b3\u4e0d\u540c\u4e8b\u52a1\u4e4b\u95f4\u7531\u4e8e\u5e76\u53d1\u6267\u884c\u9020\u6210\u7684\u95ee\u9898\uff0c\u4f46\u662f\u4e24\u9636\u6bb5\u9501\u7684\u4f7f\u7528\u5374\u5f15\u5165\u4e86\u53e6\u4e00\u4e2a\u4e25\u91cd\u7684\u95ee\u9898\uff0c\u6b7b\u9501\uff1b</p> <p>\u4e0d\u540c\u7684\u4e8b\u52a1\u7b49\u5f85\u5bf9\u65b9\u5df2\u7ecf\u9501\u5b9a\u7684\u8d44\u6e90\u5c31\u4f1a\u9020\u6210\u6b7b\u9501\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u4e3e\u4e00\u4e2a\u7b80\u5355\u7684\u4f8b\u5b50\uff1a</p> <p></p> <p>\u4e24\u4e2a\u4e8b\u52a1\u5728\u521a\u5f00\u59cb\u65f6\u5206\u522b\u83b7\u53d6\u4e86 <code>draven</code> \u548c <code>beacon</code>\u8d44\u6e90\u4e0a\u9762\u7684\u9501\uff0c\u7136\u540e\u518d\u8bf7\u6c42\u5bf9\u65b9\u5df2\u7ecf\u83b7\u5f97\u7684\u9501\u65f6\u5c31\u4f1a\u53d1\u751f\u6b7b\u9501\uff0c\u53cc\u65b9\u90fd\u6ca1\u6709\u529e\u6cd5\u7b49\u5230\u9501\u7684\u91ca\u653e\uff0c\u5982\u679c\u6ca1\u6709\u6b7b\u9501\u7684\u5904\u7406\u673a\u5236\u5c31\u4f1a\u65e0\u9650\u7b49\u5f85\u4e0b\u53bb\uff0c\u4e24\u4e2a\u4e8b\u52a1\u90fd\u6ca1\u6709\u529e\u6cd5\u5b8c\u6210\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#5","title":"5 \u6b7b\u9501\u7684\u5904\u7406","text":"<p>\u6b7b\u9501\u5728\u591a\u7ebf\u7a0b\u7f16\u7a0b\u4e2d\u662f\u7ecf\u5e38\u9047\u5230\u7684\u4e8b\u60c5\uff0c\u4e00\u65e6\u6d89\u53ca\u591a\u4e2a\u7ebf\u7a0b\u5bf9\u8d44\u6e90\u8fdb\u884c\u4e89\u593a\u5c31\u9700\u8981\u8003\u8651\u5f53\u524d\u7684\u51e0\u4e2a\u7ebf\u7a0b\u6216\u8005\u4e8b\u52a1\u662f\u5426\u4f1a\u9020\u6210\u6b7b\u9501\uff1b\u89e3\u51b3\u6b7b\u9501\u5927\u4f53\u6765\u770b\u6709\u4e24\u79cd\u529e\u6cd5\uff0c</p> <ul> <li>\u4e00\u79cd\u662f\u4ece\u6e90\u5934\u675c\u7edd\u6b7b\u9501\u7684\u4ea7\u751f\u548c\u51fa\u73b0\uff0c</li> <li>\u4e00\u79cd\u662f\u5141\u8bb8\u7cfb\u7edf\u8fdb\u5165\u6b7b\u9501\u7684\u72b6\u6001\uff0c\u4f46\u662f\u5728\u7cfb\u7edf\u51fa\u73b0\u6b7b\u9501\u65f6\u80fd\u591f\u53ca\u65f6\u53d1\u73b0\u5e76\u4e14\u8fdb\u884c\u6062\u590d\u3002</li> </ul>"},{"location":"chap1/5DB_locc_mvcc/#1_1","title":"1.\u9884\u9632\u6b7b\u9501","text":"<p>\u6709\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u9884\u9632\u6b7b\u9501\u7684\u51fa\u73b0\uff0c</p> <ul> <li>\u4e00\u79cd\u662f\u4fdd\u8bc1\u4e8b\u52a1\u4e4b\u95f4\u7684\u7b49\u5f85\u4e0d\u4f1a\u51fa\u73b0\u73af\uff0c\u4e5f\u5c31\u662f\u4e8b\u52a1\u4e4b\u95f4\u7684\u7b49\u5f85\u56fe\u5e94\u8be5\u662f\u4e00\u5f20\u6709\u5411\u65e0\u73af\u56fe\uff0c\u6ca1\u6709\u5faa\u73af\u7b49\u5f85\u7684\u60c5\u51b5\u6216\u8005\u4fdd\u8bc1\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u60f3\u8981\u83b7\u5f97\u7684\u6240\u6709\u8d44\u6e90\u90fd\u5728\u4e8b\u52a1\u5f00\u59cb\u65f6\u4ee5\u539f\u5b50\u7684\u65b9\u5f0f\u88ab\u9501\u5b9a\uff0c\u6240\u6709\u7684\u8d44\u6e90\u8981\u4e48\u88ab\u9501\u5b9a\u8981\u4e48\u90fd\u4e0d\u88ab\u9501\u5b9a\u3002</li> </ul> <p>\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u6709\u4e24\u4e2a\u95ee\u9898\uff0c\u5728\u4e8b\u52a1\u4e00\u5f00\u59cb\u65f6\u5f88\u96be\u5224\u65ad\u54ea\u4e9b\u8d44\u6e90\u662f\u9700\u8981\u9501\u5b9a\u7684\uff0c\u540c\u65f6\u56e0\u4e3a\u4e00\u4e9b\u5f88\u665a\u624d\u4f1a\u7528\u5230\u7684\u6570\u636e\u88ab\u63d0\u524d\u9501\u5b9a\uff0c\u6570\u636e\u7684\u5229\u7528\u7387\u4e0e\u4e8b\u52a1\u7684\u5e76\u53d1\u7387\u4e5f\u975e\u5e38\u7684\u4f4e\u3002</p> <ul> <li>\u4e00\u79cd\u89e3\u51b3\u7684\u529e\u6cd5\u5c31\u662f\u6309\u7167\u4e00\u5b9a\u7684\u987a\u5e8f\u4e3a\u6240\u6709\u7684\u6570\u636e\u884c\u52a0\u9501\uff0c\u540c\u65f6\u4e0e <code>2PL</code> \u534f\u8bae\u7ed3\u5408\uff0c\u5728\u52a0\u9501\u9636\u6bb5\u4fdd\u8bc1\u6240\u6709\u7684\u6570\u636e\u884c\u90fd\u662f\u4ece\u5c0f\u5230\u5927\u4f9d\u6b21\u8fdb\u884c\u52a0\u9501\u7684\uff0c\u4e0d\u8fc7\u8fd9\u79cd\u65b9\u5f0f\u4f9d\u7136\u9700\u8981\u4e8b\u52a1\u63d0\u524d\u77e5\u9053\u5c06\u8981\u52a0\u9501\u7684\u6570\u636e\u96c6\u3002</li> <li>\u53e6\u4e00\u79cd\u9884\u9632\u6b7b\u9501\u7684\u65b9\u6cd5\u5c31\u662f\u4f7f\u7528\u62a2\u5360\u52a0\u4e8b\u52a1\u56de\u6eda\u7684\u65b9\u5f0f\u9884\u9632\u6b7b\u9501\uff0c\u5f53\u4e8b\u52a1\u5f00\u59cb\u6267\u884c\u65f6\u4f1a\u5148\u83b7\u5f97\u4e00\u4e2a\u65f6\u95f4\u6233\uff0c\u6570\u636e\u5e93\u7a0b\u5e8f\u4f1a\u6839\u636e\u4e8b\u52a1\u7684\u65f6\u95f4\u6233\u51b3\u5b9a\u4e8b\u52a1\u5e94\u8be5\u7b49\u5f85\u8fd8\u662f\u56de\u6eda\uff0c\u5728\u8fd9\u65f6\u4e5f\u6709\u4e24\u79cd\u673a\u5236\u4f9b\u6211\u4eec\u9009\u62e9\uff0c\u4e00\u79cd\u662f <code>wait-die</code> \u673a\u5236\uff1a</li> </ul> <p></p> <p>\u5f53\u6267\u884c\u4e8b\u52a1\u7684\u65f6\u95f4\u6233\u5c0f\u4e8e\u53e6\u4e00\u4e8b\u52a1\u65f6\uff0c\u5373\u4e8b\u52a1 A \u5148\u4e8e B \u5f00\u59cb\uff0c\u90a3\u4e48\u5b83\u5c31\u4f1a\u7b49\u5f85\u53e6\u4e00\u4e2a\u4e8b\u52a1\u91ca\u653e\u5bf9\u5e94\u8d44\u6e90\u7684\u9501\uff0c\u5426\u5219\u5c31\u4f1a\u4fdd\u6301\u5f53\u524d\u7684\u65f6\u95f4\u6233\u5e76\u56de\u6eda\u3002</p> <ul> <li>\u53e6\u4e00\u79cd\u673a\u5236\u53eb\u505a     <code>wound-wait</code>\uff0c\u8fd9\u662f\u4e00\u79cd\u62a2\u5360\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5b83\u548c <code>wait-die</code> \u673a\u5236\u7684\u7ed3\u679c\u5b8c\u5168\u76f8\u53cd\uff0c</li> <li>\u5f53\u524d\u4e8b\u52a1\u5982\u679c\u5148\u4e8e\u53e6\u4e00\u4e8b\u52a1\u6267\u884c\u5e76\u8bf7\u6c42\u4e86\u53e6\u4e00\u4e8b\u52a1\u7684\u8d44\u6e90\uff0c\u90a3\u4e48\u53e6\u4e00\u4e8b\u52a1\u4f1a\u7acb\u523b\u56de\u6eda\uff0c\u5c06\u8d44\u6e90\u8ba9\u7ed9\u5148\u6267\u884c\u7684\u4e8b\u52a1\uff0c\u5426\u5219\u5c31\u4f1a\u7b49\u5f85\u5176\u4ed6\u4e8b\u52a1\u91ca\u653e\u8d44\u6e90</li> </ul> <p></p> <p>\u4e24\u79cd\u65b9\u6cd5\u90fd\u4f1a\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u4e8b\u52a1\u56de\u6eda\uff0c\u7531\u6b64\u4f1a\u5e26\u6765\u4e00\u5b9a\u7684\u6027\u80fd\u635f\u5931\uff0c\u66f4\u7b80\u5355\u7684\u89e3\u51b3\u6b7b\u9501\u7684\u65b9\u5f0f\u5c31\u662f\u4f7f\u7528\u8d85\u65f6\u65f6\u95f4\uff0c\u4f46\u662f\u8d85\u65f6\u65f6\u95f4\u7684\u8bbe\u5b9a\u662f\u9700\u8981\u4ed4\u7ec6\u8003\u8651\u7684\uff0c\u5426\u5219\u4f1a\u9020\u6210\u8017\u65f6\u8f83\u957f\u7684\u4e8b\u52a1\u65e0\u6cd5\u6b63\u5e38\u6267\u884c\uff0c\u6216\u8005\u65e0\u6cd5\u53ca\u65f6\u53d1\u73b0\u9700\u8981\u89e3\u51b3\u7684\u6b7b\u9501\uff0c\u6240\u4ee5\u5b83\u7684\u4f7f\u7528\u8fd8\u662f\u6709\u4e00\u5b9a\u7684\u5c40\u9650\u6027\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#6","title":"6 \u6b7b\u9501\u68c0\u6d4b\u548c\u6062\u590d","text":"<p>\u5982\u679c\u6570\u636e\u5e93\u7a0b\u5e8f\u65e0\u6cd5\u901a\u8fc7\u534f\u8bae\u4ece\u539f\u7406\u4e0a\u4fdd\u8bc1\u6b7b\u9501\u4e0d\u4f1a\u53d1\u751f\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u5728\u6b7b\u9501\u53d1\u751f\u65f6\u53ca\u65f6\u68c0\u6d4b\u5230\u5e76\u4ece\u6b7b\u9501\u72b6\u6001\u6062\u590d\u5230\u6b63\u5e38\u72b6\u6001\u4fdd\u8bc1\u6570\u636e\u5e93\u7a0b\u5e8f\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u3002\u5728\u4f7f\u7528\u68c0\u6d4b\u548c\u6062\u590d\u7684\u65b9\u5f0f\u89e3\u51b3\u6b7b\u9501\u65f6\uff0c\u6570\u636e\u5e93\u7a0b\u5e8f\u9700\u8981\u7ef4\u62a4\u6570\u636e\u548c\u4e8b\u52a1\u4e4b\u95f4\u7684\u5f15\u7528\u4fe1\u606f\uff0c\u540c\u65f6\u4e5f\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u7528\u4e8e\u5224\u65ad\u5f53\u524d\u6570\u636e\u5e93\u662f\u5426\u8fdb\u5165\u6b7b\u9501\u72b6\u6001\u7684\u7b97\u6cd5\uff0c\u6700\u540e\u9700\u8981\u5728\u6b7b\u9501\u53d1\u751f\u65f6\u63d0\u4f9b\u5408\u9002\u7684\u7b56\u7565\u53ca\u65f6\u6062\u590d\u3002</p> <p>\u5728\u4e0a\u4e00\u8282\u4e2d\u6211\u4eec\u5176\u5b9e\u63d0\u5230\u6b7b\u9501\u7684\u68c0\u6d4b\u53ef\u4ee5\u901a\u8fc7\u4e00\u4e2a\u6709\u5411\u7684\u7b49\u5f85\u56fe\u6765\u8fdb\u884c\u5224\u65ad\uff0c</p> <p>\u679c\u4e00\u4e2a\u4e8b\u52a1\u4f9d\u8d56\u4e8e\u53e6\u4e00\u4e2a\u4e8b\u52a1\u6b63\u5728\u5904\u7406\u7684\u6570\u636e\uff0c\u90a3\u4e48\u5f53\u524d\u4e8b\u52a1\u5c31\u4f1a\u7b49\u5f85\u53e6\u4e00\u4e2a\u4e8b\u52a1\u7684\u7ed3\u675f\uff0c\u8fd9\u4e5f\u5c31\u662f\u6574\u4e2a\u7b49\u5f85\u56fe\u4e2d\u7684\u4e00\u6761\u8fb9\uff1a</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u5982\u679c\u5728\u8fd9\u4e2a\u6709\u5411\u56fe\u4e2d\u51fa\u73b0\u4e86\u73af\uff0c\u5c31\u8bf4\u660e\u5f53\u524d\u6570\u636e\u5e93\u8fdb\u5165\u4e86\u6b7b\u9501\u7684\u72b6\u6001 <code>TransB -&gt; TransE -&gt; TransF -&gt; TransD -&gt; TransB</code>\uff0c\u5728\u8fd9\u65f6\u5c31\u9700\u8981\u6b7b\u9501\u6062\u590d\u673a\u5236\u63a5\u5165\u4e86\u3002</p> <p>\u5982\u4f55\u4ece\u6b7b\u9501\u4e2d\u6062\u590d\u5176\u5b9e\u975e\u5e38\u7b80\u5355\uff0c\u6700\u5e38\u89c1\u7684\u89e3\u51b3\u529e\u6cd5\u5c31\u662f\u9009\u62e9\u6574\u4e2a\u73af\u4e2d\u4e00\u4e2a\u4e8b\u52a1\u8fdb\u884c\u56de\u6eda\uff0c\u4ee5\u6253\u7834\u6574\u4e2a\u7b49\u5f85\u56fe\u4e2d\u7684\u73af\uff0c\u5728\u6574\u4e2a\u6062\u590d\u7684\u8fc7\u7a0b\u4e2d\u6709\u4e09\u4e2a\u4e8b\u60c5\u9700\u8981\u8003\u8651\uff1a</p> <p></p> <p>\u6bcf\u6b21\u51fa\u73b0\u6b7b\u9501\u65f6\u5176\u5b9e\u90fd\u4f1a\u6709\u591a\u4e2a\u4e8b\u52a1\u88ab\u6ce2\u53ca\uff0c\u800c\u9009\u62e9\u5176\u4e2d\u54ea\u4e00\u4e2a\u4efb\u52a1\u8fdb\u884c\u56de\u6eda\u662f\u5fc5\u987b\u8981\u505a\u7684\u4e8b\u60c5\uff0c\u5728\u9009\u62e9\u727a\u7272\u54c1\uff08<code>Victim</code>\uff09\u65f6\u7684\u9ec4\u91d1\u539f\u5219\u5c31\u662f\u6700\u5c0f\u5316\u4ee3\u4ef7\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u7efc\u5408\u8003\u8651\u4e8b\u52a1\u5df2\u7ecf\u8ba1\u7b97\u7684\u65f6\u95f4\u3001\u4f7f\u7528\u7684\u6570\u636e\u884c\u4ee5\u53ca\u6d89\u53ca\u7684\u4e8b\u52a1\u7b49\u56e0\u7d20\uff1b\u5f53\u6211\u4eec\u9009\u62e9\u4e86\u727a\u7272\u54c1\u4e4b\u540e\u5c31\u53ef\u4ee5\u5f00\u59cb\u56de\u6eda\u4e86\uff0c</p> <ul> <li>\u56de\u6eda\u5176\u5b9e\u6709\u4e24\u79cd\u9009\u62e9\u4e00\u79cd\u662f\u5168\u90e8\u56de\u6eda\uff0c</li> <li>\u53e6\u4e00\u79cd\u662f\u90e8\u5206\u56de\u6eda\uff0c\u90e8\u5206\u56de\u6eda\u4f1a\u56de\u6eda\u5230\u4e8b\u52a1\u4e4b\u524d\u7684\u4e00\u4e2a\u68c0\u67e5\u70b9\u4e0a\uff0c\u5982\u679c\u6ca1\u6709\u68c0\u67e5\u70b9\u90a3\u81ea\u7136\u6ca1\u6709\u529e\u6cd5\u8fdb\u884c\u90e8\u5206\u56de\u6eda\u3002</li> </ul> <p>\u6bcf\u6b21\u51fa\u73b0\u6b7b\u9501\u65f6\u5176\u5b9e\u90fd\u4f1a\u6709\u591a\u4e2a\u4e8b\u52a1\u88ab\u6ce2\u53ca\uff0c\u800c\u9009\u62e9\u5176\u4e2d\u54ea\u4e00\u4e2a\u4efb\u52a1\u8fdb\u884c\u56de\u6eda\u662f\u5fc5\u987b\u8981\u505a\u7684\u4e8b\u60c5\uff0c\u5728\u9009\u62e9\u727a\u7272\u54c1\uff08Victim\uff09\u65f6\u7684\u9ec4\u91d1\u539f\u5219\u5c31\u662f\u6700\u5c0f\u5316\u4ee3\u4ef7\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u7efc\u5408\u8003\u8651\u4e8b\u52a1\u5df2\u7ecf\u8ba1\u7b97\u7684\u65f6\u95f4\u3001\u4f7f\u7528\u7684\u6570\u636e\u884c\u4ee5\u53ca\u6d89\u53ca\u7684\u4e8b\u52a1\u7b49\u56e0\u7d20\uff1b\u5f53\u6211\u4eec\u9009\u62e9\u4e86\u727a\u7272\u54c1\u4e4b\u540e\u5c31\u53ef\u4ee5\u5f00\u59cb\u56de\u6eda\u4e86\uff0c\u56de\u6eda\u5176\u5b9e\u6709\u4e24\u79cd\u9009\u62e9\u4e00\u79cd\u662f\u5168\u90e8\u56de\u6eda\uff0c\u53e6\u4e00\u79cd\u662f\u90e8\u5206\u56de\u6eda\uff0c\u90e8\u5206\u56de\u6eda\u4f1a\u56de\u6eda\u5230\u4e8b\u52a1\u4e4b\u524d\u7684\u4e00\u4e2a\u68c0\u67e5\u70b9\u4e0a\uff0c\u5982\u679c\u6ca1\u6709\u68c0\u67e5\u70b9\u90a3\u81ea\u7136\u6ca1\u6709\u529e\u6cd5\u8fdb\u884c\u90e8\u5206\u56de\u6eda\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#7","title":"7 \u9501\u7684\u7c92\u5ea6","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\u6211\u4eec\u90fd\u6ca1\u6709\u5bf9\u4e0d\u540c\u7c92\u5ea6\u7684\u9501\u8fdb\u884c\u8ba8\u8bba\uff0c\u4e00\u76f4\u4ee5\u6765\u6211\u4eec\u90fd\u8ba8\u8bba\u7684\u90fd\u662f\u6570\u636e\u884c\u9501\uff0c\u4f46\u662f\u5728\u6709\u4e9b\u65f6\u5019\u6211\u4eec\u5e0c\u671b\u5c06\u591a\u4e2a\u8282\u70b9\u770b\u505a\u4e00\u4e2a\u6570\u636e\u5355\u5143\uff0c\u4f7f\u7528\u9501\u76f4\u63a5\u5c06\u8fd9\u4e2a\u6570\u636e\u5355\u5143\u3001\u8868\u751a\u81f3\u6570\u636e\u5e93\u9501\u5b9a\u8d77\u6765\u3002\u8fd9\u4e2a\u76ee\u6807\u7684\u5b9e\u73b0\u9700\u8981\u6211\u4eec\u5728\u6570\u636e\u5e93\u4e2d\u5b9a\u4e49\u4e0d\u540c\u7c92\u5ea6\u7684\u9501\uff1a</p> <p></p> <p>\u5f53\u6211\u4eec\u62e5\u6709\u4e86\u4e0d\u540c\u7c92\u5ea6\u7684\u9501\u4e4b\u540e\uff0c\u5982\u679c\u67d0\u4e2a\u4e8b\u52a1\u60f3\u8981\u9501\u5b9a\u6574\u4e2a\u6570\u636e\u5e93\u6216\u8005\u6574\u5f20\u8868\u65f6\u53ea\u9700\u8981\u7b80\u5355\u7684\u9501\u4f4f\u5bf9\u5e94\u7684\u8282\u70b9\u5c31\u4f1a\u5728\u5f53\u524d\u8282\u70b9\u52a0\u4e0a\u663e\u793a\uff08explicit\uff09\u9501\uff0c\u5728\u6240\u6709\u7684\u5b50\u8282\u70b9\u4e0a\u52a0\u9690\u5f0f\uff08implicit\uff09\u9501\uff1b\u867d\u7136\u8fd9\u79cd\u4e0d\u540c\u7c92\u5ea6\u7684\u9501\u80fd\u591f\u89e3\u51b3\u7236\u8282\u70b9\u88ab\u52a0\u9501\u65f6\uff0c\u5b50\u8282\u70b9\u4e0d\u80fd\u88ab\u52a0\u9501\u7684\u95ee\u9898\uff0c\u4f46\u662f\u6211\u4eec\u6ca1\u6709\u529e\u6cd5\u5728\u5b50\u8282\u70b9\u88ab\u52a0\u9501\u65f6\uff0c\u7acb\u523b\u786e\u5b9a\u7236\u8282\u70b9\u4e0d\u80fd\u88ab\u52a0\u9501\u3002</p> <p>\u5728\u8fd9\u65f6\u6211\u4eec\u5c31\u9700\u8981\u5f15\u5165\u610f\u5411\u9501\u6765\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u4e86\uff0c\u5f53\u9700\u8981\u7ed9\u5b50\u8282\u70b9\u52a0\u9501\u65f6\uff0c\u5148\u7ed9\u6240\u6709\u7684\u7236\u8282\u70b9\u52a0\u5bf9\u5e94\u7684\u610f\u5411\u9501\uff0c\u610f\u5411\u9501\u4e4b\u95f4\u662f\u5b8c\u5168\u4e0d\u4f1a\u4e92\u65a5\u7684\uff0c\u53ea\u662f\u7528\u6765\u5e2e\u52a9\u7236\u8282\u70b9\u5feb\u901f\u5224\u65ad\u662f\u5426\u53ef\u4ee5\u5bf9\u8be5\u8282\u70b9\u8fdb\u884c\u52a0\u9501\uff1a</p> <p></p> <p>\u8fd9\u91cc\u662f\u4e00\u5f20\u5f15\u5165\u4e86\u4e24\u79cd\u610f\u5411\u9501\uff0c\u610f\u5411\u5171\u4eab\u9501\u548c\u610f\u5411\u4e92\u65a5\u9501\u4e4b\u540e\u6240\u6709\u7684\u9501\u4e4b\u95f4\u7684\u517c\u5bb9\u5173\u7cfb\uff1b\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u901a\u8fc7\u4e0d\u540c\u7c92\u5ea6\u7684\u9501\u548c\u610f\u5411\u9501\u52a0\u5feb\u4e86\u6570\u636e\u5e93\u7684\u541e\u5410\u91cf\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#8","title":"8 \u4e50\u89c2\u5e76\u53d1\u63a7\u5236","text":"<p>\u9664\u4e86\u60b2\u89c2\u5e76\u53d1\u63a7\u5236\u673a\u5236 - \u9501\u4e4b\u5916\uff0c\u6211\u4eec\u5176\u5b9e\u8fd8\u6709\u5176\u4ed6\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u4e50\u89c2\u5e76\u53d1\u63a7\u5236\uff08<code>Optimistic Concurrency Control</code>\uff09\u3002\u4e50\u89c2\u5e76\u53d1\u63a7\u5236\u4e5f\u53eb\u4e50\u89c2\u9501\uff0c</p> <p>\u4f46\u662f\u5b83\u5e76\u4e0d\u662f\u771f\u6b63\u7684\u9501\uff0c\u5f88\u591a\u4eba\u90fd\u4f1a\u8bef\u4ee5\u4e3a\u4e50\u89c2\u9501\u662f\u4e00\u79cd\u771f\u6b63\u7684\u9501\uff0c\u7136\u800c\u5b83\u53ea\u662f\u4e00\u79cd\u5e76\u53d1\u63a7\u5236\u7684\u601d\u60f3\u3002</p> <p></p> <p>\u6211\u4eec\u5c06\u4f1a\u5148\u4ecb\u7ecd\u57fa\u4e8e\u65f6\u95f4\u6233\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u7136\u540e\u5728\u8fd9\u4e2a\u534f\u8bae\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u6269\u5c55\uff0c\u5b9e\u73b0\u4e50\u89c2\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236</p>"},{"location":"chap1/5DB_locc_mvcc/#1_2","title":"1 \u57fa\u4e8e\u65f6\u95f4\u6233\u7684\u534f\u8bae","text":"<p>\u9501\u534f\u8bae\u6309\u7167\u4e0d\u540c\u4e8b\u52a1\u5bf9\u540c\u4e00\u6570\u636e\u9879\u8bf7\u6c42\u7684\u65f6\u95f4\u4f9d\u6b21\u6267\u884c\uff0c\u56e0\u4e3a\u540e\u9762\u6267\u884c\u7684\u4e8b\u52a1\u60f3\u8981\u83b7\u53d6\u7684\u6570\u636e\u5df2\u5c06\u88ab\u524d\u9762\u7684\u4e8b\u52a1\u52a0\u9501\uff0c\u53ea\u80fd\u7b49\u5f85\u9501\u7684\u91ca\u653e\uff0c\u6240\u4ee5\u57fa\u4e8e\u9501\u7684\u534f\u8bae\u6267\u884c\u4e8b\u52a1\u7684\u987a\u5e8f\u4e0e\u83b7\u5f97\u9501\u7684\u987a\u5e8f\u6709\u5173\u3002</p> <p>\u5728\u8fd9\u91cc\u60f3\u8981\u4ecb\u7ecd\u7684\u57fa\u4e8e\u65f6\u95f4\u6233\u7684\u534f\u8bae\u80fd\u591f\u5728\u4e8b\u52a1\u6267\u884c\u4e4b\u524d\u5148\u51b3\u5b9a\u4e8b\u52a1\u7684\u6267\u884c\u987a\u5e8f\u3002</p> <p>\u6bcf\u4e00\u4e2a\u4e8b\u52a1\u90fd\u4f1a\u5177\u6709\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684\u65f6\u95f4\u6233\uff0c\u5b83\u5373\u53ef\u4ee5\u4f7f\u7528\u7cfb\u7edf\u7684\u65f6\u949f\u65f6\u95f4\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u8ba1\u6570\u5668\uff0c\u53ea\u8981\u80fd\u591f\u4fdd\u8bc1\u6240\u6709\u7684\u65f6\u95f4\u6233\u90fd\u662f\u552f\u4e00\u5e76\u4e14\u662f\u968f\u65f6\u95f4\u9012\u589e\u7684\u5c31\u53ef\u4ee5\u3002</p> <p></p> <ul> <li>\u57fa\u4e8e\u65f6\u95f4\u6233\u7684\u534f\u8bae\u80fd\u591f\u4fdd\u8bc1\u4e8b\u52a1\u5e76\u884c\u6267\u884c\u7684\u987a\u5e8f\u4e0e\u4e8b\u52a1\u6309\u7167\u65f6\u95f4\u6233\u4e32\u884c\u6267\u884c\u7684\u6548\u679c\u5b8c\u5168\u76f8\u540c\uff1b</li> <li>\u6bcf\u4e00\u4e2a\u6570\u636e\u9879\u90fd\u6709\u4e24\u4e2a\u65f6\u95f4\u6233\uff0c\u8bfb\u65f6\u95f4\u6233\u548c\u5199\u65f6\u95f4\u6233\uff0c\u5206\u522b\u4ee3\u8868\u4e86\u5f53\u524d\u6210\u529f\u6267\u884c\u5bf9\u5e94\u64cd\u4f5c\u7684\u4e8b\u52a1\u7684\u65f6\u95f4\u6233\u3002</li> </ul> <p>\u8be5\u534f\u8bae\u80fd\u591f\u4fdd\u8bc1\u6240\u6709\u51b2\u7a81\u7684\u8bfb\u5199\u64cd\u4f5c\u90fd\u80fd\u6309\u7167\u65f6\u95f4\u6233\u7684\u5927\u5c0f\u4e32\u884c\u6267\u884c\uff0c\u5728\u6267\u884c\u5bf9\u5e94\u7684\u64cd\u4f5c\u65f6\u4e0d\u9700\u8981\u5173\u6ce8\u5176\u4ed6\u7684\u4e8b\u52a1\u53ea\u9700\u8981\u5173\u5fc3\u6570\u636e\u9879\u5bf9\u5e94\u65f6\u95f4\u6233\u7684\u503c\u5c31\u53ef\u4ee5\u4e86\uff1a</p> <p></p> <p>\u65e0\u8bba\u662f\u8bfb\u64cd\u4f5c\u8fd8\u662f\u5199\u64cd\u4f5c\u90fd\u4f1a\u4ece\u5de6\u5230\u53f3\u4f9d\u6b21\u6bd4\u8f83\u8bfb\u5199\u65f6\u95f4\u6233\u7684\u503c\uff0c\u5982\u679c\u5c0f\u4e8e\u5f53\u524d\u503c\u5c31\u4f1a\u76f4\u63a5\u88ab\u62d2\u7edd\u7136\u540e\u56de\u6eda\uff0c\u6570\u636e\u5e93\u7cfb\u7edf\u4f1a\u7ed9\u56de\u6eda\u7684\u4e8b\u52a1\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u65f6\u95f4\u6233\u5e76\u91cd\u65b0\u6267\u884c\u8fd9\u4e2a\u4e8b\u52a1\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#2_1","title":"2 \u57fa\u4e8e\u9a8c\u8bc1\u7684\u534f\u8bae","text":"<p>\u4e50\u89c2\u5e76\u53d1\u63a7\u5236\u5176\u5b9e\u672c\u8d28\u4e0a\u5c31\u662f\u57fa\u4e8e\u9a8c\u8bc1\u7684\u534f\u8bae\uff0c\u56e0\u4e3a\u5728\u591a\u6570\u7684\u5e94\u7528\u4e2d\u53ea\u8bfb\u7684\u4e8b\u52a1\u5360\u4e86\u7edd\u5927\u591a\u6570\uff0c\u4e8b\u52a1\u4e4b\u95f4\u56e0\u4e3a\u5199\u64cd\u4f5c\u9020\u6210\u51b2\u7a81\u7684\u53ef\u80fd\u975e\u5e38\u5c0f\uff0c\u4e5f\u5c31\u662f\u8bf4\u5927\u591a\u6570\u7684\u4e8b\u52a1\u5728\u4e0d\u9700\u8981\u5e76\u53d1\u63a7\u5236\u673a\u5236\u4e5f\u80fd\u8fd0\u884c\u7684\u975e\u5e38\u597d\uff0c\u4e5f\u53ef\u4ee5\u4fdd\u8bc1\u6570\u636e\u5e93\u7684\u4e00\u81f4\u6027\uff1b</p> <p>\u800c\u5e76\u53d1\u63a7\u5236\u673a\u5236\u5176\u5b9e\u5411\u6574\u4e2a\u6570\u636e\u5e93\u7cfb\u7edf\u6dfb\u52a0\u4e86\u5f88\u591a\u7684\u5f00\u9500\uff0c\u6211\u4eec\u5176\u5b9e\u53ef\u4ee5\u901a\u8fc7\u522b\u7684\u7b56\u7565\u964d\u4f4e\u8fd9\u90e8\u5206\u5f00\u9500\u3002</p> <p>\u800c\u9a8c\u8bc1\u534f\u8bae\u5c31\u662f\u6211\u4eec\u627e\u5230\u7684\u89e3\u51b3\u529e\u6cd5\uff0c\u5b83\u6839\u636e\u4e8b\u52a1\u7684\u53ea\u8bfb\u6216\u8005\u66f4\u65b0\u5c06\u6240\u6709\u4e8b\u52a1\u7684\u6267\u884c\u5206\u4e3a\u4e24\u5230\u4e09\u4e2a\u9636\u6bb5\uff1a</p> <p></p> <ul> <li>\u5728\u8bfb\u9636\u6bb5\uff0c\u6570\u636e\u5e93\u4f1a\u6267\u884c\u4e8b\u52a1\u4e2d\u7684\u5168\u90e8\u8bfb\u64cd\u4f5c\u548c\u5199\u64cd\u4f5c\uff0c\u5e76\u5c06\u6240\u6709\u5199\u540e\u7684\u503c\u5b58\u5165\u4e34\u65f6\u53d8\u91cf\u4e2d\uff0c\u5e76\u4e0d\u4f1a\u771f\u6b63\u66f4\u65b0\u6570\u636e\u5e93\u4e2d\u7684\u5185\u5bb9\uff1b</li> <li>\u5728\u8fd9\u65f6\u5019\u4f1a\u8fdb\u5165\u4e0b\u4e00\u4e2a\u9636\u6bb5\uff0c\u6570\u636e\u5e93\u7a0b\u5e8f\u4f1a\u68c0\u67e5\u5f53\u524d\u7684\u6539\u52a8\u662f\u5426\u5408\u6cd5\uff0c\u4e5f\u5c31\u662f\u662f\u5426\u6709\u5176\u4ed6\u4e8b\u52a1\u5728 <code>RAED PHASE</code> \u671f\u95f4\u66f4\u65b0\u4e86\u6570\u636e\uff0c</li> <li>\u5982\u679c\u901a\u8fc7\u6d4b\u8bd5\u90a3\u4e48\u76f4\u63a5\u5c31\u8fdb\u5165 <code>WRITE PHASE</code> \u5c06\u6240\u6709\u5b58\u5728\u4e34\u65f6\u53d8\u91cf\u4e2d\u7684\u6539\u52a8\u5168\u90e8\u5199\u5165\u6570\u636e\u5e93\uff0c\u6ca1\u6709\u901a\u8fc7\u6d4b\u8bd5\u7684\u4e8b\u52a1\u4f1a\u76f4\u63a5\u88ab\u7ec8\u6b62\u3002</li> </ul> <p>\u4e3a\u4e86\u4fdd\u8bc1\u4e50\u89c2\u5e76\u53d1\u63a7\u5236\u80fd\u591f\u6b63\u5e38\u8fd0\u884c\uff0c\u6211\u4eec\u9700\u8981\u77e5\u9053\u4e00\u4e2a\u4e8b\u52a1\u4e0d\u540c\u9636\u6bb5\u7684\u53d1\u751f\u65f6\u95f4\uff0c\u5305\u62ec\u4e8b\u52a1\u5f00\u59cb\u65f6\u95f4\u3001\u9a8c\u8bc1\u9636\u6bb5\u7684\u5f00\u59cb\u65f6\u95f4\u4ee5\u53ca\u5199\u9636\u6bb5\u7684\u7ed3\u675f\u65f6\u95f4\uff1b\u901a\u8fc7\u8fd9\u4e09\u4e2a\u65f6\u95f4\u6233\uff0c\u6211\u4eec\u53ef\u4ee5\u4fdd\u8bc1\u4efb\u610f\u51b2\u7a81\u7684\u4e8b\u52a1\u4e0d\u4f1a\u540c\u65f6\u5199\u5165\u6570\u636e\u5e93\uff0c\u4e00\u65e6\u7531\u4e00\u4e2a\u4e8b\u52a1\u5b8c\u6210\u4e86\u9a8c\u8bc1\u9636\u6bb5\u5c31\u4f1a\u7acb\u5373\u5199\u5165\uff0c\u5176\u4ed6\u8bfb\u53d6\u4e86\u76f8\u540c\u6570\u636e\u7684\u4e8b\u52a1\u5c31\u4f1a\u56de\u6eda\u91cd\u65b0\u6267\u884c\u3002</p> <p>\u4f5c\u4e3a\u4e50\u89c2\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u5b83\u4f1a\u5047\u5b9a\u6240\u6709\u7684\u4e8b\u52a1\u5728\u6700\u7ec8\u90fd\u4f1a\u901a\u8fc7\u9a8c\u8bc1\u9636\u6bb5\u5e76\u4e14\u6267\u884c\u6210\u529f\uff0c\u800c\u9501\u673a\u5236\u548c\u57fa\u4e8e\u65f6\u95f4\u6233\u6392\u5e8f\u7684\u534f\u8bae\u662f\u60b2\u89c2\u7684\uff0c\u56e0\u4e3a\u5b83\u4eec\u4f1a\u5728\u53d1\u751f\u51b2\u7a81\u65f6\u5f3a\u5236\u4e8b\u52a1\u8fdb\u884c\u7b49\u5f85\u6216\u8005\u56de\u6eda\uff0c\u54ea\u6015\u6709\u4e0d\u9700\u8981\u9501\u4e5f\u80fd\u591f\u4fdd\u8bc1\u4e8b\u52a1\u4e4b\u95f4\u4e0d\u4f1a\u51b2\u7a81\u7684\u53ef\u80fd\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#9","title":"9 \u591a\u7248\u672c\u5e76\u53d1\u63a7","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\u6211\u4eec\u4ecb\u7ecd\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\u5176\u5b9e\u90fd\u662f\u901a\u8fc7\u5ef6\u8fdf\u6216\u8005\u7ec8\u6b62\u76f8\u5e94\u7684\u4e8b\u52a1\u6765\u89e3\u51b3\u4e8b\u52a1\u4e4b\u95f4\u7684\u7ade\u4e89\u6761\u4ef6\uff08<code>Race condition</code>\uff09\u6765\u4fdd\u8bc1\u4e8b\u52a1\u7684\u53ef\u4e32\u884c\u5316\uff1b\u867d\u7136\u524d\u9762\u7684\u4e24\u79cd\u5e76\u53d1\u63a7\u5236\u673a\u5236\u786e\u5b9e\u80fd\u591f\u4ece\u6839\u672c\u4e0a\u89e3\u51b3\u5e76\u53d1\u4e8b\u52a1\u7684\u53ef\u4e32\u884c\u5316\u7684\u95ee\u9898\uff0c\u4f46\u662f\u5728\u5b9e\u9645\u73af\u5883\u4e2d\u6570\u636e\u5e93\u7684\u4e8b\u52a1\u5927\u90fd\u662f\u53ea\u8bfb\u7684\uff0c\u8bfb\u8bf7\u6c42\u662f\u5199\u8bf7\u6c42\u7684\u5f88\u591a\u500d\uff0c\u5982\u679c\u5199\u8bf7\u6c42\u548c\u8bfb\u8bf7\u6c42\u4e4b\u524d\u6ca1\u6709\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u90a3\u4e48\u6700\u574f\u7684\u60c5\u51b5\u4e5f\u662f\u8bfb\u8bf7\u6c42\u8bfb\u5230\u4e86\u5df2\u7ecf\u5199\u5165\u7684\u6570\u636e\uff0c\u8fd9\u5bf9\u5f88\u591a\u5e94\u7528\u5b8c\u5168\u662f\u53ef\u4ee5\u63a5\u53d7\u7684\u3002</p> <p></p> <p>\u5728\u8fd9\u79cd\u5927\u524d\u63d0\u4e0b\uff0c\u6570\u636e\u5e93\u7cfb\u7edf\u5f15\u5165\u4e86\u53e6\u4e00\u79cd\u5e76\u53d1\u63a7\u5236\u673a\u5236 - \u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff08Multiversion Concurrency Control\uff09\uff0c\u6bcf\u4e00\u4e2a\u5199\u64cd\u4f5c\u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u65b0\u7248\u672c\u7684\u6570\u636e\uff0c\u8bfb\u64cd\u4f5c\u4f1a\u4ece\u6709\u9650\u591a\u4e2a\u7248\u672c\u7684\u6570\u636e\u4e2d\u6311\u9009\u4e00\u4e2a\u6700\u5408\u9002\u7684\u7ed3\u679c\u76f4\u63a5\u8fd4\u56de\uff1b</p> <p>\u5728\u8fd9\u65f6\uff0c\u8bfb\u5199\u64cd\u4f5c\u4e4b\u95f4\u7684\u51b2\u7a81\u5c31\u4e0d\u518d\u9700\u8981\u88ab\u5173\u6ce8\uff0c\u800c\u7ba1\u7406\u548c\u5feb\u901f\u6311\u9009\u6570\u636e\u7684\u7248\u672c\u5c31\u6210\u4e86<code>MVCC</code> \u9700\u8981\u89e3\u51b3\u7684\u4e3b\u8981\u95ee\u9898\u3002</p> <p><code>MVCC</code> \u5e76\u4e0d\u662f\u4e00\u4e2a\u4e0e\u4e50\u89c2\u548c\u60b2\u89c2\u5e76\u53d1\u63a7\u5236\u5bf9\u7acb\u7684\u4e1c\u897f\uff0c\u5b83\u80fd\u591f\u4e0e\u4e24\u8005\u5f88\u597d\u7684\u7ed3\u5408\u4ee5\u589e\u52a0\u4e8b\u52a1\u7684\u5e76\u53d1\u91cf\uff0c\u5728\u76ee\u524d\u6700\u6d41\u884c\u7684 <code>SQL</code> \u6570\u636e\u5e93 <code>MySQL</code> \u548c <code>PostgreSQL</code> \u4e2d\u90fd\u5bf9 <code>MVCC</code> \u8fdb\u884c\u4e86\u5b9e\u73b0\uff1b\u4f46\u662f\u7531\u4e8e\u5b83\u4eec\u5206\u522b\u5b9e\u73b0\u4e86\u60b2\u89c2\u9501\u548c\u4e50\u89c2\u9501\uff0c\u6240\u4ee5 <code>MVCC</code> \u5b9e\u73b0\u7684\u65b9\u5f0f\u4e5f\u4e0d\u540c\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#1-mysql-mvcc","title":"1 MySQL \u4e0e MVCC","text":"<p>MySQL \u4e2d\u5b9e\u73b0\u7684\u591a\u7248\u672c\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff08<code>Multiversion 2PL</code>\uff09\u5c06 <code>MVCC</code> \u548c <code>2PL</code> \u7684\u4f18\u70b9\u7ed3\u5408\u4e86\u8d77\u6765\uff0c\u6bcf\u4e00\u4e2a\u7248\u672c\u7684\u6570\u636e\u884c\u90fd\u5177\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u65f6\u95f4\u6233\uff0c\u5f53\u6709\u8bfb\u4e8b\u52a1\u8bf7\u6c42\u65f6\uff0c\u6570\u636e\u5e93\u7a0b\u5e8f\u4f1a\u76f4\u63a5\u4ece\u591a\u4e2a\u7248\u672c\u7684\u6570\u636e\u9879\u4e2d\u5177\u6709\u6700\u5927\u65f6\u95f4\u6233\u7684\u8fd4\u56de\u3002</p> <p></p> <p>\u66f4\u65b0\u64cd\u4f5c\u5c31\u7a0d\u5fae\u6709\u4e9b\u590d\u6742\u4e86\uff0c\u4e8b\u52a1\u4f1a\u5148\u8bfb\u53d6\u6700\u65b0\u7248\u672c\u7684\u6570\u636e\u8ba1\u7b97\u51fa\u6570\u636e\u66f4\u65b0\u540e\u7684\u7ed3\u679c\uff0c\u7136\u540e\u521b\u5efa\u4e00\u4e2a\u65b0\u7248\u672c\u7684\u6570\u636e\uff0c\u65b0\u6570\u636e\u7684\u65f6\u95f4\u6233\u662f\u76ee\u524d\u6570\u636e\u884c\u7684\u6700\u5927\u7248\u672c <code>\uff0b1</code>\uff1a</p> <p></p> <p>\u6570\u636e\u7248\u672c\u7684\u5220\u9664\u4e5f\u662f\u6839\u636e\u65f6\u95f4\u6233\u6765\u9009\u62e9\u7684\uff0c<code>MySQL</code> \u4f1a\u5c06\u7248\u672c\u6700\u4f4e\u7684\u6570\u636e\u5b9a\u65f6\u4ece\u6570\u636e\u5e93\u4e2d\u6e05\u9664\u4ee5\u4fdd\u8bc1\u4e0d\u4f1a\u51fa\u73b0\u5927\u91cf\u7684\u9057\u7559\u5185\u5bb9\u3002</p>"},{"location":"chap1/5DB_locc_mvcc/#2-postgresql-mvcc","title":"2 PostgreSQL \u4e0e MVCC","text":"<p>\u4e0e <code>MySQL</code> \u4e2d\u4f7f\u7528\u60b2\u89c2\u5e76\u53d1\u63a7\u5236\u4e0d\u540c\uff0c<code>PostgreSQL</code> \u4e2d\u90fd\u662f\u4f7f\u7528\u4e50\u89c2\u5e76\u53d1\u63a7\u5236\u7684\uff0c\u8fd9\u4e5f\u5c31\u5bfc\u81f4\u4e86 <code>MVCC</code> \u5728\u4e8e\u4e50\u89c2\u9501\u7ed3\u5408\u65f6\u7684\u5b9e\u73b0\u4e0a\u6709\u4e00\u4e9b\u4e0d\u540c\uff0c\u6700\u7ec8\u5b9e\u73b0\u7684\u53eb\u505a\u591a\u7248\u672c\u65f6\u95f4\u6233\u6392\u5e8f\u534f\u8bae\uff08<code>Multiversion Timestamp Ordering</code>\uff09\uff0c\u5728\u8fd9\u4e2a\u534f\u8bae\u4e2d\uff0c\u6240\u6709\u7684\u7684\u4e8b\u52a1\u5728\u6267\u884c\u4e4b\u524d\u90fd\u4f1a\u88ab\u5206\u914d\u4e00\u4e2a\u552f\u4e00\u7684\u65f6\u95f4\u6233\uff0c\u6bcf\u4e00\u4e2a\u6570\u636e\u9879\u90fd\u6709\u8bfb\u5199\u4e24\u4e2a\u65f6\u95f4\u6233\uff1a</p> <p></p> <p>\u5f53 <code>PostgreSQL</code> \u7684\u4e8b\u52a1\u53d1\u51fa\u4e86\u4e00\u4e2a\u8bfb\u8bf7\u6c42\uff0c\u6570\u636e\u5e93\u76f4\u63a5\u5c06\u6700\u65b0\u7248\u672c\u7684\u6570\u636e\u8fd4\u56de\uff0c\u4e0d\u4f1a\u88ab\u4efb\u4f55\u64cd\u4f5c\u963b\u585e\uff0c\u800c\u5199\u64cd\u4f5c\u5728\u6267\u884c\u65f6\uff0c\u4e8b\u52a1\u7684\u65f6\u95f4\u6233\u4e00\u5b9a\u8981\u5927\u6216\u8005\u7b49\u4e8e\u6570\u636e\u884c\u7684\u8bfb\u65f6\u95f4\u6233\uff0c\u5426\u5219\u5c31\u4f1a\u88ab\u56de\u6eda\u3002</p> <p>\u8fd9\u79cd <code>MVCC</code>\u7684\u5b9e\u73b0\u4fdd\u8bc1\u4e86\u8bfb\u4e8b\u52a1\u6c38\u8fdc\u90fd\u4e0d\u4f1a\u5931\u8d25\u5e76\u4e14\u4e0d\u9700\u8981\u7b49\u5f85\u9501\u7684\u91ca\u653e\uff0c\u5bf9\u4e8e\u8bfb\u8bf7\u6c42\u8fdc\u8fdc\u591a\u4e8e\u5199\u8bf7\u6c42\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u4e50\u89c2\u9501\u52a0 <code>MVCC</code> \u5bf9\u6570\u636e\u5e93\u7684\u6027\u80fd\u6709\u7740\u975e\u5e38\u5927\u7684\u63d0\u5347\uff1b\u867d\u7136\u8fd9\u79cd\u534f\u8bae\u80fd\u591f\u9488\u5bf9\u4e00\u4e9b\u5b9e\u9645\u60c5\u51b5\u505a\u51fa\u4e00\u4e9b\u660e\u663e\u7684\u6027\u80fd\u63d0\u5347\uff0c\u4f46\u662f\u4e5f\u4f1a\u5bfc\u81f4\u4e24\u4e2a\u95ee\u9898\uff0c\u4e00\u4e2a\u662f\u6bcf\u4e00\u6b21\u8bfb\u64cd\u4f5c\u90fd\u4f1a\u66f4\u65b0\u8bfb\u65f6\u95f4\u6233\u9020\u6210\u4e24\u6b21\u7684\u78c1\u76d8\u5199\u5165\uff0c\u7b2c\u4e8c\u662f\u4e8b\u52a1\u4e4b\u95f4\u7684\u51b2\u7a81\u662f\u901a\u8fc7\u56de\u6eda\u89e3\u51b3\u7684\uff0c\u6240\u4ee5\u5982\u679c\u51b2\u7a81\u7684\u53ef\u80fd\u6027\u975e\u5e38\u9ad8\u6216\u8005\u56de\u6eda\u4ee3\u4ef7\u5de8\u5927\uff0c\u6570\u636e\u5e93\u7684\u8bfb\u5199\u6027\u80fd\u8fd8\u4e0d\u5982\u4f7f\u7528\u4f20\u7edf\u7684\u9501\u7b49\u5f85\u65b9\u5f0f\u3002</p>"},{"location":"chap1/5mysql_lock/","title":"\u7b2c\u4e94\u8282 \u5168\u5c40\u9501\u548c\u8868\u9501","text":"<p>\u6570\u636e\u5e93\u9501\u8bbe\u8ba1\u7684\u521d\u8877\u662f\u5904\u7406\u5e76\u53d1\u95ee\u9898\u3002\u4f5c\u4e3a\u591a\u7528\u6237\u5171\u4eab\u7684\u8d44\u6e90\uff0c\u5f53\u51fa\u73b0\u5e76\u53d1\u8bbf\u95ee\u7684\u65f6\u5019\uff0c\u6570\u636e\u5e93\u9700\u8981\u5408\u7406\u5730\u63a7\u5236\u8d44\u6e90\u7684\u8bbf\u95ee\u89c4\u5219\u3002\u800c\u9501\u5c31\u662f\u7528\u6765\u5b9e\u73b0\u8fd9\u4e9b\u8bbf\u95ee\u89c4\u5219\u7684\u91cd\u8981\u6570\u636e\u7ed3\u6784\u3002</p> <p>\u6839\u636e\u52a0\u9501\u7684\u8303\u56f4\uff0cMySQL \u91cc\u9762\u7684\u9501\u5927\u81f4\u53ef\u4ee5\u5206\u6210\u5168\u5c40\u9501\u3001\u8868\u7ea7\u9501\u548c\u884c\u9501\u4e09\u7c7b</p>"},{"location":"chap1/5mysql_lock/#1","title":"1\u3001\u5168\u5c40\u9501","text":""},{"location":"chap1/5mysql_lock/#1-1-flush-tables-with-read-lock-ftwrl","title":"1-1 \u4f7f\u7528\u52a0\u5168\u5c40\u8bfb\u9501 <code>Flush tables with read lock (FTWRL)</code>","text":"<p>\u5168\u5c40\u9501\u5c31\u662f\u5bf9\u6574\u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u52a0\u9501\u3002</p> <p>MySQL \u63d0\u4f9b\u4e86\u4e00\u4e2a\u52a0\u5168\u5c40\u8bfb\u9501\u7684\u65b9\u6cd5\uff0c\u547d\u4ee4\u662f <code>Flush tables with read lock (FTWRL)</code>\u3002</p> <p>\u5f53\u4f60\u9700\u8981\u8ba9\u6574\u4e2a\u5e93\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u4f7f\u7528\u8fd9\u4e2a\u547d\u4ee4\uff0c\u4e4b\u540e\u5176\u4ed6\u7ebf\u7a0b\u7684\u4ee5\u4e0b\u8bed\u53e5\u4f1a\u88ab\u963b\u585e\uff1a</p> <ul> <li>\u6570\u636e\u66f4\u65b0\u8bed\u53e5\uff08\u6570\u636e\u7684\u589e\u5220\u6539\uff09</li> <li>\u6570\u636e\u5b9a\u4e49\u8bed\u53e5\uff08\u5305\u62ec\u5efa\u8868\u3001\u4fee\u6539\u8868\u7ed3\u6784\u7b49\uff09</li> <li>\u66f4\u65b0\u7c7b\u4e8b\u52a1\u7684\u63d0\u4ea4\u8bed\u53e5</li> </ul> <p>unlock tables\u53ef\u4ee5\u89e3\u9664</p> <p>\u5168\u5c40\u9501\u7684\u5178\u578b\u4f7f\u7528\u573a\u666f\u662f\uff0c\u505a\u5168\u5e93\u903b\u8f91\u5907\u4efd\u3002\u4e5f\u5c31\u662f\u628a\u6574\u5e93\u6bcf\u4e2a\u8868\u90fd select \u51fa\u6765\u5b58\u6210\u6587\u672c\u3002</p> <p>\u4ee5\u524d\u6709\u4e00\u79cd\u505a\u6cd5\uff0c\u662f\u901a\u8fc7 <code>FTWRL</code> \u786e\u4fdd\u4e0d\u4f1a\u6709\u5176\u4ed6\u7ebf\u7a0b\u5bf9\u6570\u636e\u5e93\u505a\u66f4\u65b0\uff0c\u7136\u540e\u5bf9\u6574\u4e2a\u5e93\u505a\u5907\u4efd\u3002\u6ce8\u610f\uff0c\u5728\u5907\u4efd\u8fc7\u7a0b\u4e2d\u6574\u4e2a\u5e93\u5b8c\u5168\u5904\u4e8e\u53ea\u8bfb\u72b6\u6001\u3002 \u4f46\u662f\u8ba9\u6574\u5e93\u90fd\u53ea\u8bfb\uff0c\u542c\u4e0a\u53bb\u5c31\u5f88\u5371\u9669\uff1a</p> <ul> <li>\u5982\u679c\u4f60\u5728\u4e3b\u5e93\u4e0a\u5907\u4efd\uff0c\u90a3\u4e48\u5728\u5907\u4efd\u671f\u95f4\u90fd\u4e0d\u80fd\u6267\u884c\u66f4\u65b0\uff0c\u4e1a\u52a1\u57fa\u672c\u4e0a\u5c31\u5f97\u505c\u6446\uff1b</li> <li>\u5982\u679c\u4f60\u5728\u4ece\u5e93\u4e0a\u5907\u4efd\uff0c\u90a3\u4e48\u5907\u4efd\u671f\u95f4\u4ece\u5e93\u4e0d\u80fd\u6267\u884c\u4e3b\u5e93\u540c\u6b65\u8fc7\u6765\u7684 binlog\uff0c\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u5ef6\u8fdf\u3002</li> </ul> <p>\u770b\u6765\u52a0\u5168\u5c40\u9501\u4e0d\u592a\u597d\u3002\u4f46\u662f\u7ec6\u60f3\u4e00\u4e0b\uff0c\u5907\u4efd\u4e3a\u4ec0\u4e48\u8981\u52a0\u9501\u5462\uff1f</p> <p>\u4e0d\u52a0\u9501\u7684\u8bdd\uff0c\u5907\u4efd\u7cfb\u7edf\u5907\u4efd\u7684\u5f97\u5230\u7684\u5e93\u4e0d\u662f\u4e00\u4e2a\u903b\u8f91\u65f6\u95f4\u70b9\uff0c\u8fd9\u4e2a\u89c6\u56fe\u662f\u903b\u8f91\u4e0d\u4e00\u81f4\u7684\u3002</p> <ul> <li>\u5982\u679c\u4e0d\u5728\u5168\u5c40\u9501\uff0c\u56e0\u4e3a\u4e0d\u540c\u8868\u4e4b\u95f4\u7684\u6267\u884c\u987a\u5e8f\u4e0d\u540c\u8fdb\u800c\u5907\u4efd\u7684\u65f6\u95f4\u4e0d\u540c\u3002</li> <li>\u5982\u679c\u67d0\u4e2a\u8868\u5728\u8fd9\u4e2a\u65f6\u95f4\u5dee\u4e2d\u8fdb\u884c\u4e86\u66f4\u65b0\u5e76\u4e14\u6210\u529f\u88ab\u5907\u4efd\uff0c\u800c\u4e0e\u5176\u6709\u5173\u8054\u7684\u8868\u5df2\u7ecf\u5728\u4e4b\u524d\u5907\u4efd\u5b8c\u6bd5\u5df2\u65e0\u6cd5\u66f4\u65b0\u3002\u6b64\u65f6\u5c31\u53d1\u751f\u6570\u636e\u4e0d\u4e00\u81f4\u3002</li> </ul>"},{"location":"chap1/5mysql_lock/#1-2-innodb","title":"1-2 \u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u53ea\u9002\u7528\u4e8eInnoDB","text":"<p>\u5176\u5b9e\u662f\u6709\u4e00\u4e2a\u65b9\u6cd5\u80fd\u591f\u62ff\u5230\u4e00\u81f4\u6027\u89c6\u56fe\u7684\uff0c \u5c31\u662f\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\u5f00\u542f\u4e00\u4e2a\u4e8b\u52a1</p> <p>\u5b98\u65b9\u81ea\u5e26\u7684\u903b\u8f91\u5907\u4efd\u5de5\u5177\u662f <code>mysqldump</code>\u3002\u5f53 <code>mysqldump</code> \u4f7f\u7528\u53c2\u6570<code>\u2013single-transaction</code> \u7684\u65f6\u5019\uff0c\u5bfc\u6570\u636e\u4e4b\u524d\u5c31\u4f1a\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u6765\u786e\u4fdd\u62ff\u5230\u4e00\u81f4\u6027\u89c6\u56fe\u3002\u800c\u7531\u4e8e MVCC \u7684\u652f\u6301\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u6570\u636e\u662f\u53ef\u4ee5\u6b63\u5e38\u66f4\u65b0\u7684\u3002</p> <p>\u6709\u4e86\u8fd9\u4e2a\u529f\u80fd\uff0c\u4e3a\u4ec0\u4e48\u8fd8\u9700\u8981 FTWRL \u5462\uff1f \u4e00\u81f4\u6027\u8bfb\u662f\u597d\uff0c\u4f46\u524d\u63d0\u662f\u5f15\u64ce\u8981\u652f\u6301\u8fd9\u4e2a\u9694\u79bb\u7ea7\u522b\u3002\u6bd4\u5982\uff0c\u5bf9\u4e8e MyISAM \u8fd9\u79cd\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u5982\u679c\u5907\u4efd\u8fc7\u7a0b\u4e2d\u6709\u66f4\u65b0\uff0c\u603b\u662f\u53ea\u80fd\u53d6\u5230\u6700\u65b0\u7684\u6570\u636e\uff0c\u90a3\u4e48\u5c31\u7834\u574f\u4e86\u5907\u4efd\u7684\u4e00\u81f4\u6027\u3002</p> <p><code>single-transaction</code> \u65b9\u6cd5\u53ea\u9002\u7528\u4e8e\u6240\u6709\u7684\u8868\u4f7f\u7528\u4e8b\u52a1\u5f15\u64ce\u7684\u5e93\u3002\u5982\u679c\u6709\u7684\u8868\u4f7f\u7528\u4e86\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u90a3\u4e48\u5907\u4efd\u5c31\u53ea\u80fd\u901a\u8fc7 <code>FTWRL</code> \u65b9\u6cd5\u3002\u8fd9\u5f80\u5f80\u662f DBA \u8981\u6c42\u4e1a\u52a1\u5f00\u53d1\u4eba\u5458\u4f7f\u7528 InnoDB \u66ff\u4ee3 MyISAM \u7684\u539f\u56e0\u4e4b\u4e00\u3002</p>"},{"location":"chap1/5mysql_lock/#1-3-set-global-readonlytrue","title":"1-3 \u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 <code>set global readonly=true</code>","text":"<p>\u65e2\u7136\u8981\u5168\u5e93\u53ea\u8bfb\uff0c\u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 <code>set global readonly=true</code> \u7684\u65b9\u5f0f\u5462\uff1f\u786e\u5b9e readonly \u65b9\u5f0f\u4e5f\u53ef\u4ee5\u8ba9\u5168\u5e93\u8fdb\u5165\u53ea\u8bfb\u72b6\u6001\uff0c\u4f46\u6211\u8fd8\u662f\u4f1a\u5efa\u8bae\u4f60\u7528 FTWRL \u65b9\u5f0f\uff0c\u4e3b\u8981\u6709\u4e24\u4e2a\u539f\u56e0\uff1a</p> <ul> <li>\u4e00\u662f\uff0c\u5728\u6709\u4e9b\u7cfb\u7edf\u4e2d\uff0c<code>readonly</code> \u7684\u503c\u4f1a\u88ab\u7528\u6765\u505a\u5176\u4ed6\u903b\u8f91\uff0c\u6bd4\u5982\u7528\u6765\u5224\u65ad\u4e00\u4e2a\u5e93\u662f\u4e3b\u5e93\u8fd8\u662f\u5907\u5e93\u3002\u56e0\u6b64\uff0c\u4fee\u6539 global \u53d8\u91cf\u7684\u65b9\u5f0f\u5f71\u54cd\u9762\u66f4\u5927\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u4f7f\u7528\u3002</li> <li>\u4e8c\u662f\uff0c\u5728\u5f02\u5e38\u5904\u7406\u673a\u5236\u4e0a\u6709\u5dee\u5f02\u3002\u5982\u679c\u6267\u884c FTWRL \u547d\u4ee4\u4e4b\u540e\u7531\u4e8e\u5ba2\u6237\u7aef\u53d1\u751f\u5f02\u5e38\u65ad\u5f00\uff0c\u90a3\u4e48 MySQL \u4f1a\u81ea\u52a8\u91ca\u653e\u8fd9\u4e2a\u5168\u5c40\u9501\uff0c\u6574\u4e2a\u5e93\u56de\u5230\u53ef\u4ee5\u6b63\u5e38\u66f4\u65b0\u7684\u72b6\u6001\u3002\u800c\u5c06\u6574\u4e2a\u5e93\u8bbe\u7f6e\u4e3a <code>readonly</code> \u4e4b\u540e\uff0c\u5982\u679c\u5ba2\u6237\u7aef\u53d1\u751f\u5f02\u5e38\uff0c\u5219\u6570\u636e\u5e93\u5c31\u4f1a\u4e00\u76f4\u4fdd\u6301 <code>readonly</code> \u72b6\u6001\uff0c\u8fd9\u6837\u4f1a\u5bfc\u81f4\u6574\u4e2a\u5e93\u957f\u65f6\u95f4\u5904\u4e8e\u4e0d\u53ef\u5199\u72b6\u6001\uff0c\u98ce\u9669\u8f83\u9ad8\u3002</li> </ul> <p>\u4e1a\u52a1\u7684\u66f4\u65b0\u4e0d\u53ea\u662f\u589e\u5220\u6539\u6570\u636e\uff08DML)\uff0c\u8fd8\u6709\u53ef\u80fd\u662f\u52a0\u5b57\u6bb5\u7b49\u4fee\u6539\u8868\u7ed3\u6784\u7684\u64cd\u4f5c\uff08DDL\uff09\u3002\u4e0d\u8bba\u662f\u54ea\u79cd\u65b9\u6cd5\uff0c\u4e00\u4e2a\u5e93\u88ab\u5168\u5c40\u9501\u4e0a\u4ee5\u540e\uff0c\u4f60\u8981\u5bf9\u91cc\u9762\u4efb\u4f55\u4e00\u4e2a\u8868\u505a\u52a0\u5b57\u6bb5\u64cd\u4f5c\uff0c\u90fd\u662f\u4f1a\u88ab\u9501\u4f4f\u7684\u3002</p>"},{"location":"chap1/5mysql_lock/#2","title":"2\u3001\u8868\u7ea7\u9501","text":"<p>MySQL \u91cc\u9762\u8868\u7ea7\u522b\u7684\u9501\u6709\u4e24\u79cd\uff1a\u4e00\u79cd\u662f\u8868\u9501\uff0c\u4e00\u79cd\u662f\u5143\u6570\u636e\u9501\uff08meta data lock\uff0cMDL)\u3002</p>"},{"location":"chap1/5mysql_lock/#2-1","title":"2-1 \u8868\u9501","text":"<p>\u8868\u9501\u7684\u8bed\u6cd5\u662f <code>lock tables \u2026 read/write</code>\u3002\u4e0e FTWRL \u7c7b\u4f3c\uff0c\u53ef\u4ee5\u7528 <code>unlock tables</code> \u4e3b\u52a8\u91ca\u653e\u9501\uff0c\u4e5f\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u65ad\u5f00\u7684\u65f6\u5019\u81ea\u52a8\u91ca\u653e\u3002</p> <p>\u9700\u8981\u6ce8\u610f\uff0clock tables \u8bed\u6cd5\u9664\u4e86\u4f1a\u9650\u5236\u522b\u7684\u7ebf\u7a0b\u7684\u8bfb\u5199\u5916\uff0c\u4e5f\u9650\u5b9a\u4e86\u672c\u7ebf\u7a0b\u63a5\u4e0b\u6765\u7684\u64cd\u4f5c\u5bf9\u8c61\u3002</p> <p>\u4e3e\u4e2a\u4f8b\u5b50, \u5982\u679c\u5728\u67d0\u4e2a\u7ebf\u7a0b A \u4e2d\u6267\u884c<code>lock tables t1 read, t2 write;</code> \u8fd9\u4e2a\u8bed\u53e5\uff0c\u5219\u5176\u4ed6\u7ebf\u7a0b\u5199 t1\u3001\u8bfb\u5199 t2 \u7684\u8bed\u53e5\u90fd\u4f1a\u88ab\u963b\u585e\u3002</p> <p>\u540c\u65f6\uff0c\u7ebf\u7a0b A \u5728\u6267\u884c <code>unlock tables</code> \u4e4b\u524d\uff0c\u4e5f\u53ea\u80fd\u6267\u884c\u8bfb t1\u3001\u8bfb\u5199 t2 \u7684\u64cd\u4f5c\u3002\u8fde\u5199 t1 \u90fd\u4e0d\u5141\u8bb8\uff0c\u81ea\u7136\u4e5f\u4e0d\u80fd\u8bbf\u95ee\u5176\u4ed6\u8868\u3002</p> <p>\u5bf9\u4e8e InnoDB \u8fd9\u79cd\u652f\u6301\u884c\u9501\u7684\u5f15\u64ce\uff0c\u4e00\u822c\u4e0d\u4f7f\u7528 lock tables \u547d\u4ee4\u6765\u63a7\u5236\u5e76\u53d1\uff0c\u6bd5\u7adf\u9501\u4f4f\u6574\u4e2a\u8868\u7684\u5f71\u54cd\u9762\u8fd8\u662f\u592a\u5927\u3002</p>"},{"location":"chap1/5mysql_lock/#2-2-metadata-lock","title":"2-2 \u5143\u6570\u636e\u9501metadata lock","text":"<p>\u53e6\u4e00\u7c7b\u8868\u7ea7\u7684\u9501\u662f MDL\uff08metadata lock)\u3002MDL \u4e0d\u9700\u8981\u663e\u5f0f\u4f7f\u7528\uff0c\u5728\u8bbf\u95ee\u4e00\u4e2a\u8868\u7684\u65f6\u5019\u4f1a\u88ab\u81ea\u52a8\u52a0\u4e0a\u3002</p> <p>MDL \u7684\u4f5c\u7528\u662f\uff0c\u4fdd\u8bc1\u8bfb\u5199\u7684\u6b63\u786e\u6027\u3002\u4f60\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\uff0c\u5982\u679c\u4e00\u4e2a\u67e5\u8be2\u6b63\u5728\u904d\u5386\u4e00\u4e2a\u8868\u4e2d\u7684\u6570\u636e\uff0c\u800c\u6267\u884c\u671f\u95f4\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u5bf9\u8fd9\u4e2a\u8868\u7ed3\u6784\u505a\u53d8\u66f4\uff0c\u5220\u4e86\u4e00\u5217\uff0c\u90a3\u4e48\u67e5\u8be2\u7ebf\u7a0b\u62ff\u5230\u7684\u7ed3\u679c\u8ddf\u8868\u7ed3\u6784\u5bf9\u4e0d\u4e0a\uff0c\u80af\u5b9a\u662f\u4e0d\u884c\u7684\u3002</p> <p>\u5143\u6570\u636e\u9501\u662fserver\u5c42\u7684\u9501\uff0c\u8868\u7ea7\u9501\uff0c\u4e3b\u8981\u7528\u4e8e\u9694\u79bbDML\uff08Data Manipulation Language\uff0c\u6570\u636e\u64cd\u7eb5\u8bed\u8a00\uff0c\u5982select\uff09\u548cDDL\uff08Data Definition Language\uff0c\u6570\u636e\u5b9a\u4e49\u8bed\u8a00\uff0c\u5982\u6539\u8868\u5934\u65b0\u589e\u4e00\u5217\uff09\u64cd\u4f5c\u4e4b\u95f4\u7684\u5e72\u6270\u3002\u6bcf\u6267\u884c\u4e00\u6761DML\u3001DDL\u8bed\u53e5\u65f6\u90fd\u4f1a\u7533\u8bf7MDL\u9501\uff0cDML\u64cd\u4f5c\u9700\u8981MDL\u8bfb\u9501\uff0cDDL\u64cd\u4f5c\u9700\u8981MDL\u5199\u9501\uff08MDL\u52a0\u9501\u8fc7\u7a0b\u662f\u7cfb\u7edf\u81ea\u52a8\u63a7\u5236\uff0c\u65e0\u6cd5\u76f4\u63a5\u5e72\u9884\uff0c\u8bfb\u8bfb\u5171\u4eab\uff0c\u8bfb\u5199\u4e92\u65a5\uff0c\u5199\u5199\u4e92\u65a5\uff09</p> <p>\u5728 MySQL 5.5 \u7248\u672c\u4e2d\u5f15\u5165\u4e86 MDL\uff0c\u5f53\u5bf9\u4e00\u4e2a\u8868\u505a\u589e\u5220\u6539\u67e5\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u52a0 MDL \u8bfb\u9501\uff1b\u5f53\u8981\u5bf9\u8868\u505a\u7ed3\u6784\u53d8\u66f4\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u52a0 MDL \u5199\u9501\u3002</p> <ul> <li>\u52a0\u8bfb\u9501\u5219\u6240\u6709\u7ebf\u7a0b\u53ef\u6b63\u5e38\u8bfb\u5143\u6570\u636e\uff0c\u4e0d\u5f71\u54cd\u589e\u5220\u6539\u67e5\u64cd\u4f5c\uff0c\u53ea\u662f\u4e0d\u80fd\u4fee\u6539\u8868\u7ed3\u6784\uff1b</li> <li> <p>\u52a0\u5199\u9501\u5219\u53ea\u6709\u62e5\u6709\u9501\u7684\u7ebf\u7a0b\u53ef\u4ee5\u8bfb\u5199\u5143\u6570\u636e\uff0c\u4e5f\u5c31\u662f\u4fee\u6539\u8868\u7ed3\u6784\uff0c\u5176\u5b83\u7ebf\u7a0b\u4e0d\u80fd\u6267\u884c\u4efb\u4f55\u64cd\u4f5c\uff0c\u5305\u62ec\u4fee\u6539\u8868\u7ed3\u6784\u4e0e\u589e\u5220\u6539\u67e5\u3002</p> </li> <li> <p>\u8bfb\u9501\u4e4b\u95f4\u4e0d\u4e92\u65a5\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u6709\u591a\u4e2a\u7ebf\u7a0b\u540c\u65f6\u5bf9\u4e00\u5f20\u8868\u589e\u5220\u6539\u67e5\u3002</p> </li> <li>\u8bfb\u5199\u9501\u4e4b\u95f4\u3001\u5199\u9501\u4e4b\u95f4\u662f\u4e92\u65a5\u7684\uff0c\u7528\u6765\u4fdd\u8bc1\u53d8\u66f4\u8868\u7ed3\u6784\u64cd\u4f5c\u7684\u5b89\u5168\u6027\u3002</li> </ul> <p>\u56e0\u6b64\uff0c\u5982\u679c\u6709\u4e24\u4e2a\u7ebf\u7a0b\u8981\u540c\u65f6\u7ed9\u4e00\u4e2a\u8868\u52a0\u5b57\u6bb5\uff0c\u5176\u4e2d\u4e00\u4e2a\u8981\u7b49\u53e6\u4e00\u4e2a\u6267\u884c\u5b8c\u624d\u80fd\u5f00\u59cb\u6267\u884c\u3002</p> <p>\u867d\u7136 MDL \u9501\u662f\u7cfb\u7edf\u9ed8\u8ba4\u4f1a\u52a0\u7684, \u6211\u7ecf\u5e38\u770b\u5230\u6709\u4eba\u6389\u5230\u8fd9\u4e2a\u5751\u91cc\uff1a\u7ed9\u4e00\u4e2a\u5c0f\u8868\u52a0\u4e2a\u5b57\u6bb5\uff0c\u5bfc\u81f4\u6574\u4e2a\u5e93\u6302\u4e86\u3002</p> <p>\u7ed9\u4e00\u4e2a\u8868\u52a0\u5b57\u6bb5\uff0c\u6216\u8005\u4fee\u6539\u5b57\u6bb5\uff0c\u6216\u8005\u52a0\u7d22\u5f15\uff0c\u9700\u8981\u626b\u63cf\u5168\u8868\u7684\u6570\u636e\u3002\u5728\u5bf9\u5927\u8868\u64cd\u4f5c\u7684\u65f6\u5019\uff0c\u4f60\u80af\u5b9a\u4f1a\u7279\u522b\u5c0f\u5fc3\uff0c\u4ee5\u514d\u5bf9\u7ebf\u4e0a\u670d\u52a1\u9020\u6210\u5f71\u54cd\u3002</p> <p>\u800c\u5b9e\u9645\u4e0a\uff0c\u5373\u4f7f\u662f\u5c0f\u8868\uff0c\u64cd\u4f5c\u4e0d\u614e\u4e5f\u4f1a\u51fa\u95ee\u9898\u3002\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u4e0b\u9762\u7684\u64cd\u4f5c\u5e8f\u5217\uff0c\u5047\u8bbe\u8868 t \u662f\u4e00\u4e2a\u5c0f\u8868\u3002</p> <p></p> <ul> <li>session A \u5148\u542f\u52a8\uff0c\u8fd9\u65f6\u5019\u4f1a\u5bf9\u8868 t \u52a0\u4e00\u4e2a MDL \u8bfb\u9501\u3002</li> <li>\u7531\u4e8e session B \u9700\u8981\u7684\u4e5f\u662f MDL \u8bfb\u9501\uff0c\u56e0\u6b64\u53ef\u4ee5\u6b63\u5e38\u6267\u884c</li> <li>\u4e4b\u540e session C \u4f1a\u88ab blocked\uff0c\u662f\u56e0\u4e3a session A \u7684 MDL \u8bfb\u9501\u8fd8\u6ca1\u6709\u91ca\u653e\uff0c\u800c session C \u9700\u8981 MDL \u5199\u9501\uff0c\u56e0\u6b64\u53ea\u80fd\u88ab\u963b\u585e\u3002</li> <li>\u5982\u679c\u53ea\u6709 session C \u81ea\u5df1\u88ab\u963b\u585e\u8fd8\u6ca1\u4ec0\u4e48\u5173\u7cfb\uff0c\u4f46\u662f\u4e4b\u540e\u6240\u6709\u8981\u5728\u8868 t \u4e0a\u65b0\u7533\u8bf7 MDL \u8bfb\u9501\u7684\u8bf7\u6c42\u4e5f\u4f1a\u88ab session C \u963b\u585e\u3002</li> </ul> <p>\u5982\u679c\u67d0\u4e2a\u8868\u4e0a\u7684\u67e5\u8be2\u8bed\u53e5\u9891\u7e41\uff0c\u800c\u4e14\u5ba2\u6237\u7aef\u6709\u91cd\u8bd5\u673a\u5236\uff0c\u4e5f\u5c31\u662f\u8bf4\u8d85\u65f6\u540e\u4f1a\u518d\u8d77\u4e00\u4e2a\u65b0 session \u518d\u8bf7\u6c42\u7684\u8bdd\uff0c\u8fd9\u4e2a\u5e93\u7684\u7ebf\u7a0b\u5f88\u5feb\u5c31\u4f1a\u7206\u6ee1\u3002</p> <p>\u8868\u4e0d\u53ef\u7528\u7684\u539f\u56e0\u662f\u56e0\u4e3a sessionc \u7533\u8bf7\u5199\u9501 \u5e76\u4e14\u5728\u961f\u5217\u5904\u4e8e\u4f18\u5148\uff0c\u5bfc\u81f4 sessionc \u540e\u9762\u7684\u6240\u6709 \u8bfb\u9501 \u8bf7\u6c42\u7533\u8bf7\u90fd\u88ab block \u4e86\u3002\u8fd9\u4e2a\u65f6\u5019\u5ba2\u6237\u7aef\u5982\u679c\u6709\u9891\u7e41\u91cd\u8bd5\u7684\u903b\u8f91\u5c31\u4f1a\u5bfc\u81f4\u4e0d\u505c\u7684\u548c\u6570\u636e\u5e93\u5efa\u7acb\u8fde\u63a5\uff0c\u628a\u8fde\u63a5\u6c60\u6253\u6ee1\u5bfc\u81f4\u5e93\u4e0d\u53ef\u7528\u3002</p> <p>\u4e8b\u52a1\u4e2d\u7684 MDL \u9501\uff0c\u5728\u8bed\u53e5\u6267\u884c\u5f00\u59cb\u65f6\u7533\u8bf7\uff0c\u4f46\u662f\u8bed\u53e5\u7ed3\u675f\u540e\u5e76\u4e0d\u4f1a\u9a6c\u4e0a\u91ca\u653e\uff0c\u800c\u4f1a\u7b49\u5230\u6574\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u540e\u518d\u91ca\u653e\u3002</p>"},{"location":"chap1/5mysql_lock/#2-3","title":"2-3 \u5982\u4f55\u5b89\u5168\u5730\u7ed9\u5c0f\u8868\u52a0\u5b57\u6bb5\uff1f","text":"<ul> <li>\u9996\u5148\u6211\u4eec\u8981\u89e3\u51b3\u957f\u4e8b\u52a1\uff0c\u4e8b\u52a1\u4e0d\u63d0\u4ea4\uff0c\u5c31\u4f1a\u4e00\u76f4\u5360\u7740 MDL \u9501\u3002</li> <li>\u5728 MySQL \u7684 <code>information_schema</code> \u5e93\u7684 <code>innodb_trx</code> \u8868\u4e2d\uff0c\u4f60\u53ef\u4ee5\u67e5\u5230\u5f53\u524d\u6267\u884c\u4e2d\u7684\u4e8b\u52a1\u3002</li> <li>\u5982\u679c\u4f60\u8981\u505a DDL \u53d8\u66f4\u7684\u8868\u521a\u597d\u6709\u957f\u4e8b\u52a1\u5728\u6267\u884c\uff0c\u8981\u8003\u8651\u5148\u6682\u505c DDL\uff0c\u6216\u8005 kill \u6389\u8fd9\u4e2a\u957f\u4e8b\u52a1\u3002</li> </ul>"},{"location":"chap1/5mysql_lock/#2-4","title":"2-4 \u53d8\u66f4\u7684\u8868\u662f\u4e00\u4e2a\u70ed\u70b9\u8868","text":"<p>\u5982\u679c\u4f60\u8981\u53d8\u66f4\u7684\u8868\u662f\u4e00\u4e2a\u70ed\u70b9\u8868\uff0c\u867d\u7136\u6570\u636e\u91cf\u4e0d\u5927\uff0c\u4f46\u662f\u4e0a\u9762\u7684\u8bf7\u6c42\u5f88\u9891\u7e41\uff0c\u800c\u4f60\u4e0d\u5f97\u4e0d\u52a0\u4e2a\u5b57\u6bb5</p> <ul> <li>\u8fd9\u65f6\u5019 kill \u53ef\u80fd\u672a\u5fc5\u7ba1\u7528\uff0c\u56e0\u4e3a\u65b0\u7684\u8bf7\u6c42\u9a6c\u4e0a\u5c31\u6765\u4e86\u3002</li> <li>\u6bd4\u8f83\u7406\u60f3\u7684\u673a\u5236\u662f\uff0c\u5728 <code>alter table</code> \u8bed\u53e5\u91cc\u9762\u8bbe\u5b9a\u7b49\u5f85\u65f6\u95f4\uff0c\u5982\u679c\u5728\u8fd9\u4e2a\u6307\u5b9a\u7684\u7b49\u5f85\u65f6\u95f4\u91cc\u9762\u80fd\u591f\u62ff\u5230 <code>MD</code>L \u5199\u9501\u6700\u597d\uff0c\u62ff\u4e0d\u5230\u4e5f\u4e0d\u8981\u963b\u585e\u540e\u9762\u7684\u4e1a\u52a1\u8bed\u53e5\uff0c\u5148\u653e\u5f03\u3002</li> <li>\u4e4b\u540e\u5f00\u53d1\u4eba\u5458\u6216\u8005 DBA \u518d\u901a\u8fc7\u91cd\u8bd5\u547d\u4ee4\u91cd\u590d\u8fd9\u4e2a\u8fc7\u7a0b\u3002</li> </ul> <p>\u5982\u679c\u8981\u7ed9\u70ed\u70b9\u6570\u636e\u505a\u8868\u7ed3\u6784\u53d8\u66f4\u8981\u5e26\u4e0a\u8d85\u65f6\u65f6\u95f4 \u62ff\u4e0d\u5230\u5199\u9501\u5c31\u653e\u5f03</p> <p>MariaDB \u5df2\u7ecf\u5408\u5e76\u4e86 AliSQL \u7684\u8fd9\u4e2a\u529f\u80fd\uff0c\u6240\u4ee5\u8fd9\u4e24\u4e2a\u5f00\u6e90\u5206\u652f\u76ee\u524d\u90fd\u652f\u6301 DDL NOWAIT/WAIT n \u8fd9\u4e2a\u8bed\u6cd5\u3002</p> <pre><code>ALTER TABLE tbl_name NOWAIT add column ...\nALTER TABLE tbl_name WAIT N add column ... \n</code></pre>"},{"location":"chap1/5mysql_lock/#3","title":"3\u3001\u600e\u4e48\u51cf\u5c11\u884c\u9501\u5bf9\u6027\u80fd\u7684\u5f71\u54cd\uff1f","text":"<p>MySQL \u7684\u884c\u9501\u662f\u5728\u5f15\u64ce\u5c42\u7531\u5404\u4e2a\u5f15\u64ce\u81ea\u5df1\u5b9e\u73b0\u7684\u3002\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684\u5f15\u64ce\u90fd\u652f\u6301\u884c\u9501\uff0c\u6bd4\u5982 MyISAM \u5f15\u64ce\u5c31\u4e0d\u652f\u6301\u884c\u9501\u3002</p> <p>\u4e0d\u652f\u6301\u884c\u9501\u610f\u5473\u7740\u5e76\u53d1\u63a7\u5236\u53ea\u80fd\u4f7f\u7528\u8868\u9501\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u5f15\u64ce\u7684\u8868\uff0c\u540c\u4e00\u5f20\u8868\u4e0a\u4efb\u4f55\u65f6\u523b\u53ea\u80fd\u6709\u4e00\u4e2a\u66f4\u65b0\u5728\u6267\u884c\uff0c\u8fd9\u5c31\u4f1a\u5f71\u54cd\u5230\u4e1a\u52a1\u5e76\u53d1\u5ea6</p> <p>InnoDB \u662f\u652f\u6301\u884c\u9501\u7684\uff0c\u8fd9\u4e5f\u662f MyISAM \u88ab InnoDB \u66ff\u4ee3\u7684\u91cd\u8981\u539f\u56e0\u4e4b\u4e00\u3002</p> <p>\u6240\u4ee5 MyISAM \u4e0d\u9002\u5408\u9ad8\u5e76\u53d1\u7684\u573a\u666f\u3002 \u5b83\u66f4\u9002\u5408\u8bfb\u591a\u5199\u5c11\u7684\u573a\u666f\u3002</p> <p>\u884c\u9501\u5c31\u662f\u9488\u5bf9\u6570\u636e\u8868\u4e2d\u884c\u8bb0\u5f55\u7684\u9501\u3002\u8fd9\u5f88\u597d\u7406\u89e3\uff0c\u6bd4\u5982\u4e8b\u52a1 A \u66f4\u65b0\u4e86\u4e00\u884c\uff0c\u800c\u8fd9\u65f6\u5019\u4e8b\u52a1 B \u4e5f\u8981\u66f4\u65b0\u540c\u4e00\u884c\uff0c\u5219\u5fc5\u987b\u7b49\u4e8b\u52a1 A \u7684\u64cd\u4f5c\u5b8c\u6210\u540e\u624d\u80fd\u8fdb\u884c\u66f4\u65b0(A commit)\u3002</p>"},{"location":"chap1/5mysql_lock/#4","title":"4\u3001\u4e24\u9636\u6bb5\u9501","text":"<p>\u4e8b\u52a1 B \u7684 update \u8bed\u53e5\u6267\u884c\u65f6\u4f1a\u662f\u4ec0\u4e48\u73b0\u8c61\u5462\uff1f\u5047\u8bbe\u5b57\u6bb5 id \u662f\u8868 t \u7684\u4e3b\u952e\u3002</p> <p></p> <p>\u8fd9\u4e2a\u95ee\u9898\u7684\u7ed3\u8bba\u53d6\u51b3\u4e8e\u4e8b\u52a1 A \u5728\u6267\u884c\u5b8c\u4e24\u6761 update \u8bed\u53e5\u540e\uff0c\u6301\u6709\u54ea\u4e9b\u9501\uff0c\u4ee5\u53ca\u5728\u4ec0\u4e48\u65f6\u5019\u91ca\u653e</p> <p>\u5b9e\u9645\u4e0a\u4e8b\u52a1 B \u7684 update \u8bed\u53e5\u4f1a\u88ab\u963b\u585e\uff0c\u76f4\u5230\u4e8b\u52a1 A \u6267\u884c commit \u4e4b\u540e\uff0c\u4e8b\u52a1 B \u624d\u80fd\u7ee7\u7eed\u6267\u884c\u3002</p> <p>\u4e8b\u52a1 A \u6301\u6709\u7684\u4e24\u4e2a\u8bb0\u5f55\u7684\u884c\u9501\uff0c\u90fd\u662f\u5728 commit \u7684\u65f6\u5019\u624d\u91ca\u653e\u7684\u3002</p> <p>\u4e24\u9636\u6bb5\u9501\uff0c\u9501\u7684\u6dfb\u52a0\u4e0e\u91ca\u653e\u5206\u5230\u4e24\u4e2a\u9636\u6bb5\u8fdb\u884c\uff0c\u4e4b\u95f4\u4e0d\u5141\u8bb8\u4ea4\u53c9\u52a0\u9501\u548c\u91ca\u653e\u9501\u3002 \u4e5f\u5c31\u662f\u5728\u4e8b\u52a1\u5f00\u59cb\u6267\u884c\u540e\u4e3a\u6d89\u53ca\u5230\u7684\u884c\u6309\u7167\u9700\u8981\u52a0\u9501\uff0c\u4f46\u6267\u884c\u5b8c\u4e0d\u4f1a\u9a6c\u4e0a\u91ca\u653e\uff0c\u800c\u662f\u5728\u4e8b\u52a1\u7ed3\u675f\u65f6\u518d\u7edf\u4e00\u91ca\u653e\u4ed6\u4eec\u3002</p> <p>\u5efa\u8bae</p> <p>\u5982\u679c\u4f60\u7684\u4e8b\u52a1\u4e2d\u9700\u8981\u9501\u591a\u4e2a\u884c\uff0c\u8981\u628a\u6700\u53ef\u80fd\u9020\u6210\u9501\u51b2\u7a81\u3001\u6700\u53ef\u80fd\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u9501\u5c3d\u91cf\u5f80\u540e\u653e\u3002</p> <p>\u5047\u8bbe\u4f60\u8d1f\u8d23\u5b9e\u73b0\u4e00\u4e2a\u7535\u5f71\u7968\u5728\u7ebf\u4ea4\u6613\u4e1a\u52a1\uff0c\u987e\u5ba2 A \u8981\u5728\u5f71\u9662 B \u8d2d\u4e70\u7535\u5f71\u7968\u3002\u6211\u4eec\u7b80\u5316\u4e00\u70b9\uff0c\u8fd9\u4e2a\u4e1a\u52a1\u9700\u8981\u6d89\u53ca\u5230\u4ee5\u4e0b\u64cd\u4f5c\uff1a</p> <ol> <li>\u4ece\u987e\u5ba2 A \u8d26\u6237\u4f59\u989d\u4e2d\u6263\u9664\u7535\u5f71\u7968\u4ef7\uff1b</li> <li>\u7ed9\u5f71\u9662 B \u7684\u8d26\u6237\u4f59\u989d\u589e\u52a0\u8fd9\u5f20\u7535\u5f71\u7968\u4ef7\uff1b</li> <li>\u8bb0\u5f55\u4e00\u6761\u4ea4\u6613\u65e5\u5fd7\u3002</li> </ol> <p>\u8981\u5b8c\u6210\u8fd9\u4e2a\u4ea4\u6613\uff0c\u6211\u4eec\u9700\u8981 update \u4e24\u6761\u8bb0\u5f55\uff0c\u5e76 insert \u4e00\u6761\u8bb0\u5f55\u3002\u5f53\u7136\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u4ea4\u6613\u7684\u539f\u5b50\u6027\uff0c\u6211\u4eec\u8981\u628a\u8fd9\u4e09\u4e2a\u64cd\u4f5c\u653e\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u3002</p> <p>\u8bd5\u60f3\u5982\u679c\u540c\u65f6\u6709\u53e6\u5916\u4e00\u4e2a\u987e\u5ba2 C \u8981\u5728\u5f71\u9662 B \u4e70\u7968\uff0c\u90a3\u4e48\u8fd9\u4e24\u4e2a\u4e8b\u52a1\u51b2\u7a81\u7684\u90e8\u5206\u5c31\u662f\u8bed\u53e5 2 \u4e86\u3002\u56e0\u4e3a\u5b83\u4eec\u8981\u66f4\u65b0\u540c\u4e00\u4e2a\u5f71\u9662\u8d26\u6237\u7684\u4f59\u989d\uff0c\u9700\u8981\u4fee\u6539\u540c\u4e00\u884c\u6570\u636e\u3002</p> <p>\u6839\u636e\u4e24\u9636\u6bb5\u9501\u534f\u8bae\uff0c\u4e0d\u8bba\u4f60\u600e\u6837\u5b89\u6392\u8bed\u53e5\u987a\u5e8f\uff0c\u6240\u6709\u7684\u64cd\u4f5c\u9700\u8981\u7684\u884c\u9501\u90fd\u662f\u5728\u4e8b\u52a1\u63d0\u4ea4\u7684\u65f6\u5019\u624d\u91ca\u653e\u7684\u3002</p> <ul> <li>\u6309\u7167 3\u30011\u30012 \u8fd9\u6837\u7684\u987a\u5e8f\uff0c\u90a3\u4e48\u5f71\u9662\u8d26\u6237\u4f59\u989d\u8fd9\u4e00\u884c\u7684\u9501\u65f6\u95f4\u5c31\u6700\u5c11\u3002</li> <li>\u8fd9\u5c31\u6700\u5927\u7a0b\u5ea6\u5730\u51cf\u5c11\u4e86\u4e8b\u52a1\u4e4b\u95f4\u7684\u9501\u7b49\u5f85\uff0c\u63d0\u5347\u4e86\u5e76\u53d1\u5ea6\u3002</li> </ul>"},{"location":"chap1/5mysql_lock/#5","title":"5\u3001\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b","text":"<p>\u5f53\u5e76\u53d1\u7cfb\u7edf\u4e2d\u4e0d\u540c\u7ebf\u7a0b\u51fa\u73b0\u5faa\u73af\u8d44\u6e90\u4f9d\u8d56\uff0c\u6d89\u53ca\u7684\u7ebf\u7a0b\u90fd\u5728\u7b49\u5f85\u522b\u7684\u7ebf\u7a0b\u91ca\u653e\u8d44\u6e90\u65f6\uff0c\u5c31\u4f1a\u5bfc\u81f4\u8fd9\u51e0\u4e2a\u7ebf\u7a0b\u90fd\u8fdb\u5165\u65e0\u9650\u7b49\u5f85\u7684\u72b6\u6001\uff0c\u79f0\u4e3a\u6b7b\u9501\u3002</p> <p>\u5e94\u8be5\u4e5f\u6709\u53ef\u80fd\u51fa\u73b0\u591a\u4e2a\u4e8b\u52a1\u4e92\u76f8\u7b49\u5f85\u7684\u60c5\u51b5\uff0c\u5982 A \u7b49 B\uff0cB \u7b49 C\uff0cC \u7b49 A\u3002</p> <p></p> <ul> <li>\u4e8b\u52a1 A \u5728\u7b49\u5f85\u4e8b\u52a1 B \u91ca\u653e id=2 \u7684\u884c\u9501\uff0c\u800c\u4e8b\u52a1 B \u5728\u7b49\u5f85\u4e8b\u52a1 A \u91ca\u653e id=1 \u7684\u884c\u9501\u3002 </li> <li>\u4e8b\u52a1 A \u548c\u4e8b\u52a1 B \u5728\u4e92\u76f8\u7b49\u5f85\u5bf9\u65b9\u7684\u8d44\u6e90\u91ca\u653e\uff0c\u5c31\u662f\u8fdb\u5165\u4e86\u6b7b\u9501\u72b6\u6001\u3002</li> </ul> <p>\u5f53\u51fa\u73b0\u6b7b\u9501\u4ee5\u540e\uff0c\u6709\u4e24\u79cd\u7b56\u7565\uff1a</p> <ul> <li>\u4e00\u79cd\u7b56\u7565\u662f\uff0c\u76f4\u63a5\u8fdb\u5165\u7b49\u5f85\uff0c\u76f4\u5230\u8d85\u65f6\u3002\u8fd9\u4e2a\u8d85\u65f6\u65f6\u95f4\u53ef\u4ee5\u901a\u8fc7\u53c2\u6570 <code>innodb_lock_wait_timeout</code> \u6765\u8bbe\u7f6e\u3002</li> <li>\u53e6\u4e00\u79cd\u7b56\u7565\u662f\uff0c\u53d1\u8d77\u6b7b\u9501\u68c0\u6d4b\uff0c\u53d1\u73b0\u6b7b\u9501\u540e\uff0c\u4e3b\u52a8\u56de\u6eda\u6b7b\u9501\u94fe\u6761\u4e2d\u7684\u67d0\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8ba9\u5176\u4ed6\u4e8b\u52a1\u5f97\u4ee5\u7ee7\u7eed\u6267\u884c\u3002\u5c06\u53c2\u6570 <code>innodb_deadlock_detect</code> \u8bbe\u7f6e\u4e3a <code>on</code>\uff0c\u8868\u793a\u5f00\u542f\u8fd9\u4e2a\u903b\u8f91\u3002</li> </ul>"},{"location":"chap1/5mysql_lock/#5-1-innodb_deadlock_detect","title":"5-1 <code>innodb_deadlock_detect</code>","text":"<p>\u5728 InnoDB \u4e2d\uff0c<code>innodb_lock_wait_timeout</code> \u7684\u9ed8\u8ba4\u503c\u662f 50s\uff0c\u610f\u5473\u7740\u5982\u679c\u91c7\u7528\u7b2c\u4e00\u4e2a\u7b56\u7565\uff0c\u5f53\u51fa\u73b0\u6b7b\u9501\u4ee5\u540e\uff0c\u7b2c\u4e00\u4e2a\u88ab\u9501\u4f4f\u7684\u7ebf\u7a0b\u8981\u8fc7 50s \u624d\u4f1a\u8d85\u65f6\u9000\u51fa\uff0c\u7136\u540e\u5176\u4ed6\u7ebf\u7a0b\u624d\u6709\u53ef\u80fd\u7ee7\u7eed\u6267\u884c\u3002\u5bf9\u4e8e\u5728\u7ebf\u670d\u52a1\u6765\u8bf4\uff0c\u8fd9\u4e2a\u7b49\u5f85\u65f6\u95f4\u5f80\u5f80\u662f\u65e0\u6cd5\u63a5\u53d7\u7684\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u4eec\u53c8\u4e0d\u53ef\u80fd\u76f4\u63a5\u628a\u8fd9\u4e2a\u65f6\u95f4\u8bbe\u7f6e\u6210\u4e00\u4e2a\u5f88\u5c0f\u7684\u503c\uff0c\u6bd4\u5982 1s\u3002\u8fd9\u6837\u5f53\u51fa\u73b0\u6b7b\u9501\u7684\u65f6\u5019\uff0c\u786e\u5b9e\u5f88\u5feb\u5c31\u53ef\u4ee5\u89e3\u5f00\uff0c\u4f46\u5982\u679c\u4e0d\u662f\u6b7b\u9501\uff0c\u800c\u662f\u7b80\u5355\u7684\u9501\u7b49\u5f85\u5462\uff1f</p> <p>\u6240\u4ee5\uff0c\u8d85\u65f6\u65f6\u95f4\u8bbe\u7f6e\u592a\u77ed\u7684\u8bdd\uff0c\u4f1a\u51fa\u73b0\u5f88\u591a\u8bef\u4f24\u3002</p>"},{"location":"chap1/5mysql_lock/#5-2","title":"5-2 \u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b","text":"<p>\u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b\uff0c\u800c\u4e14 <code>innodb_deadlock_detec</code>t \u7684\u9ed8\u8ba4\u503c\u672c\u8eab\u5c31\u662f on\u3002\u4e3b\u52a8\u6b7b\u9501\u68c0\u6d4b\u5728\u53d1\u751f\u6b7b\u9501\u7684\u65f6\u5019\uff0c\u662f\u80fd\u591f\u5feb\u901f\u53d1\u73b0\u5e76\u8fdb\u884c\u5904\u7406\u7684\uff0c\u4f46\u662f\u5b83\u4e5f\u662f\u6709\u989d\u5916\u8d1f\u62c5\u7684\u3002</p> <p>\u6bcf\u5f53\u4e00\u4e2a\u4e8b\u52a1\u88ab\u9501\u7684\u65f6\u5019\uff0c\u5c31\u8981\u770b\u770b\u5b83\u6240\u4f9d\u8d56\u7684\u7ebf\u7a0b\u6709\u6ca1\u6709\u88ab\u522b\u4eba\u9501\u4f4f\uff0c\u5982\u6b64\u5faa\u73af\uff0c\u6700\u540e\u5224\u65ad\u662f\u5426\u51fa\u73b0\u4e86\u5faa\u73af\u7b49\u5f85\uff0c\u4e5f\u5c31\u662f\u6b7b\u9501</p> <p>\u90a3\u5982\u679c\u662f\u6211\u4eec\u4e0a\u9762\u8bf4\u5230\u7684\u6240\u6709\u4e8b\u52a1\u90fd\u8981\u66f4\u65b0\u540c\u4e00\u884c\u7684\u573a\u666f\u5462\uff1f</p> <p>\u6bcf\u4e2a\u65b0\u6765\u7684\u88ab\u5835\u4f4f\u7684\u7ebf\u7a0b\uff0c\u90fd\u8981\u5224\u65ad\u4f1a\u4e0d\u4f1a\u7531\u4e8e\u81ea\u5df1\u7684\u52a0\u5165\u5bfc\u81f4\u4e86\u6b7b\u9501\uff0c\u8fd9\u662f\u4e00\u4e2a\u65f6\u95f4\u590d\u6742\u5ea6\u662f O(n) \u7684\u64cd\u4f5c\u3002\u5047\u8bbe\u6709 1000 \u4e2a\u5e76\u53d1\u7ebf\u7a0b\u8981\u540c\u65f6\u66f4\u65b0\u540c\u4e00\u884c\uff0c\u90a3\u4e48\u6b7b\u9501\u68c0\u6d4b\u64cd\u4f5c\u5c31\u662f 100 \u4e07\u8fd9\u4e2a\u91cf\u7ea7\u7684\u3002\u867d\u7136\u6700\u7ec8\u68c0\u6d4b\u7684\u7ed3\u679c\u662f\u6ca1\u6709\u6b7b\u9501\uff0c\u4f46\u662f\u8fd9\u671f\u95f4\u8981\u6d88\u8017\u5927\u91cf\u7684 CPU \u8d44\u6e90\u3002\u56e0\u6b64\uff0c\u4f60\u5c31\u4f1a\u770b\u5230 CPU \u5229\u7528\u7387\u5f88\u9ad8\uff0c\u4f46\u662f\u6bcf\u79d2\u5374\u6267\u884c\u4e0d\u4e86\u51e0\u4e2a\u4e8b\u52a1\u3002</p> <p>\u6b7b\u9501\u68c0\u6d4b\u8981\u8017\u8d39\u5927\u91cf\u7684 CPU \u8d44\u6e90\u3002</p>"},{"location":"chap1/5mysql_lock/#5-3","title":"5-3 \u5982\u4f55\u89e3\u51b3\u6b7b\u9501\u95ee\u9898","text":"<ul> <li> <p>\u4e00\u79cd\u5934\u75db\u533b\u5934\u7684\u65b9\u6cd5\uff0c\u5c31\u662f\u5982\u679c\u4f60\u80fd\u786e\u4fdd\u8fd9\u4e2a\u4e1a\u52a1\u4e00\u5b9a\u4e0d\u4f1a\u51fa\u73b0\u6b7b\u9501\uff0c\u53ef\u4ee5\u4e34\u65f6\u628a\u6b7b\u9501\u68c0\u6d4b\u5173\u6389\u3002</p> <ul> <li>\u79cd\u64cd\u4f5c\u672c\u8eab\u5e26\u6709\u4e00\u5b9a\u7684\u98ce\u9669\uff0c\u56e0\u4e3a\u4e1a\u52a1\u8bbe\u8ba1\u7684\u65f6\u5019\u4e00\u822c\u4e0d\u4f1a\u628a\u6b7b\u9501\u5f53\u505a\u4e00\u4e2a\u4e25\u91cd\u9519\u8bef\uff0c\u6bd5\u7adf\u51fa\u73b0\u6b7b\u9501\u4e86\uff0c\u5c31\u56de\u6eda\uff0c\u7136\u540e\u901a\u8fc7\u4e1a\u52a1\u91cd\u8bd5\u4e00\u822c\u5c31\u6ca1\u95ee\u9898\u4e86\uff0c\u8fd9\u662f\u4e1a\u52a1\u65e0\u635f\u7684\u3002\u800c\u5173\u6389\u6b7b\u9501\u68c0\u6d4b\u610f\u5473\u7740\u53ef\u80fd\u4f1a\u51fa\u73b0\u5927\u91cf\u7684\u8d85\u65f6\uff0c\u8fd9\u662f\u4e1a\u52a1\u6709\u635f\u7684\u3002</li> </ul> </li> <li> <p>\u53e6\u4e00\u4e2a\u601d\u8def\u662f\u63a7\u5236\u5e76\u53d1\u5ea6 </p> <ul> <li>\u4f60\u4f1a\u53d1\u73b0\u5982\u679c\u5e76\u53d1\u80fd\u591f\u63a7\u5236\u4f4f\uff0c\u6bd4\u5982\u540c\u4e00\u884c\u540c\u65f6\u6700\u591a\u53ea\u6709 10 \u4e2a\u7ebf\u7a0b\u5728\u66f4\u65b0\uff0c\u90a3\u4e48\u6b7b\u9501\u68c0\u6d4b\u7684\u6210\u672c\u5f88\u4f4e\uff0c\u5c31\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u4e2a\u95ee\u9898\u3002</li> <li>\u3002\u4e00\u4e2a\u76f4\u63a5\u7684\u60f3\u6cd5\u5c31\u662f\uff0c\u5728\u5ba2\u6237\u7aef\u505a\u5e76\u53d1\u63a7\u5236\u3002\u4f46\u662f\uff0c\u4f60\u4f1a\u5f88\u5feb\u53d1\u73b0\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u592a\u53ef\u884c\uff0c\u56e0\u4e3a\u5ba2\u6237\u7aef\u5f88\u591a</li> <li>\u8fd9\u4e2a\u5e76\u53d1\u63a7\u5236\u8981\u505a\u5728\u6570\u636e\u5e93\u670d\u52a1\u7aef\u3002\u5982\u679c\u4f60\u6709\u4e2d\u95f4\u4ef6\uff0c\u53ef\u4ee5\u8003\u8651\u5728\u4e2d\u95f4\u4ef6\u5b9e\u73b0 </li> <li>\u4f60\u7684\u56e2\u961f\u6709\u80fd\u4fee\u6539 MySQL \u6e90\u7801\u7684\u4eba\uff0c\u4e5f\u53ef\u4ee5\u505a\u5728 MySQL \u91cc\u9762</li> </ul> </li> <li> <p>\u8bbe\u8ba1\u4e0a\u4f18\u5316\u8fd9\u4e2a\u95ee\u9898</p> <ul> <li>\u5c06\u4e00\u884c\u6539\u6210\u903b\u8f91\u4e0a\u7684\u591a\u884c\u6765\u51cf\u5c11\u9501\u51b2\u7a81\u3002</li> </ul> </li> </ul> <p>\u8fd8\u662f\u4ee5\u5f71\u9662\u8d26\u6237\u4e3a\u4f8b\uff0c\u53ef\u4ee5\u8003\u8651\u653e\u5728\u591a\u6761\u8bb0\u5f55\u4e0a\uff0c\u6bd4\u5982 10 \u4e2a\u8bb0\u5f55\uff0c\u5f71\u9662\u7684\u8d26\u6237\u603b\u989d\u7b49\u4e8e\u8fd9 10 \u4e2a\u8bb0\u5f55\u7684\u503c\u7684\u603b\u548c\u3002\u8fd9\u6837\u6bcf\u6b21\u8981\u7ed9\u5f71\u9662\u8d26\u6237\u52a0\u91d1\u989d\u7684\u65f6\u5019\uff0c\u968f\u673a\u9009\u5176\u4e2d\u4e00\u6761\u8bb0\u5f55\u6765\u52a0\u3002\u8fd9\u6837\u6bcf\u6b21\u51b2\u7a81\u6982\u7387\u53d8\u6210\u539f\u6765\u7684 1/10\uff0c\u53ef\u4ee5\u51cf\u5c11\u9501\u7b49\u5f85\u4e2a\u6570\uff0c\u4e5f\u5c31\u51cf\u5c11\u4e86\u6b7b\u9501\u68c0\u6d4b\u7684 CPU \u6d88\u8017\u3002</p>"},{"location":"chap1/5mysql_lock/#6","title":"6\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ol> <li>\u5168\u5c40\u9501\u4e3b\u8981\u7528\u5728\u903b\u8f91\u5907\u4efd\u8fc7\u7a0b\u4e2d\u3002\u5bf9\u4e8e\u5168\u90e8\u662f InnoDB \u5f15\u64ce\u7684\u5e93\uff0c\u6211\u5efa\u8bae\u4f60\u9009\u62e9\u4f7f\u7528<code>\u2013single-transaction</code> \u53c2\u6570\uff0c</li> <li>\u8868\u9501\u4e00\u822c\u662f\u5728\u6570\u636e\u5e93\u5f15\u64ce\u4e0d\u652f\u6301\u884c\u9501\u7684\u65f6\u5019\u624d\u4f1a\u88ab\u7528\u5230\u7684\u3002<ul> <li>\u8868\u9501\u4e00\u822c\u662f\u6570\u636e\u5e93\u5f15\u64ce\u4e0d\u652f\u6301\u884c\u9501\u7684\u65f6\u5019\u624d\u4f1a\u88ab\u7528\u5230\u3002 </li> </ul> </li> <li>\u5e94\u7528\u7a0b\u5e8f\u91cc\u6709 lock tables \u8fd9\u6837\u7684\u8bed\u53e5\uff0c\u4f60\u9700\u8981\u8ffd\u67e5\u4e00\u4e0b\uff0c\u6bd4\u8f83\u53ef\u80fd\u7684\u60c5\u51b5\u662f<ul> <li>\u8981\u4e48\u662f\u4f60\u7684\u7cfb\u7edf\u73b0\u5728\u8fd8\u5728\u7528 MyISAM \u8fd9\u7c7b\u4e0d\u652f\u6301\u4e8b\u52a1\u7684\u5f15\u64ce\uff0c\u90a3\u8981\u5b89\u6392\u5347\u7ea7\u6362\u5f15\u64ce\uff1b</li> <li>\u8981\u4e48\u662f\u4f60\u7684\u5f15\u64ce\u5347\u7ea7\u4e86\uff0c\u4f46\u662f\u4ee3\u7801\u8fd8\u6ca1\u5347\u7ea7\u3002\u6211\u89c1\u8fc7\u8fd9\u6837\u7684\u60c5\u51b5\uff0c\u6700\u540e\u4e1a\u52a1\u5f00\u53d1\u5c31\u662f\u628a <code>lock tables</code> \u548c <code>unlock tables</code> \u6539\u6210 <code>begin</code> \u548c <code>commit</code>\uff0c\u95ee\u9898\u5c31\u89e3\u51b3\u4e86 </li> </ul> </li> <li>MDL \u4f1a\u76f4\u5230\u4e8b\u52a1\u63d0\u4ea4\u624d\u91ca\u653e\uff0c\u5728\u505a\u8868\u7ed3\u6784\u53d8\u66f4\u7684\u65f6\u5019\uff0c\u4f60\u4e00\u5b9a\u8981\u5c0f\u5fc3\u4e0d\u8981\u5bfc\u81f4\u9501\u4f4f\u7ebf\u4e0a\u67e5\u8be2\u548c\u66f4\u65b0\u3002</li> <li>\u5982\u679c\u4f60\u7684\u4e8b\u52a1\u4e2d\u9700\u8981\u9501\u591a\u4e2a\u884c\uff0c\u8981\u628a\u6700\u53ef\u80fd\u9020\u6210\u9501\u51b2\u7a81\u3001\u6700\u53ef\u80fd\u5f71\u54cd\u5e76\u53d1\u5ea6\u7684\u9501\u7684\u7533\u8bf7\u65f6\u673a\u5c3d\u91cf\u5f80\u540e\u653e\u3002</li> <li>\u8c03\u6574\u8bed\u53e5\u987a\u5e8f\u5e76\u4e0d\u80fd\u5b8c\u5168\u907f\u514d\u6b7b\u9501\u3002\u6240\u4ee5\u6211\u4eec\u5f15\u5165\u4e86\u6b7b\u9501\u548c\u6b7b\u9501\u68c0\u6d4b\u7684\u6982\u5ff5\uff0c\u4ee5\u53ca\u63d0\u4f9b\u4e86\u4e09\u4e2a\u65b9\u6848\uff0c\u6765\u51cf\u5c11\u6b7b\u9501\u5bf9\u6570\u636e\u5e93\u7684\u5f71\u54cd\u3002\u51cf\u5c11\u6b7b\u9501\u7684\u4e3b\u8981\u65b9\u5411\uff0c\u5c31\u662f\u63a7\u5236\u8bbf\u95ee\u76f8\u540c\u8d44\u6e90\u7684\u5e76\u53d1\u4e8b\u52a1\u91cf\u3002</li> </ol>"},{"location":"chap1/5mysql_lock/#7","title":"7\u3001\u672c\u8282\u63d0\u95ee","text":"<p>1.\u5907\u4efd\u4e00\u822c\u90fd\u4f1a\u5728\u5907\u5e93\u4e0a\u6267\u884c\uff0c\u4f60\u5728\u7528<code>\u2013single-transaction</code> \u65b9\u6cd5\u505a\u903b\u8f91\u5907\u4efd\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5982\u679c\u4e3b\u5e93\u4e0a\u7684\u4e00\u4e2a\u5c0f\u8868\u505a\u4e86\u4e00\u4e2a DDL\uff0c\u6bd4\u5982\u7ed9\u4e00\u4e2a\u8868\u4e0a\u52a0\u4e86\u4e00\u5217\u3002\u8fd9\u65f6\u5019\uff0c\u4ece\u5907\u5e93\u4e0a\u4f1a\u770b\u5230\u4ec0\u4e48\u73b0\u8c61\u5462\uff1f</p> <p>\u5047\u8bbe\u8fd9\u4e2a DDL \u662f\u9488\u5bf9\u8868 t1 \u7684\uff0c \u8fd9\u91cc\u6211\u628a\u5907\u4efd\u8fc7\u7a0b\u4e2d\u51e0\u4e2a\u5173\u952e\u7684\u8bed\u53e5\u5217\u51fa\u6765\uff1a</p> <pre><code>\nQ1:SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;\nQ2:START TRANSACTION  WITH CONSISTENT SNAPSHOT\uff1b\n/* other tables */\nQ3:SAVEPOINT sp;\n/* \u65f6\u523b 1 */\nQ4:show create table `t1`;\n/* \u65f6\u523b 2 */\nQ5:SELECT * FROM `t1`;\n/* \u65f6\u523b 3 */\nQ6:ROLLBACK TO SAVEPOINT sp;\n/* \u65f6\u523b 4 */\n/* other tables */\n</code></pre> <p>\u5728\u5907\u4efd\u5f00\u59cb\u7684\u65f6\u5019\uff0c\u4e3a\u4e86\u786e\u4fdd RR\uff08\u53ef\u91cd\u590d\u8bfb\uff09\u9694\u79bb\u7ea7\u522b\uff0c\u518d\u8bbe\u7f6e\u4e00\u6b21 RR \u9694\u79bb\u7ea7\u522b (Q1);</p> <p>\u542f\u52a8\u4e8b\u52a1\uff0c\u8fd9\u91cc\u7528 <code>WITH CONSISTENT SNAPSHOT</code> \u786e\u4fdd\u8fd9\u4e2a\u8bed\u53e5\u6267\u884c\u5b8c\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u4e00\u81f4\u6027\u89c6\u56fe\uff08Q2)\uff1b</p> <p>\u8bbe\u7f6e\u4e00\u4e2a\u4fdd\u5b58\u70b9\uff0c\u8fd9\u4e2a\u5f88\u91cd\u8981\uff08Q3\uff09\uff1b</p> <p>show create \u662f\u4e3a\u4e86\u62ff\u5230\u8868\u7ed3\u6784 (Q4)\uff0c\u7136\u540e\u6b63\u5f0f\u5bfc\u6570\u636e \uff08Q5\uff09\uff0c\u56de\u6eda\u5230 SAVEPOINT sp\uff0c\u5728\u8fd9\u91cc\u7684\u4f5c\u7528\u662f\u91ca\u653e t1 \u7684 MDL \u9501 \uff08Q6\uff09\u3002\u5f53\u7136\u8fd9\u90e8\u5206\u5c5e\u4e8e\u201c\u8d85\u7eb2\u201d\uff0c\u4e0a\u6587\u6b63\u6587\u91cc\u9762\u90fd\u6ca1\u63d0\u5230\u3002</p> <p>DDL \u4ece\u4e3b\u5e93\u4f20\u8fc7\u6765\u7684\u65f6\u95f4\u6309\u7167\u6548\u679c\u4e0d\u540c\uff0c\u6211\u6253\u4e86\u56db\u4e2a\u65f6\u523b\u3002\u9898\u76ee\u8bbe\u5b9a\u4e3a\u5c0f\u8868\uff0c\u6211\u4eec\u5047\u5b9a\u5230\u8fbe\u540e\uff0c\u5982\u679c\u5f00\u59cb\u6267\u884c\uff0c\u5219\u5f88\u5feb\u80fd\u591f\u6267\u884c\u5b8c\u6210\u3002</p> <p>\u53c2\u8003\u7b54\u6848\u5982\u4e0b\uff1a</p> <ol> <li>\u5982\u679c\u5728 Q4 \u8bed\u53e5\u6267\u884c\u4e4b\u524d\u5230\u8fbe\uff0c\u73b0\u8c61\uff1a\u6ca1\u6709\u5f71\u54cd\uff0c\u5907\u4efd\u62ff\u5230\u7684\u662f DDL \u540e\u7684\u8868\u7ed3\u6784\u3002</li> <li>\u5982\u679c\u5728\u201c\u65f6\u523b 2\u201d\u5230\u8fbe\uff0c\u5219\u8868\u7ed3\u6784\u88ab\u6539\u8fc7\uff0cQ5 \u6267\u884c\u7684\u65f6\u5019\uff0c\u62a5 <code>Table definition has changed, please retry transaction</code>\uff0c\u73b0\u8c61\uff1a<code>mysqldump</code> \u7ec8\u6b62\uff1b</li> <li>\u5982\u679c\u5728\u201c\u65f6\u523b 2\u201d\u548c\u201c\u65f6\u523b 3\u201d\u4e4b\u95f4\u5230\u8fbe\uff0cmysqldump \u5360\u7740 t1 \u7684 MDL \u8bfb\u9501\uff0cbinlog \u88ab\u963b\u585e\uff0c\u73b0\u8c61\uff1a\u4e3b\u4ece\u5ef6\u8fdf\uff0c\u76f4\u5230 Q6 \u6267\u884c\u5b8c\u6210\u3002</li> <li>\u4ece\u201c\u65f6\u523b 4\u201d\u5f00\u59cb\uff0cmysqldump \u91ca\u653e\u4e86 MDL \u8bfb\u9501\uff0c\u73b0\u8c61\uff1a\u6ca1\u6709\u5f71\u54cd\uff0c\u5907\u4efd\u62ff\u5230\u7684\u662f DDL \u524d\u7684\u8868\u7ed3\u6784\u3002</li> </ol> <p>2.\u5982\u679c\u4f60\u8981\u5220\u9664\u4e00\u4e2a\u8868\u91cc\u9762\u7684\u524d 10000 \u884c\u6570\u636e\uff0c\u6709\u4ee5\u4e0b\u4e09\u79cd\u65b9\u6cd5\u53ef\u4ee5\u505a\u5230\uff1a</p> <ul> <li>\u7b2c\u4e00\u79cd\uff0c\u76f4\u63a5\u6267\u884c <code>delete from T limit 10000;</code></li> <li>\u7b2c\u4e8c\u79cd\uff0c\u5728\u4e00\u4e2a\u8fde\u63a5\u4e2d\u5faa\u73af\u6267\u884c 20 \u6b21 <code>delete from T limit 500;</code></li> <li>\u7b2c\u4e09\u79cd\uff0c\u5728 20 \u4e2a\u8fde\u63a5\u4e2d\u540c\u65f6\u6267\u884c <code>delete from T limit 500</code>\u3002</li> </ul> <p>\u4f60\u4f1a\u9009\u62e9\u54ea\u4e00\u79cd\u65b9\u6cd5\u5462\uff1f\u4e3a\u4ec0\u4e48\u5462\uff1f</p> <p>\u56de\u7b54\uff1a</p> <p>\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u5373\uff1a\u5728\u4e00\u4e2a\u8fde\u63a5\u4e2d\u5faa\u73af\u6267\u884c 20 \u6b21 <code>delete from T limit 500</code>\u3002</p> <ul> <li>\u7b2c\u4e00\u79cd\u65b9\u5f0f\uff08\u5373\uff1a\u76f4\u63a5\u6267\u884c <code>delete from T limit 10000</code>\uff09\u91cc\u9762\uff0c\u5355\u4e2a\u8bed\u53e5\u5360\u7528\u65f6\u95f4\u957f\uff0c\u9501\u7684\u65f6\u95f4\u4e5f\u6bd4\u8f83\u957f\uff1b\u800c\u4e14\u5927\u4e8b\u52a1\u8fd8\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u5ef6\u8fdf\u3002</li> <li>\u7b2c\u4e09\u79cd\u65b9\u5f0f\uff08\u5373\uff1a\u5728 20 \u4e2a\u8fde\u63a5\u4e2d\u540c\u65f6\u6267\u884c delete from T limit 500\uff09\uff0c\u4f1a\u4eba\u4e3a\u9020\u6210\u9501\u51b2\u7a81\u3002</li> </ul>"},{"location":"chap1/6mysql_transaction_isolation/","title":"\u7b2c\u516d\u8282 \u4e8b\u52a1\u5230\u5e95\u662f\u9694\u79bb\u7684\u8fd8\u662f\u4e0d\u9694\u79bb\u7684","text":"<p>\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u7684\u65f6\u5019\u63d0\u5230\u8fc7\uff0c\u5982\u679c\u662f\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\uff0c\u4e8b\u52a1 T \u542f\u52a8\u7684\u65f6\u5019\u4f1a\u521b\u5efa\u4e00\u4e2a\u89c6\u56fe <code>read-view</code>\uff0c\u4e4b\u540e\u4e8b\u52a1 T \u6267\u884c\u671f\u95f4\uff0c\u5373\u4f7f\u6709\u5176\u4ed6\u4e8b\u52a1\u4fee\u6539\u4e86\u6570\u636e\uff0c\u4e8b\u52a1 T \u770b\u5230\u7684\u4ecd\u7136\u8ddf\u5728\u542f\u52a8\u65f6\u770b\u5230\u7684\u4e00\u6837\u3002</p> <p>\u4e0a\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u884c\u9501\u7684\u65f6\u5019\u53c8\u63d0\u5230\uff0c\u4e00\u4e2a\u4e8b\u52a1\u8981\u66f4\u65b0\u4e00\u884c\uff0c\u5982\u679c\u521a\u597d\u6709\u53e6\u5916\u4e00\u4e2a\u4e8b\u52a1\u62e5\u6709\u8fd9\u4e00\u884c\u7684\u884c\u9501\uff0c\u4f1a\u88ab\u9501\u4f4f\uff0c\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\u3002</p> <p>\u95ee\u9898\u662f\uff0c\u65e2\u7136\u8fdb\u5165\u4e86\u7b49\u5f85\u72b6\u6001\uff0c\u90a3\u4e48\u7b49\u5230\u8fd9\u4e2a\u4e8b\u52a1\u81ea\u5df1\u83b7\u53d6\u5230\u884c\u9501\u8981\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u5b83\u8bfb\u5230\u7684\u503c\u53c8\u662f\u4ec0\u4e48\u5462\uff1f</p> <pre><code>mysql&gt; CREATE TABLE `t` (\n  `id` int(11) NOT NULL,\n  `k` int(11) DEFAULT NULL,\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB;\n\ninsert into t(id, k) values(1,1),(2,2);\n</code></pre> <p></p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e8b\u52a1\u7684\u542f\u52a8\u65f6\u673a</p> <p><code>begin/start transaction</code> \u547d\u4ee4\u5e76\u4e0d\u662f\u4e00\u4e2a\u4e8b\u52a1\u7684\u8d77\u70b9\uff0c\u5728\u6267\u884c\u5230\u5b83\u4eec\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a\u64cd\u4f5c InnoDB \u8868\u7684\u8bed\u53e5\uff0c\u4e8b\u52a1\u624d\u771f\u6b63\u542f\u52a8\u3002</p> <p>\u5982\u679c\u4f60\u60f3\u8981\u9a6c\u4e0a\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>start transaction with consistent snapshot</code> \u8fd9\u4e2a\u547d\u4ee4\u3002</p> <p>\u7b2c\u4e00\u79cd\u542f\u52a8\u65b9\u5f0f\uff0c\u4e00\u81f4\u6027\u89c6\u56fe\u662f\u5728\u6267\u884c\u7b2c\u4e00\u4e2a\u5feb\u7167\u8bfb\u8bed\u53e5\u65f6\u521b\u5efa\u7684\uff1b</p> <p>\u7b2c\u4e8c\u79cd\u542f\u52a8\u65b9\u5f0f\uff0c\u4e00\u81f4\u6027\u89c6\u56fe\u662f\u5728\u6267\u884c <code>start transaction with consistent snapshot</code> \u65f6\u521b\u5efa\u7684\u3002</p> <p>\u90fd\u662f\u9ed8\u8ba4 autocommit=1\u3002</p> <ul> <li>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u4e8b\u52a1 C \u6ca1\u6709\u663e\u5f0f\u5730\u4f7f\u7528 <code>begin/commit</code>\uff0c\u8868\u793a\u8fd9\u4e2a update \u8bed\u53e5\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u4e8b\u52a1\uff0c\u8bed\u53e5\u5b8c\u6210\u7684\u65f6\u5019\u4f1a\u81ea\u52a8\u63d0\u4ea4\u3002</li> <li>\u4e8b\u52a1 B \u5728\u66f4\u65b0\u4e86\u884c\u4e4b\u540e\u67e5\u8be2</li> <li>\u4e8b\u52a1 A \u5728\u4e00\u4e2a\u53ea\u8bfb\u4e8b\u52a1\u4e2d\u67e5\u8be2\uff0c\u5e76\u4e14\u65f6\u95f4\u987a\u5e8f\u4e0a\u662f\u5728\u4e8b\u52a1 B \u7684\u67e5\u8be2\u4e4b\u540e\u3002</li> </ul> <p>\u7b54\u6848\u662f\uff1a \u4e8b\u52a1 B \u67e5\u5230\u7684 k \u7684\u503c\u662f 3\uff0c\u800c\u4e8b\u52a1 A \u67e5\u5230\u7684 k \u7684\u503c\u662f 1</p> <p>\u6211\u4eec\u6765\u4e00\u70b9\u70b9\u7684\u89e3\u91ca\u8fd9\u4e2a\u539f\u56e0</p>"},{"location":"chap1/6mysql_transaction_isolation/#1mysql","title":"1\u3001MySQL\u4e2d\u7684\u89c6\u56fe","text":"<p>\u5728 MySQL \u91cc\uff0c\u6709\u4e24\u4e2a\u201c\u89c6\u56fe\u201d\u7684\u6982\u5ff5\uff1a</p> <ul> <li>\u4e00\u4e2a\u662f <code>view</code>\u3002\u5b83\u662f\u4e00\u4e2a\u7528\u67e5\u8be2\u8bed\u53e5\u5b9a\u4e49\u7684\u865a\u62df\u8868\uff0c\u5728\u8c03\u7528\u7684\u65f6\u5019\u6267\u884c\u67e5\u8be2\u8bed\u53e5\u5e76\u751f\u6210\u7ed3\u679c<ul> <li>\u521b\u5efa\u89c6\u56fe\u7684\u8bed\u6cd5\u662f <code>create view</code> \u2026 \uff0c\u800c\u5b83\u7684\u67e5\u8be2\u65b9\u6cd5\u4e0e\u8868\u4e00\u6837\u3002</li> </ul> </li> <li>\u53e6\u4e00\u4e2a\u662f <code>InnoDB</code> \u5728\u5b9e\u73b0 <code>MVCC</code> \u65f6\u7528\u5230\u7684\u4e00\u81f4\u6027\u8bfb\u89c6\u56fe\uff0c<ul> <li>\u5373 <code>consistent read view</code>\uff0c\u7528\u4e8e\u652f\u6301 <code>RC</code>\uff08Read Committed\uff0c\u8bfb\u63d0\u4ea4\uff09\u548c <code>RR</code>\uff08Repeatable Read\uff0c\u53ef\u91cd\u590d\u8bfb\uff09\u9694\u79bb\u7ea7\u522b\u7684\u5b9e\u73b0\u3002</li> </ul> </li> </ul> <p>\u5b83\u6ca1\u6709\u7269\u7406\u7ed3\u6784\uff0c\u4f5c\u7528\u662f\u4e8b\u52a1\u6267\u884c\u671f\u95f4\u7528\u6765\u5b9a\u4e49\u201c\u6211\u80fd\u770b\u5230\u4ec0\u4e48\u6570\u636e\u201d\u3002</p>"},{"location":"chap1/6mysql_transaction_isolation/#2-mvcc","title":"2\u3001\u201c\u5feb\u7167\u201d\u5728 MVCC \u91cc\u662f\u600e\u4e48\u5de5\u4f5c\u7684\uff1f","text":"<p>\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u4e8b\u52a1\u5728\u542f\u52a8\u7684\u65f6\u5019\u5c31\u201c\u62cd\u4e86\u4e2a\u5feb\u7167\u201d\u3002\u6ce8\u610f\uff0c\u8fd9\u4e2a\u5feb\u7167\u662f\u57fa\u4e8e\u6574\u5e93\u7684\u3002</p> <p>\u5e93\u5feb\u7167\uff0c\u4e0d\u662f\u884c\u5feb\u7167\u3002\u6240\u4ee5\u4e0d\u4f1a\u8fdb\u884cMDL\u8bfb\u9501\u7b49\u5f85\uff0c\u800c\u662f\u83b7\u53d6\u6240\u6709\u5df2\u63d0\u4ea4\u7684\u6570\u636e</p> <p>\u770b\u4e0a\u53bb\u4e0d\u592a\u73b0\u5b9e\u554a\u3002\u5982\u679c\u4e00\u4e2a\u5e93\u6709 100G\uff0c\u90a3\u4e48\u6211\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0cMySQL \u5c31\u8981\u62f7\u8d1d 100G \u7684\u6570\u636e\u51fa\u6765\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5f97\u591a\u6162\u554a</p> <p>\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u5e76\u4e0d\u9700\u8981\u62f7\u8d1d\u51fa\u8fd9 100G \u7684\u6570\u636e\u3002</p>"},{"location":"chap1/6mysql_transaction_isolation/#2-1-transaction-id-row-trx_id","title":"2-1 <code>transaction id</code> &amp; <code>row trx_id</code>","text":"<p>InnoDB \u91cc\u9762\u6bcf\u4e2a\u4e8b\u52a1\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u4e8b\u52a1 ID\uff0c\u53eb\u4f5c <code>transaction id</code>\u3002\u5b83\u662f\u5728\u4e8b\u52a1\u5f00\u59cb\u7684\u65f6\u5019\u5411 InnoDB \u7684\u4e8b\u52a1\u7cfb\u7edf\u7533\u8bf7\u7684\uff0c\u662f\u6309\u7533\u8bf7\u987a\u5e8f\u4e25\u683c\u9012\u589e\u7684\u3002</p> <ul> <li>\u6bcf\u884c\u6570\u636e\u4e5f\u90fd\u662f\u6709\u591a\u4e2a\u7248\u672c\u7684\u3002\u6bcf\u6b21\u4e8b\u52a1\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u90fd\u4f1a\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u7248\u672c\uff0c\u5e76\u4e14\u628a <code>transaction id</code> \u8d4b\u503c\u7ed9\u8fd9\u4e2a\u6570\u636e\u7248\u672c\u7684\u4e8b\u52a1 ID\uff0c\u8bb0\u4e3a <code>row trx_id</code></li> <li><code>transaction id</code> ==  <code>row trx_id</code></li> <li>\u540c\u65f6\uff0c\u65e7\u7684\u6570\u636e\u7248\u672c\u8981\u4fdd\u7559\uff0c\u5e76\u4e14\u5728\u65b0\u7684\u6570\u636e\u7248\u672c\u4e2d\uff0c\u80fd\u591f\u6709\u4fe1\u606f\u53ef\u4ee5\u76f4\u63a5\u62ff\u5230\u5b83\u3002</li> </ul> <p>\u6570\u636e\u8868\u4e2d\u7684\u4e00\u884c\u8bb0\u5f55\uff0c\u5176\u5b9e\u53ef\u80fd\u6709\u591a\u4e2a\u7248\u672c (row)\uff0c\u6bcf\u4e2a\u7248\u672c\u6709\u81ea\u5df1\u7684 <code>row trx_id</code>\u3002</p> <p>\u5982\u56fe\u6240\u793a\uff0c\u5c31\u662f\u4e00\u4e2a\u8bb0\u5f55\u88ab\u591a\u4e2a\u4e8b\u52a1\u8fde\u7eed\u66f4\u65b0\u540e\u7684\u72b6\u6001\u3002</p> <p></p> <ul> <li>\u865a\u7ebf\u6846\u91cc\u662f\u540c\u4e00\u884c\u6570\u636e\u7684 4 \u4e2a\u7248\u672c\uff0c\u5f53\u524d\u6700\u65b0\u7248\u672c\u662f V4\uff0ck \u7684\u503c\u662f 22\uff0c\u5b83\u662f\u88ab <code>transaction id</code> \u4e3a 25 \u7684\u4e8b\u52a1\u66f4\u65b0\u7684\uff0c\u56e0\u6b64\u5b83\u7684 <code>row trx_id</code>\u4e5f\u662f 25\u3002</li> <li>\u56fe \u4e2d\u7684\u4e09\u4e2a\u865a\u7ebf\u7bad\u5934\uff0c\u5c31\u662f <code>undo log</code>\uff1b</li> <li>\u800c V1\u3001V2\u3001V3 \u5e76\u4e0d\u662f\u7269\u7406\u4e0a\u771f\u5b9e\u5b58\u5728\u7684\uff0c\u800c\u662f\u6bcf\u6b21\u9700\u8981\u7684\u65f6\u5019\u6839\u636e\u5f53\u524d\u7248\u672c\u548c <code>undo log</code> \u8ba1\u7b97\u51fa\u6765\u7684\u3002<ul> <li>\u6bd4\u5982\uff0c\u9700\u8981 V2 \u7684\u65f6\u5019\uff0c\u5c31\u662f\u901a\u8fc7 V4 \u4f9d\u6b21\u6267\u884c U3\u3001U2 \u7b97\u51fa\u6765\u3002</li> </ul> </li> </ul>"},{"location":"chap1/6mysql_transaction_isolation/#2-2-read-view","title":"2-2 \u4e00\u81f4\u6027\u89c6\u56fe\uff08read-view\uff09","text":"<p>InnoDB \u662f\u600e\u4e48\u5b9a\u4e49\u90a3\u4e2a\u201c100G\u201d\u7684\u5feb\u7167\u7684\u3002</p> <p>\u6309\u7167\u53ef\u91cd\u590d\u8bfb\u7684\u5b9a\u4e49\uff0c\u4e00\u4e2a\u4e8b\u52a1\u542f\u52a8\u7684\u65f6\u5019\uff0c\u80fd\u591f\u770b\u5230\u6240\u6709\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1\u7ed3\u679c\u3002\u4f46\u662f\u4e4b\u540e\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u6267\u884c\u671f\u95f4\uff0c\u5176\u4ed6\u4e8b\u52a1\u7684\u66f4\u65b0\u5bf9\u5b83\u4e0d\u53ef\u89c1\u3002</p> <ul> <li>\u4e00\u4e2a\u4e8b\u52a1\u53ea\u9700\u8981\u5728\u542f\u52a8\u7684\u65f6\u5019\u58f0\u660e\u8bf4\uff0c\u201c\u4ee5\u6211\u542f\u52a8\u7684\u65f6\u523b\u4e3a\u51c6\uff0c\u5982\u679c\u4e00\u4e2a\u6570\u636e\u7248\u672c\u662f\u5728\u6211\u542f\u52a8\u4e4b\u524d\u751f\u6210\u7684\uff0c\u5c31\u8ba4\uff1b\u5982\u679c\u662f\u6211\u542f\u52a8\u4ee5\u540e\u624d\u751f\u6210\u7684\uff0c\u6211\u5c31\u4e0d\u8ba4\uff0c\u6211\u5fc5\u987b\u8981\u627e\u5230\u5b83\u7684\u4e0a\u4e00\u4e2a\u7248\u672c\u201d\u3002</li> <li>\u5982\u679c\u201c\u4e0a\u4e00\u4e2a\u7248\u672c\u201d\u4e5f\u4e0d\u53ef\u89c1\uff0c\u90a3\u5c31\u5f97\u7ee7\u7eed\u5f80\u524d\u627e\u3002</li> <li>\u8fd8\u6709\uff0c\u5982\u679c\u662f\u8fd9\u4e2a\u4e8b\u52a1\u81ea\u5df1\u66f4\u65b0\u7684\u6570\u636e\uff0c\u5b83\u81ea\u5df1\u8fd8\u662f\u8981\u8ba4\u7684\u3002</li> </ul> <p>\u5728\u5b9e\u73b0\u4e0a\uff0c InnoDB \u4e3a\u6bcf\u4e2a\u4e8b\u52a1\u6784\u9020\u4e86\u4e00\u4e2a\u6570\u7ec4\uff0c\u7528\u6765\u4fdd\u5b58\u8fd9\u4e2a\u4e8b\u52a1\u542f\u52a8\u77ac\u95f4\uff0c\u5f53\u524d\u6b63\u5728\u201c\u6d3b\u8dc3\u201d\u7684\u6240\u6709\u4e8b\u52a1 ID\u3002\u201c\u6d3b\u8dc3\u201d\u6307\u7684\u5c31\u662f\uff0c\u542f\u52a8\u4e86\u4f46\u8fd8\u6ca1\u63d0\u4ea4\u3002</p> <p>\u6570\u7ec4\u91cc\u9762\u4e8b\u52a1 ID \u7684\u6700\u5c0f\u503c\u8bb0\u4e3a\u4f4e\u6c34\u4f4d\uff0c\u5f53\u524d\u7cfb\u7edf\u91cc\u9762\u5df2\u7ecf\u521b\u5efa\u8fc7\u7684\u4e8b\u52a1 ID \u7684\u6700\u5927\u503c\u52a0 1 \u8bb0\u4e3a\u9ad8\u6c34\u4f4d\u3002</p> <ul> <li>\u4f4e\u6c34\u4f4d\uff1a\u6570\u7ec4\u5185\u4e8b\u52a1ID\u6700\u5c0f\u503c\u3002 </li> <li>\u9ad8\u6c34\u4f4d\uff1a\u5f53\u524d\u7cfb\u7edf\u5df2\u7ecf\u521b\u5efa\u7684\u4e8b\u52a1id\u7684\u6700\u5927\u503c+1\uff08\u5e76\u4e0d\u662f\u6570\u7ec4\u5185\u7684\u6700\u5927\uff09</li> </ul> <p>\u4f4e\u6c34\u4f4d\u662f\u3010\u6570\u7ec4\u5185\u3011 \u9ad8\u6c34\u4f4d\u3010\u7cfb\u7edf\u5185\u3011</p> <p>\u8fd9\u4e2a\u89c6\u56fe\u6570\u7ec4\u548c\u9ad8\u6c34\u4f4d\uff0c\u5c31\u7ec4\u6210\u4e86\u5f53\u524d\u4e8b\u52a1\u7684\u4e00\u81f4\u6027\u89c6\u56fe\uff08read-view\uff09\u3002</p> <p>\u800c\u6570\u636e\u7248\u672c\u7684\u53ef\u89c1\u6027\u89c4\u5219\uff0c\u5c31\u662f\u57fa\u4e8e\u6570\u636e\u7684 <code>row trx_id</code> \u548c\u8fd9\u4e2a\u4e00\u81f4\u6027\u89c6\u56fe\u7684\u5bf9\u6bd4\u7ed3\u679c\u5f97\u5230\u7684\u3002</p> <p>\u89c6\u56fe\u6570\u7ec4\u628a\u6240\u6709\u7684 <code>row trx_id</code> \u5206\u6210\u4e86\u51e0\u79cd\u4e0d\u540c\u7684\u60c5\u51b5\u3002</p> <p></p> <p>\u5bf9\u4e8e\u5f53\u524d\u4e8b\u52a1\u7684\u542f\u52a8\u77ac\u95f4\u6765\u8bf4\uff0c\u4e00\u4e2a\u6570\u636e\u7248\u672c\u7684 <code>row trx_id</code>\uff0c\u6709\u4ee5\u4e0b\u51e0\u79cd\u53ef\u80fd\uff1a</p> <ol> <li>\u5982\u679c\u843d\u5728\u7eff\u8272\u90e8\u5206\uff0c\u8868\u793a\u8fd9\u4e2a\u7248\u672c\u662f\u5df2\u63d0\u4ea4\u7684\u4e8b\u52a1\u6216\u8005\u662f\u5f53\u524d\u4e8b\u52a1\u81ea\u5df1\u751f\u6210\u7684\uff0c\u8fd9\u4e2a\u6570\u636e\u662f\u53ef\u89c1\u7684\uff1b</li> <li>\u5982\u679c\u843d\u5728\u7ea2\u8272\u90e8\u5206\uff0c\u8868\u793a\u8fd9\u4e2a\u7248\u672c\u662f\u7531\u5c06\u6765\u542f\u52a8\u7684\u4e8b\u52a1\u751f\u6210\u7684\uff0c\u662f\u80af\u5b9a\u4e0d\u53ef\u89c1\u7684\uff1b</li> <li>\u5982\u679c\u843d\u5728\u9ec4\u8272\u90e8\u5206\uff0c\u90a3\u5c31\u5305\u62ec\u4e24\u79cd\u60c5\u51b5<ul> <li>a. \u82e5 <code>row trx_id</code> \u5728\u6570\u7ec4\u4e2d\uff0c\u8868\u793a\u8fd9\u4e2a\u7248\u672c\u662f\u7531\u8fd8\u6ca1\u63d0\u4ea4\u7684\u4e8b\u52a1\u751f\u6210\u7684\uff0c\u4e0d\u53ef\u89c1\uff1b </li> <li>b. \u82e5 <code>row trx_id</code> \u4e0d\u5728\u6570\u7ec4\u4e2d\uff0c\u8868\u793a\u8fd9\u4e2a\u7248\u672c\u662f\u5df2\u7ecf\u63d0\u4ea4\u4e86\u7684\u4e8b\u52a1\u751f\u6210\u7684\uff0c\u53ef\u89c1\u3002</li> </ul> </li> </ol> <p>\u5bf9\u4e8e\u56fe 2 \u4e2d\u7684\u6570\u636e\u6765\u8bf4\uff0c\u5982\u679c\u6709\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5b83\u7684\u4f4e\u6c34\u4f4d\u662f 18\uff0c\u90a3\u4e48\u5f53\u5b83\u8bbf\u95ee\u8fd9\u4e00\u884c\u6570\u636e\u65f6\uff0c\u5c31\u4f1a\u4ece V4 \u901a\u8fc7 U3 \u8ba1\u7b97\u51fa V3\uff0c\u6240\u4ee5\u5728\u5b83\u770b\u6765\uff0c\u8fd9\u4e00\u884c\u7684\u503c\u662f 11\u3002</p> <p>\u6709\u4e86\u8fd9\u4e2a\u58f0\u660e\u540e\uff0c\u7cfb\u7edf\u91cc\u9762\u968f\u540e\u53d1\u751f\u7684\u66f4\u65b0\uff0c\u662f\u4e0d\u662f\u5c31\u8ddf\u8fd9\u4e2a\u4e8b\u52a1\u770b\u5230\u7684\u5185\u5bb9\u65e0\u5173\u4e86\u5462\uff1f\u56e0\u4e3a\u4e4b\u540e\u7684\u66f4\u65b0\uff0c\u751f\u6210\u7684\u7248\u672c\u4e00\u5b9a\u5c5e\u4e8e\u4e0a\u9762\u7684 2 \u6216\u8005 3(a) \u7684\u60c5\u51b5\uff0c\u800c\u5bf9\u5b83\u6765\u8bf4\uff0c\u8fd9\u4e9b\u65b0\u7684\u6570\u636e\u7248\u672c\u662f\u4e0d\u5b58\u5728\u7684\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4e8b\u52a1\u7684\u5feb\u7167\uff0c\u5c31\u662f\u201c\u9759\u6001\u201d\u7684\u4e86\u3002</p> <p>InnoDB \u5229\u7528\u4e86\u201c\u6240\u6709\u6570\u636e\u90fd\u6709\u591a\u4e2a\u7248\u672c\u201d\u7684\u8fd9\u4e2a\u7279\u6027\uff0c\u5b9e\u73b0\u4e86\u201c\u79d2\u7ea7\u521b\u5efa\u5feb\u7167\u201d\u7684\u80fd\u529b\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7ee7\u7eed\u770b\u4e00\u4e0b\u56fe 1 \u4e2d\u7684\u4e09\u4e2a\u4e8b\u52a1\uff0c\u5206\u6790\u4e0b\u4e8b\u52a1 A \u7684\u8bed\u53e5\u8fd4\u56de\u7684\u7ed3\u679c\uff0c\u4e3a\u4ec0\u4e48\u662f k=1\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u4e0d\u59a8\u505a\u5982\u4e0b\u5047\u8bbe\uff1a</p> <ul> <li>\u4e8b\u52a1 A \u5f00\u59cb\u524d\uff0c\u7cfb\u7edf\u91cc\u9762\u53ea\u6709\u4e00\u4e2a\u6d3b\u8dc3\u4e8b\u52a1 ID \u662f 99\uff1b</li> <li>\u4e8b\u52a1 A\u3001B\u3001C \u7684\u7248\u672c\u53f7\u5206\u522b\u662f 100\u3001101\u3001102\uff0c\u4e14\u5f53\u524d\u7cfb\u7edf\u91cc\u53ea\u6709\u8fd9\u56db\u4e2a\u4e8b\u52a1\uff1b</li> <li>\u4e09\u4e2a\u4e8b\u52a1\u5f00\u59cb\u524d\uff0c<code>(1,1</code>\uff09\u8fd9\u4e00\u884c\u6570\u636e\u7684 <code>row trx_id</code> \u662f 90\u3002</li> </ul> <ul> <li>\u4e8b\u52a1 A \u7684\u89c6\u56fe\u6570\u7ec4\u5c31\u662f[99,100], </li> <li>\u4e8b\u52a1 B \u7684\u89c6\u56fe\u6570\u7ec4\u662f[99,100,101], </li> <li>\u4e8b\u52a1 C \u7684\u89c6\u56fe\u6570\u7ec4\u662f[99,100,101,102]</li> </ul> <p>\u4e3a\u4e86\u7b80\u5316\u5206\u6790, \u53ea\u753b\u51fa\u8ddf\u4e8b\u52a1 A \u67e5\u8be2\u903b\u8f91\u6709\u5173\u7684\u64cd\u4f5c\uff1a</p> <p></p> <ul> <li>\uff0c\u7b2c\u4e00\u4e2a\u6709\u6548\u66f4\u65b0\u662f\u4e8b\u52a1 C\uff0c\u628a\u6570\u636e\u4ece (1,1) \u6539\u6210\u4e86 (1,2)\u3002\u8fd9\u65f6\u5019\uff0c\u8fd9\u4e2a\u6570\u636e\u7684\u6700\u65b0\u7248\u672c\u7684 <code>row trx_id</code> \u662f 102\uff0c\u800c 90 \u8fd9\u4e2a\u7248\u672c\u5df2\u7ecf\u6210\u4e3a\u4e86\u5386\u53f2\u7248\u672c\u3002</li> <li>\u7b2c\u4e8c\u4e2a\u6709\u6548\u66f4\u65b0\u662f\u4e8b\u52a1 B\uff0c\u628a\u6570\u636e\u4ece (1,2) \u6539\u6210\u4e86 (1,3)\u3002\u8fd9\u65f6\u5019\uff0c\u8fd9\u4e2a\u6570\u636e\u7684\u6700\u65b0\u7248\u672c\uff08\u5373 <code>row trx_id</code>\uff09\u662f 101\uff0c\u800c 102 \u53c8\u6210\u4e3a\u4e86\u5386\u53f2\u7248\u672c\u3002</li> <li>\u5728\u4e8b\u52a1 A \u67e5\u8be2\u7684\u65f6\u5019\uff0c\u5176\u5b9e\u4e8b\u52a1 B \u8fd8\u6ca1\u6709\u63d0\u4ea4\uff0c\u4f46\u662f\u5b83\u751f\u6210\u7684 (1,3) \u8fd9\u4e2a\u7248\u672c\u5df2\u7ecf\u53d8\u6210\u5f53\u524d\u7248\u672c\u4e86\u3002\u4f46\u8fd9\u4e2a\u7248\u672c\u5bf9\u4e8b\u52a1 A \u5fc5\u987b\u662f\u4e0d\u53ef\u89c1\u7684\uff0c\u5426\u5219\u5c31\u53d8\u6210\u810f\u8bfb\u4e86\u3002</li> </ul> <p>\u73b0\u5728\u4e8b\u52a1 A \u8981\u6765\u8bfb\u6570\u636e\u4e86\uff0c\u5b83\u7684\u89c6\u56fe\u6570\u7ec4\u662f<code>[99,100]</code>\u3002\u5f53\u7136\u4e86\uff0c\u8bfb\u6570\u636e\u90fd\u662f\u4ece\u5f53\u524d\u7248\u672c\u8bfb\u8d77\u7684\u3002\u6240\u4ee5\uff0c\u4e8b\u52a1 A \u67e5\u8be2\u8bed\u53e5\u7684\u8bfb\u6570\u636e\u6d41\u7a0b\u662f\u8fd9\u6837\u7684\uff1a</p> <ul> <li>\u627e\u5230 (1,3) \u7684\u65f6\u5019\uff0c\u5224\u65ad\u51fa <code>row trx_id=101</code>\uff0c\u6bd4\u9ad8\u6c34\u4f4d\u5927\uff0c\u5904\u4e8e\u7ea2\u8272\u533a\u57df\uff0c\u4e0d\u53ef\u89c1\uff1b</li> </ul> <p>100\u662f\u9ad8\u6c34\u4f4d\uff0c\u521b\u5efa\u4e8b\u52a1A\u7684\u65f6\u5019\uff0c\u7cfb\u7edf\u73b0\u6709\u7684\u6700\u5927\u4e8b\u52a1id\u662f99\uff0c99 + 1 = 100\u3002</p> <ul> <li>\u63a5\u7740\uff0c\u627e\u5230\u4e0a\u4e00\u4e2a\u5386\u53f2\u7248\u672c\uff0c\u4e00\u770b <code>row trx_id=102</code>\uff0c\u6bd4\u9ad8\u6c34\u4f4d\u5927\uff0c\u5904\u4e8e\u7ea2\u8272\u533a\u57df\uff0c\u4e0d\u53ef\u89c1\uff1b</li> <li>\u518d\u5f80\u524d\u627e\uff0c\u7ec8\u4e8e\u627e\u5230\u4e86<code>\uff081,1)</code>\uff0c\u5b83\u7684<code>row trx_id=90</code>\uff0c\u6bd4\u4f4e\u6c34\u4f4d\u5c0f\uff0c\u5904\u4e8e\u7eff\u8272\u533a\u57df\uff0c\u53ef\u89c1\u3002</li> </ul> <p>\u867d\u7136\u671f\u95f4\u8fd9\u4e00\u884c\u6570\u636e\u88ab\u4fee\u6539\u8fc7\uff0c\u4f46\u662f\u4e8b\u52a1 A \u4e0d\u8bba\u5728\u4ec0\u4e48\u65f6\u5019\u67e5\u8be2\uff0c\u770b\u5230\u8fd9\u884c\u6570\u636e\u7684\u7ed3\u679c\u90fd\u662f\u4e00\u81f4\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u79f0\u4e4b\u4e3a\u4e00\u81f4\u6027\u8bfb\u3002</p> <p>\u4e00\u4e2a\u6570\u636e\u7248\u672c\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u4e8b\u52a1\u89c6\u56fe\u6765\u8bf4\uff0c\u9664\u4e86\u81ea\u5df1\u7684\u66f4\u65b0\u603b\u662f\u53ef\u89c1\u4ee5\u5916\uff0c\u6709\u4e09\u79cd\u60c5\u51b5\uff1a</p> <ul> <li>\u7248\u672c\u672a\u63d0\u4ea4\uff0c\u4e0d\u53ef\u89c1\uff1b</li> <li>\u7248\u672c\u5df2\u63d0\u4ea4\uff0c\u4f46\u662f\u662f\u5728\u89c6\u56fe\u521b\u5efa\u540e\u63d0\u4ea4\u7684\uff0c\u4e0d\u53ef\u89c1\uff1b</li> <li>\u7248\u672c\u5df2\u63d0\u4ea4\uff0c\u800c\u4e14\u662f\u5728\u89c6\u56fe\u521b\u5efa\u524d\u63d0\u4ea4\u7684\uff0c\u53ef\u89c1\u3002</li> </ul> <p>\u56fe 4 \u4e2d\u7684\u67e5\u8be2\u7ed3\u679c\uff0c\u4e8b\u52a1 A \u7684\u67e5\u8be2\u8bed\u53e5\u7684\u89c6\u56fe\u6570\u7ec4\u662f\u5728\u4e8b\u52a1 A \u542f\u52a8\u7684\u65f6\u5019\u751f\u6210\u7684\uff0c\u8fd9\u65f6\u5019\uff1a</p> <ul> <li>(1,3) \u8fd8\u6ca1\u63d0\u4ea4\uff0c\u5c5e\u4e8e\u60c5\u51b5 1\uff0c\u4e0d\u53ef\u89c1\uff1b</li> <li>(1,2) \u867d\u7136\u63d0\u4ea4\u4e86\uff0c\u4f46\u662f\u662f\u5728\u89c6\u56fe\u6570\u7ec4\u521b\u5efa\u4e4b\u540e\u63d0\u4ea4\u7684\uff0c\u5c5e\u4e8e\u60c5\u51b5 2\uff0c\u4e0d\u53ef\u89c1\uff1b</li> <li>(1,1) \u662f\u5728\u89c6\u56fe\u6570\u7ec4\u521b\u5efa\u4e4b\u524d\u63d0\u4ea4\u7684\uff0c\u53ef\u89c1\u3002</li> </ul>"},{"location":"chap1/6mysql_transaction_isolation/#3","title":"3\u3001\u66f4\u65b0\u903b\u8f91","text":"<p>\u4e8b\u52a1 B \u7684 update \u8bed\u53e5\uff0c\u5982\u679c\u6309\u7167\u4e00\u81f4\u6027\u8bfb\uff0c\u597d\u50cf\u7ed3\u679c\u4e0d\u5bf9\u54e6\uff1f</p> <p>\u4e8b\u52a1 B \u7684\u89c6\u56fe\u6570\u7ec4\u662f\u5148\u751f\u6210\u7684\uff0c\u4e4b\u540e\u4e8b\u52a1 C \u624d\u63d0\u4ea4\uff0c\u4e0d\u662f\u5e94\u8be5\u770b\u4e0d\u89c1 (1,2) \u5417\uff0c\u600e\u4e48\u80fd\u7b97\u51fa (1,3) \u6765\uff1f</p>"},{"location":"chap1/6mysql_transaction_isolation/#3-1-current-read","title":"3-1 \u5f53\u524d\u8bfb\uff08current read)","text":"<ul> <li>\u5982\u679c\u4e8b\u52a1 B \u5728\u66f4\u65b0\u4e4b\u524d\u67e5\u8be2\u4e00\u6b21\u6570\u636e\uff0c\u8fd9\u4e2a\u67e5\u8be2\u8fd4\u56de\u7684 k \u7684\u503c\u786e\u5b9e\u662f 1\u3002</li> <li>\u5f53\u5b83\u8981\u53bb\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u5c31\u4e0d\u80fd\u518d\u5728\u5386\u53f2\u7248\u672c\u4e0a\u66f4\u65b0\u4e86\uff0c\u5426\u5219\u4e8b\u52a1 C \u7684\u66f4\u65b0\u5c31\u4e22\u5931\u4e86\u3002\u56e0\u6b64\uff0c\u4e8b\u52a1 B \u6b64\u65f6\u7684 <code>set k=k+1</code> \u662f\u5728\uff081,2\uff09\u7684\u57fa\u7840\u4e0a\u8fdb\u884c\u7684\u64cd\u4f5c\u3002</li> <li>\u66f4\u65b0\u6570\u636e\u90fd\u662f\u5148\u8bfb\u540e\u5199\u7684\uff0c\u800c\u8fd9\u4e2a\u8bfb\uff0c\u53ea\u80fd\u8bfb\u5f53\u524d\u7684\u503c\uff0c\u79f0\u4e3a\u201c\u5f53\u524d\u8bfb\u201d\uff08current read\uff09\u3002</li> </ul> <p>\u4e8b\u52a1\u4e0e\u4e8b\u52a1\u4e4b\u95f4\u7684\u9694\u79bb\u4e0d\u5e94\u8be5\u5f71\u54cd\u6700\u7ec8\u6570\u636e\u7684\u843d\u5730\u3002</p> <p>\u5c31\u662f\u8bf4\u4e8b\u52a1C\u5148\u66f4\u65b0\u4e86\u6570\u636e\uff0c\u800c\u540e\u4e8b\u52a1B\u4e5f\u66f4\u65b0\u4e86\u540c\u4e00\u4efd\u6570\u636e\uff0c\u4ee5\u6570\u636e\u5e93\u7684\u773c\u5149\u6765\u770b\u8fd9\u4efd\u6570\u636e\u7684\u53d8\u52a8\u5c31\u662f\u4e8b\u52a1C\u7684\u66f4\u65b0\u8ddf\u7740\u4e8b\u52a1B\u7684\u66f4\u65b0\uff0c\u5fc5\u987b\u5ef6\u7eed\u5728\u4e00\u5757\u800c\u4e0d\u80fd\u5206\u5f00\u3002 </p> <p>\u6240\u4ee5\u4e8b\u52a1\u7684\u66f4\u65b0\u5fc5\u987b\u662f\u57fa\u4e8e\u5f53\u524d\u6700\u65b0\u503c\u6765\u6267\u884c\u7684\uff0c\u800c\u8bfb\u5219\u662f\u57fa\u4e8e\u5176\u89c6\u56fe\uff0c\u5373\u53ef\u91cd\u590d\u8bfb\u7684\u9694\u79bb\uff0c\u771f\u7684\u53ea\u662f\u8bfb\u5c42\u9762\u7684\u9694\u79bb\u3002 </p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u5c31\u662f\u56e0\u4e3a\u4e8b\u52a1C\u7684\u66f4\u65b0\u5728\u524d\uff0c\u4e8b\u52a1B\u7684\u66f4\u65b0\u5fc5\u987b\u5ef6\u7eed\u4e8b\u52a1C\u7684\u7ed3\u679c\uff0c\u6240\u4ee5\u53ea\u80fd\u8bfb\u53d6\u5f53\u524d\u503c\u518d\u66f4\u65b0\u3002\u800c\u4e8b\u52a1\u672c\u8eab\u7684\u66f4\u65b0\u662f\u80fd\u88ab\u770b\u5230\u7684\uff0c\u6240\u4ee5\u4e8b\u52a1B\u518d\u67e5\u8be2\u5c31\u53ea\u80fd\u662f\u5f97\u5230\u5f53\u524d\u6700\u65b0\u503c</p> <p>\u56e0\u6b64\uff0c\u5728\u66f4\u65b0\u7684\u65f6\u5019\uff0c\u5f53\u524d\u8bfb\u62ff\u5230\u7684\u6570\u636e\u662f (1,2)\uff0c\u66f4\u65b0\u540e\u751f\u6210\u4e86\u65b0\u7248\u672c\u7684\u6570\u636e (1,3)\uff0c\u8fd9\u4e2a\u65b0\u7248\u672c\u7684 <code>row trx_id</code> \u662f 101\u3002</p> <p>\u5728\u6267\u884c\u4e8b\u52a1 B \u67e5\u8be2\u8bed\u53e5\u7684\u65f6\u5019\uff0c\u4e00\u770b\u81ea\u5df1\u7684\u7248\u672c\u53f7\u662f 101\uff0c\u6700\u65b0\u6570\u636e\u7684\u7248\u672c\u53f7\u4e5f\u662f 101\uff0c\u662f\u81ea\u5df1\u7684\u66f4\u65b0\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\uff0c\u6240\u4ee5\u67e5\u8be2\u5f97\u5230\u7684 k \u7684\u503c\u662f 3\u3002</p>"},{"location":"chap1/6mysql_transaction_isolation/#3-2-select","title":"3-2 select \u52a0\u9501 =&gt; \u5f53\u524d\u8bfb","text":"<p>\u5176\u5b9e\uff0c\u9664\u4e86 update \u8bed\u53e5\u5916\uff0cselect \u8bed\u53e5\u5982\u679c\u52a0\u9501\uff0c\u4e5f\u662f\u5f53\u524d\u8bfb\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u628a\u4e8b\u52a1 A \u7684\u67e5\u8be2\u8bed\u53e5 <code>select * from t where id=1</code> \u4fee\u6539\u4e00\u4e0b\uff0c\u52a0\u4e0a <code>lock in share mode</code> \u6216 <code>for update</code>\uff0c\u4e5f\u90fd\u53ef\u4ee5\u8bfb\u5230\u7248\u672c\u53f7\u662f 101 \u7684\u6570\u636e\uff0c\u8fd4\u56de\u7684 k \u7684\u503c\u662f 3\u3002</p> <p>\u4e0b\u9762\u8fd9\u4e24\u4e2a<code>select</code>\u8bed\u53e5\uff0c\u5c31\u662f\u5206\u522b\u52a0\u4e86\u8bfb\u9501\uff08S \u9501\uff0c\u5171\u4eab\u9501\uff09\u548c\u5199\u9501\uff08X \u9501\uff0c\u6392\u4ed6\u9501)</p> <pre><code>mysql&gt; select k from t where id=1 lock in share mode;\nmysql&gt; select k from t where id=1 for update;\n</code></pre>"},{"location":"chap1/6mysql_transaction_isolation/#3-3","title":"3-3 \u53ef\u91cd\u590d\u8bfb\u52a0\u9501","text":"<p>\u5047\u8bbe\u4e8b\u52a1 C \u4e0d\u662f\u9a6c\u4e0a\u63d0\u4ea4\u7684\uff0c\u800c\u662f\u53d8\u6210\u4e86\u4e0b\u9762\u7684\u4e8b\u52a1 <code>C\u2019</code>\uff0c\u4f1a\u600e\u4e48\u6837\u5462\uff1f</p> <p></p> <p>\u4e8b\u52a1<code>C\u2019</code>\u7684\u4e0d\u540c\u662f\uff0c\u66f4\u65b0\u540e\u5e76\u6ca1\u6709\u9a6c\u4e0a\u63d0\u4ea4\uff0c\u5728\u5b83\u63d0\u4ea4\u524d\uff0c\u4e8b\u52a1 B \u7684\u66f4\u65b0\u8bed\u53e5\u5148\u53d1\u8d77\u4e86\u3002</p> <p>\u867d\u7136\u4e8b\u52a1<code>C\u2019</code>\u8fd8\u6ca1\u63d0\u4ea4\uff0c\u4f46\u662f<code>(1,2)</code>\u8fd9\u4e2a\u7248\u672c\u4e5f\u5df2\u7ecf\u751f\u6210\u4e86\uff0c\u5e76\u4e14\u662f\u5f53\u524d\u7684\u6700\u65b0\u7248\u672c</p> <p>\u4e8b\u52a1 B \u7684\u66f4\u65b0\u8bed\u53e5\u4f1a\u600e\u4e48\u5904\u7406\u5462\uff1f</p> <p>\u201c\u4e24\u9636\u6bb5\u9501\u534f\u8bae\u201d\u5c31\u8981\u4e0a\u573a\u4e86\u3002\u4e8b\u52a1 <code>C\u2019</code>\u6ca1\u63d0\u4ea4\uff0c\u4e5f\u5c31\u662f\u8bf4 (1,2) \u8fd9\u4e2a\u7248\u672c\u4e0a\u7684\u5199\u9501\u8fd8\u6ca1\u91ca\u653e\u3002\u800c\u4e8b\u52a1 B \u662f\u5f53\u524d\u8bfb\uff0c\u5fc5\u987b\u8981\u8bfb\u6700\u65b0\u7248\u672c\uff0c\u800c\u4e14\u5fc5\u987b\u52a0\u9501\uff0c\u56e0\u6b64\u5c31\u88ab\u9501\u4f4f\u4e86\uff0c\u5fc5\u987b\u7b49\u5230\u4e8b\u52a1 <code>C\u2019</code>\u91ca\u653e\u8fd9\u4e2a\u9501\uff0c\u624d\u80fd\u7ee7\u7eed\u5b83\u7684\u5f53\u524d\u8bfb\u3002</p> <p></p> <p>\u5230\u8fd9\u91cc\uff0c\u6211\u4eec\u628a\u4e00\u81f4\u6027\u8bfb\u3001\u5f53\u524d\u8bfb\u548c\u884c\u9501\u5c31\u4e32\u8d77\u6765\u4e86\u3002</p> <p>\u4e8b\u52a1\u7684\u53ef\u91cd\u590d\u8bfb\u7684\u80fd\u529b\u662f\u600e\u4e48\u5b9e\u73b0\u7684\uff1f</p> <ul> <li>\u53ef\u91cd\u590d\u8bfb\u7684\u6838\u5fc3\u5c31\u662f\u4e00\u81f4\u6027\u8bfb\uff08consistent read\uff09\uff1b</li> <li>\u800c\u4e8b\u52a1\u66f4\u65b0\u6570\u636e\u7684\u65f6\u5019\uff0c\u53ea\u80fd\u7528\u5f53\u524d\u8bfb\u3002</li> <li>\u5982\u679c\u5f53\u524d\u7684\u8bb0\u5f55\u7684\u884c\u9501\u88ab\u5176\u4ed6\u4e8b\u52a1\u5360\u7528\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u8fdb\u5165\u9501\u7b49\u5f85\u3002</li> </ul> <p>\u800c\u8bfb\u63d0\u4ea4\u7684\u903b\u8f91\u548c\u53ef\u91cd\u590d\u8bfb\u7684\u903b\u8f91\u7c7b\u4f3c\uff0c\u5b83\u4eec\u6700\u4e3b\u8981\u7684\u533a\u522b\u662f\uff1a</p> <ul> <li>\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u53ea\u9700\u8981\u5728\u4e8b\u52a1\u5f00\u59cb\u7684\u65f6\u5019\u521b\u5efa\u4e00\u81f4\u6027\u89c6\u56fe\uff0c\u4e4b\u540e\u4e8b\u52a1\u91cc\u7684\u5176\u4ed6\u67e5\u8be2\u90fd\u5171\u7528\u8fd9\u4e2a\u4e00\u81f4\u6027\u89c6\u56fe\uff1b</li> <li>\u5728\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u6bcf\u4e00\u4e2a\u8bed\u53e5\u6267\u884c\u524d\u90fd\u4f1a\u91cd\u65b0\u7b97\u51fa\u4e00\u4e2a\u65b0\u7684\u89c6\u56fe\u3002</li> </ul> <p>\u5728\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u4e8b\u52a1 A \u548c\u4e8b\u52a1 B \u7684\u67e5\u8be2\u8bed\u53e5\u67e5\u5230\u7684 k\uff0c\u5206\u522b\u5e94\u8be5\u662f\u591a\u5c11\u5462\uff1f</p> <ul> <li><code>\u201cstart transaction with consistent snapshot; \u201d</code> \u7684\u610f\u601d\u662f\u4ece\u8fd9\u4e2a\u8bed\u53e5\u5f00\u59cb\uff0c\u521b\u5efa\u4e00\u4e2a\u6301\u7eed\u6574\u4e2a\u4e8b\u52a1\u7684\u4e00\u81f4\u6027\u5feb\u7167\u3002</li> <li>\u6240\u4ee5\uff0c\u5728\u8bfb\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u8fd9\u4e2a\u7528\u6cd5\u5c31\u6ca1\u610f\u4e49\u4e86\uff0c\u7b49\u6548\u4e8e\u666e\u901a\u7684 <code>start transaction</code>\u3002</li> </ul> <p>\u8bfb\u63d0\u4ea4\u65f6\u7684\u72b6\u6001\u56fe\uff0c\u53ef\u4ee5\u770b\u5230\u8fd9\u4e24\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u521b\u5efa\u89c6\u56fe\u6570\u7ec4\u7684\u65f6\u673a\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u5c31\u662f\u56fe\u4e2d\u7684 <code>read view</code> \u6846 (( \u6ce8\u610f\uff1a\u8fd9\u91cc\uff0c\u6211\u4eec\u7528\u7684\u8fd8\u662f\u4e8b\u52a1 <code>C</code> \u7684\u903b\u8f91\u76f4\u63a5\u63d0\u4ea4\uff0c\u800c\u4e0d\u662f\u4e8b\u52a1<code>C\u2019</code>))</p> <p></p> <p>\u8fd9\u65f6\uff0c\u4e8b\u52a1 A \u7684\u67e5\u8be2\u8bed\u53e5\u7684\u89c6\u56fe\u6570\u7ec4\u662f\u5728\u6267\u884c\u8fd9\u4e2a\u8bed\u53e5\u7684\u65f6\u5019\u521b\u5efa\u7684\uff0c\u65f6\u5e8f\u4e0a (1,2)\u3001(1,3) \u7684\u751f\u6210\u65f6\u95f4\u90fd\u5728\u521b\u5efa\u8fd9\u4e2a\u89c6\u56fe\u6570\u7ec4\u7684\u65f6\u523b\u4e4b\u524d\u3002\u4f46\u662f\uff0c\u5728\u8fd9\u4e2a\u65f6\u523b\uff1a</p> <ul> <li>(1,3) \u8fd8\u6ca1\u63d0\u4ea4\uff0c\u5c5e\u4e8e\u60c5\u51b5 1\uff0c\u4e0d\u53ef\u89c1\uff1b</li> <li>(1,2) \u63d0\u4ea4\u4e86\uff0c\u5c5e\u4e8e\u60c5\u51b5 3\uff0c\u53ef\u89c1\u3002</li> </ul> <p>\u6240\u4ee5\uff0c\u8fd9\u65f6\u5019\u4e8b\u52a1 A \u67e5\u8be2\u8bed\u53e5\u8fd4\u56de\u7684\u662f k=2\u3002 \u663e\u7136\u5730\uff0c\u4e8b\u52a1 B \u67e5\u8be2\u7ed3\u679c k=3\u3002</p>"},{"location":"chap1/6mysql_transaction_isolation/#4","title":"4\u3001\u672c\u8282\u5c0f\u7ed3","text":"<ul> <li>InnoDB \u7684\u884c\u6570\u636e\u6709\u591a\u4e2a\u7248\u672c\uff0c\u6bcf\u4e2a\u6570\u636e\u7248\u672c\u6709\u81ea\u5df1\u7684 <code>row trx_id</code>\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u6216\u8005\u8bed\u53e5\u6709\u81ea\u5df1\u7684\u4e00\u81f4\u6027\u89c6\u56fe\u3002</li> <li> <p>\u666e\u901a\u67e5\u8be2\u8bed\u53e5\u662f\u4e00\u81f4\u6027\u8bfb\uff0c\u4e00\u81f4\u6027\u8bfb\u4f1a\u6839\u636e <code>row trx_id</code> \u548c\u4e00\u81f4\u6027\u89c6\u56fe\u786e\u5b9a\u6570\u636e\u7248\u672c\u7684\u53ef\u89c1\u6027\u3002</p> </li> <li> <p>\u5bf9\u4e8e\u53ef\u91cd\u590d\u8bfb\uff0c\u67e5\u8be2\u53ea\u627f\u8ba4\u5728\u4e8b\u52a1\u542f\u52a8\u524d\u5c31\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e\uff1b</p> </li> <li>\u5bf9\u4e8e\u8bfb\u63d0\u4ea4\uff0c\u67e5\u8be2\u53ea\u627f\u8ba4\u5728\u8bed\u53e5\u542f\u52a8\u524d\u5c31\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e\uff1b</li> </ul> <p>\u800c\u5f53\u524d\u8bfb\uff0c\u603b\u662f\u8bfb\u53d6\u5df2\u7ecf\u63d0\u4ea4\u5b8c\u6210\u7684\u6700\u65b0\u7248\u672c\u3002</p> <p><code>update</code>\u548c<code>\u52a0\u9501\u7684select</code>\u90fd\u662f\u5f53\u524d\u8bfb\uff0c\u5f53\u524d\u8bfb\uff0c\u53ef\u80fd\u4f1a\u9047\u5230\u963b\u585e\u7684\u60c5\u51b5\uff0c\u83b7\u53d6\u9501\u540e\uff0c\u8bfb\u7684\u4e5f\u662f\u5df2\u63d0\u4ea4\u7684\u6700\u65b0\u7248\u672c</p> <ul> <li>\u4e3a\u4ec0\u4e48\u8868\u7ed3\u6784\u4e0d\u652f\u6301\u201c\u53ef\u91cd\u590d\u8bfb\u201d\uff1f\u8fd9\u662f\u56e0\u4e3a\u8868\u7ed3\u6784\u6ca1\u6709\u5bf9\u5e94\u7684\u884c\u6570\u636e\uff0c\u4e5f\u6ca1\u6709 row trx_id\uff0c\u56e0\u6b64\u53ea\u80fd\u9075\u5faa\u5f53\u524d\u8bfb\u7684\u903b\u8f91\u3002</li> <li>\u5f53\u7136\uff0cMySQL 8.0 \u5df2\u7ecf\u53ef\u4ee5\u628a\u8868\u7ed3\u6784\u653e\u5728 InnoDB \u5b57\u5178\u91cc\u4e86\uff0c\u4e5f\u8bb8\u4ee5\u540e\u4f1a\u652f\u6301\u8868\u7ed3\u6784\u7684\u53ef\u91cd\u590d\u8bfb\u3002</li> </ul>"},{"location":"chap1/6mysql_transaction_isolation/#4-1","title":"4-1 \u5168\u6587\u603b\u7ed3","text":"<ol> <li>innodb\u652f\u6301RC(Read commit)\u548cRR(Repeatable Read)\u9694\u79bb\u7ea7\u522b\u5b9e\u73b0\u662f\u7528\u7684\u4e00\u81f4\u6027\u89c6\u56fe(consistent read view)</li> <li>\u4e8b\u52a1\u5728\u542f\u52a8\u65f6\u4f1a\u62cd\u4e00\u4e2a\u5feb\u7167,\u8fd9\u4e2a\u5feb\u7167\u662f\u57fa\u4e8e\u6574\u4e2a\u5e93\u7684. \u57fa\u4e8e\u6574\u4e2a\u5e93\u7684\u610f\u601d\u5c31\u662f\u8bf4\u4e00\u4e2a\u4e8b\u52a1\u5185,\u6574\u4e2a\u5e93\u7684\u4fee\u6539\u5bf9\u4e8e\u8be5\u4e8b\u52a1\u90fd\u662f\u4e0d\u53ef\u89c1\u7684(\u5bf9\u4e8e\u5feb\u7167\u8bfb\u7684\u60c5\u51b5) \u5982\u679c\u5728\u4e8b\u52a1\u5185select t\u8868,\u53e6\u5916\u7684\u4e8b\u52a1\u6267\u884c\u4e86DDL t\u8868,\u6839\u636e\u53d1\u751f\u65f6\u95f4,\u8981\u561b\u9501\u4f4f\u8981\u561b\u62a5\u9519</li> <li>\u4e8b\u52a1\u662f\u5982\u4f55\u5b9e\u73b0\u7684MVCC\u5462?<ul> <li>\u6bcf\u4e2a\u4e8b\u52a1\u90fd\u6709\u4e00\u4e2a\u4e8b\u52a1ID,\u53eb\u505a<code>transaction id</code>(\u4e25\u683c\u9012\u589e)</li> <li>\u4e8b\u52a1\u5728\u542f\u52a8\u65f6,\u627e\u5230\u5df2\u63d0\u4ea4\u7684\u6700\u5927\u4e8b\u52a1ID\u8bb0\u4e3a<code>up_limit_id</code>\u3002</li> <li>\u4e8b\u52a1\u5728\u66f4\u65b0\u4e00\u6761\u8bed\u53e5\u65f6,\u6bd4\u5982<code>id=1</code>\u6539\u4e3a\u4e86<code>id=2</code>.\u4f1a\u628aid=1\u548c\u8be5\u884c\u4e4b\u524d\u7684<code>row trx_id</code>\u5199\u5230<code>undo log</code>\u91cc, \u5e76\u4e14\u5728\u6570\u636e\u9875\u4e0a\u628aid\u7684\u503c\u6539\u4e3a2,\u5e76\u4e14\u628a\u4fee\u6539\u8fd9\u6761\u8bed\u53e5\u7684<code>transaction id</code>\u8bb0\u5728\u8be5\u884c\u884c\u5934</li> <li>\u518d\u5b9a\u4e00\u4e2a\u89c4\u77e9,\u4e00\u4e2a\u4e8b\u52a1\u8981\u67e5\u770b\u4e00\u6761\u6570\u636e\u65f6,\u5fc5\u987b\u5148\u7528\u8be5\u4e8b\u52a1\u7684<code>up_limit_id</code>\u4e0e\u8be5\u884c\u7684<code>transaction id</code>\u505a\u6bd4\u5bf9,</li> <li>\u5982\u679c<code>up_limit_id&gt;=transaction id</code>,\u90a3\u4e48\u53ef\u4ee5\u770b.\u5982\u679c<code>up_limit_id&lt;transaction id</code>,\u5219\u53ea\u80fd\u53bb<code>undo log</code>\u91cc\u53bb\u53d6\u3002\u53bb<code>undo log</code>\u67e5\u627e\u6570\u636e\u7684\u65f6\u5019,\u4e5f\u9700\u8981\u505a\u6bd4\u5bf9,\u5fc5\u987b<code>up_limit_id&gt;transaction id</code>,\u624d\u8fd4\u56de\u6570\u636e</li> </ul> </li> <li>\u4ec0\u4e48\u662f\u5f53\u524d\u8bfb,\u7531\u4e8e\u5f53\u524d\u8bfb\u90fd\u662f\u5148\u8bfb\u540e\u5199,\u53ea\u80fd\u8bfb\u5f53\u524d\u7684\u503c,\u6240\u4ee5\u4e3a\u5f53\u524d\u8bfb.\u4f1a\u66f4\u65b0\u4e8b\u52a1\u5185\u7684<code>up_limit_id</code>\u4e3a\u8be5\u4e8b\u52a1\u7684<code>transaction id</code></li> <li>\u4e3a\u4ec0\u4e48rr\u80fd\u5b9e\u73b0\u53ef\u91cd\u590d\u8bfb\u800crc\u4e0d\u80fd,\u5206\u4e24\u79cd\u60c5\u51b5<ul> <li>\u5feb\u7167\u8bfb\u7684\u60c5\u51b5\u4e0b,rr\u4e0d\u80fd\u66f4\u65b0\u4e8b\u52a1\u5185\u7684<code>up_limit_id</code>, \u800crc\u6bcf\u6b21\u4f1a\u628a<code>up_limit_id</code>\u66f4\u65b0\u4e3a\u5feb\u7167\u8bfb\u4e4b\u524d\u6700\u65b0\u5df2\u63d0\u4ea4\u4e8b\u52a1\u7684<code>transaction id,</code>\u5219rc\u4e0d\u80fd\u53ef\u91cd\u590d\u8bfb</li> <li>\u5f53\u524d\u8bfb\u7684\u60c5\u51b5\u4e0b,rr\u662f\u5229\u7528<code>record lock+gap loc</code>k\u6765\u5b9e\u73b0\u7684,\u800crc\u6ca1\u6709gap,\u6240\u4ee5rc\u4e0d\u80fd\u53ef\u91cd\u590d\u8bfb</li> </ul> </li> </ol>"},{"location":"chap1/6mysql_transaction_isolation/#4-2","title":"4-2 \u601d\u8003\u9898","text":"<p>\u6211\u7528\u4e0b\u9762\u7684\u8868\u7ed3\u6784\u548c\u521d\u59cb\u5316\u8bed\u53e5\u4f5c\u4e3a\u8bd5\u9a8c\u73af\u5883\uff0c\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u662f\u53ef\u91cd\u590d\u8bfb\u3002\u73b0\u5728\uff0c\u6211\u8981\u628a\u6240\u6709\u201c\u5b57\u6bb5 c \u548c id \u503c\u76f8\u7b49\u7684\u884c\u201d\u7684 c \u503c\u6e05\u96f6\uff0c\u4f46\u662f\u5374\u53d1\u73b0\u4e86\u4e00\u4e2a\u201c\u8be1\u5f02\u201d\u7684\u3001\u6539\u4e0d\u6389\u7684\u60c5\u51b5\u3002\u8bf7\u4f60\u6784\u9020\u51fa\u8fd9\u79cd\u60c5\u51b5\uff0c\u5e76\u8bf4\u660e\u5176\u539f\u7406\u3002</p> <pre><code>mysql&gt; CREATE TABLE `t` ( \n    `id` int(11) NOT NULL, \n    `c` int(11) DEFAULT NULL, \n    PRIMARY KEY (`id`)\n    ) ENGINE=InnoDB;\n\n\ninsert into t(id, c) values(1,1),(2,2),(3,3),(4,4);\n</code></pre> <p></p> <p></p> <p></p>"},{"location":"chap1/mysql1_innodb/","title":"\u7b2c\u4e03\u8282 \"Shallow Dive\" MySQL \u548c InnoDB","text":"<ul> <li>\u6570\u636e\u5e93\u7684\u5b9a\u4e49</li> <li>MySQL \u7684\u67b6\u6784</li> <li>\u6570\u636e\u7684\u5b58\u50a8</li> <li>\u5982\u4f55\u5b58\u50a8\u8868</li> <li>\u5982\u4f55\u5b58\u50a8\u8bb0\u5f55</li> <li>\u884c\u6ea2\u51fa\u6570\u636e</li> <li>\u6570\u636e\u9875\u7ed3\u6784</li> <li>\u7d22\u5f15</li> <li>\u805a\u96c6\u7d22\u5f15\u548c\u8f85\u52a9\u7d22\u5f15</li> <li>\u9501</li> <li>\u9501\u7684\u7b97\u6cd5</li> <li>\u4e8b\u52a1\u4e0e\u9694\u79bb\u7ea7\u522b</li> </ul> <p>\u4f5c\u4e3a\u4e00\u540d\u5f00\u53d1\u4eba\u5458\uff0c\u5728\u65e5\u5e38\u7684\u5de5\u4f5c\u4e2d\u4f1a\u96be\u4ee5\u907f\u514d\u5730\u63a5\u89e6\u5230\u6570\u636e\u5e93\uff0c\u65e0\u8bba\u662f\u57fa\u4e8e\u6587\u4ef6\u7684 sqlite \u8fd8\u662f\u5de5\u7a0b\u4e0a\u4f7f\u7528\u975e\u5e38\u5e7f\u6cdb\u7684 MySQL\u3001PostgreSQL.</p> <p>\u672c\u6587\u4e2d\u5bf9\u4e8e\u6570\u636e\u5e93\u7684\u4ecb\u7ecd\u4ee5\u53ca\u7814\u7a76\u90fd\u662f\u5728 MySQL \u4e0a\u8fdb\u884c\u7684\uff0c\u5982\u679c\u6d89\u53ca\u5230\u4e86\u5176\u4ed6\u6570\u636e\u5e93\u7684\u5185\u5bb9\u6216\u8005\u5b9e\u73b0\u4f1a\u5728\u6587\u4e2d\u5355\u72ec\u6307\u51fa\u3002</p>"},{"location":"chap1/mysql1_innodb/#1","title":"1 \u6570\u636e\u5e93\u7684\u5b9a\u4e49","text":"<p>\u5f88\u591a\u5f00\u53d1\u8005\u5728\u6700\u5f00\u59cb\u65f6\u5176\u5b9e\u90fd\u5bf9\u6570\u636e\u5e93\u6709\u4e00\u4e2a\u6bd4\u8f83\u6a21\u7cca\u7684\u8ba4\u8bc6\uff0c\u89c9\u5f97\u6570\u636e\u5e93\u5c31\u662f\u4e00\u5806\u6570\u636e\u7684\u96c6\u5408\uff0c\u4f46\u662f\u5b9e\u9645\u5374\u6bd4\u8fd9\u590d\u6742\u7684\u591a\uff0c\u6570\u636e\u5e93\u9886\u57df\u4e2d\u6709\u4e24\u4e2a\u8bcd\u975e\u5e38\u5bb9\u6613\u6df7\u6dc6\uff0c\u4e5f\u5c31\u662f\u6570\u636e\u5e93\u548c\u5b9e\u4f8b\uff1a</p> <ul> <li>\u6570\u636e\u5e93\uff1a\u7269\u7406\u64cd\u4f5c\u6587\u4ef6\u7cfb\u7edf\u6216\u5176\u4ed6\u5f62\u5f0f\u6587\u4ef6\u7c7b\u578b\u7684\u96c6\u5408\uff1b</li> <li>\u5b9e\u4f8b\uff1a<code>MySQL</code> \u6570\u636e\u5e93\u7531\u540e\u53f0\u7ebf\u7a0b\u4ee5\u53ca\u4e00\u4e2a\u5171\u4eab\u5185\u5b58\u533a\u7ec4\u6210\uff1b</li> </ul>"},{"location":"chap1/mysql1_innodb/#1-1","title":"1-1 \u6570\u636e\u5e93\u548c\u5b9e\u4f8b","text":"<p>\u5728 <code>MySQL</code> \u4e2d\uff0c\u5b9e\u4f8b\u548c\u6570\u636e\u5e93\u5f80\u5f80\u90fd\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\uff0c\u800c\u6211\u4eec\u4e5f\u65e0\u6cd5\u76f4\u63a5\u64cd\u4f5c\u6570\u636e\u5e93\uff0c\u800c\u662f\u8981\u901a\u8fc7\u6570\u636e\u5e93\u5b9e\u4f8b\u6765\u64cd\u4f5c\u6570\u636e\u5e93\u6587\u4ef6\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u6570\u636e\u5e93\u5b9e\u4f8b\u662f\u6570\u636e\u5e93\u4e3a\u4e0a\u5c42\u63d0\u4f9b\u7684\u4e00\u4e2a\u4e13\u95e8\u7528\u4e8e\u64cd\u4f5c\u7684\u63a5\u53e3\u3002</p> <p></p> <p>\u5728 <code>Unix</code> \u4e0a\uff0c\u542f\u52a8\u4e00\u4e2a <code>MySQL</code> \u5b9e\u4f8b\u5f80\u5f80\u4f1a\u4ea7\u751f\u4e24\u4e2a\u8fdb\u7a0b\uff0c</p> <ul> <li><code>mysqld</code> \u5c31\u662f\u771f\u6b63\u7684\u6570\u636e\u5e93\u670d\u52a1\u5b88\u62a4\u8fdb\u7a0b</li> <li>\u800c <code>mysqld_safe</code> \u662f\u4e00\u4e2a\u7528\u4e8e\u68c0\u67e5\u548c\u8bbe\u7f6e <code>mysqld</code> \u542f\u52a8\u7684\u63a7\u5236\u7a0b\u5e8f\uff0c\u5b83\u8d1f\u8d23\u76d1\u63a7 MySQL \u8fdb\u7a0b\u7684\u6267\u884c\uff0c\u5f53 <code>mysqld</code> \u53d1\u751f\u9519\u8bef\u65f6\uff0c<code>mysqld_safe</code> \u4f1a\u5bf9\u5176\u72b6\u6001\u8fdb\u884c\u68c0\u67e5\u5e76\u5728\u5408\u9002\u7684\u6761\u4ef6\u4e0b\u91cd\u542f\u3002</li> </ul>"},{"location":"chap1/mysql1_innodb/#2-mysql","title":"2 MySQL \u7684\u67b6\u6784","text":"<p>MySQL \u4ece\u7b2c\u4e00\u4e2a\u7248\u672c\u53d1\u5e03\u5230\u73b0\u5728\u5df2\u7ecf\u6709\u4e86 20 \u591a\u5e74\u7684\u5386\u53f2\uff0c\u5728\u8fd9\u4e48\u591a\u5e74\u7684\u53d1\u5c55\u548c\u6f14\u53d8\u4e2d\uff0c\u6574\u4e2a\u5e94\u7528\u7684\u4f53\u7cfb\u7ed3\u6784\u53d8\u5f97\u8d8a\u6765\u8d8a\u590d\u6742\uff1a</p> <p></p> <ul> <li>\u6700\u4e0a\u5c42\u7528\u4e8e\u8fde\u63a5\u3001\u7ebf\u7a0b\u5904\u7406\u7684\u90e8\u5206\u5e76\u4e0d\u662f MySQL \u300e\u53d1\u660e\u300f\u7684\uff0c\u5f88\u591a\u670d\u52a1\u90fd\u6709\u7c7b\u4f3c\u7684\u7ec4\u6210\u90e8\u5206\uff1b</li> <li>\u7b2c\u4e8c\u5c42\u4e2d\u5305\u542b\u4e86\u5927\u591a\u6570 MySQL \u7684\u6838\u5fc3\u670d\u52a1\uff0c\u5305\u62ec\u4e86\u5bf9 <code>SQL</code> \u7684\u89e3\u6790\u3001\u5206\u6790\u3001\u4f18\u5316\u548c\u7f13\u5b58\u7b49\u529f\u80fd\uff0c\u5b58\u50a8\u8fc7\u7a0b\u3001\u89e6\u53d1\u5668\u548c\u89c6\u56fe\u90fd\u662f\u5728\u8fd9\u91cc\u5b9e\u73b0\u7684\uff1b</li> <li>\u800c\u7b2c\u4e09\u5c42\u5c31\u662f <code>MySQL</code> \u4e2d\u771f\u6b63\u8d1f\u8d23\u6570\u636e\u7684\u5b58\u50a8\u548c\u63d0\u53d6\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u4f8b\u5982\uff1a<code>InnoDB</code>\u3001<code>MyISAM</code> \u7b49\uff0c\u6587\u4e2d\u5bf9\u5b58\u50a8\u5f15\u64ce\u7684\u4ecb\u7ecd\u90fd\u662f\u5bf9 <code>InnoDB</code> \u5b9e\u73b0\u7684\u5206\u6790\u3002</li> </ul>"},{"location":"chap1/mysql1_innodb/#3","title":"3 \u6570\u636e\u7684\u5b58\u50a8","text":"<p>\u5728\u6574\u4e2a\u6570\u636e\u5e93\u4f53\u7cfb\u7ed3\u6784\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u7684\u5b58\u50a8\u5f15\u64ce\u6765\u5b58\u50a8\u6570\u636e\uff0c\u800c\u7edd\u5927\u591a\u6570\u5b58\u50a8\u5f15\u64ce\u90fd\u4ee5\u4e8c\u8fdb\u5236\u7684\u5f62\u5f0f\u5b58\u50a8\u6570\u636e\uff1b\u8fd9\u4e00\u8282\u4f1a\u4ecb\u7ecd InnoDB \u4e2d\u5bf9\u6570\u636e\u662f\u5982\u4f55\u5b58\u50a8\u7684\u3002</p> <p>\u5728 <code>InnoDB</code> \u5b58\u50a8\u5f15\u64ce\u4e2d\uff0c\u6240\u6709\u7684\u6570\u636e\u90fd\u88ab\u903b\u8f91\u5730\u5b58\u653e\u5728\u8868\u7a7a\u95f4\u4e2d\uff0c\u8868\u7a7a\u95f4\uff08<code>tablespace</code>\uff09\u662f\u5b58\u50a8\u5f15\u64ce\u4e2d\u6700\u9ad8\u7684\u5b58\u50a8\u903b\u8f91\u5355\u4f4d\uff0c\u5728\u8868\u7a7a\u95f4\u7684\u4e0b\u9762\u53c8\u5305\u62ec\u6bb5\uff08<code>segment</code>\uff09\u3001\u533a\uff08<code>extent</code>\uff09\u3001\u9875\uff08<code>page</code>\uff09</p> <p></p> <p>\u540c\u4e00\u4e2a\u6570\u636e\u5e93\u5b9e\u4f8b\u7684\u6240\u6709\u8868\u7a7a\u95f4\u90fd\u6709\u76f8\u540c\u7684\u9875\u5927\u5c0f\uff1b</p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8868\u7a7a\u95f4\u4e2d\u7684\u9875\u5927\u5c0f\u90fd\u4e3a <code>16KB</code>\uff0c\u5f53\u7136\u4e5f\u53ef\u4ee5\u901a\u8fc7\u6539\u53d8 <code>innodb_page_size</code> \u9009\u9879\u5bf9\u9ed8\u8ba4\u5927\u5c0f\u8fdb\u884c\u4fee\u6539\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u4e0d\u540c\u7684\u9875\u5927\u5c0f\u6700\u7ec8\u4e5f\u4f1a\u5bfc\u81f4\u533a\u5927\u5c0f\u7684\u4e0d\u540c\uff1a</p> <p></p> <p>\u4ece\u56fe\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c\u5728 <code>InnoDB</code> \u5b58\u50a8\u5f15\u64ce\u4e2d\uff0c\u4e00\u4e2a\u533a\u7684\u5927\u5c0f\u6700\u5c0f\u4e3a <code>1MB</code>\uff0c\u9875\u7684\u6570\u91cf\u6700\u5c11\u4e3a <code>64</code> \u4e2a\u3002</p>"},{"location":"chap1/mysql1_innodb/#4","title":"4 \u5982\u4f55\u5b58\u50a8\u8868","text":"<p>MySQL \u4f7f\u7528 <code>InnoDB</code> \u5b58\u50a8\u8868\u65f6\uff0c\u4f1a\u5c06\u8868\u7684\u5b9a\u4e49\u548c\u6570\u636e\u7d22\u5f15\u7b49\u4fe1\u606f\u5206\u5f00\u5b58\u50a8\uff0c\u5176\u4e2d\u524d\u8005\u5b58\u50a8\u5728 <code>.frm</code> \u6587\u4ef6\u4e2d\uff0c\u540e\u8005\u5b58\u50a8\u5728 <code>.ibd</code> \u6587\u4ef6\u4e2d\uff0c\u8fd9\u4e00\u8282\u5c31\u4f1a\u5bf9\u8fd9\u4e24\u79cd\u4e0d\u540c\u7684\u6587\u4ef6\u5206\u522b\u8fdb\u884c\u4ecb\u7ecd\u3002</p> <p></p>"},{"location":"chap1/mysql1_innodb/#4-1-frm-for","title":"4-1 <code>.frm \u6587\u4ef6</code> for \u8868\u7684\u5b9a\u4e49","text":"<p>\u65e0\u8bba\u5728 <code>MySQL</code> \u4e2d\u9009\u62e9\u4e86\u54ea\u4e2a\u5b58\u50a8\u5f15\u64ce\uff0c\u6240\u6709\u7684<code>MySQL</code> \u8868\u90fd\u4f1a\u5728\u786c\u76d8\u4e0a\u521b\u5efa\u4e00\u4e2a <code>.frm</code>\u6587\u4ef6\u7528\u6765\u63cf\u8ff0\u8868\u7684\u683c\u5f0f\u6216\u8005\u8bf4\u5b9a\u4e49\uff1b<code>.frm</code> \u6587\u4ef6\u7684\u683c\u5f0f\u5728\u4e0d\u540c\u7684\u5e73\u53f0\u4e0a\u90fd\u662f\u76f8\u540c\u7684\u3002</p> <pre><code>CREATE TABLE test_frm(\n    column1 CHAR(5),\n    column2 INTEGER\n);\n</code></pre> <p>\u5f53\u6211\u4eec\u4f7f\u7528\u4e0a\u9762\u7684\u4ee3\u7801\u521b\u5efa\u8868\u65f6\uff0c\u4f1a\u5728\u78c1\u76d8\u4e0a\u7684 <code>datadir</code> \u6587\u4ef6\u5939\u4e2d\u751f\u6210\u4e00\u4e2a <code>test_frm.frm</code> \u7684\u6587\u4ef6\uff0c\u8fd9\u4e2a\u6587\u4ef6\u4e2d\u5c31\u5305\u542b\u4e86\u8868\u7ed3\u6784\u76f8\u5173\u7684\u4fe1\u606f\uff1a</p> <p></p>"},{"location":"chap1/mysql1_innodb/#4-2-ibd-for","title":"4-2 <code>.ibd</code> \u6587\u4ef6 for \u6570\u636e\u7d22\u5f15","text":"<p><code>InnoDB</code> \u4e2d\u7528\u4e8e\u5b58\u50a8\u6570\u636e\u7684\u6587\u4ef6\u603b\u5171\u6709\u4e24\u4e2a\u90e8\u5206\uff0c\u4e00\u662f\u7cfb\u7edf\u8868\u7a7a\u95f4\u6587\u4ef6\uff0c\u5305\u62ec <code>ibdata1</code>\u3001<code>ibdata2</code> \u7b49\u6587\u4ef6\uff0c\u5176\u4e2d\u5b58\u50a8\u4e86 <code>InnoDB</code> \u7cfb\u7edf\u4fe1\u606f\u548c\u7528\u6237\u6570\u636e\u5e93\u8868\u6570\u636e\u548c\u7d22\u5f15\uff0c\u662f\u6240\u6709\u8868\u516c\u7528\u7684\u3002</p>"},{"location":"chap1/mysql1_innodb/#5","title":"5 \u5982\u4f55\u5b58\u50a8\u8bb0\u5f55","text":"<p>\u4e0e\u73b0\u6709\u7684\u5927\u591a\u6570\u5b58\u50a8\u5f15\u64ce\u4e00\u6837\uff0c<code>InnoDB</code> \u4f7f\u7528\u9875\u4f5c\u4e3a\u78c1\u76d8\u7ba1\u7406\u7684\u6700\u5c0f\u5355\u4f4d\uff1b</p> <p>\u6570\u636e\u5728 <code>InnoDB</code> \u5b58\u50a8\u5f15\u64ce\u4e2d\u90fd\u662f\u6309\u884c\u5b58\u50a8\u7684\uff0c\u6bcf\u4e2a <code>16KB</code> \u5927\u5c0f\u7684\u9875\u4e2d\u53ef\u4ee5\u5b58\u653e <code>2-200</code> \u884c\u7684\u8bb0\u5f55\u3002</p> <p>\u5f53 InnoDB \u5b58\u50a8\u6570\u636e\u65f6\uff0c\u5b83\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u7684\u884c\u683c\u5f0f\u8fdb\u884c\u5b58\u50a8\uff1bMySQL 5.7 \u7248\u672c\u652f\u6301\u4ee5\u4e0b\u683c\u5f0f\u7684\u884c\u5b58\u50a8\u65b9\u5f0f\uff1a</p> <p></p> <p><code>Antelope</code> \u662f <code>InnoDB</code> \u6700\u5f00\u59cb\u652f\u6301\u7684\u6587\u4ef6\u683c\u5f0f\uff0c\u5b83\u5305\u542b\u4e24\u79cd\u884c\u683c\u5f0f <code>Compact</code> \u548c <code>Redundant</code>\uff0c\u5b83\u6700\u5f00\u59cb\u5e76\u6ca1\u6709\u540d\u5b57\uff1b</p> <p><code>Antelope</code> \u7684\u540d\u5b57\u662f\u5728\u65b0\u7684\u6587\u4ef6\u683c\u5f0f <code>Barracuda</code> \u51fa\u73b0\u540e\u624d\u8d77\u7684\uff0c<code>Barracuda</code> \u7684\u51fa\u73b0\u5f15\u5165\u4e86\u4e24\u79cd\u65b0\u7684\u884c\u683c\u5f0f <code>Compressed</code> \u548c <code>Dynamic</code>\uff1b</p> <p><code>InnoDB</code> \u5bf9\u4e8e\u6587\u4ef6\u683c\u5f0f\u90fd\u4f1a\u5411\u524d\u517c\u5bb9\uff0c\u800c\u5b98\u65b9\u6587\u6863\u4e2d\u4e5f\u5bf9\u4e4b\u540e\u4f1a\u51fa\u73b0\u7684\u65b0\u6587\u4ef6\u683c\u5f0f\u9884\u5148\u5b9a\u4e49\u597d\u4e86\u540d\u5b57\uff1a<code>Cheetah</code>\u3001<code>Dragon</code>\u3001<code>Elk</code> \u7b49\u7b49\u3002</p> <p>\u4e24\u79cd\u884c\u8bb0\u5f55\u683c\u5f0f <code>Compact</code> \u548c <code>Redundant</code> \u5728\u78c1\u76d8\u4e0a\u6309\u7167\u4ee5\u4e0b\u65b9\u5f0f\u5b58\u50a8\uff1a</p> <p></p> <p><code>Compact</code> \u548c <code>Redundant</code> \u683c\u5f0f\u6700\u5927\u7684\u4e0d\u540c\u5c31\u662f\u8bb0\u5f55\u683c\u5f0f\u7684\u7b2c\u4e00\u4e2a\u90e8\u5206\uff1b</p> <ul> <li>\u5728 <code>Compact</code> \u4e2d\uff0c\u884c\u8bb0\u5f55\u7684\u7b2c\u4e00\u90e8\u5206\u5012\u5e8f\u5b58\u653e\u4e86\u4e00\u884c\u6570\u636e\u4e2d\u5217\u7684\u957f\u5ea6\uff08<code>Length</code>\uff09\uff0c</li> <li>\u800c <code>Redundant</code> \u4e2d\u5b58\u7684\u662f\u6bcf\u4e00\u5217\u7684\u504f\u79fb\u91cf\uff08<code>Offset</code>\uff09</li> </ul> <p>\u4ece\u603b\u4f53\u4e0a\u4e0a\u770b\uff0c<code>Compact</code> \u884c\u8bb0\u5f55\u683c\u5f0f\u76f8\u6bd4 <code>Redundant</code> \u683c\u5f0f\u80fd\u591f\u51cf\u5c11 <code>20%</code> \u7684\u5b58\u50a8\u7a7a\u95f4\u3002</p>"},{"location":"chap1/mysql1_innodb/#6","title":"6 \u884c\u6ea2\u51fa\u6570\u636e","text":"<p>\u5f53 <code>InnoDB</code> \u4f7f\u7528 <code>Compact</code> \u6216\u8005 <code>Redundant</code> \u683c\u5f0f\u5b58\u50a8\u6781\u957f\u7684 <code>VARCHAR</code> \u6216\u8005 <code>BLOB</code> \u8fd9\u7c7b\u5927\u5bf9\u8c61\u65f6\uff0c\u6211\u4eec\u5e76\u4e0d\u4f1a\u76f4\u63a5\u5c06\u6240\u6709\u7684\u5185\u5bb9\u90fd\u5b58\u653e\u5728\u6570\u636e\u9875\u8282\u70b9\u4e2d\uff0c\u800c\u662f\u5c06\u884c\u6570\u636e\u4e2d\u7684\u524d <code>768</code> \u4e2a\u5b57\u8282\u5b58\u50a8\u5728\u6570\u636e\u9875\u4e2d\uff0c\u540e\u9762\u4f1a\u901a\u8fc7\u504f\u79fb\u91cf\u6307\u5411\u6ea2\u51fa\u9875\u3002</p> <p></p> <p>\u4f46\u662f\u5f53\u6211\u4eec\u4f7f\u7528\u65b0\u7684\u884c\u8bb0\u5f55\u683c\u5f0f <code>Compressed</code> \u6216\u8005 <code>Dynamic</code> \u65f6\u90fd\u53ea\u4f1a\u5728\u884c\u8bb0\u5f55\u4e2d\u4fdd\u5b58 <code>20</code> \u4e2a\u5b57\u8282\u7684\u6307\u9488\uff0c\u5b9e\u9645\u7684\u6570\u636e\u90fd\u4f1a\u5b58\u653e\u5728\u6ea2\u51fa\u9875\u9762\u4e2d\u3002</p> <p></p> <p>\u5f53\u7136\u5728\u5b9e\u9645\u5b58\u50a8\u4e2d\uff0c\u53ef\u80fd\u4f1a\u5bf9\u4e0d\u540c\u957f\u5ea6\u7684 <code>TEXT</code> \u548c <code>BLOB</code> \u5217\u8fdb\u884c\u4f18\u5316\uff0c\u4e0d\u8fc7\u8fd9\u5c31\u4e0d\u662f\u672c\u6587\u5173\u6ce8\u7684\u91cd\u70b9\u4e86\u3002</p>"},{"location":"chap1/mysql1_innodb/#7","title":"7 \u6570\u636e\u9875\u7ed3\u6784","text":"<ul> <li>\u9875(<code>Page</code>)\u662f <code>InnoDB</code> \u5b58\u50a8\u5f15\u64ce\u7ba1\u7406\u6570\u636e\u7684\u6700\u5c0f\u78c1\u76d8\u5355\u4f4d\uff0c</li> <li>\u800c <code>B-Tree</code> \u8282\u70b9\u5c31\u662f\u5b9e\u9645\u5b58\u653e\u8868\u4e2d\u6570\u636e\u7684\u9875\u9762\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u5c06\u8981\u4ecb\u7ecd\u9875\u662f\u5982\u4f55\u7ec4\u7ec7\u548c\u5b58\u50a8\u8bb0\u5f55\u7684\uff1b</li> </ul> <p>\u9996\u5148\uff0c\u4e00\u4e2a <code>InnoDB</code> \u9875\u6709\u4ee5\u4e0b\u4e03\u4e2a\u90e8\u5206\uff1a</p> <p></p>"},{"location":"chap1/mysql1_innodb/#1-fil-headerfil-trailer-page-headerpage-directory","title":"1. <code>Fil Header/Fil Trailer</code> / <code>Page Header/Page Directory</code>","text":"<ul> <li>\u6bcf\u4e00\u4e2a\u9875\u4e2d\u5305\u542b\u4e86\u4e24\u5bf9 <code>header/trailer</code>\uff1a</li> <li>\u5185\u90e8\u7684 <code>Page Header/Page Directory</code> \u5173\u5fc3\u7684\u662f\u9875\u7684\u72b6\u6001\u4fe1\u606f</li> <li>\u800c <code>Fil Header/Fil Trailer</code> \u5173\u5fc3\u7684\u662f\u8bb0\u5f55\u9875\u7684\u5934\u4fe1\u606f\u3002</li> </ul>"},{"location":"chap1/mysql1_innodb/#2-infimum-supremum","title":"2. <code>Infimum</code> / <code>Supremum</code>","text":"<p>\u5728\u9875\u7684\u5934\u90e8\u548c\u5c3e\u90e8\u4e4b\u95f4\u5c31\u662f\u7528\u6237\u8bb0\u5f55\u548c\u7a7a\u95f2\u7a7a\u95f4\u4e86\uff0c\u6bcf\u4e00\u4e2a\u6570\u636e\u9875\u4e2d\u90fd\u5305\u542b <code>Infimum</code> \u548c <code>Supremum</code> \u8fd9\u4e24\u4e2a\u865a\u62df\u7684\u8bb0\u5f55\uff08\u53ef\u4ee5\u7406\u89e3\u4e3a\u5360\u4f4d\u7b26\uff09\uff0c</p> <ul> <li><code>Infimum</code> \u8bb0\u5f55\u662f\u6bd4\u8be5\u9875\u4e2d\u4efb\u4f55\u4e3b\u952e\u503c\u90fd\u8981\u5c0f\u7684\u503c</li> <li><code>Supremum</code> \u662f\u8be5\u9875\u4e2d\u7684\u6700\u5927\u503c</li> </ul> <p></p>"},{"location":"chap1/mysql1_innodb/#3-user-records-free-space","title":"3. <code>User Records</code> / <code>Free Space</code>","text":"<ul> <li><code>User Records</code> \u5c31\u662f\u6574\u4e2a\u9875\u9762\u4e2d\u771f\u6b63\u7528\u4e8e\u5b58\u653e\u884c\u8bb0\u5f55\u7684\u90e8\u5206\uff0c</li> <li><code>Free Space</code> \u5c31\u662f\u7a7a\u4f59\u7a7a\u95f4\u4e86\uff0c\u5b83\u662f\u4e00\u4e2a\u94fe\u8868\u7684\u6570\u636e\u7ed3\u6784\uff0c</li> </ul> <p>\u4e3a\u4e86\u4fdd\u8bc1\u63d2\u5165\u548c\u5220\u9664\u7684\u6548\u7387\uff0c\u6574\u4e2a\u9875\u9762\u5e76\u4e0d\u4f1a\u6309\u7167\u4e3b\u952e\u987a\u5e8f\u5bf9\u6240\u6709\u8bb0\u5f55\u8fdb\u884c\u6392\u5e8f\uff0c\u5b83\u4f1a\u81ea\u52a8\u4ece\u5de6\u4fa7\u5411\u53f3\u5bfb\u627e\u7a7a\u767d\u8282\u70b9\u8fdb\u884c\u63d2\u5165\uff0c\u884c\u8bb0\u5f55\u5728\u7269\u7406\u5b58\u50a8\u4e0a\u5e76\u4e0d\u662f\u6309\u7167\u987a\u5e8f\u7684\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684\u987a\u5e8f\u662f\u7531 <code>next_record</code> \u8fd9\u4e00\u6307\u9488\u63a7\u5236\u7684\u3002</p> <p>InnoDB \u5b58\u50a8\u5f15\u64ce\u4e2d\u5bf9\u6570\u636e\u7684\u5b58\u50a8\u662f\u4e00\u4e2a\u975e\u5e38\u590d\u6742\u7684\u8bdd\u9898\uff0c\u8fd9\u4e00\u8282\u4e2d\u4e5f\u53ea\u662f\u5bf9\u8868\u3001\u884c\u8bb0\u5f55\u4ee5\u53ca\u9875\u9762\u7684\u5b58\u50a8\u8fdb\u884c\u4e00\u5b9a\u7684\u5206\u6790\u548c\u4ecb\u7ecd\uff0c\u867d\u7136\u4f5c\u8005\u76f8\u4fe1\u8fd9\u90e8\u5206\u77e5\u8bc6\u5bf9\u4e8e\u5927\u90e8\u5206\u5f00\u53d1\u8005\u5df2\u7ecf\u8db3\u591f\u4e86\uff0c\u4f46\u662f\u60f3\u8981\u771f\u6b63\u6d88\u5316\u8fd9\u90e8\u5206\u5185\u5bb9\u8fd8\u9700\u8981\u5f88\u591a\u7684\u52aa\u529b\u548c\u5b9e\u8df5\u3002</p>"},{"location":"chap1/mysql1_innodb/#8","title":"8 \u7d22\u5f15","text":"<p>\u7d22\u5f15\u662f\u6570\u636e\u5e93\u4e2d\u975e\u5e38\u975e\u5e38\u91cd\u8981\u7684\u6982\u5ff5\uff0c\u5b83\u662f\u5b58\u50a8\u5f15\u64ce\u80fd\u591f\u5feb\u901f\u5b9a\u4f4d\u8bb0\u5f55\u7684\u79d8\u5bc6\u6b66\u5668\uff0c\u5bf9\u4e8e\u63d0\u5347\u6570\u636e\u5e93\u7684\u6027\u80fd\u3001\u51cf\u8f7b\u6570\u636e\u5e93\u670d\u52a1\u5668\u7684\u8d1f\u62c5\u6709\u7740\u975e\u5e38\u91cd\u8981\u7684\u4f5c\u7528\uff1b\u7d22\u5f15\u4f18\u5316\u662f\u5bf9\u67e5\u8be2\u6027\u80fd\u4f18\u5316\u7684\u6700\u6709\u6548\u624b\u6bb5\uff0c\u5b83\u80fd\u591f\u8f7b\u677e\u5730\u5c06\u67e5\u8be2\u7684\u6027\u80fd\u63d0\u9ad8\u51e0\u4e2a\u6570\u91cf\u7ea7\u3002</p>"},{"location":"chap1/mysql1_innodb/#9","title":"9 \u7d22\u5f15\u7684\u6570\u636e\u7ed3\u6784","text":"<p>\u5728\u4e0a\u4e00\u8282\u4e2d\uff0c\u6211\u4eec\u8c08\u4e86\u884c\u8bb0\u5f55\u7684\u5b58\u50a8\u548c\u9875\u7684\u5b58\u50a8\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u5c31\u8981\u4ece\u66f4\u9ad8\u7684\u5c42\u9762\u770b InnoDB \u4e2d\u5bf9\u4e8e\u6570\u636e\u662f\u5982\u4f55\u5b58\u50a8\u7684\uff1b</p> <p><code>InnoDB</code> \u5b58\u50a8\u5f15\u64ce\u5728\u7edd\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u4f7f\u7528 <code>B+</code> \u6811\u5efa\u7acb\u7d22\u5f15\uff0c\u8fd9\u662f\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u67e5\u627e\u6700\u4e3a\u5e38\u7528\u548c\u6709\u6548\u7684\u7d22\u5f15</p> <p>\u4f46\u662f <code>B+</code> \u6811\u7d22\u5f15\u5e76\u4e0d\u80fd\u627e\u5230\u4e00\u4e2a\u7ed9\u5b9a\u952e\u5bf9\u5e94\u7684\u5177\u4f53\u503c\uff0c\u5b83\u53ea\u80fd\u627e\u5230\u6570\u636e\u884c\u5bf9\u5e94\u7684\u9875\uff0c\u7136\u540e\u6b63\u5982\u4e0a\u4e00\u8282\u6240\u63d0\u5230\u7684\uff0c\u6570\u636e\u5e93\u628a\u6574\u4e2a\u9875\u8bfb\u5165\u5230\u5185\u5b58\u4e2d\uff0c\u5e76\u5728\u5185\u5b58\u4e2d\u67e5\u627e\u5177\u4f53\u7684\u6570\u636e\u884c\u3002</p> <p></p>"},{"location":"chap1/mysql1_innodb/#b-b","title":"<code>B+</code> \u6811\u662f\u5e73\u8861\u6811\uff0c\u5b83\u67e5\u627e\u4efb\u610f\u8282\u70b9\u6240\u8017\u8d39\u7684\u65f6\u95f4\u90fd\u662f\u5b8c\u5168\u76f8\u540c\u7684\uff0c\u6bd4\u8f83\u7684\u6b21\u6570\u5c31\u662f <code>B+</code> \u6811\u7684\u9ad8\u5ea6\uff1b\ud83d\ude0d","text":"<p>\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u5e76\u4e0d\u4f1a\u6df1\u5165\u5206\u6790\u6216\u8005\u52a8\u624b\u5b9e\u73b0\u4e00\u4e2a B+ \u6811\uff0c\u53ea\u662f\u5bf9\u5b83\u7684\u7279\u6027\u8fdb\u884c\u7b80\u5355\u7684\u4ecb\u7ecd\u3002</p>"},{"location":"chap1/mysql1_innodb/#10","title":"10 \u805a\u96c6\u7d22\u5f15\u548c\u8f85\u52a9\u7d22\u5f15","text":"<p>\u6570\u636e\u5e93\u4e2d\u7684 <code>B+</code> \u6811\u7d22\u5f15\u53ef\u4ee5\u5206\u4e3a\u805a\u96c6\u7d22\u5f15\uff08<code>clustered index</code>\uff09\u548c\u8f85\u52a9\u7d22\u5f15\uff08<code>secondary index</code>\uff09\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684\u6700\u5927\u533a\u522b\u5c31\u662f: </p> <ul> <li>\u805a\u96c6\u7d22\u5f15\u4e2d\u5b58\u653e\u7740\u4e00\u6761\u884c\u8bb0\u5f55\u7684\u5168\u90e8\u4fe1\u606f</li> <li>\u8f85\u52a9\u7d22\u5f15\u4e2d\u53ea\u5305\u542b\u7d22\u5f15\u5217\u548c\u4e00\u4e2a\u7528\u4e8e\u67e5\u627e\u5bf9\u5e94\u884c\u8bb0\u5f55\u7684\u300e\u4e66\u7b7e\u300f</li> </ul>"},{"location":"chap1/mysql1_innodb/#10-1","title":"10-1 \u805a\u96c6\u7d22\u5f15","text":"<p><code>InnoDB</code> \u5b58\u50a8\u5f15\u64ce\u4e2d\u7684\u8868\u90fd\u662f\u4f7f\u7528\u7d22\u5f15\u7ec4\u7ec7\u7684\uff0c\u4e5f\u5c31\u662f\u6309\u7167\u952e\u7684\u987a\u5e8f\u5b58\u653e\uff1b</p> <p>\u805a\u96c6\u7d22\u5f15\u5c31\u662f\u6309\u7167\u8868\u4e2d\u4e3b\u952e\u7684\u987a\u5e8f\u6784\u5efa\u4e00\u9897 <code>B+</code> \u6811\uff0c\u5e76\u5728\u53f6\u8282\u70b9\u4e2d\u5b58\u653e\u8868\u4e2d\u7684\u884c\u8bb0\u5f55\u6570\u636e\u3002</p> <pre><code>CREATE TABLE users(\n    id INT NOT NULL,\n    first_name VARCHAR(20) NOT NULL,\n    last_name VARCHAR(20) NOT NULL,\n    age INT NOT NULL,\n    PRIMARY KEY(id),\n    KEY(last_name, first_name, age)\n    KEY(first_name)\n);\n</code></pre> <p>\u5982\u679c\u4f7f\u7528\u4e0a\u9762\u7684 <code>SQL</code> \u5728\u6570\u636e\u5e93\u4e2d\u521b\u5efa\u4e00\u5f20\u8868\uff0c<code>B+</code> \u6811\u5c31\u4f1a\u4f7f\u7528 <code>id</code> \u4f5c\u4e3a\u7d22\u5f15\u7684\u952e\uff0c\u5e76\u5728\u53f6\u5b50\u8282\u70b9\u4e2d\u5b58\u50a8\u4e00\u6761\u8bb0\u5f55\u4e2d\u7684<code>\u6240\u6709</code>\u4fe1\u606f\u3002</p> <p></p> <p>\u56fe\u4e2d\u5bf9 B+ \u6811\u7684\u63cf\u8ff0\u4e0e\u771f\u5b9e\u60c5\u51b5\u4e0b B+ \u6811\u4e2d\u7684\u6570\u636e\u7ed3\u6784\u6709\u4e00\u4e9b\u5dee\u522b\uff0c\u4e0d\u8fc7\u8fd9\u91cc\u60f3\u8981\u8868\u8fbe\u7684\u4e3b\u8981\u610f\u601d\u662f\uff1a\u805a\u96c6\u7d22\u5f15\u53f6\u8282\u70b9\u4e2d\u4fdd\u5b58\u7684\u662f\u6574\u6761\u884c\u8bb0\u5f55\uff0c\u800c\u4e0d\u662f\u5176\u4e2d\u7684\u4e00\u90e8\u5206\u3002</p> <p>\u805a\u96c6\u7d22\u5f15\u4e0e\u8868\u7684\u7269\u7406\u5b58\u50a8\u65b9\u5f0f\u6709\u7740\u975e\u5e38\u5bc6\u5207\u7684\u5173\u7cfb\uff0c\u6240\u6709\u6b63\u5e38\u7684\u8868\u5e94\u8be5\u6709\u4e14\u4ec5\u6709\u4e00\u4e2a\u805a\u96c6\u7d22\u5f15\uff08\u7edd\u5927\u591a\u6570\u60c5\u51b5\u4e0b\u90fd\u662f\u4e3b\u952e\uff09\uff0c\u8868\u4e2d\u7684\u6240\u6709\u884c\u8bb0\u5f55\u6570\u636e\u90fd\u662f\u6309\u7167\u805a\u96c6\u7d22\u5f15\u7684\u987a\u5e8f\u5b58\u653e\u7684\u3002</p> <p>\u5f53\u6211\u4eec\u4f7f\u7528\u805a\u96c6\u7d22\u5f15\u5bf9\u8868\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u68c0\u7d22\u65f6\uff0c\u53ef\u4ee5\u76f4\u63a5\u83b7\u5f97\u805a\u96c6\u7d22\u5f15\u6240\u5bf9\u5e94\u7684\u6574\u6761\u884c\u8bb0\u5f55\u6570\u636e\u6240\u5728\u7684\u9875\uff0c\u4e0d\u9700\u8981\u8fdb\u884c\u7b2c\u4e8c\u6b21\u64cd\u4f5c\u3002</p>"},{"location":"chap1/mysql1_innodb/#10-2","title":"10-2 \u8f85\u52a9\u7d22\u5f15","text":"<p>\u6570\u636e\u5e93\u5c06\u6240\u6709\u7684\u975e\u805a\u96c6\u7d22\u5f15\u90fd\u5212\u5206\u4e3a\u8f85\u52a9\u7d22\u5f15\uff0c\u4f46\u662f\u8fd9\u4e2a\u6982\u5ff5\u5bf9\u6211\u4eec\u7406\u89e3\u8f85\u52a9\u7d22\u5f15\u5e76\u6ca1\u6709\u4ec0\u4e48\u5e2e\u52a9\uff1b</p> <p>\u8f85\u52a9\u7d22\u5f15\u4e5f\u662f\u901a\u8fc7 B+ \u6811\u5b9e\u73b0\u7684\uff0c\u4f46\u662f\u5b83\u7684\u53f6\u8282\u70b9\u5e76\u4e0d\u5305\u542b\u884c\u8bb0\u5f55\u7684\u5168\u90e8\u6570\u636e\uff0c\u4ec5\u5305\u542b\u7d22\u5f15\u4e2d\u7684\u6240\u6709\u952e\u548c\u4e00\u4e2a\u7528\u4e8e\u67e5\u627e\u5bf9\u5e94\u884c\u8bb0\u5f55\u7684\u300e\u4e66\u7b7e\u300f\uff0c\u5728 <code>InnoDB</code> \u4e2d\u8fd9\u4e2a\u4e66\u7b7e\u5c31\u662f\u5f53\u524d\u8bb0\u5f55\u7684\u4e3b\u952e\u3002</p> <p>\u8f85\u52a9\u7d22\u5f15\u7684\u5b58\u5728\u5e76\u4e0d\u4f1a\u5f71\u54cd\u805a\u96c6\u7d22\u5f15\uff0c\u56e0\u4e3a\u805a\u96c6\u7d22\u5f15\u6784\u6210\u7684 <code>B+</code>\u6811\u662f\u6570\u636e\u5b9e\u9645\u5b58\u50a8\u7684\u5f62\u5f0f\uff0c\u800c\u8f85\u52a9\u7d22\u5f15\u53ea\u7528\u4e8e\u52a0\u901f\u6570\u636e\u7684\u67e5\u627e\uff0c\u6240\u4ee5\u4e00\u5f20\u8868\u4e0a\u5f80\u5f80\u6709\u591a\u4e2a\u8f85\u52a9\u7d22\u5f15\u4ee5\u6b64\u6765\u63d0\u5347\u6570\u636e\u5e93\u7684\u6027\u80fd\u3002</p> <p>\u4e00\u5f20\u8868\u4e00\u5b9a\u5305\u542b\u4e00\u4e2a\u805a\u96c6\u7d22\u5f15\u6784\u6210\u7684 B+ \u6811\u4ee5\u53ca\u82e5\u5e72\u8f85\u52a9\u7d22\u5f15\u7684\u6784\u6210\u7684 B+ \u6811\u3002</p> <p></p> <p>\u5982\u679c\u5728\u8868 <code>users</code> \u4e2d\u5b58\u5728\u4e00\u4e2a\u8f85\u52a9\u7d22\u5f15 (<code>first_name, age</code>)\uff0c\u90a3\u4e48\u5b83\u6784\u6210\u7684 <code>B+</code> \u6811\u5927\u81f4\u5c31\u662f\u4e0a\u56fe\u8fd9\u6837\uff0c\u6309\u7167 (<code>first_name, age</code>) \u7684\u5b57\u6bcd\u987a\u5e8f\u5bf9\u8868\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u6392\u5e8f\uff0c\u5f53\u67e5\u627e\u5230\u4e3b\u952e\u65f6\uff0c\u518d\u901a\u8fc7\u805a\u96c6\u7d22\u5f15\u83b7\u53d6\u5230\u6574\u6761\u884c\u8bb0\u5f55\u3002</p> <p></p> <p>\u4e0a\u56fe\u5c55\u793a\u4e86\u4e00\u4e2a\u4f7f\u7528\u8f85\u52a9\u7d22\u5f15\u67e5\u627e\u4e00\u6761\u8868\u8bb0\u5f55\u7684\u8fc7\u7a0b\uff1a</p> <ul> <li>\u901a\u8fc7\u8f85\u52a9\u7d22\u5f15\u67e5\u627e\u5230\u5bf9\u5e94\u7684\u4e3b\u952e\uff0c</li> <li>\u6700\u540e\u5728\u805a\u96c6\u7d22\u5f15\u4e2d\u4f7f\u7528\u4e3b\u952e\u83b7\u53d6\u5bf9\u5e94\u7684\u884c\u8bb0\u5f55\uff0c\u8fd9\u4e5f\u662f\u901a\u5e38\u60c5\u51b5\u4e0b\u884c\u8bb0\u5f55\u7684\u67e5\u627e\u65b9\u5f0f\u3002</li> </ul>"},{"location":"chap1/mysql1_innodb/#11","title":"11 \u9501","text":"<p>\u6211\u4eec\u90fd\u77e5\u9053\u9501\u7684\u79cd\u7c7b\u4e00\u822c\u5206\u4e3a\u4e50\u89c2\u9501\u548c\u60b2\u89c2\u9501\u4e24\u79cd\uff0cInnoDB \u5b58\u50a8\u5f15\u64ce\u4e2d\u4f7f\u7528\u7684\u5c31\u662f\u60b2\u89c2\u9501\uff0c\u800c\u6309\u7167\u9501\u7684\u7c92\u5ea6\u5212\u5206\uff0c\u4e5f\u53ef\u4ee5\u5206\u6210\u884c\u9501\u548c\u8868\u9501\u3002</p>"},{"location":"chap1/mysql1_innodb/#1_1","title":"1 \u5e76\u53d1\u63a7\u5236\u673a\u5236","text":"<p>\u4e50\u89c2\u9501\u548c\u60b2\u89c2\u9501\u5176\u5b9e\u90fd\u662f\u5e76\u53d1\u63a7\u5236\u7684\u673a\u5236\uff0c\u540c\u65f6\u5b83\u4eec\u5728\u539f\u7406\u4e0a\u5c31\u6709\u7740\u672c\u8d28\u7684\u5dee\u522b\uff1b</p> <ul> <li>\u4e50\u89c2\u9501\u662f\u4e00\u79cd\u601d\u60f3\uff0c\u5b83\u5176\u5b9e\u5e76\u4e0d\u662f\u4e00\u79cd\u771f\u6b63\u7684\u300e\u9501\u300f\uff0c\u5b83\u4f1a\u5148\u5c1d\u8bd5\u5bf9\u8d44\u6e90\u8fdb\u884c\u4fee\u6539\uff0c\u5728\u5199\u56de\u65f6\u5224\u65ad\u8d44\u6e90\u662f\u5426\u8fdb\u884c\u4e86\u6539\u53d8\uff0c\u5982\u679c\u6ca1\u6709\u53d1\u751f\u6539\u53d8\u5c31\u4f1a\u5199\u56de\uff0c\u5426\u5219\u5c31\u4f1a\u8fdb\u884c\u91cd\u8bd5\uff0c\u5728\u6574\u4e2a\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\u5176\u5b9e\u90fd\u6ca1\u6709\u5bf9\u6570\u636e\u5e93\u8fdb\u884c\u52a0\u9501</li> </ul> <p></p> <ul> <li>\u60b2\u89c2\u9501\u5c31\u662f\u4e00\u79cd\u771f\u6b63\u7684\u9501\u4e86\uff0c\u5b83\u4f1a\u5728\u83b7\u53d6\u8d44\u6e90\u524d\u5bf9\u8d44\u6e90\u8fdb\u884c\u52a0\u9501\uff0c\u786e\u4fdd\u540c\u4e00\u65f6\u523b\u53ea\u6709\u6709\u9650\u7684\u7ebf\u7a0b\u80fd\u591f\u8bbf\u95ee\u8be5\u8d44\u6e90\uff0c\u5176\u4ed6\u60f3\u8981\u5c1d\u8bd5\u83b7\u53d6\u8d44\u6e90\u7684\u64cd\u4f5c\u90fd\u4f1a\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\uff0c\u76f4\u5230\u8be5\u7ebf\u7a0b\u5b8c\u6210\u4e86\u5bf9\u8d44\u6e90\u7684\u64cd\u4f5c\u5e76\u4e14\u91ca\u653e\u4e86\u9501\u540e\uff0c\u5176\u4ed6\u7ebf\u7a0b\u624d\u80fd\u91cd\u65b0\u64cd\u4f5c\u8d44\u6e90\uff1b</li> </ul> <p></p> <p>\u867d\u7136\u4e50\u89c2\u9501\u548c\u60b2\u89c2\u9501\u5728\u672c\u8d28\u4e0a\u5e76\u4e0d\u662f\u540c\u4e00\u79cd\u4e1c\u897f\uff0c\u4e00\u4e2a\u662f\u4e00\u79cd\u601d\u60f3\uff0c\u53e6\u4e00\u4e2a\u662f\u4e00\u79cd\u771f\u6b63\u7684\u9501\uff0c\u4f46\u662f\u5b83\u4eec\u90fd\u662f\u4e00\u79cd\u5e76\u53d1\u63a7\u5236\u673a\u5236\u3002</p> <p>\u4e50\u89c2\u9501\u4e0d\u4f1a\u5b58\u5728\u6b7b\u9501\u7684\u95ee\u9898\uff0c\u4f46\u662f\u7531\u4e8e\u66f4\u65b0\u540e\u9a8c\u8bc1\uff0c\u6240\u4ee5\u5f53\u51b2\u7a81\u9891\u7387\u548c\u91cd\u8bd5\u6210\u672c\u8f83\u9ad8\u65f6\u66f4\u63a8\u8350\u4f7f\u7528\u60b2\u89c2\u9501\uff0c\u800c\u9700\u8981\u975e\u5e38\u9ad8\u7684\u54cd\u5e94\u901f\u5ea6\u5e76\u4e14\u5e76\u53d1\u91cf\u975e\u5e38\u5927\u7684\u65f6\u5019\u4f7f\u7528\u4e50\u89c2\u9501\u5c31\u80fd\u8f83\u597d\u7684\u89e3\u51b3\u95ee\u9898\uff0c\u5728\u8fd9\u65f6\u4f7f\u7528\u60b2\u89c2\u9501\u5c31\u53ef\u80fd\u51fa\u73b0\u4e25\u91cd\u7684\u6027\u80fd\u95ee\u9898\uff1b\u5728\u9009\u62e9\u5e76\u53d1\u63a7\u5236\u673a\u5236\u65f6\uff0c\u9700\u8981\u7efc\u5408\u8003\u8651\u4e0a\u9762\u7684\u56db\u4e2a\u65b9\u9762</p> <ul> <li>\u51b2\u7a81\u9891\u7387\u3001</li> <li>\u91cd\u8bd5\u6210\u672c\u3001</li> <li>\u54cd\u5e94\u901f\u5ea6</li> <li>\u5e76\u53d1\u91cf</li> </ul> <p>\u8fdb\u884c\u9009\u62e9\u3002</p>"},{"location":"chap1/mysql1_innodb/#2","title":"2 \u9501\u7684\u79cd\u7c7b","text":"<p>\u5bf9\u6570\u636e\u7684\u64cd\u4f5c\u5176\u5b9e\u53ea\u6709\u4e24\u79cd\uff0c\u4e5f\u5c31\u662f\u8bfb\u548c\u5199\uff0c\u800c\u6570\u636e\u5e93\u5728\u5b9e\u73b0\u9501\u65f6\uff0c\u4e5f\u4f1a\u5bf9\u8fd9\u4e24\u79cd\u64cd\u4f5c\u4f7f\u7528\u4e0d\u540c\u7684\u9501\uff1bInnoDB \u5b9e\u73b0\u4e86\u6807\u51c6\u7684\u884c\u7ea7\u9501\uff0c\u4e5f\u5c31\u662f\u5171\u4eab\u9501\uff08<code>Shared Lock</code>\uff09 \u548c\u4e92\u65a5\u9501\uff08<code>Exclusive Lock</code>\uff09\uff1b\u5171\u4eab\u9501\u548c\u4e92\u65a5\u9501\u7684\u4f5c\u7528\u5176\u5b9e\u975e\u5e38\u597d\u7406\u89e3\uff1a</p> <ul> <li>\u5171\u4eab\u9501\uff08\u8bfb\u9501\uff09\uff1a\u5141\u8bb8\u4e8b\u52a1\u5bf9\u4e00\u6761\u884c\u6570\u636e\u8fdb\u884c\u8bfb\u53d6\uff1b</li> <li>\u4e92\u65a5\u9501\uff08\u5199\u9501\uff09\uff1a\u5141\u8bb8\u4e8b\u52a1\u5bf9\u4e00\u6761\u884c\u6570\u636e\u8fdb\u884c\u5220\u9664\u6216\u66f4\u65b0\uff1b</li> </ul> <p>\u800c\u5b83\u4eec\u7684\u540d\u5b57\u4e5f\u6697\u793a\u7740\u5404\u81ea\u7684\u53e6\u5916\u4e00\u4e2a\u7279\u6027\uff0c\u5171\u4eab\u9501\u4e4b\u95f4\u662f\u517c\u5bb9\u7684\uff0c\u800c\u4e92\u65a5\u9501\u4e0e\u5176\u4ed6\u4efb\u610f\u9501\u90fd\u4e0d\u517c\u5bb9\uff1a</p> <p></p> <p>\u7a0d\u5fae\u5bf9\u5b83\u4eec\u7684\u4f7f\u7528\u8fdb\u884c\u601d\u8003\u5c31\u80fd\u60f3\u660e\u767d\u5b83\u4eec\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u8bbe\u8ba1\uff0c\u56e0\u4e3a\u5171\u4eab\u9501\u4ee3\u8868\u4e86\u8bfb\u64cd\u4f5c\u3001\u4e92\u65a5\u9501\u4ee3\u8868\u4e86\u5199\u64cd\u4f5c\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728\u6570\u636e\u5e93\u4e2d\u5e76\u884c\u8bfb\uff0c\u4f46\u662f\u53ea\u80fd\u4e32\u884c\u5199\uff0c</p> <p>\u53ea\u6709\u8fd9\u6837\u624d\u80fd\u4fdd\u8bc1\u4e0d\u4f1a\u53d1\u751f\u7ebf\u7a0b\u7ade\u4e89\uff0c\u5b9e\u73b0\u7ebf\u7a0b\u5b89\u5168\u3002</p>"},{"location":"chap1/mysql1_innodb/#3_1","title":"3 \u9501\u7684\u7c92\u5ea6","text":"<p>\u4e0e\u4e0a\u4e00\u8282\u4e2d\u63d0\u5230\u7684\u4e24\u79cd\u9501\u7684\u79cd\u7c7b\u76f8\u4f3c\u7684\u662f\uff0c\u610f\u5411\u9501\u4e5f\u5206\u4e3a\u4e24\u79cd\uff1a</p> <ul> <li>\u610f\u5411\u5171\u4eab\u9501\uff1a\u4e8b\u52a1\u60f3\u8981\u5728\u83b7\u5f97\u8868\u4e2d\u67d0\u4e9b\u8bb0\u5f55\u7684\u5171\u4eab\u9501\uff0c\u9700\u8981\u5728\u8868\u4e0a\u5148\u52a0\u610f\u5411\u5171\u4eab\u9501\uff1b</li> <li>\u610f\u5411\u4e92\u65a5\u9501\uff1a\u4e8b\u52a1\u60f3\u8981\u5728\u83b7\u5f97\u8868\u4e2d\u67d0\u4e9b\u8bb0\u5f55\u7684\u4e92\u65a5\u9501\uff0c\u9700\u8981\u5728\u8868\u4e0a\u5148\u52a0\u610f\u5411\u4e92\u65a5\u9501\uff1b</li> </ul> <p>\u968f\u7740\u610f\u5411\u9501\u7684\u52a0\u5165\uff0c\u9501\u7c7b\u578b\u4e4b\u95f4\u7684\u517c\u5bb9\u77e9\u9635\u4e5f\u53d8\u5f97\u6108\u52a0\u590d\u6742\uff1a</p> <p></p> <p>\u610f\u5411\u9501\u5176\u5b9e\u4e0d\u4f1a\u963b\u585e\u5168\u8868\u626b\u63cf\u4e4b\u5916\u7684\u4efb\u4f55\u8bf7\u6c42\uff0c\u5b83\u4eec\u7684\u4e3b\u8981\u76ee\u7684\u662f\u4e3a\u4e86\u8868\u793a\u662f\u5426\u6709\u4eba\u8bf7\u6c42\u9501\u5b9a\u8868\u4e2d\u7684\u67d0\u4e00\u884c\u6570\u636e\u3002</p> <p>\u6709\u7684\u4eba\u53ef\u80fd\u4f1a\u5bf9\u610f\u5411\u9501\u7684\u76ee\u7684\u5e76\u4e0d\u662f\u5b8c\u5168\u7684\u7406\u89e3\uff0c\u6211\u4eec\u5728\u8fd9\u91cc\u53ef\u4ee5\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff1a\u5982\u679c\u6ca1\u6709\u610f\u5411\u9501\uff0c\u5f53\u5df2\u7ecf\u6709\u4eba\u4f7f\u7528\u884c\u9501\u5bf9\u8868\u4e2d\u7684\u67d0\u4e00\u884c\u8fdb\u884c\u4fee\u6539\u65f6\uff0c\u5982\u679c\u53e6\u5916\u4e00\u4e2a\u8bf7\u6c42\u8981\u5bf9\u5168\u8868\u8fdb\u884c\u4fee\u6539\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u5bf9\u6240\u6709\u7684\u884c\u662f\u5426\u88ab\u9501\u5b9a\u8fdb\u884c\u626b\u63cf\uff0c\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6548\u7387\u662f\u975e\u5e38\u4f4e\u7684\uff1b\u4e0d\u8fc7\uff0c\u5728\u5f15\u5165\u610f\u5411\u9501\u4e4b\u540e\uff0c\u5f53\u6709\u4eba\u4f7f\u7528\u884c\u9501\u5bf9\u8868\u4e2d\u7684\u67d0\u4e00\u884c\u8fdb\u884c\u4fee\u6539\u4e4b\u524d\uff0c\u4f1a\u5148\u4e3a\u8868\u6dfb\u52a0\u610f\u5411\u4e92\u65a5\u9501\uff08IX\uff09\uff0c\u518d\u4e3a\u884c\u8bb0\u5f55\u6dfb\u52a0\u4e92\u65a5\u9501\uff08X\uff09\uff0c\u5728\u8fd9\u65f6\u5982\u679c\u6709\u4eba\u5c1d\u8bd5\u5bf9\u5168\u8868\u8fdb\u884c\u4fee\u6539\u5c31\u4e0d\u9700\u8981\u5224\u65ad\u8868\u4e2d\u7684\u6bcf\u4e00\u884c\u6570\u636e\u662f\u5426\u88ab\u52a0\u9501\u4e86\uff0c\u53ea\u9700\u8981\u901a\u8fc7\u7b49\u5f85\u610f\u5411\u4e92\u65a5\u9501\u88ab\u91ca\u653e\u5c31\u53ef\u4ee5\u4e86\u3002</p>"},{"location":"chap1/mysql1_innodb/#12","title":"12 \u9501\u7684\u7b97\u6cd5","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\u5df2\u7ecf\u5bf9 InnoDB \u4e2d\u9501\u7684\u7c92\u5ea6\u6709\u4e00\u5b9a\u7684\u4e86\u89e3\uff0c\u4e5f\u6e05\u695a\u4e86\u5728\u5bf9\u6570\u636e\u5e93\u8fdb\u884c\u8bfb\u5199\u65f6\u4f1a\u83b7\u53d6\u4e0d\u540c\u7684\u9501\uff0c\u5728\u8fd9\u4e00\u5c0f\u8282\u5c06\u4ecb\u7ecd\u9501\u662f\u5982\u4f55\u6dfb\u52a0\u5230\u5bf9\u5e94\u7684\u6570\u636e\u884c\u4e0a\u7684\uff0c\u6211\u4eec\u4f1a\u5206\u522b\u4ecb\u7ecd\u4e09\u79cd\u9501\u7684\u7b97\u6cd5\uff1a</p> <ul> <li><code>Record Lock</code>\u3001</li> <li><code>Gap Lock</code></li> <li><code>Next-Key Lock</code></li> </ul>"},{"location":"chap1/mysql1_innodb/#1-record-lock","title":"1 Record Lock","text":"<p>\u8bb0\u5f55\u9501\uff08<code>Record Lock</code>\uff09\u662f\u52a0\u5230\u7d22\u5f15\u8bb0\u5f55\u4e0a\u7684\u9501\uff0c\u5047\u8bbe\u6211\u4eec\u5b58\u5728\u4e0b\u9762\u7684\u4e00\u5f20\u8868 <code>users</code>\uff1a</p> <pre><code>CREATE TABLE users(\n    id INT NOT NULL AUTO_INCREMENT,\n    last_name VARCHAR(255) NOT NULL,\n    first_name VARCHAR(255),\n    age INT,\n    PRIMARY KEY(id),\n    KEY(last_name),\n    KEY(age)\n);\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u4f7f\u7528 <code>id</code> \u6216\u8005 <code>last_name</code> \u4f5c\u4e3a <code>SQL</code> \u4e2d <code>WHERE</code> \u8bed\u53e5\u7684\u8fc7\u6ee4\u6761\u4ef6\uff0c\u90a3\u4e48 <code>InnoDB</code> \u5c31\u53ef\u4ee5\u901a\u8fc7\u7d22\u5f15\u5efa\u7acb\u7684 <code>B+</code> \u6811\u627e\u5230\u884c\u8bb0\u5f55\u5e76\u6dfb\u52a0\u7d22\u5f15</p> <p>\u4f46\u662f\u5982\u679c\u4f7f\u7528 <code>first_name</code> \u4f5c\u4e3a\u8fc7\u6ee4\u6761\u4ef6\u65f6\uff0c\u7531\u4e8e <code>InnoDB</code> \u4e0d\u77e5\u9053\u5f85\u4fee\u6539\u7684\u8bb0\u5f55\u5177\u4f53\u5b58\u653e\u7684\u4f4d\u7f6e\uff0c\u4e5f\u65e0\u6cd5\u5bf9\u5c06\u8981\u4fee\u6539\u54ea\u6761\u8bb0\u5f55\u63d0\u524d\u505a\u51fa\u5224\u65ad\u5c31\u4f1a\u9501\u5b9a\u6574\u4e2a\u8868\u3002</p>"},{"location":"chap1/mysql1_innodb/#2-gap-lock","title":"2 Gap Lock","text":"<p>\u8bb0\u5f55\u9501\u662f\u5728\u5b58\u50a8\u5f15\u64ce\u4e2d\u6700\u4e3a\u5e38\u89c1\u7684\u9501\uff0c\u9664\u4e86\u8bb0\u5f55\u9501\u4e4b\u5916\uff0c</p> <p><code>InnoDB</code>\u4e2d\u8fd8\u5b58\u5728\u95f4\u9699\u9501\uff08<code>Gap Lock</code>\uff09\uff0c\u95f4\u9699\u9501\u662f\u5bf9\u7d22\u5f15\u8bb0\u5f55\u4e2d\u7684\u4e00\u6bb5\u8fde\u7eed\u533a\u57df\u7684\u9501\uff1b</p> <p>\u5f53\u4f7f\u7528\u7c7b\u4f3c <code>SELECT * FROM users WHERE id BETWEEN 10 AND 20 FOR UPDATE;</code> \u7684 SQL \u8bed\u53e5\u65f6\uff0c\u5c31\u4f1a\u963b\u6b62\u5176\u4ed6\u4e8b\u52a1\u5411\u8868\u4e2d\u63d2\u5165 <code>id = 15</code> \u7684\u8bb0\u5f55\uff0c\u56e0\u4e3a\u6574\u4e2a\u8303\u56f4\u90fd\u88ab\u95f4\u9699\u9501\u9501\u5b9a\u4e86\u3002</p> <p>\u95f4\u9699\u9501\u662f\u5b58\u50a8\u5f15\u64ce\u5bf9\u4e8e\u6027\u80fd\u548c\u5e76\u53d1\u505a\u51fa\u7684\u6743\u8861\uff0c\u5e76\u4e14\u53ea\u7528\u4e8e\u67d0\u4e9b\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u3002</p> <p>\u867d\u7136\u95f4\u9699\u9501\u4e2d\u4e5f\u5206\u4e3a\u5171\u4eab\u9501\u548c\u4e92\u65a5\u9501\uff0c\u4e0d\u8fc7\u5b83\u4eec\u4e4b\u95f4\u5e76\u4e0d\u662f\u4e92\u65a5\u7684\uff0c\u4e5f\u5c31\u662f\u4e0d\u540c\u7684\u4e8b\u52a1\u53ef\u4ee5\u540c\u65f6\u6301\u6709\u4e00\u6bb5\u76f8\u540c\u8303\u56f4\u7684\u5171\u4eab\u9501\u548c\u4e92\u65a5\u9501\uff0c\u5b83\u552f\u4e00\u963b\u6b62\u7684\u5c31\u662f\u5176\u4ed6\u4e8b\u52a1\u5411\u8fd9\u4e2a\u8303\u56f4\u4e2d\u6dfb\u52a0\u65b0\u7684\u8bb0\u5f55\u3002</p>"},{"location":"chap1/mysql1_innodb/#3-next-key-lock","title":"3 Next-Key Lock","text":"<p>Next-Key \u9501\u76f8\u6bd4\u524d\u4e24\u8005\u5c31\u7a0d\u5fae\u6709\u4e00\u4e9b\u590d\u6742\uff0c\u5b83\u662f\u8bb0\u5f55\u9501\u548c\u8bb0\u5f55\u524d\u7684\u95f4\u9699\u9501\u7684\u7ed3\u5408\uff0c\u5728 <code>users</code> \u8868\u4e2d\u6709\u4ee5\u4e0b\u8bb0\u5f55\uff1a</p> <pre><code>+------|-------------|--------------|-------+\n|   id | last_name   | first_name   |   age |\n|------|-------------|--------------|-------|\n|    4 | stark       | tony         |    21 |\n|    1 | tom         | hiddleston   |    30 |\n|    3 | morgan      | freeman      |    40 |\n|    5 | jeff        | dean         |    50 |\n|    2 | donald      | trump        |    80 |\n+------|-------------|--------------|-------+\n</code></pre> <p>\u5982\u679c\u4f7f\u7528 Next-Key \u9501\uff0c\u90a3\u4e48 Next-Key \u9501\u5c31\u53ef\u4ee5\u5728\u9700\u8981\u7684\u65f6\u5019\u9501\u5b9a\u4ee5\u4e0b\u7684\u8303\u56f4\uff1a</p> <pre><code>(-\u221e, 21]\n(21, 30]\n(30, 40]\n(40, 50]\n(50, 80]\n(80, \u221e)\n</code></pre> <p>\u65e2\u7136\u53eb Next-Key \u9501\uff0c\u9501\u5b9a\u7684\u5e94\u8be5\u662f\u5f53\u524d\u503c\u548c\u540e\u9762\u7684\u8303\u56f4\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u5374\u4e0d\u662f\uff0c</p>"},{"location":"chap1/mysql1_innodb/#next-key","title":"<code>Next-Key</code> \u9501\u9501\u5b9a\u7684\u662f\u5f53\u524d\u503c\u548c\u524d\u9762\u7684\u8303\u56f4\u3002","text":"<p>\u5f53\u6211\u4eec\u66f4\u65b0\u4e00\u6761\u8bb0\u5f55\uff0c\u6bd4\u5982 <code>SELECT * FROM users WHERE age = 30 FOR UPDATE;</code>\uff0c</p> <p><code>InnoDB</code> \u4e0d\u4ec5\u4f1a\u5728\u8303\u56f4 <code>(21, 30]</code>\u4e0a\u52a0 <code>Next-Key</code> \u9501\uff0c\u8fd8\u4f1a\u5728\u8fd9\u6761\u8bb0\u5f55\u540e\u9762\u7684\u8303\u56f4 <code>(30, 40]</code> \u52a0\u95f4\u9699\u9501\uff0c\u6240\u4ee5\u63d2\u5165<code>(21, 40]</code> \u8303\u56f4\u5185\u7684\u8bb0\u5f55\u90fd\u4f1a\u88ab\u9501\u5b9a\u3002</p> <p>Next-Key \u9501\u7684\u4f5c\u7528\u5176\u5b9e\u662f\u4e3a\u4e86\u89e3\u51b3\u5e7b\u8bfb\u7684\u95ee\u9898\uff0c\u6211\u4eec\u4f1a\u5728\u4e0b\u4e00\u8282\u8c08\u4e8b\u52a1\u7684\u65f6\u5019\u5177\u4f53\u4ecb\u7ecd\u3002</p>"},{"location":"chap1/mysql1_innodb/#4_1","title":"4 \u6b7b\u9501\u7684\u53d1\u751f","text":"<p>\u65e2\u7136 InnoDB \u4e2d\u5b9e\u73b0\u7684\u9501\u662f\u60b2\u89c2\u7684\uff0c\u90a3\u4e48\u4e0d\u540c\u4e8b\u52a1\u4e4b\u95f4\u5c31\u53ef\u80fd\u4f1a\u4e92\u76f8\u7b49\u5f85\u5bf9\u65b9\u91ca\u653e\u9501\u9020\u6210\u6b7b\u9501\uff0c\u6700\u7ec8\u5bfc\u81f4\u4e8b\u52a1\u53d1\u751f\u9519\u8bef\uff1b\u60f3\u8981\u5728 MySQL \u4e2d\u5236\u9020\u6b7b\u9501\u7684\u95ee\u9898\u5176\u5b9e\u975e\u5e38\u5bb9\u6613\uff1a</p> <p></p> <p>\u4e24\u4e2a\u4f1a\u8bdd\u90fd\u6301\u6709\u4e00\u4e2a\u9501\uff0c\u5e76\u4e14\u5c1d\u8bd5\u83b7\u53d6\u5bf9\u65b9\u7684\u9501\u65f6\u5c31\u4f1a\u53d1\u751f\u6b7b\u9501\uff0c\u4e0d\u8fc7 MySQL \u4e5f\u80fd\u5728\u53d1\u751f\u6b7b\u9501\u65f6\u53ca\u65f6\u53d1\u73b0\u95ee\u9898\uff0c\u5e76\u4fdd\u8bc1\u5176\u4e2d\u7684\u4e00\u4e2a\u4e8b\u52a1\u80fd\u591f\u6b63\u5e38\u5de5\u4f5c\uff0c\u8fd9\u5bf9\u6211\u4eec\u6765\u8bf4\u4e5f\u662f\u4e00\u4e2a\u597d\u6d88\u606f\u3002</p>"},{"location":"chap1/mysql1_innodb/#13","title":"13 \u4e8b\u52a1\u4e0e\u9694\u79bb\u7ea7\u522b","text":"<p>\u5728\u4ecb\u7ecd\u4e86\u9501\u4e4b\u540e\uff0c\u6211\u4eec\u518d\u6765\u8c08\u8c08\u6570\u636e\u5e93\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6982\u5ff5 \u2014\u2014 \u4e8b\u52a1\uff1b\u76f8\u4fe1\u53ea\u8981\u662f\u4e00\u4e2a\u5408\u683c\u7684\u8f6f\u4ef6\u5de5\u7a0b\u5e08\u5c31\u5bf9\u4e8b\u52a1\u7684\u7279\u6027\u6709\u6240\u4e86\u89e3\uff0c\u5176\u4e2d\u88ab\u4eba\u7ecf\u5e38\u63d0\u8d77\u7684\u5c31\u662f\u4e8b\u52a1\u7684\u539f\u5b50\u6027\uff0c\u5728\u6570\u636e\u63d0\u4ea4\u5de5\u4f5c\u65f6\uff0c\u8981\u4e48\u4fdd\u8bc1\u6240\u6709\u7684\u4fee\u6539\u90fd\u80fd\u591f\u63d0\u4ea4\uff0c\u8981\u4e48\u5c31\u6240\u6709\u7684\u4fee\u6539\u5168\u90e8\u56de\u6eda\u3002</p> <p>\u4f46\u662f\u4e8b\u52a1\u8fd8\u9075\u5faa\u5305\u62ec\u539f\u5b50\u6027\u5728\u5185\u7684 ACID \u56db\u5927\u7279\u6027\uff1a</p> <ul> <li>\u539f\u5b50\u6027\uff08Atomicity\uff09\u3001</li> <li>\u4e00\u81f4\u6027\uff08Consistency\uff09\u3001</li> <li>\u9694\u79bb\u6027\uff08Isolation\uff09</li> <li>\u6301\u4e45\u6027\uff08Durability\uff09\uff1b</li> </ul> <p>\u6587\u7ae0\u4e0d\u4f1a\u5bf9\u8fd9\u56db\u5927\u7279\u6027\u5168\u90e8\u5c55\u5f00\u8fdb\u884c\u4ecb\u7ecd\uff0c\u76f8\u4fe1\u4f60\u80fd\u591f\u901a\u8fc7 Google \u548c\u6570\u636e\u5e93\u76f8\u5173\u7684\u4e66\u7c4d\u8f7b\u677e\u83b7\u5f97\u6709\u5173\u5b83\u4eec\u7684\u6982\u5ff5\uff0c\u672c\u6587\u6700\u540e\u8981\u4ecb\u7ecd\u7684\u5c31\u662f\u4e8b\u52a1\u7684\u56db\u79cd\u9694\u79bb\u7ea7\u522b\u3002</p>"},{"location":"chap1/mysql1_innodb/#1_2","title":"1 \u51e0\u79cd\u9694\u79bb\u7ea7\u522b","text":"<p>\u4e8b\u52a1\u7684\u9694\u79bb\u6027\u662f\u6570\u636e\u5e93\u5904\u7406\u6570\u636e\u7684\u51e0\u5927\u57fa\u7840\u4e4b\u4e00\uff0c\u800c\u9694\u79bb\u7ea7\u522b\u5176\u5b9e\u5c31\u662f\u63d0\u4f9b\u7ed9\u7528\u6237\u7528\u4e8e\u5728\u6027\u80fd\u548c\u53ef\u9760\u6027\u505a\u51fa\u9009\u62e9\u548c\u6743\u8861\u7684\u914d\u7f6e\u9879\u3002</p> <p>ISO \u548c ANIS SQL \u6807\u51c6\u5236\u5b9a\u4e86\u56db\u79cd\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\uff0c\u800c InnoDB \u9075\u5faa\u4e86 SQL:1992 \u6807\u51c6\u4e2d\u7684\u56db\u79cd\u9694\u79bb\u7ea7\u522b\uff1a<code>READ UNCOMMITED</code>\u3001<code>READ COMMITED</code>\u3001<code>REPEATABLE READ</code> \u548c <code>SERIALIZABLE</code>\uff1b\u6bcf\u4e2a\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\u5176\u5b9e\u90fd\u6bd4\u4e0a\u4e00\u7ea7\u591a\u89e3\u51b3\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a</p> <ul> <li><code>RAED UNCOMMITED</code>\uff1a\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5\u4e0d\u4f1a\u52a0\u9501\uff0c\u53ef\u80fd\u4f1a\u8bfb\u5230\u672a\u63d0\u4ea4\u7684\u884c\uff08<code>Dirty Read</code>\uff09\uff1b</li> <li><code>READ COMMITED</code>\uff1a\u53ea\u5bf9\u8bb0\u5f55\u52a0\u8bb0\u5f55\u9501\uff0c\u800c\u4e0d\u4f1a\u5728\u8bb0\u5f55\u4e4b\u95f4\u52a0\u95f4\u9699\u9501\uff0c\u6240\u4ee5\u5141\u8bb8\u65b0\u7684\u8bb0\u5f55\u63d2\u5165\u5230\u88ab\u9501\u5b9a\u8bb0\u5f55\u7684\u9644\u8fd1\uff0c\u6240\u4ee5\u518d\u591a\u6b21\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5\u65f6\uff0c\u53ef\u80fd\u5f97\u5230\u4e0d\u540c\u7684\u7ed3\u679c\uff08<code>Non-Repeatable Read</code>\uff09\uff1b</li> <li><code>REPEATABLE READ</code>\uff1a\u591a\u6b21\u8bfb\u53d6\u540c\u4e00\u8303\u56f4\u7684\u6570\u636e\u4f1a\u8fd4\u56de\u7b2c\u4e00\u6b21\u67e5\u8be2\u7684\u5feb\u7167\uff0c\u4e0d\u4f1a\u8fd4\u56de\u4e0d\u540c\u7684\u6570\u636e\u884c\uff0c\u4f46\u662f\u53ef\u80fd\u53d1\u751f\u5e7b\u8bfb\uff08<code>Phantom Read</code>)</li> <li><code>SERIALIZABLE</code>\uff1aInnoDB \u9690\u5f0f\u5730\u5c06\u5168\u90e8\u7684\u67e5\u8be2\u8bed\u53e5\u52a0\u4e0a\u5171\u4eab\u9501\uff0c\u89e3\u51b3\u4e86\u5e7b\u8bfb\u7684\u95ee\u9898\uff1b</li> </ul> <p>MySQL \u4e2d\u9ed8\u8ba4\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u5c31\u662f <code>REPEATABLE READ</code>\uff0c\u4f46\u662f\u5b83\u901a\u8fc7 <code>Next-Key</code> \u9501\u4e5f\u80fd\u591f\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u5e7b\u8bfb\u7684\u95ee\u9898\u3002</p> <p></p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5c06\u6570\u636e\u5e93\u4e2d\u521b\u5efa\u5982\u4e0b\u7684\u8868\u5e76\u901a\u8fc7\u4e2a\u4f8b\u5b50\u6765\u5c55\u793a\u5728\u4e0d\u540c\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u4e4b\u4e0b\uff0c\u4f1a\u53d1\u751f\u4ec0\u4e48\u6837\u7684\u95ee\u9898\uff1a</p> <pre><code>CREATE TABLE test(\n    id INT NOT NULL,\n    UNIQUE(id)\n);\n</code></pre>"},{"location":"chap1/mysql1_innodb/#2_1","title":"2 \u810f\u8bfb","text":"<p>\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u8bfb\u53d6\u4e86\u5176\u4ed6\u4e8b\u52a1\u672a\u63d0\u4ea4\u7684\u6570\u636e\u3002</p> <p>\u5f53\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\u4e3a <code>READ UNCOMMITED</code> \u65f6\uff0c\u6211\u4eec\u5728 <code>SESSION 2</code> \u4e2d\u63d2\u5165\u7684\u672a\u63d0\u4ea4\u6570\u636e\u5728 <code>SESSION 1</code> \u4e2d\u662f\u53ef\u4ee5\u8bbf\u95ee\u7684\u3002</p> <p></p>"},{"location":"chap1/mysql1_innodb/#3_2","title":"3 \u4e0d\u53ef\u91cd\u590d\u8bfb","text":"<p>\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u540c\u4e00\u884c\u8bb0\u5f55\u88ab\u8bbf\u95ee\u4e86\u4e24\u6b21\u5374\u5f97\u5230\u4e86\u4e0d\u540c\u7684\u7ed3\u679c\u3002</p> <p>\u5f53\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\u4e3a <code>READ COMMITED</code> \u65f6\uff0c\u867d\u7136\u89e3\u51b3\u4e86\u810f\u8bfb\u7684\u95ee\u9898\uff0c</p> <ul> <li>\u4f46\u662f\u5982\u679c\u5728 <code>SESSION 1</code> \u5148\u67e5\u8be2\u4e86\u4e00\u884c\u6570\u636e\uff0c</li> <li>\u5728\u8fd9\u4e4b\u540e <code>SESSION 2</code> \u4e2d\u4fee\u6539\u4e86\u540c\u4e00\u884c\u6570\u636e\u5e76\u4e14\u63d0\u4ea4\u4e86\u4fee\u6539\uff0c\u5728\u8fd9\u65f6\uff0c\u5982\u679c <code>SESSION 1</code> \u4e2d\u518d\u6b21\u4f7f\u7528\u76f8\u540c\u7684\u67e5\u8be2\u8bed\u53e5\uff0c\u5c31\u4f1a\u53d1\u73b0\u4e24\u6b21\u67e5\u8be2\u7684\u7ed3\u679c\u4e0d\u4e00\u6837\u3002</li> </ul> <p></p> <p>\u4e0d\u53ef\u91cd\u590d\u8bfb\u7684\u539f\u56e0\u5c31\u662f\uff0c\u5728 <code>READ COMMITED</code> \u7684\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u5b58\u50a8\u5f15\u64ce\u4e0d\u4f1a\u5728\u67e5\u8be2\u8bb0\u5f55\u65f6\u6dfb\u52a0\u884c\u9501\uff0c\u9501\u5b9a <code>id = 3</code> \u8fd9\u6761\u8bb0\u5f55\u3002</p>"},{"location":"chap1/mysql1_innodb/#4_2","title":"4 \u5e7b\u8bfb","text":"<p>\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u540c\u4e00\u4e2a\u8303\u56f4\u5185\u7684\u8bb0\u5f55\u88ab\u8bfb\u53d6\u65f6\uff0c\u5176\u4ed6\u4e8b\u52a1\u5411\u8fd9\u4e2a\u8303\u56f4\u6dfb\u52a0\u4e86\u65b0\u7684\u8bb0\u5f55\u3002</p> <p>\u91cd\u65b0\u5f00\u542f\u4e86\u4e24\u4e2a\u4f1a\u8bdd <code>SESSION 1</code> \u548c <code>SESSION 2</code>\uff0c</p> <ul> <li>\u5728 <code>SESSION 1</code> \u4e2d\u6211\u4eec\u67e5\u8be2\u5168\u8868\u7684\u4fe1\u606f\uff0c\u6ca1\u6709\u5f97\u5230\u4efb\u4f55\u8bb0\u5f55\uff1b</li> <li>\u5728 <code>SESSION 2</code> \u4e2d\u5411\u8868\u4e2d\u63d2\u5165\u4e00\u6761\u6570\u636e\u5e76\u63d0\u4ea4\uff1b</li> <li>\u7531\u4e8e <code>REPEATABLE READ</code> \u7684\u539f\u56e0\uff0c\u518d\u6b21\u67e5\u8be2\u5168\u8868\u7684\u6570\u636e\u65f6\uff0c\u6211\u4eec\u83b7\u5f97\u5230\u7684\u4ecd\u7136\u662f\u7a7a\u96c6\uff0c\u4f46\u662f\u5728\u5411\u8868\u4e2d\u63d2\u5165\u540c\u6837\u7684\u6570\u636e\u5374\u51fa\u73b0\u4e86\u9519\u8bef\u3002</li> </ul> <p></p> <p>\u8fd9\u79cd\u73b0\u8c61\u5728\u6570\u636e\u5e93\u4e2d\u5c31\u88ab\u79f0\u4f5c\u5e7b\u8bfb\uff0c\u867d\u7136\u6211\u4eec\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5\u5f97\u5230\u4e86\u4e00\u4e2a\u7a7a\u7684\u96c6\u5408\uff0c\u4f46\u662f\u63d2\u5165\u6570\u636e\u65f6\u5374\u5f97\u5230\u4e86\u9519\u8bef\uff0c\u597d\u50cf\u4e4b\u524d\u7684\u67e5\u8be2\u662f\u5e7b\u89c9\u4e00\u6837\u3002</p> <p>\u5728\u6807\u51c6\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u4e2d\uff0c\u5e7b\u8bfb\u662f\u7531\u66f4\u9ad8\u7684\u9694\u79bb\u7ea7\u522b <code>SERIALIZABLE</code> \u89e3\u51b3\u7684\uff0c\u4f46\u662f\u5b83\u4e5f\u53ef\u4ee5\u901a\u8fc7 <code>MySQL</code> \u63d0\u4f9b\u7684 <code>Next-Key</code> \u9501\u89e3\u51b3\uff1a</p> <p></p> <p><code>REPEATABLE READ</code> \u548c <code>READ UNCOMMITED</code> \u5176\u5b9e\u662f\u77db\u76fe\u7684\uff0c\u5982\u679c\u4fdd\u8bc1\u4e86\u524d\u8005\u5c31\u770b\u4e0d\u5230\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1\uff0c\u5982\u679c\u4fdd\u8bc1\u4e86\u540e\u8005\uff0c\u5c31\u4f1a\u5bfc\u81f4\u4e24\u6b21\u67e5\u8be2\u7684\u7ed3\u679c\u4e0d\u540c\uff0c</p> <p><code>MySQL</code> \u4e3a\u6211\u4eec\u63d0\u4f9b\u4e86\u4e00\u79cd\u6298\u4e2d\u7684\u65b9\u5f0f\uff0c\u80fd\u591f\u5728 <code>REPEATABLE READ</code> \u6a21\u5f0f\u4e0b\u52a0\u9501\u8bbf\u95ee\u5df2\u7ecf\u63d0\u4ea4\u7684\u6570\u636e\uff0c\u5176\u672c\u8eab\u5e76\u4e0d\u80fd\u89e3\u51b3\u5e7b\u8bfb\u7684\u95ee\u9898\uff0c\u800c\u662f\u901a\u8fc7\u6587\u7ae0\u524d\u9762\u63d0\u5230\u7684 <code>Next-Key</code> \u9501\u6765\u89e3\u51b3\u3002</p>"},{"location":"chap1/mysql2_index/","title":"\u7b2c\u4e5d\u8282 \"Shallow dive\" MySQL \u7d22\u5f15\u8bbe\u8ba1\u6982\u8981","text":"<p>\u5728\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u8bbe\u8ba1\u7d22\u5f15\u5176\u5b9e\u5e76\u4e0d\u662f\u590d\u6742\u7684\u4e8b\u60c5\uff0c\u5f88\u591a\u5f00\u53d1\u8005\u90fd\u89c9\u5f97\u8bbe\u8ba1\u7d22\u5f15\u80fd\u591f\u63d0\u5347\u6570\u636e\u5e93\u7684\u6027\u80fd\uff0c\u76f8\u5173\u7684\u77e5\u8bc6\u4e00\u5b9a\u975e\u5e38\u590d\u6742\u3002</p> <p></p> <p>\u7136\u800c\u8fd9\u79cd\u60f3\u6cd5\u662f\u4e0d\u6b63\u786e\u7684\uff0c\u7d22\u5f15\u5176\u5b9e\u5e76\u4e0d\u662f\u4e00\u4e2a\u591a\u4e48\u9ad8\u6df1\u83ab\u6d4b\u7684\u4e1c\u897f\uff0c\u53ea\u8981\u6211\u4eec\u638c\u63e1\u4e00\u5b9a\u7684\u65b9\u6cd5\uff0c\u7406\u89e3\u7d22\u5f15\u7684\u5b9e\u73b0\u5c31\u80fd\u5728\u4e0d\u9700\u8981 <code>DBA</code> \u7684\u60c5\u51b5\u4e0b\u8bbe\u8ba1\u51fa\u9ad8\u6548\u7684\u7d22\u5f15\u3002</p>"},{"location":"chap1/mysql2_index/#1-io","title":"1 \u78c1\u76d8 IO","text":"<p>\u4e00\u4e2a\u6570\u636e\u5e93\u5fc5\u987b\u4fdd\u8bc1\u5176\u4e2d\u5b58\u50a8\u7684\u6240\u6709\u6570\u636e\u90fd\u662f\u53ef\u4ee5\u968f\u65f6\u8bfb\u5199\u7684\uff0c\u540c\u65f6\u56e0\u4e3a <code>MySQL</code> \u4e2d\u6240\u6709\u7684\u6570\u636e\u5176\u5b9e\u90fd\u662f\u4ee5\u6587\u4ef6\u7684\u5f62\u5f0f\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\u7684\uff0c</p> <p>\u800c\u4ece\u78c1\u76d8\u4e0a\u968f\u673a\u8bbf\u95ee\u5bf9\u5e94\u7684\u6570\u636e\u975e\u5e38\u8017\u65f6\uff0c\u6240\u4ee5\u6570\u636e\u5e93\u7a0b\u5e8f\u548c\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e86\u7f13\u51b2\u6c60\u548c\u5185\u5b58\u4ee5\u63d0\u9ad8\u6570\u636e\u7684\u8bbf\u95ee\u901f\u5ea6\u3002</p> <p></p> <p>\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u77e5\u9053\u6570\u636e\u5e93\u5bf9\u6570\u636e\u7684\u8bfb\u53d6\u5e76\u4e0d\u662f\u4ee5\u884c\u4e3a\u5355\u4f4d\u8fdb\u884c\u7684\uff0c\u65e0\u8bba\u662f\u8bfb\u53d6\u4e00\u884c\u8fd8\u662f\u591a\u884c\uff0c\u90fd\u4f1a\u5c06\u8be5\u884c\u6216\u8005\u591a\u884c\u6240\u5728\u7684\u9875\u5168\u90e8\u52a0\u8f7d\u8fdb\u6765\uff0c\u7136\u540e\u518d\u8bfb\u53d6\u5bf9\u5e94\u7684\u6570\u636e\u8bb0\u5f55\uff1b</p> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c\u8bfb\u53d6\u6240\u8017\u8d39\u7684\u65f6\u95f4\u4e0e\u884c\u6570\u65e0\u5173\uff0c\u53ea\u4e0e\u9875\u6570\u6709\u5173\u3002</p> <p></p> <p>\u5728 <code>MySQL</code> \u4e2d\uff0c\u9875\u7684\u5927\u5c0f\u4e00\u822c\u4e3a <code>16KB</code>\uff0c\u4e0d\u8fc7\u4e5f\u53ef\u80fd\u662f <code>8KB</code>\u3001<code>32KB</code> \u6216\u8005\u5176\u4ed6\u503c\uff0c\u8fd9\u8ddf <code>MySQL</code> \u7684\u5b58\u50a8\u5f15\u64ce\u5bf9\u6570\u636e\u7684\u5b58\u50a8\u65b9\u5f0f\u6709\u5f88\u5927\u7684\u5173\u7cfb\uff0c\u6587\u4e2d\u4e0d\u4f1a\u5c55\u5f00\u4ecb\u7ecd\uff0c</p> <p>\u4e0d\u8fc7\u7d22\u5f15\u6216\u884c\u8bb0\u5f55\u662f\u5426\u5728\u7f13\u5b58\u6c60\u4e2d\u6781\u5927\u7684\u5f71\u54cd\u4e86\u8bbf\u95ee\u7d22\u5f15\u6216\u8005\u6570\u636e\u7684\u6210\u672c\u3002</p>"},{"location":"chap1/mysql2_index/#2","title":"2 \u968f\u673a\u8bfb\u53d6","text":"<p>\u6570\u636e\u5e93\u7b49\u5f85\u4e00\u4e2a\u9875\u4ece\u78c1\u76d8\u8bfb\u53d6\u5230\u7f13\u5b58\u6c60\u7684\u6240\u9700\u8981\u7684\u6210\u672c\u5de8\u5927\u7684\uff0c\u65e0\u8bba\u6211\u4eec\u662f\u60f3\u8981\u8bfb\u53d6\u4e00\u4e2a\u9875\u9762\u4e0a\u7684\u591a\u6761\u6570\u636e\u8fd8\u662f\u4e00\u6761\u6570\u636e\uff0c\u90fd\u9700\u8981\u6d88\u8017\u7ea6 10ms \u5de6\u53f3\u7684\u65f6\u95f4\uff1a</p> <p></p> <p>10ms \u7684\u65f6\u95f4\u5728\u8ba1\u7b97\u9886\u57df\u5176\u5b9e\u662f\u4e00\u4e2a\u975e\u5e38\u5de8\u5927\u7684\u6210\u672c\uff0c\u5047\u8bbe\u6211\u4eec\u4f7f\u7528\u811a\u672c\u5411\u88c5\u4e86 SSD \u7684\u78c1\u76d8\u4e0a\u987a\u5e8f\u5199\u5165\u5b57\u8282\uff0c\u90a3\u4e48\u5728 <code>10ms</code> \u5185\u53ef\u4ee5\u5199\u5165\u5927\u6982 <code>3MB</code> \u5de6\u53f3\u7684\u5185\u5bb9\uff0c</p> <p>\u4f46\u662f\u6570\u636e\u5e93\u7a0b\u5e8f\u5728 <code>10ms</code> \u4e4b\u5185\u53ea\u80fd\u5c06\u4e00\u9875\u7684\u6570\u636e\u52a0\u8f7d\u5230\u6570\u636e\u5e93\u7f13\u51b2\u6c60\u4e2d\uff0c\u4ece\u8fd9\u91cc\u53ef\u4ee5\u770b\u51fa\u968f\u673a\u8bfb\u53d6\u7684\u4ee3\u4ef7\u662f\u5de8\u5927\u7684\u3002</p> <p></p> <p>\u8fd9 10ms \u7684\u4e00\u6b21\u968f\u673a\u8bfb\u53d6\u662f\u6309\u7167\u6bcf\u79d2 50 \u6b21\u7684\u8bfb\u53d6\u8ba1\u7b97\u5f97\u5230\u7684\uff0c\u5176\u4e2d\u7b49\u5f85\u65f6\u95f4\u4e3a <code>3ms</code>\u3001\u78c1\u76d8\u7684\u5b9e\u9645\u7e41\u5fd9\u65f6\u95f4\u7ea6\u4e3a 6ms\uff0c\u6700\u7ec8\u6570\u636e\u9875\u4ece\u78c1\u76d8\u4f20\u8f93\u5230\u7f13\u51b2\u6c60\u7684\u65f6\u95f4\u4e3a <code>1ms</code> \u5de6\u53f3\uff0c\u5728\u5bf9\u67e5\u8be2\u8fdb\u884c\u4f30\u7b97\u65f6\u5e76\u4e0d\u9700\u8981\u51c6\u786e\u7684\u77e5\u9053\u968f\u673a\u8bfb\u53d6\u7684\u65f6\u95f4\uff0c\u53ea\u9700\u8981\u77e5\u9053\u4f30\u7b97\u51fa\u7684 <code>10ms</code> \u5c31\u53ef\u4ee5\u4e86\u3002</p>"},{"location":"chap1/mysql2_index/#3","title":"3 \u5185\u5b58\u8bfb\u53d6","text":"<p>\u5982\u679c\u5728\u6570\u636e\u5e93\u7684\u7f13\u5b58\u6c60\u4e2d\u6ca1\u6709\u627e\u5230\u5bf9\u5e94\u7684\u6570\u636e\u9875\uff0c\u90a3\u4e48\u4f1a\u53bb\u5185\u5b58\u4e2d\u5bfb\u627e\u5bf9\u5e94\u7684\u9875\u9762\uff1a</p> <p></p> <p>\u5f53\u5bf9\u5e94\u7684\u9875\u9762\u5b58\u5728\u4e8e\u5185\u5b58\u65f6\uff0c\u6570\u636e\u5e93\u7a0b\u5e8f\u5c31\u4f1a\u4f7f\u7528\u5185\u5b58\u4e2d\u7684\u9875\uff0c\u8fd9\u80fd\u591f\u5c06\u6570\u636e\u7684\u8bfb\u53d6\u65f6\u95f4\u964d\u4f4e\u4e00\u4e2a\u6570\u91cf\u7ea7\uff0c\u5c06 <code>10ms</code> \u964d\u4f4e\u5230 <code>1ms</code>\uff1b</p> <p>MySQL \u5728\u6267\u884c\u8bfb\u64cd\u4f5c\u65f6\uff0c\u4f1a\u5148\u4ece\u6570\u636e\u5e93\u7684\u7f13\u51b2\u533a\u4e2d\u8bfb\u53d6\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u4e0e\u7f13\u51b2\u533a\u4e2d\u5c31\u4f1a\u5c1d\u8bd5\u4ece\u5185\u5b58\u4e2d\u52a0\u8f7d\u9875\u9762\uff0c\u5982\u679c\u524d\u9762\u7684\u4e24\u4e2a\u6b65\u9aa4\u90fd\u5931\u8d25\u4e86\uff0c\u6700\u540e\u5c31\u53ea\u80fd\u6267\u884c\u968f\u673a IO \u4ece\u78c1\u76d8\u4e2d\u83b7\u53d6\u5bf9\u5e94\u7684\u6570\u636e\u9875\u3002</p>"},{"location":"chap1/mysql2_index/#4","title":"4 \u987a\u5e8f\u8bfb\u53d6","text":"<p>\u4ece\u78c1\u76d8\u8bfb\u53d6\u6570\u636e\u5e76\u4e0d\u662f\u90fd\u8981\u4ed8\u51fa\u5f88\u5927\u7684\u4ee3\u4ef7\uff0c\u5f53\u6570\u636e\u5e93\u7ba1\u7406\u7a0b\u5e8f\u4e00\u6b21\u6027\u4ece\u78c1\u76d8\u4e2d\u987a\u5e8f\u8bfb\u53d6\u5927\u91cf\u7684\u6570\u636e\u65f6\uff0c\u8bfb\u53d6\u7684\u901f\u5ea6\u4f1a\u5f02\u5e38\u7684\u5feb\uff0c\u5927\u6982\u5728 <code>40MB/s</code>\u5de6\u53f3\u3002</p> <p></p> <p>\u5982\u679c\u4e00\u4e2a\u9875\u9762\u7684\u5927\u5c0f\u4e3a <code>4KB</code>\uff0c\u90a3\u4e48 <code>1s</code> \u7684\u65f6\u95f4\u5c31\u53ef\u4ee5\u8bfb\u53d6 <code>10000</code> \u4e2a\u9875\uff0c\u8bfb\u53d6\u4e00\u4e2a\u9875\u9762\u6240\u82b1\u8d39\u7684\u5e73\u5747\u65f6\u95f4\u5c31\u662f <code>0.1ms</code>\uff0c\u76f8\u6bd4\u968f\u673a\u8bfb\u53d6\u7684 <code>10ms</code> \u5df2\u7ecf\u964d\u4f4e\u4e86\u4e24\u4e2a\u6570\u91cf\u7ea7\uff0c\u751a\u81f3\u6bd4\u5185\u5b58\u4e2d\u8bfb\u53d6\u6570\u636e\u8fd8\u8981\u5feb\u3002</p> <p></p> <p>\u6570\u636e\u9875\u9762\u7684\u987a\u5e8f\u8bfb\u53d6\u6709\u4e24\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u4f18\u52bf\uff1a</p> <ol> <li>\u540c\u65f6\u8bfb\u53d6\u591a\u4e2a\u754c\u9762\u610f\u5473\u7740\u603b\u65f6\u95f4\u7684\u6d88\u8017\u4f1a\u5927\u5e45\u5ea6\u51cf\u5c11\uff0c\u78c1\u76d8\u7684\u541e\u5410\u91cf\u53ef\u4ee5\u8fbe\u5230 40MB/s\uff1b</li> <li>\u6570\u636e\u5e93\u7ba1\u7406\u7a0b\u5e8f\u4f1a\u5bf9\u4e00\u4e9b\u5373\u5c06\u4f7f\u7528\u7684\u754c\u9762\u8fdb\u884c\u9884\u8bfb\uff0c\u4ee5\u51cf\u5c11\u67e5\u8be2\u8bf7\u6c42\u7684\u7b49\u5f85\u548c\u54cd\u5e94\u65f6\u95f4\uff1b</li> </ol>"},{"location":"chap1/mysql2_index/#_1","title":"\u5c0f\u7ed3","text":"<p>\u6570\u636e\u5e93\u67e5\u8be2\u64cd\u4f5c\u7684\u65f6\u95f4\u5927\u90fd\u6d88\u8017\u5728\u4ece\u78c1\u76d8\u6216\u8005\u5185\u5b58\u4e2d\u8bfb\u53d6\u6570\u636e\u7684\u8fc7\u7a0b\uff0c\u7531\u4e8e\u968f\u673a IO \u7684\u4ee3\u4ef7\u5de8\u5927\uff0c\u5982\u4f55\u5728\u4e00\u6b21\u6570\u636e\u5e93\u67e5\u8be2\u4e2d\u51cf\u5c11\u968f\u673a IO \u7684\u6b21\u6570\u5f80\u5f80\u80fd\u591f\u5927\u5e45\u5ea6\u7684\u964d\u4f4e\u67e5\u8be2\u6240\u8017\u8d39\u7684\u65f6\u95f4\u63d0\u9ad8\u78c1\u76d8\u7684\u541e\u5410\u91cf\u3002</p>"},{"location":"chap1/mysql2_index/#5","title":"5 \u67e5\u8be2\u8fc7\u7a0b","text":"<p>\u5728\u4e0a\u4e00\u8282\u4e2d\uff0c\u6587\u7ae0\u4ece\u6570\u636e\u9875\u52a0\u8f7d\u7684\u89d2\u5ea6\u4ecb\u7ecd\u4e86\u78c1\u76d8 IO \u5bf9 MySQL \u67e5\u8be2\u7684\u5f71\u54cd\uff0c\u800c\u5728\u8fd9\u4e00\u8282\u4e2d\u5c06\u4ecb\u7ecd MySQL \u67e5\u8be2\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\u4ee5\u53ca\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u7684\u7279\u5f81\u5bf9\u6700\u7ec8\u67e5\u8be2\u6027\u80fd\u7684\u5f71\u54cd\u3002</p>"},{"location":"chap1/mysql2_index/#5-1-index-slices","title":"5-1 \u7d22\u5f15\u7247\uff08Index Slices\uff09","text":"<p>\u7d22\u5f15\u7247\u5176\u5b9e\u5c31\u662f <code>SQL</code> \u67e5\u8be2\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u626b\u63cf\u7684\u4e00\u4e2a\u7d22\u5f15\u7247\u6bb5\uff0c\u5728\u8fd9\u4e2a\u8303\u56f4\u4e2d\u7684\u7d22\u5f15\u5c06\u88ab\u987a\u5e8f\u626b\u63cf\uff0c\u6839\u636e\u7d22\u5f15\u7247\u5305\u542b\u7684\u5217\u6570\u4e0d\u540c\uff0c\u6570\u636e\u5e93\u7d22\u5f15\u8bbe\u8ba1\u4e0e\u4f18\u5316\u4e66\u4e2d\u5bf9\u5c06\u7d22\u5f15\u5206\u4e3a\u5bbd\u7d22\u5f15\u548c\u7a84\u7d22\u5f15\uff1a</p> <p></p> <p>\u4e3b\u952e\u5217 id \u5728\u6240\u6709\u7684 MySQL \u7d22\u5f15\u4e2d\u90fd\u662f\u4e00\u5b9a\u4f1a\u5b58\u5728\u7684\u3002</p> <pre><code>SELECT id, username, age FROM users WHERE username=\"draven\"\n</code></pre> <ul> <li>(<code>id, username</code>) \u5c31\u662f\u4e00\u4e2a\u7a84\u7d22\u5f15\uff0c\u56e0\u4e3a\u8be5\u7d22\u5f15\u6ca1\u6709\u5305\u542b\u5b58\u5728\u4e8e <code>SQL</code> \u67e5\u8be2\u4e2d\u7684 <code>age</code> \u5217\uff0c</li> <li> <p>(<code>id, username, age</code>) \u5c31\u662f\u8be5\u67e5\u8be2\u7684\u4e00\u4e2a\u5bbd\u7d22\u5f15\u4e86\uff0c\u5b83\u5305\u542b\u8fd9\u4e2a\u67e5\u8be2\u4e2d\u6240\u9700\u8981\u7684\u5168\u90e8\u6570\u636e\u5217\u3002</p> </li> <li> <p>\u5bbd\u7d22\u5f15\u80fd\u591f\u907f\u514d\u4e8c\u6b21\u7684\u968f\u673a IO\uff0c</p> </li> <li>\u800c\u7a84\u7d22\u5f15\u5c31\u9700\u8981\u5728\u5bf9\u7d22\u5f15\u8fdb\u884c\u987a\u5e8f\u8bfb\u53d6\u4e4b\u540e\u518d\u6839\u636e\u4e3b\u952e id \u4ece\u4e3b\u952e\u7d22\u5f15\u4e2d\u67e5\u627e\u5bf9\u5e94\u7684\u6570\u636e\uff1a</li> </ul> <p></p> <p>\u5bf9\u4e8e\u7a84\u7d22\u5f15\uff0c\u6bcf\u4e00\u4e2a\u5728\u7d22\u5f15\u4e2d\u5339\u914d\u5230\u7684\u8bb0\u5f55\u884c\u6700\u7ec8\u90fd\u9700\u8981\u6267\u884c\u53e6\u5916\u7684\u968f\u673a\u8bfb\u53d6\u4ece\u805a\u96c6\u7d22\u5f15\u4e2d\u83b7\u5f97\u5269\u4f59\u7684\u6570\u636e\uff0c\u5982\u679c\u7ed3\u679c\u96c6\u975e\u5e38\u5927\uff0c\u90a3\u4e48\u5c31\u4f1a\u5bfc\u81f4\u968f\u673a\u8bfb\u53d6\u7684\u6b21\u6570\u8fc7\u591a\u8fdb\u800c\u5f71\u54cd\u6027\u80fd\u3002</p>"},{"location":"chap1/mysql2_index/#5-2","title":"5-2 \u8fc7\u6ee4\u56e0\u5b50","text":"<p>\u4ece\u4e0a\u4e00\u5c0f\u8282\u5bf9\u7d22\u5f15\u7247\u7684\u4ecb\u7ecd\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5f71\u54cd SQL \u67e5\u8be2\u7684\u9664\u4e86\u67e5\u8be2\u672c\u8eab\u8fd8\u4e0e\u6570\u636e\u5e93\u8868\u4e2d\u7684\u6570\u636e\u7279\u5f81\u6709\u5173\uff0c\u5982\u679c\u4f7f\u7528\u7684\u662f\u7a84\u7d22\u5f15\u90a3\u4e48\u5bf9\u8868\u7684\u968f\u673a\u8bbf\u95ee\u5c31\u4e0d\u53ef\u907f\u514d\uff0c\u5728\u8fd9\u65f6\u5982\u4f55\u8ba9\u7d22\u5f15\u7247\u53d8\u300e\u8584\u300f\u5c31\u662f\u6211\u4eec\u9700\u8981\u505a\u7684\u4e86\u3002</p> <p>\u4e00\u4e2a <code>SQL</code> \u67e5\u8be2\u626b\u63cf\u7684\u7d22\u5f15\u7247\u5927\u5c0f\u5176\u5b9e\u662f\u7531\u8fc7\u6ee4\u56e0\u5b50\u51b3\u5b9a\u7684\uff0c\u4e5f\u5c31\u662f\u6ee1\u8db3\u67e5\u8be2\u6761\u4ef6\u7684\u8bb0\u5f55\u884c\u6570\u6240\u5360\u7684\u6bd4\u4f8b\uff1a</p> <p></p> <ul> <li>\u5bf9\u4e8e <code>users</code> \u8868\u6765\u8bf4\uff0c<code>sex=\u201dmale\u201d</code> \u5c31\u4e0d\u662f\u4e00\u4e2a\u597d\u7684\u8fc7\u6ee4\u56e0\u5b50\uff0c\u5b83\u4f1a\u9009\u62e9\u6574\u5f20\u8868\u4e2d\u4e00\u534a\u7684\u6570\u636e\uff0c\u6240\u4ee5\u5728\u4e00\u822c\u60c5\u51b5\u4e0b\u6211\u4eec\u6700\u597d\u4e0d\u8981\u4f7f\u7528 <code>sex</code> \u5217\u4f5c\u4e3a\u6574\u4e2a\u7d22\u5f15\u7684\u7b2c\u4e00\u5217\uff1b</li> <li>\u800c <code>name=\u201ddraven\u201d</code> \u7684\u4f7f\u7528\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u8fc7\u6ee4\u56e0\u5b50\u4e86\uff0c\u5b83\u7684\u4f7f\u7528\u80fd\u8fc7\u6ee4\u6574\u4e2a\u6570\u636e\u8868\u4e2d <code>99.9%</code> \u7684\u6570\u636e\uff1b</li> <li>\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u5c06\u8fd9\u4e09\u4e2a\u8fc7\u6ee4\u8fdb\u884c\u7ec4\u5408\uff0c\u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u7d22\u5f15<code>(name, age, sex)</code>\u5e76\u540c\u65f6\u4f7f\u7528\u8fd9\u4e09\u5217\u4f5c\u4e3a\u8fc7\u6ee4\u6761\u4ef6</li> </ul> <p></p> <p>\u5f53\u4e09\u4e2a\u8fc7\u6ee4\u6761\u4ef6\u90fd\u662f\u7b49\u503c\u8c13\u8bcd\u65f6\uff0c\u51e0\u4e2a\u7d22\u5f15\u5217\u7684\u987a\u5e8f\u5176\u5b9e\u662f\u65e0\u6240\u8c13\u7684\uff0c\u7d22\u5f15\u5217\u7684\u987a\u5e8f\u4e0d\u4f1a\u5f71\u54cd\u540c\u4e00\u4e2a SQL \u8bed\u53e5\u5bf9\u7d22\u5f15\u7684\u9009\u62e9\uff0c\u4e5f\u5c31\u662f\u7d22\u5f15 (<code>name, age, sex</code>) \u548c (<code>age, sex, name</code>) \u5bf9\u4e8e\u4e0a\u56fe\u4e2d\u7684\u6761\u4ef6\u6765\u8bf4\u662f\u5b8c\u5168\u4e00\u6837\u7684\uff0c\u8fd9\u4e24\u4e2a\u7d22\u5f15\u5728\u6267\u884c\u67e5\u8be2\u65f6\u90fd\u6709\u7740\u5b8c\u5168\u76f8\u540c\u7684\u6548\u679c\u3002</p> <p>\u7ec4\u5408\u6761\u4ef6\u7684\u8fc7\u6ee4\u56e0\u5b50\u5c31\u53ef\u4ee5\u8fbe\u5230\u5341\u4e07\u5206\u4e4b <code>6</code> \u4e86\uff0c\u5982\u679c\u6574\u5f20\u8868\u4e2d\u6709 <code>10w</code> \u884c\u6570\u636e\uff0c\u4e5f\u53ea\u9700\u8981\u5728\u626b\u63cf\u8584\u7d22\u5f15\u7247\u540e\u8fdb\u884c <code>6</code> \u6b21\u968f\u673a\u8bfb\u53d6\uff0c\u8fd9\u79cd\u76f4\u63a5\u4f7f\u7528\u4e58\u79ef\u6765\u8ba1\u7b97\u7ec4\u5408\u6761\u4ef6\u7684\u8fc7\u6ee4\u56e0\u5b50\u5176\u5b9e\u6709\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u95ee\u9898\uff1a</p> <p>\u5217\u4e0e\u5217\u4e4b\u95f4\u4e0d\u5e94\u8be5\u6709\u592a\u5f3a\u7684\u76f8\u5173\u6027\uff0c\u5982\u679c\u4e0d\u540c\u7684\u5217\u4e4b\u95f4\u6709\u76f8\u5173\u6027\uff0c\u90a3\u4e48\u5f97\u5230\u7684\u7ed3\u679c\u5c31\u4f1a\u6bd4\u76f4\u63a5\u4e58\u79ef\u5f97\u51fa\u7684\u7ed3\u679c\u5927\u4e00\u4e9b\uff0c\u6bd4\u5982\uff1a\u6240\u5728\u7684\u57ce\u5e02\u548c\u90ae\u653f\u7f16\u7801\u5c31\u6709\u975e\u5e38\u5f3a\u7684\u76f8\u5173\u6027\uff0c\u4e24\u8005\u7684\u8fc7\u6ee4\u56e0\u5b50\u76f4\u63a5\u76f8\u4e58\u5176\u5b9e\u4e0e\u5b9e\u9645\u7684\u8fc7\u6ee4\u56e0\u5b50\u4f1a\u6709\u5f88\u5927\u7684\u504f\u5dee\uff0c\u4e0d\u8fc7\u8fd9\u5728\u591a\u6570\u60c5\u51b5\u4e0b\u90fd\u4e0d\u662f\u592a\u5927\u7684\u95ee\u9898\u3002</p> <p>\u5bf9\u4e8e\u4e00\u5f20\u8868\u4e2d\u7684\u540c\u4e00\u4e2a\u5217\uff0c\u4e0d\u540c\u7684\u503c\u4e5f\u4f1a\u6709\u4e0d\u540c\u7684\u8fc7\u6ee4\u56e0\u5b50\uff0c\u8fd9\u4e5f\u5c31\u9020\u6210\u4e86\u540c\u4e00\u5217\u7684\u4e0d\u540c\u503c\u6700\u7ec8\u7684\u67e5\u8be2\u6027\u80fd\u4e5f\u4f1a\u6709\u5f88\u5927\u5dee\u522b\uff1a</p> <p></p> <p>\u5f53\u6211\u4eec\u8bc4\u4f30\u4e00\u4e2a\u7d22\u5f15\u662f\u5426\u5408\u9002\u65f6\uff0c\u9700\u8981\u8003\u8651\u6781\u7aef\u60c5\u51b5\u4e0b\u67e5\u8be2\u8bed\u53e5\u7684\u6027\u80fd\uff0c\u6bd4\u5982 <code>0%</code> \u6216\u8005 <code>50%</code> \u7b49\uff1b</p> <p>\u6700\u5dee\u7684\u8f93\u5165\u5f80\u5f80\u610f\u5473\u7740\u6700\u5dee\u7684\u6027\u80fd\uff0c\u5728\u5e73\u5747\u60c5\u51b5\u4e0b\u8868\u73b0\u826f\u597d\u7684 SQL \u8bed\u53e5\u5728\u6781\u7aef\u7684\u8f93\u5165\u4e0b\u53ef\u80fd\u5c31\u5b8c\u5168\u65e0\u6cd5\u6b63\u5e38\u5de5\u4f5c\uff0c\u8fd9\u4e5f\u662f\u5728\u8bbe\u8ba1\u7d22\u5f15\u65f6\u9700\u8981\u6ce8\u610f\u7684\u95ee\u9898\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0c\u9700\u8981\u626b\u63cf\u7684\u7d22\u5f15\u7247\u7684\u5927\u5c0f\u5bf9\u67e5\u8be2\u6027\u80fd\u7684\u5f71\u54cd\u81f3\u5173\u91cd\u8981\uff0c\u800c\u626b\u63cf\u7684\u7d22\u5f15\u8bb0\u5f55\u7684\u6570\u91cf\uff0c\u5c31\u662f\u603b\u884c\u6570\u4e0e\u7ec4\u5408\u6761\u4ef6\u7684\u8fc7\u6ee4\u56e0\u5b50\u7684\u4e58\u79ef\uff0c\u7d22\u5f15\u7247\u7684\u5927\u5c0f\u6700\u7ec8\u4e5f\u51b3\u5b9a\u4e86\u4ece\u8868\u4e2d\u8bfb\u53d6\u6570\u636e\u6240\u9700\u8981\u7684\u65f6\u95f4\u3002</p>"},{"location":"chap1/mysql2_index/#6","title":"6 \u5339\u914d\u5217\u4e0e\u8fc7\u6ee4\u5217","text":"<p>\u5047\u8bbe\u5728 <code>users</code> \u8868\u4e2d\u6709 <code>name</code>\u3001<code>age</code> \u548c (<code>name, sex, age</code>) \u4e09\u4e2a\u8f85\u52a9\u7d22\u5f15\uff1b</p> <p>\u5f53<code>WHERE</code> \u6761\u4ef6\u4e2d\u5b58\u5728\u7c7b\u4f3c <code>age = 21</code> \u6216\u8005 <code>name = \u201cdraven\u201d</code> \u8fd9\u79cd\u7b49\u503c\u8c13\u8bcd\u65f6\uff0c\u5b83\u4eec\u90fd\u4f1a\u6210\u4e3a\u5339\u914d\u5217\uff08<code>Matching Column</code>\uff09\u7528\u4e8e\u9009\u62e9\u7d22\u5f15\u6811\u4e2d\u7684\u6570\u636e\u884c\uff0c\u4f46\u662f\u5f53\u6211\u4eec\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8be2\u65f6\uff1a</p> <pre><code>SELECT * FROM users\nWHERE name = \"draven\" AND sex = \"male\" AND age &gt; 20;\n</code></pre> <p>\u867d\u7136\u6211\u4eec\u6709 (<code>name, sex, age</code>) \u7d22\u5f15\u5305\u542b\u4e86\u4e0a\u8ff0\u67e5\u8be2\u6761\u4ef6\u4e2d\u7684\u5168\u90e8\u5217\uff0c\u4f46\u662f\u5728\u8fd9\u91cc\u53ea\u6709 <code>name</code> \u548c <code>sex</code> \u4e24\u5217\u624d\u662f\u5339\u914d\u5217\uff0c<code>MySQL</code> \u5728\u6267\u884c\u4e0a\u8ff0\u67e5\u8be2\u65f6\uff0c\u4f1a\u9009\u62e9 <code>name</code>\u548c <code>sex</code> \u4f5c\u4e3a\u5339\u914d\u5217\uff0c\u626b\u63cf\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u884c\uff0c\u7136\u540e\u5c06 <code>age</code> \u5f53\u505a\u8fc7\u6ee4\u5217\uff08<code>Filtering Column</code>\uff09\uff1a</p> <p></p> <p>\u8fc7\u6ee4\u5217\u867d\u7136\u4e0d\u80fd\u591f\u51cf\u5c11\u7d22\u5f15\u7247\u7684\u5927\u5c0f\uff0c\u4f46\u662f\u80fd\u591f\u51cf\u5c11\u4ece\u8868\u4e2d\u968f\u673a\u8bfb\u53d6\u6570\u636e\u7684\u6b21\u6570\uff0c\u6240\u4ee5\u5728\u7d22\u5f15\u4e2d\u4e5f\u626e\u6f14\u7740\u975e\u5e38\u91cd\u8981\u7684\u89d2\u8272\u3002</p>"},{"location":"chap1/mysql2_index/#7","title":"7 \u7d22\u5f15\u7684\u8bbe\u8ba1","text":"<p>\u4f5c\u8005\u76f8\u4fe1\u6587\u7ae0\u524d\u9762\u7684\u5185\u5bb9\u5df2\u7ecf\u4e3a\u7d22\u5f15\u7684\u8bbe\u8ba1\u63d0\u4f9b\u4e86\u5145\u8db3\u7684\u7406\u8bba\u57fa\u7840\u548c\u77e5\u8bc6\uff0c\u4ece\u603b\u4f53\u6765\u770b\u5982\u4f55\u51cf\u5c11\u968f\u673a\u8bfb\u53d6\u7684\u6b21\u6570\u662f\u8bbe\u8ba1\u7d22\u5f15\u65f6\u9700\u8981\u91cd\u89c6\u7684\u6700\u91cd\u8981\u7684\u95ee\u9898\uff0c\u5728\u8fd9\u4e00\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u4ecb\u7ecd \u6570\u636e\u5e93\u7d22\u5f15\u8bbe\u8ba1\u4e0e\u4f18\u5316 \u4e00\u4e66\u4e2d\u5f52\u7eb3\u51fa\u7684\u8bbe\u8ba1\u6700\u4f73\u7d22\u5f15\u7684\u65b9\u6cd5\u3002</p>"},{"location":"chap1/mysql2_index/#1","title":"1 \u4e09\u661f\u7d22\u5f15","text":"<p>\u4e09\u661f\u7d22\u5f15\u662f\u5bf9\u4e8e\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u53ef\u80fd\u7684\u6700\u597d\u7d22\u5f15\uff0c\u5982\u679c\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u7d22\u5f15\u662f\u4e09\u661f\u7d22\u5f15\uff0c\u90a3\u4e48\u5b83\u53ea\u9700\u8981\u8fdb\u884c\u4e00\u6b21\u78c1\u76d8\u7684\u968f\u673a\u8bfb\u53ca\u4e00\u4e2a\u7a84\u7d22\u5f15\u7247\u7684\u987a\u5e8f\u626b\u63cf\u5c31\u53ef\u4ee5\u5f97\u5230\u5168\u90e8\u7684\u7ed3\u679c\u96c6\uff1b</p> <p>\u56e0\u6b64\u5176\u67e5\u8be2\u7684\u54cd\u5e94\u65f6\u95f4\u6bd4\u666e\u901a\u7684\u7d22\u5f15\u4f1a\u5c11\u51e0\u4e2a\u6570\u91cf\u7ea7\uff1b</p> <p>\u6839\u636e\u4e66\u4e2d\u5bf9\u4e09\u661f\u7d22\u5f15\u7684\u5b9a\u4e49\uff0c\u6211\u4eec\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e3b\u952e\u7d22\u5f15\u5bf9\u4e8e <code>WHERE id = 1</code> \u5c31\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u4e09\u661f\u7d22\u5f15\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5bf9\u4e3b\u952e\u7d22\u5f15\u6811\u8fdb\u884c\u4e00\u6b21\u7d22\u5f15\u8bbf\u95ee\u5e76\u4e14\u987a\u5e8f\u8bfb\u53d6\u4e00\u6761\u6570\u636e\u8bb0\u5f55\u67e5\u8be2\u5c31\u7ed3\u675f\u4e86\u3002</p> <p></p> <p>\u4e3a\u4e86\u6ee1\u8db3\u4e09\u661f\u7d22\u5f15\u4e2d\u7684\u4e09\u9897\u661f\uff0c\u6211\u4eec\u5206\u522b\u9700\u8981\u505a\u4ee5\u4e0b\u51e0\u4ef6\u4e8b\u60c5\uff1a</p> <ol> <li>\u7b2c\u4e00\u9897\u661f\u9700\u8981\u53d6\u51fa\u6240\u6709\u7b49\u503c\u8c13\u8bcd\u4e2d\u7684\u5217\uff0c\u4f5c\u4e3a\u7d22\u5f15\u5f00\u5934\u7684\u6700\u5f00\u59cb\u7684\u5217\uff08\u4efb\u610f\u987a\u5e8f\uff09\uff1b</li> <li>\u7b2c\u4e8c\u9897\u661f\u9700\u8981\u5c06<code>ORDER BY</code> \u5217\u52a0\u5165\u7d22\u5f15\u4e2d\uff1b</li> <li>\u7b2c\u4e09\u9897\u661f\u9700\u8981\u5c06\u67e5\u8be2\u8bed\u53e5\u5269\u4f59\u7684\u5217\u5168\u90e8\u52a0\u5165\u5230\u7d22\u5f15\u4e2d\uff1b</li> </ol> <p>\u5982\u679c\u5bf9\u4e8e\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u6211\u4eec\u4f9d\u7167\u4e0a\u8ff0\u7684\u4e09\u4e2a\u6761\u4ef6\u8fdb\u884c\u8bbe\u8ba1\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u5f97\u5230\u8be5\u67e5\u8be2\u7684\u4e09\u661f\u7d22\u5f15\uff0c\u8fd9\u4e09\u9897\u661f\u4e2d\u7684\u6700\u540e\u4e00\u9897\u661f\u5f80\u5f80\u90fd\u662f\u6700\u5bb9\u6613\u83b7\u5f97\u7684\uff0c\u6ee1\u8db3\u7b2c\u4e09\u9897\u661f\u7684\u7d22\u5f15\u4e5f\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684\u5bbd\u7d22\u5f15\uff0c\u80fd\u591f\u907f\u514d\u5927\u91cf\u7684\u968f\u673a IO\uff0c\u5982\u679c\u6211\u4eec\u9075\u5faa\u8fd9\u4e2a\u987a\u5e8f\u4e3a\u4e00\u4e2a SQL \u67e5\u8be2\u8bbe\u8ba1\u7d22\u5f15\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u5b8c\u7f8e\u7684\u7d22\u5f15\u4e86\uff1b\u8fd9\u4e09\u9897\u661f\u7684\u83b7\u5f97\u5176\u5b9e\u4e5f\u6ca1\u6709\u8868\u9762\u4e0a\u8fd9\u4e48\u7b80\u5355\uff0c\u6bcf\u4e00\u9897\u661f\u90fd\u6709\u81ea\u5df1\u7684\u610f\u4e49\uff1a</p> <p></p> <ol> <li>\u7b2c\u4e00\u9897\u661f\u4e0d\u53ea\u662f\u5c06\u7b49\u503c\u8c13\u8bcd\u7684\u5217\u52a0\u5165\u7d22\u5f15\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u51cf\u5c11\u7d22\u5f15\u7247\u7684\u5927\u5c0f\u4ee5\u51cf\u5c11\u9700\u8981\u626b\u63cf\u7684\u6570\u636e\u884c\uff1b</li> <li>\u7b2c\u4e8c\u9897\u661f\u7528\u4e8e\u907f\u514d\u6392\u5e8f\uff0c\u51cf\u5c11\u78c1\u76d8 IO \u548c\u5185\u5b58\u7684\u4f7f\u7528\uff1b</li> <li>\u7b2c\u4e09\u9897\u661f\u7528\u4e8e\u907f\u514d\u6bcf\u4e00\u4e2a\u7d22\u5f15\u5bf9\u5e94\u7684\u6570\u636e\u884c\u90fd\u9700\u8981\u8fdb\u884c\u4e00\u6b21\u968f\u673a <code>IO</code> \u4ece\u805a\u96c6\u7d22\u5f15\u4e2d\u8bfb\u53d6\u5269\u4f59\u7684\u6570\u636e\uff1b</li> </ol> <p>\u5728\u5b9e\u9645\u573a\u666f\u4e2d\uff0c\u95ee\u9898\u5f80\u5f80\u6ca1\u6709\u8fd9\u4e48\u7b80\u5355\uff0c\u6211\u4eec\u867d\u7136\u53ef\u4ee5\u603b\u80fd\u591f\u901a\u8fc7\u5bbd\u7d22\u5f15\u907f\u514d\u5927\u91cf\u7684\u968f\u673a\u8bbf\u95ee\uff0c\u4f46\u662f\u5728\u4e00\u4e9b\u590d\u6742\u7684\u67e5\u8be2\u4e2d\u6211\u4eec\u65e0\u6cd5\u540c\u65f6\u83b7\u5f97\u7b2c\u4e00\u9897\u661f\u548c\u7b2c\u4e8c\u9897\u661f\u3002</p> <pre><code>SELECT id, name, age FROM users\nWHERE age BETWEEN 18 AND 21\n  AND city = \"Beijing\"\nORDER BY name;\n</code></pre> <p>\u5728\u4e0a\u8ff0\u67e5\u8be2\u4e2d\uff0c\u6211\u4eec\u603b\u53ef\u4ee5\u901a\u8fc7\u589e\u52a0\u7d22\u5f15\u4e2d\u7684\u5217\u4ee5\u83b7\u5f97\u7b2c\u4e09\u9897\u661f\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u60f3\u8981\u83b7\u5f97\u7b2c\u4e00\u9897\u661f\u5c31\u9700\u8981\u6700\u5c0f\u5316\u7d22\u5f15\u7247\u7684\u5927\u5c0f\uff0c\u8fd9\u65f6\u7d22\u5f15\u7684\u524d\u7f00\u5fc5\u987b\u4e3a (<code>city, age</code>)\uff0c\u5728\u8fd9\u65f6\u518d\u60f3\u83b7\u5f97\u4e09\u9897\u661f\u5c31\u4e0d\u53ef\u80fd\u4e86\uff0c\u54ea\u6015\u5728 <code>age</code> \u7684\u540e\u9762\u6dfb\u52a0\u7d22\u5f15\u5217 <code>name</code>\uff0c\u4e5f\u4f1a\u56e0\u4e3a <code>name</code> \u5728\u8303\u56f4\u7d22\u5f15\u5217 <code>age</code> \u540e\u9762\u5fc5\u987b\u8fdb\u884c\u4e00\u6b21\u6392\u5e8f\u64cd\u4f5c\uff0c\u6700\u7ec8\u5f97\u5230\u7684\u7d22\u5f15\u5c31\u662f (<code>city, age, name, id</code>)\uff1a</p> <p></p> <p>\u5982\u679c\u6211\u4eec\u9700\u8981\u5728\u5185\u5b58\u4e2d\u907f\u514d\u6392\u5e8f\u7684\u8bdd\uff0c</p> <p>\u5c31\u9700\u8981\u4ea4\u6362 <code>age</code> \u548c <code>name</code> \u7684\u4f4d\u7f6e\u4e86\uff0c\u5728\u8fd9\u65f6\u5c31\u53ef\u4ee5\u5f97\u5230\u7d22\u5f15 (<code>city, name, age, id</code>)\uff0c\u5f53\u4e00\u4e2a <code>SQL</code> \u67e5\u8be2\u4e2d\u540c\u65f6\u62e5\u6709\u8303\u56f4\u8c13\u8bcd\u548c <code>ORDER BY</code> \u65f6\uff0c\u65e0\u8bba\u5982\u4f55\u6211\u4eec\u90fd\u662f\u6ca1\u6709\u529e\u6cd5\u83b7\u5f97\u4e00\u4e2a\u4e09\u661f\u7d22\u5f15\u7684\uff0c\u6211\u4eec\u80fd\u591f\u505a\u7684\u5c31\u662f\u5728\u8fd9\u4e24\u8005\u4e4b\u95f4\u505a\u51fa\u9009\u62e9\uff0c\u662f\u727a\u7272\u7b2c\u4e00\u9897\u661f\u8fd8\u662f\u7b2c\u4e8c\u9897\u661f\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0c\u5728\u8bbe\u8ba1\u5355\u8868\u7684\u7d22\u5f15\u65f6\uff0c</p> <ul> <li>\u9996\u5148\u628a\u67e5\u8be2\u4e2d\u6240\u6709\u7684<code>\u7b49\u503c\u8c13\u8bcd</code>\u5168\u90e8\u53d6\u51fa\u4ee5\u4efb\u610f\u987a\u5e8f\u653e\u5728\u7d22\u5f15\u6700\u524d\u9762\uff0c</li> <li>\u5728\u8fd9\u65f6\uff0c\u5982\u679c\u7d22\u5f15\u4e2d\u540c\u65f6\u5b58\u5728\u8303\u56f4\u7d22\u5f15\u548c <code>ORDER BY</code> \u5c31\u9700\u8981\u6743\u8861\u5229\u5f0a\u4e86\uff0c</li> </ul> <p>\u5e0c\u671b\u6700\u5c0f\u5316\u626b\u63cf\u7684\u7d22\u5f15\u7247\u539a\u5ea6\u65f6\uff0c\u5e94\u8be5\u5c06\u8fc7\u6ee4\u56e0\u5b50\u6700\u5c0f\u7684\u8303\u56f4\u7d22\u5f15\u5217\u52a0\u5165\u7d22\u5f15\uff0c\u5982\u679c\u5e0c\u671b\u907f\u514d\u6392\u5e8f\u5c31\u9009\u62e9 <code>ORDER BY</code>\u4e2d\u7684\u5168\u90e8\u5217\uff0c\u5728\u8fd9\u4e4b\u540e\u5c31\u53ea\u9700\u8981\u5c06\u67e5\u8be2\u4e2d\u5269\u4f59\u7684\u5168\u90e8\u5217\u52a0\u5165\u7d22\u5f15\u4e86\uff0c\u901a\u8fc7\u8fd9\u79cd\u56fa\u5b9a\u7684\u65b9\u6cd5\u548c\u903b\u8f91\u5c31\u53ef\u4ee5\u6700\u5feb\u5730\u83b7\u5f97\u4e00\u4e2a\u67e5\u8be2\u8bed\u53e5\u7684\u4e8c\u661f\u6216\u8005\u4e09\u661f\u7d22\u5f15\u4e86\u3002</p>"},{"location":"chap1/mysql3_transaction/","title":"\u7b2c\u516b\u8282 \"Shallow Dive\" MySQL \u4e2d\u4e8b\u52a1\u7684\u5b9e\u73b0(<code>transaction</code>)","text":"<ul> <li>\u539f\u5b50\u6027</li> <li>\u6301\u4e45\u6027</li> <li>\u56de\u6eda\u65e5\u5fd7\u548c\u91cd\u505a\u65e5\u5fd7</li> <li>\u9694\u79bb\u6027</li> <li>\u9694\u79bb\u7ea7\u522b\u7684\u5b9e\u73b0</li> <li>\u9694\u79bb\u6027\u4e0e\u539f\u5b50\u6027</li> <li>\u4e00\u81f4\u6027</li> </ul> <p>\u5728\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\uff0c\u4e8b\u52a1\u7684\u91cd\u8981\u6027\u4e0d\u8a00\u800c\u55bb\uff0c\u53ea\u8981\u5bf9\u6570\u636e\u5e93\u7a0d\u6709\u4e86\u89e3\u7684\u4eba\u90fd\u77e5\u9053\u4e8b\u52a1\u5177\u6709 ACID \u56db\u4e2a\u57fa\u672c\u5c5e\u6027\uff0c\u800c\u6211\u4eec\u4e0d\u77e5\u9053\u7684\u53ef\u80fd\u5c31\u662f\u6570\u636e\u5e93\u662f\u5982\u4f55\u5b9e\u73b0\u8fd9\u56db\u4e2a\u5c5e\u6027\u7684\uff1b</p> <p>\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u5bf9\u4e8b\u52a1\u7684\u5b9e\u73b0\u8fdb\u884c\u5206\u6790\uff0c\u5c1d\u8bd5\u7406\u89e3\u6570\u636e\u5e93\u662f\u5982\u4f55\u5b9e\u73b0\u4e8b\u52a1\u7684\uff0c\u5f53\u7136\u6211\u4eec\u4e5f\u4f1a\u5728\u6587\u7ae0\u4e2d\u7b80\u5355\u5bf9 <code>MySQL</code> \u4e2d\u5bf9 <code>ACID</code> \u7684\u5b9e\u73b0\u8fdb\u884c\u7b80\u5355\u7684\u4ecb\u7ecd\u3002</p> <p></p> <p>\u4e8b\u52a1\u5176\u5b9e\u5c31\u662f\u5e76\u53d1\u63a7\u5236\u7684\u57fa\u672c\u5355\u4f4d\uff1b</p> <p>\u76f8\u4fe1\u6211\u4eec\u90fd\u77e5\u9053\uff0c\u4e8b\u52a1\u662f\u4e00\u4e2a\u5e8f\u5217\u64cd\u4f5c\uff0c\u5176\u4e2d\u7684\u64cd\u4f5c\u8981\u4e48\u90fd\u6267\u884c\uff0c\u8981\u4e48\u90fd\u4e0d\u6267\u884c\uff0c\u5b83\u662f\u4e00\u4e2a\u4e0d\u53ef\u5206\u5272\u7684\u5de5\u4f5c\u5355\u4f4d\uff1b</p> <p>\u6570\u636e\u5e93\u4e8b\u52a1\u7684 <code>ACID</code> \u56db\u5927\u7279\u6027\u662f\u4e8b\u52a1\u7684\u57fa\u7840\uff0c\u4e86\u89e3\u4e86 <code>ACID</code> \u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff0c\u6211\u4eec\u4e5f\u5c31\u6e05\u695a\u4e86\u4e8b\u52a1\u7684\u5b9e\u73b0\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c06\u4f9d\u6b21\u4ecb\u7ecd\u6570\u636e\u5e93\u662f\u5982\u4f55\u5b9e\u73b0\u8fd9\u56db\u4e2a\u7279\u6027\u7684\u3002</p>"},{"location":"chap1/mysql3_transaction/#1","title":"1 \u539f\u5b50\u6027","text":"<p>\u5728\u5b66\u4e60\u4e8b\u52a1\u65f6\uff0c\u7ecf\u5e38\u6709\u4eba\u4f1a\u544a\u8bc9\u4f60\uff0c\u4e8b\u52a1\u5c31\u662f\u4e00\u7cfb\u5217\u7684\u64cd\u4f5c\uff0c\u8981\u4e48\u5168\u90e8\u90fd\u6267\u884c\uff0c\u8981\u90fd\u4e0d\u6267\u884c\uff0c\u8fd9\u5176\u5b9e\u5c31\u662f\u5bf9\u4e8b\u52a1\u539f\u5b50\u6027\u7684\u523b\u753b\uff1b\u867d\u7136\u4e8b\u52a1\u5177\u6709\u539f\u5b50\u6027\uff0c\u4f46\u662f\u539f\u5b50\u6027\u5e76\u4e0d\u662f\u53ea\u4e0e\u4e8b\u52a1\u6709\u5173\u7cfb\uff0c\u5b83\u7684\u8eab\u5f71\u5728\u5f88\u591a\u5730\u65b9\u90fd\u4f1a\u51fa\u73b0\u3002</p> <p></p> <p>\u7531\u4e8e\u64cd\u4f5c\u5e76\u4e0d\u5177\u6709\u539f\u5b50\u6027\uff0c\u5e76\u4e14\u53ef\u4ee5\u518d\u5206\u4e3a\u591a\u4e2a\u64cd\u4f5c\uff0c\u5f53\u8fd9\u4e9b\u64cd\u4f5c\u51fa\u73b0\u9519\u8bef\u6216\u629b\u51fa\u5f02\u5e38\u65f6\uff0c\u6574\u4e2a\u64cd\u4f5c\u5c31\u53ef\u80fd\u4e0d\u4f1a\u7ee7\u7eed\u6267\u884c\u4e0b\u53bb\uff0c\u800c\u5df2\u7ecf\u8fdb\u884c\u7684\u64cd\u4f5c\u9020\u6210\u7684\u526f\u4f5c\u7528\u5c31\u53ef\u80fd\u9020\u6210\u6570\u636e\u66f4\u65b0\u7684\u4e22\u5931\u6216\u8005\u9519\u8bef\u3002</p> <p>\u4e8b\u52a1\u5176\u5b9e\u548c\u4e00\u4e2a\u64cd\u4f5c\u6ca1\u6709\u4ec0\u4e48\u592a\u5927\u7684\u533a\u522b\uff0c\u5b83\u662f\u4e00\u7cfb\u5217\u7684\u6570\u636e\u5e93\u64cd\u4f5c\uff08\u53ef\u4ee5\u7406\u89e3\u4e3a <code>SQL</code>\uff09\u7684\u96c6\u5408\uff0c\u5982\u679c\u4e8b\u52a1\u4e0d\u5177\u5907\u539f\u5b50\u6027\uff0c\u90a3\u4e48\u5c31\u6ca1\u529e\u6cd5\u4fdd\u8bc1\u540c\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u88ab\u6267\u884c\u6216\u8005\u672a\u88ab\u6267\u884c\u4e86\uff0c\u6574\u4e2a\u6570\u636e\u5e93\u7cfb\u7edf\u5c31\u65e2\u4e0d\u53ef\u7528\u4e5f\u4e0d\u53ef\u4fe1\u3002</p>"},{"location":"chap1/mysql3_transaction/#1_1","title":"1 \u56de\u6eda\u65e5\u5fd7","text":"<p>\u60f3\u8981\u4fdd\u8bc1\u4e8b\u52a1\u7684\u539f\u5b50\u6027\uff0c\u5c31\u9700\u8981\u5728\u5f02\u5e38\u53d1\u751f\u65f6\uff0c\u5bf9\u5df2\u7ecf\u6267\u884c\u7684\u64cd\u4f5c\u8fdb\u884c\u56de\u6eda\uff0c\u800c\u5728 <code>MySQL</code> \u4e2d\uff0c\u6062\u590d\u673a\u5236\u662f\u901a\u8fc7\u56de\u6eda\u65e5\u5fd7\uff08<code>undo log</code>\uff09\u5b9e\u73b0\u7684\uff0c\u6240</p> <p>\u6709\u4e8b\u52a1\u8fdb\u884c\u7684\u4fee\u6539\u90fd\u4f1a\u5148\u8bb0\u5f55\u5230\u8fd9\u4e2a\u56de\u6eda\u65e5\u5fd7\u4e2d\uff0c\u7136\u540e\u5728\u5bf9\u6570\u636e\u5e93\u4e2d\u7684\u5bf9\u5e94\u884c\u8fdb\u884c\u5199\u5165\u3002</p> <p></p> <p>\u8fd9\u4e2a\u8fc7\u7a0b\u5176\u5b9e\u975e\u5e38\u597d\u7406\u89e3\uff0c\u4e3a\u4e86\u80fd\u591f\u5728\u53d1\u751f\u9519\u8bef\u65f6\u64a4\u9500\u4e4b\u524d\u7684\u5168\u90e8\u64cd\u4f5c\uff0c\u80af\u5b9a\u662f\u9700\u8981\u5c06\u4e4b\u524d\u7684\u64cd\u4f5c\u90fd\u8bb0\u5f55\u4e0b\u6765\u7684\uff0c\u8fd9\u6837\u5728\u53d1\u751f\u9519\u8bef\u65f6\u624d\u53ef\u4ee5\u56de\u6eda\u3002</p> <ul> <li>\u56de\u6eda\u65e5\u5fd7\u9664\u4e86\u80fd\u591f\u5728\u53d1\u751f\u9519\u8bef\u6216\u8005\u7528\u6237\u6267\u884c <code>ROLLBACK</code> \u65f6\u63d0\u4f9b\u56de\u6eda\u76f8\u5173\u7684\u4fe1\u606f\uff0c</li> <li>\u5b83\u8fd8\u80fd\u591f\u5728\u6574\u4e2a\u7cfb\u7edf\u53d1\u751f\u5d29\u6e83\u3001\u6570\u636e\u5e93\u8fdb\u7a0b\u76f4\u63a5\u88ab\u6740\u6b7b\u540e\uff0c\u5f53\u7528\u6237\u518d\u6b21\u542f\u52a8\u6570\u636e\u5e93\u8fdb\u7a0b\u65f6\uff0c\u8fd8\u80fd\u591f\u7acb\u523b\u901a\u8fc7\u67e5\u8be2\u56de\u6eda\u65e5\u5fd7\u5c06\u4e4b\u524d\u672a\u5b8c\u6210\u7684\u4e8b\u52a1\u8fdb\u884c\u56de\u6eda\uff0c</li> </ul> <p>\u8fd9\u4e5f\u5c31\u9700\u8981\u56de\u6eda\u65e5\u5fd7\u5fc5\u987b\u5148\u4e8e\u6570\u636e\u6301\u4e45\u5316\u5230\u78c1\u76d8\u4e0a\uff0c\u662f\u6211\u4eec\u9700\u8981\u5148\u5199\u65e5\u5fd7\u540e\u5199\u6570\u636e\u5e93\u7684\u4e3b\u8981\u539f\u56e0\u3002</p> <ul> <li>\u56de\u6eda\u65e5\u5fd7\u5e76\u4e0d\u80fd\u5c06\u6570\u636e\u5e93\u7269\u7406\u5730\u6062\u590d\u5230\u6267\u884c\u8bed\u53e5\u6216\u8005\u4e8b\u52a1\u4e4b\u524d\u7684\u6837\u5b50\uff1b\u5b83\u662f\u903b\u8f91\u65e5\u5fd7\uff0c\u5f53\u56de\u6eda\u65e5\u5fd7\u88ab\u4f7f\u7528\u65f6\uff0c\u5b83\u53ea\u4f1a\u6309\u7167\u65e5\u5fd7\u903b\u8f91\u5730\u5c06\u6570\u636e\u5e93\u4e2d\u7684\u4fee\u6539\u64a4\u9500\u6389\u770b\uff0c</li> <li>\u53ef\u4ee5\u7406\u89e3\u4e3a\uff0c\u6211\u4eec\u5728\u4e8b\u52a1\u4e2d\u4f7f\u7528\u7684\u6bcf\u4e00\u6761 <code>INSERT</code> \u90fd\u5bf9\u5e94\u4e86\u4e00\u6761 <code>DELETE</code>\uff0c\u6bcf\u4e00\u6761 <code>UPDATE</code> \u4e5f\u90fd\u5bf9\u5e94\u4e00\u6761\u76f8\u53cd\u7684 <code>UPDATE</code> \u8bed\u53e5\u3002</li> </ul> <p></p>"},{"location":"chap1/mysql3_transaction/#2","title":"2 \u4e8b\u52a1\u7684\u72b6\u6001","text":"<p>\u56e0\u4e3a\u4e8b\u52a1\u5177\u6709\u539f\u5b50\u6027\uff0c\u6240\u4ee5\u4ece\u8fdc\u5904\u770b\u7684\u8bdd\uff0c\u4e8b\u52a1\u5c31\u662f\u5bc6\u4e0d\u53ef\u5206\u7684\u4e00\u4e2a\u6574\u4f53\uff0c\u4e8b\u52a1\u7684\u72b6\u6001\u4e5f\u53ea\u6709\u4e09\u79cd\uff1a<code>Active</code>\u3001<code>Commited</code> \u548c <code>Failed</code>\uff0c\u4e8b\u52a1\u8981\u4e0d\u5c31\u5728\u6267\u884c\u4e2d\uff0c\u8981\u4e0d\u7136\u5c31\u662f\u6210\u529f\u6216\u8005\u5931\u8d25\u7684\u72b6\u6001\uff1a</p> <p></p> <p>\u4f46\u662f\u5982\u679c\u653e\u5927\u6765\u770b\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u4e8b\u52a1\u4e0d\u518d\u662f\u539f\u5b50\u7684\uff0c\u5176\u4e2d\u5305\u62ec\u4e86\u5f88\u591a\u4e2d\u95f4\u72b6\u6001\uff0c\u6bd4\u5982\u90e8\u5206\u63d0\u4ea4\uff0c\u4e8b\u52a1\u7684\u72b6\u6001\u56fe\u4e5f\u53d8\u5f97\u8d8a\u6765\u8d8a\u590d\u6742\u3002</p> <p></p> <ul> <li><code>Active</code>\uff1a\u4e8b\u52a1\u7684\u521d\u59cb\u72b6\u6001\uff0c\u8868\u793a\u4e8b\u52a1\u6b63\u5728\u6267\u884c\uff1b</li> <li><code>Partially Commited</code>\uff1a\u5728\u6700\u540e\u4e00\u6761\u8bed\u53e5\u6267\u884c\u4e4b\u540e\uff1b</li> <li><code>Failed</code>\uff1a\u53d1\u73b0\u4e8b\u52a1\u65e0\u6cd5\u6b63\u5e38\u6267\u884c\u4e4b\u540e\uff1b</li> <li><code>Aborted</code>\uff1a\u4e8b\u52a1\u88ab\u56de\u6eda\u5e76\u4e14\u6570\u636e\u5e93\u6062\u590d\u5230\u4e86\u4e8b\u52a1\u8fdb\u884c\u4e4b\u524d\u7684\u72b6\u6001\u4e4b\u540e\uff1b</li> <li><code>Commited</code>\uff1a\u6210\u529f\u6267\u884c\u6574\u4e2a\u4e8b\u52a1\uff1b</li> </ul> <p>\u867d\u7136\u5728\u53d1\u751f\u9519\u8bef\u65f6\uff0c\u6574\u4e2a\u6570\u636e\u5e93\u7684\u72b6\u6001\u53ef\u4ee5\u6062\u590d\uff0c\u4f46\u662f\u5982\u679c\u6211\u4eec\u5728\u4e8b\u52a1\u4e2d\u6267\u884c\u4e86\u8bf8\u5982\uff1a</p> <ul> <li>\u5411\u6807\u51c6\u8f93\u51fa\u6253\u5370\u65e5\u5fd7\u3001</li> <li>\u5411\u5916\u754c\u53d1\u51fa\u90ae\u4ef6\u3001</li> <li>\u6ca1\u6709\u901a\u8fc7\u6570\u636e\u5e93\u4fee\u6539\u4e86\u78c1\u76d8\u4e0a\u7684\u5185\u5bb9\u751a\u81f3\u5728\u4e8b\u52a1\u6267\u884c\u671f\u95f4\u53d1\u751f\u4e86\u8f6c\u8d26\u6c47\u6b3e\uff0c</li> </ul> <p>\u90a3\u4e48\u8fd9\u4e9b\u64cd\u4f5c\u4f5c\u4e3a\u53ef\u89c1\u7684\u5916\u90e8\u8f93\u51fa\u90fd\u662f\u6ca1\u6709\u529e\u6cd5\u56de\u6eda\u7684\uff1b\u8fd9\u4e9b\u95ee\u9898\u90fd\u662f\u7531\u5e94\u7528\u5f00\u53d1\u8005\u89e3\u51b3\u548c\u8d1f\u8d23\u7684\uff0c\u5728\u7edd\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u90fd\u9700\u8981\u5728\u6574\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u540e\uff0c\u518d\u89e6\u53d1\u7c7b\u4f3c\u7684\u65e0\u6cd5\u56de\u6eda\u7684\u64cd\u4f5c\u3002</p> <p></p> <p>\u4ee5\u8ba2\u7968\u4e3a\u4f8b\uff0c\u54ea\u6015\u6211\u4eec\u5728\u6574\u4e2a\u4e8b\u52a1\u7ed3\u675f\u4e4b\u540e\uff0c\u624d\u5411\u7b2c\u4e09\u65b9\u53d1\u8d77\u8bf7\u6c42\uff0c\u7531\u4e8e\u5411\u7b2c\u4e09\u65b9\u8bf7\u6c42\u5e76\u83b7\u53d6\u7ed3\u679c\u662f\u4e00\u4e2a\u9700\u8981\u8f83\u957f\u65f6\u95f4\u7684\u64cd\u4f5c\uff0c\u5982\u679c\u5728\u4e8b\u52a1\u521a\u521a\u63d0\u4ea4\u65f6\uff0c\u6570\u636e\u5e93\u6216\u8005\u670d\u52a1\u5668\u53d1\u751f\u4e86\u5d29\u6e83\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u975e\u5e38\u6709\u53ef\u80fd\u4e22\u5931\u53d1\u8d77\u8bf7\u6c42\u8fd9\u4e00\u8fc7\u7a0b\uff0c\u8fd9\u5c31\u9020\u6210\u4e86\u975e\u5e38\u4e25\u91cd\u7684\u95ee\u9898\uff1b\u800c\u8fd9\u4e00\u70b9\u5c31\u4e0d\u662f\u6570\u636e\u5e93\u6240\u80fd\u4fdd\u8bc1\u7684\uff0c\u5f00\u53d1\u8005\u9700\u8981\u5728\u9002\u5f53\u7684\u65f6\u5019\u67e5\u770b\u8bf7\u6c42\u662f\u5426\u88ab\u53d1\u8d77\u3001\u7ed3\u679c\u662f\u6210\u529f\u8fd8\u662f\u5931\u8d25\u3002</p>"},{"location":"chap1/mysql3_transaction/#3","title":"3 \u5e76\u884c\u4e8b\u52a1\u7684\u539f\u5b50\u6027","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6240\u6709\u7684\u4e8b\u52a1\u90fd\u53ea\u662f\u4e32\u884c\u6267\u884c\u7684\uff0c\u4e00\u76f4\u90fd\u6ca1\u6709\u8003\u8651\u8fc7\u5e76\u884c\u6267\u884c\u7684\u95ee\u9898\uff1b\u7136\u800c\u5728\u5b9e\u9645\u5de5\u4f5c\u4e2d\uff0c\u5e76\u884c\u6267\u884c\u7684\u4e8b\u52a1\u624d\u662f\u5e38\u6001\uff0c\u7136\u800c\u5e76\u884c\u4efb\u52a1\u4e0b\uff0c\u5374\u53ef\u80fd\u51fa\u73b0\u975e\u5e38\u590d\u6742\u7684\u95ee\u9898\uff1a</p> <p></p> <ul> <li>\u5f53<code>Transaction1</code> \u5728\u6267\u884c\u7684\u8fc7\u7a0b\u4e2d\u5bf9 <code>id = 1</code> \u7684\u7528\u6237\u8fdb\u884c\u4e86\u8bfb\u5199\uff0c\u4f46\u662f\u6ca1\u6709\u5c06\u4fee\u6539\u7684\u5185\u5bb9\u8fdb\u884c\u63d0\u4ea4\u6216\u8005\u56de\u6eda\uff0c\u5728\u8fd9\u65f6 <code>Transaction2</code>\u5bf9\u540c\u6837\u7684\u6570\u636e\u8fdb\u884c\u4e86\u8bfb\u64cd\u4f5c\u5e76\u63d0\u4ea4\u4e86\u4e8b\u52a1\uff1b</li> <li>\u4e5f\u5c31\u662f\u8bf4 <code>Transaction2</code> \u662f\u4f9d\u8d56\u4e8e <code>Transaction1</code> \u7684\uff0c\u5f53 <code>Transaction1</code> \u7531\u4e8e\u4e00\u4e9b\u9519\u8bef\u9700\u8981\u56de\u6eda\u65f6\uff0c\u56e0\u4e3a\u8981\u4fdd\u8bc1\u4e8b\u52a1\u7684\u539f\u5b50\u6027\uff0c\u9700\u8981\u5bf9 <code>Transaction2</code> \u8fdb\u884c\u56de\u6eda\uff0c\u4f46\u662f\u7531\u4e8e\u6211\u4eec\u5df2\u7ecf\u63d0\u4ea4\u4e86 <code>Transaction2</code>\uff0c\u6240\u4ee5\u6211\u4eec\u5df2\u7ecf\u6ca1\u6709\u529e\u6cd5\u8fdb\u884c\u56de\u6eda\u64cd\u4f5c\uff0c\u5728\u8fd9\u79cd\u95ee\u9898\u4e0b\u6211\u4eec\u5c31\u53d1\u751f\u4e86\u95ee\u9898\uff0c<code>Database System Concepts</code> \u4e00\u4e66\u4e2d\u5c06\u8fd9\u79cd\u73b0\u8c61\u79f0\u4e3a\u4e0d\u53ef\u6062\u590d\u5b89\u6392\uff08<code>Nonrecoverable Schedule</code>\uff09\uff0c\u90a3\u4ec0\u4e48\u60c5\u51b5\u4e0b\u662f\u53ef\u4ee5\u6062\u590d\u7684\u5462\uff1f</li> </ul> <p>A recoverable schedule is one where, for each pair of transactions Ti and Tj such that Tj reads a data item previously written by Ti , the commit operation of Ti appears before the commit operation of Tj .</p> <p>\u7b80\u5355\u7406\u89e3\u4e00\u4e0b\uff0c\u5982\u679c <code>Transaction2</code> \u4f9d\u8d56\u4e8e\u4e8b\u52a1 <code>Transaction1</code>\uff0c\u90a3\u4e48\u4e8b\u52a1 <code>Transaction1</code> \u5fc5\u987b\u5728 <code>Transaction2</code> \u63d0\u4ea4\u4e4b\u524d\u5b8c\u6210\u63d0\u4ea4\u7684\u64cd\u4f5c\uff1a</p> <p></p> <p>\u7136\u800c\u8fd9\u6837\u8fd8\u4e0d\u7b97\u5b8c\uff0c\u5f53\u4e8b\u52a1\u7684\u6570\u91cf\u9010\u6e10\u589e\u591a\u65f6\uff0c\u6574\u4e2a\u6062\u590d\u6d41\u7a0b\u4e5f\u4f1a\u53d8\u5f97\u8d8a\u6765\u8d8a\u590d\u6742\uff0c\u5982\u679c\u6211\u4eec\u60f3\u8981\u4ece\u4e8b\u52a1\u53d1\u751f\u7684\u9519\u8bef\u4e2d\u6062\u590d\uff0c\u4e5f\u4e0d\u662f\u4e00\u4ef6\u90a3\u4e48\u5bb9\u6613\u7684\u4e8b\u60c5\u3002</p> <p></p> <p>\u5728\u4e0a\u56fe\u6240\u793a\u7684\u4e00\u6b21\u4e8b\u4ef6\u4e2d\uff0c<code>Transaction2</code> \u4f9d\u8d56\u4e8e <code>Transaction1</code>\uff0c\u800c <code>Transaction3</code> \u53c8\u4f9d\u8d56\u4e8e <code>Transaction1</code>\uff0c\u5f53 <code>Transaction1</code> \u7531\u4e8e\u6267\u884c\u51fa\u73b0\u95ee\u9898\u53d1\u751f\u56de\u6eda\u65f6\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u4e8b\u52a1\u7684\u539f\u5b50\u6027\uff0c\u5c31\u4f1a\u5c06 <code>Transaction2</code> \u548c <code>Transaction3</code> \u4e2d\u7684\u5de5\u4f5c\u5168\u90e8\u56de\u6eda\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e5f\u53eb\u505a\u7ea7\u8054\u56de\u6eda\uff08<code>Cascading Rollback</code>\uff09\uff0c\u7ea7\u8054\u56de\u6eda\u7684\u53d1\u751f\u4f1a\u5bfc\u81f4\u5927\u91cf\u7684\u5de5\u4f5c\u9700\u8981\u64a4\u56de\uff0c\u662f\u6211\u4eec\u96be\u4ee5\u63a5\u53d7\u7684\uff0c\u4e0d\u8fc7\u5982\u679c\u60f3\u8981\u8fbe\u5230\u7edd\u5bf9\u7684\u539f\u5b50\u6027\uff0c\u8fd9\u4ef6\u4e8b\u60c5\u53c8\u662f\u4e0d\u5f97\u4e0d\u53bb\u5904\u7406\u7684\uff0c\u6211\u4eec\u4f1a\u5728\u6587\u7ae0\u7684\u540e\u9762\u5177\u4f53\u4ecb\u7ecd\u5982\u4f55\u5904\u7406\u5e76\u884c\u4e8b\u52a1\u7684\u539f\u5b50\u6027\u3002</p>"},{"location":"chap1/mysql3_transaction/#2_1","title":"2 \u6301\u4e45\u6027","text":"<p>\u65e2\u7136\u662f\u6570\u636e\u5e93\uff0c\u90a3\u4e48\u4e00\u5b9a\u5bf9\u6570\u636e\u7684\u6301\u4e45\u5b58\u50a8\u6709\u7740\u975e\u5e38\u5f3a\u70c8\u7684\u9700\u6c42\uff0c\u5982\u679c\u6570\u636e\u88ab\u5199\u5165\u5230\u6570\u636e\u5e93\u4e2d\uff0c\u90a3\u4e48\u6570\u636e\u4e00\u5b9a\u80fd\u591f\u88ab\u5b89\u5168\u5b58\u50a8\u5728\u78c1\u76d8\u4e0a\uff1b\u800c\u4e8b\u52a1\u7684\u6301\u4e45\u6027\u5c31\u4f53\u73b0\u5728\uff0c\u4e00\u65e6\u4e8b\u52a1\u88ab\u63d0\u4ea4\uff0c\u90a3\u4e48\u6570\u636e\u4e00\u5b9a\u4f1a\u88ab\u5199\u5165\u5230\u6570\u636e\u5e93\u4e2d\u5e76\u6301\u4e45\u5b58\u50a8\u8d77\u6765\u3002</p> <p></p> <p>\u5f53\u4e8b\u52a1\u5df2\u7ecf\u88ab\u63d0\u4ea4\u4e4b\u540e\uff0c\u5c31\u65e0\u6cd5\u518d\u6b21\u56de\u6eda\u4e86\uff0c\u552f\u4e00\u80fd\u591f\u64a4\u56de\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1\u7684\u65b9\u5f0f\u5c31\u662f\u521b\u5efa\u4e00\u4e2a\u76f8\u53cd\u7684\u4e8b\u52a1\u5bf9\u539f\u64cd\u4f5c\u8fdb\u884c\u300e<code>\u8865\u507f</code>\u300f\uff0c\u8fd9\u4e5f\u662f\u4e8b\u52a1\u6301\u4e45\u6027\u7684\u4f53\u73b0\u4e4b\u4e00\u3002</p>"},{"location":"chap1/mysql3_transaction/#1_2","title":"1 \u91cd\u505a\u65e5\u5fd7","text":"<p>\u4e0e\u539f\u5b50\u6027\u4e00\u6837\uff0c\u4e8b\u52a1\u7684\u6301\u4e45\u6027\u4e5f\u662f\u901a\u8fc7\u65e5\u5fd7\u6765\u5b9e\u73b0\u7684\uff0c<code>MySQL</code> \u4f7f\u7528\u91cd\u505a\u65e5\u5fd7\uff08<code>redo log</code>\uff09\u5b9e\u73b0\u4e8b\u52a1\u7684\u6301\u4e45\u6027\uff0c\u91cd\u505a\u65e5\u5fd7\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff0c</p> <ul> <li>\u4e00\u662f\u5185\u5b58\u4e2d\u7684\u91cd\u505a\u65e5\u5fd7\u7f13\u51b2\u533a\uff0c\u56e0\u4e3a\u91cd\u505a\u65e5\u5fd7\u7f13\u51b2\u533a\u5728\u5185\u5b58\u4e2d\uff0c\u6240\u4ee5\u5b83\u662f\u6613\u5931\u7684\uff0c</li> <li>\u53e6\u4e00\u4e2a\u5c31\u662f\u5728\u78c1\u76d8\u4e0a\u7684\u91cd\u505a\u65e5\u5fd7\u6587\u4ef6\uff0c\u5b83\u662f\u6301\u4e45\u7684\u3002</li> </ul> <p></p> <ul> <li>\u5f53\u6211\u4eec\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u5c1d\u8bd5\u5bf9\u6570\u636e\u8fdb\u884c\u4fee\u6539\u65f6(1)\uff0c</li> <li>\u5b83\u4f1a\u5148\u5c06\u6570\u636e\u4ece\u78c1\u76d8\u8bfb\u5165\u5185\u5b58, \u5e76\u66f4\u65b0\u5185\u5b58\u4e2d\u7f13\u5b58\u7684\u6570\u636e(2)</li> <li>\u7136\u540e\u751f\u6210\u4e00\u6761\u91cd\u505a\u65e5\u5fd7\u5e76\u5199\u5165\u91cd\u505a\u65e5\u5fd7\u7f13\u5b58(3)</li> <li>\u5f53\u4e8b\u52a1\u771f\u6b63\u63d0\u4ea4\u65f6\uff0cMySQL \u4f1a\u5c06\u91cd\u505a\u65e5\u5fd7\u7f13\u5b58\u4e2d\u7684\u5185\u5bb9\u5237\u65b0\u5230\u91cd\u505a\u65e5\u5fd7\u6587\u4ef6(4)</li> <li>\u518d\u5c06\u5185\u5b58\u4e2d\u7684\u6570\u636e\u66f4\u65b0\u5230\u78c1\u76d8\u4e0a(5)</li> </ul> <p>\u5728 InnoDB \u4e2d\uff0c\u91cd\u505a\u65e5\u5fd7\u90fd\u662f\u4ee5 512 \u5b57\u8282\u7684\u5757\u7684\u5f62\u5f0f\u8fdb\u884c\u5b58\u50a8\u7684\uff0c\u540c\u65f6\u56e0\u4e3a\u5757\u7684\u5927\u5c0f\u4e0e\u78c1\u76d8\u6247\u533a\u5927\u5c0f\u76f8\u540c\uff0c\u6240\u4ee5\u91cd\u505a\u65e5\u5fd7\u7684\u5199\u5165\u53ef\u4ee5\u4fdd\u8bc1\u539f\u5b50\u6027\uff0c\u4e0d\u4f1a\u7531\u4e8e\u673a\u5668\u65ad\u7535\u5bfc\u81f4\u91cd\u505a\u65e5\u5fd7\u4ec5\u5199\u5165\u4e00\u534a\u5e76\u7559\u4e0b\u810f\u6570\u636e\u3002</p> <p>\u9664\u4e86\u6240\u6709\u5bf9\u6570\u636e\u5e93\u7684\u4fee\u6539\u4f1a\u4ea7\u751f\u91cd\u505a\u65e5\u5fd7\uff0c\u56e0\u4e3a\u56de\u6eda\u65e5\u5fd7\u4e5f\u662f\u9700\u8981\u6301\u4e45\u5b58\u50a8\u7684\uff0c\u5b83\u4eec\u4e5f\u4f1a\u521b\u5efa\u5bf9\u5e94\u7684\u91cd\u505a\u65e5\u5fd7\uff0c\u5728\u53d1\u751f\u9519\u8bef\u540e\uff0c\u6570\u636e\u5e93\u91cd\u542f\u65f6\u4f1a\u4ece\u91cd\u505a\u65e5\u5fd7\u4e2d\u627e\u51fa\u672a\u88ab\u66f4\u65b0\u5230\u6570\u636e\u5e93\u78c1\u76d8\u4e2d\u7684\u65e5\u5fd7\u91cd\u65b0\u6267\u884c\u4ee5\u6ee1\u8db3\u4e8b\u52a1\u7684\u6301\u4e45\u6027\u3002</p>"},{"location":"chap1/mysql3_transaction/#3_1","title":"3 \u56de\u6eda\u65e5\u5fd7\u548c\u91cd\u505a\u65e5\u5fd7","text":"<p>\u5230\u73b0\u5728\u4e3a\u6b62\u6211\u4eec\u4e86\u89e3\u4e86 MySQL \u4e2d\u7684\u4e24\u79cd\u65e5\u5fd7\uff0c\u56de\u6eda\u65e5\u5fd7\uff08<code>undo log</code>\uff09 \u548c \u91cd\u505a\u65e5\u5fd7\uff08<code>redo log</code>\uff09\uff1b</p> <p>\u5728\u6570\u636e\u5e93\u7cfb\u7edf\u4e2d\uff0c\u4e8b\u52a1\u7684\u539f\u5b50\u6027\u548c\u6301\u4e45\u6027\u662f\u7531\u4e8b\u52a1\u65e5\u5fd7\uff08<code>transaction log</code>\uff09\u4fdd\u8bc1\u7684\uff0c\u5728\u5b9e\u73b0\u65f6\u4e5f\u5c31\u662f\u4e0a\u9762\u63d0\u5230\u7684\u4e24\u79cd\u65e5\u5fd7\uff0c</p> <ul> <li>\u524d\u8005\u7528\u4e8e\u5bf9\u4e8b\u52a1\u7684\u5f71\u54cd\u8fdb\u884c\u64a4\u9500\uff0c</li> <li>\u540e\u8005\u5728\u9519\u8bef\u5904\u7406\u65f6\u5bf9\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1\u8fdb\u884c\u91cd\u505a\uff0c</li> </ul> <p>\u5b83\u4eec\u80fd\u4fdd\u8bc1\u4e24\u70b9\uff1a</p> <ol> <li>\u53d1\u751f\u9519\u8bef\u6216\u8005\u9700\u8981\u56de\u6eda\u7684\u4e8b\u52a1\u80fd\u591f\u6210\u529f\u56de\u6eda\uff08\u539f\u5b50\u6027\uff09\uff1b</li> <li>\u5728\u4e8b\u52a1\u63d0\u4ea4\u540e\uff0c\u6570\u636e\u6ca1\u6765\u5f97\u53ca\u5199\u4f1a\u78c1\u76d8\u5c31\u5b95\u673a\u65f6\uff0c\u5728\u4e0b\u6b21\u91cd\u65b0\u542f\u52a8\u540e\u80fd\u591f\u6210\u529f\u6062\u590d\u6570\u636e\uff08\u6301\u4e45\u6027\uff09\uff1b</li> </ol> <p></p> <p>\u5728\u6570\u636e\u5e93\u4e2d\uff0c\u8fd9\u4e24\u79cd\u65e5\u5fd7\u7ecf\u5e38\u90fd\u662f\u4e00\u8d77\u5de5\u4f5c\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5b83\u4eec\u6574\u4f53\u770b\u505a\u4e00\u6761\u4e8b\u52a1\u65e5\u5fd7\uff0c\u5176\u4e2d\u5305\u542b\u4e86\u4e8b\u52a1\u7684 ID\u3001\u4fee\u6539\u7684\u884c\u5143\u7d20\u4ee5\u53ca\u4fee\u6539\u524d\u540e\u7684\u503c\u3002</p> <p>\u4e00\u6761\u4e8b\u52a1\u65e5\u5fd7\u540c\u65f6\u5305\u542b\u4e86\u4fee\u6539\u524d\u540e\u7684\u503c\uff0c\u80fd\u591f\u975e\u5e38\u7b80\u5355\u7684\u8fdb\u884c\u56de\u6eda\u548c\u91cd\u505a\u4e24\u79cd\u64cd\u4f5c\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u4e5f\u4e0d\u4f1a\u5bf9\u91cd\u505a\u548c\u56de\u6eda\u65e5\u5fd7\u5c55\u5f00\u8fdb\u884c\u4ecb\u7ecd\uff0c\u53ef\u80fd\u4f1a\u5728\u4e4b\u540e\u7684\u6587\u7ae0\u8c08\u4e00\u8c08\u6570\u636e\u5e93\u7cfb\u7edf\u7684\u6062\u590d\u673a\u5236\u65f6\u63d0\u5230\u4e24\u79cd\u65e5\u5fd7\u7684\u4f7f\u7528\u3002</p>"},{"location":"chap1/mysql3_transaction/#_1","title":"\u7b2c\u516b\u8282 \"Shallow Dive\" MySQL \u4e2d\u4e8b\u52a1\u7684\u5b9e\u73b0(`transaction`)","text":"<p>\u4e8b\u52a1\u7684\u9694\u79bb\u6027\u662f\u6570\u636e\u5e93\u5904\u7406\u6570\u636e\u7684\u51e0\u5927\u57fa\u7840\u4e4b\u4e00\uff0c\u5982\u679c\u6ca1\u6709\u6570\u636e\u5e93\u7684\u4e8b\u52a1\u4e4b\u95f4\u6ca1\u6709\u9694\u79bb\u6027\uff0c\u5c31\u4f1a\u53d1\u751f\u5728 \u5e76\u884c\u4e8b\u52a1\u7684\u539f\u5b50\u6027 \u4e00\u8282\u4e2d\u63d0\u5230\u7684\u7ea7\u8054\u56de\u6eda\u7b49\u95ee\u9898\uff0c\u9020\u6210\u6027\u80fd\u4e0a\u7684\u5de8\u5927\u635f\u5931\u3002\u5982\u679c\u6240\u6709\u7684\u4e8b\u52a1\u7684\u6267\u884c\u987a\u5e8f\u90fd\u662f\u7ebf\u6027\u7684\uff0c\u90a3\u4e48\u5bf9\u4e8e\u4e8b\u52a1\u7684\u7ba1\u7406\u5bb9\u6613\u5f97\u591a\uff0c\u4f46\u662f\u5141\u8bb8\u4e8b\u52a1\u7684\u5e76\u884c\u6267\u884c\u5374\u80fd\u80fd\u591f\u63d0\u5347\u541e\u5410\u91cf\u548c\u8d44\u6e90\u5229\u7528\u7387\uff0c\u5e76\u4e14\u53ef\u4ee5\u51cf\u5c11\u6bcf\u4e2a\u4e8b\u52a1\u7684\u7b49\u5f85\u65f6\u95f4\u3002</p> <p></p> <p>\u5f53\u591a\u4e2a\u4e8b\u52a1\u540c\u65f6\u5e76\u53d1\u6267\u884c\u65f6\uff0c\u4e8b\u52a1\u7684\u9694\u79bb\u6027\u53ef\u80fd\u5c31\u4f1a\u88ab\u8fdd\u53cd\uff0c\u867d\u7136\u5355\u4e2a\u4e8b\u52a1\u7684\u6267\u884c\u53ef\u80fd\u6ca1\u6709\u4efb\u4f55\u9519\u8bef\uff0c\u4f46\u662f\u4ece\u603b\u4f53\u6765\u770b\u5c31\u4f1a\u9020\u6210\u6570\u636e\u5e93\u7684\u4e00\u81f4\u6027\u51fa\u73b0\u95ee\u9898\uff0c\u800c\u4e32\u884c\u867d\u7136\u80fd\u591f\u5141\u8bb8\u5f00\u53d1\u8005\u5ffd\u7565\u5e76\u884c\u9020\u6210\u7684\u5f71\u54cd\uff0c\u80fd\u591f\u5f88\u597d\u5730\u7ef4\u62a4\u6570\u636e\u5e93\u7684\u4e00\u81f4\u6027\uff0c\u4f46\u662f\u5374\u4f1a\u5f71\u54cd\u4e8b\u52a1\u6267\u884c\u7684\u6027\u80fd\u3002</p>"},{"location":"chap1/mysql3_transaction/#1_3","title":"1 \u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b","text":"<p>\u6240\u4ee5\u8bf4\u6570\u636e\u5e93\u7684\u9694\u79bb\u6027\u548c\u4e00\u81f4\u6027\u5176\u5b9e\u662f\u4e00\u4e2a\u9700\u8981\u5f00\u53d1\u8005\u53bb\u6743\u8861\u7684\u95ee\u9898\uff0c\u4e3a\u6570\u636e\u5e93\u63d0\u4f9b\u4ec0\u4e48\u6837\u7684\u9694\u79bb\u6027\u5c42\u7ea7\u4e5f\u5c31\u51b3\u5b9a\u4e86\u6570\u636e\u5e93\u7684\u6027\u80fd\u4ee5\u53ca\u53ef\u4ee5\u8fbe\u5230\u4ec0\u4e48\u6837\u7684\u4e00\u81f4\u6027\uff1b</p> <p>\u5728 SQL \u6807\u51c6\u4e2d\u5b9a\u4e49\u4e86\u56db\u79cd\u6570\u636e\u5e93\u7684\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\uff1a<code>READ UNCOMMITED</code>\u3001<code>READ COMMITED</code>\u3001<code>REPEATABLE READ</code> \u548c <code>SERIALIZABLE</code>\uff1b</p> <p>\u6bcf\u4e2a\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\u5176\u5b9e\u90fd\u6bd4\u4e0a\u4e00\u7ea7\u591a\u89e3\u51b3\u4e86\u4e00\u4e2a\u95ee\u9898\uff1a</p> <ul> <li><code>RAED UNCOMMITED</code>\uff1a\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5\u4e0d\u4f1a\u52a0\u9501\uff0c\u53ef\u80fd\u4f1a\u8bfb\u5230\u672a\u63d0\u4ea4\u7684\u884c\uff08<code>Dirty Read</code>\uff09\uff1b</li> <li><code>READ COMMITED</code>\uff1a\u53ea\u5bf9\u8bb0\u5f55\u52a0\u8bb0\u5f55\u9501\uff0c\u800c\u4e0d\u4f1a\u5728\u8bb0\u5f55\u4e4b\u95f4\u52a0\u95f4\u9699\u9501\uff0c\u6240\u4ee5\u5141\u8bb8\u65b0\u7684\u8bb0\u5f55\u63d2\u5165\u5230\u88ab\u9501\u5b9a\u8bb0\u5f55\u7684\u9644\u8fd1\uff0c\u6240\u4ee5\u518d\u591a\u6b21\u4f7f\u7528\u67e5\u8be2\u8bed\u53e5\u65f6\uff0c\u53ef\u80fd\u5f97\u5230\u4e0d\u540c\u7684\u7ed3\u679c\uff08<code>Non-Repeatable Read</code>\uff09\uff1b</li> <li><code>REPEATABLE READ</code>\uff1a\u591a\u6b21\u8bfb\u53d6\u540c\u4e00\u8303\u56f4\u7684\u6570\u636e\u4f1a\u8fd4\u56de\u7b2c\u4e00\u6b21\u67e5\u8be2\u7684\u5feb\u7167\uff0c\u4e0d\u4f1a\u8fd4\u56de\u4e0d\u540c\u7684\u6570\u636e\u884c\uff0c\u4f46\u662f\u53ef\u80fd\u53d1\u751f\u5e7b\u8bfb\uff08<code>Phantom Read</code>)</li> <li><code>SERIALIZABLE</code>\uff1aInnoDB \u9690\u5f0f\u5730\u5c06\u5168\u90e8\u7684\u67e5\u8be2\u8bed\u53e5\u52a0\u4e0a\u5171\u4eab\u9501\uff0c\u89e3\u51b3\u4e86\u5e7b\u8bfb\u7684\u95ee\u9898\uff1b</li> </ul> <p>MySQL \u4e2d\u9ed8\u8ba4\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u5c31\u662f <code>REPEATABLE READ</code>\uff0c\u4f46\u662f\u5b83\u901a\u8fc7 <code>Next-Key</code> \u9501\u4e5f\u80fd\u591f\u5728\u67d0\u79cd\u7a0b\u5ea6\u4e0a\u89e3\u51b3\u5e7b\u8bfb\u7684\u95ee\u9898\u3002</p> <p>\u4ee5\u4e0a\u7684\u6240\u6709\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u90fd\u4e0d\u5141\u8bb8\u810f\u5199\u5165\uff08<code>Dirty Write</code>\uff09\uff0c\u4e5f\u5c31\u662f\u5f53\u524d\u4e8b\u52a1\u66f4\u65b0\u4e86\u53e6\u4e00\u4e2a\u4e8b\u52a1\u5df2\u7ecf\u66f4\u65b0\u4f46\u662f\u8fd8\u672a\u63d0\u4ea4\u7684\u6570\u636e\uff0c\u5927\u90e8\u5206\u7684\u6570\u636e\u5e93\u4e2d\u90fd\u4f7f\u7528\u4e86 <code>READ COMMITED</code> \u4f5c\u4e3a\u9ed8\u8ba4\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\uff0c\u4f46\u662f <code>MySQL</code> \u4f7f\u7528\u4e86 <code>REPEATABLE READ</code> \u4f5c\u4e3a\u9ed8\u8ba4\u914d\u7f6e\uff1b</p> <p>\u4ece <code>RAED UNCOMMITED</code> \u5230 <code>SERIALIZABLE</code>\uff0c\u968f\u7740\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u53d8\u5f97\u8d8a\u6765\u8d8a\u4e25\u683c\uff0c\u6570\u636e\u5e93\u5bf9\u4e8e\u5e76\u53d1\u6267\u884c\u4e8b\u52a1\u7684\u6027\u80fd\u4e5f\u9010\u6e10\u4e0b\u964d\u3002</p> <p></p> <p>\u5bf9\u4e8e\u6570\u636e\u5e93\u7684\u4f7f\u7528\u8005\uff0c\u4ece\u7406\u8bba\u4e0a\u8bf4\uff0c\u5e76\u4e0d\u9700\u8981\u77e5\u9053\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b\u662f\u5982\u4f55\u5b9e\u73b0\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u77e5\u9053\u8fd9\u4e2a\u9694\u79bb\u7ea7\u522b\u89e3\u51b3\u4e86\u4ec0\u4e48\u6837\u7684\u95ee\u9898\uff0c\u4f46\u662f\u4e0d\u540c\u6570\u636e\u5e93\u5bf9\u4e8e\u4e0d\u540c\u9694\u79bb\u7ea7\u522b\u7684\u662f\u5b9e\u73b0\u7ec6\u8282\u5728\u5f88\u591a\u65f6\u5019\u90fd\u4f1a\u8ba9\u6211\u4eec\u9047\u5230\u610f\u6599\u4e4b\u5916\u7684\u5751\u3002</p> <p></p>"},{"location":"chap1/mysql3_transaction/#4","title":"4 \u9694\u79bb\u7ea7\u522b\u7684\u5b9e\u73b0","text":"<p>\u6570\u636e\u5e93\u5bf9\u4e8e\u9694\u79bb\u7ea7\u522b\u7684\u5b9e\u73b0\u5c31\u662f\u4f7f\u7528\u5e76\u53d1\u63a7\u5236\u673a\u5236\u5bf9\u5728\u540c\u4e00\u65f6\u95f4\u6267\u884c\u7684\u4e8b\u52a1\u8fdb\u884c\u63a7\u5236\uff0c\u9650\u5236\u4e0d\u540c\u7684\u4e8b\u52a1\u5bf9\u4e8e\u540c\u4e00\u8d44\u6e90\u7684\u8bbf\u95ee\u548c\u66f4\u65b0\uff0c\u800c\u6700\u91cd\u8981\u4e5f\u6700\u5e38\u89c1\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u5c06\u7b80\u5355\u4ecb\u7ecd\u4e09\u79cd\u6700\u91cd\u8981\u7684\u5e76\u53d1\u63a7\u5236\u5668\u673a\u5236\u7684\u5de5\u4f5c\u539f\u7406\u3002</p>"},{"location":"chap1/mysql3_transaction/#1_4","title":"1 \u9501","text":"<p>\u9501\u662f\u4e00\u79cd\u6700\u4e3a\u5e38\u89c1\u7684\u5e76\u53d1\u63a7\u5236\u673a\u5236\uff0c\u5728\u4e00\u4e2a\u4e8b\u52a1\u4e2d\uff0c\u6211\u4eec\u5e76\u4e0d\u4f1a\u5c06\u6574\u4e2a\u6570\u636e\u5e93\u90fd\u52a0\u9501\uff0c\u800c\u662f\u53ea\u4f1a\u9501\u4f4f\u90a3\u4e9b\u9700\u8981\u8bbf\u95ee\u7684\u6570\u636e\u9879\uff0c <code>MySQL</code> \u548c\u5e38\u89c1\u6570\u636e\u5e93\u4e2d\u7684\u9501\u90fd\u5206\u4e3a\u4e24\u79cd\uff0c</p> <p>\u5171\u4eab\u9501\uff08<code>Shared</code>\uff09 \u548c \u4e92\u65a5\u9501\uff08<code>Exclusive</code>\uff09\uff0c\u524d\u8005\u4e5f\u53eb\u8bfb\u9501\uff0c\u540e\u8005\u53eb\u5199\u9501\u3002</p> <p></p> <p>\u8bfb\u9501\u4fdd\u8bc1\u4e86\u8bfb\u64cd\u4f5c\u53ef\u4ee5\u5e76\u53d1\u6267\u884c\uff0c\u76f8\u4e92\u4e0d\u4f1a\u5f71\u54cd\uff0c\u800c\u5199\u9501\u4fdd\u8bc1\u4e86\u5728\u66f4\u65b0\u6570\u636e\u5e93\u6570\u636e\u65f6\u4e0d\u4f1a\u6709\u5176\u4ed6\u7684\u4e8b\u52a1\u8bbf\u95ee\u6216\u8005\u66f4\u6539\u540c\u4e00\u6761\u8bb0\u5f55\u9020\u6210\u4e0d\u53ef\u9884\u77e5\u7684\u95ee\u9898\u3002</p>"},{"location":"chap1/mysql3_transaction/#2_2","title":"2 \u65f6\u95f4\u6233","text":"<p>\u9664\u4e86\u9501\uff0c\u53e6\u4e00\u79cd\u5b9e\u73b0\u4e8b\u52a1\u7684\u9694\u79bb\u6027\u7684\u65b9\u5f0f\u5c31\u662f\u901a\u8fc7\u65f6\u95f4\u6233\uff0c\u4f7f\u7528\u8fd9\u79cd\u65b9\u5f0f\u5b9e\u73b0\u4e8b\u52a1\u7684\u6570\u636e\u5e93\uff0c\u4f8b\u5982 <code>PostgreSQL</code> \u4f1a\u4e3a\u6bcf\u4e00\u6761\u8bb0\u5f55\u4fdd\u7559\u4e24\u4e2a\u5b57\u6bb5\uff1b</p> <ul> <li><code>\u8bfb\u65f6\u95f4\u6233</code>\u4e2d\u5305\u62ec\u4e86\u6240\u6709\u8bbf\u95ee\u8be5\u8bb0\u5f55\u7684\u4e8b\u52a1\u4e2d\u7684\u6700\u5927\u65f6\u95f4\u6233\uff0c\u800c\u8bb0\u5f55\u884c\u7684\u5199\u65f6\u95f4\u6233\u4e2d\u4fdd\u5b58\u4e86\u5c06\u8bb0\u5f55\u6539\u5230\u5f53\u524d\u503c\u7684\u4e8b\u52a1\u7684\u65f6\u95f4\u6233\u3002</li> </ul> <p></p> <p>\u4f7f\u7528\u65f6\u95f4\u6233\u5b9e\u73b0\u4e8b\u52a1\u7684\u9694\u79bb\u6027\u65f6\uff0c\u5f80\u5f80\u90fd\u4f1a\u4f7f\u7528\u4e50\u89c2\u9501\uff0c\u5148\u5bf9\u6570\u636e\u8fdb\u884c\u4fee\u6539\uff0c\u5728\u5199\u56de\u65f6\u518d\u53bb\u5224\u65ad\u5f53\u524d\u503c\uff0c\u4e5f\u5c31\u662f\u65f6\u95f4\u6233\u662f\u5426\u6539\u53d8\u8fc7\uff0c\u5982\u679c\u6ca1\u6709\u6539\u53d8\u8fc7\uff0c\u5c31\u5199\u5165\uff0c\u5426\u5219\uff0c\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u65f6\u95f4\u6233\u5e76\u518d\u6b21\u66f4\u65b0\u6570\u636e\uff0c\u4e50\u89c2\u9501\u5176\u5b9e\u5e76\u4e0d\u662f\u771f\u6b63\u7684\u9501\u673a\u5236\uff0c\u5b83\u53ea\u662f\u4e00\u79cd\u601d\u60f3\uff0c\u5728\u8fd9\u91cc\u5e76\u4e0d\u4f1a\u5bf9\u5b83\u8fdb\u884c\u5c55\u5f00\u4ecb\u7ecd\u3002</p>"},{"location":"chap1/mysql3_transaction/#3_2","title":"3 \u591a\u7248\u672c\u548c\u5feb\u7167\u9694\u79bb","text":"<p>\u901a\u8fc7\u7ef4\u62a4\u591a\u4e2a\u7248\u672c\u7684\u6570\u636e\uff0c\u6570\u636e\u5e93\u53ef\u4ee5\u5141\u8bb8\u4e8b\u52a1\u5728\u6570\u636e\u88ab\u5176\u4ed6\u4e8b\u52a1\u66f4\u65b0\u65f6\u5bf9\u65e7\u7248\u672c\u7684\u6570\u636e\u8fdb\u884c\u8bfb\u53d6\uff0c\u5f88\u591a\u6570\u636e\u5e93\u90fd\u5bf9\u8fd9\u4e00\u673a\u5236\u8fdb\u884c\u4e86\u5b9e\u73b0\uff1b\u56e0\u4e3a\u6240\u6709\u7684\u8bfb\u64cd\u4f5c\u4e0d\u518d\u9700\u8981\u7b49\u5f85\u5199\u9501\u7684\u91ca\u653e\uff0c\u6240\u4ee5\u80fd\u591f\u663e\u8457\u5730\u63d0\u5347\u8bfb\u7684\u6027\u80fd\uff0c<code>MySQL</code> \u548c <code>PostgreSQL</code> \u90fd\u5bf9\u8fd9\u4e00\u673a\u5236\u8fdb\u884c\u81ea\u5df1\u7684\u5b9e\u73b0\uff0c\u4e5f\u5c31\u662f <code>MVCC</code>\uff0c\u867d\u7136\u5404\u81ea\u5b9e\u73b0\u7684\u65b9\u5f0f\u6709\u6240\u4e0d\u540c\uff0c</p> <p><code>MySQL</code> \u5c31\u901a\u8fc7\u6587\u7ae0\u4e2d\u63d0\u5230\u7684\u56de\u6eda\u65e5\u5fd7\u5b9e\u73b0\u4e86 <code>MVCC</code>\uff0c\u4fdd\u8bc1\u4e8b\u52a1\u5e76\u884c\u6267\u884c\u65f6\u80fd\u591f\u4e0d\u7b49\u5f85\u4e92\u65a5\u9501\u7684\u91ca\u653e\u76f4\u63a5\u83b7\u53d6\u6570\u636e\u3002</p>"},{"location":"chap1/mysql3_transaction/#4_1","title":"4 \u9694\u79bb\u6027\u4e0e\u539f\u5b50\u6027","text":"<p>\u5728\u8fd9\u91cc\u5c31\u9700\u8981\u7b80\u5355\u63d0\u4e00\u4e0b\u5728\u5728\u539f\u5b50\u6027\u4e00\u8282\u4e2d\u9047\u5230\u7684\u7ea7\u8054\u56de\u6eda\u7b49\u95ee\u9898\u4e86\uff0c\u5982\u679c\u4e00\u4e2a\u4e8b\u52a1\u5bf9\u6570\u636e\u8fdb\u884c\u4e86\u5199\u5165\uff0c\u8fd9\u65f6\u5c31\u4f1a\u83b7\u53d6\u4e00\u4e2a\u4e92\u65a5\u9501\uff0c\u5176\u4ed6\u7684\u4e8b\u52a1\u5c31\u60f3\u8981\u83b7\u5f97\u6539\u884c\u6570\u636e\u7684\u8bfb\u9501\u5c31\u5fc5\u987b\u7b49\u5f85\u5199\u9501\u7684\u91ca\u653e\uff0c\u81ea\u7136\u5c31\u4e0d\u4f1a\u53d1\u751f\u7ea7\u8054\u56de\u6eda\u7b49\u95ee\u9898\u4e86\u3002</p> <p></p> <p>\u4e0d\u8fc7\u5728\u5927\u591a\u6570\u7684\u6570\u636e\u5e93\uff0c\u6bd4\u5982 <code>MySQL</code> \u4e2d\u90fd\u4f7f\u7528\u4e86 <code>MVCC</code> \u7b49\u7279\u6027\uff0c\u4e5f\u5c31\u662f\u6b63\u5e38\u7684\u8bfb\u65b9\u6cd5\u662f\u4e0d\u9700\u8981\u83b7\u53d6\u9501\u7684\uff0c\u5728\u60f3\u8981\u5bf9\u8bfb\u53d6\u7684\u6570\u636e\u8fdb\u884c\u66f4\u65b0\u65f6\u9700\u8981\u4f7f\u7528 <code>SELECT ... FOR UPDATE</code> \u5c1d\u8bd5\u83b7\u53d6\u5bf9\u5e94\u884c\u7684\u4e92\u65a5\u9501\uff0c\u4ee5\u4fdd\u8bc1\u4e0d\u540c\u4e8b\u52a1\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u3002</p>"},{"location":"chap1/mysql3_transaction/#5","title":"5 \u4e00\u81f4\u6027","text":"<p>\u4f5c\u8005\u8ba4\u4e3a\u6570\u636e\u5e93\u7684\u4e00\u81f4\u6027\u662f\u4e00\u4e2a\u975e\u5e38\u8ba9\u4eba\u8ff7\u60d1\u7684\u6982\u5ff5\uff0c\u539f\u56e0\u662f\u6570\u636e\u5e93\u9886\u57df\u5176\u5b9e\u5305\u542b\u4e24\u4e2a\u4e00\u81f4\u6027\uff0c\u4e00\u4e2a\u662f <code>ACID</code> \u4e2d\u7684\u4e00\u81f4\u6027\u3001\u53e6\u4e00\u4e2a\u662f <code>CAP</code> \u5b9a\u4e49\u4e2d\u7684\u4e00\u81f4\u6027\u3002</p> <p></p> <p>\u8fd9\u4e24\u4e2a\u6570\u636e\u5e93\u7684\u4e00\u81f4\u6027\u8bf4\u7684\u5b8c\u5168\u4e0d\u662f\u4e00\u4e2a\u4e8b\u60c5\uff0c\u5f88\u591a\u5f88\u591a\u4eba\u90fd\u5bf9\u8fd9\u4e24\u8005\u7684\u6982\u5ff5\u6709\u975e\u5e38\u6df1\u7684\u8bef\u89e3\uff0c\u5f53\u6211\u4eec\u5728\u8ba8\u8bba\u6570\u636e\u5e93\u7684\u4e00\u81f4\u6027\u65f6\uff0c\u4e00\u5b9a\u8981\u6e05\u695a\u4e0a\u4e0b\u6587\u7684\u8bed\u4e49\u662f\u4ec0\u4e48\uff0c\u5c3d\u91cf\u660e\u786e\u7684\u95ee\u51fa\u6211\u4eec\u8981\u8ba8\u8bba\u7684\u5230\u5e95\u662f ACID \u4e2d\u7684\u4e00\u81f4\u6027\u8fd8\u662f CAP \u4e2d\u7684\u4e00\u81f4\u6027\u3002</p>"},{"location":"chap1/mysql3_transaction/#1-acid","title":"1 ACID","text":"<p>\u6570\u636e\u5e93\u5bf9\u4e8e ACID \u4e2d\u7684\u4e00\u81f4\u6027\u7684\u5b9a\u4e49\u662f\u8fd9\u6837\u7684\uff1a\u5982\u679c\u4e00\u4e2a\u4e8b\u52a1\u539f\u5b50\u5730\u5728\u4e00\u4e2a\u4e00\u81f4\u5730\u6570\u636e\u5e93\u4e2d\u72ec\u7acb\u8fd0\u884c\uff0c\u90a3\u4e48\u5728\u5b83\u6267\u884c\u4e4b\u540e\uff0c\u6570\u636e\u5e93\u7684\u72b6\u6001\u4e00\u5b9a\u662f\u4e00\u81f4\u7684\u3002</p> <p>\u5bf9\u4e8e\u8fd9\u4e2a\u6982\u5ff5\uff0c\u5b83\u7684\u7b2c\u4e00\u5c42\u610f\u601d\u5c31\u662f\u5bf9\u4e8e\u6570\u636e\u5b8c\u6574\u6027\u7684\u7ea6\u675f\uff0c\u5305\u62ec\u4e3b\u952e\u7ea6\u675f\u3001\u5f15\u7528\u7ea6\u675f\u4ee5\u53ca\u4e00\u4e9b\u7ea6\u675f\u68c0\u67e5\u7b49\u7b49\uff0c\u5728\u4e8b\u52a1\u7684\u6267\u884c\u7684\u524d\u540e\u4ee5\u53ca\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u8fdd\u80cc\u5bf9\u6570\u636e\u5b8c\u6574\u6027\u7684\u7ea6\u675f\uff0c\u6240\u6709\u5bf9\u6570\u636e\u5e93\u5199\u5165\u7684\u64cd\u4f5c\u90fd\u5e94\u8be5\u662f\u5408\u6cd5\u7684\uff0c\u5e76\u4e0d\u80fd\u4ea7\u751f\u4e0d\u5408\u6cd5\u7684\u6570\u636e\u72b6\u6001\u3002</p> <p>A transaction must preserve database consistency - if a transaction is run atomically in isolation starting from a consistent database, the database must again be consistent at the end of the transaction.</p> <p>\u6211\u4eec\u53ef\u4ee5\u5c06\u4e8b\u52a1\u7406\u89e3\u6210\u4e00\u4e2a\u51fd\u6570\uff0c\u5b83\u63a5\u53d7\u4e00\u4e2a\u5916\u754c\u7684 <code>SQL</code> \u8f93\u5165\u548c\u4e00\u4e2a\u4e00\u81f4\u7684\u6570\u636e\u5e93\uff0c\u5b83\u4e00\u5b9a\u4f1a\u8fd4\u56de\u4e00\u4e2a\u4e00\u81f4\u7684\u6570\u636e\u5e93\u3002</p> <p>\u800c\u7b2c\u4e8c\u5c42\u610f\u601d\u5176\u5b9e\u662f\u6307\u903b\u8f91\u4e0a\u7684\u5bf9\u4e8e\u5f00\u53d1\u8005\u7684\u8981\u6c42\uff0c\u6211\u4eec\u8981\u5728\u4ee3\u7801\u4e2d\u5199\u51fa\u6b63\u786e\u7684\u4e8b\u52a1\u903b\u8f91\uff0c\u6bd4\u5982\u94f6\u884c\u8f6c\u8d26\uff0c\u4e8b\u52a1\u4e2d\u7684\u903b\u8f91\u4e0d\u53ef\u80fd\u53ea\u6263\u94b1\u6216\u8005\u53ea\u52a0\u94b1\uff0c\u8fd9\u662f\u5e94\u7528\u5c42\u9762\u4e0a\u5bf9\u4e8e\u6570\u636e\u5e93\u4e00\u81f4\u6027\u7684\u8981\u6c42\u3002</p> <p></p> <p>Ensuring consistency for an individual transaction is the responsibility of the application programmer who codes the transaction</p> <p>\u6570\u636e\u5e93 ACID \u4e2d\u7684\u4e00\u81f4\u6027\u5bf9\u4e8b\u52a1\u7684\u8981\u6c42\u4e0d\u6b62\u5305\u542b\u5bf9\u6570\u636e\u5b8c\u6574\u6027\u4ee5\u53ca\u5408\u6cd5\u6027\u7684\u68c0\u67e5\uff0c\u8fd8\u5305\u542b\u5e94\u7528\u5c42\u9762\u903b\u8f91\u7684\u6b63\u786e\u3002</p> <p><code>CAP</code> \u5b9a\u7406\u4e2d\u7684\u6570\u636e\u4e00\u81f4\u6027\uff0c\u5176\u5b9e\u662f\u8bf4\u5206\u5e03\u5f0f\u7cfb\u7edf\u4e2d\u7684\u5404\u4e2a\u8282\u70b9\u4e2d\u5bf9\u4e8e\u540c\u4e00\u6570\u636e\u7684\u62f7\u8d1d\u6709\u7740\u76f8\u540c\u7684\u503c\uff1b\u800c <code>ACID</code> \u4e2d\u7684\u4e00\u81f4\u6027\u662f\u6307\u6570\u636e\u5e93\u7684\u89c4\u5219\uff0c\u5982\u679c <code>schema</code> \u4e2d\u89c4\u5b9a\u4e86\u4e00\u4e2a\u503c\u5fc5\u987b\u662f\u552f\u4e00\u7684\uff0c\u90a3\u4e48\u4e00\u81f4\u7684\u7cfb\u7edf\u5fc5\u987b\u786e\u4fdd\u5728\u6240\u6709\u7684\u64cd\u4f5c\u4e2d\uff0c\u8be5\u503c\u90fd\u662f\u552f\u4e00\u7684\uff0c\u7531\u6b64\u6765\u770b <code>CAP</code> \u548c <code>ACID</code> \u5bf9\u4e8e\u4e00\u81f4\u6027\u7684\u5b9a\u4e49\u6709\u7740\u6839\u672c\u6027\u7684\u533a\u522b\u3002</p>"},{"location":"chap1/mysql4_index_perf/","title":"\u7b2c\u5341\u8282 \"Shallow Dive\" MySQL \u7d22\u5f15\u6027\u80fd\u5206\u6790\u6982\u8981","text":"<p><code>\"Shallow dive\" MySQL</code> \u7d22\u5f15\u8bbe\u8ba1\u6982\u8981\u4ecb\u7ecd\u4e86\u5f71\u54cd\u7d22\u5f15\u8bbe\u8ba1\u7684\u51e0\u5927\u56e0\u7d20\uff0c\u5305\u62ec\u8fc7\u6ee4\u56e0\u5b50\u3001\u7d22\u5f15\u7247\u7684\u5bbd\u7a84\u4e0e\u5927\u5c0f\u4ee5\u53ca\u5339\u914d\u5217\u548c\u8fc7\u6ee4\u5217\u3002</p> <p>\u7406\u60f3\u7684\u4e09\u661f\u7d22\u5f15\u7684\u8bbe\u8ba1\u6d41\u7a0b\u548c\u5957\u8def\uff0c\u5230\u76ee\u524d\u4e3a\u6b62\u867d\u7136\u6211\u4eec\u638c\u63e1\u4e86\u5355\u8868\u7d22\u5f15\u7684\u8bbe\u8ba1\u65b9\u6cd5\uff0c\u4f46\u662f\u5374\u6ca1\u6709\u5206\u6790\u9884\u4f30\u7d22\u5f15\u8017\u65f6\u7684\u80fd\u529b\u3002</p> <p></p>"},{"location":"chap1/mysql4_index_perf/#1","title":"1 \u57fa\u672c\u95ee\u9898\u6cd5","text":"<p>\u5f53\u6211\u4eec\u9700\u8981\u8003\u8651\u5bf9\u73b0\u6709\u7684 <code>SELECT</code> \u67e5\u8be2\u8fdb\u884c\u5206\u6790\u65f6\uff0c\u54ea\u6015\u6ca1\u6709\u8db3\u591f\u7684\u65f6\u95f4\uff0c\u4e5f\u5e94\u8be5\u4f7f\u7528\u57fa\u672c\u95ee\u9898\u6cd5\u5bf9\u67e5\u8be2\u8fdb\u884c\u8bc4\u4f30\uff0c\u8bc4\u4f30\u7684\u5185\u5bb9\u975e\u5e38\u7b80\u5355\uff1a</p> <p>\u73b0\u6709\u7684\u7d22\u5f15\u6216\u8005\u5373\u5c06\u6dfb\u52a0\u7684\u7d22\u5f15\u662f\u5426\u5305\u542b\u4e86 <code>WHERE</code> \u4e2d\u4f7f\u7528\u7684\u5168\u90e8\u5217\uff0c\u4e5f\u5c31\u662f\u5bf9\u4e8e\u5f53\u524d\u67e5\u8be2\u6765\u8bf4\uff0c\u662f\u5426\u6709\u4e00\u4e2a\u7d22\u5f15\u662f\u534a\u5bbd\u7d22\u5f15\u3002</p> <p></p> <ul> <li>\u7a84\u7d22\u5f15 (<code>username</code>) \u5176\u5b9e\u5c31\u53eb\u505a\u534a\u5bbd\u7d22\u5f15\uff0c\u5176\u4e2d\u5305\u542b\u4e86 <code>WHERE</code> \u4e2d\u7684\u5168\u90e8\u7684\u5217 <code>username</code>\uff0c\u5f53\u524d\u7d22\u5f15\u7684\u5bf9\u4e8e\u8be5\u67e5\u8be2\u53ea\u6709\u4e00\u9897\u661f, \u5b83\u867d\u7136\u907f\u514d\u4e86\u65e0\u6548\u7684\u56de\u8868\u67e5\u8be2\u9020\u6210\u7684\u968f\u673a <code>IO</code>\uff0c\u4f46\u662f\u5982\u679c\u5f53\u524d\u7684\u7d22\u5f15\u7684\u6027\u80fd\u4ecd\u7136\u65e0\u6cd5\u6ee1\u8db3\u9700\u8981</li> </ul> <pre><code>select id, username from users where username=\"draven\"\n</code></pre> <ul> <li>\u53ef\u4ee5\u6dfb\u52a0 <code>age</code> \u5c06\u8be5\u7d22\u5f15\u53d8\u6210\u5bbd\u7d22\u5f15 (<code>username, age</code>) \u4ee5\u6b64\u6765\u907f\u514d\u56de\u8868\u8bbf\u95ee\u9020\u6210\u7684\u6027\u80fd\u5f71\u54cd\uff1b</li> </ul> <pre><code>select id, username, age from users where username=\"draven\"\n</code></pre> <ul> <li>\u5bf9\u4e8e\u4e0a\u56fe\u4e2d\u7684\u7b80\u5355\u67e5\u8be2\uff0c\u7d22\u5f15 (<code>username, age</code>) \u5176\u5b9e\u5df2\u7ecf\u662f\u4e00\u4e2a\u4e09\u661f\u7d22\u5f15\u4e86\uff0c\u4f46\u662f\u5bf9\u4e8e\u5305\u542b <code>ORDER BY</code> \u6216\u8005\u66f4\u52a0\u590d\u6742\u7684\u67e5\u8be2\uff0c(<code>username, age</code>) \u53ef\u80fd\u5c31\u53ea\u662f\u4e8c\u661f\u7d22\u5f15\uff1a</li> </ul> <p></p> <pre><code>select id, username, age from users where username=\"draven\" order by city\n</code></pre> <p>\u867d\u7136\u57fa\u672c\u95ee\u9898\u6cd5\u80fd\u591f\u5feb\u901f\u89e3\u51b3\u4e00\u4e9b\u7531\u4e8e\u7d22\u5f15\u9020\u6210\u7684\u95ee\u9898\uff0c\u4f46\u662f\u5b83\u5e76\u4e0d\u80fd\u4fdd\u8bc1\u8db3\u591f\u7684\u6027\u80fd\uff0c\u5f53\u8868\u4e2d\u6709 (<code>city, username, age</code>) \u7d22\u5f15\uff0c\u8c13\u8bcd\u4e3a <code>WHERE username=\"draveness\" AND age=\"21\"</code> \u65f6\uff0c\u4f7f\u7528\u57fa\u672c\u95ee\u9898\u6cd5\u5e76\u4e0d\u80fd\u5f97\u51fa\u6b63\u786e\u7684\u7ed3\u679c\u3002</p>"},{"location":"chap1/mysql4_index_perf/#2","title":"2 \u5feb\u901f\u4f30\u7b97\u4e0a\u9650\u6cd5","text":"<p>\u57fa\u672c\u95ee\u9898\u6cd5\u975e\u5e38\u7b80\u5355\uff0c\u5b83\u80fd\u591f\u6700\u77ed\u7684\u65f6\u95f4\u5185\u5e2e\u52a9\u6211\u4eec\u8bc4\u4f30\u4e00\u4e2a\u67e5\u8be2\u7684\u6027\u80fd\uff0c\u4f46\u662f\u5b83\u5e76\u4e0d\u80fd\u51c6\u786e\u5730\u53cd\u6620\u4e00\u4e2a\u7d22\u5f15\u76f8\u5173\u7684\u6027\u80fd\u95ee\u9898\uff0c\u800c\u5feb\u901f\u4f30\u7b97\u4e0a\u9650\u6cd5\u5c31\u662f\u4e00\u79cd\u66f4\u52a0\u51c6\u786e\u3001\u590d\u6742\u7684\u65b9\u6cd5\u4e86\uff1b\u5176\u76ee\u7684\u5728\u4e8e\u5728\u7a0b\u5e8f\u5f00\u53d1\u671f\u95f4\u5c31\u80fd\u5c06\u8bbf\u95ee\u8def\u5f84\u7f13\u6162\u7684\u95ee\u9898\u66b4\u9732\u51fa\u6765\uff0c\u8fd9\u4e2a\u4f30\u7b97\u65b9\u6cd5\u7684\u8f93\u51fa\u5c31\u662f\u672c\u5730\u54cd\u5e94\u65f6\u95f4\uff08<code>Local Response Time</code>\uff09\uff1a</p> <p></p> <p>\u672c\u5730\u54cd\u5e94\u65f6\u95f4\u5c31\u662f\u67e5\u8be2\u5728\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e2d\u7684\u8017\u65f6\uff0c\u4e0d\u5305\u62ec\u4efb\u4f55\u7684\u7f51\u7edc\u5ef6\u8fdf\u548c\u591a\u5c42\u73af\u5883\u7684\u901a\u4fe1\u65f6\u95f4\uff0c\u4ec5\u5305\u62ec\u6267\u884c\u67e5\u8be2\u4efb\u52a1\u7684\u8017\u65f6\u3002</p>"},{"location":"chap1/mysql4_index_perf/#1_1","title":"1 \u54cd\u5e94\u65f6\u95f4","text":"<p>\u672c\u5730\u54cd\u5e94\u65f6\u95f4\u7b49\u4e8e<code>\u670d\u52a1\u65f6\u95f4</code>\u548c<code>\u6392\u961f\u65f6\u95f4</code>\u7684\u603b\u548c\uff0c\u4e00\u6b21\u67e5\u8be2\u8bf7\u6c42\u9700\u8981\u5728\u6570\u636e\u5e93\u4e2d\u7b49\u5f85 <code>CPU</code> \u4ee5\u53ca\u78c1\u76d8\u7684\u54cd\u5e94\uff0c\u4e5f\u53ef\u80fd\u4f1a\u56e0\u4e3a\u5176\u4ed6\u4e8b\u52a1\u6b63\u5728\u5bf9\u540c\u6837\u7684\u6570\u636e\u8fdb\u884c\u8bfb\u5199\uff0c\u5bfc\u81f4\u5f53\u524d\u67e5\u8be2\u9700\u8981\u7b49\u5f85\u9501\u7684\u83b7\u53d6\uff0c\u4e0d\u8fc7\u7ec4\u6210\u54cd\u5e94\u65f6\u95f4\u4e2d\u7684\u4e3b\u8981\u90e8\u5206\u8fd8\u662f\u78c1\u76d8\u7684\u670d\u52a1\u65f6\u95f4\uff1a</p> <p><code>\u672c\u5730\u54cd\u5e94  =  \u670d\u52a1\u65f6\u95f4  + \u6392\u961f\u65f6\u95f4</code></p> <p></p> <p><code>QUBE</code> \u5728\u8ba1\u7b97\u7684\u8fc7\u7a0b\u4e2d\u4f1a\u5ffd\u7565\u9664\u4e86\u78c1\u76d8\u6392\u961f\u65f6\u95f4\u7684\u5176\u4ed6\u6392\u961f\u65f6\u95f4\uff0c\u8fd9\u6837\u80fd\u591f\u7b80\u5316\u6574\u4e2a\u8bc4\u4f30\u6d41\u7a0b\uff0c\u800c\u78c1\u76d8\u7684\u670d\u52a1\u65f6\u95f4\u4e3b\u8981\u8fd8\u662f\u5305\u62ec\u540c\u6b65\u8bfb\u5199\u4ee5\u53ca\u5f02\u6b65\u8bfb\u51e0\u4e2a\u90e8\u5206\uff1a</p> <p></p> <p>\u5728\u6392\u9664\u4e86\u4e0a\u8ff0\u591a\u4e2a\u90e8\u5206\u7684\u5185\u5bb9\uff0c\u6211\u4eec\u5f97\u5230\u4e86\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u4f30\u7b97\u8fc7\u7a0b\uff0c</p> <p>\u6574\u4e2a\u4f30\u7b97\u65f6\u95f4\u7684\u8f93\u5165\u4ec5\u4e3a<code>\u968f\u673a\u8bfb</code>\u548c<code>\u987a\u5e8f\u8bfb</code>\u4ee5\u53ca<code>\u6570\u636e\u83b7\u53d6</code>\u7684\u4e09\u4e2a\u8f93\u5165\uff0c\u800c\u5b83\u4eec\u4e5f\u662f\u5f71\u54cd\u67e5\u8be2\u7684\u4e3b\u8981\u56e0\u7d20\uff1a</p> <p></p> <p>\u5176\u4e2d\u6570\u636e\u83b7\u53d6\u7684\u8fc7\u7a0b\u5728\u6bd4\u8f83\u4e0d\u540c\u7684\u7d22\u5f15\u5bf9\u540c\u4e00\u67e5\u8be2\u7684\u5f71\u54cd\u662f\u4e0d\u9700\u8981\u8003\u8651\u7684\uff0c\u56e0\u4e3a\u540c\u4e00\u67e5\u8be2\u4f7f\u7528\u4e0d\u540c\u7684\u7d22\u5f15\u4e5f\u4f1a\u5f97\u5230\u76f8\u540c\u7684\u7ed3\u679c\u96c6\uff0c\u83b7\u53d6\u7684\u6570\u636e\u4e5f\u662f\u5b8c\u5168\u76f8\u540c\u7684\u3002</p>"},{"location":"chap1/mysql4_index_perf/#2_1","title":"2 \u8bbf\u95ee","text":"<p>\u5f53 <code>MySQL</code> \u8bfb\u53d6\u4e00\u4e2a\u7d22\u5f15\u884c\u6216\u8005\u4e00\u4e2a\u8868\u884c\u65f6\uff0c\u5c31\u4f1a\u53d1\u751f\u4e00\u6b21\u8bbf\u95ee\uff0c</p> <ul> <li>\u5f53\u4f7f\u7528\u5168\u8868\u626b\u63cf\u6216\u8005\u626b\u63cf\u7d22\u5f15\u7247\u65f6\uff0c\u8bfb\u53d6\u7684\u7b2c\u4e00\u4e2a\u884c\u5c31\u662f\u968f\u673a\u8bbf\u95ee\uff0c\u968f\u673a\u8bbf\u95ee\u9700\u8981\u78c1\u76d8\u8fdb\u884c\u5bfb\u9053\u548c\u65cb\u8f6c\uff0c\u6240\u4ee5\u5176\u4ee3\u4ef7\u5de8\u5927\uff0c</li> <li>\u800c\u63a5\u4e0b\u6765\u987a\u5e8f\u8bfb\u53d6\u7684\u6240\u6709\u884c\u90fd\u662f\u901a\u8fc7\u987a\u5e8f\u8bbf\u95ee\u8bfb\u53d6\u7684\uff0c\u4ee3\u4ef7\u53ea\u6709\u968f\u673a\u8bbf\u95ee\u7684\u5343\u5206\u4e4b\u4e00\u3002</li> </ul> <p>\u5982\u679c\u5927\u91cf\u7684\u987a\u5e8f\u8bfb\u53d6\u7d22\u5f15\u884c\u548c\u8868\u884c\uff0c\u5728\u539f\u7406\u4e0a\u53ef\u80fd\u4f1a\u9020\u6210\u4e00\u4e9b\u989d\u5916\u7684\u96f6\u661f\u7684\u968f\u673a\u8bbf\u95ee\uff0c\u4e0d\u8fc7\u8fd9\u5bf9\u4e8e\u6574\u4e2a\u67e5\u8be2\u7684\u4f30\u7b97\u6765\u8bf4\u5176\u5b9e\u5e76\u4e0d\u91cd\u8981\uff1b\u5728\u8ba1\u7b97\u672c\u5730\u54cd\u5e94\u65f6\u95f4\u65f6\uff0c\u4ecd\u7136\u4f1a\u628a\u5b83\u4eec\u5f53\u505a\u987a\u5e8f\u8bbf\u95ee\u8fdb\u884c\u4f30\u7b97\u3002</p>"},{"location":"chap1/mysql4_index_perf/#3","title":"3 \u793a\u4f8b","text":"<p>\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u7b80\u5355\u5730\u4e3e\u4e00\u4e2a\u4f8b\u5b50\u6765\u5c55\u793a\u5982\u4f55\u8ba1\u7b97\u67e5\u8be2\u5728\u4f7f\u7528\u67d0\u4e2a\u7d22\u5f15\u65f6\u6240\u9700\u8981\u7684\u672c\u5730\u54cd\u5e94\u65f6\u95f4\uff0c\u5047\u8bbe\u6211\u4eec\u6709\u4e00\u5f20 <code>users</code> \u8868\uff0c\u5176\u4e2d\u6709\u4e00\u5343\u4e07\u6761\u6570\u636e\uff1a</p> <p></p> <p>\u5728\u8be5 <code>users</code> \u8868\u4e2d\u9664\u4e86\u4e3b\u952e\u7d22\u5f15\u4e4b\u5916\uff0c\u8fd8\u5177\u6709\u4ee5\u4e0b (<code>username, city)</code>\u3001(<code>username, age</code>) \u548c (<code>username</code>) \u51e0\u4e2a\u8f85\u52a9\u7d22\u5f15\uff0c\u5f53\u6211\u4eec\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8be2\u65f6\uff1a</p> <pre><code>select * from users where username=\"draven\" and city=\"beijing\"\n</code></pre> <p></p> <p>\u4e24\u4e2a\u67e5\u8be2\u6761\u4ef6\u5206\u522b\u6709\u7740 <code>0.05%</code> \u548c <code>12%</code> \u7684\u8fc7\u6ee4\u56e0\u5b50\uff0c\u8be5\u67e5\u8be2\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5df2\u6709\u7684\u8f85\u52a9\u7d22\u5f15 (<code>username, city</code>)\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u6839\u636e\u8868\u4e2d\u7684\u603b\u884c\u6570\u548c\u8fc7\u6ee4\u56e0\u5b50\u5f00\u59cb\u4f30\u7b97\u8fd9\u4e00\u6b65\u9aa4 <code>SQL</code> \u7684\u6267\u884c\u65f6\u95f4\uff1a</p> <p></p> <p>\u8be5\u67e5\u8be2\u5728\u5f00\u59cb\u65f6\u4f1a\u547d\u4e2d (<code>username, city</code>) \u7d22\u5f15\uff0c\u626b\u63cf\u7b26\u5408\u6761\u4ef6\u7684\u7d22\u5f15\u7247\uff0c\u8be5\u7d22\u5f15\u603b\u5171\u4f1a\u8bbf\u95ee </p> <pre><code>10,000,000 * 0.05% * 12% = 600\n</code></pre> <p>\u6761\u6570\u636e\uff0c\u5176\u4e2d\u5305\u62ec <code>1</code> \u6b21\u7684\u968f\u673a\u8bbf\u95ee\u548c <code>599</code> \u6b21\u7684\u987a\u5e8f\u8bbf\u95ee\uff0c\u56e0\u4e3a\u8be5\u7d22\u5f15\u4e2d\u7684\u5217\u5e76\u4e0d\u80fd\u6ee1\u8db3\u67e5\u8be2\u7684\u9700\u8981\uff0c\u6240\u4ee5\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u7d22\u5f15\u884c\u90fd\u4f1a\u4ea7\u751f\u4e00\u6b21\u8868\u7684\u968f\u673a\u8bbf\u95ee\uff0c\u4ee5\u83b7\u53d6\u5269\u4f59\u5217 <code>age</code> \u7684\u4fe1\u606f\uff1a</p> <p></p> <p>\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u603b\u5171\u4ea7\u751f\u4e86 <code>600</code> \u6b21\u968f\u673a\u8bbf\u95ee\uff0c\u6700\u540e\u53d6\u56de\u7ed3\u679c\u96c6\u7684\u8fc7\u7a0b\u4e2d\u4e5f\u4f1a\u6709 <code>600</code> \u6b21 <code>FETCH</code> \u64cd\u4f5c\uff0c</p> <p>\u4ece\u603b\u4f53\u4e0a\u6765\u770b\u8fd9\u4e00\u6b21 SQL \u67e5\u8be2\u5171\u8fdb\u884c\u4e86:  </p> <ul> <li><code>601</code> \u6b21\u968f\u673a\u8bbf\u95ee</li> <li><code>599</code> \u6b21\u987a\u5e8f\u8bbf\u95ee\u548c </li> <li><code>600</code> \u6b21 <code>FETCH</code>\uff0c</li> </ul> <p>\u6839\u636e\u4e0a\u4e00\u8282\u4e2d\u7684\u516c\u5f0f\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u8fd9\u4e2a\u67e5\u8be2\u7684\u7528\u65f6\u7ea6\u4e3a <code>6075.99ms</code> \u4e5f\u5c31\u662f <code>6s</code> \u5de6\u53f3\uff0c\u8fd9\u4e2a\u65f6\u95f4\u5bf9\u4e8e\u7edd\u5927\u591a\u6570\u5e94\u7528\u90fd\u662f\u65e0\u6cd5\u63a5\u53d7\u7684\u3002</p> <pre><code>601*10 + 599 * 0.1s + 600*0.01(fetch) = 6010 + 59.9 +  6 = 6075.99ms\n</code></pre> <p></p> <p>\u5728\u6574\u4e2a\u67e5\u8be2\u7684\u8fc7\u7a0b\u4e2d\uff0c\u56de\u8868\u67e5\u8be2\u7684 <code>600</code> \u6b21\u968f\u673a\u8bbf\u95ee\u6210\u4e3a\u4e86\u8fd9\u4e2a\u8d85\u7ea7\u6162\u7684\u67e5\u8be2\u7684\u4e3b\u8981\u8d21\u732e\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u53ea\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a (<code>username, city, age</code>) \u7d22\u5f15\u6216\u8005\u5728\u5df2\u6709\u7684 (<code>username, city</code>) \u540e\u6dfb\u52a0\u65b0\u7684 <code>age</code> \u5217\u5c31\u53ef\u4ee5\u907f\u514d <code>600</code> \u6b21\u7684\u968f\u673a\u8bbf\u95ee\uff1a</p> <p></p> <p>(<code>username, city, age</code>) \u7d22\u5f15\u5bf9\u4e8e\u8be5\u67e5\u8be2\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u4e09\u661f\u7d22\u5f15\u4e86\uff0c</p>"},{"location":"chap1/mysql5_btree/","title":"\u7b2c\u5341\u4e8c\u8282 \"Shallow Dive\" MySQL \u4e3a\u4f55\u4f7f\u7528 B+ \u6811\u800c\u975e\u54c8\u5e0c\u6216\u8005B \u6811","text":"<p>\u4e3a\u4ec0\u4e48 MySQL \u4f7f\u7528 B+ \u6811\u662f\u9762\u8bd5\u4e2d\u7ecf\u5e38\u4f1a\u51fa\u73b0\u7684\u95ee\u9898\uff0c\u5f88\u591a\u4eba\u5bf9\u4e8e\u8fd9\u4e2a\u95ee\u9898\u53ef\u80fd\u90fd\u6709\u4e00\u4e9b\u81ea\u5df1\u7684\u7406\u89e3\uff0c\u4f46\u662f\u591a\u6570\u7684\u56de\u7b54\u90fd\u4e0d\u591f\u5b8c\u6574\u548c\u51c6\u786e\uff0c\u5927\u591a\u6570\u4eba\u90fd\u53ea\u4f1a\u7b80\u5355\u8bf4\u4e00\u4e0b B+ \u6811\u548c B \u6811\u7684\u533a\u522b\uff0c\u4f46\u662f\u6ca1\u4ec0\u4e48\u771f\u6b63\u56de\u7b54 MySQL \u4e3a\u4ec0\u4e48\u9009\u62e9\u4f7f\u7528 B+ \u6811\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u5728\u8fd9\u7bc7\u6587\u7ae0\u4e2d\u5c31\u4f1a\u6df1\u5165\u5206\u6790 MySQL \u9009\u62e9 B+ \u6811\u80cc\u540e\u7684\u4e00\u4e9b\u539f\u56e0\u3002</p>"},{"location":"chap1/mysql5_btree/#1","title":"1 \u6982\u8ff0","text":"<p>\u9996\u5148\u9700\u8981\u6f84\u6e05\u7684\u4e00\u70b9\u662f\uff0c<code>MySQ</code>L \u8ddf <code>B+</code> \u6811\u6ca1\u6709\u76f4\u63a5\u7684\u5173\u7cfb\uff0c\u771f\u6b63\u4e0e <code>B+</code> \u6811\u6709\u5173\u7cfb\u7684\u662f <code>MySQL</code> \u7684\u9ed8\u8ba4\u5b58\u50a8\u5f15\u64ce <code>InnoDB</code>\uff0c</p> <p><code>MySQL</code> \u4e2d\u5b58\u50a8\u5f15\u64ce\u7684\u4e3b\u8981\u4f5c\u7528\u662f\u8d1f\u8d23\u6570\u636e\u7684\u5b58\u50a8\u548c\u63d0\u53d6\uff0c\u9664\u4e86 <code>InnoDB</code> \u4e4b\u5916\uff0c<code>MySQL</code> \u4e2d\u4e5f\u652f\u6301 <code>MyISAM</code> \u4f5c\u4e3a\u8868\u7684\u5e95\u5c42\u5b58\u50a8\u5f15\u64ce\u3002</p> <p></p> <p>\u6211\u4eec\u5728\u4f7f\u7528 <code>SQL</code> \u8bed\u53e5\u521b\u5efa\u8868\u65f6\u5c31\u53ef\u4ee5\u4e3a\u5f53\u524d\u8868\u6307\u5b9a\u4f7f\u7528\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u4f60\u80fd\u5728 MySQL \u7684\u6587\u6863 Alternative Storage Engines \u4e2d\u627e\u5230\u5b83\u652f\u6301\u7684\u5168\u90e8\u5b58\u50a8\u5f15\u64ce\uff0c\u4f8b\u5982\uff1a<code>MyISAM</code>\u3001<code>CSV</code>\u3001<code>MEMORY</code> \u7b49\uff0c</p> <p>\u7136\u800c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684 SQL \u8bed\u53e5\u6765\u521b\u5efa\u8868\u5c31\u4f1a\u5f97\u5230 InnoDB \u5b58\u50a8\u5f15\u64ce\u652f\u6491\u7684\u8868\uff1a</p> <pre><code>CREATE TABLE t1 (\n    a INT,\n    b CHAR (20), \n    PRIMARY KEY (a)) ENGINE=InnoDB;\n</code></pre> <p>\u6211\u4eec\u4eca\u5929\u6700\u7ec8\u5c06\u8981\u5206\u6790\u7684\u95ee\u9898\u5176\u5b9e\u8fd8\u662f\uff0c\u4e3a\u4ec0\u4e48 MySQL \u9ed8\u8ba4\u7684\u5b58\u50a8\u5f15\u64ce InnoDB \u4f1a\u4f7f\u7528 MySQL \u6765\u5b58\u50a8\u6570\u636e\uff0c\u76f8\u4fe1\u5bf9 MySQL \u7a0d\u5fae\u6709\u4e9b\u4e86\u89e3\u7684\u4eba\u90fd\u77e5\u9053\uff0c</p> <p>\u65e0\u8bba\u662f\u8868\u4e2d\u7684\u6570\u636e\uff08\u4e3b\u952e\u7d22\u5f15\uff09\u8fd8\u662f\u8f85\u52a9\u7d22\u5f15\u6700\u7ec8\u90fd\u4f1a\u4f7f\u7528 <code>B+</code> \u6811\u6765\u5b58\u50a8\u6570\u636e\uff0c\u5176\u4e2d\u524d\u8005\u5728\u8868\u4e2d\u4f1a\u4ee5 <code>&lt;id, row&gt;</code> \u7684\u65b9\u5f0f\u5b58\u50a8\uff0c\u800c\u540e\u8005\u4f1a\u4ee5 <code>&lt;index, id&gt;</code>\u7684\u65b9\u5f0f\u8fdb\u884c\u5b58\u50a8\uff0c\u8fd9\u5176\u5b9e\u4e5f\u6bd4\u8f83\u597d\u7406\u89e3\uff1a</p> <ul> <li>\u5728\u4e3b\u952e\u7d22\u5f15\u4e2d\uff0c<code>id</code> \u662f\u4e3b\u952e\uff0c\u6211\u4eec\u80fd\u591f\u901a\u8fc7 <code>id</code> \u627e\u5230\u8be5\u884c\u7684\u5168\u90e8\u5217\uff1b</li> <li>\u5728\u8f85\u52a9\u7d22\u5f15\u4e2d\uff0c\u7d22\u5f15\u4e2d\u7684\u51e0\u4e2a\u5217\u6784\u6210\u4e86\u952e\uff0c\u6211\u4eec\u80fd\u591f\u901a\u8fc7\u7d22\u5f15\u4e2d\u7684\u5217\u627e\u5230 <code>id</code>\uff0c\u5982\u679c\u6709\u9700\u8981\u7684\u8bdd\uff0c\u53ef\u4ee5\u518d\u901a\u8fc7 <code>id</code> \u627e\u5230\u5f53\u524d\u6570\u636e\u884c\u7684\u5168\u90e8\u5185\u5bb9\uff1b</li> </ul> <p>\u5bf9\u4e8e <code>InnoDB</code> \u6765\u8bf4\uff0c\u6240\u6709\u7684\u6570\u636e\u90fd\u662f\u4ee5\u952e\u503c\u5bf9\u7684\u65b9\u5f0f\u5b58\u50a8\u7684\uff0c\u4e3b\u952e\u7d22\u5f15\u548c\u8f85\u52a9\u7d22\u5f15\u5728\u5b58\u50a8\u6570\u636e\u65f6\u4f1a\u5c06 <code>id</code> \u548c <code>index</code> \u4f5c\u4e3a\u952e\uff0c\u5c06\u6240\u6709\u5217\u548c <code>id</code> \u4f5c\u4e3a\u952e\u5bf9\u5e94\u7684\u503c\u3002</p> <p></p> <p>\u5728\u5177\u4f53\u5206\u6790 <code>InnoDB</code> \u4f7f\u7528 <code>B+</code> \u6811\u80cc\u540e\u7684\u539f\u56e0\u4e4b\u524d\uff0c\u6211\u4eec\u9700\u8981\u4e3a <code>B+</code> \u6811\u627e\u51e0\u4e2a\u300e\u5047\u60f3\u654c\u300f\uff0c\u56e0\u4e3a\u5982\u679c\u6211\u4eec\u53ea\u6709\u4e00\u4e2a\u9009\u62e9\uff0c\u90a3\u4e48\u9009\u62e9 <code>B+</code> \u6811\u4e5f\u5e76\u4e0d\u503c\u5f97\u8ba8\u8bba\uff0c\u627e\u5230\u7684\u4e24\u4e2a\u5047\u60f3\u654c\u5c31\u662f B \u6811\u548c\u54c8\u5e0c\uff0c\u76f8\u4fe1\u8fd9\u4e5f\u662f\u5f88\u591a\u4eba\u4f1a\u5728\u9762\u8bd5\u4e2d\u771f\u5b9e\u9047\u5230\u7684\u95ee\u9898\uff0c\u6211\u4eec\u5c31\u4ee5\u8fd9\u4e24\u79cd\u6570\u636e\u7ed3\u6784\u4e3a\u4f8b\uff0c\u5206\u6790\u6bd4\u8f83 B+ \u6811\u7684\u4f18\u70b9\u3002</p>"},{"location":"chap1/mysql5_btree/#2","title":"2 \u8bbe\u8ba1","text":"<p>\u5230\u4e86\u8fd9\u91cc\u6211\u4eec\u5df2\u7ecf\u660e\u786e\u4e86\u4eca\u5929\u5f85\u8ba8\u8bba\u7684\u95ee\u9898\uff0c\u4e5f\u5c31\u662f\u4e3a\u4ec0\u4e48 MySQL \u7684 InnoDB \u5b58\u50a8\u5f15\u64ce\u4f1a\u9009\u62e9 B+ \u6811\u4f5c\u4e3a\u5e95\u5c42\u7684\u6570\u636e\u7ed3\u6784\uff0c\u800c\u4e0d\u9009\u62e9 B \u6811\u6216\u8005\u54c8\u5e0c\uff1f\u5728\u8fd9\u4e00\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u901a\u8fc7\u4ee5\u4e0b\u7684\u4e24\u4e2a\u65b9\u9762\u4ecb\u7ecd InnoDB \u8fd9\u6837\u9009\u62e9\u7684\u539f\u56e0\u3002</p> <ul> <li><code>InnoDB</code> \u9700\u8981\u652f\u6301\u7684\u573a\u666f\u548c\u529f\u80fd\u9700\u8981\u5728\u7279\u5b9a\u67e5\u8be2\u4e0a\u62e5\u6709\u8f83\u5f3a\u7684\u6027\u80fd\uff1b</li> <li><code>CPU</code> \u5c06\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u9700\u8981\u82b1\u8d39\u5927\u91cf\u7684\u65f6\u95f4\uff0c\u8fd9\u4f7f\u5f97 <code>B+</code> \u6811\u6210\u4e3a\u4e86\u975e\u5e38\u597d\u7684\u9009\u62e9\uff1b</li> </ul> <p>\u6570\u636e\u7684\u6301\u4e45\u5316\u4ee5\u53ca\u6301\u4e45\u5316\u6570\u636e\u7684\u67e5\u8be2\u5176\u5b9e\u662f\u4e00\u4e2a\u5e38\u89c1\u7684\u9700\u6c42\uff0c\u800c\u6570\u636e\u7684\u6301\u4e45\u5316\u5c31\u9700\u8981\u6211\u4eec\u4e0e\u78c1\u76d8\u3001\u5185\u5b58\u548c CPU \u6253\u4ea4\u9053\uff1b</p> <p><code>MySQL</code> \u4f5c\u4e3a <code>OLTP</code> \u7684\u6570\u636e\u5e93\u4e0d\u4ec5\u9700\u8981\u5177\u5907\u4e8b\u52a1\u7684\u5904\u7406\u80fd\u529b\uff0c\u800c\u4e14\u8981\u4fdd\u8bc1\u6570\u636e\u7684\u6301\u4e45\u5316\u5e76\u4e14\u80fd\u591f\u6709\u4e00\u5b9a\u7684\u5b9e\u65f6\u6570\u636e\u67e5\u8be2\u80fd\u529b\uff0c\u8fd9\u4e9b\u9700\u6c42\u5171\u540c\u51b3\u5b9a\u4e86 <code>B+</code> \u6811\u7684\u9009\u62e9\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u4f1a\u8be6\u7ec6\u5206\u6790\u4e0a\u8ff0\u4e24\u4e2a\u539f\u56e0\u80cc\u540e\u7684\u903b\u8f91\u3002</p>"},{"location":"chap1/mysql5_btree/#3-hash-is-bad","title":"3 \u8bfb\u5199\u6027\u80fd (Hash is bad)","text":"<p>\u5f88\u591a\u4eba\u5bf9 OLTP \u8fd9\u4e2a\u8bcd\u53ef\u80fd\u4e0d\u662f\u7279\u522b\u4e86\u89e3\uff0c\u6211\u4eec\u5e2e\u52a9\u5404\u4f4d\u8bfb\u8005\u5feb\u901f\u7406\u89e3\u4e00\u4e0b\uff0c\u4e0e <code>OLTP</code> \u76f8\u6bd4\u7684\u8fd8\u6709 <code>OLAP</code>\uff0c\u5b83\u4eec\u5206\u522b\u662f <code>Online Transaction Processing</code> \u548c <code>Online Analytical Processing</code>\uff0c\u4ece\u8fd9\u4e24\u4e2a\u540d\u5b57\u4e2d\u6211\u4eec\u5c31\u53ef\u4ee5\u770b\u51fa\uff0c</p> <ul> <li><code>OLTP</code>\u524d\u8005\u6307\u7684\u5c31\u662f\u4f20\u7edf\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0c\u4e3b\u8981\u7528\u4e8e\u5904\u7406\u57fa\u672c\u7684\u3001\u65e5\u5e38\u7684\u4e8b\u52a1\u5904\u7406\uff0c</li> <li><code>OLAP</code> \u800c\u540e\u8005\u4e3b\u8981\u5728\u6570\u636e\u4ed3\u5e93\u4e2d\u4f7f\u7528\uff0c\u7528\u4e8e\u652f\u6301\u4e00\u4e9b\u590d\u6742\u7684\u5206\u6790\u548c\u51b3\u7b56\u3002</li> </ul> <p></p> <p>\u4f5c\u4e3a\u652f\u6491 <code>OLTP</code> \u6570\u636e\u5e93\u7684\u5b58\u50a8\u5f15\u64ce\uff0c\u6211\u4eec\u7ecf\u5e38\u4f1a\u4f7f\u7528 InnoDB \u5b8c\u6210\u4ee5\u4e0b\u7684\u4e00\u4e9b\u5de5\u4f5c\uff1a</p> <ul> <li>\u901a\u8fc7 <code>INSERT</code>\u3001<code>UPDATE</code> \u548c <code>DELETE</code> \u8bed\u53e5\u5bf9\u8868\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u589e\u52a0\u3001\u4fee\u6539\u548c\u5220\u9664\uff1b</li> <li>\u901a\u8fc7 <code>UPDATE</code> \u548c <code>DELETE</code> \u8bed\u53e5\u5bf9\u7b26\u5408\u6761\u4ef6\u7684\u6570\u636e\u8fdb\u884c\u6279\u91cf\u7684\u5220\u9664\uff1b</li> <li>\u8fc7 <code>SELECT</code> \u8bed\u53e5\u548c\u4e3b\u952e\u67e5\u8be2\u67d0\u6761\u8bb0\u5f55\u7684\u5168\u90e8\u5217\uff1b</li> <li>\u901a\u8fc7 <code>SELECT</code> \u8bed\u53e5\u5728\u8868\u4e2d\u67e5\u8be2\u7b26\u5408\u67d0\u4e9b\u6761\u4ef6\u7684\u8bb0\u5f55\u5e76\u6839\u636e\u67d0\u4e9b\u5b57\u6bb5\u6392\u5e8f\uff1b</li> <li>\u901a\u8fc7 <code>SELECT</code>\u8bed\u53e5\u67e5\u8be2\u8868\u4e2d\u6570\u636e\u7684\u884c\u6570\uff1b</li> <li>\u901a\u8fc7\u552f\u4e00\u7d22\u5f15\u4fdd\u8bc1\u8868\u4e2d\u67d0\u4e2a\u5b57\u6bb5\u6216\u8005\u67d0\u51e0\u4e2a\u5b57\u6bb5\u7684\u552f\u4e00\u6027\uff1b</li> </ul> <p>\u5982\u679c\u6211\u4eec\u4f7f\u7528 <code>B+</code> \u6811\u4f5c\u4e3a\u5e95\u5c42\u7684\u6570\u636e\u7ed3\u6784\uff0c</p> <p>\u90a3\u4e48\u6240\u6709\u53ea\u4f1a\u8bbf\u95ee\u6216\u8005\u4fee\u6539\u4e00\u6761\u6570\u636e\u7684 <code>SQL</code> \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u90fd\u662f <code>O(log n)</code>\uff0c\u4e5f\u5c31\u662f\u6811\u7684\u9ad8\u5ea6</p> <p>\u4f46\u662f\u4f7f\u7528\u54c8\u5e0c\u5374\u6709\u53ef\u80fd\u8fbe\u5230 <code>O(1)</code> \u7684\u65f6\u95f4\u590d\u6742\u5ea6\uff0c\u770b\u8d77\u6765\u662f\u4e0d\u662f\u7279\u522b\u7684\u7f8e\u597d\u3002\u4f46\u662f\u5f53\u6211\u4eec\u4f7f\u7528\u5982\u4e0b\u6240\u793a\u7684 <code>SQL</code> \u65f6\uff0c\u54c8\u5e0c\u7684\u8868\u73b0\u5c31\u4e0d\u4f1a\u8fd9\u4e48\u597d\u4e86</p> <pre><code>SELECT * FROM posts WHERE author = 'draven' ORDER BY created_at DESC\nSELECT * FROM posts WHERE comments_count &gt; 10\nUPDATE posts SET github = 'github.com/draveness' WHERE author = 'draven'\nDELETE FROM posts WHERE author = 'draven'\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u4f7f\u7528\u54c8\u5e0c\u4f5c\u4e3a\u5e95\u5c42\u7684\u6570\u636e\u7ed3\u6784\uff0c\u9047\u5230\u4e0a\u8ff0\u7684\u573a\u666f\u65f6\uff0c\u4f7f\u7528\u54c8\u5e0c\u6784\u6210\u7684\u4e3b\u952e\u7d22\u5f15\u6216\u8005\u8f85\u52a9\u7d22\u5f15\u53ef\u80fd\u5c31\u6ca1\u6709\u529e\u6cd5\u5feb\u901f\u5904\u7406\u4e86\uff0c\u5b83\u5bf9\u4e8e\u5904\u7406\u8303\u56f4\u67e5\u8be2\u6216\u8005\u6392\u5e8f\u6027\u80fd\u4f1a\u975e\u5e38\u5dee\uff0c\u53ea\u80fd\u8fdb\u884c\u5168\u8868\u626b\u63cf\u5e76\u4f9d\u6b21\u5224\u65ad\u662f\u5426\u6ee1\u8db3\u6761\u4ef6\u3002\u5168\u8868\u626b\u63cf\u5bf9\u4e8e\u6570\u636e\u5e93\u6765\u8bf4\u662f\u4e00\u4e2a\u975e\u5e38\u7cdf\u7cd5\u7684\u7ed3\u679c\uff0c\u8fd9\u5176\u5b9e\u4e5f\u5c31\u610f\u5473\u7740\u6211\u4eec\u4f7f\u7528\u7684\u6570\u636e\u7ed3\u6784\u5bf9\u4e8e\u8fd9\u4e9b\u67e5\u8be2\u6ca1\u6709\u5176\u4ed6\u4efb\u4f55\u6548\u679c\uff0c\u6700\u7ec8\u7684\u6027\u80fd\u53ef\u80fd\u90fd\u4e0d\u5982\u4ece\u65e5\u5fd7\u4e2d\u987a\u5e8f\u8fdb\u884c\u5339\u914d\u3002</p> <p></p> <p>\u4f7f\u7528 <code>B+</code> \u6811\u5176\u5b9e\u80fd\u591f\u4fdd\u8bc1\u6570\u636e\u6309\u7167\u952e\u7684\u987a\u5e8f\u8fdb\u884c\u5b58\u50a8\uff0c\u4e5f\u5c31\u662f\u76f8\u90bb\u7684\u6240\u6709\u6570\u636e\u5176\u5b9e\u90fd\u662f\u6309\u7167\u81ea\u7136\u987a\u5e8f\u6392\u5217\u7684\uff0c\u4f7f\u7528\u54c8\u5e0c\u5374\u65e0\u6cd5\u8fbe\u5230\u8fd9\u6837\u7684\u6548\u679c\uff0c\u56e0\u4e3a\u54c8\u5e0c\u51fd\u6570\u7684\u76ee\u7684\u5c31\u662f\u8ba9\u6570\u636e\u5c3d\u53ef\u80fd\u88ab\u5206\u6563\u5230\u4e0d\u540c\u7684\u6876\u4e2d\u8fdb\u884c\u5b58\u50a8\uff0c\u6240\u4ee5\u5728\u9047\u5230\u53ef\u80fd\u5b58\u5728\u76f8\u540c\u952e <code>author = 'draven</code> \u6216\u8005\u6392\u5e8f\u4ee5\u53ca\u8303\u56f4\u67e5\u8be2 <code>comments_count &gt; 10</code> \u65f6\uff0c\u7531\u54c8\u5e0c\u4f5c\u4e3a\u5e95\u5c42\u6570\u636e\u7ed3\u6784\u7684\u8868\u53ef\u80fd\u5c31\u4f1a\u9762\u5bf9\u6570\u636e\u5e93\u67e5\u8be2\u7684\u5669\u68a6 \u2014\u2014 \u5168\u8868\u626b\u63cf\u3002</p> <p>B \u6811\u548c B+ \u6811\u5728\u6570\u636e\u7ed3\u6784\u4e0a\u5176\u5b9e\u6709\u4e00\u4e9b\u7c7b\u4f3c\uff0c\u5b83\u4eec\u90fd\u53ef\u4ee5\u6309\u7167\u67d0\u4e9b\u987a\u5e8f\u5bf9\u7d22\u5f15\u4e2d\u7684\u5185\u5bb9\u8fdb\u884c\u904d\u5386\uff0c\u5bf9\u4e8e\u6392\u5e8f\u548c\u8303\u56f4\u67e5\u8be2\u7b49\u64cd\u4f5c\uff0cB \u6811\u548c B+ \u6811\u76f8\u6bd4\u4e8e\u54c8\u5e0c\u4f1a\u5e26\u6765\u66f4\u597d\u7684\u6027\u80fd\uff0c\u5f53\u7136\u5982\u679c\u7d22\u5f15\u5efa\u7acb\u4e0d\u591f\u597d\u6216\u8005 SQL \u67e5\u8be2\u975e\u5e38\u590d\u6742\uff0c\u4f9d\u7136\u4f1a\u5bfc\u81f4\u5168\u8868\u626b\u63cf\u3002</p> <ul> <li>\u4e0e B \u6811\u548c B+ \u6811\u76f8\u6bd4\uff0c\u54c8\u5e0c\u4f5c\u4e3a\u5e95\u5c42\u7684\u6570\u636e\u7ed3\u6784\u7684\u8868\u80fd\u591f\u4ee5 <code>O(1)</code> \u7684\u901f\u5ea6\u5904\u7406\u5355\u4e2a\u6570\u636e\u884c\u7684\u589e\u5220\u6539\u67e5\uff0c\u4f46\u662f\u9762\u5bf9\u8303\u56f4\u67e5\u8be2\u6216\u8005\u6392\u5e8f\u65f6\u5c31\u4f1a\u5bfc\u81f4\u5168\u8868\u626b\u63cf\u7684\u7ed3\u679c\uff0c</li> <li>\u800c <code>B</code> \u6811\u548c <code>B+</code> \u6811\u867d\u7136\u5728\u5355\u6570\u636e\u884c\u7684\u589e\u5220\u67e5\u6539\u4e0a\u9700\u8981<code>O(log n)</code>\u7684\u65f6\u95f4\uff0c\u4f46\u662f\u5b83\u4f1a\u5c06\u7d22\u5f15\u5217\u76f8\u8fd1\u7684\u6570\u636e\u6309\u987a\u5e8f\u5b58\u50a8\uff0c\u6240\u4ee5\u80fd\u591f\u907f\u514d\u5168\u8868\u626b\u63cf\u3002</li> </ul>"},{"location":"chap1/mysql5_btree/#4-b-trees-is-bad","title":"4 \u6570\u636e\u52a0\u8f7d (B trees is bad)","text":"<p>\u65e2\u7136\u4f7f\u7528\u54c8\u5e0c\u65e0\u6cd5\u5e94\u5bf9\u6211\u4eec\u5e38\u89c1\u7684 <code>SQL</code> \u4e2d\u6392\u5e8f\u548c\u8303\u56f4\u67e5\u8be2\u7b49\u64cd\u4f5c\uff0c\u800c <code>B</code> \u6811\u548c <code>B</code> \u6811\u548c <code>B+</code> \u6811\u90fd\u53ef\u4ee5\u76f8\u5bf9\u9ad8\u6548\u5730\u6267\u884c\u8fd9\u4e9b\u67e5\u8be2\uff0c\u90a3\u4e48\u4e3a\u4ec0\u4e48\u6211\u4eec\u4e0d\u9009\u62e9 <code>B</code> \u6811\u5462\uff1f</p> <p>\u8fd9\u4e2a\u539f\u56e0\u5176\u5b9e\u975e\u5e38\u7b80\u5355 \u2014\u2014 \u8ba1\u7b97\u673a\u5728\u8bfb\u5199\u6587\u4ef6\u65f6\u4f1a\u4ee5\u9875\u4e3a\u5355\u4f4d\u5c06\u6570\u636e\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u3002\u9875\u7684\u5927\u5c0f\u53ef\u80fd\u4f1a\u6839\u636e\u64cd\u4f5c\u7cfb\u7edf\u7684\u4e0d\u540c\u800c\u53d1\u751f\u53d8\u5316\uff0c\u4e0d\u8fc7\u5728\u5927\u591a\u6570\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0c\u9875\u7684\u5927\u5c0f\u90fd\u662f <code>4KB</code>\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u7684\u547d\u4ee4\u83b7\u53d6\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u7684\u9875\u5927\u5c0f:</p> <pre><code>$ getconf PAGE_SIZE\n4096\n</code></pre> <p>\u5f53\u6211\u4eec\u9700\u8981\u5728\u6570\u636e\u5e93\u4e2d\u67e5\u8be2\u6570\u636e\u65f6\uff0c</p> <ul> <li><code>CPU</code> \u4f1a\u53d1\u73b0\u5f53\u524d\u6570\u636e\u4f4d\u4e8e\u78c1\u76d8\u800c\u4e0d\u662f\u5185\u5b58\u4e2d\uff0c</li> <li>\u8fd9\u65f6\u5c31\u4f1a\u89e6\u53d1 <code>I/O</code> \u64cd\u4f5c\u5c06\u6570\u636e\u52a0\u8f7d\u5230\u5185\u5b58\u4e2d\u8fdb\u884c\u8bbf\u95ee\uff0c</li> <li>\u6570\u636e\u7684\u52a0\u8f7d\u90fd\u662f\u4ee5\u9875\u7684\u7ef4\u5ea6\u8fdb\u884c\u52a0\u8f7d\u7684\uff0c\u7136\u800c\u5c06\u6570\u636e\u4ece\u78c1\u76d8\u8bfb\u53d6\u5230\u5185\u5b58\u4e2d\u6240\u9700\u8981\u7684\u6210\u672c\u662f\u975e\u5e38\u5927\u7684\uff0c\u666e\u901a\u78c1\u76d8\uff08\u975e <code>SSD</code>\uff09\u52a0\u8f7d\u6570\u636e\u9700\u8981\u7ecf\u8fc7\u961f\u5217\u3001\u5bfb\u9053\u3001\u65cb\u8f6c\u4ee5\u53ca\u4f20\u8f93\u7684\u8fd9\u4e9b\u8fc7\u7a0b\uff0c\u5927\u6982\u8981\u82b1\u8d39 <code>10ms</code> \u5de6\u53f3\u7684\u65f6\u95f4\u3002</li> </ul> <p></p> <p>\u6211\u4eec\u5728\u4f30\u7b97 <code>MySQL</code> \u7684\u67e5\u8be2\u65f6\u5c31\u53ef\u4ee5\u4f7f\u7528 <code>10ms</code> \u8fd9\u4e2a\u6570\u91cf\u7ea7\u5bf9\u968f\u673a <code>I/O</code> \u5360\u7528\u7684\u65f6\u95f4\u8fdb\u884c\u4f30\u7b97\uff0c\u8fd9\u91cc\u60f3\u8981\u8bf4\u7684\u662f\u968f\u673a <code>I/O</code> \u5bf9\u4e8e <code>MySQL</code> \u7684\u67e5\u8be2\u6027\u80fd\u5f71\u54cd\u4f1a\u975e\u5e38\u5927\uff0c\u800c\u987a\u5e8f\u8bfb\u53d6\u78c1\u76d8\u4e2d\u7684\u6570\u636e\u65f6\u901f\u5ea6\u53ef\u4ee5\u8fbe\u5230 <code>40MB/s</code>\uff0c\u8fd9\u4e24\u8005\u7684\u6027\u80fd\u5dee\u8ddd\u6709\u51e0\u4e2a\u6570\u91cf\u7ea7\uff0c\u7531\u6b64\u6211\u4eec\u4e5f\u5e94\u8be5\u5c3d\u91cf\u51cf\u5c11\u968f\u673a I/O \u7684\u6b21\u6570\uff0c\u8fd9\u6837\u624d\u80fd\u63d0\u9ad8\u6027\u80fd\u3002</p> <p><code>B</code> \u6811\u4e0e <code>B+</code> \u6811\u7684\u6700\u5927\u533a\u522b\u5c31\u662f\uff0c<code>B</code> \u6811\u53ef\u4ee5\u5728\u975e\u53f6\u7ed3\u70b9\u4e2d\u5b58\u50a8\u6570\u636e\uff0c\u4f46\u662f <code>B+</code> \u6811\u7684\u6240\u6709\u6570\u636e\u5176\u5b9e\u90fd\u5b58\u50a8\u5728\u53f6\u5b50\u8282\u70b9\u4e2d\uff0c\u5f53\u4e00\u4e2a\u8868\u5e95\u5c42\u7684\u6570\u636e\u7ed3\u6784\u662f <code>B</code> \u6811\u65f6\uff0c\u5047\u8bbe\u6211\u4eec\u9700\u8981\u8bbf\u95ee\u6240\u6709<code>\u300e\u5927\u4e8e 4\uff0c\u5e76\u4e14\u5c0f\u4e8e 9 \u7684\u6570\u636e\u300f</code>\uff1a</p> <p></p> <p>\u5982\u679c\u4e0d\u8003\u8651\u4efb\u4f55\u4f18\u5316\uff0c\u5728\u4e0a\u9762\u7684\u7b80\u5355 <code>B</code> \u6811\u4e2d\u6211\u4eec\u9700\u8981\u8fdb\u884c <code>4</code> \u6b21\u78c1\u76d8\u7684\u968f\u673a <code>I/O</code> \u624d\u80fd\u627e\u5230\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u884c\uff1a</p> <ol> <li>\u52a0\u8f7d\u6839\u8282\u70b9\u6240\u5728\u7684\u9875\uff0c\u53d1\u73b0\u6839\u8282\u70b9\u7684\u7b2c\u4e00\u4e2a\u5143\u7d20\u662f 6\uff0c\u5927\u4e8e 4\uff1b</li> <li>\u901a\u8fc7\u6839\u8282\u70b9\u7684\u6307\u9488\u52a0\u8f7d\u5de6\u5b50\u8282\u70b9\u6240\u5728\u7684\u9875\uff0c\u904d\u5386\u9875\u9762\u4e2d\u7684\u6570\u636e\uff0c\u627e\u5230 5\uff1b</li> <li>\u91cd\u65b0\u52a0\u8f7d\u6839\u8282\u70b9\u6240\u5728\u7684\u9875\uff0c\u53d1\u73b0\u6839\u8282\u70b9\u4e0d\u5305\u542b\u7b2c\u4e8c\u4e2a\u5143\u7d20\uff1b</li> <li>\u901a\u8fc7\u6839\u8282\u70b9\u7684\u6307\u9488\u52a0\u8f7d\u53f3\u5b50\u8282\u70b9\u6240\u5728\u7684\u9875\uff0c\u904d\u5386\u9875\u9762\u4e2d\u7684\u6570\u636e\uff0c\u627e\u5230 7 \u548c 8\uff1b</li> </ol> <p>\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5404\u79cd\u65b9\u5f0f\u6765\u5bf9\u4e0a\u8ff0\u7684\u8fc7\u7a0b\u8fdb\u884c\u4f18\u5316\uff0c\u4e0d\u8fc7 B \u6811\u80fd\u505a\u7684\u4f18\u5316 B+ \u6811\u57fa\u672c\u90fd\u53ef\u4ee5\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u9700\u8981\u8003\u8651\u4f18\u5316 B \u6811\u800c\u5e26\u6765\u7684\u6536\u76ca\uff0c\u76f4\u63a5\u6765\u770b\u770b\u4ec0\u4e48\u6837\u7684\u4f18\u5316 B+ \u6811\u53ef\u4ee5\u505a\uff0c\u800c B \u6811\u4e0d\u884c\u3002</p> <p></p> <p>\u7531\u4e8e\u6240\u6709\u7684\u8282\u70b9\u90fd\u53ef\u80fd\u5305\u542b\u76ee\u6807\u6570\u636e\uff0c\u6211\u4eec\u603b\u662f\u8981\u4ece\u6839\u8282\u70b9\u5411\u4e0b\u904d\u5386\u5b50\u6811\u67e5\u627e\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u884c\uff0c\u8fd9\u4e2a\u7279\u70b9\u5e26\u6765\u4e86\u5927\u91cf\u7684\u968f\u673a <code>I/O</code>\uff0c\u4e5f\u662f <code>B</code> \u6811\u6700\u5927\u7684\u6027\u80fd\u95ee\u9898\u3002</p> <p><code>B+</code> \u6811\u4e2d\u5c31\u4e0d\u5b58\u5728\u8fd9\u4e2a\u95ee\u9898\u4e86\uff0c\u56e0\u4e3a\u6240\u6709\u7684\u6570\u636e\u884c\u90fd\u5b58\u50a8\u5728\u53f6\u8282\u70b9\u4e2d\uff0c\u800c\u8fd9<code>\u4e9b\u53f6\u8282\u70b9\u53ef\u4ee5\u901a\u8fc7\u300e\u6307\u9488\u300f\u4f9d\u6b21\u6309\u987a\u5e8f\u8fde\u63a5</code>\uff0c</p> <p>\u5f53\u6211\u4eec\u5728\u5982\u4e0b\u6240\u793a\u7684 <code>B+</code> \u6811\u904d\u5386\u6570\u636e\u65f6\u53ef\u4ee5\u76f4\u63a5\u5728\u591a\u4e2a\u5b50\u8282\u70b9\u4e4b\u95f4\u8fdb\u884c\u8df3\u8f6c\uff0c\u8fd9\u6837\u80fd\u591f\u8282\u7701\u5927\u91cf\u7684\u78c1\u76d8 <code>I/</code>O \u65f6\u95f4\uff0c\u4e5f\u4e0d\u9700\u8981\u5728\u4e0d\u540c\u5c42\u7ea7\u7684\u8282\u70b9\u4e4b\u95f4\u5bf9\u6570\u636e\u8fdb\u884c\u62fc\u63a5\u548c\u6392\u5e8f\uff1b</p> <p>\u901a\u8fc7\u4e00\u4e2a <code>B+</code> \u6811\u6700\u5de6\u4fa7\u7684\u53f6\u5b50\u8282\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u50cf\u94fe\u8868\u4e00\u6837\u904d\u5386\u6574\u4e2a\u6811\u4e2d\u7684\u5168\u90e8\u6570\u636e\uff0c\u5f53\u6211\u4eec\u4e5f\u53ef\u4ee5\u4f7f\u7528\u53cc\u5411\u94fe\u8868\u4fdd\u8bc1\u5012\u5e8f\u904d\u5386\u65f6\u7684\u6027\u80fd\u3002</p> <p>\u6709\u4e9b\u8bfb\u8005\u53ef\u80fd\u4f1a\u8ba4\u4e3a\u4f7f\u7528 <code>B+</code> \u6811\u8fd9\u79cd\u6570\u636e\u7ed3\u6784\u4f1a\u589e\u52a0\u6811\u7684\u9ad8\u5ea6\u4ece\u800c\u589e\u52a0\u6574\u4f53\u7684\u8017\u65f6\uff0c</p> <p>\u7136\u800c\u9ad8\u5ea6\u4e3a 3 \u7684 <code>B+</code> \u6811\u5c31\u80fd\u591f\u5b58\u50a8\u5343\u4e07\u7ea7\u522b\u7684\u6570\u636e\uff0c\u5b9e\u8df5\u4e2d <code>B+</code> \u6811\u7684\u9ad8\u5ea6\u6700\u591a\u4e5f\u5c31 <code>4</code> \u6216\u8005 <code>5</code>\uff0c\u6240\u4ee5\u8fd9\u5e76\u4e0d\u662f\u5f71\u54cd\u6027\u80fd\u7684\u6839\u672c\u95ee\u9898\u3002</p>"},{"location":"chap1/mysql5_btree/#5","title":"5 \u603b\u7ed3","text":"<p>\u4efb\u4f55\u4e0d\u8003\u8651\u5e94\u7528\u573a\u666f\u7684\u8bbe\u8ba1\u90fd\u4e0d\u662f\u6700\u597d\u7684\u8bbe\u8ba1\uff0c\u5f53\u6211\u4eec\u660e\u786e\u7684\u5b9a\u4e49\u4e86\u4f7f\u7528 MySQL \u65f6\u7684\u5e38\u89c1\u67e5\u8be2\u9700\u6c42\u5e76\u7406\u89e3\u573a\u666f\u4e4b\u540e\uff0c\u518d\u5bf9\u4e0d\u540c\u7684\u6570\u636e\u7ed3\u6784\u8fdb\u884c\u9009\u62e9\u5c31\u6210\u4e86\u7406\u6240\u5f53\u7136\u7684\u4e8b\u60c5\uff0c\u5f53\u7136 B+ \u6811\u53ef\u80fd\u65e0\u6cd5\u5bf9\u6240\u6709 OLTP \u573a\u666f\u4e0b\u7684\u67e5\u8be2\u90fd\u6709\u7740\u8f83\u597d\u7684\u6027\u80fd\uff0c\u4f46\u662f\u5b83\u80fd\u591f\u89e3\u51b3\u5927\u591a\u6570\u7684\u95ee\u9898\u3002</p> <p>\u6211\u4eec\u5728\u8fd9\u91cc\u91cd\u65b0\u56de\u987e\u4e00\u4e0b MySQL \u9ed8\u8ba4\u7684\u5b58\u50a8\u5f15\u64ce\u9009\u62e9 B+ \u6811\u800c\u4e0d\u662f\u54c8\u5e0c\u6216\u8005 B \u6811\u7684\u539f\u56e0\uff1a</p> <ul> <li>\u54c8\u5e0c\u867d\u7136\u80fd\u591f\u63d0\u4f9b <code>O(1)</code> \u7684\u5355\u6570\u636e\u884c\u64cd\u4f5c\u6027\u80fd\uff0c\u4f46\u662f\u5bf9\u4e8e<code>\u8303\u56f4\u67e5\u8be2</code>\u548c`\u6392\u5e8f\u5374\u65e0\u6cd5\u5f88\u597d\u5730\u652f\u6301\uff0c\u6700\u7ec8\u5bfc\u81f4\u5168\u8868\u626b\u63cf\uff1b</li> <li><code>B</code> \u6811\u80fd\u591f\u5728\u975e\u53f6\u8282\u70b9\u4e2d\u5b58\u50a8\u6570\u636e\uff0c\u4f46\u662f\u8fd9\u4e5f\u5bfc\u81f4\u5728\u67e5\u8be2\u8fde\u7eed\u6570\u636e\u65f6\u53ef\u80fd\u4f1a\u5e26\u6765\u66f4\u591a\u7684\u968f\u673a <code>I/O</code>\uff0c</li> <li>\u800c <code>B+</code> \u6811\u7684\u6240\u6709\u53f6\u8282\u70b9\u53ef\u4ee5\u901a\u8fc7\u6307\u9488\u76f8\u4e92\u8fde\u63a5\uff0c\u80fd\u591f\u51cf\u5c11\u987a\u5e8f\u904d\u5386\u65f6\u4ea7\u751f\u7684\u989d\u5916\u968f\u673a <code>I/O</code>\uff1b</li> </ul> <p>\u5982\u679c\u60f3\u8981\u8ffd\u6c42\u5404\u65b9\u9762\u7684\u6781\u81f4\u6027\u80fd\u4e5f\u4e0d\u662f\u6ca1\u6709\u53ef\u80fd\uff0c\u53ea\u662f\u4f1a\u5e26\u6765\u66f4\u9ad8\u7684\u590d\u6742\u5ea6\uff0c\u6211\u4eec\u53ef\u4ee5\u4e3a\u4e00\u5f20\u8868\u540c\u65f6\u5efa B+ \u6811\u548c\u54c8\u5e0c\u6784\u6210\u7684\u5b58\u50a8\u7ed3\u6784\uff0c\u8fd9\u6837\u4e0d\u540c\u7c7b\u578b\u7684\u67e5\u8be2\u5c31\u53ef\u4ee5\u9009\u62e9\u76f8\u5bf9\u66f4\u5feb\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4f46\u662f\u4f1a\u5bfc\u81f4\u66f4\u65b0\u548c\u5220\u9664\u65f6\u9700\u8981\u64cd\u4f5c\u591a\u4efd\u6570\u636e\u3002</p> <p>\u4ece\u4eca\u5929\u7684\u89d2\u5ea6\u6765\u770b\uff0cB+ \u6811\u53ef\u80fd\u4e0d\u662f InnoDB \u7684\u6700\u4f18\u9009\u62e9\uff0c\u4f46\u662f\u5b83\u4e00\u5b9a\u662f\u80fd\u591f\u6ee1\u8db3\u5f53\u65f6\u8bbe\u8ba1\u573a\u666f\u7684\u9700\u8981\uff0c\u4ece B+ \u6811\u4f5c\u4e3a\u6570\u636e\u5e93\u5e95\u5c42\u7684\u5b58\u50a8\u7ed3\u6784\u5230\u4eca\u5929\u5df2\u7ecf\u8fc7\u4e86\u51e0\u5341\u5e74\u7684\u65f6\u95f4\uff0c\u6211\u4eec\u4e0d\u5f97\u4e0d\u8bf4\u4f18\u79c0\u7684\u5de5\u7a0b\u8bbe\u8ba1\u786e\u5b9e\u6709\u8db3\u591f\u7684\u751f\u547d\u529b\u3002\u800c\u6211\u4eec\u4f5c\u4e3a\u5de5\u7a0b\u5e08\uff0c\u5728\u9009\u62e9\u6570\u636e\u5e93\u65f6\u4e5f\u5e94\u8be5\u975e\u5e38\u6e05\u695a\u5730\u77e5\u9053\u4e0d\u540c\u6570\u636e\u5e93\u9002\u5408\u7684\u573a\u666f\uff0c\u56e0\u4e3a\u8f6f\u4ef6\u5de5\u7a0b\u4e2d\u6ca1\u6709\u94f6\u5f39\u3002</p>"},{"location":"chap1/mysql_bia_review/","title":"MySQL \u57fa\u7840\u77e5\u8bc6\u590d\u4e60","text":""},{"location":"chap1/mysql_bia_review/#1-sql-primary-key","title":"1 SQL Primary Key","text":"<ul> <li>Primary keys must contain unique values.</li> <li>A primary key column cannot have NULL values.</li> <li>A table can have only one primary key, which may consist of single or multiple fields.</li> <li>When multiple fields are used as a primary key, they are called a composite key.</li> <li>\u4f5c\u4e3aPrimary Key\u7684\u57df/\u57df\u7ec4\u4e0d\u80fd\u4e3anull\uff0c\u800cUnique Key\u53ef\u4ee5\u3002</li> <li>\u5728\u4e00\u4e2a\u8868\u4e2d\u53ea\u80fd\u6709\u4e00\u4e2aPrimary Key\uff0c\u800c\u591a\u4e2aUnique Key\u53ef\u4ee5\u540c\u65f6\u5b58\u5728</li> </ul>"},{"location":"chap1/mysql_bia_review/#2-sql","title":"2 \u65e5\u5fd7\u7cfb\u7edf\uff1a\u6267\u884c\u4e00\u6761SQL\u66f4\u65b0\u8bed\u53e5","text":"<p>\u4e00\u6761\u67e5\u8be2\u8bed\u53e5\u7684\u6267\u884c\u8fc7\u7a0b\u4e00\u822c\u662f\u7ecf\u8fc7\u8fde\u63a5\u5668\u3001\u5206\u6790\u5668\u3001\u4f18\u5316\u5668\u3001\u6267\u884c\u5668\u7b49\u529f\u80fd\u6a21\u5757\uff0c\u6700\u540e\u5230\u8fbe\u5b58\u50a8\u5f15\u64ce</p>"},{"location":"chap1/mysql_bia_review/#2-1-redo-log","title":"2-1 \u65e5\u5fd7\u6a21\u5757\uff1aredo log","text":"<p>MySQL \u91cc\u7ecf\u5e38\u8bf4\u5230\u7684 WAL \u6280\u672f\uff0cWAL \u7684\u5168\u79f0\u662f Write-Ahead Logging\uff0c\u5b83\u7684\u5173\u952e\u70b9\u5c31\u662f\u5148\u5199\u65e5\u5fd7\uff0c\u518d\u5199\u78c1\u76d8\u3002</p> <p>\u5177\u4f53\u6765\u8bf4\uff0c\u5f53\u6709\u4e00\u6761\u8bb0\u5f55\u9700\u8981\u66f4\u65b0\u7684\u65f6\u5019\uff0cInnoDB \u5f15\u64ce\u5c31\u4f1a\u5148\u628a\u8bb0\u5f55\u5199\u5230 redo log\u91cc\u9762\uff0c\u5e76\u66f4\u65b0\u5185\u5b58\uff0c\u8fd9\u4e2a\u65f6\u5019\u66f4\u65b0\u5c31\u7b97\u5b8c\u6210\u4e86\u3002</p> <p>\u540c\u65f6\uff0cInnoDB \u5f15\u64ce\u4f1a\u5728\u9002\u5f53\u7684\u65f6\u5019\uff0c\u5c06\u8fd9\u4e2a\u64cd\u4f5c\u8bb0\u5f55\u66f4\u65b0\u5230\u78c1\u76d8\u91cc\u9762\uff0c\u800c\u8fd9\u4e2a\u66f4\u65b0\u5f80\u5f80\u662f\u5728\u7cfb\u7edf\u6bd4\u8f83\u7a7a\u95f2\u7684\u65f6\u5019\u505a\u3002</p>"},{"location":"chap1/mysql_bia_review/#2-3-binlog","title":"2-3 \u65e5\u5fd7\u6a21\u5757\uff1abinlog","text":"<p>Binlog\u6709\u4e24\u79cd\u6a21\u5f0f \uff1a </p> <ul> <li>statement \u683c\u5f0f\u7684\u8bdd\u662f\u8bb0sql\u8bed\u53e5\uff0c</li> <li>row\u683c\u5f0f\u4f1a\u8bb0\u5f55\u884c\u7684\u5185\u5bb9\uff0c\u8bb0\u4e24\u6761\uff0c\u66f4\u65b0\u524d\u548c\u66f4\u65b0\u540e\u90fd\u6709\u3002</li> </ul> <p>\u641c\u7d22 log \u540d\u79f0\uff1a<code>show variables like '%log_bin%';</code></p> <p>\u8fd9\u4e24\u79cd\u65e5\u5fd7\u6709\u4ee5\u4e0b\u4e09\u70b9\u4e0d\u540c\u3002:</p> <ul> <li>redo log \u662f InnoDB \u5f15\u64ce\u7279\u6709\u7684\uff1bbinlog \u662f MySQL \u7684 Server \u5c42\u5b9e\u73b0\u7684\uff0c\u6240\u6709\u5f15\u64ce\u90fd\u53ef\u4ee5\u4f7f\u7528\u3002</li> <li><code>redo log</code> \u662f\u7269\u7406\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u201c\u5728\u67d0\u4e2a\u6570\u636e\u9875\u4e0a\u505a\u4e86\u4ec0\u4e48\u4fee\u6539\u201d\uff1bbinlog \u662f\u903b\u8f91\u65e5\u5fd7\uff0c\u8bb0\u5f55\u7684\u662f\u8fd9\u4e2a\u8bed\u53e5\u7684\u539f\u59cb\u903b\u8f91\uff0c\u6bd4\u5982\u201c\u7ed9 ID=2 \u8fd9\u4e00\u884c\u7684 c \u5b57\u6bb5\u52a0 1 \u201d\u3002</li> <li>redo log \u662f\u5faa\u73af\u5199\u7684\uff0c\u7a7a\u95f4\u56fa\u5b9a\u4f1a\u7528\u5b8c\uff1bbinlog \u662f\u53ef\u4ee5\u8ffd\u52a0\u5199\u5165\u7684\u3002\u201c\u8ffd\u52a0\u5199\u201d\u662f\u6307 binlog \u6587\u4ef6\u5199\u5230\u4e00\u5b9a\u5927\u5c0f\u540e\u4f1a\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\uff0c\u5e76\u4e0d\u4f1a\u8986\u76d6\u4ee5\u524d\u7684\u65e5\u5fd7\u3002</li> </ul>"},{"location":"chap1/mysql_bia_review/#2-4","title":"2-4 \u4e24\u9636\u6bb5\u63d0\u4ea4","text":"<p>\u4e3a\u4ec0\u4e48\u5fc5\u987b\u6709\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\u5462\uff1f\u8fd9\u662f\u4e3a\u4e86\u8ba9\u4e24\u4efd\u65e5\u5fd7\u4e4b\u95f4\u7684\u903b\u8f91\u4e00\u81f4</p> <p>\u5982\u679c\u4e0d\u4f7f\u7528\u201c\u4e24\u9636\u6bb5\u63d0\u4ea4\u201d\uff0c\u90a3\u4e48\u6570\u636e\u5e93\u7684\u72b6\u6001\u5c31\u6709\u53ef\u80fd\u548c\u7528\u5b83\u7684\u65e5\u5fd7\u6062\u590d\u51fa\u6765\u7684\u5e93\u7684\u72b6\u6001\u4e0d\u4e00\u81f4\u3002</p> <p>\u672c\u8d28\u4e0a\u662f\u56e0\u4e3a redo log \u8d1f\u8d23\u4e8b\u52a1\uff1b binlog\u8d1f\u8d23\u5f52\u6863\u6062\u590d\uff1b \u5404\u53f8\u5176\u804c\uff0c\u76f8\u4e92\u914d\u5408\uff0c\u624d\u63d0\u4f9b(\u4fdd\u8bc1)\u4e86\u73b0\u6709\u529f\u80fd\u7684\u5b8c\u6574\u6027\uff1b</p> <p>redolog\u548cbinlog\u5177\u6709\u5173\u8054\u884c\uff0c\u5728\u6062\u590d\u6570\u636e\u65f6\uff0credolog\u7528\u4e8e\u6062\u590d\u4e3b\u673a\u6545\u969c\u65f6\u7684\u672a\u66f4\u65b0\u7684\u7269\u7406\u6570\u636e\uff0cbinlog\u7528\u4e8e\u5907\u4efd\u64cd\u4f5c\u3002</p> <p>\u6bcf\u4e2a\u9636\u6bb5\u7684log\u64cd\u4f5c\u90fd\u662f\u8bb0\u5f55\u5728\u78c1\u76d8\u7684\uff0c\u5728\u6062\u590d\u6570\u636e\u65f6\uff0credolog \u72b6\u6001\u4e3acommit\u5219\u8bf4\u660ebinlog\u4e5f\u6210\u529f\uff0c\u76f4\u63a5\u6062\u590d\u6570\u636e\uff1b</p>"},{"location":"chap1/mysql_bia_review/#2-5-redo-log-crash-safe","title":"2-5 redo log \u7528\u4e8e\u4fdd\u8bc1 crash-safe \u80fd\u529b\u3002","text":"<ul> <li>Redo log \u8bb0\u5f55\u8fd9\u4e2a\u9875 \u201c\u505a\u4e86\u4ec0\u4e48\u6539\u52a8\u201d\u3002 redo log\u8bb0\u5f55\u7684\u662f\u5f53\u65f6\u7684\u6570\u636e\u662f\u600e\u4e48\u53d8\u5316\u7684\uff0c\u6bd4\u5982\u5907\u4efd\u7684\u65f6\u5019\u8bb0\u5f55table\u8868\u4e2d\u5b57\u6bb5a\u7684\u503c\u662f1\u21923\uff08\u75311\u53d8\u62103\uff09</li> <li>Binlog\u6709\u4e24\u79cd\u6a21\u5f0f\uff0cstatement \u683c\u5f0f\u7684\u8bdd\u662f\u8bb0sql\u8bed\u53e5 <ul> <li>row\u683c\u5f0f\u4f1a\u8bb0\u5f55\u884c\u7684\u5185\u5bb9\uff0c\u8bb0\u4e24\u6761\uff0c\u66f4\u65b0\u524d\u548c\u66f4\u65b0\u540e\u90fd\u6709\u3002</li> <li>binlog\u91cc\u9762\u8bb0\u5f55\u53ef\u80fd\u5c31\u662f\u591a\u6761SQL\u6267\u884c\u4e4b\u540ea\u7684\u503c\u624d\u7b49\u4e8e3\uff0c\u6bd4\u5982<code>update table set a =1 where ID=1\uff1b</code> ,<code>update table set a=3 where ID=1\uff1b</code>\u6216\u8005\u6267\u884c\u8fc7\u66f4\u591aSQL\u624d\u53d8\u62103\u3002</li> </ul> </li> </ul>"},{"location":"chap1/mysql_bia_review/#3","title":"3 \u4e8b\u52a1\u9694\u79bb","text":""},{"location":"chap1/mysql_bia_review/#3-1","title":"3-1 \u9694\u79bb\u6027","text":"<p>\u5f53\u6570\u636e\u5e93\u4e0a\u6709\u591a\u4e2a\u4e8b\u52a1\u540c\u65f6\u6267\u884c\u7684\u65f6\u5019\uff0c\u5c31\u53ef\u80fd\u51fa\u73b0\u810f\u8bfb\uff08dirty read\uff09\u3001\u4e0d\u53ef\u91cd\u590d\u8bfb\uff08non-repeatable read\uff09\u3001\u5e7b\u8bfb\uff08phantom read\uff09\u7684\u95ee\u9898\uff0c\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u5c31\u6709\u4e86\u201c\u9694\u79bb\u7ea7\u522b\u201d\u7684\u6982\u5ff5\u3002</p> <ul> <li>\u810f\u8bfb: \u8bfb\u5230\u5176\u4ed6\u4e8b\u52a1\u672a\u63d0\u4ea4\u7684\u6570\u636e\uff1b</li> <li>\u4e0d\u53ef\u91cd\u590d\u8bfb\uff1a\u524d\u540e\u8bfb\u53d6\u7684\u8bb0\u5f55\u5185\u5bb9\u4e0d\u4e00\u81f4\uff1b</li> <li>\u5e7b\u8bfb\uff1a\u524d\u540e\u8bfb\u53d6\u7684\u8bb0\u5f55\u6570\u91cf\u4e0d\u4e00\u81f4\u3002</li> </ul>"},{"location":"chap1/mysql_bia_review/#3-2","title":"3-2 \u9694\u79bb\u7ea7\u522b","text":"<p>\u9694\u79bb\u5f97\u8d8a\u4e25\u5b9e\uff0c\u6548\u7387\u5c31\u4f1a\u8d8a\u4f4e\u3002\u56e0\u6b64\u5f88\u591a\u65f6\u5019\uff0c\u6211\u4eec\u90fd\u8981\u5728\u4e8c\u8005\u4e4b\u95f4\u5bfb\u627e\u4e00\u4e2a\u5e73\u8861\u70b9\u3002</p> <p>SQL \u6807\u51c6\u7684\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u5305\u62ec\uff1a\u8bfb\u672a\u63d0\u4ea4\uff08read uncommitted\uff09\u3001\u8bfb\u63d0\u4ea4\uff08read committed\uff09\u3001\u53ef\u91cd\u590d\u8bfb\uff08repeatable read\uff09\u548c\u4e32\u884c\u5316\uff08serializable \uff09\u3002\u4e0b\u9762\u6211\u9010\u4e00\u4e3a\u4f60\u89e3\u91ca\uff1a</p> <ul> <li>\u8bfb\u672a\u63d0\u4ea4\u662f\u6307\uff0c\u4e00\u4e2a\u4e8b\u52a1\u8fd8\u6ca1\u63d0\u4ea4\u65f6\uff0c\u5b83\u505a\u7684\u53d8\u66f4\u5c31\u80fd\u88ab\u522b\u7684\u4e8b\u52a1\u770b\u5230\u3002</li> <li>\u8bfb\u63d0\u4ea4\u662f\u6307\uff0c\u4e00\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u540e\uff0c\u5b83\u505a\u7684\u53d8\u66f4\u624d\u4f1a\u88ab\u5176\u4ed6\u4e8b\u52a1\u770b\u5230\u3002</li> <li>\u53ef\u91cd\u590d\u8bfb\u662f\u6307\uff0c\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u8fc7\u7a0b\u4e2d\u770b\u5230\u7684\u6570\u636e\uff0c\u603b\u662f\u8ddf\u8fd9\u4e2a\u4e8b\u52a1\u5728\u542f\u52a8\u65f6\u770b\u5230\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\u3002\u5f53\u7136\u5728\u53ef\u91cd\u590d\u8bfb\u9694\u79bb\u7ea7\u522b\u4e0b\uff0c\u672a\u63d0\u4ea4\u53d8\u66f4\u5bf9\u5176\u4ed6\u4e8b\u52a1\u4e5f\u662f\u4e0d\u53ef\u89c1\u7684\u3002</li> <li>\u4e32\u884c\u5316\uff0c\u987e\u540d\u601d\u4e49\u662f\u5bf9\u4e8e\u540c\u4e00\u884c\u8bb0\u5f55\uff0c\u201c\u5199\u201d\u4f1a\u52a0\u201c\u5199\u9501\u201d\uff0c\u201c\u8bfb\u201d\u4f1a\u52a0\u201c\u8bfb\u9501\u201d\u3002\u5f53\u51fa\u73b0\u8bfb\u5199\u9501\u51b2\u7a81\u7684\u65f6\u5019\uff0c\u540e\u8bbf\u95ee\u7684\u4e8b\u52a1\u5fc5\u987b\u7b49\u524d\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u5b8c\u6210\uff0c\u624d\u80fd\u7ee7\u7eed\u6267\u884c\u3002</li> </ul> <p>\u542f\u52a8\u53c2\u6570\uff1a <code>show variables like 'transaction_isolation';</code></p> <ul> <li>\u56de\u6eda\u65e5\u5fd7\u7684\u5220\u9664 undo log</li> </ul> <p>\u4ec0\u4e48\u65f6\u5019\u5220\u9664\u5462\uff1f\u7b54\u6848\u662f\uff0c\u5728\u4e0d\u9700\u8981\u7684\u65f6\u5019\u624d\u5220\u9664\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u7cfb\u7edf\u4f1a\u5224\u65ad\uff0c\u5f53\u6ca1\u6709\u4e8b\u52a1\u518d\u9700\u8981\u7528\u5230\u8fd9\u4e9b\u56de\u6eda\u65e5\u5fd7\u65f6\uff0c\u56de\u6eda\u65e5\u5fd7\u4f1a\u88ab\u5220\u9664</p> <ul> <li>\u5c3d\u91cf\u4e0d\u8981\u4f7f\u7528\u957f\u4e8b\u52a1</li> <li><code>set autocommit=1\uff08\u63a8\u8350\uff09</code>  \u8868\u793aMySQL\u81ea\u52a8\u5f00\u542f\u548c\u63d0\u4ea4\u4e8b\u52a1\u3002</li> </ul>"},{"location":"chap1/mysql_bia_review/#4","title":"4  \u6df1\u5165\u6d45\u51fa\u7d22\u5f15","text":"<p>\u7d22\u5f15\u7684\u51fa\u73b0\u5176\u5b9e\u5c31\u662f\u4e3a\u4e86\u63d0\u9ad8\u6570\u636e\u67e5\u8be2\u7684\u6548\u7387</p> <p>\u4e09\u79cd\u5e38\u89c1\u3001\u4e5f\u6bd4\u8f83\u7b80\u5355\u7684\u6570\u636e\u7ed3\u6784\uff0c\u5b83\u4eec\u5206\u522b\u662f\u54c8\u5e0c\u8868\u3001\u6709\u5e8f\u6570\u7ec4\u548c\u641c\u7d22\u6811\u3002</p> <p>\u6bcf\u4e00\u4e2a\u7d22\u5f15\u5728 InnoDB \u91cc\u9762\u5bf9\u5e94\u4e00\u68f5 B+ \u6811\u3002</p>"},{"location":"chap1/mysql_bia_review/#4-1","title":"4-1 \u805a\u96c6\u7d22\u5f15\u548c\u8f85\u52a9\u7d22\u5f15","text":"<p>\u6570\u636e\u5e93\u4e2d\u7684 <code>B+</code> \u6811\u7d22\u5f15\u53ef\u4ee5\u5206\u4e3a\u805a\u96c6\u7d22\u5f15\uff08<code>clustered index</code>\uff09\u548c\u8f85\u52a9\u7d22\u5f15\uff08<code>secondary index</code>\uff09\uff0c\u5b83\u4eec\u4e4b\u95f4\u7684\u6700\u5927\u533a\u522b\u5c31\u662f: </p> <ul> <li>\u805a\u96c6\u7d22\u5f15\u4e2d\u5b58\u653e\u7740\u4e00\u6761\u884c\u8bb0\u5f55\u7684\u5168\u90e8\u4fe1\u606f</li> <li>\u8f85\u52a9\u7d22\u5f15\u4e2d\u53ea\u5305\u542b\u7d22\u5f15\u5217\u548c\u4e00\u4e2a\u7528\u4e8e\u67e5\u627e\u5bf9\u5e94\u884c\u8bb0\u5f55\u7684\u300e\u4e66\u7b7e\u300f</li> </ul>"},{"location":"chap1/mysql_bia_review/#5","title":"5 \u9501","text":"<p>\u6211\u4eec\u90fd\u77e5\u9053\u9501\u7684\u79cd\u7c7b\u4e00\u822c\u5206\u4e3a\u4e50\u89c2\u9501\u548c\u60b2\u89c2\u9501\u4e24\u79cd\uff0cInnoDB \u5b58\u50a8\u5f15\u64ce\u4e2d\u4f7f\u7528\u7684\u5c31\u662f\u60b2\u89c2\u9501\uff0c\u800c\u6309\u7167\u9501\u7684\u7c92\u5ea6\u5212\u5206\uff0c\u4e5f\u53ef\u4ee5\u5206\u6210\u884c\u9501\u548c\u8868\u9501\u3002</p>"},{"location":"chap1/mysql_bia_review/#5-1","title":"5-1 \u4e50\u89c2\u9501","text":"<p>\u4e50\u89c2\u9501\u662f\u4e00\u79cd\u601d\u60f3\uff0c\u5b83\u5176\u5b9e\u5e76\u4e0d\u662f\u4e00\u79cd\u771f\u6b63\u7684\u300e\u9501\u300f\uff0c\u5b83\u4f1a\u5148\u5c1d\u8bd5\u5bf9\u8d44\u6e90\u8fdb\u884c\u4fee\u6539\uff0c\u5728\u5199\u56de\u65f6\u5224\u65ad\u8d44\u6e90\u662f\u5426\u8fdb\u884c\u4e86\u6539\u53d8\uff0c\u5982\u679c\u6ca1\u6709\u53d1\u751f\u6539\u53d8\u5c31\u4f1a\u5199\u56de\uff0c\u5426\u5219\u5c31\u4f1a\u8fdb\u884c\u91cd\u8bd5\uff0c\u5728\u6574\u4e2a\u7684\u6267\u884c\u8fc7\u7a0b\u4e2d\u5176\u5b9e\u90fd\u6ca1\u6709\u5bf9\u6570\u636e\u5e93\u8fdb\u884c\u52a0\u9501</p>"},{"location":"chap1/mysql_bia_review/#5-2","title":"5-2 \u60b2\u89c2\u9501","text":"<p>\u60b2\u89c2\u9501\u5c31\u662f\u4e00\u79cd\u771f\u6b63\u7684\u9501\u4e86\uff0c\u5b83\u4f1a\u5728\u83b7\u53d6\u8d44\u6e90\u524d\u5bf9\u8d44\u6e90\u8fdb\u884c\u52a0\u9501\uff0c\u786e\u4fdd\u540c\u4e00\u65f6\u523b\u53ea\u6709\u6709\u9650\u7684\u7ebf\u7a0b\u80fd\u591f\u8bbf\u95ee\u8be5\u8d44\u6e90\uff0c\u5176\u4ed6\u60f3\u8981\u5c1d\u8bd5\u83b7\u53d6\u8d44\u6e90\u7684\u64cd\u4f5c\u90fd\u4f1a\u8fdb\u5165\u7b49\u5f85\u72b6\u6001\uff0c\u76f4\u5230\u8be5\u7ebf\u7a0b\u5b8c\u6210\u4e86\u5bf9\u8d44\u6e90\u7684\u64cd\u4f5c\u5e76\u4e14\u91ca\u653e\u4e86\u9501\u540e\uff0c\u5176\u4ed6\u7ebf\u7a0b\u624d\u80fd\u91cd\u65b0\u64cd\u4f5c\u8d44\u6e90\uff1b</p>"},{"location":"chap1/mysql_bia_review/#6-primary-keys","title":"6 Primary keys","text":"<p>Primary keys must contain unique values.</p> <p>A primary key column cannot have NULL values.</p> <p>A table can have only one primary key, which may consist of single or multiple fields.</p> <p>When multiple fields are used as a primary key, they are called a composite key.</p>"},{"location":"chap1/mysql_bia_review/#7","title":"7 \u540c\u6b65","text":""},{"location":"chap1/mysql_bia_review/#mysql_1","title":"\u5982\u4f55\u5224\u65admysql\u4e3b\u4ece\u662f\u5426\u540c\u6b65\uff1f\u8be5\u5982\u4f55\u4f7f\u5176\u540c\u6b65\uff1f","text":"<pre><code>Slave_IO_Running\nSlave_SQL_Running\uff1b\n</code></pre>"},{"location":"chap1/mysql_bia_review/#2mysqlinnodbmysql","title":"2.mysql\u7684innodb\u5982\u4f55\u5b9a\u4f4d\u9501\u95ee\u9898\uff0cmysql\u5982\u4f55\u51cf\u5c11\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\uff1f","text":"<p>\u5728\u4f7f\u7528 <code>show engine innodb status</code> \u68c0\u67e5\u5f15\u64ce\u72b6\u6001\u65f6\uff0c\u53d1\u73b0\u4e86\u6b7b\u9501\u95ee\u9898</p>"},{"location":"chap1/mysql_bia_review/#mysql_2","title":"mysql\u5982\u4f55\u51cf\u5c11\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf:","text":"<ul> <li>\u4ece\u5e93\u786c\u4ef6\u6bd4\u4e3b\u5e93\u5dee\uff0c\u5bfc\u81f4\u590d\u5236\u5ef6\u8fdf</li> <li>\u4e3b\u4ece\u590d\u5236\u5355\u7ebf\u7a0b\uff0c\u5982\u679c\u4e3b\u5e93\u5199\u5e76\u53d1\u592a\u5927\uff0c\u6765\u4e0d\u53ca\u4f20\u9001\u5230\u4ece\u5e93\uff0c\u5c31\u4f1a\u5bfc\u81f4\u5ef6\u8fdf\u3002\u66f4\u9ad8\u7248\u672c\u7684mysql\u53ef\u4ee5\u652f\u6301\u591a\u7ebf\u7a0b\u590d\u5236</li> <li>\u6162SQL\u8bed\u53e5\u8fc7\u591a</li> <li>\u7f51\u7edc\u5ef6\u8fdf</li> <li>master\u8d1f\u8f7d: \u4e3b\u5e93\u8bfb\u5199\u538b\u529b\u5927\uff0c\u5bfc\u81f4\u590d\u5236\u5ef6\u8fdf\uff0c\u67b6\u6784\u7684\u524d\u7aef\u8981\u52a0buffer\u53ca\u7f13\u5b58\u5c42</li> </ul> <p>\u53e6\u5916\uff0c 2\u4e2a\u53ef\u4ee5\u51cf\u5c11\u5ef6\u8fdf\u7684\u53c2\u6570:</p> <p><code>-slave-net-timeout=seconds</code> \u5355\u4f4d\u4e3a\u79d2 \u9ed8\u8ba4\u8bbe\u7f6e\u4e3a 3600\u79d2</p> <p>\u53c2\u6570\u542b\u4e49\uff1a\u5f53slave\u4ece\u4e3b\u6570\u636e\u5e93\u8bfb\u53d6log\u6570\u636e\u5931\u8d25\u540e\uff0c\u7b49\u5f85\u591a\u4e45\u91cd\u65b0\u5efa\u7acb\u8fde\u63a5\u5e76\u83b7\u53d6\u6570\u636e</p> <p><code>-master-connect-retry=seconds</code> \u5355\u4f4d\u4e3a\u79d2 \u9ed8\u8ba4\u8bbe\u7f6e\u4e3a 60\u79d2</p> <p>\u53c2\u6570\u542b\u4e49\uff1a\u5f53\u91cd\u65b0\u5efa\u7acb\u4e3b\u4ece\u8fde\u63a5\u65f6\uff0c\u5982\u679c\u8fde\u63a5\u5efa\u7acb\u5931\u8d25\uff0c\u95f4\u9694\u591a\u4e45\u540e\u91cd\u8bd5\u3002</p> <p>MySQL\u6570\u636e\u5e93\u4e3b\u4ece\u540c\u6b65\u5ef6\u8fdf\u89e3\u51b3\u65b9\u6848</p> <p>\u6700\u7b80\u5355\u7684\u51cf\u5c11slave\u540c\u6b65\u5ef6\u65f6\u7684\u65b9\u6848\u5c31\u662f\u5728\u67b6\u6784\u4e0a\u505a\u4f18\u5316\uff0c\u5c3d\u91cf\u8ba9\u4e3b\u5e93\u7684DDL\u5feb\u901f\u6267\u884c\u3002\u8fd8\u6709\u5c31\u662f\u4e3b\u5e93\u662f\u5199\uff0c\u5bf9\u6570\u636e\u5b89\u5168\u6027\u8f83\u9ad8\uff0c\u6bd4\u5982 <code>sync_binlog=1</code>\uff0c</p>"},{"location":"chap1/mysql_bia_review/#mysql_3","title":"mysql\u6570\u636e\u5907\u4efd\u5de5\u5177","text":"<ul> <li>mysqldump\u5de5\u5177</li> <li>\u57fa\u4e8eLVM\u5feb\u7167\u5907\u4efd</li> <li>tar\u5305\u5907\u4efd</li> <li>percona\u63d0\u4f9b\u7684xtrabackup\u5de5\u5177</li> </ul>"},{"location":"chap1/mysql_bia_review/#8-nosql","title":"8 NoSQL\u548c\u5173\u7cfb\u6570\u636e\u5e93\u7684\u533a\u522b\uff1f","text":""},{"location":"chap1/mysql_bia_review/#8-1","title":"8-1 \u8868\u7ed3\u6784","text":"<ul> <li>SQL\u6570\u636e\u5b58\u5728\u7279\u5b9a\u7ed3\u6784\u7684\u8868\u4e2d\uff1b<ul> <li>\u5728SQL\u4e2d\uff0c\u5fc5\u987b\u5b9a\u4e49\u597d\u8868\u548c\u5b57\u6bb5\u7ed3\u6784\u540e\u624d\u80fd\u6dfb\u52a0\u6570\u636e\uff0c\u4f8b\u5982\u5b9a\u4e49\u8868\u7684\u4e3b\u952e(primary key)\uff0c\u7d22\u5f15(index),\u89e6\u53d1\u5668(trigger),\u5b58\u50a8\u8fc7\u7a0b(stored procedure)\u7b49\u3002</li> <li>\u8868\u7ed3\u6784\u53ef\u4ee5\u5728\u88ab\u5b9a\u4e49\u4e4b\u540e\u66f4\u65b0\uff0c\u4f46\u662f\u5982\u679c\u6709\u6bd4\u8f83\u5927\u7684\u7ed3\u6784\u53d8\u66f4\u7684\u8bdd\u5c31\u4f1a\u53d8\u5f97\u6bd4\u8f83\u590d\u6742</li> </ul> </li> <li>\u800cNoSQL\u5219\u66f4\u52a0\u7075\u6d3b\u548c\u53ef\u6269\u5c55\uff0c\u5b58\u50a8\u65b9\u5f0f\u53ef\u4ee5\u7701\u662fJSON\u6587\u6863\u3001\u54c8\u5e0c\u8868\u6216\u8005\u5176\u4ed6\u65b9\u5f0f\u3002<ul> <li>\u5728NoSQL\u4e2d\uff0c\u6570\u636e\u53ef\u4ee5\u5728\u4efb\u4f55\u65f6\u5019\u4efb\u4f55\u5730\u65b9\u6dfb\u52a0\uff0c\u4e0d\u9700\u8981\u5148\u5b9a\u4e49\u8868\u3002</li> </ul> </li> </ul>"},{"location":"chap1/mysql_bia_review/#8-2","title":"8-2 \u5916\u90e8\u5173\u8054\u6570\u636e","text":"<ul> <li>SQL\u4e2d\u5982\u679c\u9700\u8981\u589e\u52a0\u5916\u90e8\u5173\u8054\u6570\u636e\u7684\u8bdd\uff0c\u89c4\u8303\u5316\u505a\u6cd5\u662f\u5728\u539f\u8868\u4e2d\u589e\u52a0\u4e00\u4e2a\u5916\u952e\uff0c\u5173\u8054\u5916\u90e8\u6570\u636e\u8868\u3002</li> </ul> <p>NoSQL:</p> <ul> <li>\u800c\u5728NoSQL\u4e2d\u9664\u4e86\u8fd9\u79cd\u89c4\u8303\u5316\u7684\u5916\u90e8\u6570\u636e\u8868\u505a\u6cd5\u4ee5\u5916\uff0c</li> <li>\u6211\u4eec\u8fd8\u80fd\u7528\u5982\u4e0b\u7684\u975e\u89c4\u8303\u5316\u65b9\u5f0f\u628a\u5916\u90e8\u6570\u636e\u76f4\u63a5\u653e\u5230\u539f\u6570\u636e\u96c6\u4e2d\uff0c\u4ee5\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\u3002\u7f3a\u70b9\u4e5f\u6bd4\u8f83\u660e\u663e\uff0c\u66f4\u65b0\u5ba1\u6838\u4eba\u6570\u636e\u7684\u65f6\u5019\u5c06\u4f1a\u6bd4\u8f83\u9ebb\u70e6\u3002</li> </ul>"},{"location":"chap1/mysql_bia_review/#8-3-join","title":"8-3 JOIN","text":"<ul> <li>SQL\u4e2d\u53ef\u4ee5\u4f7f\u7528JOIN\u8868\u94fe\u63a5\u65b9\u5f0f\u5c06\u591a\u4e2a\u5173\u7cfb\u6570\u636e\u8868\u4e2d\u7684\u6570\u636e\u7528\u4e00\u6761\u7b80\u5355\u7684\u67e5\u8be2\u8bed\u53e5\u67e5\u8be2\u51fa\u6765</li> <li>NoSQL\u6682\u672a\u63d0\u4f9b\u7c7b\u4f3cJOIN\u7684\u67e5\u8be2\u65b9\u5f0f\u5bf9\u591a\u4e2a\u6570\u636e\u96c6\u4e2d\u7684\u6570\u636e\u505a\u67e5\u8be2\u3002\u6240\u4ee5\u5927\u90e8\u5206NoSQL\u4f7f\u7528\u975e\u89c4\u8303\u5316\u7684\u6570\u636e\u5b58\u50a8\u65b9\u5f0f\u5b58\u50a8\u6570\u636e\u3002</li> </ul>"},{"location":"chap1/mysql_bia_review/#8-4","title":"8-4 \u5220\u9664\u5916\u90e8\u6570\u636e","text":"<ul> <li>SQL\u4e2d\u4e0d\u5141\u8bb8\u5220\u9664\u5df2\u7ecf\u88ab\u4f7f\u7528\u7684\u5916\u90e8\u6570\u636e\uff0c</li> <li>\u800cNoSQL\u4e2d\u5219\u6ca1\u6709\u8fd9\u79cd\u5f3a\u8026\u5408\u7684\u6982\u5ff5\uff0c\u53ef\u4ee5\u968f\u65f6\u5220\u9664\u4efb\u4f55\u6570\u636e\u3002</li> </ul> <p>SQL\u4e2d\u5982\u679c\u591a\u5f20\u8868\u6570\u636e\u9700\u8981\u540c\u6279\u6b21\u88ab\u66f4\u65b0\uff0c\u5373\u5982\u679c\u5176\u4e2d\u4e00\u5f20\u8868\u66f4\u65b0\u5931\u8d25\u7684\u8bdd\u5176\u4ed6\u8868\u4e5f\u4e0d\u80fd\u66f4\u65b0\u6210\u529f\u3002\u8fd9\u79cd\u573a\u666f\u53ef\u4ee5\u901a\u8fc7\u4e8b\u52a1\u6765\u63a7\u5236\uff0c\u53ef\u4ee5\u5728\u6240\u6709\u547d\u4ee4\u5b8c\u6210\u540e\u518d\u7edf\u4e00\u63d0\u4ea4\u4e8b\u52a1\u3002\u800cNoSQL\u4e2d\u6ca1\u6709\u4e8b\u52a1\u8fd9\u4e2a\u6982\u5ff5\uff0c\u6bcf\u4e00\u4e2a\u6570\u636e\u96c6\u7684\u64cd\u4f5c\u90fd\u662f\u539f\u5b50\u7ea7\u7684\u3002</p> <p>\u5728\u76f8\u540c\u6c34\u5e73\u7684\u7cfb\u7edf\u8bbe\u8ba1\u7684\u524d\u63d0\u4e0b\uff0c\u56e0\u4e3aNoSQL\u4e2d\u7701\u7565\u4e86JOIN\u67e5\u8be2\u7684\u6d88\u8017\uff0c\u6545\u7406\u8bba\u4e0a\u6027\u80fd\u4e0a\u662f\u4f18\u4e8eSQL\u7684\u3002</p>"},{"location":"chap1/mysql_bia_review/#9","title":"9 \u5982\u4f55\u5bf9\u67e5\u8be2\u547d\u4ee4\u8fdb\u884c\u4f18\u5316\uff1f","text":"<ul> <li>\u5e94\u5c3d\u91cf\u907f\u514d\u5168\u8868\u626b\u63cf\uff0c\u9996\u5148\u5e94\u8003\u8651\u5728 where \u53ca order by \u6d89\u53ca\u7684\u5217\u4e0a\u5efa\u7acb\u7d22\u3002</li> <li>\u5e94\u5c3d\u91cf\u907f\u514d\u5728 where \u5b50\u53e5\u4e2d\u5bf9\u5b57\u6bb5\u8fdb\u884c null \u503c\u5224\u65ad\uff0c\u907f\u514d\u4f7f\u7528<code>!=</code>\u6216<code>&lt;&gt;</code>\u64cd\u4f5c\u7b26\uff0c\u907f\u514d\u4f7f\u7528 or \u8fde\u63a5\u6761\u4ef6\uff0c\u6216\u5728where\u5b50\u53e5\u4e2d\u4f7f\u7528\u53c2\u6570\u3001\u5bf9\u5b57\u6bb5\u8fdb\u884c\u8868\u8fbe\u5f0f\u6216\u51fd\u6570\u64cd\u4f5c\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u6743\u6807\u626b\u63cf</li> <li>\u5e94\u4e0d\u8981\u5728 where \u5b50\u53e5\u4e2d\u7684\u201c=\u201d\u5de6\u8fb9\u8fdb\u884c\u51fd\u6570\u3001\u7b97\u672f\u8fd0\u7b97\u6216\u5176\u4ed6\u8868\u8fbe\u5f0f\u8fd0\u7b97\uff0c\u5426\u5219\u7cfb\u7edf\u5c06\u53ef\u80fd\u65e0\u6cd5\u6b63\u786e\u4f7f\u7528\u7d22\u5f15</li> <li>\u4f7f\u7528\u7d22\u5f15\u5b57\u6bb5\u4f5c\u4e3a\u6761\u4ef6\u65f6\uff0c\u5982\u679c\u8be5\u7d22\u5f15\u662f\u590d\u5408\u7d22\u5f15\uff0c\u90a3\u4e48\u5fc5\u987b\u4f7f\u7528\u5230\u8be5\u7d22\u5f15\u4e2d\u7684\u7b2c\u4e00\u4e2a\u5b57\u6bb5\u4f5c\u4e3a\u6761\u4ef6\u65f6\u624d\u80fd\u4fdd\u8bc1\u7cfb\u7edf\u4f7f\u7528\u8be5\u7d22\u5f15\uff0c\u5426\u5219\u8be5\u7d22\u5f15\u5c06\u4e0d\u4f1a\u88ab\u4f7f\u7528\u3002</li> <li>\u5f88\u591a\u65f6\u5019\u53ef\u8003\u8651\u7528 exists \u4ee3\u66ff in</li> <li>\u5c3d\u91cf\u4f7f\u7528\u6570\u5b57\u578b\u5b57\u6bb5</li> <li>\u5c3d\u53ef\u80fd\u7684\u4f7f\u7528 <code>varchar/nvarchar</code> \u4ee3\u66ff <code>char/nchar</code></li> <li>\u4efb\u4f55\u5730\u65b9\u90fd\u4e0d\u8981\u4f7f\u7528 <code>select * from t</code> \uff0c\u7528\u5177\u4f53\u7684\u5b57\u6bb5\u5217\u8868\u4ee3\u66ff\u201c*\u201d\uff0c\u4e0d\u8981\u8fd4\u56de\u7528\u4e0d\u5230\u7684\u4efb\u4f55\u5b57\u6bb5\u3002</li> <li>\u5c3d\u91cf\u4f7f\u7528\u8868\u53d8\u91cf\u6765\u4ee3\u66ff\u4e34\u65f6\u8868\u3002</li> <li>\u907f\u514d\u9891\u7e41\u521b\u5efa\u548c\u5220\u9664\u4e34\u65f6\u8868\uff0c\u4ee5\u51cf\u5c11\u7cfb\u7edf\u8868\u8d44\u6e90\u7684\u6d88\u8017</li> <li>\u5c3d\u91cf\u907f\u514d\u4f7f\u7528\u6e38\u6807\uff0c\u56e0\u4e3a\u6e38\u6807\u7684\u6548\u7387\u8f83\u5dee\u3002</li> <li>\u5728\u6240\u6709\u7684\u5b58\u50a8\u8fc7\u7a0b\u548c\u89e6\u53d1\u5668\u7684\u5f00\u59cb\u5904\u8bbe\u7f6e \u00b7SET NOCOUNT ON\u00b7\uff0c\u5728\u7ed3\u675f\u65f6\u8bbe\u7f6e SET NOCOUNT OFF</li> <li>\u5c3d\u91cf\u907f\u514d\u5927\u4e8b\u52a1\u64cd\u4f5c\uff0c\u63d0\u9ad8\u7cfb\u7edf\u5e76\u53d1\u80fd\u529b\u3002</li> <li>.\u5c3d\u91cf\u907f\u514d\u5411\u5ba2\u6237\u7aef\u8fd4\u56de\u5927\u6570\u636e\u91cf\uff0c\u82e5\u6570\u636e\u91cf\u8fc7\u5927\uff0c\u5e94\u8be5\u8003\u8651\u76f8\u5e94\u9700\u6c42\u662f\u5426\u5408\u7406\u3002</li> </ul>"},{"location":"chap1/mysql_bia_review/#10-mssql","title":"10 MSSQL\u7684\u6b7b\u9501\u662f\u5982\u4f55\u4ea7\u751f\u7684\uff1f","text":"<p>\u5982\u4e0b\u662f\u6b7b\u9501\u4ea7\u751f\u7684\u56db\u4e2a\u5fc5\u8981\u6761\u4ef6\uff1a</p> <p>\u4e92\u65a5\u6761\u4ef6\uff1a\u6307\u8fdb\u7a0b\u5bf9\u6240\u5206\u914d\u5230\u7684\u8d44\u6e90\u8fdb\u884c\u6392\u5b83\u6027\u4f7f\u7528\uff0c\u5373\u5728\u4e00\u6bb5\u65f6\u95f4\u5185\u67d0\u8d44\u6e90\u53ea\u7531\u4e00\u4e2a\u8fdb\u7a0b\u5360\u7528\u3002\u5982\u679c\u6b64\u65f6\u8fd8\u6709\u5176\u5b83\u8fdb\u7a0b\u8bf7\u6c42\u8d44\u6e90\uff0c\u5219\u8bf7\u6c42\u8005\u53ea\u80fd\u7b49\u5f85\uff0c\u76f4\u81f3\u5360\u6709\u8d44\u6e90\u7684\u8fdb\u7a0b\u7528\u6bd5\u91ca\u653e\u3002</p> <p>\u8bf7\u6c42\u548c\u4fdd\u6301\u6761\u4ef6\uff1a\u6307\u8fdb\u7a0b\u5df2\u7ecf\u4fdd\u6301\u81f3\u5c11\u4e00\u4e2a\u8d44\u6e90\uff0c\u4f46\u53c8\u63d0\u51fa\u4e86\u65b0\u7684\u8d44\u6e90\u8bf7\u6c42\uff0c\u800c\u8be5\u8d44\u6e90\u5df2\u88ab\u5176\u5b83\u8fdb\u7a0b\u5360\u6709\uff0c\u6b64\u65f6\u8bf7\u6c42\u8fdb\u7a0b\u963b\u585e\uff0c\u4f46\u53c8\u5bf9\u81ea\u5df1\u5df2\u83b7\u5f97\u7684\u5176\u5b83\u8d44\u6e90\u4fdd\u6301\u4e0d\u653e\u3002</p> <p>\u4e0d\u5265\u593a\u6761\u4ef6\uff1a\u6307\u8fdb\u7a0b\u5df2\u83b7\u5f97\u7684\u8d44\u6e90\uff0c\u5728\u672a\u4f7f\u7528\u5b8c\u4e4b\u524d\uff0c\u4e0d\u80fd\u88ab\u5265\u593a\uff0c\u53ea\u80fd\u5728\u4f7f\u7528\u5b8c\u65f6\u7531\u81ea\u5df1\u91ca\u653e\u3002</p> <p>\u73af\u8def\u7b49\u5f85\u6761\u4ef6\uff1a\u6307\u5728\u53d1\u751f\u6b7b\u9501\u65f6\uff0c\u5fc5\u7136\u5b58\u5728\u4e00\u4e2a\u8fdb\u7a0b\u2014\u2014\u8d44\u6e90\u7684\u73af\u5f62\u94fe\uff0c\u5373\u8fdb\u7a0b\u96c6\u5408{P0\uff0cP1\uff0cP2\uff0c\u00b7\u00b7\u00b7\uff0cPn}\u4e2d\u7684P0\u6b63\u5728\u7b49\u5f85\u4e00\u4e2aP1\u5360\u7528\u7684\u8d44\u6e90\uff1bP1\u6b63\u5728\u7b49\u5f85P2\u5360\u7528\u7684\u8d44\u6e90\uff0c\u2026\u2026\uff0cPn\u6b63\u5728\u7b49\u5f85\u5df2\u88abP0\u5360\u7528\u7684\u8d44\u6e90\u3002</p>"},{"location":"chap1/mysql_bia_review/#11-what-are-the-advantages-of-nosql-over-traditional-rdbms","title":"11 What are the advantages of NoSQL over traditional RDBMS?","text":"<p>NoSQL is better than RDBMS because of the following reasons/properities of NoSQL:</p> <ul> <li>It supports semi-structured data and volatile data</li> <li>It does not have schema</li> <li>Read/Write throughput is very high</li> <li>Horizontal scalability can be achieved easily</li> <li>Will support Bigdata in volumes of Terra Bytes &amp; Peta Bytes</li> <li>Provides good support for Analytic tools on top of Bigdata</li> <li>Can be hosted in cheaper hardware machines</li> <li>In-memory caching option is available to increase the performance of queries</li> <li>Faster development life cycles for developers</li> </ul> <p>Still, RDBMS is better than NoSQL for the following reasons/properties of RDBMS:</p> <ul> <li>Transactions with ACID properties - Atomicity, Consistency, Isolation &amp; Durability</li> <li>Adherence to Strong Schema of data being written/read</li> <li>Real time query management ( in case of data size &lt; 10 Tera bytes )</li> <li>Execution of complex queries involving join &amp; group by clauses</li> </ul>"},{"location":"chap1/mysql_bia_review/#when-should-i-use-a-nosql-database-instead-of-a-relational-database","title":"When should I use a NoSQL database instead of a relational database?","text":"<p>Relational databases enforces ACID. So, you will have schema based transaction oriented data stores. It's proven and suitable for 99% of the real world applications. You can practically do anything with relational databases.</p> <p>But, there are limitations on speed and scaling when it comes to massive high availability data stores. For example, Google and Amazon have terabytes of data stored in big data centers. Querying and inserting is not performant in these scenarios because of the blocking/schema/transaction nature of the RDBMs. That's the reason they have implemented their own databases (actually, key-value stores) for massive performance gain and scalability.</p> <p>If you need a NoSQL db you usually know about it, possible reasons are:</p> <ul> <li>client wants 99.999% availability on a high traffic site.</li> <li>your data makes no sense in SQL, you find yourself doing multiple JOIN queries for accessing some piece of information.</li> <li>you are breaking the relational model, you have CLOBs that store denormalized data and you generate external indexes to search that data.</li> </ul>"},{"location":"chap2_opt/1table_design/","title":"L1 \u8868\u7ed3\u6784\u8bbe\u8ba1\u7bc7 - \u6570\u636e\u7c7b\u578b","text":""},{"location":"chap2_opt/1table_design/#1","title":"1 \u6570\u5b57\u7c7b\u578b","text":"<p>\u6574\u578b\u7c7b\u578b</p> <p>MySQL \u6570\u636e\u5e93\u652f\u6301 SQL \u6807\u51c6\u652f\u6301\u7684\u6574\u578b\u7c7b\u578b\uff1aINT\u3001SMALLINT\u3002\u6b64\u5916\uff0cMySQL \u6570\u636e\u5e93\u4e5f\u652f\u6301\u8bf8\u5982 TINYINT\u3001MEDIUMINT \u548c BIGINT \u6574\u578b\u7c7b\u578b</p> <p>\u5728\u6574\u578b\u7c7b\u578b\u4e2d\uff0c\u6709 signed \u548c unsigned \u5c5e\u6027\uff0c\u5176\u8868\u793a\u7684\u662f\u6574\u578b\u7684\u53d6\u503c\u8303\u56f4\uff0c\u9ed8\u8ba4\u4e3a signed\u3002\u5728\u8bbe\u8ba1\u65f6\uff0c\u6211\u4e0d\u5efa\u8bae\u4f60\u523b\u610f\u53bb\u7528 unsigned \u5c5e\u6027\uff0c\u56e0\u4e3a\u5728\u505a\u4e00\u4e9b\u6570\u636e\u5206\u6790\u65f6\uff0cSQL \u53ef\u80fd\u8fd4\u56de\u7684\u7ed3\u679c\u5e76\u4e0d\u662f\u60f3\u8981\u5f97\u5230\u7684\u7ed3\u679c\u3002</p> <p>\u6d6e\u70b9\u7c7b\u578b\u548c\u9ad8\u7cbe\u5ea6\u578b</p> <p>MySQL \u4e4b\u524d\u7684\u7248\u672c\u4e2d\u5b58\u5728\u6d6e\u70b9\u7c7b\u578b Float \u548c Double\uff0c\u4f46\u8fd9\u4e9b\u7c7b\u578b\u56e0\u4e3a\u4e0d\u662f\u9ad8\u7cbe\u5ea6\uff0c\u4e5f\u4e0d\u662f SQL \u6807\u51c6\u7684\u7c7b\u578b\uff0c\u6240\u4ee5\u5728\u771f\u5b9e\u7684\u751f\u4ea7\u73af\u5883\u4e2d\u4e0d\u63a8\u8350\u4f7f\u7528\uff0c\u5426\u5219\u5728\u8ba1\u7b97\u65f6\uff0c\u7531\u4e8e\u7cbe\u5ea6\u7c7b\u578b\u95ee\u9898\uff0c\u4f1a\u5bfc\u81f4\u6700\u7ec8\u7684\u8ba1\u7b97\u7ed3\u679c\u51fa\u9519\u3002</p> <p>\u66f4\u91cd\u8981\u7684\u662f\uff0c\u4ece MySQL 8.0.17 \u7248\u672c\u5f00\u59cb\uff0c\u5f53\u521b\u5efa\u8868\u7528\u5230\u7c7b\u578b Float \u6216 Double \u65f6\uff0c\u4f1a\u629b\u51fa\u4e0b\u9762\u7684\u8b66\u544a\uff1aMySQL \u63d0\u9192\u7528\u6237\u4e0d\u8be5\u7528\u4e0a\u8ff0\u6d6e\u70b9\u7c7b\u578b\uff0c\u751a\u81f3\u63d0\u9192\u5c06\u5728\u4e4b\u540e\u7248\u672c\u4e2d\u5e9f\u5f03\u6d6e\u70b9\u7c7b\u578b</p> <pre><code>Specifying number of digits for floating point data types is deprecated and will be removed in a future release\n</code></pre> <p>\u800c\u6570\u5b57\u7c7b\u578b\u4e2d\u7684\u9ad8\u7cbe\u5ea6 DECIMAL \u7c7b\u578b\u53ef\u4ee5\u4f7f\u7528\uff0c\u5f53\u58f0\u660e\u8be5\u7c7b\u578b\u5217\u65f6\uff0c\u53ef\u4ee5\uff08\u5e76\u4e14\u901a\u5e38\u5fc5\u987b\u8981\uff09\u6307\u5b9a\u7cbe\u5ea6\u548c\u6807\u5ea6\uff0c\u4f8b\u5982\uff1a</p> <pre><code>salary DECIMAL(8,2)\n</code></pre> <p>\u5176\u4e2d\uff0c8 \u662f\u7cbe\u5ea6\uff08\u7cbe\u5ea6\u8868\u793a\u4fdd\u5b58\u503c\u7684\u4e3b\u8981\u4f4d\u6570\uff09\uff0c2 \u662f\u6807\u5ea6\uff08\u6807\u5ea6\u8868\u793a\u5c0f\u6570\u70b9\u540e\u9762\u4fdd\u5b58\u7684\u4f4d\u6570\uff09\u3002\u901a\u5e38\u5728\u8868\u7ed3\u6784\u8bbe\u8ba1\u4e2d\uff0c\u7c7b\u578b DECIMAL \u53ef\u4ee5\u7528\u6765\u8868\u793a\u7528\u6237\u7684\u5de5\u8d44\u3001\u8d26\u6237\u7684\u4f59\u989d\u7b49\u7cbe\u786e\u5230\u5c0f\u6570\u70b9\u540e 2 \u4f4d\u7684\u4e1a\u52a1\u3002</p> <p>\u7136\u800c\uff0c\u5728\u6d77\u91cf\u5e76\u53d1\u7684\u4e92\u8054\u7f51\u4e1a\u52a1\u4e2d\u4f7f\u7528\uff0c\u91d1\u989d\u5b57\u6bb5\u7684\u8bbe\u8ba1\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528 DECIMAL \u7c7b\u578b\uff0c\u800c\u66f4\u63a8\u8350\u4f7f\u7528 INT \u6574\u578b\u7c7b\u578b</p>"},{"location":"chap2_opt/1table_design/#1-2","title":"1-2 \u4e1a\u52a1\u8868\u7ed3\u6784\u8bbe\u8ba1\u5b9e\u6218","text":"<p>\u6574\u578b\u7c7b\u578b\u4e0e\u81ea\u589e\u8bbe\u8ba1</p> <p>\u6574\u578b\u7c7b\u578b: \u5728\u4e1a\u52a1\u4e2d\uff0c\u6574\u578b\u7c7b\u578b\u7684\u53e6\u4e00\u4e2a\u5e38\u89c1\u4e14\u91cd\u8981\u7684\u4f7f\u7528\u7528\u6cd5\u662f\u4f5c\u4e3a\u8868\u7684\u4e3b\u952e\uff0c\u5373\u7528\u6765\u552f\u4e00\u6807\u8bc6\u4e00\u884c\u6570\u636e\u3002</p> <p>\u6574\u578b\u7ed3\u5408\u5c5e\u6027 <code>auto_increment</code>\uff0c\u53ef\u4ee5\u5b9e\u73b0\u81ea\u589e\u529f\u80fd\uff0c\u4f46\u5728\u8868\u7ed3\u6784\u8bbe\u8ba1\u65f6\u7528\u81ea\u589e\u505a\u4e3b\u952e\uff0c\u5e0c\u671b\u4f60\u7279\u522b\u8981\u6ce8\u610f\u4ee5\u4e0b\u4e24\u70b9\uff0c\u82e5\u4e0d\u6ce8\u610f\uff0c\u53ef\u80fd\u4f1a\u5bf9\u4e1a\u52a1\u9020\u6210\u707e\u96be\u6027\u7684\u6253\u51fb\uff1a</p> <ul> <li>\u7528 BIGINT \u505a\u4e3b\u952e\uff0c\u800c\u4e0d\u662f INT\uff1b</li> <li>\u81ea\u589e\u503c\u5e76\u4e0d\u6301\u4e45\u5316\uff0c\u53ef\u80fd\u4f1a\u6709\u56de\u6eaf\u73b0\u8c61\uff08MySQL 8.0 \u7248\u672c\u524d\uff09</li> </ul> <p>\u7528\u81ea\u589e\u6574\u578b\u505a\u4e3b\u952e\uff0c\u4e00\u5f8b\u4f7f\u7528 BIGINT\uff0c\u800c\u4e0d\u662f INT\u3002\u4e0d\u8981\u4e3a\u4e86\u8282\u7701 4 \u4e2a\u5b57\u8282\u4f7f\u7528 INT\uff0c\u5f53\u8fbe\u5230\u4e0a\u9650\u65f6\uff0c\u518d\u8fdb\u884c\u8868\u7ed3\u6784\u7684\u53d8\u66f4\uff0c\u5c06\u662f\u5de8\u5927\u7684\u8d1f\u62c5\u4e0e\u75db\u82e6\u3002 <p>\u5f53\u8fbe\u5230 INT \u4e0a\u9650\u540e\uff0c\u518d\u6b21\u8fdb\u884c\u81ea\u589e\u63d2\u5165\u65f6\uff0c\u4f1a\u62a5\u91cd\u590d\u9519\u8bef\uff0cMySQL \u6570\u636e\u5e93\u5e76\u4e0d\u4f1a\u81ea\u52a8\u5c06\u5176\u91cd\u7f6e\u4e3a 1\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u7279\u522b\u8981\u6ce8\u610f\u7684\u95ee\u9898\u662f\uff0c\uff08\u6572\u9ed1\u677f 2\uff09MySQL 8.0 \u7248\u672c\u524d\uff0c\u81ea\u589e\u4e0d\u6301\u4e45\u5316\uff0c\u81ea\u589e\u503c\u53ef\u80fd\u4f1a\u5b58\u5728\u56de\u6eaf\u95ee\u9898\uff01</p> <ul> <li>\u5347\u7ea7 MySQL \u7248\u672c\u5230 8.0 \u7248\u672c\uff0c\u6bcf\u5f20\u8868\u7684\u81ea\u589e\u503c\u4f1a\u6301\u4e45\u5316\uff1b</li> <li>\u82e5\u65e0\u6cd5\u5347\u7ea7\u6570\u636e\u5e93\u7248\u672c\uff0c\u5219\u5f3a\u70c8\u4e0d\u63a8\u8350\u5728\u6838\u5fc3\u4e1a\u52a1\u8868\u4e2d\u4f7f\u7528\u81ea\u589e\u6570\u636e\u7c7b\u578b\u505a\u4e3b\u952e\u3002</li> </ul> <p>\u8d44\u91d1\u5b57\u6bb5\u8bbe\u8ba1</p> <p>\u5728\u7528\u6237\u4f59\u989d\u3001\u57fa\u91d1\u8d26\u6237\u4f59\u989d\u3001\u6570\u5b57\u94b1\u5305\u3001\u96f6\u94b1\u7b49\u7684\u4e1a\u52a1\u8bbe\u8ba1\u4e2d\uff0c\u7531\u4e8e\u5b57\u6bb5\u90fd\u662f\u8d44\u91d1\u5b57\u6bb5\uff0c\u901a\u5e38\u7a0b\u5e8f\u5458\u4e60\u60ef\u4f7f\u7528 DECIMAL \u7c7b\u578b\u4f5c\u4e3a\u5b57\u6bb5\u7684\u9009\u578b\uff0c\u56e0\u4e3a\u8fd9\u6837\u53ef\u4ee5\u7cbe\u786e\u5230\u5206\uff0c\u5982\uff1aDECIMAL(8,2)\u3002</p> <pre><code>CREATE TABLE User (\n\n  userId BIGINT AUTO_INCREMENT,\n\n  money DECIMAL(8,2) NOT NULL,\n\n  ......\n)\n</code></pre> <p>\u5728\u6d77\u91cf\u4e92\u8054\u7f51\u4e1a\u52a1\u7684\u8bbe\u8ba1\u6807\u51c6\u4e2d\uff0c\u5e76\u4e0d\u63a8\u8350\u7528 DECIMAL \u7c7b\u578b\uff0c\u800c\u662f\u66f4\u63a8\u8350\u5c06 DECIMAL \u8f6c\u5316\u4e3a \u6574\u578b\u7c7b\u578b\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u8d44\u91d1\u7c7b\u578b\u66f4\u63a8\u8350\u4f7f\u7528\u7528\u5206\u5355\u4f4d\u5b58\u50a8\uff0c\u800c\u4e0d\u662f\u7528\u5143\u5355\u4f4d\u5b58\u50a8\u3002\u59821\u5143\u5728\u6570\u636e\u5e93\u4e2d\u7528\u6574\u578b\u7c7b\u578b 100 \u5b58\u50a8\u3002</p> <p>\u7c7b\u578b DECIMAL \u662f\u901a\u8fc7\u4e8c\u8fdb\u5236\u5b9e\u73b0\u7684\u4e00\u79cd\u7f16\u7801\u65b9\u5f0f\uff0c\u8ba1\u7b97\u6548\u7387\u8fdc\u4e0d\u5982\u6574\u578b\u6765\u7684\u9ad8\u6548\u3002\u56e0\u6b64\uff0c\u63a8\u8350\u4f7f\u7528 BIG INT \u6765\u5b58\u50a8\u91d1\u989d\u76f8\u5173\u7684\u5b57\u6bb5\u3002</p>"},{"location":"chap2_opt/1table_design/#1-3","title":"1-3 \u603b\u7ed3","text":"<ul> <li>\u4e0d\u63a8\u8350\u4f7f\u7528\u6574\u578b\u7c7b\u578b\u7684\u5c5e\u6027 Unsigned\uff0c\u82e5\u975e\u8981\u4f7f\u7528\uff0c\u53c2\u6570 <code>sql_mode</code> \u52a1\u5fc5\u989d\u5916\u6dfb\u52a0\u4e0a\u9009\u9879 <code>NO_UNSIGNED_SUBTRACTION</code>\uff1b</li> <li>\u81ea\u589e\u6574\u578b\u7c7b\u578b\u505a\u4e3b\u952e\uff0c\u52a1\u5fc5\u4f7f\u7528\u7c7b\u578b BIGINT\uff0c\u800c\u975e INT\uff0c\u540e\u671f\u8868\u7ed3\u6784\u8c03\u6574\u4ee3\u4ef7\u5de8\u5927\uff1b</li> <li>MySQL 8.0 \u7248\u672c\u524d\uff0c\u81ea\u589e\u6574\u578b\u4f1a\u6709\u56de\u6eaf\u95ee\u9898\uff0c\u505a\u4e1a\u52a1\u5f00\u53d1\u7684\u4f60\u4e00\u5b9a\u8981\u4e86\u89e3\u8fd9\u4e2a\u95ee\u9898\uff1b</li> <li>\u5f53\u8fbe\u5230\u81ea\u589e\u6574\u578b\u7c7b\u578b\u7684\u4e0a\u9650\u503c\u65f6\uff0c\u518d\u6b21\u81ea\u589e\u63d2\u5165\uff0cMySQL \u6570\u636e\u5e93\u4f1a\u62a5\u91cd\u590d\u9519\u8bef\uff1b</li> <li>\u4e0d\u8981\u518d\u4f7f\u7528\u6d6e\u70b9\u7c7b\u578b Float\u3001Double\uff0cMySQL \u540e\u7eed\u7248\u672c\u5c06\u4e0d\u518d\u652f\u6301\u4e0a\u8ff0\u4e24\u79cd\u7c7b\u578b\uff1b</li> <li>\u8d26\u6237\u4f59\u989d\u5b57\u6bb5\uff0c\u8bbe\u8ba1\u662f\u7528\u6574\u578b\u7c7b\u578b\uff0c\u800c\u4e0d\u662f DECIMAL \u7c7b\u578b\uff0c\u8fd9\u6837\u6027\u80fd\u66f4\u597d\uff0c\u5b58\u50a8\u66f4\u7d27\u51d1\u3002</li> </ul>"},{"location":"chap2_opt/1table_design/#2-collation","title":"2 \u5b57\u7b26\u4e32\u7c7b\u578b\uff1a\u4e0d\u80fd\u5ffd\u7565\u7684 COLLATION","text":"<p>MySQL \u6570\u636e\u5e93\u7684\u5b57\u7b26\u4e32\u7c7b\u578b\u6709 CHAR\u3001VARCHAR\u3001BINARY\u3001BLOB\u3001TEXT\u3001ENUM\u3001SET\u3002\u4e0d\u540c\u7684\u7c7b\u578b\u5728\u4e1a\u52a1\u8bbe\u8ba1\u3001\u6570\u636e\u5e93\u6027\u80fd\u65b9\u9762\u7684\u8868\u73b0\u5b8c\u5168\u4e0d\u540c\uff0c\u5176\u4e2d\u6700\u5e38\u4f7f\u7528\u7684\u662f CHAR\u3001VARCHAR\u3002</p>"},{"location":"chap2_opt/1table_design/#2-1-char-varchar","title":"2-1 CHAR \u548c VARCHAR \u7684\u5b9a\u4e49","text":"<p>CHAR(N) \u7528\u6765\u4fdd\u5b58\u56fa\u5b9a\u957f\u5ea6\u7684\u5b57\u7b26\uff0cN \u7684\u8303\u56f4\u662f 0 ~ 255\uff0c\u8bf7\u7262\u8bb0\uff0cN \u8868\u793a\u7684\u662f\u5b57\u7b26\uff0c\u800c\u4e0d\u662f\u5b57\u8282\u3002VARCHAR(N) \u7528\u6765\u4fdd\u5b58\u53d8\u957f\u5b57\u7b26\uff0cN \u7684\u8303\u56f4\u4e3a 0 ~ 65536\uff0c N \u8868\u793a\u5b57\u7b26\u3002</p> <p>\u5728\u8d85\u51fa 65536 \u4e2a\u5b57\u7b26\u7684\u60c5\u51b5\u4e0b\uff0c\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u66f4\u5927\u7684\u5b57\u7b26\u7c7b\u578b TEXT \u6216 BLOB\uff0c\u4e24\u8005\u6700\u5927\u5b58\u50a8\u957f\u5ea6\u4e3a 4G\uff0c\u5176\u533a\u522b\u662f BLOB \u6ca1\u6709\u5b57\u7b26\u96c6\u5c5e\u6027\uff0c\u7eaf\u5c5e\u4e8c\u8fdb\u5236\u5b58\u50a8\u3002</p> <p>\u548c Oracle\u3001Microsoft SQL Server \u7b49\u4f20\u7edf\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e0d\u540c\u7684\u662f\uff0cMySQL \u6570\u636e\u5e93\u7684 VARCHAR \u5b57\u7b26\u7c7b\u578b\uff0c\u6700\u5927\u80fd\u591f\u5b58\u50a8 65536 \u4e2a\u5b57\u7b26\uff0c\u6240\u4ee5\u5728 MySQL \u6570\u636e\u5e93\u4e0b\uff0c\u7edd\u5927\u90e8\u5206\u573a\u666f\u4f7f\u7528\u7c7b\u578b VARCHAR \u5c31\u8db3\u591f\u4e86\u3002</p> <ul> <li>\u5b57\u7b26\u96c6</li> </ul> <p>\u5728\u8868\u7ed3\u6784\u8bbe\u8ba1\u4e2d\uff0c\u9664\u4e86\u5c06\u5217\u5b9a\u4e49\u4e3a CHAR \u548c VARCHAR \u7528\u4ee5\u5b58\u50a8\u5b57\u7b26\u4ee5\u5916\uff0c\u8fd8\u9700\u8981\u989d\u5916\u5b9a\u4e49\u5b57\u7b26\u5bf9\u5e94\u7684\u5b57\u7b26\u96c6\uff0c\u56e0\u4e3a\u6bcf\u79cd\u5b57\u7b26\u5728\u4e0d\u540c\u5b57\u7b26\u96c6\u7f16\u7801\u4e0b\uff0c\u5bf9\u5e94\u7740\u4e0d\u540c\u7684\u4e8c\u8fdb\u5236\u503c\u3002</p> <p>\u5e38\u89c1\u7684\u5b57\u7b26\u96c6\u6709 GBK\u3001UTF8\uff0c\u901a\u5e38\u63a8\u8350\u628a\u9ed8\u8ba4\u5b57\u7b26\u96c6\u8bbe\u7f6e\u4e3a UTF8\u3002</p> <p>\u800c\u4e14\u968f\u7740\u79fb\u52a8\u4e92\u8054\u7f51\u7684\u98de\u901f\u53d1\u5c55\uff0c\u63a8\u8350\u628a MySQL \u7684\u9ed8\u8ba4\u5b57\u7b26\u96c6\u8bbe\u7f6e\u4e3a UTF8MB4\uff0c\u5426\u5219\uff0c\u67d0\u4e9b emoji \u8868\u60c5\u5b57\u7b26\u65e0\u6cd5\u5728 UTF8 \u5b57\u7b26\u96c6\u4e0b\u5b58\u50a8\uff0c\u6bd4\u5982 emoji \u7b11\u8138\u8868\u60c5\uff0c\u5bf9\u5e94\u7684\u5b57\u7b26\u7f16\u7801\u4e3a <code>0xF09F988E</code>\uff1a</p> <p></p> <p>\u82e5\u5f3a\u884c\u5728\u5b57\u7b26\u96c6\u4e3a UTF8 \u7684\u5217\u4e0a\u63d2\u5165 emoji \u8868\u60c5\u5b57\u7b26\uff0c MySQL \u4f1a\u629b\u51fa\u5982\u4e0b\u9519\u8bef\u4fe1\u606f\uff1a</p> <pre><code>mysql&gt; INSERT INTO emoji_test VALUES (0xF09F988E);\n\nERROR 1366 (HY000): Incorrect string value: '\\xF0\\x9F\\x98\\x8E' for column 'a' at row 1\n</code></pre> <p>\u53e6\u5916\uff0c\u4e0d\u540c\u7684\u5b57\u7b26\u96c6\uff0cCHAR(N)\u3001VARCHAR(N) \u5bf9\u5e94\u6700\u957f\u7684\u5b57\u8282\u4e5f\u4e0d\u76f8\u540c\u3002\u6bd4\u5982 GBK \u5b57\u7b26\u96c6\uff0c1 \u4e2a\u5b57\u7b26\u6700\u5927\u5b58\u50a8 2 \u4e2a\u5b57\u8282\uff0cUTF8MB4 \u5b57\u7b26\u96c6 1 \u4e2a\u5b57\u7b26\u6700\u5927\u5b58\u50a8 4 \u4e2a\u5b57\u8282\u3002\u6240\u4ee5\u4ece\u5e95\u5c42\u5b58\u50a8\u5185\u6838\u770b\uff0c\u5728\u591a\u5b57\u8282\u5b57\u7b26\u96c6\u4e0b\uff0cCHAR \u548c VARCHAR \u5e95\u5c42\u7684\u5b9e\u73b0\u5b8c\u5168\u76f8\u540c\uff0c\u90fd\u662f\u53d8\u957f\u5b58\u50a8\uff01</p> <p>\u9274\u4e8e\u76ee\u524d\u9ed8\u8ba4\u5b57\u7b26\u96c6\u63a8\u8350\u8bbe\u7f6e\u4e3a UTF8MB4\uff0c\u6240\u4ee5\u5728\u8868\u7ed3\u6784\u8bbe\u8ba1\u65f6\uff0c\u53ef\u4ee5\u628a CHAR \u5168\u90e8\u7528 VARCHAR \u66ff\u6362\uff0c\u5e95\u5c42\u5b58\u50a8\u7684\u672c\u8d28\u5b9e\u73b0\u4e00\u6a21\u4e00\u6837\u3002</p> <ul> <li>\u6392\u5e8f\u89c4\u5219</li> </ul> <p>\u6392\u5e8f\u89c4\u5219\uff08Collation\uff09\u662f\u6bd4\u8f83\u548c\u6392\u5e8f\u5b57\u7b26\u4e32\u7684\u4e00\u79cd\u89c4\u5219\uff0c\u6bcf\u4e2a\u5b57\u7b26\u96c6\u90fd\u4f1a\u6709\u9ed8\u8ba4\u7684\u6392\u5e8f\u89c4\u5219\uff0c\u4f60\u53ef\u4ee5\u7528\u547d\u4ee4 SHOW CHARSET \u6765\u67e5\u770b\uff1a</p> <p>\u7262\u8bb0\uff0c\u7edd\u5927\u90e8\u5206\u4e1a\u52a1\u7684\u8868\u7ed3\u6784\u8bbe\u8ba1\u65e0\u987b\u8bbe\u7f6e\u6392\u5e8f\u89c4\u5219\u4e3a\u5927\u5c0f\u5199\u654f\u611f\uff01\u9664\u975e\u4f60\u80fd\u660e\u767d\u4f60\u7684\u4e1a\u52a1\u771f\u6b63\u9700\u8981\u3002</p>"},{"location":"chap2_opt/1table_design/#2-2","title":"2-2 \u6b63\u786e\u4fee\u6539\u5b57\u7b26\u96c6","text":"<p>\u5982\u4e0b\u64cd\u4f5c\u540e\uff0c\u4f9d\u7136\u65e0\u6cd5\u63d2\u5165 emoji \u8fd9\u7c7b UTF8MB4 \u5b57\u7b26\uff1a</p> <pre><code>ALTER TABLE emoji_test CHARSET utf8mb4;\n</code></pre> <p>\u5176\u5b9e\uff0c\u4e0a\u8ff0\u4fee\u6539\u53ea\u662f\u5c06\u8868\u7684\u5b57\u7b26\u96c6\u4fee\u6539\u4e3a UTF8MB4\uff0c\u4e0b\u6b21\u65b0\u589e\u5217\u65f6\uff0c\u82e5\u4e0d\u663e\u5f0f\u5730\u6307\u5b9a\u5b57\u7b26\u96c6\uff0c\u65b0\u5217\u7684\u5b57\u7b26\u96c6\u4f1a\u53d8\u66f4\u4e3a UTF8MB4\uff0c\u4f46\u5bf9\u4e8e\u5df2\u7ecf\u5b58\u5728\u7684\u5217\uff0c\u5176\u9ed8\u8ba4\u5b57\u7b26\u96c6\u5e76\u4e0d\u505a\u4fee\u6539\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 SHOW CREATE TABLE \u786e\u8ba4\uff1a</p> <p>\u56e0\u6b64\uff0c\u6b63\u786e\u4fee\u6539\u5217\u5b57\u7b26\u96c6\u7684\u547d\u4ee4\u5e94\u8be5\u4f7f\u7528<code>ALTER TABLE ... CONVERT TO...</code>\u8fd9\u6837\u624d\u80fd\u5c06\u4e4b\u524d\u7684\u5217 a \u5b57\u7b26\u96c6\u4ece UTF8 \u4fee\u6539\u4e3a UTF8MB4\uff1a</p> <pre><code>ALTER TABLE emoji_test CONVERT TO CHARSET utf8mb4;\n</code></pre>"},{"location":"chap2_opt/1table_design/#2-3","title":"2-3 \u4e1a\u52a1\u8868\u7ed3\u6784\u8bbe\u8ba1\u5b9e\u6218","text":"<p>\u7528\u6237\u6027\u522b\u8bbe\u8ba1</p> <p>\u8bbe\u8ba1\u8868\u7ed3\u6784\u65f6\uff0c\u4f60\u4f1a\u9047\u5230\u4e00\u4e9b\u56fa\u5b9a\u9009\u9879\u503c\u7684\u5b57\u6bb5\u3002\u4f8b\u5982</p> <pre><code> `sex` tinyint DEFAULT NULL,\n</code></pre> <p>\u5176\u4e2d\uff0ctinyint \u5217 sex \u8868\u793a\u7528\u6237\u6027\u522b\uff0c\u4f46\u8fd9\u6837\u8bbe\u8ba1\u95ee\u9898\u6bd4\u8f83\u660e\u663e\u3002</p> <ul> <li>\u8868\u8fbe\u4e0d\u6e05\uff1a\u5728\u5177\u4f53\u5b58\u50a8\u65f6\uff0c0 \u8868\u793a\u5973\uff0c\u8fd8\u662f 1 \u8868\u793a\u5973\u5462\uff1f\u6bcf\u4e2a\u4e1a\u52a1\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u6f5c\u89c4\u5219\uff1b</li> <li>\u810f\u6570\u636e\uff1a\u56e0\u4e3a\u662f tinyint\uff0c\u56e0\u6b64\u9664\u4e86 0 \u548c 1\uff0c\u7528\u6237\u5b8c\u5168\u53ef\u4ee5\u63d2\u5165 2\u30013\u30014 \u8fd9\u6837\u7684\u6570\u503c\uff0c\u6700\u7ec8\u8868\u4e2d\u5b58\u5728\u65e0\u6548\u6570\u636e\u7684\u53ef\u80fd\uff0c\u540e\u671f\u518d\u8fdb\u884c\u6e05\u7406\uff0c\u4ee3\u4ef7\u5c31\u975e\u5e38\u5927\u4e86\u3002</li> </ul> <p>\u5728 MySQL 8.0 \u7248\u672c\u4e4b\u524d\uff0c\u53ef\u4ee5\u4f7f\u7528 ENUM \u5b57\u7b26\u4e32\u679a\u4e3e\u7c7b\u578b\uff0c\u53ea\u5141\u8bb8\u6709\u9650\u7684\u5b9a\u4e49\u503c\u63d2\u5165\u3002\u5982\u679c\u5c06\u53c2\u6570 <code>SQL_MODE</code> \u8bbe\u7f6e\u4e3a\u4e25\u683c\u6a21\u5f0f\uff0c\u63d2\u5165\u975e\u5b9a\u4e49\u6570\u636e\u5c31\u4f1a\u62a5\u9519\uff1a</p> <pre><code>...\n `sex` enum('M','F') COLLATE utf8mb4_general_ci DEFAULT NULL,\n ...\n\n SET sql_mode = 'STRICT_TRANS_TABLES';\n\n mysql&gt; INSERT INTO User VALUES (NULL,'F');\n\nQuery OK, 1 row affected (0.08 sec)\n\nmysql&gt; INSERT INTO User VALUES (NULL,'A');\n\nERROR 1265 (01000): Data truncated for column 'sex' at row 1\n</code></pre>"},{"location":"chap2_opt/1table_design/#2-4","title":"2-4 \u8d26\u6237\u5bc6\u7801\u5b58\u50a8\u8bbe\u8ba1","text":"<p>\u76f8\u4fe1\u4e0d\u5c11\u5f00\u53d1\u5f00\u53d1\u540c\u5b66\u4f1a\u901a\u8fc7\u51fd\u6570 MD5 \u52a0\u5bc6\u5b58\u50a8\u9690\u79c1\u6570\u636e\uff0c\u8fd9\u6ca1\u6709\u9519\uff0c\u56e0\u4e3a MD5 \u7b97\u6cd5\u5e76\u4e0d\u53ef\u9006\u3002\u7136\u800c\uff0cMD5 \u52a0\u5bc6\u540e\u7684\u503c\u662f\u56fa\u5b9a\u7684\uff0c\u5982\u5bc6\u7801 12345678\uff0c\u5b83\u5bf9\u5e94\u7684 MD5 \u56fa\u5b9a\u503c\u5373\u4e3a 25d55ad283aa400af464c76d713c07ad\u3002</p> <p>\u56e0\u6b64\uff0c\u53ef\u4ee5\u5bf9 MD5 \u8fdb\u884c\u66b4\u529b\u7834\u89e3\uff0c\u8ba1\u7b97\u51fa\u6240\u6709\u53ef\u80fd\u7684\u5b57\u7b26\u4e32\u5bf9\u5e94\u7684 MD5 \u503c\u3002\u82e5\u65e0\u6cd5\u679a\u4e3e\u6240\u6709\u7684\u5b57\u7b26\u4e32\u7ec4\u5408\uff0c\u90a3\u53ef\u4ee5\u8ba1\u7b97\u4e00\u4e9b\u5e38\u89c1\u7684\u5bc6\u7801\uff0c\u5982111111\u300112345678 \u7b49\u3002</p> <p>\u6240\u4ee5\uff0c\u5728\u8bbe\u8ba1\u5bc6\u7801\u5b58\u50a8\u4f7f\u7528\uff0c\u8fd8\u9700\u8981\u52a0\u76d0\uff08salt\uff09\uff0c\u6bcf\u4e2a\u516c\u53f8\u7684\u76d0\u503c\u90fd\u662f\u4e0d\u540c\u7684\uff0c\u56e0\u6b64\u8ba1\u7b97\u51fa\u7684\u503c\u4e5f\u662f\u4e0d\u540c\u7684\u3002\u82e5\u76d0\u503c\u4e3a psalt\uff0c\u5219\u5bc6\u7801 12345678 \u5728\u6570\u636e\u5e93\u4e2d\u7684\u503c\u4e3a\uff1a</p> <pre><code>password = MD5\uff08\u2018psalt12345678\u2019\uff09\n</code></pre> <ul> <li>\u82e5 salt \u503c\u88ab\uff08\u79bb\u804c\uff09\u5458\u5de5\u6cc4\u6f0f\uff0c\u5219\u5916\u90e8\u9ed1\u5ba2\u4f9d\u7136\u5b58\u5728\u66b4\u5229\u7834\u89e3\u7684\u53ef\u80fd\u6027\uff1b</li> <li>\u5bf9\u4e8e\u76f8\u540c\u5bc6\u7801\uff0c\u5176\u5bc6\u7801\u5b58\u50a8\u503c\u76f8\u540c\uff0c\u4e00\u65e6\u4e00\u4e2a\u7528\u6237\u5bc6\u7801\u6cc4\u6f0f\uff0c\u5176\u4ed6\u76f8\u540c\u5bc6\u7801\u7684\u7528\u6237\u7684\u5bc6\u7801\u4e5f\u5c06\u88ab\u6cc4\u6f0f\uff1b</li> <li>\u56fa\u5b9a\u4f7f\u7528 MD5 \u52a0\u5bc6\u7b97\u6cd5\uff0c\u4e00\u65e6 MD5 \u7b97\u6cd5\u88ab\u7834\u89e3\uff0c\u5219\u5f71\u54cd\u5f88\u5927\u3002</li> </ul> <p>\u52a8\u6001\u76d0 + \u975e\u56fa\u5b9a\u52a0\u5bc6\u7b97\u6cd5\u3002</p> <p>\u6211\u6bd4\u8f83\u63a8\u8350\u8fd9\u4e48\u8bbe\u8ba1\u5bc6\u7801\uff0c\u5217 password \u5b58\u50a8\u7684\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>$salt$cryption_algorithm$value\n</code></pre> <p>\u5176\u4e2d\uff1a</p> <ul> <li>$salt\uff1a\u8868\u793a\u52a8\u6001\u76d0\uff0c\u6bcf\u6b21\u7528\u6237\u6ce8\u518c\u65f6\u4e1a\u52a1\u4ea7\u751f\u4e0d\u540c\u7684\u76d0\u503c\uff0c\u5e76\u5b58\u50a8\u5728\u6570\u636e\u5e93\u4e2d\u3002\u82e5\u505a\u5f97\u518d\u7cbe\u7ec6\u4e00\u70b9\uff0c\u53ef\u4ee5\u52a8\u6001\u76d0\u503c + \u7528\u6237\u6ce8\u518c\u65e5\u671f\u5408\u5e76\u4e3a\u4e00\u4e2a\u66f4\u4e3a\u52a8\u6001\u7684\u76d0\u503c\u3002</li> <li><code>$cryption_algorithm</code>\uff1a\u8868\u793a\u52a0\u5bc6\u7684\u7b97\u6cd5\uff0c\u5982 v1 \u8868\u793a MD5 \u52a0\u5bc6\u7b97\u6cd5\uff0cv2 \u8868\u793a AES256 \u52a0\u5bc6\u7b97\u6cd5\uff0cv3 \u8868\u793a AES512 \u52a0\u5bc6\u7b97\u6cd5\u7b49\u3002</li> <li>$value\uff1a\u8868\u793a\u52a0\u5bc6\u540e\u7684\u5b57\u7b26\u4e32\u3002</li> </ul> <pre><code>password: $fgfaef$v1$2198687f6db06c9d1b31a030ba1ef074\n\n\npassword: $zpelf$v2$0x860E4E3B2AA4005D8EE9B7653409C4B133AF77AEF53B815D31426EC6EF78D882\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u7528\u6237 David \u548c Amy \u5bc6\u7801\u90fd\u662f 12345678\uff0c\u7136\u800c\u7531\u4e8e\u4f7f\u7528\u4e86\u52a8\u6001\u76d0\u548c\u52a8\u6001\u52a0\u5bc6\u7b97\u6cd5\uff0c\u4e24\u8005\u5b58\u50a8\u7684\u5185\u5bb9\u5b8c\u5168\u4e0d\u540c\u3002</p>"},{"location":"chap2_opt/1table_design/#2-5","title":"2-5 \u603b\u7ed3","text":"<ul> <li>CHAR \u548c VARCHAR \u867d\u7136\u5206\u522b\u7528\u4e8e\u5b58\u50a8\u5b9a\u957f\u548c\u53d8\u957f\u5b57\u7b26\uff0c\u4f46\u5bf9\u4e8e\u53d8\u957f\u5b57\u7b26\u96c6\uff08\u5982 GBK\u3001UTF8MB4\uff09\uff0c\u5176\u672c\u8d28\u662f\u4e00\u6837\u7684\uff0c\u90fd\u662f\u53d8\u957f\uff0c\u8bbe\u8ba1\u65f6\u5b8c\u5168\u53ef\u4ee5\u7528 VARCHAR \u66ff\u4ee3 CHAR\uff1b</li> <li>\u63a8\u8350 MySQL \u5b57\u7b26\u96c6\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a UTF8MB4\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8 emoji \u7b49\u6269\u5c55\u5b57\u7b26\uff1b</li> <li>\u6392\u5e8f\u89c4\u5219\u5f88\u91cd\u8981\uff0c\u7528\u4e8e\u5b57\u7b26\u7684\u6bd4\u8f83\u548c\u6392\u5e8f\uff0c\u4f46\u5927\u90e8\u5206\u573a\u666f\u4e0d\u9700\u8981\u7528\u533a\u5206\u5927\u5c0f\u5199\u7684\u6392\u5e8f\u89c4\u5219\uff1b</li> <li>\u4fee\u6539\u8868\u4e2d\u5df2\u6709\u5217\u7684\u5b57\u7b26\u96c6\uff0c\u4f7f\u7528\u547d\u4ee4 ALTER TABLE ... CONVERT TO ....\uff1b</li> <li>\u7528\u6237\u6027\u522b\uff0c\u8fd0\u884c\u72b6\u6001\u7b49\u6709\u9650\u503c\u7684\u5217\uff0cMySQL 8.0.16 \u7248\u672c\u76f4\u63a5\u4f7f\u7528 CHECK \u7ea6\u675f\u673a\u5236\uff0c\u4e4b\u524d\u7684\u7248\u672c\u53ef\u4f7f\u7528 ENUM \u679a\u4e3e\u5b57\u7b26\u4e32\u7c7b\u578b\uff0c\u5916\u52a0 <code>SQL_MODE</code>\u7684\u4e25\u683c\u6a21\u5f0f\uff1b</li> <li>\u4e1a\u52a1\u9690\u79c1\u4fe1\u606f\uff0c\u5982\u5bc6\u7801\u3001\u624b\u673a\u3001\u4fe1\u7528\u5361\u7b49\u4fe1\u606f\uff0c\u9700\u8981\u52a0\u5bc6\u3002\u5207\u8bb0\u7b80\u5355\u7684MD5\u7b97\u6cd5\u662f\u53ef\u4ee5\u8fdb\u884c\u66b4\u529b\u7834\u89e3\uff0c\u5e76\u4e0d\u5b89\u5168\uff0c\u63a8\u8350\u4f7f\u7528\u52a8\u6001\u76d0+\u52a8\u6001\u52a0\u5bc6\u7b97\u6cd5\u8fdb\u884c\u9690\u79c1\u6570\u636e\u7684\u5b58\u50a8\u3002</li> </ul>"},{"location":"chap2_opt/1table_design/#3-timestamp","title":"3 \u65e5\u671f\u7c7b\u578b\uff1aTIMESTAMP \u53ef\u80fd\u662f\u5de8\u5751","text":""},{"location":"chap2_opt/1table_design/#3-1","title":"3-1 \u65e5\u671f\u7c7b\u578b","text":"<p>MySQL \u6570\u636e\u5e93\u4e2d\u5e38\u89c1\u7684\u65e5\u671f\u7c7b\u578b\u6709 YEAR\u3001DATE\u3001TIME\u3001DATETIME\u3001TIMESTAMEP\u3002\u56e0\u4e3a\u4e1a\u52a1\u7edd\u5927\u90e8\u5206\u573a\u666f\u90fd\u9700\u8981\u5c06\u65e5\u671f\u7cbe\u786e\u5230\u79d2\uff0c\u6240\u4ee5\u5728\u8868\u7ed3\u6784\u8bbe\u8ba1\u4e2d\uff0c\u5e38\u89c1\u4f7f\u7528\u7684\u65e5\u671f\u7c7b\u578b\u4e3aDATETIME \u548c TIMESTAMP</p> <p>DATETIME</p> <p>\u7c7b\u578b DATETIME \u6700\u7ec8\u5c55\u73b0\u7684\u5f62\u5f0f\u4e3a\uff1aYYYY-MM-DD HH\uff1aMM\uff1aSS\uff0c\u56fa\u5b9a\u5360\u7528 8 \u4e2a\u5b57\u8282\u3002</p> <p>\u4ece MySQL 5.6 \u7248\u672c\u5f00\u59cb\uff0cDATETIME \u7c7b\u578b\u652f\u6301\u6beb\u79d2\uff0cDATETIME(N) \u4e2d\u7684 N \u8868\u793a\u6beb\u79d2\u7684\u7cbe\u5ea6\u3002\u4f8b\u5982\uff0cDATETIME(6) \u8868\u793a\u53ef\u4ee5\u5b58\u50a8 6 \u4f4d\u7684\u6beb\u79d2\u503c\u3002\u540c\u65f6\uff0c\u4e00\u4e9b\u65e5\u671f\u51fd\u6570\u4e5f\u652f\u6301\u7cbe\u786e\u5230\u6beb\u79d2\uff0c\u4f8b\u5982\u5e38\u89c1\u7684\u51fd\u6570 NOW\u3001SYSDATE\uff1a</p> <pre><code>mysql&gt; SELECT NOW(6);\n\n| 2020-09-14 17:50:28.707971 |\n\n</code></pre> <p>\u7528\u6237\u53ef\u4ee5\u5c06 DATETIME \u521d\u59cb\u5316\u503c\u8bbe\u7f6e\u4e3a\u5f53\u524d\u65f6\u95f4\uff0c\u5e76\u8bbe\u7f6e\u81ea\u52a8\u66f4\u65b0\u5f53\u524d\u65f6\u95f4\u7684\u5c5e\u6027\u3002</p> <pre><code>...\nregister_date DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n\nlast_modify_date DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n\nCHECK (sex = 'M' OR sex = 'F'),\n</code></pre> <p>\u5728\u4e0a\u9762\u7684\u8868 User \u4e2d\uff0c\u5217<code>register_date</code> \u8868\u793a\u6ce8\u518c\u65f6\u95f4\uff0c<code>DEFAULT CURRENT_TIMESTAMP</code> \u8868\u793a\u8bb0\u5f55\u63d2\u5165\u65f6\uff0c\u82e5\u6ca1\u6709\u6307\u5b9a\u65f6\u95f4\uff0c\u9ed8\u8ba4\u5c31\u662f\u5f53\u524d\u65f6\u95f4\u3002</p> <p>\u5217 last_modify_date \u8868\u793a\u5f53\u524d\u8bb0\u5f55\u6700\u540e\u7684\u4fee\u6539\u65f6\u95f4\uff0c<code>DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6)</code> \u8868\u793a\u6bcf\u6b21\u4fee\u6539\u90fd\u4f1a\u4fee\u6539\u4e3a\u5f53\u524d\u65f6\u95f4\u3002</p> <p>TIMESTAMP</p> <p>\u9664\u4e86 DATETIME\uff0c\u65e5\u671f\u7c7b\u578b\u4e2d\u8fd8\u6709\u4e00\u79cd TIMESTAMP \u7684\u65f6\u95f4\u6233\u7c7b\u578b\uff0c\u5176\u5b9e\u9645\u5b58\u50a8\u7684\u5185\u5bb9\u4e3a\u20181970-01-01 00:00:00\u2019\u5230\u73b0\u5728\u7684\u6beb\u79d2\u6570\u3002\u5728 MySQL \u4e2d\uff0c\u7531\u4e8e\u7c7b\u578b TIMESTAMP \u5360\u7528 4 \u4e2a\u5b57\u8282\uff0c\u56e0\u6b64\u5176\u5b58\u50a8\u7684\u65f6\u95f4\u4e0a\u9650\u53ea\u80fd\u5230\u2018<code>2038-01-19 03:14:07\u2019</code>\u3002</p> <p>\u4e0e DATETIME \u4e0d\u540c\u7684\u662f\uff0c\u82e5\u5e26\u6709\u6beb\u79d2\u65f6\uff0c\u7c7b\u578b TIMESTAMP \u5360\u7528 7 \u4e2a\u5b57\u8282\uff0c\u800c DATETIME \u65e0\u8bba\u662f\u5426\u5b58\u50a8\u6beb\u79d2\u4fe1\u606f\uff0c\u90fd\u5360\u7528 8 \u4e2a\u5b57\u8282\u3002</p> <p>\u53c2\u6570 time_zone \u6307\u5b9a\u4e86\u5f53\u524d\u4f7f\u7528\u7684\u65f6\u533a\uff0c\u9ed8\u8ba4\u4e3a SYSTEM \u4f7f\u7528\u64cd\u4f5c\u7cfb\u7edf\u65f6\u533a\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u8be5\u53c2\u6570\u6307\u5b9a\u6240\u9700\u8981\u7684\u65f6\u533a\u3002</p> <p>\u5982\u679c\u60f3\u4f7f\u7528 TIMESTAMP \u7684\u65f6\u533a\u529f\u80fd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u8bed\u53e5\u5c06\u4e4b\u524d\u7684\u7528\u6237\u8868 User \u7684\u6ce8\u518c\u65f6\u95f4\u5b57\u6bb5\u7c7b\u578b\u4ece DATETIME(6) \u4fee\u6539\u4e3a TIMESTAMP(6)\uff1a</p> <p>\u8fd9\u65f6\u901a\u8fc7\u8bbe\u5b9a\u4e0d\u540c\u7684 <code>time_zone</code>\uff0c\u53ef\u4ee5\u89c2\u5bdf\u5230\u4e0d\u540c\u65f6\u533a\u4e0b\u7684\u6ce8\u518c\u65f6\u95f4\uff1a</p> <pre><code>mysql&gt; SET time_zone = '-08:00';\n</code></pre>"},{"location":"chap2_opt/1table_design/#3-2","title":"3-2 \u4e1a\u52a1\u8868\u7ed3\u6784\u8bbe\u8ba1\u5b9e\u6218","text":"<ul> <li>DATETIME vs TIMESTAMP vs INT\uff0c\u600e\u4e48\u9009\uff1f</li> </ul> <p>\u5728\u505a\u8868\u7ed3\u6784\u8bbe\u8ba1\u65f6\uff0c\u5bf9\u65e5\u671f\u5b57\u6bb5\u7684\u5b58\u50a8\uff0c\u5f00\u53d1\u4eba\u5458\u901a\u5e38\u4f1a\u6709 3 \u79cd\u9009\u62e9\uff1aDATETIME\u3001TIMESTAMP\u3001INT\u3002</p> <p>INT \u7c7b\u578b\u5c31\u662f\u76f4\u63a5\u5b58\u50a8 <code>'1970-01-01 00:00:00'</code> \u5230\u73b0\u5728\u7684\u6beb\u79d2\u6570\uff0c\u672c\u8d28\u548c TIMESTAMP \u4e00\u6837\uff0c\u56e0\u6b64\u7528 INT \u4e0d\u5982\u76f4\u63a5\u4f7f\u7528 TIMESTAMP\u3002</p> <p>\u603b\u7684\u6765\u8bf4\uff0c\u6211\u5efa\u8bae\u4f60\u4f7f\u7528\u7c7b\u578b DATETIME\u3002 \u5bf9\u4e8e\u65f6\u533a\u95ee\u9898\uff0c\u53ef\u4ee5\u7531\u524d\u7aef\u6216\u8005\u670d\u52a1\u8fd9\u91cc\u505a\u4e00\u6b21\u8f6c\u5316\uff0c\u4e0d\u4e00\u5b9a\u975e\u8981\u5728\u6570\u636e\u5e93\u4e2d\u89e3\u51b3\u3002</p> <ul> <li>\u4e0d\u8981\u5ffd\u89c6 TIMESTAMP \u7684\u6027\u80fd\u95ee\u9898<ul> <li>\u6027\u80fd\u4e0d\u5982 DATETIME\uff1a DATETIME \u4e0d\u5b58\u5728\u65f6\u533a\u8f6c\u5316\u95ee\u9898\u3002</li> <li>\u6027\u80fd\u6296\u52a8\uff1a \u6d77\u91cf\u5e76\u53d1\u65f6\uff0c\u5b58\u5728\u6027\u80fd\u6296\u52a8\u95ee\u9898 </li> </ul> </li> </ul> <p>\u4e3a\u4e86\u4f18\u5316 TIMESTAMP \u7684\u4f7f\u7528\uff0c\u5f3a\u70c8\u5efa\u8bae\u4f60\u4f7f\u7528\u663e\u5f0f\u7684\u65f6\u533a\uff0c\u800c\u4e0d\u662f\u64cd\u4f5c\u7cfb\u7edf\u65f6\u533a\u3002\u6bd4\u5982\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u663e\u793a\u5730\u8bbe\u7f6e\u65f6\u533a\uff0c\u800c\u4e0d\u8981\u4f7f\u7528\u7cfb\u7edf\u65f6\u533a\uff1a</p> <pre><code>[mysqld]\n\ntime_zone = \"+08:00\"\n</code></pre> <ul> <li>\u8868\u7ed3\u6784\u8bbe\u8ba1\u89c4\u8303\uff1a\u6bcf\u6761\u8bb0\u5f55\u90fd\u8981\u6709\u4e00\u4e2a\u65f6\u95f4\u5b57\u6bb5</li> </ul> <p>\u5f3a\u70c8\u5efa\u8bae\u4f60\u6bcf\u5f20\u4e1a\u52a1\u6838\u5fc3\u8868\u90fd\u589e\u52a0\u4e00\u4e2a DATETIME \u7c7b\u578b\u7684 <code>last_modify_date</code> \u5b57\u6bb5\uff0c\u5e76\u8bbe\u7f6e\u4fee\u6539\u81ea\u52a8\u66f4\u65b0\u673a\u5236\uff0c \u5373\u4fbf\u6807\u8bc6\u6bcf\u6761\u8bb0\u5f55\u6700\u540e\u4fee\u6539\u7684\u65f6\u95f4\u3002</p> <pre><code> last_modify_date DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n</code></pre> <p>\u901a\u8fc7\u5b57\u6bb5 <code>last_modify_date</code> \u5b9a\u4e49\u7684 ON UPDATE CURRENT_TIMESTAMP(6)\uff0c\u90a3\u4e48\u6bcf\u6b21\u8fd9\u6761\u8bb0\u5f55\uff0c\u5219\u90fd\u4f1a\u81ea\u52a8\u66f4\u65b0 <code>last_modify_date</code> \u4e3a\u5f53\u524d\u65f6\u95f4\u3002</p> <p>\u8fd9\u6837\u8bbe\u8ba1\u7684\u597d\u5904\u662f\uff1a \u7528\u6237\u53ef\u4ee5\u77e5\u9053\u6bcf\u4e2a\u7528\u6237\u6700\u8fd1\u4e00\u6b21\u8bb0\u5f55\u66f4\u65b0\u7684\u65f6\u95f4\uff0c\u4ee5\u4fbf\u505a\u540e\u7eed\u7684\u5904\u7406\u3002\u6bd4\u5982\u5728\u7535\u5546\u7684\u8ba2\u5355\u8868\u4e2d\uff0c\u53ef\u4ee5\u65b9\u4fbf\u5bf9\u652f\u4ed8\u8d85\u65f6\u7684\u8ba2\u5355\u505a\u5904\u7406\uff1b\u5728\u91d1\u878d\u4e1a\u52a1\u4e2d\uff0c\u53ef\u4ee5\u6839\u636e\u7528\u6237\u8d44\u91d1\u6700\u540e\u7684\u4fee\u6539\u65f6\u95f4\u505a\u76f8\u5e94\u7684\u8d44\u91d1\u6838\u5bf9\u7b49\u3002</p>"},{"location":"chap2_opt/1table_design/#3-3","title":"3-3 \u603b\u7ed3","text":"<p>\u65e5\u671f\u7c7b\u578b\u901a\u5e38\u5c31\u662f\u4f7f\u7528 DATETIME \u548c TIMESTAMP \u4e24\u79cd\u7c7b\u578b\uff0c\u7136\u800c\u7531\u4e8e\u7c7b\u578b TIMESTAMP \u5b58\u5728\u6027\u80fd\u95ee\u9898\uff0c\u5efa\u8bae\u4f60\u8fd8\u662f\u5c3d\u53ef\u80fd\u4f7f\u7528\u7c7b\u578b DATETIME</p> <ul> <li>MySQL 5.6 \u7248\u672c\u5f00\u59cb DATETIME \u548c TIMESTAMP \u7cbe\u5ea6\u652f\u6301\u5230\u6beb\u79d2\uff1b</li> <li>DATETIME \u5360\u7528 8 \u4e2a\u5b57\u8282\uff0cTIMESTAMP \u5360\u7528 4 \u4e2a\u5b57\u8282\uff0cDATETIME(6) \u4f9d\u7136\u5360\u7528 8 \u4e2a\u5b57\u8282\uff0cTIMESTAMP(6) \u5360\u7528 7 \u4e2a\u5b57\u8282\uff1b</li> <li>TIMESTAMP \u65e5\u671f\u5b58\u50a8\u7684\u4e0a\u9650\u4e3a <code>2038-01-19 03:14:07</code>\uff0c\u4e1a\u52a1\u7528 TIMESTAMP \u5b58\u5728\u98ce\u9669\uff1b</li> <li>\u4f7f\u7528 TIMESTAMP \u5fc5\u987b\u663e\u5f0f\u5730\u8bbe\u7f6e\u65f6\u533a\uff0c\u4e0d\u8981\u4f7f\u7528\u9ed8\u8ba4\u7cfb\u7edf\u65f6\u533a\uff0c\u5426\u5219\u5b58\u5728\u6027\u80fd\u95ee\u9898\uff0c\u63a8\u8350\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u53c2\u6570 <code>time_zone = '+08:00'</code>\uff1b</li> <li>\u63a8\u8350\u65e5\u671f\u7c7b\u578b\u4f7f\u7528 DATETIME\uff0c\u800c\u4e0d\u662f TIMESTAMP \u548c INT \u7c7b\u578b\uff1b</li> <li>\u8868\u7ed3\u6784\u8bbe\u8ba1\u65f6\uff0c\u6bcf\u4e2a\u6838\u5fc3\u4e1a\u52a1\u8868\uff0c\u63a8\u8350\u8bbe\u8ba1\u4e00\u4e2a <code>last_modify_date</code> \u7684\u5b57\u6bb5\uff0c\u7528\u4ee5\u8bb0\u5f55\u6bcf\u6761\u8bb0\u5f55\u7684\u6700\u540e\u4fee\u6539\u65f6\u95f4\u3002</li> </ul>"},{"location":"chap2_opt/1table_design/#4-json","title":"4 \u975e\u7ed3\u6784\u5b58\u50a8\uff1a\u7528\u597d JSON","text":""},{"location":"chap2_opt/1table_design/#4-1-json","title":"4-1 JSON \u6570\u636e\u7c7b\u578b","text":"<p>\u4e3b\u8981\u6709JSON \u5bf9\u8c61\u548cJSON \u6570\u7ec4\u4e24\u79cd\u7c7b\u578b</p> <p>JSON\u5bf9\u8c61\u9664\u4e86\u652f\u6301\u5b57\u7b26\u4e32\u3001\u6574\u578b\u3001\u65e5\u671f\u7c7b\u578b\uff0cJSON \u5185\u5d4c\u7684\u5b57\u6bb5\u4e5f\u652f\u6301\u6570\u7ec4\u7c7b\u578b\uff0c\u5982\u4e0a\u4ee3\u7801\u4e2d\u7684 IDs \u5b57\u6bb5\u3002</p>"},{"location":"chap2_opt/1table_design/#4-2","title":"4-2 \u4e1a\u52a1\u8868\u7ed3\u6784\u8bbe\u8ba1\u5b9e\u6218","text":"<ul> <li>\u7528\u6237\u767b\u5f55\u8bbe\u8ba1</li> </ul> <p>\u5728\u6570\u636e\u5e93\u4e2d\uff0cJSON \u7c7b\u578b\u6bd4\u8f83\u9002\u5408\u5b58\u50a8\u4e00\u4e9b\u4fee\u6539\u8f83\u5c11\u3001\u76f8\u5bf9\u9759\u6001\u7684\u6570\u636e\uff0c\u6bd4\u5982\u7528\u6237\u767b\u5f55\u4fe1\u606f\u7684\u5b58\u50a8\u5982\u4e0b\uff1a</p> <pre><code>DROP TABLE IF EXISTS UserLogin;\n\nCREATE TABLE UserLogin (\n\n    userId BIGINT NOT NULL,\n\n    loginInfo JSON,\n\n    PRIMARY KEY(userId)\n\n);\n</code></pre> <p>\u63a5\u7740\uff0c\u63d2\u5165\u4e0b\u9762\u7684\u6570\u636e\uff1a</p> <pre><code>SET @b = '\n\n{\n\n    \"cellphone\" : \"15026888888\"\n\n}\n\n';\n\nINSERT INTO UserLogin VALUES (2,@b);\n</code></pre> <p>\u56e0\u4e3a\u652f\u6301\u4e86\u65b0\u7684JSON\u7c7b\u578b\uff0cMySQL \u914d\u5957\u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684 JSON \u5b57\u6bb5\u5904\u7406\u51fd\u6570\uff0c\u7528\u4e8e\u65b9\u4fbf\u5730\u64cd\u4f5c JSON \u6570\u636e\uff0c\u5177\u4f53\u53ef\u4ee5\u89c1 MySQL \u5b98\u65b9\u6587\u6863\u3002</p> <p>\u5176\u4e2d\uff0c\u6700\u5e38\u89c1\u7684\u5c31\u662f\u51fd\u6570 <code>JSON_EXTRACT</code>\uff0c\u5b83\u7528\u6765\u4ece JSON \u6570\u636e\u4e2d\u63d0\u53d6\u6240\u9700\u8981\u7684\u5b57\u6bb5\u5185\u5bb9\uff0c\u5982\u4e0b\u9762\u7684\u8fd9\u6761 SQL \u8bed\u53e5\u5c31\u67e5\u8be2\u7528\u6237\u7684\u624b\u673a\u548c\u5fae\u4fe1\u4fe1\u606f\u3002</p> <pre><code>SELECT\n\n    userId,\n\n    JSON_UNQUOTE(JSON_EXTRACT(loginInfo,\"$.cellphone\")) cellphone,\n\n    JSON_UNQUOTE(JSON_EXTRACT(loginInfo,\"$.wxchat\")) wxchat\n\nFROM UserLogin;\n</code></pre> <p>\u5f53 JSON \u6570\u636e\u91cf\u975e\u5e38\u5927\uff0c\u7528\u6237\u5e0c\u671b\u5bf9 JSON \u6570\u636e\u8fdb\u884c\u6709\u6548\u68c0\u7d22\u65f6\uff0c\u53ef\u4ee5\u5229\u7528 MySQL \u7684\u51fd\u6570\u7d22\u5f15\u529f\u80fd\u5bf9 JSON \u4e2d\u7684\u67d0\u4e2a\u5b57\u6bb5\u8fdb\u884c\u7d22\u5f15\u3002</p> <pre><code>ALTER TABLE UserLogin ADD COLUMN cellphone VARCHAR(255) AS (loginInfo-&gt;&gt;\"$.cellphone\");\n</code></pre> <p>\u4e0a\u8ff0 SQL \u9996\u5148\u521b\u5efa\u4e86\u4e00\u4e2a\u865a\u62df\u5217 cellphone\uff0c\u8fd9\u4e2a\u5217\u662f\u7531\u51fd\u6570 <code>loginInfo-&gt;&gt;\"$.cellphone\"</code> \u8ba1\u7b97\u5f97\u5230\u7684\u3002</p> <p>\u7136\u540e\u5728\u8fd9\u4e2a\u865a\u62df\u5217\u4e0a\u521b\u5efa\u4e00\u4e2a\u552f\u4e00\u7d22\u5f15 <code>idx_cellphone</code>\u3002 \u8fd9\u65f6\u518d\u901a\u8fc7\u865a\u62df\u5217 cellphone \u8fdb\u884c\u67e5\u8be2\uff0c\u5c31\u53ef\u4ee5\u770b\u5230\u4f18\u5316\u5668\u4f1a\u4f7f\u7528\u5230\u65b0\u521b\u5efa\u7684 <code>idx_cellphone</code> \u7d22\u5f15\uff1a</p> <p>\u5f53\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u4e00\u5f00\u59cb\u521b\u5efa\u8868\u7684\u65f6\u5019\uff0c\u5c31\u5b8c\u6210\u865a\u62df\u5217\u53ca\u51fd\u6570\u7d22\u5f15\u7684\u521b\u5efa\u3002\u5982\u4e0b\u8868\u521b\u5efa\u7684\u5217 cellphone \u5bf9\u5e94\u7684\u5c31\u662f JSON \u4e2d\u7684\u5185\u5bb9\uff0c\u662f\u4e2a\u865a\u62df\u5217\uff1b<code>uk_idx_cellphone</code> \u5c31\u662f\u5728\u865a\u62df\u5217 cellphone \u4e0a\u6240\u521b\u5efa\u7684\u7d22\u5f15\u3002</p> <pre><code>CREATE TABLE UserLogin (\n\n    userId BIGINT,\n\n    loginInfo JSON,\n\n    cellphone VARCHAR(255) AS (loginInfo-&gt;&gt;\"$.cellphone\"),\n\n    PRIMARY KEY(userId),\n\n    UNIQUE KEY uk_idx_cellphone(cellphone)\n\n);\n</code></pre>"},{"location":"chap2_opt/1table_design/#4-2_1","title":"4-2 \u603b\u7ed3","text":"<p>JSON \u7c7b\u578b\u662f MySQL 5.7 \u7248\u672c\u65b0\u589e\u7684\u6570\u636e\u7c7b\u578b\uff0c\u7528\u597d JSON \u6570\u636e\u7c7b\u578b\u53ef\u4ee5\u6709\u6548\u89e3\u51b3\u5f88\u591a\u4e1a\u52a1\u4e2d\u5b9e\u9645\u95ee\u9898</p> <ul> <li>\u4f7f\u7528 JSON \u6570\u636e\u7c7b\u578b\uff0c\u63a8\u8350\u7528 MySQL 8.0.17 \u4ee5\u4e0a\u7684\u7248\u672c\uff0c\u6027\u80fd\u66f4\u597d\uff0c\u540c\u65f6\u4e5f\u652f\u6301 <code>Multi-Valued Indexes</code>\uff1b</li> <li>JSON \u6570\u636e\u7c7b\u578b\u7684\u597d\u5904\u662f\u65e0\u987b\u9884\u5148\u5b9a\u4e49\u5217\uff0c\u6570\u636e\u672c\u8eab\u5c31\u5177\u6709\u5f88\u597d\u7684\u63cf\u8ff0\u6027\uff1b</li> <li>\u4e0d\u8981\u5c06\u6709\u660e\u663e\u5173\u7cfb\u578b\u7684\u6570\u636e\u7528 JSON \u5b58\u50a8\uff0c\u5982\u7528\u6237\u4f59\u989d\u3001\u7528\u6237\u59d3\u540d\u3001\u7528\u6237\u8eab\u4efd\u8bc1\u7b49\uff0c\u8fd9\u4e9b\u90fd\u662f\u6bcf\u4e2a\u7528\u6237\u5fc5\u987b\u5305\u542b\u7684\u6570\u636e\uff1b</li> <li>JSON \u6570\u636e\u7c7b\u578b\u63a8\u8350\u4f7f\u7528\u5728\u4e0d\u7ecf\u5e38\u66f4\u65b0\u7684\u9759\u6001\u6570\u636e\u5b58\u50a8\u3002</li> </ul>"},{"location":"chap2_opt/2table_design/","title":"L2 \u8868\u7ed3\u6784\u8bbe\u8ba1\u7bc7 - \u8868\u8bbe\u8ba1","text":""},{"location":"chap2_opt/2table_design/#1","title":"1 \u5fd8\u8bb0\u8303\u5f0f\u51c6\u5219","text":"<p>\u8303\u5f0f\u8bbe\u8ba1\u662f\u975e\u5e38\u91cd\u8981\u7684\u7406\u8bba\uff0c\u662f\u901a\u8fc7\u6570\u5b66\u96c6\u5408\u6982\u5ff5\u6765\u63a8\u5bfc\u8303\u5f0f\u7684\u8fc7\u7a0b\uff0c\u5728\u7406\u8bba\u4e0a\uff0c\u8981\u6c42\u8868\u7ed3\u6784\u8bbe\u8ba1\u5fc5\u987b\u81f3\u5c11\u6ee1\u8db3\u4e09\u8303\u5f0f\u7684\u8981\u6c42\u3002</p> <p>\u7531\u4e8e\u5b8c\u5168\u662f\u6570\u636e\u63a8\u5bfc\u8fc7\u7a0b\uff0c\u8303\u5f0f\u7406\u8bba\u975e\u5e38\u67af\u71e5\uff0c\u4f46\u4f60\u53ea\u8981\u8bb0\u4f4f\u51e0\u4e2a\u8981\u70b9\u5c31\u80fd\u6293\u4f4f\u5176\u4e2d\u7684\u7cbe\u9ad3\uff1a</p> <ul> <li>\u4e00\u8303\u5f0f\u8981\u6c42\u6240\u6709\u5c5e\u6027\u90fd\u662f\u4e0d\u53ef\u5206\u7684\u57fa\u672c\u6570\u636e\u9879\uff1b</li> <li>\u4e8c\u8303\u5f0f\u89e3\u51b3\u90e8\u5206\u4f9d\u8d56\uff1b</li> <li>\u4e09\u8303\u5f0f\u89e3\u51b3\u4f20\u9012\u4f9d\u8d56\u3002</li> </ul> <p>\u4ece\u4e1a\u52a1\u89d2\u5ea6\u51fa\u53d1\uff0c\u8bbe\u8ba1\u51fa\u7b26\u5408\u8303\u5f0f\u51c6\u5219\u8981\u6c42\u7684\u8868\u7ed3\u6784\u3002</p>"},{"location":"chap2_opt/2table_design/#1-1","title":"1-1 \u5de5\u7a0b\u4e0a\u7684\u8868\u7ed3\u6784\u8bbe\u8ba1\u5b9e\u6218","text":"<p>\u771f\u5b9e\u7684\u4e1a\u52a1\u573a\u666f\u662f\u5de5\u7a0b\u5b9e\u73b0\uff0c\u8868\u7ed3\u6784\u8bbe\u8ba1\u505a\u597d\u4ee5\u4e0b\u51e0\u70b9\u5c31\u5df2\u7ecf\u8db3\u591f\uff1a</p> <ul> <li>\u6bcf\u5f20\u8868\u4e00\u5b9a\u8981\u6709\u4e00\u4e2a\u4e3b\u952e\uff08\u65b9\u6cd5\u6709\u81ea\u589e\u4e3b\u952e\u8bbe\u8ba1\u3001UUID \u4e3b\u952e\u8bbe\u8ba1\u3001\u4e1a\u52a1\u81ea\u5b9a\u4e49\u751f\u6210\u4e3b\u952e\uff09\uff1b</li> <li> <p>\u6d88\u9664\u5197\u4f59\u6570\u636e\u5b58\u5728\u7684\u53ef\u80fd</p> </li> <li> <p>\u81ea\u589e\u4e3b\u952e\u8bbe\u8ba1</p> </li> </ul> <p>\u4e3b\u952e\u7528\u4e8e\u552f\u4e00\u6807\u8bc6\u4e00\u884c\u6570\u636e\uff0c\u6240\u4ee5\u4e00\u5f20\u8868\u6709\u4e3b\u952e\uff0c\u5c31\u5df2\u7ecf\u76f4\u63a5\u6ee1\u8db3\u4e00\u8303\u5f0f\u7684\u8981\u6c42\u4e86</p> <p>\u4f7f\u7528 BIGINT \u7684\u81ea\u589e\u7c7b\u578b\u4f5c\u4e3a\u4e3b\u952e\uff0c\u540c\u65f6\u7531\u4e8e\u6574\u578b\u7684\u81ea\u589e\u6027\uff0c\u6570\u636e\u5e93\u63d2\u5165\u4e5f\u662f\u987a\u5e8f\u7684\uff0c\u6027\u80fd\u8f83\u597d\u3002</p> <p>\u4f7f\u7528 BIGINT \u7684\u81ea\u589e\u7c7b\u578b\u4f5c\u4e3a\u4e3b\u952e\u7684\u8bbe\u8ba1\u4ec5\u4ec5\u9002\u5408\u975e\u6838\u5fc3\u4e1a\u52a1\u8868\uff0c\u6bd4\u5982\u544a\u8b66\u8868\u3001\u65e5\u5fd7\u8868\u7b49\u3002\u771f\u6b63\u7684\u6838\u5fc3\u4e1a\u52a1\u8868\uff0c\u4e00\u5b9a\u4e0d\u8981\u7528\u81ea\u589e\u952e\u505a\u4e3b\u952e\uff0c</p> <ul> <li>\u81ea\u589e\u5b58\u5728\u56de\u6eaf\u95ee\u9898\uff1b</li> <li>\u81ea\u589e\u503c\u5728\u670d\u52a1\u5668\u7aef\u4ea7\u751f\uff0c\u5b58\u5728\u5e76\u53d1\u6027\u80fd\u95ee\u9898\uff1b</li> <li>\u81ea\u589e\u503c\u505a\u4e3b\u952e\uff0c\u53ea\u80fd\u5728\u5f53\u524d\u5b9e\u4f8b\u4e2d\u4fdd\u8bc1\u552f\u4e00\uff0c\u4e0d\u80fd\u4fdd\u8bc1\u5168\u5c40\u552f\u4e00\uff1b</li> <li>\u516c\u5f00\u6570\u636e\u503c\uff0c\u5bb9\u6613\u5f15\u53d1\u5b89\u5168\u95ee\u9898\uff0c\u4f8b\u5982\u77e5\u9053\u5730\u5740<code>http://www.example.com/User/10/</code>\uff0c\u5f88\u5bb9\u731c\u51fa User \u6709 11\u300112 \u4f9d\u6b21\u7c7b\u63a8\u7684\u503c\uff0c\u5bb9\u6613\u5f15\u53d1\u6570\u636e\u6cc4\u9732\uff1b</li> <li>MGR\uff08MySQL Group Replication\uff09 \u53ef\u80fd\u5f15\u8d77\u7684\u6027\u80fd\u95ee\u9898\uff1b</li> <li>\u5206\u5e03\u5f0f\u67b6\u6784\u8bbe\u8ba1\u95ee\u9898\u3002</li> </ul> <p>\u53c8\u56e0\u4e3a\u81ea\u589e\u503c\u662f\u5728 MySQL \u670d\u52a1\u7aef\u4ea7\u751f\u7684\u503c\uff0c\u9700\u8981\u6709\u4e00\u628a\u81ea\u589e\u7684 AI \u9501\u4fdd\u62a4\uff0c\u82e5\u8fd9\u65f6\u6709\u5927\u91cf\u7684\u63d2\u5165\u8bf7\u6c42\uff0c\u5c31\u53ef\u80fd\u5b58\u5728\u81ea\u589e\u5f15\u8d77\u7684\u6027\u80fd\u74f6\u9888\u3002</p> <p>\u6bd4\u5982\u5728 MySQL \u6570\u636e\u5e93\u4e2d\uff0c\u53c2\u6570 <code>innodb_autoinc_lock_mode</code> \u7528\u4e8e\u63a7\u5236\u81ea\u589e\u9501\u6301\u6709\u7684\u65f6\u95f4\u3002\u5047\u8bbe\u6709\u4e00 SQL \u8bed\u53e5\uff0c\u540c\u65f6\u63d2\u5165 3 \u6761\u5e26\u6709\u81ea\u589e\u503c\u7684\u8bb0\u5f55\uff1a</p> <pre><code>INSERT INTO ... VALUES (NULL,...),(NULL,...),(NULL,...);\n</code></pre> <p>\u4ece\u8868\u683c\u4e2d\u4f60\u53ef\u4ee5\u770b\u5230\uff0c\u4e00\u6761 SQL \u8bed\u53e5\u63d2\u5165 3 \u6761\u8bb0\u5f55\uff0c\u53c2\u6570 innodb_autoinc_lock_mode \u8bbe\u7f6e\u4e3a 1\uff0c\u81ea\u589e\u9501\u5728\u8fd9\u4e00\u6761 SQL \u6267\u884c\u5b8c\u6210\u540e\u624d\u91ca\u653e\u3002</p> <p>\u5982\u679c\u53c2\u6570 <code>innodb_autoinc_lock_mode</code> \u8bbe\u7f6e\u4e3a2\uff0c\u81ea\u589e\u9501\u9700\u8981\u6301\u6709 3 \u6b21\uff0c\u6bcf\u63d2\u5165\u4e00\u6761\u8bb0\u5f55\u83b7\u53d6\u4e00\u6b21\u81ea\u589e\u9501\u3002</p> <ul> <li>\u8fd9\u6837\u8bbe\u8ba1\u597d\u5904\u662f\uff1a \u5f53\u524d\u63d2\u5165\u4e0d\u5f71\u54cd\u5176\u4ed6\u81ea\u589e\u4e3b\u952e\u7684\u63d2\u5165\uff0c\u53ef\u4ee5\u83b7\u5f97\u6700\u5927\u7684\u81ea\u589e\u5e76\u53d1\u63d2\u5165\u6027\u80fd\u3002</li> <li>\u7f3a\u70b9\u662f\uff1a \u4e00\u6761 SQL \u63d2\u5165\u7684\u591a\u6761\u8bb0\u5f55\u5e76\u4e0d\u662f\u8fde\u7eed\u7684\uff0c\u5982\u7ed3\u679c\u53ef\u80fd\u662f 1\u30013\u30015 \u8fd9\u6837\u5355\u8c03\u9012\u589e\u4f46\u975e\u8fde\u7eed\u7684\u60c5\u51b5\u3002</li> </ul> <p>\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u60f3\u83b7\u5f97\u81ea\u589e\u503c\u7684\u6700\u5927\u5e76\u53d1\u6027\u80fd\uff0c\u628a\u53c2\u6570 <code>innodb_autoinc_lock_mode</code> \u8bbe\u7f6e\u4e3a2\u3002</p> <p>\u5728\u4e92\u8054\u7f51\u6d77\u91cf\u5e76\u53d1\u67b6\u6784\u5b9e\u6218\u4e2d\uff0c\u6211\u66f4\u63a8\u8350 UUID \u505a\u4e3b\u952e\u6216\u4e1a\u52a1\u81ea\u5b9a\u4e49\u751f\u6210\u4e3b\u952e</p> <ul> <li>UUID\u4e3b\u952e\u8bbe\u8ba1</li> </ul> <p>UUID\uff08Universally Unique Identifier\uff09\u4ee3\u8868\u5168\u5c40\u552f\u4e00\u6807\u8bc6 ID\u3002\u663e\u7136\uff0c\u7531\u4e8e\u5168\u5c40\u552f\u4e00\u6027\uff0c\u4f60\u53ef\u4ee5\u628a\u5b83\u7528\u6765\u4f5c\u4e3a\u6570\u636e\u5e93\u7684\u4e3b\u952e\u3002</p> <pre><code>mysql&gt; SELECT UUID();\n\n+--------------------------------------+\n\n| UUID()                               |\n\n+--------------------------------------+\n\n| e0ea12d4-6473-11eb-943c-00155dbaa39d |\n\n+--------------------------------------+\n</code></pre> <p>\u6839\u636e Version 1\u7684\u89c4\u8303\uff0cMySQL\u4e2d\u7684 UUID \u7531\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206\u7ec4\u6210\uff1a</p> <pre><code>UUID = \u65f6\u95f4\u4f4e\uff084\u5b57\u8282\uff09- \u65f6\u95f4\u4e2d\u9ad8+\u7248\u672c\uff084\u5b57\u8282\uff09- \u65f6\u949f\u5e8f\u5217 - MAC\u5730\u5740\n</code></pre> <p>\u9700\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5b58\u50a8\u65f6\u95f4\u65f6\uff0cUUID \u662f\u6839\u636e\u65f6\u95f4\u4f4d\u9006\u5e8f\u5b58\u50a8\uff0c \u4e5f\u5c31\u662f\u4f4e\u65f6\u95f4\u4f4e\u4f4d\u5b58\u653e\u5728\u6700\u524d\u9762\uff0c\u9ad8\u65f6\u95f4\u4f4d\u5728\u6700\u540e\uff0c\u5373 UUID \u7684\u524d 4 \u4e2a\u5b57\u8282\u4f1a\u968f\u7740\u65f6\u95f4\u7684\u53d8\u5316\u800c\u4e0d\u65ad\u201c\u968f\u673a\u201d\u53d8\u5316\uff0c\u5e76\u975e\u5355\u8c03\u9012\u589e\u3002</p> <p>\u5f53\u7136\u4e86\uff0cMySQL 8.0\u7248\u672c\u4e4b\u524d\u6ca1\u6709\u51fd\u6570 <code>UUID_TO_BIN/BIN_TO_UUI</code>D\uff0c\u4f46\u662f\u4f60\u8fd8\u662f\u53ef\u4ee5\u901a\u8fc7\u7528\u6237\u4e49\u51fd\u6570\uff08UDF\uff09\u7684\u65b9\u5f0f\u89e3\u51b3\uff0c\u5982\u521b\u5efa\u4e0b\u9762\u7684\u51fd\u6570\uff1a</p> <p>\u73b0\u5728\uff0c\u4f60\u53ef\u4ee5\u5728\u5ba2\u6237\u7aef\u901a\u8fc7\u4ee5\u4e0b SQL \u547d\u4ee4\u63d2\u5165\u6570\u636e\uff0c\u5982\uff1a</p> <pre><code>INSERT INTO User VALUES (UUID_TO_BIN(UUID(),TRUE),......);\n</code></pre> <p>MySQL 8.0 \u63d0\u4f9b\u7684\u6392\u5e8f UUID \u6027\u80fd\u6700\u597d\uff0c\u751a\u81f3\u6bd4\u81ea\u589eID\u8fd8\u8981\u597d\u3002\u6b64\u5916\uff0c\u7531\u4e8e<code>UUID_TO_BIN</code>\u8f6c\u6362\u4e3a\u7684\u7ed3\u679c\u662f16 \u5b57\u8282\uff0c\u4ec5\u6bd4\u81ea\u589e ID \u589e\u52a0 8 \u4e2a\u5b57\u8282\uff0c\u6700\u540e\u5b58\u50a8\u5360\u7528\u7684\u7a7a\u95f4\u4e5f\u4ec5\u6bd4\u81ea\u589e\u5927\u4e86 3G\u3002</p> <p>\u800c\u4e14\u7531\u4e8e UUID \u80fd\u4fdd\u8bc1\u5168\u5c40\u552f\u4e00\uff0c\u56e0\u6b64\u4f7f\u7528 UUID \u7684\u6536\u76ca\u8fdc\u8fdc\u5927\u4e8e\u81ea\u589eID\u3002\u53ef\u80fd\u4f60\u5df2\u7ecf\u4e60\u60ef\u4e86\u7528\u81ea\u589e\u505a\u4e3b\u952e\uff0c\u4f46\u5728\u6d77\u91cf\u5e76\u53d1\u7684\u4e92\u8054\u7f51\u4e1a\u52a1\u573a\u666f\u4e0b\uff0c\u66f4\u63a8\u8350 UUID \u8fd9\u6837\u7684\u5168\u5c40\u552f\u4e00\u503c\u505a\u4e3b\u952e\u3002</p> <ul> <li>\u4e1a\u52a1\u81ea\u5b9a\u4e49\u751f\u6210\u4e3b\u952e</li> </ul> <p>\u73b0\u5728\u4f60\u53ea\u9700\u8981\u7262\u8bb0\uff1a\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\uff0c\u4ec5\u7528 UUID \u505a\u4e3b\u952e\u4f9d\u7136\u662f\u4e0d\u591f\u7684\u3002</p> <p>\u6240\u4ee5\uff0c\u5bf9\u4e8e\u5206\u5e03\u5f0f\u67b6\u6784\u7684\u6838\u5fc3\u4e1a\u52a1\u8868\uff0c\u6211\u63a8\u8350\u7c7b\u4f3c\u5982\u4e0b\u7684\u8bbe\u8ba1\uff0c\u6bd4\u5982\uff1a</p> <pre><code>PK = \u65f6\u95f4\u5b57\u6bb5 + \u968f\u673a\u7801\uff08\u53ef\u9009\uff09 + \u4e1a\u52a1\u4fe1\u606f1 + \u4e1a\u52a1\u4fe1\u606f2 ......\n</code></pre> <ul> <li>\u6d88\u9664\u5197\u4f59</li> </ul> <p>\u6d88\u9664\u5197\u4f59\u4e5f\u662f\u8303\u5f0f\u7684\u8981\u6c42\uff0c\u89e3\u51b3\u90e8\u5206\u4f9d\u8d56\u548c\u4f20\u9012\u4f9d\u8d56\uff0c\u672c\u8d28\u5c31\u662f\u5c3d\u53ef\u80fd\u51cf\u5c11\u5197\u4f59\u6570\u636e\u3002</p> <p>\u6240\u4ee5\uff0c\u5728\u8fdb\u884c\u8868\u7ed3\u6784\u8bbe\u8ba1\u65f6\uff0c\u6570\u636e\u53ea\u9700\u5b58\u653e\u5728\u4e00\u4e2a\u5730\u65b9\uff0c\u5176\u4ed6\u8868\u8981\u4f7f\u7528\uff0c\u901a\u8fc7\u4e3b\u952e\u5173\u8054\u5b58\u50a8\u5373\u53ef\u3002\u6bd4\u5982\u8ba2\u5355\u8868\u4e2d\u9700\u8981\u5b58\u653e\u8ba2\u5355\u5bf9\u5e94\u7684\u7528\u6237\u4fe1\u606f\uff0c\u5219\u4fdd\u5b58\u7528\u6237 ID \u5373\u53ef\uff1a</p> <p>\u5f53\u7136\u4e86\uff0c\u65e0\u8bba\u662f\u81ea\u589e\u4e3b\u952e\u8bbe\u8ba1\u3001UUID\u4e3b\u952e\u8bbe\u8ba1\u3001\u4e1a\u52a1\u81ea\u5b9a\u4e49\u751f\u6210\u4e3b\u952e\u3001\u8fd8\u662f\u6d88\u9664\u5197\u4f59\uff0c\u672c\u8d28\u4e0a\u90fd\u662f\u9075\u5faa\u4e86\u8303\u5f0f\u51c6\u5219\u3002\u4f46\u662f\u5728\u4e00\u4e9b\u5176\u4ed6\u4e1a\u52a1\u573a\u666f\u4e0b\uff0c\u4e5f\u5b58\u5728\u53cd\u8303\u5f0f\u8bbe\u8ba1\u7684\u60c5\u51b5\u3002</p>"},{"location":"chap2_opt/2table_design/#1-2","title":"1-2 \u603b\u7ed3","text":"<p>\u5728 MySQL \u6d77\u91cf\u5e76\u53d1\u7684\u5de5\u7a0b\u5b9e\u8df5\u4e0a\uff0c\u8868\u7ed3\u6784\u8bbe\u8ba1\u5e94\u9075\u5faa\u8fd9\u6837\u51e0\u4e2a\u89c4\u8303\uff1a</p> <ul> <li>\u6bcf\u5f20\u8868\u4e00\u5b9a\u8981\u6709\u4e00\u4e2a\u4e3b\u952e\uff1b</li> <li>\u81ea\u589e\u4e3b\u952e\u53ea\u63a8\u8350\u7528\u5728\u975e\u6838\u5fc3\u4e1a\u52a1\u8868\uff0c\u751a\u81f3\u5e94\u907f\u514d\u4f7f\u7528\uff1b</li> <li>\u6838\u5fc3\u4e1a\u52a1\u8868\u63a8\u8350\u4f7f\u7528 UUID \u6216\u4e1a\u52a1\u81ea\u5b9a\u4e49\u4e3b\u952e\uff1b</li> <li>\u4e00\u4efd\u6570\u636e\u5e94\u5c3d\u53ef\u80fd\u4fdd\u7559\u4e00\u4efd\uff0c\u901a\u8fc7\u4e3b\u952e\u5173\u8054\u8fdb\u884c\u67e5\u8be2\uff0c\u907f\u514d\u5197\u4f59\u6570\u636e\uff1b</li> <li>\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7 JSON \u6570\u636e\u7c7b\u578b\u8fdb\u884c\u53cd\u8303\u5f0f\u8bbe\u8ba1\uff0c\u63d0\u5347\u5b58\u50a8\u6548\u7387\uff1b</li> </ul>"},{"location":"chap2_opt/2table_design/#2","title":"2 \u8868\u538b\u7f29\uff1a\u4e0d\u4ec5\u4ec5\u662f\u7a7a\u95f4\u538b\u7f29","text":"<p>\u6570\u636e\u5e93\u4e2d\u7684\u8868\u662f\u7531\u4e00\u884c\u884c\u8bb0\u5f55\uff08rows\uff09\u6240\u7ec4\u6210\uff0c\u6bcf\u884c\u8bb0\u5f55\u88ab\u5b58\u50a8\u5728\u4e00\u4e2a\u9875\u4e2d\uff0c\u5728 MySQL \u4e2d\uff0c\u4e00\u4e2a\u9875\u7684\u5927\u5c0f\u9ed8\u8ba4\u4e3a 16K\uff0c\u4e00\u4e2a\u4e2a\u9875\u53c8\u7ec4\u6210\u4e86\u6bcf\u5f20\u8868\u7684\u8868\u7a7a\u95f4\u3002</p>"},{"location":"chap2_opt/2table_design/#2-1","title":"2-1 \u8868\u538b\u7f29","text":"<p>\u901a\u5e38\u6211\u4eec\u8ba4\u4e3a\uff0c\u5982\u679c\u4e00\u4e2a\u9875\u4e2d\u5b58\u653e\u7684\u8bb0\u5f55\u6570\u8d8a\u591a\uff0c\u6570\u636e\u5e93\u7684\u6027\u80fd\u8d8a\u9ad8\u3002\u8fd9\u662f\u56e0\u4e3a\u6570\u636e\u5e93\u8868\u7a7a\u95f4\u4e2d\u7684\u9875\u662f\u5b58\u653e\u5728\u78c1\u76d8\u4e0a\uff0cMySQL \u6570\u636e\u5e93\u5148\u8981\u5c06\u78c1\u76d8\u4e2d\u7684\u9875\u8bfb\u53d6\u5230\u5185\u5b58\u7f13\u51b2\u6c60\uff0c\u7136\u540e\u4ee5\u9875\u4e3a\u5355\u4f4d\u6765\u8bfb\u53d6\u548c\u7ba1\u7406\u8bb0\u5f55\u3002</p> <p>\u4e00\u4e2a\u9875\u4e2d\u5b58\u653e\u7684\u8bb0\u5f55\u8d8a\u591a\uff0c\u5185\u5b58\u4e2d\u80fd\u5b58\u653e\u7684\u8bb0\u5f55\u6570\u4e5f\u5c31\u8d8a\u591a\uff0c\u90a3\u4e48\u5b58\u53d6\u6548\u7387\u4e5f\u5c31\u8d8a\u9ad8\u3002\u82e5\u60f3\u5c06\u4e00\u4e2a\u9875\u4e2d\u5b58\u653e\u7684\u8bb0\u5f55\u6570\u53d8\u591a\uff0c\u53ef\u4ee5\u542f\u7528\u538b\u7f29\u529f\u80fd\u3002\u6b64\u5916\uff0c\u542f\u7528\u538b\u7f29\u540e\uff0c\u5b58\u50a8\u7a7a\u95f4\u5360\u7528\u4e5f\u53d8\u5c0f\u4e86\uff0c\u540c\u6837\u5355\u4f4d\u7684\u5b58\u50a8\u80fd\u5b58\u653e\u7684\u6570\u636e\u4e5f\u53d8\u591a\u4e86\u3002</p> <p>\u82e5\u8981\u542f\u7528\u538b\u7f29\u6280\u672f\uff0c\u6570\u636e\u5e93\u53ef\u4ee5\u6839\u636e\u8bb0\u5f55\u3001\u9875\u3001\u8868\u7a7a\u95f4\u8fdb\u884c\u538b\u7f29\uff0c\u4e0d\u8fc7\u5728\u5b9e\u9645\u5de5\u7a0b\u4e2d\uff0c\u6211\u4eec\u666e\u904d\u4f7f\u7528\u9875\u538b\u7f29\u6280\u672f\uff0c</p> <ul> <li>\u538b\u7f29\u6bcf\u6761\u8bb0\u5f55\uff1a \u56e0\u4e3a\u6bcf\u6b21\u8bfb\u5199\u90fd\u8981\u538b\u7f29\u548c\u89e3\u538b\uff0c\u8fc7\u4e8e\u4f9d\u8d56 CPU \u7684\u8ba1\u7b97\u80fd\u529b\uff0c\u6027\u80fd\u4f1a\u660e\u663e\u4e0b\u964d\uff1b<ul> <li>\u53e6\u5916\uff0c\u56e0\u4e3a\u5355\u6761\u8bb0\u5f55\u5927\u5c0f\u4e0d\u4f1a\u7279\u522b\u5927\uff0c\u4e00\u822c\u5c0f\u4e8e 1K\uff0c\u538b\u7f29\u6548\u7387\u4e5f\u5e76\u4e0d\u4f1a\u7279\u522b\u597d\u3002</li> </ul> </li> <li>\u538b\u7f29\u8868\u7a7a\u95f4\uff1a \u538b\u7f29\u6548\u7387\u975e\u5e38\u4e0d\u9519\uff0c\u4f46\u8981\u6c42\u8868\u7a7a\u95f4\u6587\u4ef6\u9759\u6001\u4e0d\u589e\u957f\uff0c\u8fd9\u5bf9\u57fa\u4e8e\u78c1\u76d8\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6765\u8bf4\uff0c\u5f88\u96be\u5b9e\u73b0\u3002</li> </ul> <p>\u800c\u57fa\u4e8e\u9875\u7684\u538b\u7f29\uff0c\u65e2\u80fd\u63d0\u5347\u538b\u7f29\u6548\u7387\uff0c\u53c8\u80fd\u5728\u6027\u80fd\u4e4b\u95f4\u53d6\u5f97\u4e00\u79cd\u5e73\u8861\u3002</p> <p>\u53ef\u80fd\u5f88\u591a\u540c\u5b66\u8ba4\u4e3a\uff0c\u542f\u7528\u8868\u7684\u9875\u538b\u7f29\u529f\u80fd\u540e\uff0c\u6027\u80fd\u6709\u660e\u663e\u635f\u5931\uff0c\u56e0\u4e3a\u538b\u7f29\u9700\u8981\u6709\u989d\u5916\u7684\u5f00\u9500\u3002</p> <p>\u7684\u786e\uff0c\u538b\u7f29\u9700\u8981\u6d88\u8017\u989d\u5916\u7684 CPU \u6307\u4ee4\uff0c\u4f46\u662f\u538b\u7f29\u5e76\u4e0d\u610f\u5473\u7740\u6027\u80fd\u4e0b\u964d\uff0c\u6216\u8bb8\u80fd\u989d\u5916\u63d0\u5347\u6027\u80fd\uff0c\u56e0\u4e3a\u5927\u90e8\u5206\u7684\u6570\u636e\u5e93\u4e1a\u52a1\u7cfb\u7edf\uff0cCPU \u7684\u5904\u7406\u80fd\u529b\u662f\u5269\u4f59\u7684\uff0c\u800c I/O \u8d1f\u8f7d\u624d\u662f\u6570\u636e\u5e93\u4e3b\u8981\u74f6\u9888\u3002</p> <p>\u501f\u52a9\u9875\u538b\u7f29\u6280\u672f\uff0cMySQL \u53ef\u4ee5\u628a\u4e00\u4e2a 16K \u7684\u9875\u538b\u7f29\u4e3a 8K\uff0c\u751a\u81f3 4K\uff0c\u8fd9\u6837\u5728\u4ece\u78c1\u76d8\u5199\u5165\u6216\u8bfb\u53d6\u65f6\uff0c\u5c31\u80fd\u5c06 I/O \u8bf7\u6c42\u5927\u5c0f\u51cf\u534a\uff0c\u751a\u81f3\u66f4\u5c0f\uff0c\u4ece\u800c\u63d0\u5347\u6570\u636e\u5e93\u7684\u6574\u4f53\u6027\u80fd\u3002</p>"},{"location":"chap2_opt/2table_design/#2-2-mysql","title":"2-2 MySQL \u538b\u7f29\u8868\u8bbe\u8ba1","text":"<ul> <li>COMPRESS \u9875\u538b\u7f29</li> </ul> <p>COMPRESS \u9875\u538b\u7f29\u662f MySQL 5.7 \u7248\u672c\u4e4b\u524d\u63d0\u4f9b\u7684\u9875\u538b\u7f29\u529f\u80fd\u3002\u53ea\u8981\u5728\u521b\u5efa\u8868\u65f6\u6307\u5b9a<code>ROW_FORMAT=COMPRESS</code>\uff0c\u5e76\u8bbe\u7f6e\u901a\u8fc7\u9009\u9879 <code>KEY_BLOCK_SIZE</code> \u8bbe\u7f6e\u538b\u7f29\u7684\u6bd4\u4f8b\u3002</p> <p>\u9700\u8981\u7262\u8bb0\u7684\u662f\uff0c \u867d\u7136\u662f\u901a\u8fc7\u9009\u9879 ROW_FORMAT \u542f\u7528\u538b\u7f29\u529f\u80fd\uff0c\u4f46\u8fd9\u5e76\u4e0d\u662f\u8bb0\u5f55\u7ea7\u538b\u7f29\uff0c\u4f9d\u7136\u662f\u6839\u636e\u9875\u7684\u7ef4\u5ea6\u8fdb\u884c\u538b\u7f29\u3002</p> <p>\u4e0b\u9762\u8fd9\u662f\u4e00\u5f20\u65e5\u5fd7\u8868\uff0c<code>ROW_FROMAT</code> \u8bbe\u7f6e\u4e3a COMPRESS\uff0c\u8868\u793a\u542f\u7528 COMPRESS \u9875\u538b\u7f29\u529f\u80fd\uff0c<code>KEY_BLOCK_SIZE</code> \u8bbe\u7f6e\u4e3a 8\uff0c\u8868\u793a\u5c06\u4e00\u4e2a 16K \u7684\u9875\u538b\u7f29\u4e3a 8K\u3002</p> <pre><code>CREATE TABLE Log (\n\n  logId BINARY(16) PRIMARY KEY,\n\n  ......\n\n)\n\nROW_FORMAT=COMPRESSED\n\nKEY_BLOCK_SIZE=8\n</code></pre> <p>COMPRESS \u9875\u538b\u7f29\u5c31\u662f\u5c06\u4e00\u4e2a\u9875\u538b\u7f29\u5230\u6307\u5b9a\u5927\u5c0f\u3002\u5982 16K \u7684\u9875\u538b\u7f29\u5230 8K\uff0c\u82e5\u4e00\u4e2a 16K \u7684\u9875\u65e0\u6cd5\u538b\u7f29\u5230 8K\uff0c\u5219\u4f1a\u4ea7\u751f 2 \u4e2a\u538b\u7f29\u540e\u7684 8K \u9875\uff0c\u5177\u4f53\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <ul> <li>COMPRESS \u9875\u538b\u7f29</li> </ul> <p>\u603b\u7684\u6765\u8bf4\uff0cCOMPRESS \u9875\u538b\u7f29\uff0c\u9002\u5408\u7528\u4e8e\u4e00\u4e9b\u5bf9\u6027\u80fd\u4e0d\u654f\u611f\u7684\u4e1a\u52a1\u8868\uff0c\u4f8b\u5982\u65e5\u5fd7\u8868\u3001\u76d1\u63a7\u8868\u3001\u544a\u8b66\u8868\u7b49\uff0c\u538b\u7f29\u6bd4\u4f8b\u901a\u5e38\u80fd\u8fbe\u5230 50% \u5de6\u53f3\u3002</p> <p>\u867d\u7136 COMPRESS \u538b\u7f29\u53ef\u4ee5\u6709\u6548\u51cf\u5c0f\u5b58\u50a8\u7a7a\u95f4\uff0c\u4f46 COMPRESS \u9875\u538b\u7f29\u7684\u5b9e\u73b0\u5bf9\u6027\u80fd\u7684\u5f00\u9500\u662f\u5de8\u5927\u7684\uff0c\u6027\u80fd\u4f1a\u6709\u660e\u663e\u9000\u5316\u3002\u4e3b\u8981\u539f\u56e0\u662f\u4e00\u4e2a\u538b\u7f29\u9875\u5728\u5185\u5b58\u7f13\u51b2\u6c60\u4e2d\uff0c\u5b58\u5728\u538b\u7f29\u548c\u89e3\u538b\u4e24\u4e2a\u9875\u3002</p> <p></p> <p>1 \u4e2a COMPRESS \u538b\u7f29\u9875\u5728\u5185\u5b58\u4e2d\u5b58\u5728 2 \u4e2a\u9875\u7248\u672c</p> <p>\u5982\u56fe\u6240\u793a\uff0cPage1 \u548c Page2 \u90fd\u662f\u538b\u7f29\u9875 8K\uff0c\u4f46\u662f\u5728\u5185\u5b58\u4e2d\u8fd8\u6709\u5176\u89e3\u538b\u540e\u7684 16K \u9875\u3002\u8fd9\u6837\u8bbe\u8ba1\u7684\u539f\u56e0\u662f 8K \u7684\u9875\u7528\u4e8e\u540e\u7eed\u9875\u7684\u66f4\u65b0\uff0c16K \u7684\u9875\u7528\u4e8e\u8bfb\u53d6\uff0c\u8fd9\u6837\u8bfb\u53d6\u5c31\u4e0d\u7528\u6bcf\u6b21\u505a\u89e3\u538b\u64cd\u4f5c\u4e86\u3002</p> <p>\u4e3a\u4e86 \u89e3\u51b3\u538b\u7f29\u6027\u80fd\u4e0b\u964d\u7684\u95ee\u9898\uff0c\u4eceMySQL 5.7 \u7248\u672c\u5f00\u59cb\u63a8\u51fa\u4e86 TPC \u538b\u7f29\u529f\u80fd\u3002</p> <ul> <li>TPC \u538b\u7f29</li> </ul> <p>TPC\uff08Transparent Page Compression\uff09\u662f 5.7 \u7248\u672c\u63a8\u51fa\u7684\u4e00\u79cd\u65b0\u7684\u9875\u538b\u7f29\u529f\u80fd\uff0c\u5176\u5229\u7528\u6587\u4ef6\u7cfb\u7edf\u7684\u7a7a\u6d1e\uff08Punch Hole\uff09\u7279\u6027\u8fdb\u884c\u538b\u7f29\u3002\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa TPC \u538b\u7f29\u8868\uff1a</p> <pre><code>CREATE TABLE Transaction \uff08\n\n  transactionId BINARY(16) PRIMARY KEY,\n\n  .....\n\n)\n\nCOMPRESSION=ZLIB | LZ4 | NONE;\n</code></pre> <p>\u8981\u4f7f\u7528 TPC \u538b\u7f29\uff0c\u9996\u5148\u8981\u786e\u8ba4\u5f53\u524d\u7684\u64cd\u4f5c\u7cfb\u7edf\u662f\u5426\u652f\u6301\u7a7a\u6d1e\u7279\u6027\u3002\u901a\u5e38\u6765\u8bf4\uff0c\u5f53\u524d\u5e38\u89c1\u7684 Linux \u64cd\u4f5c\u7cfb\u7edf\u90fd\u5df2\u652f\u6301\u7a7a\u6d1e\u7279\u6027\u3002</p> <p>\u7531\u4e8e\u7a7a\u6d1e\u662f\u6587\u4ef6\u7cfb\u7edf\u7684\u4e00\u4e2a\u7279\u6027\uff0c\u5229\u7528\u7a7a\u6d1e\u538b\u7f29\u53ea\u80fd\u538b\u7f29\u5230\u6587\u4ef6\u7cfb\u7edf\u7684\u6700\u5c0f\u5355\u4f4d 4K\uff0c\u4e14\u5176\u9875\u538b\u7f29\u662f 4K \u5bf9\u9f50\u7684\u3002\u6bd4\u5982\u4e00\u4e2a 16K \u7684\u9875\uff0c\u538b\u7f29\u540e\u4e3a 7K\uff0c\u5219\u5b9e\u9645\u5360\u7528\u7a7a\u95f4 8K\uff1b\u538b\u7f29\u540e\u4e3a 3K\uff0c\u5219\u5b9e\u9645\u5360\u7528\u7a7a\u95f4\u662f 4K\uff1b\u82e5\u538b\u7f29\u540e\u662f 13K\uff0c\u5219\u5360\u7528\u7a7a\u95f4\u4f9d\u7136\u4e3a 16K\u3002</p> <p>TPC \u538b\u7f29\u7684\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\u6240\u793a\uff1a</p> <p>\u4e00\u4e2a 16K \u7684\u9875\u538b\u7f29\u540e\u662f 8K\uff0c\u63a5\u7740\u6570\u636e\u5e93\u4f1a\u5bf9\u8fd9 16K \u7684\u9875\u5269\u4f59\u7684 8K \u586b\u51450x00\uff0c\u8fd9\u6837\u5f53\u8fd9\u4e2a 16K \u7684\u9875\u5199\u5165\u5230\u78c1\u76d8\u65f6\uff0c\u5229\u7528\u6587\u4ef6\u7cfb\u7edf\u7a7a\u6d1e\u7279\u6027\uff0c\u5219\u5b9e\u9645\u5c06\u4ec5\u5360\u7528 8K \u7684\u7269\u7406\u5b58\u50a8\u7a7a\u95f4\u3002</p> <p>\u7a7a\u6d1e\u538b\u7f29\u7684\u53e6\u4e00\u4e2a\u597d\u5904\u662f\uff0c\u5b83\u5bf9\u6570\u636e\u5e93\u6027\u80fd\u7684\u4fb5\u5165\u51e0\u4e4e\u662f\u65e0\u5f71\u54cd\u7684\uff08\u5c0f\u4e8e 20%\uff09\uff0c\u751a\u81f3\u53ef\u80fd\u8fd8\u80fd\u6709\u6027\u80fd\u7684\u63d0\u5347\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a\u4e0d\u540c\u4e8e COMPRESS \u9875\u538b\u7f29\uff0cTPC \u538b\u7f29\u5728\u5185\u5b58\u4e2d\u53ea\u6709\u4e00\u4e2a 16K \u7684\u89e3\u538b\u7f29\u540e\u7684\u9875\uff0c\u5bf9\u4e8e\u7f13\u51b2\u6c60\u6ca1\u6709\u989d\u5916\u7684\u5b58\u50a8\u5f00\u9500\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u6240\u6709\u9875\u7684\u8bfb\u5199\u64cd\u4f5c\u90fd\u548c\u975e\u538b\u7f29\u9875\u4e00\u6837\uff0c\u6ca1\u6709\u5f00\u9500\uff0c\u53ea\u6709\u5f53\u8fd9\u4e2a\u9875\u9700\u8981\u5237\u65b0\u5230\u78c1\u76d8\u65f6\uff0c\u624d\u4f1a\u89e6\u53d1\u9875\u538b\u7f29\u529f\u80fd\u4e00\u6b21\u3002\u4f46\u7531\u4e8e\u4e00\u4e2a 16K \u7684\u9875\u88ab\u538b\u7f29\u4e3a\u4e86 8K \u6216 4K\uff0c\u5176\u5b9e\u5199\u5165\u6027\u80fd\u4f1a\u5f97\u5230\u4e00\u5b9a\u7684\u63d0\u5347\u3002</p> <ul> <li>\u8868\u538b\u7f29\u5728\u4e1a\u52a1\u4e0a\u7684\u4f7f\u7528</li> </ul> <p>\u603b\u7684\u6765\u8bf4\uff0c\u5bf9\u4e00\u4e9b\u5bf9\u6027\u80fd\u4e0d\u654f\u611f\u7684\u4e1a\u52a1\u8868\uff0c\u4f8b\u5982\u65e5\u5fd7\u8868\u3001\u76d1\u63a7\u8868\u3001\u544a\u8b66\u8868\u7b49\uff0c\u5b83\u4eec\u53ea\u5bf9\u5b58\u50a8\u7a7a\u95f4\u6709\u8981\u6c42\uff0c\u56e0\u6b64\u53ef\u4ee5\u4f7f\u7528 COMPRESS \u9875\u538b\u7f29\u529f\u80fd\u3002  \u5728\u4e00\u4e9b\u8f83\u4e3a\u6838\u5fc3\u7684\u6d41\u6c34\u4e1a\u52a1\u8868\u4e0a\uff0c\u6211\u66f4\u63a8\u8350\u4f7f\u7528 TPC\u538b\u7f29\u3002\u56e0\u4e3a\u6d41\u6c34\u4fe1\u606f\u662f\u4e00\u79cd\u975e\u5e38\u6838\u5fc3\u7684\u6570\u636e\u5b58\u50a8\u4e1a\u52a1\uff0c\u901a\u5e38\u4f34\u968f\u6838\u5fc3\u4e1a\u52a1\u3002\u5982\u4e00\u7b14\u7535\u5546\u4ea4\u6613\uff0c\u7528\u6237\u6263\u94b1\u3001\u4e0b\u5355\u3001\u8bb0\u6d41\u6c34\uff0c\u8fd9\u5c31\u662f\u4e00\u4e2a\u6838\u5fc3\u4e1a\u52a1\u7684\u5fae\u6a21\u578b\u3002</p> <p>\u9700\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f\uff1a \u901a\u8fc7\u547d\u4ee4 <code>ALTER TABLE xxx COMPRESSION = ZLIB</code> \u53ef\u4ee5\u542f\u7528 TPC \u9875\u538b\u7f29\u529f\u80fd\uff0c\u4f46\u662f\u8fd9\u53ea\u5bf9\u540e\u7eed\u65b0\u589e\u7684\u6570\u636e\u4f1a\u8fdb\u884c\u538b\u7f29\uff0c\u5bf9\u4e8e\u539f\u6709\u7684\u6570\u636e\u5219\u4e0d\u8fdb\u884c\u538b\u7f29\u3002\u6240\u4ee5\u4e0a\u8ff0ALTER TABLE \u64cd\u4f5c\u53ea\u662f\u4fee\u6539\u5143\u6570\u636e\uff0c\u77ac\u95f4\u5c31\u80fd\u5b8c\u6210\u3002</p> <pre><code>ALTER TABLE Transaction202102 COMPRESSION=ZLIB\uff1b\n\nOPTIMIZE TABLE Transaction202102;\n</code></pre> <p></p>"},{"location":"chap2_opt/2table_design/#2-2","title":"2-2 \u603b\u7ed3","text":"<ul> <li>MySQL \u4e2d\u7684\u538b\u7f29\u90fd\u662f\u57fa\u4e8e\u9875\u7684\u538b\u7f29\uff1b</li> <li>COMPRESS \u9875\u538b\u7f29\u9002\u5408\u7528\u4e8e\u6027\u80fd\u8981\u6c42\u4e0d\u9ad8\u7684\u4e1a\u52a1\u8868\uff0c\u5982\u65e5\u5fd7\u3001\u76d1\u63a7\u3001\u544a\u8b66\u8868\u7b49\uff1b</li> <li>COMPRESS \u9875\u538b\u7f29\u5185\u5b58\u7f13\u51b2\u6c60\u5b58\u5728\u538b\u7f29\u548c\u89e3\u538b\u7684\u4e24\u4e2a\u9875\uff0c\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff1b</li> <li>\u5bf9\u5b58\u50a8\u6709\u538b\u7f29\u9700\u6c42\uff0c\u53c8\u5e0c\u671b\u6027\u80fd\u4e0d\u8981\u6709\u660e\u663e\u9000\u5316\uff0c\u63a8\u8350\u4f7f\u7528 TPC \u538b\u7f29\uff1b</li> <li>\u901a\u8fc7 ALTER TABLE \u542f\u7528 TPC \u538b\u7f29\u540e\uff0c\u8fd8\u9700\u8981\u6267\u884c\u547d\u4ee4 OPTIMIZE TABLE \u624d\u80fd\u7acb\u5373\u5b8c\u6210\u7a7a\u95f4\u7684\u538b\u7f29\u3002</li> </ul>"},{"location":"chap2_opt/2table_design/#3-sql-nosql","title":"3 \u8868\u7684\u8bbf\u95ee\u8bbe\u8ba1 SQL \u8fd8\u662f NoSQL","text":""},{"location":"chap2_opt/2table_design/#3-1-mysql","title":"3-1 MySQL \u4e2d\u8868\u7684\u8bbf\u95ee\u65b9\u5f0f","text":"<p>SQL \u662f\u8bbf\u95ee\u6570\u636e\u5e93\u7684\u4e00\u4e2a\u901a\u7528\u63a5\u53e3\uff0c\u867d\u7136\u6570\u636e\u5e93\u6709\u5f88\u591a\u79cd\uff0c\u4f46\u6570\u636e\u5e93\u4e2d\u7684 SQL \u5374\u662f\u7c7b\u4f3c\u7684\uff0c\u56e0\u4e3a SQL \u6709\u6807\u51c6\u5b58\u5728\uff0c\u5982 SQL92\u3001SQL2003 \u7b49\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u91cd\u70b9\u5e26\u4f60\u4e86\u89e3 MySQL \u600e\u4e48\u901a\u8fc7 NoSQL \u7684\u65b9\u5f0f\u8bbf\u95ee\u8868\u4e2d\u7684\u6570\u636e\u3002</p> <p></p> <p>MySQL \u4e09\u79cd\u8868\u7684\u8bbf\u95ee\u65b9\u5f0f</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u9664\u4e86\u6807\u51c6\u7684 SQL \u8bbf\u95ee\uff0cMySQL 5.6 \u7248\u672c\u5f00\u59cb\u8fd8\u652f\u6301\u901a\u8fc7 Memcached \u901a\u4fe1\u534f\u8bae\u8bbf\u95ee\u8868\u4e2d\u7684\u6570\u636e\uff0c\u8fd9\u65f6 MySQL \u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a KV \u6570\u636e\u5e93\u4f7f\u7528\u3002\u6b64\u5916\uff0cMySQL 5.7 \u7248\u672c\u5f00\u59cb\u8fd8\u652f\u6301\u901a\u8fc7\u65b0\u7684 MySQL X \u901a\u4fe1\u534f\u8bae\u8bbf\u95ee\u8868\u4e2d\u7684\u6570\u636e\uff0c\u8fd9\u65f6 MySQL \u53ef\u4ee5\u4f5c\u4e3a\u4e00\u4e2a\u6587\u6863\u6570\u636e\u5e93\u4f7f\u7528\u3002</p> <ul> <li>\u5bf9\u6bd4\u4f20\u7edf\u7684 NoSQL \u6570\u636e\u5e93\uff08\u6bd4\u5982 Memcached\u3001MongoDB\uff09\uff0cMySQL \u8fd9\u6837\u7684\u8bbf\u95ee\u66f4\u5177\u6709\u7075\u6d3b\u6027\uff0c\u5728\u901a\u8fc7\u7b80\u5355\u7684 NoSQL \u63a5\u53e3\u4fdd\u969c\u6027\u80fd\u7684\u524d\u63d0\u4e0b\uff0c\u53c8\u53ef\u4ee5\u901a\u8fc7 SQL \u7684\u65b9\u5f0f\u4e30\u5bcc\u5bf9\u4e8e\u6570\u636e\u7684\u67e5\u8be2</li> <li>\u53e6\u5916\uff0cMySQL \u63d0\u4f9b\u7684\u6210\u719f\u4e8b\u52a1\u7279\u6027\u3001\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\uff0c\u53c8\u80fd\u5f25\u8865 NoSQL \u6570\u636e\u5e93\u5728\u8fd9\u65b9\u9762\u7684\u4e0d\u8db3\u3002</li> </ul>"},{"location":"chap2_opt/2table_design/#3-2-memcached","title":"3-2 \u901a\u8fc7 Memcached \u534f\u8bae\u8bbf\u95ee\u8868","text":"<p>MySQL 5.6 \u7248\u672c\u5f00\u59cb\u652f\u6301\u901a\u8fc7\u63d2\u4ef6 Memcached Plugin\uff0c\u4ee5 KV \u65b9\u5f0f\u8bbf\u95ee\u8868\uff0c\u8fd9\u65f6\u53ef\u4ee5\u5c06 MySQL\u89c6\u4f5c\u4e00\u4e2a Memcached KV \u6570\u636e\u5e93\u3002</p> <p>\u5bf9\u4e8e\u6570\u636e\u7684\u8bbf\u95ee\u4e0d\u518d\u662f\u901a\u8fc7 SQL \u63a5\u53e3\uff0c\u800c\u662f\u901a\u8fc7 KV \u6570\u636e\u5e93\u4e2d\u5e38\u89c1\u7684 get\u3001set\u3001incr \u7b49\u8bf7\u6c42\u3002</p> <p>\u4f46\u4e3a\u4ec0\u4e48\u8981\u901a\u8fc7 KV \u7684\u65b9\u5f0f\u8bbf\u95ee\u6570\u636e\u5462\uff1f\u56e0\u4e3a\u6709\u4e9b\u4e1a\u52a1\u5bf9\u4e8e\u6570\u636e\u5e93\u7684\u8bbf\u95ee\u672c\u8d28\u4e0a\u90fd\u662f\u4e00\u4e2a KV \u64cd\u4f5c\u3002\u6bd4\u5982\u7528\u6237\u767b\u5f55\u7cfb\u7edf\uff0c\u5927\u591a\u662f\u7528\u4e8e\u4fe1\u606f\u786e\u8ba4\uff0c\u8fd9\u65f6\u5176 SQL \u5927\u591a\u90fd\u662f\u901a\u8fc7\u4e3b\u952e\u6216\u552f\u4e00\u7d22\u5f15\u8fdb\u884c\u6570\u636e\u7684\u67e5\u8be2\uff0c\u5982\uff1a</p> <pre><code>SELECT * FROM User WHERE PK = ?\n</code></pre> <p>\u82e5\u5728\u6d77\u91cf\u5e76\u53d1\u8bbf\u95ee\u7684\u7cfb\u7edf\u4e2d\uff0c\u901a\u8fc7 SQL \u8bbf\u95ee\u8fd9\u4e9b\u8868\uff0c\u7531\u4e8e\u901a\u8fc7\u4e3b\u952e\u7d22\u5f15\u8fdb\u884c\u8bbf\u95ee\uff0c\u901f\u5ea6\u5f88\u5feb\u3002\u4f46 SQL \u89e3\u6790\uff08\u54ea\u6015\u662f\u8f6f\u89e3\u6790\uff09\u5374\u8981\u8017\u8d39\u4e0d\u5c11\u65f6\u95f4\uff0c\u8fd9\u65f6\u5355\u6570\u636e\u5e93\u5b9e\u4f8b\u6027\u80fd\u4f1a\u53d7\u5230\u4e00\u5b9a\u7684\u9650\u5236\u3002</p> <p>\u57fa\u4e8e Memcached \u7684 KV \u8bbf\u95ee\uff0c\u53ef\u4ee5\u7ed5\u8fc7 SQL \u89e3\u6790\uff0c\u901a\u8fc7\u6620\u5c04\u5173\u7cfb\uff0c\u76f4\u63a5\u8bbf\u95ee\u5b58\u50a8\u5728 InnoDB \u5f15\u64ce\u4e2d\u7684\u6570\u636e\uff0c\u8fd9\u6837\u6570\u636e\u5e93\u7684\u6574\u4f53\u6027\u80fd\u4f1a\u5728\u4e0d\u82b1\u8d39\u989d\u5916\u6210\u672c\u7684\u524d\u63d0\u4e0b\u5f97\u5230\u6781\u5927\u7684\u63d0\u5347\u3002</p> <p>\u90a3\u4e48\u8981\u542f\u7528 Memcached \u534f\u8bae\u8bbf\u95ee MySQL \u9700\u8981\u505a\u4e24\u4ef6\u4e8b\u60c5\uff1a</p> <ul> <li>\u5f00\u542f Memcached \u63d2\u4ef6\uff1b</li> <li>\u914d\u7f6e\u8868\u4e0e KV \u7684\u6620\u5c04\u5173\u7cfb\u3002</li> </ul> <p>\u5177\u4f53\u64cd\u4f5c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>-- \u5b89\u88c5\u6620\u5c04\u8868\n\nmysql&gt; source MYSQL_HOME/share/innodb_memcached_config.sql\n\n-- \u5b89\u88c5\u63d2\u4ef6\uff0c\u9ed8\u8ba4\u4f1a\u542f\u52a811211\u7aef\u53e3\n\nmysql&gt; INSTALL PLUGIN daemon_memcached soname \"libmemcached.so\";\n</code></pre> <p>\u6267\u884c\u5b8c\u4e0a\u8ff0\u64cd\u4f5c\u540e\uff0c\u4f1a\u65b0\u589e\u4e00\u4e2a\u5e93 <code>innodb_memcache</code>\uff0c\u91cc\u9762\u7684\u8868 containers \u5c31\u662f\u9700\u8981\u914d\u7f6e\u7684KV\u6620\u5c04\u8868\u3002\u5982\u679c\u4e1a\u52a1\u5e38\u89c1\u7684\u4e3b\u952e\u67e5\u8be2 SQL \u5982\u4e0b\uff0c\u5176\u4e2d\u5217 <code>user_id</code> \u662f\u4e3b\u952e\uff1a</p> <pre><code>SELECT user_id,cellphone,last_login \n\nFROM test.User \n\nWHERE user_id = \uff1f\n</code></pre> <p>\u6267\u884c\u5b8c\u4e0a\u8ff0\u64cd\u4f5c\u540e\uff0c\u4f1a\u65b0\u589e\u4e00\u4e2a\u5e93 <code>innodb_memcache</code>\uff0c\u91cc\u9762\u7684\u8868 containers \u5c31\u662f\u9700\u8981\u914d\u7f6e\u7684KV\u6620\u5c04\u8868\u3002\u5982\u679c\u4e1a\u52a1\u5e38\u89c1\u7684\u4e3b\u952e\u67e5\u8be2 SQL \u5982\u4e0b\uff0c\u5176\u4e2d\u5217 <code>user_id</code> \u662f\u4e3b\u952e\uff1a</p> <pre><code>SELECT user_id,cellphone,last_login \n\nFROM test.User \n\nWHERE user_id = \uff1f\n</code></pre> <p>\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5728\u8868 Containers \u4e2d\u63d2\u5165\u4e00\u6761\u8bb0\u5f55\uff1a</p> <pre><code>INSERT INTO containers\n\nVALUES ('User','test','user_id','user_id|cellphone|last_login','0','0','0','PRIAMRY')\n</code></pre> <p>\u4e0a\u9762\u7684\u6620\u5c04\u5173\u7cfb\u8868\u793a\u901a\u8fc7 Memcached \u7684 KV \u65b9\u5f0f\u8bbf\u95ee\uff0c\u5176\u672c\u8d28\u662f\u901a\u8fc7 PRIAMRY \u7d22\u5f15\u8bbf\u95ee key \u503c\uff0ckey \u5c31\u662f <code>user_id</code>\uff0cvalue \u503c\u8fd4\u56de\u7684\u662f\u7531\u5217 <code>user_id</code>\u3001cellphone\u3001<code>last_login</code> \u7ec4\u5408\u800c\u6210\uff0c\u5206\u9694\u7b26\u4e3a<code>\"|\"</code>\u7684\u5b57\u7b26\u4e32\u3002</p> <p>\u6700\u540e\uff0c\u901a\u8fc7 SQL \u548c KV \u7684\u5bf9\u6bd4\u6027\u80fd\u6d4b\u8bd5\uff0c\u53ef\u4ee5\u53d1\u73b0\u901a\u8fc7 KV \u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u6027\u80fd\u8981\u597d\u975e\u5e38\u591a\uff0c\u5728\u6211\u7684\u6d4b\u8bd5\u670d\u52a1\u5668\u4e0a\u7ed3\u679c\u5982\u4e0b\u6240\u793a\uff1a</p> <p></p> <p>\u4ece\u6d4b\u8bd5\u7ed3\u679c\u53ef\u4ee5\u770b\u5230\uff0c\u57fa\u4e8e Memcached \u7684 KV \u8bbf\u95ee\u65b9\u5f0f\u6bd4\u4f20\u7edf\u7684 SQL \u65b9\u5f0f\u8981\u5feb54.33%\uff0c\u800c\u4e14CPU \u7684\u5f00\u9500\u53cd\u800c\u8fd8\u8981\u4f4e20%\u3002</p> <p>\u5f53\u7136\u4e86\uff0c\u4e0a\u8ff0\u64cd\u4f5c\u53ea\u662f\u5c06\u8868 User \u4f5c\u4e3a KV \u8bbf\u95ee\uff0c\u5982\u679c\u60f3\u5c06\u5176\u4ed6\u8868\u901a\u8fc7 KV \u7684\u65b9\u5f0f\u8bbf\u95ee\uff0c\u53ef\u4ee5\u7ee7\u7eed\u5728\u8868 Containers \u4e2d\u8fdb\u884c\u914d\u7f6e\u3002\u4f46\u662f\u5728\u4f7f\u7528\u65f6\uff0c\u52a1\u5fc5\u5148\u901a\u8fc7 GET \u547d\u4ee4\u6307\u5b9a\u8981\u8bbf\u95ee\u7684\u8868\uff1a</p> <pre><code># Python\u4f2a\u4ee3\u7801\n\nmc = Client('127.0.0.1:11211')\n\nmc.get('@@User') # \u8bfb\u53d6\u6620\u5c04\u8868User\n\nmc.get('key1')\n\nmc.get('@@sbtest1') # \u8bfb\u53d6\u6620\u5c04\u8868sbtest1\n\nmc.set('sb1_key1','aa|bbb|ccc')\n\n......\n</code></pre> <p>\u53e6\u4e00\u79cd\u4f7f\u7528 Memcached Plugin \u7684\u573a\u666f\u662f\u539f\u5148\u4f7f\u7528\u539f\u751f Memcached KV \u6570\u636e\u5e93\u7684\u7528\u6237\u3002\u8fd9\u4e9b\u7528\u6237\u53ef\u4ee5\u8003\u8651\u5c06 Memcached \u6570\u636e\u5e93\u8fc1\u79fb\u5230 MySQL \u3002\u8fd9\u6837\u7684\u597d\u5904\u662f\uff1a</p> <ul> <li>\u901a\u8fc7 MySQL \u8fdb\u884c\u8bbf\u95ee\u7684\u6027\u80fd\u6bd4\u539f\u751f Memcached \u597d\uff0c\u6570\u636e\u5e93\u5e76\u53d1\u4f18\u5316\u505a\u5f97\u66f4\u597d\uff1b</li> <li>\u5b58\u50a8\u53ef\u4ee5\u6301\u4e45\u5316\uff0c\u652f\u6301\u4e8b\u52a1\uff0c\u6570\u636e\u4e00\u81f4\u6027\u548c\u5b89\u5168\u6027\u66f4\u597d\uff1b</li> <li>\u5229\u7528 MySQL \u590d\u5236\u6280\u672f\uff0c\u53ef\u4ee5\u5f25\u8865\u539f\u751f Memcached \u4e0d\u652f\u6301\u6570\u636e\u590d\u5236\u7684\u77ed\u677f\uff1b</li> </ul>"},{"location":"chap2_opt/2table_design/#3-3-x-protocol","title":"3-3 \u901a\u8fc7 X Protocol \u8bbf\u95ee\u8868","text":"<p>MySQL 5.7 \u7248\u672c\u5f00\u59cb\u539f\u751f\u652f\u6301 JSON \u4e8c\u8fdb\u5236\u6570\u636e\u7c7b\u578b\uff0c\u540c\u65f6\u4e5f\u63d0\u4f9b\u5c06\u8868\u683c\u6620\u5c04\u4e3a\u4e00\u4e2a JSON \u6587\u6863\u3002</p> <p>\u540c\u65f6\uff0cMySQL \u4e5f\u63d0\u4f9b\u4e86 X Protocol \u8fd9\u6837\u7684 NoSQL \u8bbf\u95ee\u65b9\u5f0f\uff0c\u6240\u4ee5\uff0c\u73b0\u5728\u6211\u4eec MySQL \u6253\u9020\u6210\u4e00\u4e2aSQL &amp; NoSQL\u7684\u6587\u6863\u6570\u636e\u5e93\u3002</p> <p>\u5bf9\u6bd4 MongoDB \u6587\u6863\u6570\u636e\u5e93\uff0c\u5c06 MySQL \u6253\u9020\u4e3a\u6587\u6863\u6570\u636e\u5e93\u4e0e MongoDB \u7684\u5bf9\u6bd4\u5728\u4e8e\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u9664\u4e86 MySQL \u76ee\u524d\u8fd8\u65e0\u6cd5\u652f\u6301\u6570\u636e\u5206\u7247\u529f\u80fd\u5916\uff0c\u5176\u4ed6\u65b9\u9762 MySQL \u7684\u4f18\u52bf\u4f1a\u66f4\u5927\u4e00\u4e9b\uff0c\u7279\u522b\u662f MySQL \u662f\u901a\u8fc7\u4e8c\u7ef4\u8868\u683c\u5b58\u50a8 JSON \u6570\u636e\uff0c\u4ece\u800c\u5b9e\u73b0\u6587\u6863\u6570\u636e\u5e93\u529f\u80fd\u3002</p> <p>\u8fd9\u6837\u53ef\u4ee5\u901a\u8fc7 SQL \u8fdb\u884c\u5f88\u591a\u590d\u6742\u7ef4\u5ea6\u7684\u67e5\u8be2\uff0c\u7279\u522b\u662f\u7ed3\u5408 MySQL 8.0 \u7684 CTE\uff08Common Table Expression\uff09\u3001\u7a97\u53e3\u51fd\u6570\uff08Window Function\uff09\u7b49\u529f\u80fd\uff0c\u800c\u8fd9\u5728 MongoDB \u4e2d\u662f\u65e0\u6cd5\u539f\u751f\u5b9e\u73b0\u7684\u3002</p> <p>\u53e6\u5916\uff0c\u548c Memcached Plugin \u4e0d\u540c\u7684\u662f\uff0cMySQL \u9ed8\u8ba4\u4f1a\u81ea\u52a8\u542f\u7528 X Plugin \u63d2\u4ef6\uff0c\u63a5\u7740\u5c31\u53ef\u4ee5\u901a\u8fc7\u65b0\u7684 X Protocol \u534f\u8bae\u8bbf\u95ee MySQL \u4e2d\u7684\u6570\u636e\uff0c\u9ed8\u8ba4\u7aef\u53e3 33060\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u547d\u4ee4\u67e5\u770b\u6709\u5173 X Plugin \u7684\u914d\u7f6e\uff1a</p> <pre><code>mysql&gt; SHOW VARIABLES LIEK '%mysqlx%';\n\n+-----------------------------------+--------------------+\n\n| Variable_name                     | Value              |\n\n+-----------------------------------+--------------------+\n\n| mysqlx_bind_address               | *                  |\n\n| mysqlx_compression_algorithms     | \n\nDEFLATE_STREAM,LZ4_MESSAGE,ZSTD_STREAM                   |\n\n| mysqlx_connect_timeout            | 30                 |\n\n| mysqlx_document_id_unique_prefix  | 0                  |\n\n| mysqlx_enable_hello_notice        | ON                 |\n\n| mysqlx_idle_worker_thread_timeout | 60                 |\n\n| mysqlx_interactive_timeout        | 28800              |\n\n| mysqlx_max_allowed_packet         | 67108864           |\n\n| mysqlx_max_connections            | 100                |\n\n| mysqlx_min_worker_threads         | 2                  |\n\n| mysqlx_port                       | 33060              |\n\n| mysqlx_port_open_timeout          | 0                  |\n\n| mysqlx_read_timeout               | 30                 |\n\n| mysqlx_socket                     | /tmp/mysqlx.sock   |\n\n......\n</code></pre> <p>\u8981\u901a\u8fc7 X Protocol \u7ba1\u7406 MySQL \u9700\u8981\u901a\u8fc7\u65b0\u7684 MySQL Shell \u547d\u4ee4\uff0c\u9ed8\u8ba4\u5e76\u4e0d\u5b89\u88c5\uff0c\u9700\u8981\u5355\u72ec\u5b89\u88c5\u3002\u4e0b\u8f7d\u5730\u5740\uff1ahttps://dev.mysql.com/downloads/shell/\u3002\u5b89\u88c5\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 mysqlsh \u901a\u8fc7\u65b0\u7684 X Protocol \u8bbf\u95ee MySQL \u6570\u636e\u5e93\uff1a</p> <pre><code>root@MBP-Windows:# mysqlsh root@localhost/test\n</code></pre> <p>X Protocol \u534f\u8bae\u652f\u6301\u901a\u8fc7 JS\u3001Python\u3001SQL \u7684\u65b9\u5f0f\u7ba1\u7406\u548c\u8bbf\u95ee MySQL\uff0c\u5177\u4f53\u64cd\u4f5c\u4f60\u53ef\u4ee5\u53c2\u89c1\u5b98\u65b9\u6587\u6863\u3002</p> <p></p> <p>\u901a\u8fc7 X Protocol \u534f\u8bae\u7ba1\u7406\u6587\u6863\u6570\u636e\uff0c\u4e5f\u9700\u8981\u4e0b\u8f7d\u65b0\u7684 MySQL Connector\uff0c\u5e76\u5f15\u5165\u65b0\u7684 X \u9a71\u52a8\u5e93\uff0c\u5982 Python \u9a71\u52a8\uff1a</p> <pre><code>import mysqlx\n\n# Connect to server on localhost\n\nsession = mysqlx.get_session({\n\n    'host': 'localhost',\n\n    'port': 33060\n\n})\n\nschema = session.get_schema('test')\n\n# Use the collection 'my_collection'\n\ncollection = schema.get_collection('my_collection')\n\n# Specify which document to find with Collection.find()\n\nresult = collection.find('name like :param').bind('param', 'S%').limit(1).execute()\n\n# Print document\n\ndocs = result.fetch_all()\n\nprint('Name: {0}'.format(docs[0]['name']))\n\nsession.close()\n</code></pre>"},{"location":"chap2_opt/2table_design/#3-4","title":"3-4 \u603b\u7ed3","text":"<p>\u901a\u8fc7 SQL\u3001Memcache \u534f\u8bae\u3001X Protocol \u8bbf\u95ee MySQL \u4e2d\u7684\u8868\uff0c\u5373\u6211\u4eec\u53ef\u4ee5\u5c06 MySQL \u6253\u9020\u6210\u4e00\u4e2a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u3001KV \u6570\u636e\u5e93\u3001\u6587\u6863\u6570\u636e\u5e93\uff0c\u4f46\u5e95\u5c42\u90fd\u662f\u901a\u8fc7\u8868\u683c\u7684\u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u7684\u5b58\u50a8\uff0c\u5e76\u4e14\u6570\u636e\u90fd\u5b58\u50a8\u5728 InnoDB \u5f15\u64ce\u4e2d\u3002</p> <p>\u8fd8\u5728\u4f7f\u7528 Memcached\u3001MongoDB \u6570\u636e\u5e93\u7684\u540c\u5b66\u53ef\u4ee5\u8003\u8651\u5c06\u6570\u636e\u8fc1\u79fb\u5230 MySQL\uff0c\u8fd9\u6837\u80fd\u5728\u517c\u5bb9\u539f\u6709\u4e1a\u52a1\u7684\u524d\u63d0\u4e0b\uff0c\u4f7f\u7528\u5230 InnoDB \u5b58\u50a8\u5f15\u64ce\u7684\u9ad8\u5e76\u53d1\u3001\u4e8b\u52a1\u5b89\u5168\u3001\u6570\u636e\u590d\u5236\u7b49\u9ad8\u7ea7\u529f\u80fd\u3002</p>"},{"location":"chap2_opt/3table_index/","title":"L3 \u7d22\u5f15\u4f18\u5316","text":""},{"location":"chap2_opt/3table_index/#1","title":"1 \u7d22\u5f15\uff1a\u6392\u5e8f\u7684\u827a\u672f","text":""},{"location":"chap2_opt/3table_index/#1-1","title":"1-1 \u7d22\u5f15\u662f\u4ec0\u4e48\uff1f","text":"<p>\u7d22\u5f15\u662f\u63d0\u5347\u67e5\u8be2\u901f\u5ea6\u7684\u4e00\u79cd\u6570\u636e\u7ed3\u6784\u3002</p> <p>MySQL 8.0 \u7248\u672c\u4e2d\uff0cInnoDB \u5b58\u50a8\u5f15\u64ce\u652f\u6301\u7684\u7d22\u5f15\u6709 B+ \u6811\u7d22\u5f15\u3001\u5168\u6587\u7d22\u5f15\u3001R \u6811\u7d22\u5f15\u3002</p>"},{"location":"chap2_opt/3table_index/#1-2-b","title":"1-2 B+\u6811\u7d22\u5f15\u7ed3\u6784","text":"<p>\u90a3\u4e3a\u4ec0\u4e48\u5173\u7cfb\u578b\u6570\u636e\u5e93\u90fd\u70ed\u8877\u652f\u6301 B+\u6811\u7d22\u5f15\u5462\uff1f\u56e0\u4e3a\u5b83\u662f\u76ee\u524d\u4e3a\u6b62\u6392\u5e8f\u6700\u6709\u6548\u7387\u7684\u6570\u636e\u7ed3\u6784\u3002\u50cf\u4e8c\u53c9\u6811\uff0c\u54c8\u5e0c\u7d22\u5f15\u3001\u7ea2\u9ed1\u6811\u3001SkipList\uff0c\u5728\u6d77\u91cf\u6570\u636e\u57fa\u4e8e\u78c1\u76d8\u5b58\u50a8\u6548\u7387\u65b9\u9762\u8fdc\u4e0d\u5982 B+ \u6811\u7d22\u5f15\u9ad8\u6548\u3002</p> <p>B+\u6811\u7d22\u5f15\u7684\u7279\u70b9\u662f\uff1a \u57fa\u4e8e\u78c1\u76d8\u7684\u5e73\u8861\u6811\uff0c\u4f46\u6811\u975e\u5e38\u77ee\uff0c\u901a\u5e38\u4e3a 3~4 \u5c42\uff0c\u80fd\u5b58\u653e\u5343\u4e07\u5230\u4e0a\u4ebf\u7684\u6392\u5e8f\u6570\u636e\u3002\u6811\u77ee\u610f\u5473\u7740\u8bbf\u95ee\u6548\u7387\u9ad8\uff0c\u4ece\u5343\u4e07\u6216\u4e0a\u4ebf\u6570\u636e\u91cc\u67e5\u8be2\u4e00\u6761\u6570\u636e\uff0c\u53ea\u7528 3\u30014 \u6b21 I/O\u3002</p> <p>B+ \u6811\u7d22\u5f15\u7531\u6839\u8282\u70b9\uff08root node\uff09\u3001\u4e2d\u95f4\u8282\u70b9\uff08non leaf node\uff09\u3001\u53f6\u5b50\u8282\u70b9\uff08leaf node\uff09\u7ec4\u6210\uff0c\u5176\u4e2d\u53f6\u5b50\u8282\u70b9\u5b58\u653e\u6240\u6709\u6392\u5e8f\u540e\u7684\u6570\u636e\u3002\u5f53\u7136\u4e5f\u5b58\u5728\u4e00\u79cd\u6bd4\u8f83\u7279\u6b8a\u7684\u60c5\u51b5\uff0c\u6bd4\u5982\u9ad8\u5ea6\u4e3a 1 \u7684B+ \u6811\u7d22\u5f15\uff1a</p> <pre><code>CREATE TABLE User (\n\n  id BIGINT AUTO_INCREMENT PRIMARY KEY,\n\n  name VARCHAR(128) NOT NULL,\n\n  sex CHAR(6) NOT NULL,\n\n  registerDate DATETIME NOT NULL,\n\n  ...\n\n)\n</code></pre> <p>\u6240\u6709 B+ \u6811\u90fd\u662f\u4ece\u9ad8\u5ea6\u4e3a 1 \u7684\u6811\u5f00\u59cb\uff0c\u7136\u540e\u6839\u636e\u6570\u636e\u7684\u63d2\u5165\uff0c\u6162\u6162\u589e\u52a0\u6811\u7684\u9ad8\u5ea6\u3002\u4f60\u8981\u7262\u8bb0\uff1a\u7d22\u5f15\u662f\u5bf9\u8bb0\u5f55\u8fdb\u884c\u6392\u5e8f\uff0c \u9ad8\u5ea6\u4e3a 1 \u7684 B+ \u6811\u7d22\u5f15\u4e2d\uff0c\u5b58\u653e\u7684\u8bb0\u5f55\u90fd\u5df2\u7ecf\u6392\u5e8f\u597d\u4e86\uff0c\u82e5\u8981\u5728\u4e00\u4e2a\u53f6\u5b50\u8282\u70b9\u5185\u518d\u8fdb\u884c\u67e5\u8be2\uff0c\u53ea\u8fdb\u884c\u4e8c\u53c9\u67e5\u627e\uff0c\u5c31\u80fd\u5feb\u901f\u5b9a\u4f4d\u6570\u636e\u3002</p> <p>\u53ef\u968f\u7740\u63d2\u5165 B+ \u6811\u7d22\u5f15\u7684\u8bb0\u5f55\u53d8\u591a\uff0c1\u4e2a\u9875\uff0816K\uff09\u65e0\u6cd5\u5b58\u653e\u8fd9\u4e48\u591a\u6570\u636e\uff0c\u6240\u4ee5\u4f1a\u53d1\u751f B+ \u6811\u7684\u5206\u88c2\uff0cB+ \u6811\u7684\u9ad8\u5ea6\u53d8\u4e3a 2\uff0c\u5f53 B+ \u6811\u7684\u9ad8\u5ea6\u5927\u4e8e\u7b49\u4e8e 2 \u65f6\uff0c\u6839\u8282\u70b9\u548c\u4e2d\u95f4\u8282\u70b9\u5b58\u653e\u7684\u662f\u7d22\u5f15\u952e\u5bf9\uff0c\u7531\uff08\u7d22\u5f15\u952e\u3001\u6307\u9488\uff09\u7ec4\u6210\u3002</p> <p>\u9ad8\u5ea6\u4e3a 3 \u7684 B+ \u6811\u7d22\u5f15\u672c\u8d28\u4e0a\u4e0e\u9ad8\u5ea6 2 \u7684\u7d22\u5f15\u4e00\u81f4\uff0c\u5982\u4e0b\u56fe\u6240\u793a</p> <p></p> <p>\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 EXPLAIN \u67e5\u770b\u662f\u5426\u4f7f\u7528\u7d22\u5f15\uff1a</p> <pre><code>mysql&gt; EXPLAIN SELECT * FROM  User WHERE id = 1\\G\n\n********************** 1. row **********************\n\n           id: 1\n\n  select_type: SIMPLE\n\n        table: User\n\n   partitions: NULL\n\n         type: const\n\npossible_keys: PRIMARY\n\n          key: PRIMARY\n\n      key_len: 8\n\n          ref: const\n\n         rows: 1\n\n     filtered: 100.00\n\n        Extra: NULL\n</code></pre> <p>\u5728\u8f93\u51fa\u7684 EXPLIAN \u7ed3\u679c\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u5217 key \u663e\u793a PRIMARY\uff0c\u8fd9\u8868\u793a\u6839\u636e\u4e3b\u952e\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2\u3002\u82e5\u6ca1\u6709\u6839\u636e\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2\uff0c\u5982\u6839\u636e\u6027\u522b\u8fdb\u884c\u67e5\u8be2\uff0c\u5219\u4f1a\u663e\u793a\u7c7b\u4f3c\u5982\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>mysql&gt; EXPLAIN SELECT * FROM User WHERE sex = 'male'\\G\n\n********************** 1. row **********************\n\n           id: 1\n\n  select_type: SIMPLE\n\n        table: User\n\n   partitions: NULL\n\n         type: ALL\n\npossible_keys: NULL\n\n          key: NULL\n\n      key_len: NULL\n\n          ref: NULL\n\n         rows: 986400\n\n     filtered: 50.00\n\n        Extra: Using where\n</code></pre>"},{"location":"chap2_opt/3table_index/#1-3-b","title":"1-3 \u4f18\u5316 B+ \u6811\u7d22\u5f15\u7684\u63d2\u5165\u6027\u80fd","text":"<p>B+ \u6811\u5728\u63d2\u5165\u65f6\u5c31\u5bf9\u8981\u5bf9\u6570\u636e\u8fdb\u884c\u6392\u5e8f\uff0c\u4f46\u6392\u5e8f\u7684\u5f00\u9500\u5176\u5b9e\u5e76\u6ca1\u6709\u4f60\u60f3\u8c61\u5f97\u90a3\u4e48\u5927\uff0c\u56e0\u4e3a\u6392\u5e8f\u662f CPU \u64cd\u4f5c\uff08\u5f53\u524d\u4e00\u4e2a\u65f6\u949f\u5468\u671f CPU \u80fd\u5904\u7406\u4e0a\u4ebf\u6307\u4ee4\uff09\u3002</p> <p>MySQL \u4e2d B+ \u6811\u7d22\u5f15\u7684\u8bbe\u8ba1\u4e0e\u7ba1\u7406</p> <p>\u5728 MySQL \u6570\u636e\u5e93\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2\u8868 mysql.innodb_index_stats \u67e5\u770b\u6bcf\u4e2a\u7d22\u5f15\u7684\u5927\u81f4\u60c5\u51b5\uff1a</p> <pre><code>SELECT \n\ntable_name,index_name,stat_name,\n\nstat_value,stat_description \n\nFROM innodb_index_stats \n\nWHERE table_name = 'orders' and index_name = 'PRIMARY';\n\n+----------+------------+-----------+------------+------------------+\n\n|table_name| index_name | stat_name | stat_value |stat_description  |\n\n+----------+-------------------+------------+------------+----------+\n\n| orders | PRIMARY|n_diff_pfx01|5778522     | O_ORDERKEY            |\n\n| orders | PRIMARY|n_leaf_pages|48867 | Number of leaf pages        |\n\n| orders | PRIMARY|size        |49024 | Number of pages in the index|\n\n+--------+--------+------------+------+-----------------------------+\n\n3 rows in set (0.00 sec)\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u7ed3\u679c\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u8868 orders \u4e2d\u7684\u4e3b\u952e\u7d22\u5f15\uff0c\u5927\u7ea6\u6709 5778522 \u6761\u8bb0\u5f55\uff0c\u5176\u4e2d\u53f6\u5b50\u8282\u70b9\u4e00\u5171\u6709 48867 \u4e2a\u9875\uff0c\u7d22\u5f15\u6240\u6709\u9875\u7684\u6570\u91cf\u4e3a 49024\u3002\u6839\u636e\u4e0a\u9762\u7684\u4ecb\u7ecd\uff0c\u4f60\u53ef\u4ee5\u63a8\u7406\u51fa\u975e\u53f6\u8282\u70b9\u7684\u6570\u91cf\u4e3a 49024 ~ 48867\uff0c\u7b49\u4e8e 157 \u4e2a\u9875\u3002</p> <p>\u90a3\u4f60\u600e\u4e48\u77e5\u9053\u54ea\u4e9b B+\u6811\u7d22\u5f15\u672a\u88ab\u4f7f\u7528\u8fc7\u5462\uff1f\u5728 MySQL \u6570\u636e\u5e93\u4e2d\uff0c\u53ef\u4ee5\u901a\u8fc7\u67e5\u8be2\u8868<code>sys.schema_unused_indexes</code>\uff0c\u67e5\u770b\u6709\u54ea\u4e9b\u7d22\u5f15\u4e00\u76f4\u672a\u88ab\u4f7f\u7528\u8fc7\uff0c\u53ef\u4ee5\u88ab\u5e9f\u5f03\uff1a</p> <pre><code>SELECT * FROM schema_unused_indexes\n\nWHERE object_schema != 'performance_schema';\n\n+---------------+-------------+--------------+\n\n| object_schema | object_name | index_name   |\n\n+---------------+-------------+--------------+\n\n| sbtest        | sbtest1     | k_1          |\n\n| sbtest        | sbtest2     | k_2          |\n\n| sbtest        | sbtest3     | k_3          |\n\n| sbtest        | sbtest4     | k_4          |\n\n| tpch          | customer    | CUSTOMER_FK1 |\n\n| tpch          | lineitem    | LINEITEM_FK2 |\n\n| tpch          | nation      | NATION_FK1   |\n\n| tpch          | orders      | ORDERS_FK1   |\n\n| tpch          | partsupp    | PARTSUPP_FK1 |\n\n| tpch          | supplier    | SUPPLIER_FK1 |\n\n+---------------+-------------+--------------+\n</code></pre> <p>\u5982\u679c\u6570\u636e\u5e93\u8fd0\u884c\u65f6\u95f4\u6bd4\u8f83\u957f\uff0c\u800c\u4e14\u7d22\u5f15\u7684\u521b\u5efa\u65f6\u95f4\u4e5f\u6bd4\u8f83\u4e45\uff0c\u7d22\u5f15\u8fd8\u51fa\u73b0\u5728\u4e0a\u8ff0\u7ed3\u679c\u4e2d\uff0cDBA \u5c31\u53ef\u4ee5\u8003\u8651\u5220\u9664\u8fd9\u4e9b\u6ca1\u6709\u7528\u7684\u7d22\u5f15\u3002</p> <p>\u800c MySQL 8.0 \u7248\u672c\u63a8\u51fa\u4e86\u7d22\u5f15\u4e0d\u53ef\u89c1\uff08Invisible\uff09\u529f\u80fd\u3002\u5728\u5220\u9664\u5e9f\u5f03\u7d22\u5f15\u524d\uff0c\u7528\u6237\u53ef\u4ee5\u5c06\u7d22\u5f15\u8bbe\u7f6e\u4e3a\u5bf9\u4f18\u5316\u5668\u4e0d\u53ef\u89c1\uff0c\u7136\u540e\u89c2\u5bdf\u4e1a\u52a1\u662f\u5426\u6709\u5f71\u54cd\u3002\u82e5\u65e0\uff0cDBA \u53ef\u4ee5\u66f4\u5b89\u5fc3\u5730\u5220\u9664\u8fd9\u4e9b\u7d22\u5f15\uff1a</p> <pre><code>ALTER TABLE t1 \n\nALTER INDEX idx_name INVISIBLE/VISIBLE;\n</code></pre> <ul> <li>\u7d22\u5f15\u662f\u52a0\u5feb\u67e5\u8be2\u7684\u4e00\u79cd\u6570\u636e\u7ed3\u6784\uff0c\u5176\u539f\u7406\u662f\u63d2\u5165\u65f6\u5bf9\u6570\u636e\u6392\u5e8f\uff0c\u7f3a\u70b9\u662f\u4f1a\u5f71\u54cd\u63d2\u5165\u7684\u6027\u80fd\uff1b</li> <li>MySQL \u5f53\u524d\u652f\u6301 B+\u6811\u7d22\u5f15\u3001\u5168\u6587\u7d22\u5f15\u3001R \u6811\u7d22\u5f15\uff1b</li> <li>B+ \u6811\u7d22\u5f15\u7684\u9ad8\u5ea6\u901a\u5e38\u4e3a 3~4 \u5c42\uff0c\u9ad8\u5ea6\u4e3a 4 \u7684 B+ \u6811\u80fd\u5b58\u653e 50 \u4ebf\u5de6\u53f3\u7684\u6570\u636e\uff1b</li> <li>\u7531\u4e8e B+ \u6811\u7684\u9ad8\u5ea6\u4e0d\u9ad8\uff0c\u67e5\u8be2\u6548\u7387\u6781\u9ad8\uff0c50 \u4ebf\u7684\u6570\u636e\u4e5f\u53ea\u9700\u8981\u63d2\u53d9 4 \u6b21 I/O\uff1b</li> <li>MySQL \u5355\u8868\u7684\u7d22\u5f15\u6ca1\u6709\u4e2a\u6570\u9650\u5236\uff0c\u4e1a\u52a1\u67e5\u8be2\u6709\u5177\u4f53\u9700\u8981\uff0c\u521b\u5efa\u5373\u53ef\uff0c\u4e0d\u8981\u8ff7\u4fe1\u4e2a\u6570\u9650\u5236\uff1b</li> <li>\u53ef\u4ee5\u901a\u8fc7\u8868 <code>sys.schema_unused_indexes</code> \u548c\u7d22\u5f15\u4e0d\u53ef\u89c1\u7279\u6027\uff0c\u5220\u9664\u65e0\u7528\u7684\u7d22\u5f15\u3002</li> </ul>"},{"location":"chap2_opt/3table_index/#2","title":"2 \u7d22\u5f15\u7ec4\u7ec7\u8868","text":"<p>InnoDB \u5b58\u50a8\u5f15\u64ce\u662f MySQL \u6570\u636e\u5e93\u4e2d\u4f7f\u7528\u6700\u4e3a\u5e7f\u6cdb\u7684\u5f15\u64ce\uff0c\u5728\u6d77\u91cf\u5927\u5e76\u53d1\u7684 OLTP \u4e1a\u52a1\u4e2d\uff0cInnoDB \u5fc5\u9009\u3002</p> <p>\u5b83\u5728\u6570\u636e\u5b58\u50a8\u65b9\u9762\u6709\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u7279\u70b9\uff1a\u7d22\u5f15\u7ec4\u7ec7\u8868\uff08Index Organized Table\uff09\u3002</p>"},{"location":"chap2_opt/3table_index/#2-1","title":"2-1 \u7d22\u5f15\u7ec4\u7ec7\u8868","text":"<p>\u6570\u636e\u5b58\u50a8\u6709\u5806\u8868\u548c\u7d22\u5f15\u7ec4\u7ec7\u8868\u4e24\u79cd\u65b9\u5f0f\u3002</p> <p>\u5806\u8868\u4e2d\u7684\u6570\u636e\u65e0\u5e8f\u5b58\u653e\uff0c \u6570\u636e\u7684\u6392\u5e8f\u5b8c\u5168\u4f9d\u8d56\u4e8e\u7d22\u5f15\uff08Oracle\u3001Microsoft SQL Server\u3001PostgreSQL \u65e9\u671f\u9ed8\u8ba4\u652f\u6301\u7684\u6570\u636e\u5b58\u50a8\u90fd\u662f\u5806\u8868\u7ed3\u6784\uff09\u3002</p> <p></p> <p>\u4ece\u56fe\u4e2d\u770b\u5230\uff0c\u5806\u8868\u7684\u7ec4\u7ec7\u7ed3\u6784\u4e2d\uff0c\u6570\u636e\u548c\u7d22\u5f15\u5206\u5f00\u5b58\u50a8</p> <p>\u7d22\u5f15\u662f\u6392\u5e8f\u540e\u7684\u6570\u636e\uff0c\u800c\u5806\u8868\u4e2d\u7684\u6570\u636e\u662f\u65e0\u5e8f\u7684\uff0c\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5b58\u653e\u4e86\u6570\u636e\u5728\u5806\u8868\u4e2d\u7684\u5730\u5740\uff0c\u5f53\u5806\u8868\u7684\u6570\u636e\u53d1\u751f\u6539\u53d8\uff0c\u4e14\u4f4d\u7f6e\u53d1\u751f\u4e86\u53d8\u66f4\uff0c\u6240\u6709\u7d22\u5f15\u4e2d\u7684\u5730\u5740\u90fd\u8981\u66f4\u65b0\uff0c\u8fd9\u975e\u5e38\u5f71\u54cd\u6027\u80fd\uff0c\u7279\u522b\u662f\u5bf9\u4e8e OLTP \u4e1a\u52a1\u3002</p> <ul> <li>\u800c\u7d22\u5f15\u7ec4\u7ec7\u8868\uff0c\u6570\u636e\u6839\u636e\u4e3b\u952e\u6392\u5e8f\u5b58\u653e\u5728\u7d22\u5f15\u4e2d\uff0c\u4e3b\u952e\u7d22\u5f15\u4e5f\u53eb\u805a\u96c6\u7d22\u5f15\uff08Clustered Index\uff09\u3002</li> <li>\u5728\u7d22\u5f15\u7ec4\u7ec7\u8868\u4e2d\uff0c\u6570\u636e\u5373\u7d22\u5f15\uff0c\u7d22\u5f15\u5373\u6570\u636e\u3002</li> </ul> <p>MySQL InnoDB \u5b58\u50a8\u5f15\u64ce\u5c31\u662f\u8fd9\u6837\u7684\u6570\u636e\u7ec4\u7ec7\u65b9\u5f0f\uff1b</p> <p>\u4f46\u662f\uff0cPostgreSQL \u6570\u636e\u5e93\u56e0\u4e3a\u53ea\u652f\u6301\u5806\u8868\u5b58\u50a8\uff0c\u4e0d\u9002\u5408 OLTP \u7684\u8bbf\u95ee\u7279\u6027\uff0c\u867d\u7136\u5b83\u540e\u671f\u5bf9\u5806\u8868\u6709\u4e00\u5b9a\u7684\u4f18\u5316\uff0c\u4f46\u672c\u8d28\u662f\u901a\u8fc7\u7a7a\u95f4\u6362\u65f6\u95f4\uff0c\u5bf9\u6d77\u91cf\u5e76\u53d1\u7684 OLTP \u4e1a\u52a1\u652f\u6301\u4f9d\u7136\u5b58\u5728\u5c40\u9650\u6027\u3002</p>"},{"location":"chap2_opt/3table_index/#2-2","title":"2-2 \u4e8c\u7ea7\u7d22\u5f15","text":"<p>InnoDB \u5b58\u50a8\u5f15\u64ce\u7684\u6570\u636e\u662f\u6839\u636e\u4e3b\u952e\u7d22\u5f15\u6392\u5e8f\u5b58\u50a8\u7684\uff0c\u9664\u4e86\u4e3b\u952e\u7d22\u5f15\u5916\uff0c\u5176\u4ed6\u7684\u7d22\u5f15\u90fd\u79f0\u4e4b\u4e3a\u4e8c\u7ea7\u7d22\u5f15\uff08Secondeary Index\uff09\uff0c \u6216\u975e\u805a\u96c6\u7d22\u5f15\uff08None Clustered Index\uff09\u3002</p> <p>\u4e8c\u7ea7\u7d22\u5f15\u4e5f\u662f\u4e00\u9897 B+ \u6811\u7d22\u5f15\uff0c\u4f46\u5b83\u548c\u4e3b\u952e\u7d22\u5f15\u4e0d\u540c\u7684\u662f\u53f6\u5b50\u8282\u70b9\u5b58\u653e\u7684\u662f\u7d22\u5f15\u952e\u503c\u3001\u4e3b\u952e\u503c\u3002</p> <p>\u521b\u5efa\u7684\u8868 User\uff0c\u5047\u8bbe\u5728\u5217 name \u4e0a\u8fd8\u521b\u5efa\u4e86\u7d22\u5f15 idx_name\uff0c\u8be5\u7d22\u5f15\u5c31\u662f\u4e8c\u7ea7\u7d22\u5f15\uff1a</p> <pre><code>CREATE TABLE User (\n\n    id BIGINT AUTO_INCREMENT,\n\n    name VARCHAR(128) NOT NULL,\n\n    sex CHAR(6) NOT NULL,\n\n    registerDate DATETIME NOT NULL,\n\n    ...\n\n    PRIMARY KEY(id), -- \u4e3b\u952e\u7d22\u5f15\n\n    KEY idx_name(name) -- \u4e8c\u7ea7\u7d22\u5f15\n\n)\n</code></pre> <p>\u5982\u679c\u7528\u6237\u901a\u8fc7\u5217 name \u8fdb\u884c\u67e5\u8be2\uff0c\u6bd4\u5982\u4e0b\u9762\u7684 SQL\uff1a</p> <pre><code>SELECT * FROM User WHERE name = 'David'\uff0c\n</code></pre> <p>\u901a\u8fc7\u4e8c\u7ea7\u7d22\u5f15 idx_name \u53ea\u80fd\u5b9a\u4f4d\u4e3b\u952e\u503c\uff0c\u9700\u8981\u989d\u5916\u518d\u901a\u8fc7\u4e3b\u952e\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2\uff0c\u624d\u80fd\u5f97\u5230\u6700\u7ec8\u7684\u7ed3\u679c\u3002</p> <p>\u8fd9\u79cd\u201c\u4e8c\u7ea7\u7d22\u5f15\u901a\u8fc7\u4e3b\u952e\u7d22\u5f15\u8fdb\u884c\u518d\u4e00\u6b21\u67e5\u8be2\u201d\u7684\u64cd\u4f5c\u53eb\u4f5c\u201c\u56de\u8868\u201d\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u56fe\u7406\u89e3\u4e8c\u7ea7\u7d22\u5f15\u7684\u67e5\u8be2\uff1a</p> <p></p> <p>\u7d22\u5f15\u7ec4\u7ec7\u8868\u8fd9\u6837\u7684\u4e8c\u7ea7\u7d22\u5f15\u8bbe\u8ba1\u6709\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u597d\u5904\uff1a\u82e5\u8bb0\u5f55\u53d1\u751f\u4e86\u4fee\u6539\uff0c\u5219\u5176\u4ed6\u7d22\u5f15\u65e0\u987b\u8fdb\u884c\u7ef4\u62a4\uff0c\u9664\u975e\u8bb0\u5f55\u7684\u4e3b\u952e\u53d1\u751f\u4e86\u4fee\u6539\u3002</p> <p>\u201c\u7d22\u5f15\u7ec4\u7ec7\u8868\uff0c\u6570\u636e\u5373\u7d22\u5f15\uff0c\u7d22\u5f15\u5373\u6570\u636e\u201d\u3002\u90a3\u4e48\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\u4e8c\u7ea7\u7d22\u5f15\uff0c\u4f60\u53ef\u4ee5\u5c06\u4e8c\u7ea7\u7d22\u5f15\u6309\u7167\u4e00\u5f20\u8868\u6765\u8fdb\u884c\u7406\u89e3\uff0c\u6bd4\u5982\u7d22\u5f15 idx_name \u53ef\u4ee5\u7406\u89e3\u6210\u4e00\u5f20\u8868</p> <pre><code>CREATE TABLE idx_name (\n\n    name VARCHAR(128) NOT NULL,\n\n    id BIGINT NOT NULL,\n\n    PRIAMRY KEY(name,id)\n\n)\n</code></pre> <p>\u6839\u636e name \u8fdb\u884c\u67e5\u8be2\u7684 SQL \u53ef\u4ee5\u7406\u89e3\u4e3a\u62c6\u5206\u6210\u4e86\u4e24\u4e2a\u6b65\u9aa4\uff1a</p> <pre><code>SELECT id FROM idx_name WHERE name = ?\n\nSELECT * FROM User WHERE id = _id; -- \u56de\u8868\n</code></pre> <p>\u5f53\u7136\uff0c\u5bf9\u4e8e\u7d22\u5f15\uff0c\u8fd8\u53ef\u4ee5\u52a0\u5165\u552f\u4e00\u7684\u7ea6\u675f\uff0c\u5177\u6709\u552f\u4e00\u7ea6\u675f\u7684\u7d22\u5f15\u79f0\u4e4b\u4e3a\u552f\u4e00\u7d22\u5f15\uff0c\u4e5f\u662f\u4e8c\u7ea7\u7d22\u5f15\u3002</p> <p>\u5bf9\u4e8e\u8868 User\uff0c\u5217 name \u5e94\u8be5\u5177\u6709\u552f\u4e00\u7ea6\u675f\uff0c\u56e0\u4e3a\u901a\u5e38\u7528\u6237\u6ce8\u518c\u901a\u5e38\u8981\u6c42\u6635\u79f0\u552f\u4e00\uff0c\u6240\u4ee5\u8868User \u5b9a\u4e49\u66f4\u65b0\u4e3a\uff1a</p> <pre><code>\n    PRIMARY KEY(id), -- \u4e3b\u952e\u7d22\u5f15\n\n    UNIQUE KEY idx_name(name) -- \u4e8c\u7ea7\u7d22\u5f15\n\n</code></pre> <p>\u90a3\u4e48\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u53c8\u8be5\u5982\u4f55\u7406\u89e3\u4e3a\u8868\u5462\uff1f \u5176\u5b9e\u6211\u4eec\u53ef\u4ee5\u5c06\u7ea6\u675f\u7406\u89e3\u6210\u4e00\u5f20\u8868\u6216\u4e00\u4e2a\u7d22\u5f15\uff0c\u6545\u552f\u4e00\u7d22\u5f15 idx_name \u5e94\u8be5\u7406\u89e3\u4e3a\uff1a</p> <pre><code>CREATE TABLE idx_name (\n\n    name VARCHAR(128) NOT NULL,\n\n    id BIGINT NOT NULL,\n\n    PRIAMRY KEY(name,id)\n\n) -- \u4e8c\u7ea7\u7d22\u5f15\n\n\nCREATE TABLE check_idx_name (\n\n    name VARCHAR(128),\n\n    PRIMARY KEY(name)\uff0c\n\n) -- \u552f\u4e00\u7ea6\u675f\n</code></pre> <p>\u5728\u7d22\u5f15\u7ec4\u7ec7\u8868\u4e2d\uff0c\u4e07\u7269\u7686\u7d22\u5f15\uff0c\u7d22\u5f15\u5c31\u662f\u6570\u636e\uff0c\u6570\u636e\u5c31\u662f\u7d22\u5f15\u3002</p> <p>\u5806\u8868\u4e2d\u7684\u7d22\u5f15\u90fd\u662f\u4e8c\u7ea7\u7d22\u5f15\uff0c\u54ea\u6015\u662f\u4e3b\u952e\u7d22\u5f15\u4e5f\u662f\u4e8c\u7ea7\u7d22\u5f15\uff0c\u4e5f\u5c31\u662f\u8bf4\u5b83\u6ca1\u6709\u805a\u96c6\u7d22\u5f15\uff0c\u6bcf\u6b21\u7d22\u5f15\u67e5\u8be2\u90fd\u8981\u56de\u8868\u3002</p> <p>\u540c\u65f6\uff0c\u5806\u8868\u4e2d\u7684\u8bb0\u5f55\u5168\u90e8\u5b58\u653e\u5728\u6570\u636e\u6587\u4ef6\u4e2d\uff0c\u5e76\u4e14\u65e0\u5e8f\u5b58\u653e\uff0c\u8fd9\u5bf9\u4e92\u8054\u7f51\u6d77\u91cf\u5e76\u53d1\u7684 OLTP \u4e1a\u52a1\u6765\u8bf4\uff0c\u5806\u8868\u7684\u5b9e\u73b0\u7684\u786e\u201c\u8fc7\u65f6\u201d\u4e86\u3002</p>"},{"location":"chap2_opt/3table_index/#2-3","title":"2-3 \u51fd\u6570\u7d22\u5f15","text":"<p>\u4ece MySQL 5.7 \u7248\u672c\u5f00\u59cb\uff0cMySQL \u5c31\u5f00\u59cb\u652f\u6301\u521b\u5efa\u51fd\u6570\u7d22\u5f15 \uff08\u5373\u7d22\u5f15\u952e\u662f\u4e00\u4e2a\u51fd\u6570\u8868\u8fbe\u5f0f\uff09\u3002 \u51fd\u6570\u7d22\u5f15\u6709\u4e24\u5927\u7528\u5904\uff1a</p> <ul> <li>\u4f18\u5316\u4e1a\u52a1 SQL \u6027\u80fd\uff1b</li> <li>\u914d\u5408\u865a\u62df\u5217\uff08Generated Column\uff09\u3002</li> </ul> <p>\u4f60\u5e94\u8be5\u4e86\u89e3\u5230MySQL InnoDB \u5b58\u50a8\u5f15\u64ce\u662f\u7d22\u5f15\u7ec4\u7ec7\u8868\uff0c\u4ee5\u53ca\u7d22\u5f15\u7ec4\u7ec7\u8868\u548c\u5806\u8868\u4e4b\u95f4\u7684\u533a\u522b\u3002</p> <ul> <li>\u7d22\u5f15\u7ec4\u7ec7\u8868\u4e3b\u952e\u662f\u805a\u96c6\u7d22\u5f15\uff0c\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5b58\u653e\u8868\u4e2d\u4e00\u6574\u884c\u5b8c\u6574\u8bb0\u5f55\uff1b</li> <li>\u9664\u4e3b\u952e\u7d22\u5f15\u5916\u7684\u7d22\u5f15\u90fd\u662f\u4e8c\u7ea7\u7d22\u5f15\uff0c\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5b58\u653e\u7684\u662f\uff08\u7d22\u5f15\u952e\u503c\uff0c\u4e3b\u952e\u503c\uff09\uff1b</li> <li>\u7531\u4e8e\u4e8c\u7ea7\u7d22\u5f15\u4e0d\u5b58\u653e\u5b8c\u6574\u8bb0\u5f55\uff0c\u56e0\u6b64\u9700\u8981\u901a\u8fc7\u4e3b\u952e\u503c\u518d\u8fdb\u884c\u4e00\u6b21\u56de\u8868\u624d\u80fd\u5b9a\u4f4d\u5230\u5b8c\u6574\u6570\u636e\uff1b</li> <li>\u7d22\u5f15\u7ec4\u7ec7\u8868\u5bf9\u6bd4\u5806\u8868\uff0c\u5728\u6d77\u91cf\u5e76\u53d1\u7684OLTP\u4e1a\u52a1\u4e2d\u80fd\u6709\u66f4\u597d\u7684\u6027\u80fd\u8868\u73b0\uff1b</li> <li>\u6bcf\u79cd\u4e0d\u540c\u6570\u636e\uff0c\u5bf9\u4e8c\u7ea7\u7d22\u5f15\u7684\u6027\u80fd\u5f00\u9500\u5f71\u54cd\u662f\u4e0d\u4e00\u6837\u7684\uff1b</li> <li>\u6709\u65f6\u901a\u8fc7\u51fd\u6570\u7d22\u5f15\u53ef\u4ee5\u5feb\u901f\u89e3\u51b3\u7ebf\u4e0aSQL\u7684\u6027\u80fd\u95ee\u9898\uff1b</li> <li>\u865a\u62df\u5217\u4e0d\u5360\u7528\u5b9e\u9645\u5b58\u50a8\u7a7a\u95f4\uff0c\u5728\u865a\u62df\u5217\u4e0a\u521b\u5efa\u7d22\u5f15\u672c\u8d28\u5c31\u662f\u51fd\u6570\u7d22\u5f15\u3002</li> </ul>"},{"location":"chap2_opt/3table_index/#3","title":"3 \u7ec4\u5408\u7d22\u5f15","text":""},{"location":"chap2_opt/3table_index/#3-1","title":"3-1 \u7ec4\u5408\u7d22\u5f15","text":"<p>\u7ec4\u5408\u7d22\u5f15\uff08Compound Index\uff09\u662f\u6307\u7531\u591a\u4e2a\u5217\u6240\u7ec4\u5408\u800c\u6210\u7684 B+\u6811\u7d22\u5f15\uff0c\u8fd9\u548c\u6211\u4eec\u4e4b\u524d\u4ecb\u7ecd\u7684B+ \u6811\u7d22\u5f15\u7684\u539f\u7406\u5b8c\u5168\u4e00\u6837\uff0c\u53ea\u662f\u4e4b\u524d\u662f\u5bf9\u4e00\u4e2a\u5217\u6392\u5e8f\uff0c\u73b0\u5728\u662f\u5bf9\u591a\u4e2a\u5217\u6392\u5e8f\u3002</p> <p>\u7ec4\u5408\u7d22\u5f15\u65e2\u53ef\u4ee5\u662f\u4e3b\u952e\u7d22\u5f15\uff0c\u4e5f\u53ef\u4ee5\u662f\u4e8c\u7ea7\u7d22\u5f15\uff0c\u4e0b\u56fe\u663e\u793a\u7684\u662f\u4e00\u4e2a\u4e8c\u7ea7\u7ec4\u5408\u7d22\u5f15\uff1a</p> <p> </p> <p>\u7ec4\u5408\u7d22\u5f15\u7684 B+ \u6811\u7ed3\u6784</p>"},{"location":"chap2_opt/3table_index/#3-2","title":"3-2 \u5f52\u7eb3\u7ec4\u5408\u7d22\u5f15\u7684\u4e09\u5927\u4f18\u52bf","text":"<ul> <li>\u8986\u76d6\u591a\u4e2a\u67e5\u8be2\u6761\u4ef6\uff0c\u5982\uff08a\uff0cb\uff09\u7d22\u5f15\u53ef\u4ee5\u8986\u76d6\u67e5\u8be2 <code>a = ?</code>\u6216\u8005 <code>a = ?</code> and <code>b = ?</code>\uff1b</li> <li>\u907f\u514d SQL \u7684\u989d\u5916\u6392\u5e8f\uff0c\u63d0\u5347 SQL \u6027\u80fd\uff0c\u5982 <code>WHERE a = ? ORDER BY b</code>\u8fd9\u6837\u7684\u67e5\u8be2\u6761\u4ef6\uff1b</li> <li>\u5229\u7528\u7ec4\u5408\u7d22\u5f15\u5305\u542b\u591a\u4e2a\u5217\u7684\u7279\u6027\uff0c\u53ef\u4ee5\u5b9e\u73b0\u7d22\u5f15\u8986\u76d6\u6280\u672f\uff0c\u63d0\u5347 SQL \u7684\u67e5\u8be2\u6027\u80fd\uff0c\u7528\u597d\u7d22\u5f15\u8986\u76d6\u6280\u672f\uff0c\u6027\u80fd\u63d0\u5347 10 \u500d\u4e0d\u662f\u96be\u4e8b\u3002</li> </ul>"},{"location":"chap2_opt/3table_index/#4","title":"4 \u7d22\u5f15\u51fa\u9519","text":"<p>MySQL \u5e76\u6ca1\u6709\u6309\u7167\u81ea\u5df1\u7684\u9884\u60f3\u6765\u9009\u62e9\u7d22\u5f15\uff0c\u6bd4\u5982\u521b\u5efa\u4e86\u7d22\u5f15\u4f46\u662f\u9009\u62e9\u4e86\u5168\u8868\u626b\u63cf\uff0c\u8fd9\u80af\u5b9a\u662f MySQL \u6570\u636e\u5e93\u7684 Bug\uff0c\u6216\u8005\u662f\u7d22\u5f15\u51fa\u9519\u4e86\u3002</p> <p>\u5f53\u7136\u4e0d\u662f\uff01 \u8fd9\u4e3b\u8981\u56e0\u4e3a\u7d22\u5f15\u4e2d\u7684\u6570\u636e\u72af\u4e86\u9519\u3002</p> <p>\u8868 orders \u4e2d\uff0c\u5bf9\u4e8e\u5b57\u6bb5 o_custkey \u5df2\u7ecf\u521b\u5efa\u4e86\u76f8\u5173\u7684 3 \u4e2a\u7d22\u5f15\uff0c\u6240\u4ee5\u73b0\u5728\u8868 orders \u7684\u60c5\u51b5\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>...\nCREATE TABLE `orders` (\n...\n  PRIMARY KEY (`O_ORDERKEY`),\n\n  KEY `idx_custkey_orderdate` (`O_CUSTKEY`,`O_ORDERDATE`),\n\n  KEY `ORDERS_FK1` (`O_CUSTKEY`),\n\n  KEY `idx_custkey_orderdate_totalprice` (`O_CUSTKEY`,`O_ORDERDATE`,`O_TOTALPRICE`),\n\n  CONSTRAINT `orders_ibfk_1` FOREIGN KEY (`O_CUSTKEY`) REFERENCES `customer` (`C_CUSTKEY`)\n\n) ENGINE=InnoDB\n</code></pre> <p>\u5728\u67e5\u8be2\u5b57\u6bb5 o_custkey \u65f6\uff0c\u7406\u8bba\u4e0a\u53ef\u4ee5\u4f7f\u7528\u4e09\u4e2a\u76f8\u5173\u7684\u7d22\u5f15\uff1a<code>ORDERS_FK1</code>\u3001<code>idx_custkey_orderdate</code>\u3001<code>idx_custkey_orderdate_totalprice</code>\u3002\u90a3 MySQL \u4f18\u5316\u5668\u662f\u600e\u4e48\u4ece\u8fd9\u4e09\u4e2a\u7d22\u5f15\u4e2d\u8fdb\u884c\u9009\u62e9\u7684\u5462\uff1f</p> <p>\u5728\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\uff0cB+ \u6811\u7d22\u5f15\u53ea\u662f\u5b58\u50a8\u7684\u4e00\u79cd\u6570\u636e\u7ed3\u6784\uff0c\u5177\u4f53\u600e\u4e48\u4f7f\u7528\uff0c\u8fd8\u8981\u4f9d\u8d56\u6570\u636e\u5e93\u7684\u4f18\u5316\u5668\uff0c\u4f18\u5316\u5668\u51b3\u5b9a\u4e86\u5177\u4f53\u67d0\u4e00\u7d22\u5f15\u7684\u9009\u62e9\uff0c\u4e5f\u5c31\u662f\u5e38\u8bf4\u7684\u6267\u884c\u8ba1\u5212\u3002</p> <p>\u800c\u4f18\u5316\u5668\u7684\u9009\u62e9\u662f\u57fa\u4e8e\u6210\u672c\uff08cost\uff09\uff0c\u54ea\u4e2a\u7d22\u5f15\u7684\u6210\u672c\u8d8a\u4f4e\uff0c\u4f18\u5148\u4f7f\u7528\u54ea\u4e2a\u7d22\u5f15\u3002</p> <p> </p> <p>MySQL \u6267\u884c\u8fc7\u7a0b</p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0cMySQL \u6570\u636e\u5e93\u7531 Server \u5c42\u548c Engine \u5c42\u7ec4\u6210\uff1a</p> <ul> <li>Server \u5c42\u6709 SQL \u5206\u6790\u5668\u3001SQL\u4f18\u5316\u5668\u3001SQL \u6267\u884c\u5668\uff0c\u7528\u4e8e\u8d1f\u8d23 SQL \u8bed\u53e5\u7684\u5177\u4f53\u6267\u884c\u8fc7\u7a0b\uff1b</li> <li>Engine \u5c42\u8d1f\u8d23\u5b58\u50a8\u5177\u4f53\u7684\u6570\u636e\uff0c\u5982\u6700\u5e38\u4f7f\u7528\u7684 InnoDB \u5b58\u50a8\u5f15\u64ce\uff0c\u8fd8\u6709\u7528\u4e8e\u5728\u5185\u5b58\u4e2d\u5b58\u50a8\u4e34\u65f6\u7ed3\u679c\u96c6\u7684 TempTable \u5f15\u64ce</li> </ul> <p>SQL \u4f18\u5316\u5668\u4f1a\u5206\u6790\u6240\u6709\u53ef\u80fd\u7684\u6267\u884c\u8ba1\u5212\uff0c\u9009\u62e9\u6210\u672c\u6700\u4f4e\u7684\u6267\u884c\uff0c\u8fd9\u79cd\u4f18\u5316\u5668\u79f0\u4e4b\u4e3a\uff1aCBO\uff08Cost-based Optimizer\uff0c\u57fa\u4e8e\u6210\u672c\u7684\u4f18\u5316\u5668\uff09\u3002</p> <p>\u800c\u5728 MySQL\u4e2d\uff0c\u4e00\u6761 SQL \u7684\u8ba1\u7b97\u6210\u672c\u8ba1\u7b97\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>Cost  = Server Cost + Engine Cost\n\n      = CPU Cost + IO Cost\n</code></pre> <p>\u5176\u4e2d\uff0cCPU Cost \u8868\u793a\u8ba1\u7b97\u7684\u5f00\u9500\uff0c\u6bd4\u5982\u7d22\u5f15\u952e\u503c\u7684\u6bd4\u8f83\u3001\u8bb0\u5f55\u503c\u7684\u6bd4\u8f83\u3001\u7ed3\u679c\u96c6\u7684\u6392\u5e8f\u2026\u2026\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u5728 Server \u5c42\u5b8c\u6210\uff1b</p> <p>IO Cost \u8868\u793a\u5f15\u64ce\u5c42 IO \u7684\u5f00\u9500\uff0cMySQL 8.0 \u53ef\u4ee5\u901a\u8fc7\u533a\u5206\u4e00\u5f20\u8868\u7684\u6570\u636e\u662f\u5426\u5728\u5185\u5b58\u4e2d\uff0c\u5206\u522b\u8ba1\u7b97\u8bfb\u53d6\u5185\u5b58 IO \u5f00\u9500\u4ee5\u53ca\u8bfb\u53d6\u78c1\u76d8 IO \u7684\u5f00\u9500\u3002</p> <p>\u6570\u636e\u5e93 mysql \u4e0b\u7684\u8868 <code>server_cost</code>\u3001<code>engine_cost</code> \u5219\u8bb0\u5f55\u4e86\u5bf9\u4e8e\u5404\u79cd\u6210\u672c\u7684\u8ba1\u7b97\uff0c\u5982\uff1a</p> <p> </p> <p>\u8868 <code>server_cost</code> \u8bb0\u5f55\u4e86 Server \u5c42\u4f18\u5316\u5668\u5404\u79cd\u64cd\u4f5c\u7684\u6210\u672c\uff0c\u8fd9\u91cc\u9762\u5305\u62ec\u4e86\u6240\u6709 CPU Cost\uff0c\u5176\u5177\u4f53\u542b\u4e49\u5982\u4e0b\u3002</p> <ul> <li><code>disk_temptable_create_cost</code>\uff1a\u521b\u5efa\u78c1\u76d8\u4e34\u65f6\u8868\u7684\u6210\u672c\uff0c\u9ed8\u8ba4\u4e3a20\u3002</li> <li><code>disk_temptable_row_cost</code>\uff1a\u78c1\u76d8\u4e34\u65f6\u8868\u4e2d\u6bcf\u6761\u8bb0\u5f55\u7684\u6210\u672c\uff0c\u9ed8\u8ba4\u4e3a0.5\u3002</li> <li><code>key_compare_cost</code>\uff1a\u7d22\u5f15\u952e\u503c\u6bd4\u8f83\u7684\u6210\u672c\uff0c\u9ed8\u8ba4\u4e3a0.05\uff0c\u6210\u672c\u6700\u5c0f\u3002</li> <li><code>memory_temptable_create_cost</code>\uff1a\u521b\u5efa\u5185\u5b58\u4e34\u65f6\u8868\u7684\u6210\u672c\uff1a\u9ed8\u8ba4\u4e3a1\u3002</li> <li><code>memory_temptable_row_cost</code>\uff1a\u5185\u5b58\u4e34\u65f6\u8868\u4e2d\u6bcf\u6761\u8bb0\u5f55\u7684\u6210\u672c\uff0c\u9ed8\u8ba4\u4e3a0.1\u3002</li> <li><code>row_evaluate_cost</code>\uff1a\u8bb0\u5f55\u95f4\u7684\u6bd4\u8f83\u6210\u672c\uff0c\u9ed8\u8ba4\u4e3a0.1\u3002</li> </ul> <p>\u53ef\u4ee5\u770b\u5230\uff0c MySQL \u4f18\u5316\u5668\u8ba4\u4e3a\u5982\u679c\u4e00\u6761 SQL \u9700\u8981\u521b\u5efa\u57fa\u4e8e\u78c1\u76d8\u7684\u4e34\u65f6\u8868\uff0c\u5219\u8fd9\u65f6\u7684\u6210\u672c\u662f\u6700\u5927\u7684\uff0c\u5176\u6210\u672c\u662f\u57fa\u4e8e\u5185\u5b58\u4e34\u65f6\u8868\u7684 20 \u500d\u3002</p> <p>\u800c\u8868 <code>engine_cost</code> \u8bb0\u5f55\u4e86\u5b58\u50a8\u5f15\u64ce\u5c42\u5404\u79cd\u64cd\u4f5c\u7684\u6210\u672c\uff0c\u8fd9\u91cc\u5305\u542b\u4e86\u6240\u6709\u7684 IO Cost\uff0c\u5177\u4f53\u542b\u4e49\u5982\u4e0b\u3002</p> <p>\u800c\u8868 engine_cost \u8bb0\u5f55\u4e86\u5b58\u50a8\u5f15\u64ce\u5c42\u5404\u79cd\u64cd\u4f5c\u7684\u6210\u672c\uff0c\u8fd9\u91cc\u5305\u542b\u4e86\u6240\u6709\u7684 IO Cost\uff0c\u5177\u4f53\u542b\u4e49\u5982\u4e0b\u3002</p> <ul> <li><code>io_block_read_cost</code>\uff1a\u4ece\u78c1\u76d8\u8bfb\u53d6\u4e00\u4e2a\u9875\u7684\u6210\u672c\uff0c\u9ed8\u8ba4\u503c\u4e3a1\u3002</li> <li><code>memory_block_read_cost</code>\uff1a\u4ece\u5185\u5b58\u8bfb\u53d6\u4e00\u4e2a\u9875\u7684\u6210\u672c\uff0c\u9ed8\u8ba4\u503c\u4e3a0.25\u3002</li> </ul> <p>\u4e5f\u5c31\u662f\u8bf4\uff0c MySQL \u4f18\u5316\u5668\u8ba4\u4e3a\u4ece\u78c1\u76d8\u8bfb\u53d6\u7684\u5f00\u9500\u662f\u5185\u5b58\u5f00\u9500\u7684 4 \u500d\u3002</p>"},{"location":"chap2_opt/3table_index/#mysql","title":"MySQL\u7d22\u5f15\u51fa\u9519\u6848\u4f8b\u5206\u6790","text":"<p>\u6848\u4f8b1\uff1a\u672a\u80fd\u4f7f\u7528\u521b\u5efa\u7684\u7d22\u5f15</p> <p>\u7ecf\u5e38\u542c\u5230\u6709\u540c\u5b66\u53cd\u9988 MySQL \u4f18\u5316\u5668\u4e0d\u51c6\uff0c\u4e0d\u7a33\u5b9a\uff0c\u4e00\u76f4\u5728\u53d8\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u60f3\u544a\u8bc9\u4f60\u7684\u662f\uff0cMySQL \u4f18\u5316\u5668\u6c38\u8fdc\u662f\u6839\u636e\u6210\u672c\uff0c\u9009\u62e9\u51fa\u6700\u4f18\u7684\u6267\u884c\u8ba1\u5212\u3002\u54ea\u6015\u662f\u540c\u4e00\u6761 SQL \u8bed\u53e5\uff0c\u53ea\u8981\u8303\u56f4\u4e0d\u540c\uff0c\u4f18\u5316\u5668\u7684\u9009\u62e9\u4e5f\u53ef\u80fd\u4e0d\u540c\u3002</p> <pre><code>EXPLAIN SELECT * FROM orders \n\nWHERE o_orderdate &gt; '1994-01-01' \n\nAND o_orderdate &lt; '1994-12-31'\\G\n</code></pre> <pre><code>EXPLAIN FORMAT=tree \n\nSELECT * FROM orders \n\nWHERE o_orderdate &gt; '1994-01-01' \n\nAND o_orderdate &lt; '1994-12-31'\\G\n\n*************************** 1. row ***************************\n\nEXPLAIN: -&gt; Filter: ((orders.O_ORDERDATE &gt; DATE'1994-01-01') and (orders.O_ORDERDATE &lt; DATE'1994-12-31'))  (cost=592267.11 rows=1876082)\n\n    -&gt; Table scan on orders  (cost=592267.11 rows=5799601)\n</code></pre> <pre><code>EXPLAIN FORMAT=tree \n\nSELECT * FROM orders FORCE INDEX(idx_orderdate)\n\nWHERE o_orderdate &gt; '1994-01-01' \n\nAND o_orderdate &lt; '1994-12-31'\\G\n\n*************************** 1. row ***************************\n\nEXPLAIN: -&gt; Index range scan on orders using idx_orderdate, with index condition: ((orders.O_ORDERDATE &gt; DATE'1994-01-01') and (orders.O_ORDERDATE &lt; DATE'1994-12-31'))  (cost=844351.87 rows=1876082)\n</code></pre>"},{"location":"chap2_opt/3table_index/#_1","title":"\u603b\u7ed3","text":"<p>\u6211\u4eec\u77e5\u9053\u4e86 MySQL \u4f18\u5316\u5668\u662f CBO\uff0c\u5373\u4e00\u79cd\u57fa\u4e8e\u6210\u672c\u7684\u4f18\u5316\u5668\u3002</p> <ul> <li>MySQL \u4f18\u5316\u5668\u662f CBO \u7684\uff1b</li> <li>MySQL \u4f1a\u9009\u62e9\u6210\u672c\u6700\u4f4e\u7684\u6267\u884c\u8ba1\u5212\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7 EXPLAIN \u547d\u4ee4\u67e5\u770b\u6bcf\u4e2a SQL \u7684\u6210\u672c\uff1b</li> <li>\u4e00\u822c\u53ea\u5bf9\u9ad8\u9009\u62e9\u5ea6\u7684\u5b57\u6bb5\u548c\u5b57\u6bb5\u7ec4\u5408\u521b\u5efa\u7d22\u5f15\uff0c\u4f4e\u9009\u62e9\u5ea6\u7684\u5b57\u6bb5\u5982\u6027\u522b\uff0c\u4e0d\u521b\u5efa\u7d22\u5f15\uff1b</li> <li>\u4f4e\u9009\u62e9\u6027\uff0c\u4f46\u662f\u6570\u636e\u5b58\u5728\u503e\u659c\uff0c\u901a\u8fc7\u7d22\u5f15\u627e\u51fa\u5c11\u90e8\u5206\u6570\u636e\uff0c\u53ef\u4ee5\u8003\u8651\u521b\u5efa\u7d22\u5f15\uff1b</li> <li>\u82e5\u6570\u636e\u5b58\u5728\u503e\u659c\uff0c\u53ef\u4ee5\u521b\u5efa\u76f4\u65b9\u56fe\uff0c\u8ba9\u4f18\u5316\u5668\u77e5\u9053\u7d22\u5f15\u4e2d\u6570\u636e\u7684\u5206\u5e03\uff0c\u8fdb\u4e00\u6b65\u6821\u51c6\u6267\u884c\u8ba1\u5212</li> </ul>"},{"location":"chap2_opt/4table_query/","title":"L4 \u67e5\u8be2\u4f18\u5316","text":""},{"location":"chap2_opt/4table_query/#1-join","title":"1 JOIN \u8fde\u63a5","text":"<p>\u9664\u4e86\u5355\u8868\u7684 SQL \u8bed\u53e5\uff0c\u8fd8\u6709\u4e24\u5927\u7c7b\u76f8\u5bf9\u590d\u6742\u7684 SQL\uff0c\u591a\u8868 JOIN \u548c\u5b50\u67e5\u8be2\u8bed\u53e5\uff0c\u8fd9\u5c31\u8981\u5728\u591a\u5f20\u8868\u4e0a\u521b\u5efa\u7d22\u5f15\uff0c\u96be\u5ea6\u76f8\u5bf9\u63d0\u5347\u4e0d\u5c11\u3002</p> <p>\u800c\u5f88\u591a\u5f00\u53d1\u4eba\u5458\u4e0b\u610f\u8bc6\u5730\u8ba4\u4e3a JOIN \u4f1a\u964d\u4f4e SQL \u7684\u6027\u80fd\u6548\u7387\uff0c\u6240\u4ee5\u5c31\u5c06\u4e00\u6761\u591a\u8868 SQL \u62c6\u6210\u5355\u8868\u7684\u4e00\u6761\u6761\u67e5\u8be2\uff0c\u4f46\u8fd9\u6837\u53cd\u800c\u4f1a\u5f71\u54cd SQL \u6267\u884c\u7684\u6548\u7387\u3002\u7a76\u5176\u539f\u56e0\uff0c\u5728\u4e8e\u5f00\u53d1\u4eba\u5458\u4e0d\u4e86\u89e3 JOIN \u7684\u5b9e\u73b0\u8fc7\u7a0b\u3002</p>"},{"location":"chap2_opt/4table_query/#1-1-join","title":"1-1 JOIN\u8fde\u63a5\u7b97\u6cd5","text":"<p>MySQL 8.0 \u7248\u672c\u652f\u6301\u4e24\u79cd JOIN \u7b97\u6cd5\u7528\u4e8e\u8868\u4e4b\u95f4\u7684\u5173\u8054\uff1a Nested Loop Join / Hash Join\u3002</p> <p>\u901a\u5e38\u8ba4\u4e3a\uff0c\u5728 OLTP \u4e1a\u52a1\u4e2d\uff0c\u56e0\u4e3a\u67e5\u8be2\u6570\u636e\u91cf\u8f83\u5c0f\u3001\u8bed\u53e5\u76f8\u5bf9\u7b80\u5355\uff0c\u5927\u591a\u4f7f\u7528\u7d22\u5f15\u8fde\u63a5\u8868\u4e4b\u95f4\u7684\u6570\u636e\u3002 \u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f18\u5316\u5668\u5927\u591a\u4f1a\u7528 Nested Loop Join \u7b97\u6cd5\uff1b</p> <p>\u800c OLAP \u4e1a\u52a1\u4e2d\u7684\u67e5\u8be2\u6570\u636e\u91cf\u8f83\u5927\uff0c\u5173\u8054\u8868\u7684\u6570\u91cf\u975e\u5e38\u591a\uff0c\u6240\u4ee5\u7528 Hash Join \u7b97\u6cd5\uff0c\u76f4\u63a5\u626b\u63cf\u5168\u8868\u6548\u7387\u4f1a\u66f4\u9ad8\u3002</p>"},{"location":"chap2_opt/4table_query/#nested-loop-join","title":"Nested Loop Join","text":"<p>\u5728\u4e0a\u8ff0\u7b97\u6cd5\u4e2d\uff0c\u8868 R \u88ab\u79f0\u4e3a\u9a71\u52a8\u8868\uff0c\u8868 R \u4e2d\u901a\u8fc7 WHERE \u6761\u4ef6\u8fc7\u6ee4\u51fa\u7684\u6570\u636e\u4f1a\u5728\u8868 S \u5bf9\u5e94\u7684\u7d22\u5f15\u4e0a\u8fdb\u884c\u4e00\u4e00\u67e5\u8be2\u3002\u5982\u679c\u9a71\u52a8\u8868 R \u7684\u6570\u636e\u91cf\u4e0d\u5927\uff0c\u4e0a\u8ff0\u7b97\u6cd5\u975e\u5e38\u9ad8\u6548\u3002</p> <p>\u63a5\u7740\uff0c\u6211\u4eec\u770b\u4e00\u4e0b\uff0c\u4ee5\u4e0b\u4e09\u79cd JOIN \u7c7b\u578b\uff0c\u9a71\u52a8\u8868\u5404\u662f\u54ea\u5f20\u8868\uff1a</p> <pre><code>SELECT ... FROM R LEFT JOIN S ON R.x = S.x WEHRE ...\n\nSELECT ... FROM R RIGHT JOIN S ON R.x = S.x WEHRE ...\n\nSELECT ... FROM R INNER JOIN S ON R.x = S.x WEHRE ...\n</code></pre> <ul> <li>\u5bf9\u4e8e\u4e0a\u8ff0 Left Join \u6765\u8bf4\uff0c\u9a71\u52a8\u8868\u5c31\u662f\u5de6\u8868 R\uff1b</li> <li>Right Join\u4e2d\uff0c\u9a71\u52a8\u8868\u5c31\u662f\u53f3\u8868 S\u3002\u8fd9\u662f JOIN \u7c7b\u578b\u51b3\u5b9a\u5de6\u8868\u6216\u53f3\u8868\u7684\u6570\u636e\u4e00\u5b9a\u8981\u8fdb\u884c\u67e5\u8be2\u3002</li> <li>\u4f46\u5bf9\u4e8e INNER JOIN\uff0c\u9a71\u52a8\u8868\u53ef\u80fd\u662f\u8868 R\uff0c\u4e5f\u53ef\u80fd\u662f\u8868 S\u3002</li> </ul> <p>\u5728\u8fd9\u79cd\u573a\u666f\u4e0b\uff0c\u8c01\u9700\u8981\u67e5\u8be2\u7684\u6570\u636e\u91cf\u8d8a\u5c11\uff0c\u8c01\u5c31\u662f\u9a71\u52a8\u8868\u3002 </p> <pre><code>SELECT ... FROM R INNER JOIN S \n\nON R.x = S.x \n\nWHERE R.y = ? AND S.z = ?\n</code></pre> <p>\u4e0a\u9762\u8fd9\u6761 SQL \u8bed\u53e5\u662f\u5bf9\u8868 R \u548c\u8868 S \u8fdb\u884c INNER JOIN\uff0c\u5176\u4e2d\u5173\u8054\u7684\u5217\u662f x\uff0cWHERE \u8fc7\u6ee4\u6761\u4ef6\u5206\u522b\u8fc7\u6ee4\u8868 R \u4e2d\u7684\u5217 y \u548c\u8868 S \u4e2d\u7684\u5217 z\u3002\u90a3\u4e48\u8fd9\u79cd\u60c5\u51b5\u4e0b\u53ef\u4ee5\u6709\u4ee5\u4e0b\u4e24\u79cd\u9009\u62e9\uff1a</p> <p></p> <p>\u4f18\u5316\u5668\u4e00\u822c\u8ba4\u4e3a\uff0c\u901a\u8fc7\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2\u7684\u6548\u7387\u90fd\u4e00\u6837\uff0c\u6240\u4ee5 Nested Loop Join \u7b97\u6cd5\u4e3b\u8981\u8981\u6c42\u9a71\u52a8\u8868\u7684\u6570\u91cf\u8981\u5c3d\u53ef\u80fd\u5c11\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c<code>WHERE R.y = ?</code> \u8fc7\u6ee4\u51fa\u7684\u6570\u636e\u5c11\uff0c\u90a3\u4e48\u8fd9\u6761 SQL \u8bed\u53e5\u4f1a\u5148\u4f7f\u7528\u8868 R \u4e0a\u5217 y \u4e0a\u7684\u7d22\u5f15\uff0c\u7b5b\u9009\u51fa\u6570\u636e\uff0c\u7136\u540e\u518d\u4f7f\u7528\u8868 <code>S</code> \u4e0a\u5217 <code>x</code>\u7684\u7d22\u5f15\u8fdb\u884c\u5173\u8054\uff0c\u6700\u540e\u518d\u901a\u8fc7 <code>WHERE S.z = ?</code> \u8fc7\u6ee4\u51fa\u6700\u540e\u6570\u636e\u3002</p>"},{"location":"chap2_opt/4table_query/#1-2-hash-join","title":"1-2 Hash Join","text":"<p>MySQL \u4e2d\u7684\u7b2c\u4e8c\u79cd JOIN \u7b97\u6cd5\u662f Hash Join\uff0c\u7528\u4e8e\u4e24\u5f20\u8868\u4e4b\u95f4\u8fde\u63a5\u6761\u4ef6\u6ca1\u6709\u7d22\u5f15\u7684\u60c5\u51b5\u3002</p> <p>\u6ca1\u6709\u8fde\u63a5\uff0c\u90a3\u521b\u5efa\u7d22\u5f15\u4e0d\u5c31\u53ef\u4ee5\u4e86\u5417\uff1f\u6216\u8bb8\u53ef\u4ee5\uff0c\u4f46\uff1a</p> <ul> <li>\u5982\u679c\u6709\u4e9b\u5217\u662f\u4f4e\u9009\u62e9\u5ea6\u7684\u7d22\u5f15\uff0c\u90a3\u4e48\u521b\u5efa\u7d22\u5f15\u5728\u5bfc\u5165\u6570\u636e\u65f6\u8981\u5bf9\u6570\u636e\u6392\u5e8f\uff0c\u5f71\u54cd\u5bfc\u5165\u6027\u80fd\uff1b</li> <li>\u4e8c\u7ea7\u7d22\u5f15\u4f1a\u6709\u56de\u8868\u95ee\u9898\uff0c\u82e5\u7b5b\u9009\u7684\u6570\u636e\u91cf\u6bd4\u8f83\u5927\uff0c\u5219\u76f4\u63a5\u5168\u8868\u626b\u63cf\u4f1a\u66f4\u5feb\u3002</li> </ul> <p>\u5bf9\u4e8e OLAP \u4e1a\u52a1\u67e5\u8be2\u6765\u8bf4\uff0cHash Join \u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\u529f\u80fd\uff0cMySQL 8.0 \u7248\u672c\u5f00\u59cb\u652f\u6301 Hash Join \u7b97\u6cd5\uff0c\u52a0\u5f3a\u4e86\u5bf9\u4e8e OLAP \u4e1a\u52a1\u7684\u652f\u6301\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u7684\u67e5\u8be2\u6570\u636e\u91cf\u4e0d\u662f\u7279\u522b\u5927\uff0c\u5bf9\u4e8e\u67e5\u8be2\u7684\u54cd\u5e94\u65f6\u95f4\u8981\u6c42\u4e3a\u5206\u949f\u7ea7\u522b\uff0c\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u5355\u4e2a\u5b9e\u4f8b MySQL 8.0 \u6765\u5b8c\u6210\u5927\u6570\u636e\u7684\u67e5\u8be2\u5de5\u4f5c\u3002</p> <p>Hash Join\u4f1a\u626b\u63cf\u5173\u8054\u7684\u4e24\u5f20\u8868\uff1a</p> <ul> <li>\u9996\u5148\u4f1a\u5728\u626b\u63cf\u9a71\u52a8\u8868\u7684\u8fc7\u7a0b\u4e2d\u521b\u5efa\u4e00\u5f20\u54c8\u5e0c\u8868\uff1b</li> <li>\u63a5\u7740\u626b\u63cf\u7b2c\u4e8c\u5f20\u8868\u65f6\uff0c\u4f1a\u5728\u54c8\u5e0c\u8868\u4e2d\u641c\u7d22\u6bcf\u6761\u5173\u8054\u7684\u8bb0\u5f55\uff0c\u5982\u679c\u627e\u5230\u5c31\u8fd4\u56de\u8bb0\u5f55\u3002</li> </ul> <p>Hash Join \u9009\u62e9\u9a71\u52a8\u8868\u548c Nested Loop Join \u7b97\u6cd5\u5927\u81f4\u4e00\u6837\uff0c\u90fd\u662f\u8f83\u5c0f\u7684\u8868\u4f5c\u4e3a\u9a71\u52a8\u8868\u3002\u5982\u679c\u9a71\u52a8\u8868\u6bd4\u8f83\u5927\uff0c\u521b\u5efa\u7684\u54c8\u5e0c\u8868\u8d85\u8fc7\u4e86\u5185\u5b58\u7684\u5927\u5c0f\uff0cMySQL \u4f1a\u81ea\u52a8\u628a\u7ed3\u679c\u8f6c\u50a8\u5230\u78c1\u76d8\u3002</p>"},{"location":"chap2_opt/4table_query/#1-3-oltp-join","title":"1-3 OLTP \u4e1a\u52a1\u80fd\u4e0d\u80fd\u5199 JOIN\uff1f","text":"<p>OLTP \u4e1a\u52a1\u662f\u6d77\u91cf\u5e76\u53d1\uff0c\u8981\u6c42\u54cd\u5e94\u975e\u5e38\u53ca\u65f6\uff0c\u5728\u6beb\u79d2\u7ea7\u522b\u8fd4\u56de\u7ed3\u679c</p> <p>\u5982\u679c OLTP \u4e1a\u52a1\u7684 JOIN \u5e26\u6709 WHERE \u8fc7\u6ee4\u6761\u4ef6\uff0c\u5e76\u4e14\u662f\u6839\u636e\u4e3b\u952e\u3001\u7d22\u5f15\u8fdb\u884c\u8fc7\u6ee4\uff0c\u90a3\u4e48\u9a71\u52a8\u8868\u53ea\u6709\u4e00\u6761\u6216\u5c11\u91cf\u8bb0\u5f55\uff0c\u8fd9\u65f6\u8fdb\u884c JOIN \u7684\u5f00\u9500\u662f\u975e\u5e38\u5c0f\u7684\u3002</p> <p>\u6240\u4ee5\uff0cOLTP \u4e1a\u52a1\u5b8c\u5168\u53ef\u4ee5\u5927\u80c6\u653e\u5fc3\u5730\u5199 JOIN\uff0c\u4f46\u662f\u8981\u786e\u4fdd JOIN \u7684\u7d22\u5f15\u90fd\u5df2\u6dfb\u52a0\uff0c DBA \u4eec\u5728\u4e1a\u52a1\u4e0a\u7ebf\u4e4b\u524d\u4e00\u5b9a\u8981\u505a SQL Review\uff0c\u786e\u4fdd\u9884\u671f\u5185\u7684\u7d22\u5f15\u90fd\u5df2\u521b\u5efa\u3002</p>"},{"location":"chap2_opt/4table_query/#1-4","title":"1-4 \u603b\u7ed3","text":"<p>MySQL \u6570\u636e\u5e93\u4e2d\u652f\u6301 JOIN \u8fde\u63a5\u7684\u7b97\u6cd5\u6709 Nested Loop Join \u548c Hash Join \u4e24\u79cd\uff0c\u524d\u8005\u901a\u5e38\u7528\u4e8e OLTP \u4e1a\u52a1\uff0c\u540e\u8005\u7528\u4e8e OLAP \u4e1a\u52a1\u3002</p> <p>\u5728 OLTP \u53ef\u4ee5\u5199 JOIN\uff0c\u4f18\u5316\u5668\u4f1a\u81ea\u52a8\u9009\u62e9\u6700\u4f18\u7684\u6267\u884c\u8ba1\u5212\u3002\u4f46\u82e5\u4f7f\u7528 JOIN\uff0c\u8981\u786e\u4fdd SQL \u7684\u6267\u884c\u8ba1\u5212\u4f7f\u7528\u4e86\u6b63\u786e\u7684\u7d22\u5f15\u4ee5\u53ca\u7d22\u5f15\u8986\u76d6\uff0c\u56e0\u6b64\u7d22\u5f15\u8bbe\u8ba1\u663e\u5f97\u5c24\u4e3a\u91cd\u8981\uff0c\u8fd9\u4e5f\u662fDBA\u5728\u67b6\u6784\u8bbe\u8ba1\u65b9\u9762\u7684\u91cd\u8981\u5de5\u4f5c\u4e4b\u4e00\u3002</p>"},{"location":"chap2_opt/4table_query/#2","title":"2 \u5206\u533a\u8868","text":"<ul> <li>\u5f53\u524d MySQL \u7684\u5206\u533a\u8868\u652f\u6301 RANGE\u3001LIST\u3001HASH\u3001KEY\u3001COLUMNS \u7684\u5206\u533a\u7b97\u6cd5\uff1b</li> <li>\u5206\u533a\u8868\u7684\u521b\u5efa\u9700\u8981\u4e3b\u952e\u5305\u542b\u5206\u533a\u5217\uff1b</li> <li>\u5728\u5206\u533a\u8868\u4e2d\u552f\u4e00\u7d22\u5f15\u4ec5\u5728\u5f53\u524d\u5206\u533a\u6587\u4ef6\u552f\u4e00\uff0c\u800c\u4e0d\u662f\u5168\u5c40\u552f\u4e00\uff1b</li> <li>\u5206\u533a\u8868\u552f\u4e00\u7d22\u5f15\u63a8\u8350\u4f7f\u7528\u7c7b\u4f3c UUID \u7684\u5168\u5c40\u552f\u4e00\u5b9e\u73b0\uff1b</li> <li>\u5206\u533a\u8868\u4e0d\u89e3\u51b3\u6027\u80fd\u95ee\u9898\uff0c\u5982\u679c\u4f7f\u7528\u975e\u5206\u533a\u5217\u67e5\u8be2\uff0c\u6027\u80fd\u53cd\u800c\u4f1a\u66f4\u5dee\uff1b</li> <li>\u63a8\u8350\u5206\u533a\u8868\u7528\u4e8e\u6570\u636e\u7ba1\u7406\u3001\u901f\u5ea6\u5feb\u3001\u65e5\u5fd7\u5c0f\u3002</li> </ul> <p>\u5206\u533a\u8868\u5e76\u4e0d\u662f\u7528\u4e8e\u63d0\u5347\u6027\u80fd\u7684\u4e00\u79cd\u624b\u6bb5\uff0c\u5b83\u662f\u65b9\u4fbf\u7ba1\u7406\u6570\u636e\u7684\u4e00\u79cd\u65b9\u5f0f\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/","title":"L5 \u9ad8\u53ef\u7528\u67b6\u6784 - MySQL \u590d\u5236","text":""},{"location":"chap2_opt/5db_perf_replica/#1-mysql","title":"1 MySQL \u590d\u5236\u67b6\u6784","text":"<p>\u6570\u636e\u5e93\u590d\u5236\u672c\u8d28\u4e0a\u5c31\u662f\u6570\u636e\u540c\u6b65\u3002MySQL \u6570\u636e\u5e93\u662f\u57fa\u4e8e\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff08binary log\uff09\u8fdb\u884c\u6570\u636e\u589e\u91cf\u540c\u6b65\uff0c\u800c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8bb0\u5f55\u4e86\u6240\u6709\u5bf9\u4e8e MySQL \u6570\u636e\u5e93\u7684\u4fee\u6539\u64cd\u4f5c\u3002</p> <p>\u5728\u9ed8\u8ba4 ROW \u683c\u5f0f\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e2d\uff0c\u4e00\u6761 SQL \u64cd\u4f5c\u5f71\u54cd\u7684\u8bb0\u5f55\u4f1a\u88ab\u5168\u90e8\u8bb0\u5f55\u4e0b\u6765\uff0c\u6bd4\u5982\u4e00\u6761 SQL\u8bed\u53e5\u66f4\u65b0\u4e86\u4e09\u884c\u8bb0\u5f55\uff0c\u5728\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e2d\u4f1a\u8bb0\u5f55\u88ab\u4fee\u6539\u7684\u8fd9\u4e09\u6761\u8bb0\u5f55\u7684\u524d\u9879\uff08before image\uff09\u548c\u540e\u9879\uff08after image\uff09\u3002</p> <p>\u5bf9\u4e8e INSERT \u6216 DELETE \u64cd\u4f5c\uff0c\u5219\u4f1a\u8bb0\u5f55\u8fd9\u6761\u88ab\u63d2\u5165\u6216\u5220\u9664\u8bb0\u5f55\u6240\u6709\u5217\u7684\u4fe1\u606f\uff0c\u6211\u4eec\u6765\u770b\u4e00\u4e2a\u4f8b\u5b50\uff1a</p> <pre><code>DELETE FROM orders_test \n\nWHERE o_orderdate = '1997-12-31';\n\nQuery OK, 2482 rows affected (0.07 sec)\n</code></pre> <p>\u4e0a\u9762\u8fd9\u6761 SQL \u6267\u884c\u7684\u662f\u5220\u9664\u64cd\u4f5c\uff0c\u4e00\u5171\u5220\u9664\u4e86\u6709 2482 \u884c\u8bb0\u5f55\u3002\u53ef\u4ee5\u5728 mysql \u547d\u4ee4\u884c\u4e0b\u4f7f\u7528\u547d\u4ee4 <code>SHOW BINLOG EVENTS</code> \u67e5\u770b\u67d0\u4e2a\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u7684\u5185\u5bb9\uff0c\u6bd4\u5982\u4e0a\u8ff0\u5220\u9664\u64cd\u4f5c\u53d1\u751f\u5728\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6 <code>binlog.000004</code> \u4e2d\uff0c\u4f60\u53ef\u4ee5\u770b\u5230</p> <p></p> <p>\u901a\u8fc7 MySQL \u6570\u636e\u5e93\u81ea\u5e26\u7684\u547d\u4ee4 mysqlbinlog\uff0c\u53ef\u4ee5\u89e3\u6790\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u89c2\u5bdf\u5230\u66f4\u4e3a\u8be6\u7ec6\u7684\u6bcf\u6761\u8bb0\u5f55\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\uff1a</p> <p></p> <p>\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8bb0\u5f55\u770b\u5230\u88ab\u5220\u9664\u8bb0\u5f55\u7684\u5b8c\u6574\u4fe1\u606f\uff0c\u8fd8\u6709\u6bcf\u4e2a\u5217\u7684\u5c5e\u6027\uff0c\u6bd4\u5982\u5217\u7684\u7c7b\u578b\uff0c\u662f\u5426\u5141\u8bb8\u4e3a NULL \u503c\u7b49\u3002</p> <p>\u5982\u679c\u662f UPDATE \u64cd\u4f5c\uff0c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e2d\u8fd8\u8bb0\u5f55\u4e86\u88ab\u4fee\u6539\u8bb0\u5f55\u5b8c\u6574\u7684\u524d\u9879\u548c\u540e\u9879\uff0c\u6bd4\u5982\uff1a</p> <p></p> <p>\u5728\u6709\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u57fa\u7840\u4e0a\uff0cMySQL \u6570\u636e\u5e93\u5c31\u53ef\u4ee5\u901a\u8fc7\u6570\u636e\u590d\u5236\u6280\u672f\u5b9e\u73b0\u6570\u636e\u540c\u6b65\u4e86\u3002\u800c\u6570\u636e\u590d\u5236\u7684\u672c\u8d28\u5c31\u662f\u628a\u4e00\u53f0 MySQL \u6570\u636e\u5e93\u4e0a\u7684\u53d8\u66f4\u540c\u6b65\u5230\u53e6\u4e00\u53f0 MySQL \u6570\u636e\u5e93\u4e0a\u3002\u4e0b\u9762\u8fd9\u5f20\u56fe\u663e\u793a\u4e86\u5f53\u524d MySQL \u6570\u636e\u5e93\u7684\u590d\u5236\u67b6\u6784\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728 MySQL \u590d\u5236\u4e2d\uff0c\u4e00\u53f0\u662f\u6570\u636e\u5e93\u7684\u89d2\u8272\u662f Master\uff08\u4e5f\u53eb Primary\uff09\uff0c\u5269\u4e0b\u7684\u670d\u52a1\u5668\u89d2\u8272\u662f Slave\uff08\u4e5f\u53eb Standby\uff09\uff1a</p> <ul> <li>Master \u670d\u52a1\u5668\u4f1a\u628a\u6570\u636e\u53d8\u66f4\u4ea7\u751f\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u901a\u8fc7 Dump \u7ebf\u7a0b\u53d1\u9001\u7ed9 Slave \u670d\u52a1\u5668\uff1b</li> <li>Slave \u670d\u52a1\u5668\u4e2d\u7684 I/O \u7ebf\u7a0b\u8d1f\u8d23\u63a5\u53d7\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u5e76\u4fdd\u5b58\u4e3a\u4e2d\u7ee7\u65e5\u5fd7\uff1b</li> <li>SQL/Worker \u7ebf\u7a0b\u8d1f\u8d23\u5e76\u884c\u6267\u884c\u4e2d\u7ee7\u65e5\u5fd7\uff0c\u5373\u5728 Slave \u670d\u52a1\u5668\u4e0a\u56de\u653e Master \u4ea7\u751f\u7684\u65e5\u5fd7\u3002</li> </ul> <p>MySQL \u7684\u590d\u5236\u76f8\u6bd4\u5176\u4ed6\u6570\u636e\u5e93\uff0c\u5982 Oracle\u3001PostgreSQL \u7b49\uff0c\u975e\u5e38\u7075\u6d3b\uff0c\u7528\u6237\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\u6784\u5efa\u6240\u9700\u8981\u7684\u590d\u5236\u62d3\u6251\u7ed3\u6784\uff0c\u6bd4\u5982\uff1a</p> <p></p> <p>\u5728\u4e0a\u56fe\u4e2d\uff0cSlave1\u3001Slave2\u3001Slave3 \u90fd\u662f Master \u7684\u4ece\u670d\u52a1\u5668\uff0c\u800c Slave11 \u662f Slave1 \u7684\u4ece\u670d\u52a1\u5668\uff0cSlave1 \u670d\u52a1\u5668\u65e2\u662f Master \u7684\u4ece\u673a\uff0c\u53c8\u662f Slave11 \u7684\u4e3b\u673a\uff0c\u6240\u4ee5 Slave1 \u662f\u4e2a\u7ea7\u8054\u7684\u4ece\u673a\u3002\u540c\u7406\uff0cSlave3 \u4e5f\u662f\u53f0\u7ea7\u8054\u7684\u4ece\u673a\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/#mysql","title":"MySQL \u590d\u5236\u914d\u7f6e","text":"<p>\u642d\u5efa MySQL \u590d\u5236\u5b9e\u73b0\u975e\u5e38\u7b80\u5355\uff0c\u57fa\u672c\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ul> <li>\u521b\u5efa\u590d\u5236\u6240\u9700\u7684\u8d26\u53f7\u548c\u6743\u9650\uff1b</li> <li>\u4ece Master \u670d\u52a1\u5668\u62f7\u8d1d\u4e00\u4efd\u6570\u636e\uff0c\u53ef\u4ee5\u4f7f\u7528\u903b\u8f91\u5907\u4efd\u5de5\u5177 mysqldump\u3001mysqlpump\uff0c\u6216\u7269\u7406\u5907\u4efd\u5de5\u5177 Clone Plugin\uff1b</li> <li>\u901a\u8fc7\u547d\u4ee4 CHANGE MASTER TO \u642d\u5efa\u590d\u5236\u5173\u7cfb\uff1b</li> <li>\u901a\u8fc7\u547d\u4ee4 SHOW SLAVE STATUS \u89c2\u5bdf\u590d\u5236\u72b6\u6001\u3002</li> </ul> <pre><code>gtid_mode = on\n\nenforce_gtid_consistency = 1\n\nbinlog_gtid_simple_recovery = 1\n\nrelay_log_recovery = ON\n\nmaster_info_repository = TABLE \n\nrelay_log_info_repository = TABLE\n</code></pre> <p>\u4e0a\u8ff0\u8bbe\u7f6e\u90fd\u662f\u7528\u4e8e\u4fdd\u8bc1 crash safe\uff0c\u5373\u65e0\u8bba Master \u8fd8\u662f Slave \u5b95\u673a\uff0c\u5f53\u5b83\u4eec\u6062\u590d\u540e\uff0c\u8fde\u4e0a\u4e3b\u673a\u540e\uff0c\u4e3b\u4ece\u6570\u636e\u4f9d\u7136\u4e00\u81f4\uff0c\u4e0d\u4f1a\u4ea7\u751f\u4efb\u4f55\u4e0d\u4e00\u81f4\u7684\u95ee\u9898</p>"},{"location":"chap2_opt/5db_perf_replica/#mysql_1","title":"MySQL\u590d\u5236\u7c7b\u578b\u53ca\u5e94\u7528\u9009\u9879","text":"<p>\u5f02\u6b65\u590d\u5236</p> <p>\u5728\u5f02\u6b65\u590d\u5236\uff08async replication\uff09\u4e2d\uff0cMaster \u4e0d\u7528\u5173\u5fc3 Slave \u662f\u5426\u63a5\u6536\u5230\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u6240\u4ee5 Master \u4e0e Slave \u6ca1\u6709\u4efb\u4f55\u7684\u4f9d\u8d56\u5173\u7cfb\u3002\u4f60\u53ef\u4ee5\u8ba4\u4e3a Master \u548c Slave \u662f\u5206\u522b\u72ec\u81ea\u5de5\u4f5c\u7684\u4e24\u53f0\u670d\u52a1\u5668\uff0c\u6570\u636e\u6700\u7ec8\u4f1a\u901a\u8fc7\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8fbe\u5230\u4e00\u81f4\u3002</p> <p>\u5f02\u6b65\u590d\u5236\u7684\u6027\u80fd\u6700\u597d\uff0c\u56e0\u4e3a\u5b83\u5bf9\u6570\u636e\u5e93\u672c\u8eab\u51e0\u4e4e\u6ca1\u6709\u4efb\u4f55\u5f00\u9500\uff0c\u9664\u975e\u4e3b\u4ece\u5ef6\u8fdf\u975e\u5e38\u5927\uff0cDump Thread \u9700\u8981\u8bfb\u53d6\u5927\u91cf\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u3002</p> <p>\u534a\u540c\u6b65\u590d\u5236</p> <p>\u534a\u540c\u6b65\u590d\u5236\u8981\u6c42 Master \u4e8b\u52a1\u63d0\u4ea4\u8fc7\u7a0b\u4e2d\uff0c\u81f3\u5c11\u6709 N \u4e2a Slave \u63a5\u6536\u5230\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u8fd9\u6837\u5c31\u80fd\u4fdd\u8bc1\u5f53 Master \u53d1\u751f\u5b95\u673a\uff0c\u81f3\u5c11\u6709 N \u53f0 Slave \u670d\u52a1\u5668\u4e2d\u7684\u6570\u636e\u662f\u5b8c\u6574\u7684\u3002</p> <p>\u534a\u540c\u6b65\u590d\u5236\u5e76\u4e0d\u662f MySQL \u5185\u7f6e\u7684\u529f\u80fd\uff0c\u800c\u662f\u8981\u5b89\u88c5\u534a\u540c\u6b65\u63d2\u4ef6\uff0c\u5e76\u542f\u7528\u534a\u540c\u6b65\u590d\u5236\u529f\u80fd\uff0c\u8bbe\u7f6e N \u4e2a Slave \u63a5\u53d7\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6210\u529f\uff0c\u6bd4\u5982\uff1a</p> <pre><code>plugin-load=\"rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so\"\n\nrpl-semi-sync-master-enabled = 1\n\nrpl-semi-sync-slave-enabled = 1\n\nrpl_semi_sync_master_wait_no_slave = 1\n</code></pre> <p>\u4e0a\u9762\u7684\u914d\u7f6e\u4e2d\uff1a</p> <ul> <li>\u7b2c 1 \u884c\u8981\u6c42\u6570\u636e\u5e93\u542f\u52a8\u65f6\u5b89\u88c5\u534a\u540c\u6b65\u63d2\u4ef6\uff1b</li> <li>\u7b2c 2\u30013 \u884c\u8868\u793a\u5206\u522b\u542f\u7528\u534a\u540c\u6b65 Master \u548c\u534a\u540c\u6b65 Slave \u63d2\u4ef6\uff1b</li> <li>\u7b2c 4 \u884c\u8868\u793a\u534a\u540c\u6b65\u590d\u5236\u8fc7\u7a0b\u4e2d\uff0c\u63d0\u4ea4\u7684\u4e8b\u52a1\u5fc5\u987b\u81f3\u5c11\u6709\u4e00\u4e2a Slave \u63a5\u6536\u5230\u4e8c\u8fdb\u5236\u65e5\u5fd7\u3002</li> </ul> <p></p> <p>\u6240\u4ee5\uff0c\u5bf9\u4e8e\u4efb\u4f55\u6709\u6570\u636e\u4e00\u81f4\u6027\u8981\u6c42\u7684\u4e1a\u52a1\uff0c\u5982\u7535\u5546\u7684\u6838\u5fc3\u8ba2\u5355\u4e1a\u52a1\u3001\u94f6\u884c\u3001\u4fdd\u9669\u3001\u8bc1\u5238\u7b49\u4e0e\u8d44\u91d1\u5bc6\u5207\u76f8\u5173\u7684\u4e1a\u52a1\uff0c\u52a1\u5fc5\u4f7f\u7528\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\u3002\u8fd9\u6837\u6570\u636e\u624d\u662f\u5b89\u5168\u7684\u3001\u6709\u4fdd\u969c\u7684\u3001\u5373\u4f7f\u53d1\u751f\u5b95\u673a\uff0c\u4ece\u673a\u4e5f\u6709\u4e00\u4efd\u5b8c\u6574\u7684\u6570\u636e\u3002</p> <p>\u591a\u6e90\u590d\u5236</p> <p>\u65e0\u8bba\u662f\u5f02\u6b65\u590d\u5236\u8fd8\u662f\u534a\u540c\u6b65\u590d\u5236\uff0c\u90fd\u662f 1 \u4e2a Master \u5bf9\u5e94 N \u4e2a Slave\u3002\u5176\u5b9e MySQL \u4e5f\u652f\u6301 N \u4e2a Master \u5bf9\u5e94 1 \u4e2a Slave\uff0c\u8fd9\u79cd\u67b6\u6784\u5c31\u79f0\u4e4b\u4e3a\u591a\u6e90\u590d\u5236\u3002</p> <p>\u591a\u6e90\u590d\u5236\u5141\u8bb8\u5728\u4e0d\u540c MySQL \u5b9e\u4f8b\u4e0a\u7684\u6570\u636e\u540c\u6b65\u5230 1 \u53f0 MySQL \u5b9e\u4f8b\u4e0a\uff0c\u65b9\u4fbf\u5728 1 \u53f0 Slave \u670d\u52a1\u5668\u4e0a\u8fdb\u884c\u4e00\u4e9b\u7edf\u8ba1\u67e5\u8be2\uff0c\u5982\u5e38\u89c1\u7684 OLAP \u4e1a\u52a1\u67e5\u8be2\u3002</p> <p></p> <p>\u5ef6\u8fdf\u590d\u5236</p> <p>\u590d\u5236\u67b6\u6784\uff0cSlave \u5728\u63a5\u6536\u4e8c\u8fdb\u5236\u65e5\u5fd7\u540e\u4f1a\u5c3d\u53ef\u80fd\u5feb\u5730\u56de\u653e\u65e5\u5fd7\uff0c\u8fd9\u6837\u662f\u4e3a\u4e86\u907f\u514d\u4e3b\u4ece\u4e4b\u95f4\u51fa\u73b0\u5ef6\u8fdf\u3002\u800c\u5ef6\u8fdf\u590d\u5236\u5374\u5141\u8bb8Slave \u5ef6\u8fdf\u56de\u653e\u63a5\u6536\u5230\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u4e3a\u4e86\u907f\u514d\u4e3b\u670d\u52a1\u5668\u4e0a\u7684\u8bef\u64cd\u4f5c\uff0c\u9a6c\u4e0a\u53c8\u540c\u6b65\u5230\u4e86\u4ece\u670d\u52a1\u5668\uff0c\u5bfc\u81f4\u6570\u636e\u5b8c\u5168\u4e22\u5931\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u8bbe\u7f6e\u5ef6\u8fdf\u590d\u5236\uff1a</p> <pre><code>CHANGE MASTER TO master_delay = 3600\n</code></pre> <p>\u8fd9\u6837\u5c31\u4eba\u4e3a\u8bbe\u7f6e\u4e86 Slave \u843d\u540e Master \u670d\u52a1\u56681\u4e2a\u5c0f\u65f6\u3002</p> <p>\u90a3\u4e48\u5f53\u7ebf\u4e0a\u53d1\u751f\u8bef\u64cd\u4f5c\uff0c\u5982 DROP TABLE\u3001DROP DATABASE \u8fd9\u6837\u707e\u96be\u6027\u7684\u547d\u4ee4\u65f6\uff0c\u7528\u6237\u6709\u4e00\u4e2a 24 \u5c0f\u65f6\u524d\u7684\u5feb\u7167\uff0c\u6570\u636e\u53ef\u4ee5\u5feb\u901f\u6062\u590d\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/#_1","title":"\u603b\u7ed3","text":"<ul> <li>\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8bb0\u5f55\u4e86\u6240\u6709\u5bf9\u4e8e MySQL \u53d8\u66f4\u7684\u64cd\u4f5c\uff1b</li> <li>\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>SHOW BINLOG EVENTS IN ... FROM ...</code>\u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u57fa\u672c\u4fe1\u606f\uff1b</li> <li>\u53ef\u4ee5\u901a\u8fc7\u5de5\u5177 mysqlbinlog \u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u8be6\u7ec6\u5185\u5bb9\uff1b</li> <li>\u590d\u5236\u642d\u5efa\u867d\u7136\u7b80\u5355\uff0c\u4f46\u522b\u5fd8\u8bb0\u914d\u7f6e crash safe \u76f8\u5173\u53c2\u6570\uff0c\u5426\u5219\u53ef\u80fd\u5bfc\u81f4\u4e3b\u4ece\u6570\u636e\u4e0d\u4e00\u81f4\uff1b</li> <li>\u5f02\u6b65\u590d\u5236\u7528\u4e8e\u975e\u6838\u5fc3\u4e1a\u52a1\u573a\u666f\uff0c\u4e0d\u8981\u6c42\u6570\u636e\u4e00\u81f4\u6027\uff1b</li> <li>\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\u7528\u4e8e\u6838\u5fc3\u4e1a\u52a1\u573a\u666f\uff0c\u5982\u94f6\u884c\u3001\u4fdd\u9669\u3001\u8bc1\u5238\u7b49\u6838\u5fc3\u4e1a\u52a1\uff0c\u9700\u8981\u4e25\u683c\u4fdd\u969c\u6570\u636e\u4e00\u81f4\u6027\uff1b</li> <li>\u591a\u6e90\u590d\u5236\u53ef\u5c06\u591a\u4e2a Master \u6570\u636e\u6c47\u603b\u5230\u4e00\u4e2a\u6570\u636e\u5e93\u793a\u4f8b\u8fdb\u884c\u5206\u6790\uff1b</li> <li>\u5ef6\u8fdf\u590d\u5236\u4e3b\u8981\u7528\u4e8e\u8bef\u64cd\u4f5c\u9632\u8303\uff0c\u91d1\u878d\u884c\u4e1a\u8981\u7279\u522b\u8003\u8651\u8fd9\u6837\u7684\u573a\u666f\u3002</li> </ul>"},{"location":"chap2_opt/5db_perf_replica/#2","title":"2 \u9ad8\u53ef\u7528\u8bbe\u8ba1","text":""},{"location":"chap2_opt/5db_perf_replica/#2-1","title":"2-1 \u9ad8\u53ef\u7528\u6982\u5ff5","text":"<p>High availability (HA) is a characteristic of a system which aims to ensure an agreed level of operational performance, usually uptime, for a higher than normal period.</p> <p>\u9ad8\u53ef\u7528\uff08High Availability\uff09\u662f\u7cfb\u7edf\u6240\u80fd\u63d0\u4f9b\u65e0\u6545\u969c\u670d\u52a1\u7684\u4e00\u79cd\u80fd\u529b\u3002 \u7b80\u5355\u5730\u8bf4\u5c31\u662f\u907f\u514d\u56e0\u670d\u52a1\u5668\u5b95\u673a\u800c\u9020\u6210\u7684\u670d\u52a1\u4e0d\u53ef\u7528\u3002</p> <p>\u901a\u5e38\u6765\u8bf4\uff0c\u7cfb\u7edf\u81f3\u5c11\u8981\u8fbe\u5230 4 \u4e2a 9\uff0899.99%\uff09\uff0c\u4e5f\u5c31\u662f\u6bcf\u5e74\u5b95\u673a\u65f6\u95f4\u4e0d\u8d85\u8fc7 52.56 \u5206\u949f\uff0c\u5426\u5219\u7528\u6237\u4f53\u9a8c\u4f1a\u975e\u5e38\u5dee\uff0c\u611f\u89c9\u7cfb\u7edf\u4e0d\u7a33\u5b9a\u3002</p> <p><code>99.99% = 1 - 52.56 / (365*24*60)</code></p> <p>\u4e0d\u8fc7 4 \u4e2a 9 \u5b95\u673a 52 \u5206\u949f\u5bf9\u4e8e\u751f\u4ea7\u73af\u5883\u7684\u5f71\u54cd\u8fd8\u662f\u6bd4\u8f83\u5927\uff0c\u4f46\u662f 5 \u4e2a 9 \u5bf9\u5927\u90e8\u5206\u7cfb\u7edf\u6765\u8bf4\u8981\u6c42\u53c8\u592a\u9ad8\u3002\u6240\u4ee5\u4e00\u4e9b\u4e91\u670d\u52a1\u5546\u4f1a\u63d0\u51fa\u4e00\u4e2a 99.995% \u7684\u53ef\u7528\u6027\u6982\u5ff5\uff0c\u90a3\u4e48\u7cfb\u7edf\u4e00\u5e74\u7684\u4e0d\u53ef\u7528\u65f6\u957f\u4e3a\uff1a</p> <p><code>\u4e0d\u53ef\u7528\u65f6\u957f = (1 - 99.995%)*365*24*60 = 26.28 (\u5206\u949f)</code></p> <p>\u5373\u4e00\u5e74\u6700\u591a\u7684\u5f71\u54cd\u670d\u52a1\u7684\u65f6\u95f4\u4e3a 26.28 \u5206\u949f\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/#2-2","title":"2-2 \u9ad8\u53ef\u7528\u67b6\u6784\u8bbe\u8ba1","text":"<p>\u7cfb\u7edf\u8981\u8fbe\u5230\u9ad8\u53ef\u7528\uff0c\u4e00\u5b9a\u8981\u505a\u597d\u8f6f\u786c\u4ef6\u7684\u5197\u4f59\uff0c\u6d88\u9664\u5355\u70b9\u6545\u969c\uff08SPOF single point of failure\uff09\u3002</p> <p>\u5197\u4f59\u662f\u9ad8\u53ef\u7528\u7684\u57fa\u7840\uff0c\u901a\u5e38\u8ba4\u4e3a\uff0c\u7cfb\u7edf\u6295\u5165\u786c\u4ef6\u8d44\u6e90\u8d8a\u591a\uff0c\u5197\u4f59\u4e5f\u5c31\u8d8a\u591a\uff0c\u7cfb\u7edf\u53ef\u7528\u6027\u4e5f\u5c31\u8d8a\u9ad8\u3002</p> <p>\u9664\u4e86\u505a\u597d\u5197\u4f59\uff0c\u7cfb\u7edf\u8fd8\u8981\u505a\u597d\u6545\u969c\u8f6c\u79fb\uff08Failover\uff09\u7684\u5904\u7406\u3002\u4e5f\u5c31\u662f\u5728\u6700\u77ed\u7684\u65f6\u95f4\u5185\u53d1\u73b0\u6545\u969c\uff0c\u7136\u540e\u628a\u4e1a\u52a1\u5207\u6362\u5230\u5197\u4f59\u7684\u8d44\u6e90\u4e0a\u3002</p> <p>\u65e0\u72b6\u6001\u670d\u52a1\u9ad8\u53ef\u7528\u8bbe\u8ba1\u3001\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u67b6\u6784\u8bbe\u8ba1\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/#2-2_1","title":"2-2 \u65e0\u72b6\u6001\u670d\u52a1\u9ad8\u53ef\u7528\u8bbe\u8ba1","text":"<p>\u65e0\u72b6\u6001\u7684\u670d\u52a1\uff08\u5982 Nginx \uff09\u9ad8\u53ef\u7528\u8bbe\u8ba1\u975e\u5e38\u7b80\u5355\uff0c\u53d1\u73b0\u95ee\u9898\u76f4\u63a5\u8f6c\u79fb\u5c31\u884c\uff0c\u751a\u81f3\u53ef\u4ee5\u901a\u8fc7\u8d1f\u8f7d\u5747\u8861\u670d\u52a1\uff0c\u5f53\u53d1\u73b0\u6709\u95ee\u9898\uff0c\u76f4\u63a5\u5254\u9664\uff1a</p> <p></p> <p>\u7b2c\u4e00\u53f0 Ningx \u670d\u52a1\u5668\u51fa\u73b0\u95ee\u9898\uff0c\u5bfc\u81f4\u670d\u52a1\u4e0d\u53ef\u7528\uff0cLoad Balance \u8d1f\u8f7d\u5747\u8861\u670d\u52a1\u53d1\u73b0\u540e\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u628a\u5b83\u5254\u9664\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/#2-3","title":"2-3 \u6570\u636e\u5e93\u9ad8\u53ef\u7528\u67b6\u6784\u8bbe\u8ba1","text":"<ul> <li>\u6570\u636e\u6301\u4e45\u5316\u5728\u6570\u636e\u5e93\u4e2d\uff0c\u662f\u6709\u72b6\u6001\u7684\u670d\u52a1\uff1b</li> <li>\u6570\u636e\u5e93\u7684\u5bb9\u91cf\u6bd4\u8f83\u5927\uff0cFailover \u7684\u65f6\u95f4\u76f8\u5bf9\u65e0\u72b6\u6001\u670d\u52a1\u4f1a\u66f4\u591a\uff1b</li> <li>\u4e00\u4e9b\u7cfb\u7edf\uff0c\u5982\u91d1\u878d\u573a\u666f\u7684\u6570\u636e\u5e93\uff0c\u4f1a\u8981\u6c42\u6570\u636e\u5b8c\u5168\u4e0d\u80fd\u4e22\u5931\uff0c\u8fd9\u53c8\u589e\u52a0\u4e86\u9ad8\u53ef\u7528\u5b9e\u73b0\u7684\u96be\u5ea6\u3002</li> </ul> <p>\u5176\u5b9e\u4ece\u67b6\u6784\u89d2\u5ea6\u770b\uff0c\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u672c\u8eab\u4e5f\u662f\u4e1a\u52a1\u9ad8\u53ef\u7528\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u4ece\u4e1a\u52a1\u5168\u6d41\u7a0b\u7684\u89d2\u5ea6\u51fa\u53d1\uff0c\u601d\u8003\u6570\u636e\u5e93\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1\u3002</p> <p>\u57fa\u4e8e\u6570\u636e\u5c42\u7684\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u67b6\u6784</p> <p>\u57fa\u4e8e\u6570\u636e\u5c42\u7684\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u67b6\u6784\uff0c\u5c31\u662f\u57fa\u4e8e\u6570\u636e\u540c\u6b65\u6280\u672f\u3002\u5f53\u4e3b\u670d\u52a1\u5668 Master \u53d1\u751f\u5b95\u673a\uff0c\u5219\u6545\u969c\u8f6c\u79fb\u5230\u4ece\u670d\u52a1\u5668 Slave\u3002</p> <p></p> <p>\u53ef\u4ee5\u53d1\u73b0\uff0c\u6211\u4eec\u539f\u5148\u7684 Slave3 \u4ece\u670d\u52a1\u5668\u63d0\u5347\u4e3a\u4e86\u65b0\u4e3b\u673a\uff0c\u7136\u540e\u5efa\u7acb\u4e86\u65b0\u7684\u590d\u5236\u62d3\u6251\u67b6\u6784\uff0cSlave2\u3001Slave3 \u90fd\u8fde\u5230\u65b0 Master \u8fdb\u884c\u6570\u636e\u540c\u6b65\u3002</p> <p>\u4e3a\u4e86\u5728\u6545\u969c\u8f6c\u79fb\u540e\u5bf9 Service \u670d\u52a1\u65e0\u611f\u77e5\uff0c\u6240\u4ee5\u9700\u8981\u5f15\u5165 VIP\uff08Virtual IP\uff09\u865a\u62df IP \u6280\u672f\uff0c\u5f53\u53d1\u751f\u5b95\u673a\u65f6\uff0cVIP \u4e5f\u9700\u8981\u6f02\u79fb\u5230\u65b0\u7684\u4e3b\u670d\u52a1\u5668\u3002</p> <p>\u90a3\u4e48\u8fd9\u4e2a\u67b6\u6784\u7684\u771f\u6b63\u96be\u70b9\u5728\u4e8e\uff1a</p> <ul> <li>\u5982\u4f55\u4fdd\u969c\u6570\u636e\u4e00\u81f4\u6027\uff1b</li> <li>\u5982\u4f55\u53d1\u73b0\u4e3b\u670d\u52a1\u5668\u5b95\u673a\uff1b</li> <li>\u6545\u969c\u8f6c\u79fb\u903b\u8f91\u7684\u5904\u7406\uff1b</li> </ul> <p>\u57fa\u4e8e\u4e1a\u52a1\u5c42\u7684\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u67b6\u6784</p> <p>\u5f53\u4e00\u53f0\u6570\u636e\u5e93\u4e3b\u670d\u52a1\u5668\u4e0d\u53ef\u7528\uff0c\u4e1a\u52a1\u76f4\u63a5\u5199\u53e6\u4e00\u53f0\u6570\u636e\u5e93\u4e3b\u670d\u52a1\u5668\u5c31\u53ef\u4ee5\u4e86\u3002\u6211\u4eec\u6765\u770b\u4e00\u4e0b\u8fd9\u4e2a\u67b6\u6784\uff1a</p> <p></p> <p>\u4ece\u4e0a\u56fe\u53ef\u4ee5\u770b\u5230\uff0cService \u670d\u52a1\u5199\u5165 Master1 \u4e3b\u670d\u52a1\u5668\u5931\u8d25\u540e\uff0c\u4e0d\u7528\u7b49\u5f85\u6545\u969c\u8f6c\u79fb\u7a0b\u5e8f\u542f\u7528\u4e3b\u4ece\u5207\u6362\uff0c\u800c\u662f\u76f4\u63a5\u628a\u6570\u636e\u5199\u5165 Master2 \u4e3b\u670d\u52a1\u5668\u3002</p> <p>\u8fd9\u770b\u4f3c\u662f\u4e00\u79cd\u975e\u5e38\u7b80\u5355\u3001\u7c97\u66b4\u7684\u9ad8\u53ef\u7528\u67b6\u6784\u5b9e\u73b0\u65b9\u5f0f\uff0c\u4f46\u80fd\u7b26\u5408\u8fd9\u6837\u8bbe\u8ba1\u7684\u4e1a\u52a1\u5374\u5e76\u4e0d\u591a\uff0c\u56e0\u4e3a\u8be5\u8bbe\u8ba1\u524d\u63d0\u662f\u72b6\u6001\u53ef\u4fee\u6539\u3002</p> <p>\u4f46\u8fd9\u6837\u8bbe\u8ba1\u7684\u524d\u63d0\u662f\u6574\u4e2a\u670d\u52a1\u7684\u5199\u5165\u4e3b\u952e\u662f\u53ef\u4ee5\u8fdb\u884c\u8df3\u5355\u8bbe\u8ba1\uff0c\u4e14\u67e5\u8be2\u5168\u90e8\u4f9d\u8d56\u4e3b\u952e\u8fdb\u884c\u641c\u7d22\u3002</p> <p>\u878d\u5408\u7684\u9ad8\u53ef\u7528\u67b6\u6784\u8bbe\u8ba1</p> <p>\u4e00\u79cd\u4e1a\u52a1\u548c\u6570\u636e\u5c42\u76f8\u7ed3\u5408\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1\u3002\u8fd9\u4e2a\u67b6\u6784\u53ef\u4ee5\u89e3\u51b3\u5b95\u673a\u540e\uff0c\u67e5\u8be2\u670d\u52a1\u53d7\u9650\u7684\u95ee\u9898\u3002</p> <p></p> <p>\u5c06\u4e0d\u540c\u7f16\u53f7\u7684\u8ba2\u5355\u6839\u636e\u4e0d\u540c\u7684\u6570\u636e\u5e93\u8fdb\u884c\u5b58\u653e\uff0c\u6bd4\u5982\u670d\u52a1\u5668\u7f16\u53f7\u4e3a 1 \u7684\u8ba2\u5355\u5b58\u653e\u5728\u6570\u636e\u5e93 DB1 \u4e2d\uff0c\u670d\u52a1\u5668\u7f16\u53f7\u4e3a 2 \u7684\u8ba2\u5355\u5b58\u653e\u5728\u6570\u636e\u5e93 DB2 \u4e2d\u3002</p> <p>\u6b64\u5916\uff0c\u8fd9\u91cc\u4e5f\u7528\u5230\u4e86 MySQL \u590d\u5236\u4e2d\u7684\u90e8\u5206\u590d\u5236\u6280\u672f\uff0c\u5373\u5de6\u4e0a\u89d2\u7684\u4e3b\u670d\u52a1\u5668\u4ec5\u5c06 DB1 \u4e2d\u7684\u6570\u636e\u540c\u6b65\u5230\u53f3\u4e0a\u89d2\u7684\u670d\u52a1\u5668\u3002\u540c\u7406\uff0c\u53f3\u4e0a\u89d2\u7684\u4e3b\u670d\u52a1\u5668\u4ec5\u5c06 DB2 \u4e2d\u7684\u6570\u636e\u540c\u6b65\u5230\u5de6\u4e0a\u89d2\u7684\u670d\u52a1\u5668\u3002\u4e0b\u9762\u7684\u4e24\u53f0\u4ece\u670d\u52a1\u5668\u4e0d\u53d8\uff0c\u4f9d\u7136\u4ece\u539f\u6765\u7684 MySQL \u5b9e\u4f8b\u4e2d\u540c\u6b65\u6570\u636e\u3002</p> <p>\u8fd9\u6837\u505a\u5f97\u597d\u5904\u662f\uff1a</p> <ul> <li>\u5728\u5e38\u6001\u60c5\u51b5\u4e0b\uff0c\u4e0a\u9762\u4e24\u53f0 MySQL \u6570\u636e\u5e93\u662f\u53cc\u6d3b\u7684\uff0c\u90fd\u53ef\u4ee5\u6709\u6570\u636e\u7684\u5199\u5165\uff0c\u4e1a\u52a1\u7684\u6027\u80fd\u5f97\u5230\u6781\u5927\u63d0\u5347\u3002</li> <li>\u8ba2\u5355\u6570\u636e\u662f\u5b8c\u6574\u7684\uff0c\u670d\u52a1\u5668\u7f16\u53f7\u4e3a 1 \u548c 2 \u7684\u6570\u636e\u90fd\u5728\u4e00\u4e2a MySQL \u5b9e\u4f8b\u4e0a\u3002</li> <li>\u66f4\u91cd\u8981\u7684\u662f\uff0c\u8fd9\u6837\u5f53\u53d1\u751f\u5b95\u673a\u65f6\uff0cService \u670d\u52a1\u7684\u5199\u5165\u4e0d\u53d7\u5230\u5f71\u54cd\uff0c\u5199\u5165\u670d\u52a1\u5668\u7f16\u53f7\u4e3a 1 \u7684\u8ba2\u5355\u901a\u8fc7\u8df3\u5355\u8bbe\u8ba1\u5199\u5165 DB2\u3002</li> <li>\u540c\u65f6\uff0c\u5bf9\u4e8e\u8ba2\u5355\u8bfb\u53d6\u4e5f\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd\uff0c\u56e0\u4e3a\u6570\u636e\u90fd\u662f\u4e00\u4e2a\u5b9e\u4f8b\u4e0a\uff0c\u5982\uff1a</li> </ul> <p></p>"},{"location":"chap2_opt/5db_perf_replica/#2-4","title":"2-4 \u603b\u7ed3","text":"<ul> <li>\u9ad8\u53ef\u7528\u662f\u7cfb\u7edf\u6240\u80fd\u63d0\u4f9b\u65e0\u6545\u969c\u670d\u52a1\u7684\u4e00\u79cd\u80fd\u529b\uff0c\u5ea6\u91cf\u5355\u4f4d\u662f\u51e0\u4e2a 9\uff1b</li> <li>\u7ebf\u4e0a\u7cfb\u7edf\u9ad8\u53ef\u7528\u76ee\u6807\u5e94\u4e0d\u4f4e\u4e8e 99.995%\uff0c\u5426\u5219\u7cfb\u7edf\u9891\u7e41\u5b95\u673a\uff0c\u7528\u6237\u4f53\u9a8c\u4e0d\u597d\uff1b</li> <li>\u9ad8\u53ef\u7528\u5b9e\u73b0\u57fa\u7840\u662f\uff1a\u5197\u4f59 + \u6545\u969c\u8f6c\u79fb\uff1b</li> <li>\u65e0\u72b6\u6001\u670d\u52a1\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1\u8f83\u4e3a\u7b80\u5355\uff0c\u76f4\u63a5\u6545\u969c\u8f6c\u79fb\u6216\u5254\u9664\u5c31\u884c\uff1b</li> <li>\u6570\u636e\u5e93\u4f5c\u4e3a\u6709\u72b6\u6001\u7684\u670d\u52a1\uff0c\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742\uff08\u5197\u4f59\u901a\u8fc7\u590d\u5236\u6280\u672f\u5b9e\u73b0\uff0c\u6545\u969c\u8f6c\u79fb\u9700\u8981\u5bf9\u5e94\u7684\u9ad8\u53ef\u7528\u5957\u4ef6\uff09\uff1b</li> <li>\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u6709\u4e09\u5927\u67b6\u6784\u8bbe\u8ba1\uff0c\u8bf7\u52a1\u5fc5\u7262\u8bb0\u8fd9\u51e0\u79cd\u8bbe\u8ba1\u3002</li> </ul>"},{"location":"chap2_opt/5db_perf_replica/#3","title":"3 \u8bfb\u5199\u5206\u79bb\u8bbe\u8ba1","text":"<p>\u903b\u8f91\u65e5\u5fd7\u7684\u4f18\u7f3a\u70b9</p> <p>MySQL \u590d\u5236\u57fa\u4e8e\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u662f\u4e00\u79cd\u903b\u8f91\u65e5\u5fd7\uff0c\u5176\u5199\u5165\u7684\u662f\u6bcf\u4e2a\u4e8b\u52a1\u4e2d\u5df2\u53d8\u66f4\u7684\u6bcf\u6761\u8bb0\u5f55\u7684\u524d\u9879\u3001\u540e\u9879\u3002</p> <p>\u4e8b\u52a1\u4e0d\u80fd\u592a\u5927\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u4e8c\u8fdb\u5236\u65e5\u5fd7\u975e\u5e38\u5927\uff0c\u4e00\u4e2a\u5927\u4e8b\u52a1\u7684\u63d0\u4ea4\u4f1a\u975e\u5e38\u6162\u3002</p> <p>\u5047\u8bbe\u6709\u4e2a DELETE \u5220\u9664\u64cd\u4f5c\uff0c\u5220\u9664\u5f53\u6708\u6570\u636e\uff0c\u7531\u4e8e\u6570\u636e\u91cf\u53ef\u80fd\u6709 1 \u4ebf\u6761\u8bb0\u5f55\uff0c\u53ef\u80fd\u4f1a\u4ea7\u751f 100G \u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u5219\u8fd9\u6761 SQL \u5728\u63d0\u4ea4\u65f6\u9700\u8981\u7b49\u5f85 100G \u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5199\u5165\u78c1\u76d8\uff0c\u5982\u679c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u78c1\u76d8\u6bcf\u79d2\u5199\u5165\u901f\u5ea6\u4e3a 100M/\u79d2\uff0c\u81f3\u5c11\u8981\u7b49\u5f85 1000 \u79d2\u624d\u80fd\u5b8c\u6210\u8fd9\u4e2a\u4e8b\u52a1\u7684\u63d0\u4ea4\u3002</p> <p>\u6240\u4ee5\u5728 MySQL \u4e2d\uff0c\u4f60\u4e00\u5b9a\u8981\u5bf9\u5927\u4e8b\u52a1\u7279\u522b\u5bf9\u5f85</p> <ul> <li>\u8bbe\u8ba1\u65f6\uff0c\u628a DELETE \u5220\u9664\u64cd\u4f5c\u8f6c\u5316\u4e3a DROP TABLE/PARTITION \u64cd\u4f5c\uff1b</li> <li>\u4e1a\u52a1\u8bbe\u8ba1\u65f6\uff0c\u628a\u5927\u4e8b\u52a1\u62c6\u6210\u5c0f\u4e8b\u52a1\u3002</li> </ul> <p>\u5bf9\u4e8e\u7b2c\u4e00\u70b9\uff08\u628a DELETE \u5220\u9664\u64cd\u4f5c\u8f6c\u5316\u4e3a DROP TABLE/PARTITION \u64cd\u4f5c\uff09\uff0c\u4e3b\u8981\u662f\u5728\u8bbe\u8ba1\u65f6\u628a\u6d41\u6c34\u6216\u65e5\u5fd7\u7c7b\u7684\u8868\u6309\u65f6\u95f4\u5206\u8868\u6216\u8005\u5206\u533a\uff0c\u8fd9\u6837\u5728\u5220\u9664\u65f6\uff0c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5185\u5bb9\u5c31\u662f\u4e00\u6761 DROP TABLE/PARITION \u7684 SQL\uff0c\u5199\u5165\u901f\u5ea6\u5c31\u975e\u5e38\u5feb\u4e86\u3002</p> <p>\u800c\u7b2c\u4e8c\u70b9\uff08\u628a\u5927\u4e8b\u52a1\u62c6\u5206\u6210\u5c0f\u4e8b\u52a1\uff09\u4e5f\u80fd\u63a7\u5236\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u5927\u5c0f\u3002\u6bd4\u5982\u5bf9\u4e8e\u524d\u9762\u7684 DELETE \u64cd\u4f5c\uff0c\u5982\u679c\u8bbe\u8ba1\u65f6\u6ca1\u6709\u5206\u8868\u6216\u5206\u533a\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u8fdb\u884c\u5982\u4e0b\u9762\u7684\u5c0f\u4e8b\u52a1\u62c6\u5206\uff1a</p> <pre><code>DELETE FROM ...\n\nWHEREE time between ... and ...\n\nLIMIT 1000;\n</code></pre> <p>\u4e0a\u9762\u7684 SQL \u5c31\u662f\u628a\u4e00\u4e2a\u5927\u7684 DELETE \u64cd\u4f5c\u62c6\u5206\u6210\u4e86\u6bcf\u6b21\u5220\u9664 1000 \u6761\u8bb0\u5f55\u7684\u5c0f\u64cd\u4f5c\u3002\u800c\u5c0f\u4e8b\u52a1\u7684\u53e6\u4e00\u4e2a\u4f18\u52bf\u662f\uff1a\u53ef\u4ee5\u8fdb\u884c\u591a\u7ebf\u7a0b\u7684\u5e76\u53d1\u64cd\u4f5c\uff0c\u8fdb\u4e00\u6b65\u63d0\u5347\u5220\u9664\u6548\u7387\u3002</p> <p>MySQL \u6570\u636e\u5e93\u4e2d\uff0c\u5927\u4e8b\u52a1\u9664\u4e86\u4f1a\u5bfc\u81f4\u63d0\u4ea4\u901f\u5ea6\u53d8\u6162\uff0c\u8fd8\u4f1a\u5bfc\u81f4\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/#3-1","title":"3-1 \u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u4f18\u5316","text":"<p>\u8981\u5f7b\u5e95\u907f\u514d MySQL \u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\uff0c\u6570\u636e\u5e93\u7248\u672c\u81f3\u5c11\u8981\u5347\u7ea7\u5230 5.7</p> <p>MySQL \u7684\u4ece\u673a\u5e76\u884c\u590d\u5236\u6709\u4e24\u79cd\u6a21\u5f0f\u3002</p> <ul> <li>COMMIT ORDER\uff1a \u4e3b\u673a\u600e\u4e48\u5e76\u884c\uff0c\u4ece\u673a\u5c31\u600e\u4e48\u5e76\u884c\u3002</li> <li>WRITESET\uff1a \u57fa\u4e8e\u6bcf\u4e2a\u4e8b\u52a1\uff0c\u53ea\u8981\u4e8b\u52a1\u66f4\u65b0\u7684\u8bb0\u5f55\u4e0d\u51b2\u7a81\uff0c\u5c31\u53ef\u4ee5\u5e76\u884c\u3002</li> </ul> <p>\u800c WRITESET \u6a21\u5f0f\u662f\u57fa\u4e8e\u6bcf\u4e2a\u4e8b\u52a1\u5e76\u884c\uff0c\u5982\u679c\u4e8b\u52a1\u95f4\u66f4\u65b0\u7684\u8bb0\u5f55\u4e0d\u51b2\u7a81\uff0c\u5c31\u53ef\u4ee5\u5e76\u884c\u3002\u8fd8\u662f\u4ee5\u201c\u5355\u7ebf\u7a0b\u6bcf\u6b21\u63d2\u5165 1000 \u6761\u8bb0\u5f55\u201d\u4e3a\u4f8b\uff0c\u5982\u679c\u63d2\u5165\u7684\u8bb0\u5f55\u6ca1\u6709\u51b2\u7a81\uff0c\u6bd4\u5982\u552f\u4e00\u7d22\u5f15\u51b2\u7a81\uff0c\u90a3\u4e48\u867d\u7136\u4e3b\u673a\u662f\u5355\u7ebf\u7a0b\uff0c\u4f46\u4ece\u673a\u53ef\u4ee5\u662f\u591a\u7ebf\u7a0b\u5e76\u884c\u56de\u653e</p> <p>\u6240\u4ee5\u5728 WRITESET \u6a21\u5f0f\u4e0b\uff0c\u4e3b\u4ece\u590d\u5236\u51e0\u4e4e\u6ca1\u6709\u5ef6\u8fdf\u3002\u90a3\u4e48\u8981\u542f\u7528 WRITESET \u590d\u5236\u6a21\u5f0f\uff0c\u4f60\u9700\u8981\u505a\u8fd9\u6837\u7684\u914d\u7f6e\uff1a</p> <pre><code>binlog_transaction_dependency_tracking = WRITESET\n\ntransaction_write_set_extraction = XXHASH64\n\nslave-parallel-type = LOGICAL_CLOCK\n\nslave-parallel-workers = 16\n</code></pre> <p>\u56e0\u4e3a\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u4f1a\u5f71\u54cd\u5230\u540e\u7eed\u9ad8\u53ef\u7528\u7684\u5207\u6362\uff0c\u4ee5\u53ca\u8bfb\u5199\u5206\u79bb\u7684\u67b6\u6784\u8bbe\u8ba1\uff0c\u6240\u4ee5\u5728\u771f\u5b9e\u7684\u4e1a\u52a1\u4e2d\uff0c\u4f60\u8981\u5bf9\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u8fdb\u884c\u76d1\u63a7\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/#3-2","title":"3-2 \u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u76d1\u63a7","text":"<p><code>Seconds_Behind_Master</code></p> <p>SHOW SLAVE STATUS\uff0c\u5176\u4e2d\u7684 <code>Seconds_Behind_Master</code> \u53ef\u4ee5\u67e5\u770b\u590d\u5236\u5ef6\u8fdf\uff0c\u5982\uff1a</p> <p></p> <p><code>Seconds_Behind_Master</code> \u4e0d\u51c6\u786e\uff01\u7528\u4e8e\u4e25\u683c\u5224\u65ad\u4e3b\u4ece\u5ef6\u8fdf\u7684\u95ee\u9898\u5e76\u4e0d\u5408\u9002</p> <ul> <li>\u5b83\u8ba1\u7b97\u89c4\u5219\u662f\uff08\u5f53\u524d\u56de\u653e\u4e8c\u8fdb\u5236\u65f6\u95f4 - \u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e2d\u7684\u65f6\u95f4\uff09\uff0c\u5982\u679c I/O \u7ebf\u7a0b\u6709\u5ef6\u8fdf\uff0c\u90a3\u4e48 <code>Second_Behind_Master</code> \u4e3a 0\uff0c\u8fd9\u65f6\u53ef\u80fd\u5df2\u7ecf\u843d\u540e\u975e\u5e38\u591a\u4e86\uff0c\u4f8b\u5982\u5b58\u5728\u6709\u5927\u4e8b\u52a1\u7684\u60c5\u51b5\u4e0b\uff1b</li> <li>\u5bf9\u4e8e\u7ea7\u8054\u590d\u5236\uff0c\u6700\u4e0b\u6e38\u7684\u4ece\u670d\u52a1\u5668\u5ef6\u8fdf\u662f\u4e0d\u51c6\u786e\u7684\uff0c\u56e0\u4e3a\u5b83\u53ea\u8868\u793a\u548c\u4e0a\u4e00\u7ea7\u4e3b\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u5ef6\u8fdf\uff1b</li> <li>\u82e5\u4e3b\u4ece\u65f6\u533a\u4e0d\u4e00\u6837\uff0c\u90a3\u4e48 second_behind_master \u4e5f\u4e0d\u51c6\u786e\uff1b</li> </ul>"},{"location":"chap2_opt/5db_perf_replica/#3-3","title":"3-3 \u5fc3\u8df3\u8868","text":"<p>\u60f3\u8981\u5b9e\u65f6\u51c6\u786e\u5730\u76d1\u63a7\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\uff0c\u53ef\u4ee5\u5728\u4e3b\u670d\u52a1\u5668\u4e0a\u5f15\u5165\u4e00\u5f20\u5fc3\u8df3\u8868 heartbeat\uff0c\u7528\u4e8e\u5b9a\u671f\u66f4\u65b0\u65f6\u95f4\uff08\u6bd4\u5982\u6bcf 3 \u79d2\u4e00\u6b21\uff09\u3002\u4e8e\u4e3b\u4ece\u590d\u5236\u673a\u5236\uff0c\u4e3b\u673a\u4e0a\u5199\u5165\u7684\u65f6\u95f4\u4f1a\u88ab\u590d\u5236\u5230\u4ece\u673a\uff0c\u8fd9\u65f6\u5bf9\u4e8e\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u7684\u5224\u65ad\u53ef\u4ee5\u6839\u636e\u5982\u4e0b\u89c4\u5219\uff1a</p> <pre><code>\u4e3b\u4ece\u5ef6\u8fdf = \u4ece\u673a\u5f53\u524d\u65f6\u95f4 - \u8868 heartbeat \u4e2d\u7684\u65f6\u95f4\n</code></pre> <p>\u8868 heartbeat \u548c\u5b9a\u671f\u66f4\u65b0\u65f6\u95f4\u53ef\u4ee5\u6839\u636e\u7c7b\u4f3c\u7684\u8bbe\u8ba1\uff1a</p> <pre><code>USE DBA;\n\nCREATE TABLE heartbeat (\n\n  server-uuid VARCHAR(36) PRIMARY KEY,\n\n  ts TIMESTAMP(6) NOT NULL\n\n);\n\nREPLACE INTO heartbeat(@@server_uuid, NOW())\n</code></pre> <p>\u6211\u4eec\u521b\u5efa\u4e86DBA\u5e93\uff0c\u4ee5\u53ca\u5e93\u4e0b\u7684\u4e00\u5f20\u8868 heartbeat\uff0c\u7528\u4e8e\u8bb0\u5f55\u5f53\u524d\u65f6\u95f4\u3002</p> <p>REPLACE \u8bed\u53e5\u7528\u4e8e\u5b9a\u671f\u66f4\u65b0\u5f53\u524d\u65f6\u95f4\uff0c\u5e76\u5b58\u5165\u5230\u8868 heartbeat\uff0c\u8868 heartbeat \u5728\u6b63\u5e38\u8fd0\u884c\u60c5\u51b5\u4e0b\u53ea\u6709\u4e00\u6761\u8bb0\u5f55\u3002\u5b9a\u671f\u6267\u884c REPLACE \u8bed\u53e5\u53ef\u4ee5\u4f7f\u7528\u5b9a\u671f\u7684\u811a\u672c\u8c03\u5ea6\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 MySQL\u81ea\u5e26\u7684\u4e8b\u4ef6\u8c03\u5ea6\u5668\uff08event scheduler\uff09\uff0c\u5982\uff1a</p> <pre><code>CREATE EVENT e_heartbeat\n\nON SCHEDULE\n\n    EVERY 3 SECOND\n\nDO\n\nBEGIN\n\n    REPLACE INTO DBA.heartbeat VALUES (@@server_uuid,NOW())\n\nEND\n</code></pre>"},{"location":"chap2_opt/5db_perf_replica/#3-4","title":"3-4 \u8bfb\u5199\u5206\u79bb\u8bbe\u8ba1","text":"<p>\u8bfb\u5199\u5206\u79bb\u8bbe\u8ba1\u662f\u6307\uff1a\u628a\u5bf9\u6570\u636e\u5e93\u7684\u8bfb\u5199\u8bf7\u6c42\u5206\u5e03\u5230\u4e0d\u540c\u7684\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e0a\u3002\u5bf9\u4e8e\u5199\u5165\u64cd\u4f5c\u53ea\u80fd\u8bf7\u6c42\u4e3b\u670d\u52a1\u5668\uff0c\u800c\u5bf9\u8bfb\u53d6\u64cd\u4f5c\u5219\u53ef\u4ee5\u5c06\u8bfb\u53d6\u8bf7\u6c42\u5206\u5e03\u5230\u4e0d\u540c\u7684\u4ece\u670d\u52a1\u5668\u4e0a\u3002</p> <p>\u8fd9\u6837\u80fd\u6709\u6548\u964d\u4f4e\u4e3b\u670d\u52a1\u5668\u7684\u8d1f\u8f7d\uff0c\u63d0\u5347\u4ece\u670d\u52a1\u5668\u8d44\u6e90\u5229\u7528\u7387\uff0c\u4ece\u800c\u8fdb\u4e00\u6b65\u63d0\u5347\u6574\u4f53\u4e1a\u52a1\u7684\u6027\u80fd\u3002\u4e0b\u9762\u8fd9\u5f20\u56fe\u663e\u793a\u4e86\u4e00\u79cd\u5e38\u89c1\u7684\u4e1a\u52a1\u8bfb\u5199\u5206\u79bb\u7684\u67b6\u6784\u8bbe\u8ba1\uff1a</p> <p></p> <p>\u4e0a\u56fe\u5f15\u5165\u4e86 Load Balance \u8d1f\u8f7d\u5747\u8861\u7684\u7ec4\u4ef6\uff0c\u8fd9\u6837 Server \u5bf9\u4e8e\u6570\u636e\u5e93\u7684\u8bf7\u6c42\u4e0d\u7528\u5173\u5fc3\u540e\u9762\u6709\u591a\u5c11\u4e2a\u4ece\u673a\uff0c\u5bf9\u4e8e\u4e1a\u52a1\u6765\u8bf4\u4e5f\u5c31\u662f\u900f\u660e\u7684\uff0c\u53ea\u9700\u8bbf\u95ee Load Balance \u670d\u52a1\u5668\u7684 IP \u6216\u57df\u540d\u5c31\u53ef\u4ee5\u3002</p> <p>\u901a\u8fc7\u914d\u7f6e Load Balance \u670d\u52a1\uff0c\u8fd8\u80fd\u5c06\u8bfb\u53d6\u8bf7\u6c42\u5e73\u5747\u6216\u6309\u7167\u6743\u91cd\u5e73\u5747\u5206\u5e03\u5230\u4e0d\u540c\u7684\u4ece\u670d\u52a1\u5668\u3002\u8fd9\u53ef\u4ee5\u6839\u636e\u67b6\u6784\u7684\u9700\u8981\u505a\u7075\u6d3b\u7684\u8bbe\u8ba1\u3002</p> <p>\u8bfb\u5199\u5206\u79bb\u8bbe\u8ba1\u7684\u524d\u63d0\u662f\u4ece\u673a\u4e0d\u80fd\u843d\u540e\u4e3b\u673a\u5f88\u591a\uff0c\u6700\u597d\u662f\u80fd\u51c6\u5b9e\u65f6\u6570\u636e\u540c\u6b65\uff0c\u52a1\u5fc5\u4e00\u5b9a\u8981\u5f00\u59cb\u5e76\u884c\u590d\u5236\uff0c\u5e76\u786e\u4fdd\u7ebf\u4e0a\u5df2\u7ecf\u5c06\u5927\u4e8b\u52a1\u62c6\u6210\u5c0f\u4e8b\u52a1\u3002</p> <p></p> <p>\u5728 Load Balance \u670d\u52a1\u5668\uff0c\u53ef\u4ee5\u914d\u7f6e\u8f83\u5c0f\u6bd4\u4f8b\u7684\u8bfb\u53d6\u8bf7\u6c42\u8bbf\u95ee\u4e3b\u673a\uff0c\u5982\u4e0a\u56fe\u6240\u793a\u7684 1%\uff0c\u5176\u4f59\u4e09\u53f0\u4ece\u670d\u52a1\u5668\u5404\u81ea\u627f\u62c5 33% \u7684\u8bfb\u53d6\u8bf7\u6c42\u3002</p>"},{"location":"chap2_opt/5db_perf_replica/#3-5","title":"3-5 \u603b\u7ed3","text":"<p>\u57fa\u4e8e\u4e3b\u4ece\u590d\u5236\u673a\u5236\u642d\u5efa\u4e00\u4e2a\u8bfb\u5199\u5206\u79bb\u67b6\u6784\uff0c\u603b\u7684\u6765\u8bf4\uff1a</p> <ul> <li>MySQL \u4e8c\u8fdb\u5236\u65e5\u5fd7\u662f\u4e00\u79cd\u903b\u8f91\u65e5\u5fd7\uff0c\u4fbf\u4e8e\u5c06\u6570\u636e\u540c\u6b65\u5230\u5f02\u6784\u7684\u6570\u636e\u5e73\u53f0\uff1b</li> <li>\u903b\u8f91\u65e5\u5fd7\u5728\u4e8b\u52a1\u63d0\u4ea4\u65f6\u624d\u5199\u5165\uff0c\u82e5\u5b58\u5728\u5927\u4e8b\u52a1\uff0c\u5219\u63d0\u4ea4\u901f\u5ea6\u5f88\u6162\uff0c\u4e5f\u4f1a\u5f71\u54cd\u4e3b\u4ece\u6570\u636e\u4e4b\u95f4\u7684\u540c\u6b65\uff1b</li> <li>\u5728 MySQL \u4e2d\u52a1\u5fc5\u5c06\u5927\u4e8b\u52a1\u62c6\u5206\u6210\u5c0f\u4e8b\u52a1\u5904\u7406\uff0c\u8fd9\u6837\u624d\u80fd\u907f\u514d\u4e3b\u4ece\u6570\u636e\u5ef6\u8fdf\u7684\u95ee\u9898\uff1b</li> <li>\u901a\u8fc7\u914d\u7f6e MTS \u5e76\u884c\u590d\u5236\u673a\u5236\uff0c\u53ef\u4ee5\u8fdb\u4e00\u6b65\u7f29\u77ed\u4e3b\u4ece\u6570\u636e\u5ef6\u8fdf\u7684\u95ee\u9898\uff0c\u63a8\u8350\u4f7f\u7528 MySQL 5.7\u7248\u672c\uff0c\u5e76\u914d\u7f6e\u6210\u57fa\u4e8e WRITESET \u7684\u590d\u5236\uff1b</li> <li>\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u76d1\u63a7\u4e0d\u80fd\u4f9d\u8d56 <code>Seconds_Behind_Master</code> \u7684\u503c\uff0c\u6700\u597d\u7684\u65b9\u6cd5\u662f\u989d\u5916\u914d\u7f6e\u4e00\u5f20\u5fc3\u8df3\u8868\uff1b</li> <li>\u8bfb\u5199\u5206\u79bb\u662f\u4e00\u79cd\u67b6\u6784\u4e0a\u975e\u5e38\u5e38\u89c1\u7684\u65b9\u6cd5\uff0c\u4f60\u4e00\u5b9a\u8981\u638c\u63e1\uff0c\u5e76\u505a\u597d\u8bfb\u5199\u5206\u79bb\u67b6\u6784\u5931\u6548\u60c5\u51b5\u4e0b\u7684\u515c\u5e95\u8bbe\u8ba1\u3002</li> </ul>"},{"location":"chap2_opt/6db_ha/","title":"L6 MySQL\u9ad8\u53ef\u7528\u67b6\u6784","text":""},{"location":"chap2_opt/6db_ha/#1-","title":"1 \u91d1\u878d\u7ea7\u9ad8\u53ef\u7528\u67b6\u6784 - \u6570\u636e\u6838\u5bf9","text":"<p>\u4e5f\u5c31\u662f\u5f53\u670d\u52a1\u5668\u56e0\u4e3a\u5404\u79cd\u539f\u56e0\uff0c\u53d1\u751f\u5b95\u673a\uff0c\u5bfc\u81f4MySQL \u6570\u636e\u5e93\u4e0d\u53ef\u7528\u4e4b\u540e\uff0c\u5feb\u901f\u6062\u590d\u4e1a\u52a1\u3002\u4f46\u5bf9\u6709\u72b6\u6001\u7684\u6570\u636e\u5e93\u670d\u52a1\u6765\u8bf4\uff0c\u5728\u4e00\u4e9b\u6838\u5fc3\u4e1a\u52a1\u7cfb\u7edf\u4e2d\uff0c\u6bd4\u5982\u7535\u5546\u3001\u91d1\u878d\u7b49\uff0c\u8fd8\u8981\u4fdd\u8bc1\u6570\u636e\u4e00\u81f4\u6027\u3002</p> <p>\u4efb\u4f55\u707e\u96be\u573a\u666f\u4e0b\uff0c\u4e00\u6761\u6570\u636e\u90fd\u4e0d\u5141\u8bb8\u4e22\u5931\uff08\u4e00\u822c\u4e5f\u628a\u8fd9\u79cd\u6570\u636e\u590d\u5236\u65b9\u5f0f\u53eb\u4f5c\u201c\u5f3a\u540c\u6b65\u201d\uff09\u3002</p>"},{"location":"chap2_opt/6db_ha/#1-1","title":"1-1 \u590d\u5236\u7c7b\u578b\u7684\u9009\u62e9","text":"<p>\u94f6\u884c\u3001\u4fdd\u9669\u3001\u8bc1\u5238\u7b49\u6838\u5fc3\u4e1a\u52a1\uff0c\u9700\u8981\u4e25\u683c\u4fdd\u969c\u6570\u636e\u4e00\u81f4\u6027\u3002\u90a3\u4e48\u8981\u60f3\u5b9e\u73b0\u6570\u636e\u7684\u5f3a\u540c\u6b65\uff0c\u5728\u8fdb\u884c\u590d\u5236\u7684\u914d\u7f6e\u65f6\uff0c\u5c31\u8981\u4f7f\u7528\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\u6a21\u5f0f\u3002</p> <p>\u5728 MySQL \u5185\u90e8\u5c31\u662f\u8981\u628a\u53c2\u6570 <code>rpl_semi_sync_master_wait_point</code> \u8bbe\u7f6e\u6210 <code>AFTER_SYNC</code> \u3002</p> <p>\u4f46\u662f\u5728\u9ad8\u53ef\u7528\u8bbe\u8ba1\u65f6\uff0c\u5f53\u6570\u636e\u5e93 FAILOVER \u5b8c\u540e\uff0c\u6709\u65f6\u8fd8\u8981\u5bf9\u539f\u6765\u7684\u4e3b\u673a\u505a\u989d\u5916\u7684\u64cd\u4f5c\uff0c\u8fd9\u6837\u624d\u80fd\u4fdd\u8bc1\u4e3b\u4ece\u6570\u636e\u7684\u5b8c\u5168\u4e00\u81f4\u6027\u3002</p> <p></p> <p>\u5373\u4f7f\u542f\u7528\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\uff0c\u4f9d\u7136\u5b58\u5728\u5f53\u53d1\u751f\u4e3b\u673a\u5b95\u673a\u65f6\uff0c\u6700\u540e\u4e00\u7ec4\u4e8b\u52a1\u6ca1\u6709\u4e0a\u4f20\u5230\u4ece\u673a\u7684\u53ef\u80fd\u3002\u56fe\u4e2d\u5b95\u673a\u7684\u4e3b\u673a\u5df2\u7ecf\u63d0\u4ea4\u4e8b\u52a1\u5230 101\uff0c\u4f46\u662f\u4ece\u673a\u53ea\u63a5\u6536\u5230\u4e8b\u52a1 100\u3002\u5982\u679c\u8fd9\u4e2a\u65f6\u5019 Failover\uff0c\u4ece\u673a\u63d0\u5347\u4e3a\u4e3b\u673a\uff0c\u90a3\u4e48\u8fd9\u65f6\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\u5f53\u4e3b\u4ece\u5207\u6362\u5b8c\u6210\u540e\uff0c\u65b0\u7684 MySQL \u5f00\u59cb\u5199\u5165\u65b0\u7684\u4e8b\u52a1102\uff0c\u5982\u679c\u8fd9\u65f6\u8001\u7684\u4e3b\u670d\u52a1\u5668\u4ece\u5b95\u673a\u4e2d\u6062\u590d\uff0c\u5219\u8fd9\u65f6\u4e8b\u52a1 101 \u4e0d\u4f1a\u540c\u6b65\u5230\u65b0\u4e3b\u670d\u52a1\u5668\uff0c\u5bfc\u81f4\u4e3b\u4ece\u6570\u636e\u4e0d\u4e00\u81f4\u3002</p> <p>\u4f46\u8bbe\u7f6e <code>AFTER_SYNC</code> \u65e0\u635f\u534a\u540c\u6b65\u7684\u597d\u5904\u662f\uff0c\u867d\u7136\u4e8b\u52a1 101 \u5728\u539f\u4e3b\u673a\u5df2\u7ecf\u63d0\u4ea4\uff0c\u4f46\u662f\u5728\u4ece\u673a\u6ca1\u6709\u6536\u5230\u5e76\u8fd4\u56de ACK \u524d\uff0c\u8fd9\u4e2a\u4e8b\u52a1\u5bf9\u7528\u6237\u662f\u4e0d\u53ef\u89c1\u7684\uff0c\u6240\u4ee5\uff0c\u7528\u6237\u611f\u53d7\u4e0d\u5230\u4e8b\u52a1\u5df2\u7ecf\u63d0\u4ea4\u4e86\u3002</p>"},{"location":"chap2_opt/6db_ha/#1-2","title":"1-2 \u5bb9\u707e\u7ea7\u522b","text":"<p>\u9ad8\u53ef\u7528\u7528\u4e8e\u5904\u7406\u5404\u79cd\u5b95\u673a\u95ee\u9898\uff0c\u800c\u5b95\u673a\u53ef\u4ee5\u5206\u6210\u670d\u52a1\u5668\u5b95\u673a\u3001\u673a\u623f\u7ea7\u5b95\u673a\uff0c\u751a\u81f3\u662f\u4e00\u4e2a\u57ce\u5e02\u53d1\u751f\u5b95\u673a\u3002</p> <ul> <li>\u673a\u623f\u7ea7\u5b95\u673a\uff1a \u673a\u623f\u5149\u7ea4\u4e0d\u901a/\u88ab\u6316\u65ad\uff0c\u673a\u623f\u6574\u4f53\u6389\u7535\uff08\u53cc\u8def\u5907\u7528\u7535\u6e90\u4e5f\u4e0d\u53ef\u7528\uff09\uff1b</li> <li>\u57ce\u5e02\u7ea7\u5b95\u673a\uff1a \u4e00\u822c\u6307\u6574\u4e2a\u57ce\u5e02\u7684\u8fdb\u51fa\u53e3\u7f51\u7edc\uff0c\u9aa8\u5e72\u4ea4\u6362\u673a\u53d1\u751f\u7684\u6545\u969c\uff08\u8fd9\u79cd\u60c5\u51b5\u53d1\u751f\u7684\u6982\u7387\u5f88\u5c0f\uff09\u3002</li> </ul> <p>\u5982\u679c\u7efc\u5408\u8003\u8651\u7684\u8bdd\uff0c\u9ad8\u53ef\u7528\u5c31\u6210\u4e86\u4e00\u79cd\u5bb9\u707e\u5904\u7406\u673a\u5236\uff0c\u5bf9\u5e94\u7684\u9ad8\u53ef\u7528\u67b6\u6784\u7684\u8bc4\u5224\u6807\u51c6\u5c31\u4e0a\u5347\u4e86\u3002</p> <ul> <li>\u673a\u623f\u5185\u5bb9\u707e\uff1a \u673a\u623f\u5185\u67d0\u53f0\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e0d\u53ef\u7528\uff0c\u5207\u6362\u5230\u540c\u673a\u623f\u7684\u6570\u636e\u5e93\u5b9e\u4f8b\uff0c\u4fdd\u969c\u4e1a\u52a1\u8fde\u7eed\u6027\uff1b</li> <li>\u540c\u57ce\u5bb9\u707e\uff1a \u673a\u623f\u4e0d\u53ef\u7528\uff0c\u5207\u6362\u5230\u540c\u57ce\u673a\u623f\u7684\u6570\u636e\u5e93\u5b9e\u4f8b\uff0c\u4fdd\u969c\u4e1a\u52a1\u8fde\u7eed\u6027\uff1b</li> <li>\u8de8\u57ce\u5bb9\u707e\uff1a \u5355\u4e2a\u57ce\u5e02\u673a\u623f\u90fd\u4e0d\u53ef\u7528\uff0c\u5207\u6362\u5230\u8de8\u57ce\u673a\u623f\u7684\u6570\u636e\u5e93\u5b9e\u4f8b\uff0c\u4fdd\u969c\u4e1a\u52a1\u8fde\u7eed\u6027\u3002</li> </ul>"},{"location":"chap2_opt/6db_ha/#1-3","title":"1-3 \u515c\u5e95\u7b56\u7565\uff1a\u6570\u636e\u6838\u5bf9","text":"<p>\u9664\u4e86\u9ad8\u53ef\u7528\u7684\u5bb9\u707e\u67b6\u6784\u8bbe\u8ba1\uff0c\u6211\u4eec\u8fd8\u8981\u505a\u4e00\u5c42\u515c\u5e95\u670d\u52a1\uff0c\u7528\u4e8e\u5224\u65ad\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002\u8fd9\u91cc\u8981\u5f15\u5165\u6570\u636e\u6838\u5bf9\uff0c\u7528\u6765\u89e3\u51b3\u4ee5\u4e0b\u4e24\u65b9\u9762\u7684\u95ee\u9898\u3002</p> <ul> <li>\u6570\u636e\u5728\u4e1a\u52a1\u903b\u8f91\u4e0a\u4e00\u81f4\uff1a \u8fd9\u4e2a\u4fdd\u969c\u4e1a\u52a1\u662f\u5bf9\u7684\uff1b</li> <li>\u4e3b\u4ece\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u6570\u636e\u4e00\u81f4\uff1a \u8fd9\u4e2a\u4fdd\u969c\u4ece\u670d\u52a1\u5668\u7684\u6570\u636e\u662f\u5b89\u5168\u7684\u3001\u53ef\u5207\u7684\u3002</li> </ul> <p>\u4e1a\u52a1\u903b\u8f91\u6838\u5bf9\u7531\u4e1a\u52a1\u7684\u540c\u5b66\u8d1f\u8d23\u7f16\u5199</p> <p>\u4e3b\u4ece\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u6838\u5bf9\uff0c\u662f\u7531\u6570\u636e\u5e93\u56e2\u961f\u8d1f\u8d23\u7684\u3002</p> <p>\u8981\u989d\u5916\u5199\u4e00\u4e2a\u4e3b\u4ece\u6838\u5bf9\u670d\u52a1\uff0c\u7528\u4e8e\u4fdd\u969c\u4e3b\u4ece\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002\u8fd9\u4e2a\u6838\u5bf9\u4e0d\u4f9d\u8d56\u590d\u5236\u672c\u8eab\uff0c\u4e5f\u662f\u4e00\u79cd\u903b\u8f91\u6838\u5bf9\u3002\u601d\u8def\u662f\uff1a\u5c06\u6700\u8fd1\u4e00\u6bb5\u65f6\u95f4\u5185\u4e3b\u670d\u52a1\u5668\u4e0a\u53d8\u66f4\u8fc7\u7684\u8bb0\u5f55\u4e0e\u4ece\u670d\u52a1\u5668\u6838\u5bf9\uff0c\u4ece\u903b\u8f91\u4e0a\u9a8c\u8bc1\u662f\u5426\u4e00\u81f4\u3002\u5176\u5b9e\u73b0\u5982\u56fe\u6240\u793a\uff1a</p> <p></p> <ul> <li>\u8868\u7ed3\u6784\u8bbe\u8ba1\u89c4\u8303\u4e2d\uff0c\u6709\u8bb2\u8fc7\u6bcf\u5f20\u8868\u6709\u4e00\u4e2a <code>last_modify_date</code>\uff0c\u7528\u4e8e\u8bb0\u5f55\u6bcf\u6761\u8bb0\u5f55\u7684\u6700\u540e\u4fee\u6539\u65f6\u95f4\uff0c\u6309\u7167\u8fd9\u4e2a\u6761\u4ef6\u8fc7\u6ee4\u5c31\u80fd\u67e5\u51fa\u6700\u8fd1\u66f4\u65b0\u7684\u8bb0\u5f55\uff0c\u7136\u540e\u6bcf\u6761\u8bb0\u5f55\u6bd4\u8f83\u5373\u53ef\u3002</li> <li>\u6838\u5bf9\u670d\u52a1\u626b\u63cf\u6700\u8fd1\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u7b5b\u9009\u51fa\u6700\u8fd1\u66f4\u65b0\u8fc7\u8bb0\u5f55\u7684\u8868\u548c\u4e3b\u952e\uff0c\u7136\u540e\u6838\u5bf9\u6570\u636e\u3002\u8fd9\u79cd\u7684\u5b9e\u73b0\u96be\u5ea6\u4f1a\u66f4\u5927\u4e00\u4e9b\uff0c\u4f46\u662f\u4e0d\u8981\u6c42\u5728\u6570\u636e\u5e93\u4e0a\u8fdb\u884c\u67e5\u8be2</li> </ul> <p>\u5982\u679c\u5728\u6838\u5bf9\u8fc7\u7a0b\u4e2d\uff0c\u8bb0\u5f55\u53c8\u5728\u4e3b\u4e0a\u53d1\u751f\u4e86\u53d8\u5316\uff0c\u4f46\u662f\u8fd8\u6ca1\u6709\u540c\u6b65\u5230\u4ece\u673a\uff0c\u6211\u4eec\u53ef\u4ee5\u52a0\u5165\u590d\u6838\u903b\u8f91\uff0c\u6309\u7406\u6765\u8bf4\u591a\u590d\u6838\u51e0\u6b21\uff0c\u4e3b\u4ece\u6570\u636e\u5e94\u8be5\u5c31\u4e00\u81f4\u4e86\u3002\u5982\u679c\u590d\u6838\u591a\u6b21\u4e0d\u4e00\u81f4\uff0c\u90a3\u4e48\u5927\u6982\u7387\uff0c\u4e3b\u4ece\u6570\u636e\u5c31\u5df2\u7ecf\u662f\u4e0d\u4e00\u81f4\u7684\u4e86\u3002</p>"},{"location":"chap2_opt/6db_ha/#1-4","title":"1-4 \u603b\u7ed3","text":"<ul> <li>\u6838\u5fc3\u4e1a\u52a1\u590d\u5236\u52a1\u5fc5\u8bbe\u7f6e\u4e3a\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\uff1b</li> <li>\u540c\u57ce\u5bb9\u707e\u4f7f\u7528\u4e09\u56ed\u533a\u67b6\u6784\uff0c\u4e00\u5730\u4e09\u4e2d\u5fc3\uff0c\u6216\u8005\u4e24\u5730\u4e09\u4e2d\u5fc3\uff0c\u673a\u623f\u89c1\u7f51\u7edc\u5ef6\u8fdf\u4e0d\u8d85\u8fc7 5ms\uff1b</li> <li>\u8de8\u57ce\u5bb9\u707e\u4f7f\u7528\u201c\u4e09\u5730\u4e94\u4e2d\u5fc3\u201d\uff0c\u8de8\u57ce\u673a\u623f\u8ddd\u79bb\u8d85\u8fc7 200KM\uff0c\u5ef6\u8fdf\u8d85\u8fc7 25ms\uff1b</li> <li>\u8de8\u57ce\u5bb9\u707e\u67b6\u6784\u7531\u4e8e\u7f51\u7edc\u8017\u65f6\u9ad8\uff0c\u56e0\u6b64\u4e00\u822c\u4ec5\u7528\u4e8e\u8bfb\u591a\u5199\u5c11\u7684\u4e1a\u52a1\uff0c\u4f8b\u5982\u7528\u6237\u4e2d\u5fc3\uff1b</li> <li>\u9664\u4e86\u590d\u5236\u8fdb\u884c\u6570\u636e\u540c\u6b65\u5916\uff0c\u8fd8\u9700\u8981\u989d\u5916\u7684\u6838\u5bf9\u7a0b\u5e8f\u8fdb\u884c\u903b\u8f91\u6838\u5bf9\uff1b</li> <li>\u6570\u636e\u5e93\u5c42\u7684\u903b\u8f91\u6838\u5bf9\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>last_modify_date</code> \u5b57\u6bb5\uff0c\u53d6\u51fa\u6700\u8fd1\u4fee\u6539\u7684\u8bb0\u5f55\u3002</li> </ul>"},{"location":"chap2_opt/6db_ha/#2","title":"2 \u9ad8\u53ef\u7528\u5957\u4ef6","text":"<p>\u4f46\u662f\u5f53\u6570\u636e\u5e93\u53d1\u751f\u5b95\u673a\u65f6\uff0cMySQL \u7684\u4e3b\u4ece\u590d\u5236\u5e76\u4e0d\u4f1a\u81ea\u52a8\u5730\u5207\u6362\uff0c\u8fd9\u9700\u8981\u9ad8\u53ef\u7528\u5957\u4ef6\u5bf9\u6570\u636e\u5e93\u4e3b\u4ece\u8fdb\u884c\u7ba1\u7406\u3002</p>"},{"location":"chap2_opt/6db_ha/#2-1","title":"2-1 \u9ad8\u53ef\u7528\u5957\u4ef6","text":"<p>MySQL \u7684\u9ad8\u53ef\u7528\u5957\u4ef6\u7528\u4e8e\u8d1f\u8d23\u6570\u636e\u5e93\u7684 Failover \u64cd\u4f5c\uff0c\u4e5f\u5c31\u662f\u5f53\u6570\u636e\u5e93\u53d1\u751f\u5b95\u673a\u65f6\uff0cMySQL \u53ef\u4ee5\u5254\u9664\u539f\u6709\u4e3b\u673a\uff0c\u9009\u51fa\u65b0\u7684\u4e3b\u673a\uff0c\u7136\u540e\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\uff0c\u4fdd\u8bc1\u4e1a\u52a1\u7684\u8fde\u7eed\u6027\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0cMySQL \u590d\u5236\u662f\u9ad8\u53ef\u7528\u7684\u6280\u672f\u57fa\u7840\uff0c\u7528\u4e8e\u5c06\u6570\u636e\u5b9e\u65f6\u540c\u6b65\u5230\u4ece\u673a\u3002\u9ad8\u53ef\u7528\u5957\u4ef6\u662fMySQL \u9ad8\u53ef\u7528\u5b9e\u73b0\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u8d1f\u8d23\u5207\u6362\u65b0\u4e3b\u673a\u3002</p> <p>\u4e3a\u4e86\u4e0d\u8ba9\u4e1a\u52a1\u611f\u77e5\u5230\u6570\u636e\u5e93\u7684\u5b95\u673a\u5207\u6362\uff0c\u8fd9\u91cc\u8981\u7528\u5230 VIP\uff08Virtual IP\uff09\u6280\u672f\u3002\u5176\u4e2d\uff0cVIP \u4e0d\u662f\u771f\u5b9e\u7684\u7269\u7406 IP\uff0c\u800c\u662f\u53ef\u4ee5\u968f\u610f\u7ed1\u5b9a\u5728\u4efb\u4f55\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\u3002</p> <p>\u4e1a\u52a1\u8bbf\u95ee\u6570\u636e\u5e93\uff0c\u4e0d\u662f\u670d\u52a1\u5668\u4e0a\u4e0e\u7f51\u5361\u7ed1\u5b9a\u7684\u7269\u7406 IP\uff0c\u800c\u662f\u8fd9\u53f0\u670d\u52a1\u5668\u4e0a\u7684 VIP\u3002</p> <p>\u5f53\u6570\u636e\u5e93\u670d\u52a1\u5668\u53d1\u751f\u5b95\u673a\u65f6\uff0c\u9ad8\u53ef\u7528\u5957\u4ef6\u4f1a\u628a VIP \u63d2\u62d4\u5230\u65b0\u7684\u670d\u52a1\u5668\u4e0a\u3002\u6570\u636e\u5e93 Failover\u540e\uff0c\u4e1a\u52a1\u4f9d\u65e7\u8bbf\u95ee\u7684\u8fd8\u662f VIP\uff0c\u6240\u4ee5\u4f7f\u7528 VIP \u53ef\u4ee5\u505a\u5230\u5bf9\u4e1a\u52a1\u900f\u660e\u3002</p> <p></p> <p>\u4ece\u4e0a\u56fe\u53ef\u4ee5\u770b\u5230\uff0cMySQL \u7684\u4e3b\u670d\u52a1\u5668\u7684 IP \u5730\u5740\u662f 192.168.1.10\uff0c\u4e24\u4e2a\u4ece\u670d\u52a1\u5668\u7684 IP \u5730\u5740\u5206\u522b\u4e3a 192.168.1.20\u3001192.168.1.30\u3002</p> <p>\u4e0a\u5c42\u670d\u52a1\u8bbf\u95ee\u6570\u636e\u5e93\u5e76\u6ca1\u6709\u76f4\u63a5\u901a\u8fc7\u7269\u7406 IP 192.168.1.10\uff0c\u800c\u662f\u8bbf\u95ee VIP\uff0c\u5730\u5740\u4e3a192.168.1.100\u3002\u8fd9\u65f6\uff0c\u5982\u679c MySQL \u6570\u636e\u5e93\u4e3b\u670d\u52a1\u5668\u53d1\u751f\u5b95\u673a\uff0c\u4f1a\u8fdb\u884c\u5982\u4e0b\u7684\u5904\u7406\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u5f53\u53d1\u751f Failover \u540e\uff0c\u7531\u4e8e\u4e0a\u5c42\u670d\u52a1\u8bbf\u95ee\u7684\u662f VIP 192.168.1.100\uff0c\u6240\u4ee5\u5207\u6362\u5bf9\u670d\u52a1\u6765\u8bf4\u662f\u900f\u660e\u7684\uff0c\u53ea\u662f\u5728\u5207\u6362\u8fc7\u7a0b\u4e2d\uff0c\u670d\u52a1\u4f1a\u6536\u5230\u8fde\u63a5\u6570\u636e\u5e93\u5931\u8d25\u7684\u63d0\u793a\u3002\u4f46\u662f\u901a\u8fc7\u91cd\u8bd5\u673a\u5236\uff0c\u5f53\u4e0b\u5c42\u6570\u636e\u5e93\u5b8c\u6210\u5207\u6362\u540e\uff0c\u670d\u52a1\u5c31\u53ef\u4ee5\u7ee7\u7eed\u4f7f\u7528\u4e86\u3002</p> <p>\u6240\u4ee5\uff0c\u4e0a\u5c42\u670d\u52a1\u4e00\u5b9a\u8981\u505a\u597d\u9519\u8bef\u91cd\u8bd5\u7684\u903b\u8f91\uff0c\u5426\u5219\u5c31\u7b97\u542f\u7528 VIP\uff0c\u4e5f\u65e0\u6cd5\u5b9e\u73b0\u900f\u660e\u7684\u5207\u6362\u3002</p> <p>\u4e1a\u754c MySQL \u5e38\u89c1\u7684\u51e0\u6b3e\u9ad8\u53ef\u7528\u5957\u4ef6\u3002</p>"},{"location":"chap2_opt/6db_ha/#2-2-mha","title":"2-2 MHA","text":"<p>MHA(Master High Availability)\u662f\u4e00\u6b3e\u5f00\u6e90\u7684 MySQL \u9ad8\u53ef\u7528\u7a0b\u5e8f\uff0c\u5b83\u4e3a MySQL \u6570\u636e\u5e93\u4e3b\u4ece\u590d\u5236\u67b6\u6784\u63d0\u4f9b\u4e86 automating master failover \u7684\u529f\u80fd\u3002</p> <p>MHA \u662f\u7531\u4e1a\u754c\u5927\u540d\u9f0e\u9f0e\u7684 Facebook \u5de5\u7a0b\u5e08 Yoshinorim \u5f00\u53d1\uff0c\u5f00\u6e90\u5730\u5740\u4e3a\uff1ahttps://github.com/yoshinorim/mha4mysql-manager\u5b83\u7531\u4e24\u5927\u7ec4\u4ef6\u6240\u7ec4\u6210\uff0cMHA Manger \u548c MHA Node\u3002</p> <p>MHA Manager \u901a\u5e38\u90e8\u7f72\u5728\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\u7528\u6765\u5224\u65ad\u591a\u4e2a MySQL \u9ad8\u53ef\u7528\u7ec4\u662f\u5426\u53ef\u7528\u3002\u5f53\u53d1\u73b0\u6709\u4e3b\u670d\u52a1\u5668\u53d1\u751f\u5b95\u673a\uff0c\u5c31\u53d1\u8d77 failover \u64cd\u4f5c\u3002MHA Manger \u53ef\u4ee5\u770b\u4f5c\u662f failover \u7684\u603b\u63a7\u670d\u52a1\u5668\u3002</p> <p>\u800c MHA Node \u90e8\u7f72\u5728\u6bcf\u53f0 MySQL \u670d\u52a1\u5668\u4e0a\uff0cMHA Manager \u901a\u8fc7\u6267\u884c Node \u8282\u70b9\u7684\u811a\u672c\u5b8c\u6210failover \u5207\u6362\u64cd\u4f5c\u3002</p> <p>MHA Manager \u548c MHA Node \u7684\u901a\u4fe1\u662f\u91c7\u7528 ssh \u7684\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u6253\u901a MHA Manager \u5230\u6240\u6709 MySQL \u8282\u70b9\u7684 ssh \u7b56\u7565\uff0c\u90a3\u4e48\u8fd9\u91cc\u5c31\u5b58\u5728\u6f5c\u5728\u7684\u5b89\u5168\u98ce\u9669\u3002</p> <p>\u53e6\u5916\uff0cssh \u901a\u4fe1\uff0c\u6548\u7387\u4e5f\u4e0d\u662f\u7279\u522b\u9ad8\u3002\u6240\u4ee5\uff0cMHA \u6bd4\u8f83\u9002\u5408\u7528\u4e8e\u89c4\u6a21\u4e0d\u662f\u7279\u522b\u5927\u7684\u516c\u53f8\uff0c\u6240\u6709MySQL \u6570\u636e\u5e93\u7684\u670d\u52a1\u5668\u6570\u91cf\u4e0d\u8d85\u8fc7 20 \u53f0\u3002</p> <p></p>"},{"location":"chap2_opt/6db_ha/#2-3-orchestrator","title":"2-3 Orchestrator","text":"<p>Orchestrator \u662f\u53e6\u4e00\u6b3e\u5f00\u6e90\u7684 MySQL \u9ad8\u53ef\u7528\u5957\u4ef6\uff0c\u9664\u4e86\u652f\u6301 failover \u7684\u5207\u6362\uff0c\u8fd8\u53ef\u901a\u8fc7Orchestrator \u5b8c\u6210 MySQL \u6570\u636e\u5e93\u7684\u4e00\u4e9b\u7b80\u5355\u7684\u590d\u5236\u7ba1\u7406\u64cd\u4f5c\u3002Orchestrator \u7684\u5f00\u6e90\u5730\u5740\u4e3a\uff1ahttps://github.com/openark/orchestrator</p> <p>\u4f60\u53ef\u4ee5\u628a Orchestrator \u5f53\u6210 MHA \u7684\u5347\u7ea7\u7248\uff0c\u800c\u4e14\u63d0\u4f9b\u4e86 HTTP \u63a5\u53e3\u6765\u8fdb\u884c\u76f8\u5173\u6570\u636e\u5e93\u7684\u64cd\u4f5c\uff0c\u6bd4\u8d77 MHA \u9700\u8981\u6bcf\u6b21\u767b\u5f55 MHA Manager \u670d\u52a1\u5668\u6765\u8bf4\uff0c\u65b9\u4fbf\u5f88\u591a\u3002</p> <p></p> <p>\u5176\u57fa\u672c\u5b9e\u73b0\u539f\u7406\u4e0e MHA \u662f\u4e00\u6837\u7684\uff0c\u53ea\u662f\u628a\u5143\u6570\u636e\u4fe1\u606f\u5b58\u50a8\u5728\u4e86\u5143\u6570\u636e\u5e93\u4e2d\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86HTTP \u63a5\u53e3\u548c\u547d\u4ee4\u7684\u8bbf\u95ee\u65b9\u5f0f\uff0c\u4f7f\u7528\u4e0a\u66f4\u4e3a\u53cb\u597d\u3002</p> <p>\u4f46\u662f\u7531\u4e8e\u7ba1\u63a7\u8282\u70b9\u5230\u4e0b\u9762\u7684 MySQL \u6570\u636e\u5e93\u7684\u7ba1\u7406\u4f9d\u7136\u662f ssh \u7684\u65b9\u5f0f\uff0c\u4f9d\u7136\u5b58\u5728 MHA \u4e00\u6837\u7684\u77ed\u677f\u95ee\u9898\uff0c\u603b\u7684\u6765\u8bf4\uff0c\u5173\u4e8e Orchestrator \u6211\u60f3\u63d0\u9192\u4f60\uff0c\u4f9d\u7136\u53ea\u5efa\u8bae\u4f7f\u7528\u5728\u8f83\u5c0f\u89c4\u6a21\u7684\u6570\u636e\u5e93\u96c6\u7fa4\u3002</p>"},{"location":"chap2_opt/6db_ha/#3-innodb-cluster","title":"3 InnoDB Cluster","text":"<p>\u4e0d\u8fc7\uff0cMySQL \u590d\u5236\u53ea\u662f\u4e00\u79cd\u6570\u636e\u540c\u6b65\u6280\u672f\uff0c\u5982\u679c\u8981\u5b8c\u6210\u6570\u636e\u5e93\u7684\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\uff0c\u8fd8\u8981\u989d\u5916\u4f9d\u8d56\u5916\u90e8\u7684\u7ec4\u4ef6\uff0c\u6bd4\u5982 MHA\u3001Orchestrator\u3001\u6570\u636e\u5e93\u7ba1\u7406\u5e73\u53f0\u7b49\u3002</p> <p>\u6570\u636e\u5e93\u590d\u5236\u6280\u672f\u7684\u74f6\u9888\u5728\u4e8e\uff1a\u53ea\u80fd\u5728\u4e00\u4e2a\u8282\u70b9\u5b8c\u6210\u5199\u5165\uff0c\u7136\u540e\u518d\u5c06\u65e5\u5fd7\u540c\u6b65\u5404\u4e2a\u8282\u70b9\uff0c\u8fd9\u6837\u5355\u70b9\u5199\u5165\u4f1a\u5bfc\u81f4\u6570\u636e\u5e93\u6027\u80fd\u65e0\u6cd5\u8fdb\u884c\u6269\u5c55\u3002</p>"},{"location":"chap2_opt/6db_ha/#3-1-mgr","title":"3-1 MGR\u6280\u672f","text":"<p>MGR \u662f\u5b98\u65b9\u5728 MySQL 5.7 \u7248\u672c\u63a8\u51fa\u7684\u4e00\u79cd\u57fa\u4e8e\u72b6\u6001\u673a\u7684\u6570\u636e\u540c\u6b65\u673a\u5236\u3002\u4e0e\u534a\u540c\u6b65\u63d2\u4ef6\u7c7b\u4f3c\uff0cMGR \u662f\u901a\u8fc7\u63d2\u4ef6\u7684\u65b9\u5f0f\u542f\u7528\u6216\u7981\u7528\u6b64\u529f\u80fd\u3002</p> <p></p> <p>MGR \u590d\u5236\u7ed3\u6784\u56fe</p> <p>\u6ce8\u610f\uff0c\u6211\u4eec\u8c08\u53ca MGR\uff0c\u4e0d\u8981\u7b80\u5355\u8ba4\u4e3a\u5b83\u662f\u4e00\u79cd\u65b0\u7684\u6570\u636e\u540c\u6b65\u6280\u672f\uff0c\u800c\u662f\u5e94\u8be5\u628a\u5b83\u7406\u89e3\u4e3a\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\uff0c\u800c\u4e14\u7279\u522b\u9002\u5408\u5e94\u7528\u4e8e\u5bf9\u4e8e\u6570\u636e\u4e00\u81f4\u6027\u8981\u6c42\u6781\u9ad8\u7684\u91d1\u878d\u7ea7\u4e1a\u52a1\u573a\u666f\u3002</p> <p>\u9996\u5148\uff0cMGR \u4e4b\u95f4\u7684\u6570\u636e\u540c\u6b65\u5e76\u6ca1\u6709\u91c7\u7528\u590d\u5236\u6280\u672f\uff0c\u800c\u662f\u91c7\u7528 GCS\uff08Group Communication System\uff09\u534f\u8bae\u7684\u65e5\u5fd7\u540c\u6b65\u6280\u672f\u3002</p> <p>\u662f\u7684\uff0c\u867d\u7136\u901a\u8fc7\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\u4e5f\u80fd\u4fdd\u8bc1\u4e3b\u4ece\u6570\u636e\u7684\u4e00\u81f4\u6027\uff0c\u4f46\u901a\u8fc7 GCS \u8fdb\u884c\u6570\u636e\u540c\u6b65\u6709\u7740\u66f4\u597d\u7684\u6027\u80fd\uff1a\u5f53\u542f\u7528 MGR \u63d2\u4ef6\u65f6\uff0cMySQL \u4f1a\u65b0\u5f00\u542f\u4e00\u4e2a\u7aef\u53e3\u7528\u4e8e\u6570\u636e\u7684\u540c\u6b65\uff0c\u800c\u4e0d\u662f\u5982\u590d\u5236\u4e00\u6837\u4f7f\u7528MySQL \u670d\u52a1\u7aef\u53e3\uff0c\u8fd9\u6837\u4f1a\u5927\u5927\u63d0\u5347\u590d\u5236\u7684\u6548\u7387\u3002</p> <p>\u5176\u6b21\uff0cMGR \u6709\u4e24\u79cd\u6a21\u5f0f\uff1a</p> <ul> <li>\u5355\u4e3b\uff08Single Primary\uff09\u6a21\u5f0f\uff1b</li> <li>\u591a\u4e3b\uff08Multi Primary\uff09\u6a21\u5f0f\u3002</li> </ul> <p>\u5355\u4e3b\u6a21\u5f0f\u53ea\u6709 1 \u4e2a\u8282\u70b9\u53ef\u4ee5\u5199\u5165\uff0c\u591a\u4e3b\u6a21\u5f0f\u80fd\u8ba9\u6bcf\u4e2a\u8282\u70b9\u90fd\u53ef\u4ee5\u5199\u5165\u3002\u800c\u591a\u4e2a\u8282\u70b9\u4e4b\u95f4\u5199\u5165\uff0c\u5982\u679c\u5b58\u5728\u53d8\u66f4\u540c\u4e00\u884c\u7684\u51b2\u7a81\uff0cMySQL \u4f1a\u81ea\u52a8\u56de\u6eda\u5176\u4e2d\u4e00\u4e2a\u4e8b\u52a1\uff0c\u81ea\u52a8\u4fdd\u8bc1\u6570\u636e\u5728\u591a\u4e2a\u8282\u70b9\u4e4b\u95f4\u7684\u5b8c\u6574\u6027\u548c\u4e00\u81f4\u6027\u3002</p> <p>\u6700\u540e\uff0c\u5728\u5355\u4e3b\u6a21\u5f0f\u4e0b\uff0cMGR \u53ef\u4ee5\u81ea\u52a8\u8fdb\u884c Failover \u5207\u6362\uff0c\u4e0d\u7528\u4f9d\u8d56\u5916\u90e8\u7684\u5404\u79cd\u9ad8\u53ef\u7528\u5957\u4ef6\uff0c\u6240\u6709\u7684\u4e8b\u60c5\u90fd\u7531\u6570\u636e\u5e93\u81ea\u5df1\u5b8c\u6210\uff0c\u6bd4\u5982\u6700\u590d\u6742\u7684\u9009\u4e3b\uff08Primary Election\uff09\u903b\u8f91\uff0c\u90fd\u662f\u7531 MGR \u81ea\u5df1\u5b8c\u6210\uff0c\u7528\u6237\u4e0d\u7528\u90e8\u7f72\u989d\u5916\u7684 Agent \u7b49\u7ec4\u4ef6\u3002</p> <p>\u8bf4\u4e86\u8fd9\u4e48\u591a MGR \u7684\u4f18\u52bf\uff0c\u90a3\u4e48\u5b83\u6709\u6ca1\u6709\u7f3a\u70b9\u6216\u9650\u5236\u5462\uff1f \u5f53\u7136\u6709\uff0c\u4e3b\u8981\u662f\u8fd9\u6837\u51e0\u70b9\uff1a</p> <ul> <li>\u4ec5\u652f\u6301 InnoDB \u8868\uff0c\u5e76\u4e14\u6bcf\u5f20\u8868\u4e00\u5b9a\u8981\u6709\u4e00\u4e2a\u4e3b\u952e\uff1b</li> <li>\u76ee\u524d\u4e00\u4e2a MGR \u96c6\u7fa4\uff0c\u6700\u591a\u53ea\u652f\u6301 9 \u4e2a\u8282\u70b9\uff1b</li> <li>\u6709\u4e00\u4e2a\u8282\u70b9\u7f51\u7edc\u51fa\u73b0\u6296\u52a8\u6216\u4e0d\u7a33\u5b9a\uff0c\u4f1a\u5f71\u54cd\u96c6\u7fa4\u7684\u6027\u80fd\u3002</li> </ul>"},{"location":"chap2_opt/6db_ha/#3-2","title":"3-2 \u591a\u4e3b\u6a21\u5f0f\u7684\u6ce8\u610f\u4e8b\u9879","text":"<p>\u51b2\u7a81\u68c0\u6d4b</p> <p>\u591a\u4e3b\u6a21\u5f0f\u8981\u6c42\u6bcf\u4e2a\u4e8b\u52a1\u5728\u672c\u8282\u70b9\u63d0\u4ea4\u65f6\uff0c\u8fd8\u8981\u53bb\u9a8c\u8bc1\u5176\u4ed6\u8282\u70b9\u662f\u5426\u6709\u540c\u6837\u7684\u8bb0\u5f55\u4e5f\u6b63\u5728\u88ab\u4fee\u6539\u3002\u5982\u679c\u6709\u7684\u8bdd\uff0c\u5176\u4e2d\u4e00\u4e2a\u4e8b\u52a1\u8981\u88ab\u56de\u6eda\u3002</p> <p>\u6bd4\u5982\u4e24\u4e2a\u8282\u70b9\u540c\u65f6\u6267\u884c\u4e0b\u9762\u7684 SQL \u8bed\u53e5\uff1a</p> <pre><code>-- \u8282\u70b91\n\nUPDATE User set money = money - 100 WHERE id = 1;\n\n-- \u8282\u70b92\n\nUPDATE User set money = money + 300 WHERE id = 1;\n</code></pre> <p>\u5982\u679c\u4e00\u5f00\u59cb\u7528\u6237\u7684\u4f59\u989d\u4e3a 200\uff0c\u5f53\u8282\u70b9 1 \u6267\u884c SQL \u540e\uff0c\u7528\u6237\u4f59\u989d\u53d8\u4e3a 100\uff0c\u5f53\u8282\u70b9 2 \u6267\u884cSQL\uff0c\u7528\u6237\u4f59\u989d\u53d8\u5473\u4e86 500\uff0c\u8fd9\u6837\u5c31\u5bfc\u81f4\u4e86\u8282\u70b9\u6570\u636e\u7684\u4e0d\u540c\u3002</p> <p>\u6240\u4ee5 MGR \u591a\u4e3b\u6a21\u5f0f\u4f1a\u5728\u4e8b\u52a1\u63d0\u4ea4\u65f6\uff0c\u8fdb\u884c\u884c\u8bb0\u5f55\u51b2\u7a81\u68c0\u6d4b\uff0c\u53d1\u73b0\u51b2\u7a81\uff0c\u5c31\u4f1a\u5bf9\u4e8b\u52a1\u8fdb\u884c\u56de\u6eda\u3002</p> <p>\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u82e5\u8282\u70b9 2 \u4e0a\u7684\u4e8b\u52a1\u5148\u63d0\u4ea4\uff0c\u5219\u8282\u70b9 1 \u63d0\u4ea4\u65f6\u4f1a\u5931\u8d25\uff0c\u4e8b\u52a1\u4f1a\u8fdb\u884c\u56de\u6eda\u3002</p> <p>\u6240\u4ee5\uff0c\u5982\u679c\u8981\u53d1\u6325\u591a\u4e3b\u6a21\u5f0f\u7684\u4f18\u52bf\uff0c\u5c31\u8981\u907f\u514d\u5199\u5165\u65f6\u6709\u51b2\u7a81\u3002\u6700\u597d\u7684\u505a\u6cd5\u662f\uff1a\u6bcf\u4e2a\u8282\u70b9\u5199\u5404\u81ea\u7684\u6570\u636e\u5e93\uff0c\u6bd4\u5982\u8282\u70b9 1 \u5199 DB1\uff0c\u8282\u70b9 2 \u5199 DB2\uff0c\u8282\u70b9 3 \u5199 DB3\uff0c\u8fd9\u6837\u96c6\u7fa4\u7684\u5199\u5165\u6027\u80fd\u5c31\u80fd\u7ebf\u6027\u63d0\u5347\u4e86\u3002</p> <p>\u81ea\u589e\u5904\u7406</p> <p>\u5728\u591a\u4e3b\u6a21\u5f0f\u4e0b\uff0c\u81ea\u589e\u7684\u903b\u8f91\u53d1\u751f\u4e86\u5f88\u5927\u7684\u53d8\u5316\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u81ea\u589e\u4e0d\u518d\u8fde\u7eed\u81ea\u589e\u3002</p> <p>\u56e0\u4e3a\uff0c\u5982\u679c\u8fde\u7eed\u81ea\u589e\uff0c\u8fd9\u8981\u6c42\u6bcf\u6b21\u5199\u5165\u65f6\u8981\u7b49\u5f85\u81ea\u589e\u503c\u5728\u591a\u4e2a\u8282\u70b9\u4e2d\u7684\u5206\u914d\uff0c\u8fd9\u6837\u6027\u80fd\u4f1a\u5927\u5e45\u4e0b\u964d\uff0c\u6240\u4ee5 MGR \u591a\u4e3b\u6a21\u5f0f\u4e0b\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u81ea\u589e\u8d77\u59cb\u503c\u548c\u6b65\u957f\u6765\u89e3\u51b3\u81ea\u589e\u7684\u6027\u80fd\u95ee\u9898\u3002\u770b\u4e0b\u9762\u7684\u53c2\u6570\uff1a</p> <p><code>group_replication_auto_increment_increment = 7</code></p> <p>\u53c2\u6570 <code>group_replication_auto_increment_increment</code> \u9ed8\u8ba4\u4e3a 7\uff0c\u81ea\u589e\u8d77\u59cb\u503c\u5c31\u662f server-id\u3002</p> <p>\u5047\u8bbe MGR \u6709 3 \u4e2a\u8282\u70b9 Node1\u3001Node2\u3001Node3\uff0c\u5bf9\u5e94\u7684 server-id \u5206\u522b\u662f 1\u30012\u30013, \u5982\u679c\u8fd9\u65f6\u591a\u4e3b\u63d2\u5165\u81ea\u589e\u7684\u987a\u5e8f\u4e3a Node1\u3001Node1\u3001Node2\u3001Node3\u3001Node1\uff0c\u5219\u81ea\u589e\u503c\u4ea7\u751f\u7684\u7ed3\u679c\u4e3a\uff1a</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e\u662f\u591a\u4e3b\u6a21\u5f0f\uff0c\u5141\u8bb8\u591a\u4e2a\u8282\u70b9\u5e76\u53d1\u7684\u4ea7\u751f\u81ea\u589e\u503c\u3002\u6240\u4ee5\u81ea\u589e\u7684\u4ea7\u751f\u7ed3\u679c\u4e3a1\u30018\u300116\u300117\u300122\uff0c\u81ea\u589e\u503c\u4e0d\u4e00\u5b9a\u662f\u4e25\u683c\u8fde\u7eed\u7684\uff0c\u800c\u4ec5\u4ec5\u662f\u5355\u8c03\u9012\u589e\u7684\uff0c\u8fd9\u4e0e\u5355\u5b9e\u4f8b MySQL \u6709\u7740\u5f88\u5927\u7684\u4e0d\u540c\u3002</p> <p>\u5bf9\u4e8e\u6838\u5fc3\u4e1a\u52a1\u8868\uff0c\u8fd8\u662f\u4f7f\u7528\u6709\u5e8f UUID \u7684\u65b9\u5f0f\u66f4\u4e3a\u53ef\u9760\uff0c\u6027\u80fd\u4e5f\u4f1a\u66f4\u597d\u3002</p>"},{"location":"chap2_opt/6db_ha/#3-3-innodb-cluster","title":"3-3 InnoDB Cluster","text":"<p>MGR \u662f\u57fa\u4e8e Paxos \u7b97\u6cd5\u7684\u6570\u636e\u540c\u6b65\u673a\u5236\uff0c\u5c06\u6570\u636e\u5e93\u72b6\u6001\u548c\u65e5\u5fd7\u901a\u8fc7 Paxos \u7b97\u6cd5\u540c\u6b65\u5230\u5404\u4e2a\u8282\u70b9\uff0c\u4f46\u5982\u679c\u8981\u5b9e\u73b0\u4e00\u4e2a\u5b8c\u6574\u7684\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\uff0c\u5c31\u9700\u8981\u66f4\u9ad8\u4e00\u5c42\u7ea7\u7684 InnoDB Cluster \u5b8c\u6210\u3002</p> <p>\u4e00\u4e2a InnoDB Cluster \u7531\u4e09\u4e2a\u7ec4\u4ef6\u7ec4\u6210\uff1aMGR \u96c6\u7fa4\u3001MySQL Shell\u3001MySQL Router\u3002\u5177\u4f53\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5176\u4e2d\uff0cMySQL Shell \u7528\u6765\u7ba1\u7406 MGR \u96c6\u7fa4\u7684\u521b\u5efa\u3001\u53d8\u66f4\u7b49\u64cd\u4f5c\u3002\u4ee5\u540e\u6211\u4eec\u6700\u597d\u4e0d\u8981\u624b\u52a8\u53bb\u7ba1\u7406 MGR \u96c6\u7fa4\uff0c\u800c\u662f\u901a\u8fc7 MySQL Shell \u5c01\u88c5\u7684\u5404\u79cd\u63a5\u53e3\u5b8c\u6210 MGR \u7684\u5404\u79cd\u64cd\u4f5c\u3002\u5982\uff1a</p> <pre><code>mysql-js&gt; cluster.status()\n\n{\n\n    \"clusterName\": \"myCluster\", \n\n    \"defaultReplicaSet\": {\n\n        \"name\": \"default\", \n\n        \"primary\": \"ic-2:3306\", \n\n        \"ssl\": \"REQUIRED\", \n\n        \"status\": \"OK\", \n\n        \"statusText\": \"Cluster is ONLINE and can tolerate up to ONE failure.\", \n\n        \"topology\": {\n\n            \"ic-1:3306\": {\n\n                \"address\": \"ic-1:3306\", \n\n                \"mode\": \"R/O\", \n\n                \"readReplicas\": {}, \n\n                \"role\": \"HA\", \n\n                \"status\": \"ONLINE\"\n\n            }, \n\n            \"ic-2:3306\": {\n\n                \"address\": \"ic-2:3306\", \n\n                \"mode\": \"R/W\", \n\n                \"readReplicas\": {}, \n\n                \"role\": \"HA\", \n\n                \"status\": \"ONLINE\"\n\n            }, \n\n            \"ic-3:3306\": {\n\n                \"address\": \"ic-3:3306\", \n\n                \"mode\": \"R/O\", \n\n                \"readReplicas\": {}, \n\n                \"role\": \"HA\", \n\n                \"status\": \"ONLINE\"\n\n            }\n\n        }\n\n    }, \n\n    \"groupInformationSourceMember\": \"mysql://root@localhost:6446\"\n\n}\n</code></pre> <p>MySQL Router \u662f\u4e00\u4e2a\u8f7b\u91cf\u7ea7\u7684\u4ee3\u7406\uff0c\u7528\u4e8e\u4e1a\u52a1\u8bbf\u95ee MGR \u96c6\u7fa4\u4e2d\u7684\u6570\u636e\uff0c\u5f53 MGR \u53d1\u751f\u5207\u6362\u65f6\uff08\u8fd9\u91cc\u6307 Single Primary \u6a21\u5f0f\uff09\uff0c\u81ea\u52a8\u8def\u7531\u5230\u65b0\u7684 MGR \u4e3b\u8282\u70b9\uff0c\u8fd9\u6837\u4e1a\u52a1\u5c31\u4e0d\u7528\u611f\u77e5\u4e0b\u5c42MGR \u6570\u636e\u7684\u5207\u6362\u3002</p> <p>\u4e3a\u4e86\u51cf\u5c11\u5f15\u5165 MySQL Router \u5e26\u6765\u7684\u6027\u80fd\u5f71\u54cd\uff0c\u5b98\u65b9\u5efa\u8bae MySQL Router \u4e0e\u5ba2\u6237\u7aef\u7a0b\u5e8f\u90e8\u7f72\u5728\u4e00\u8d77\uff0c\u4ee5\u4e00\u79cd\u7c7b\u4f3c sidecar \u7684\u65b9\u5f0f\u8fdb\u884c\u7269\u7406\u90e8\u7f72\u3002\u8fd9\u6837\u80fd\u51cf\u5c11\u989d\u5916\u4e00\u6b21\u989d\u5916\u7684\u7f51\u7edc\u5f00\u9500\uff0c\u57fa\u672c\u6d88\u9664\u5f15\u5165 MySQL Router \u5e26\u6765\u7684\u5f71\u54cd\u3002</p> <p>\u6240\u4ee5\uff0c\u8fd9\u91cc MySQL Router \u7684\u5b9a\u4f4d\u662f\u4e00\u79cd\u8f7b\u91cf\u7ea7\u7684\u8def\u7531\u8f6c\u53d1\uff0c\u800c\u4e0d\u662f\u4e00\u4e2a\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\uff0c\u4e3b\u8981\u89e3\u51b3\u6570\u636e\u5e93\u5207\u6362\u540e\uff0c\u505a\u5230\u5bf9\u4e1a\u52a1\u65e0\u611f\u77e5\u3002</p>"},{"location":"chap2_opt/6db_ha/#3-4","title":"3-4 \u603b\u7ed3","text":"<p>InnoDB Cluster\u3002\u8fd9\u79cd\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\u5927\u6982\u7387\u4f1a\u6210\u4e3a\u4e0b\u4e00\u4ee3\u91d1\u878d\u573a\u666f\u7684\u6807\u51c6\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\uff0cInnoDB Cluster \u5e95\u5c42\u662f MGR\uff0c\u901a\u8fc7\u7c7b Paoxs \u7b97\u6cd5\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c\u6027\u80fd\u66f4\u597d\uff0c\u4e14\u80fd\u4fdd\u8bc1\u6570\u636e\u7684\u5b8c\u6574\u6027\u3002</p> <p>\u7ed3\u5408\u7ba1\u7406\u5de5\u5177 MySQL Shell\uff0c\u8def\u7531\u5de5\u5177 MySQL Router \u80fd\u6784\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684 MySQL \u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u5bf9\u4e8e\u91d1\u878d\u7528\u6237\u6765\u8bf4\uff0c\u6211\u975e\u5e38\u63a8\u8350\u8fd9\u79cd\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\u3002\u5f53\u7136\uff0c\u6211\u5efa\u8bae\u5728\u6700\u65b0\u7684 MySQL 8.0 \u7248\u672c\u4e2d\u4f7f\u7528 InnoDB Cluster\u3002</p>"},{"location":"chap2_opt/6db_ha/#4","title":"4 \u6570\u636e\u5e93\u5907\u4efd","text":""},{"location":"chap2_opt/6db_ha/#4-1","title":"4-1 \u6570\u636e\u5e93\u5907\u4efd","text":"<p>\u590d\u5236\u6280\u672f\uff08Replication\uff09\u6216 InnoDB Cluster \u53ea\u8d1f\u8d23\u4e1a\u52a1\u7684\u53ef\u7528\u6027\uff0c\u4fdd\u969c\u6570\u636e\u5b89\u5168\u9664\u4e86\u7ebf\u4e0a\u7684\u526f\u672c\u6570\u636e\u5e93\uff0c\u6211\u4eec\u8fd8\u8981\u6784\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684\u79bb\u7ebf\u5907\u4efd\u4f53\u7cfb\u3002\u8fd9\u6837\u5373\u4f7f\u7ebf\u4e0a\u6570\u636e\u5e93\u88ab\u5168\u90e8\u7834\u574f\uff0c\u7528\u6237\u4e5f\u53ef\u4ee5\u4ece\u79bb\u7ebf\u5907\u4efd\u6062\u590d\u51fa\u6570\u636e\u3002</p> <p>\u7b2c\u4e00\u6b65\u8981\u505a\u597d\uff1a\u7ebf\u4e0a\u6570\u636e\u5e93\u4e0e\u79bb\u7ebf\u5907\u4efd\u7cfb\u7edf\u7684\u6743\u9650\u9694\u79bb\u3002</p> <p>\u800c\u5bf9\u4e8e MySQL \u6570\u636e\u5e93\u6765\u8bf4\uff0c\u6570\u636e\u5e93\u5907\u4efd\u5206\u4e3a\u5168\u91cf\u5907\u4efd\u3001\u589e\u91cf\u5907\u4efd\u3002</p> <p>\u5168\u91cf\u5907\u4efd</p> <p>\u6307\u5907\u4efd\u5f53\u524d\u65f6\u95f4\u70b9\u6570\u636e\u5e93\u4e2d\u7684\u6240\u6709\u6570\u636e\uff0c\u6839\u636e\u5907\u4efd\u5185\u5bb9\u7684\u4e0d\u540c\uff0c\u5168\u91cf\u5907\u4efd\u53ef\u4ee5\u5206\u4e3a\u903b\u8f91\u5907\u4efd\u3001\u7269\u7406\u5907\u4efd\u4e24\u79cd\u65b9\u5f0f\u3002</p> <p>\u903b\u8f91\u5907\u4efd</p> <p>\u6307\u5907\u4efd\u6570\u636e\u5e93\u7684\u903b\u8f91\u5185\u5bb9\uff0c\u5c31\u662f\u6bcf\u5f20\u8868\u4e2d\u7684\u5185\u5bb9\u901a\u8fc7 INSERT \u8bed\u53e5\u7684\u5f62\u5f0f\u8fdb\u884c\u5907\u4efd\u3002</p> <p>MySQL \u5b98\u65b9\u63d0\u4f9b\u7684\u903b\u8f91\u5907\u4efd\u5de5\u5177\u6709 mysqldump \u548c mysqlpump\u3002\u901a\u8fc7 mysqldump \u8fdb\u884c\u5907\u4efd\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b SQL \u8bed\u53e5\uff1a</p> <pre><code>mysqldump -A --single-transaction &gt; backup.sql\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u5c31\u662f\u901a\u8fc7 mysqldump \u8fdb\u884c\u5168\u91cf\u7684\u903b\u8f91\u5907\u4efd\uff1a</p> <ul> <li>\u53c2\u6570 <code>-A</code> \u8868\u793a\u5907\u4efd\u6240\u6709\u6570\u636e\u5e93\uff1b</li> <li>\u53c2\u6570 <code>--single-transaction</code> \u8868\u793a\u8fdb\u884c\u4e00\u81f4\u6027\u7684\u5907\u4efd\u3002</li> </ul> <p>\u53c2\u6570 <code>--single-transaction</code> \u662f\u5fc5\u987b\u52a0\u7684\u53c2\u6570\uff0c\u5426\u5219\u5907\u4efd\u6587\u4ef6\u7684\u5185\u5bb9\u4e0d\u4e00\u81f4\uff0c\u8fd9\u6837\u7684\u5907\u4efd\u51e0\u4e4e\u6ca1\u6709\u610f\u4e49\u3002</p> <p>\u5982\u679c\u4f60\u603b\u5fd8\u8bb0\u53c2\u6570 <code>--single-transaction</code>\uff0c\u53ef\u4ee5\u5728 MySQL \u7684\u914d\u7f6e\u6587\u4ef6\u4e2d\u52a0\u4e0a\u5982\u4e0b\u63d0\u793a\uff1a</p> <pre><code># my.cnf \n\n[mysqldump]\n\nsingle-transaction\n</code></pre> <p>\u6309\u4e0a\u9762\u914d\u7f6e\uff0c\u6bcf\u5f53\u5728\u670d\u52a1\u5668\u4e0a\u8fd0\u884c\u547d\u4ee4\u65f6 mysqldump \u5c31\u4f1a\u81ea\u52a8\u52a0\u4e0a\u53c2\u6570 <code>--single-transaction</code>\uff0c\u4f60\u4e5f\u5c31\u4e0d\u4f1a\u518d\u5fd8\u8bb0\u4e86\u3002</p> <p>\u5728\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\uff0c\u6700\u7ec8\u7684\u5907\u4efd\u6587\u4ef6\u540d\u4e3a <code>backup.sql</code>\uff0c\u6253\u5f00\u8fd9\u4e2a\u6587\u4ef6\uff0c\u6211\u4eec\u4f1a\u770b\u5230\u7c7b\u4f3c\u7684\u5185\u5bb9\uff1a</p> <pre><code>-- MySQL dump 10.13  Distrib 8.0.23, for Linux (x86_64)\n\n--\n\n-- Host: localhost    Database:\n\n-- ------------------------------------------------------\n\n-- Server version       8.0.23\n\n/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;\n\n/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;\n\n/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;\n\n/*!50503 SET NAMES utf8mb4 */;\n\n/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;\n\n/*!40103 SET TIME_ZONE='+00:00' */;\n\n/*!50606 SET @OLD_INNODB_STATS_AUTO_RECALC=@@INNODB_STATS_AUTO_RECALC */;\n\n/*!50606 SET GLOBAL INNODB_STATS_AUTO_RECALC=OFF */;\n\n/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;\n\n/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;\n\n/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;\n\n/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;\n\n--\n\n-- Current Database: `mysql`\n\n--\n\nCREATE DATABASE /*!32312 IF NOT EXISTS*/ `mysql` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='N' */;\n\nUSE `mysql`;\n\n...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u6587\u4ef6 backup.sql \u672c\u8d28\u5c31\u662f\u4e00\u4e2a\u6587\u672c\u6587\u4ef6\uff0c\u91cc\u9762\u8bb0\u5f55\u7684\u5c31\u662f\u4e00\u6761\u6761 SQL \u8bed\u53e5\uff0c\u800c\u8fd9\u5c31\u662f\u6211\u4eec\u8bf4\u7684\u903b\u8f91\u5907\u4efd\u3002</p> <p>\u8981\u6062\u590d\u903b\u8f91\u5907\u4efd\u975e\u5e38\u7b80\u5355\uff0c\u5c31\u662f\u6267\u884c\u6587\u4ef6\u4e2d\u7684 SQL \u8bed\u53e5\uff0c\u8fd9\u65f6\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 SQL\uff1a</p> <pre><code>mysql &lt; backup.sql\n</code></pre> <p>\u867d\u7136 mysqldump \u7b80\u5355\u6613\u7528\uff0c\u4f46\u56e0\u4e3a\u5b83\u5907\u4efd\u662f\u5355\u7ebf\u7a0b\u8fdb\u884c\u7684\uff0c\u6240\u4ee5\u901f\u5ea6\u4f1a\u6bd4\u8f83\u6162\uff0c\u4e8e\u662f MySQL \u63a8\u51fa\u4e86 mysqlpump \u5de5\u5177\u3002</p> <p>\u547d\u4ee4 mysqlpump \u7684\u4f7f\u7528\u51e0\u4e4e\u4e0e mysqldump \u4e00\u6a21\u4e00\u6837\uff0c\u552f\u4e00\u4e0d\u540c\u7684\u662f\u5b83\u53ef\u4ee5\u8bbe\u7f6e\u5907\u4efd\u7684\u7ebf\u7a0b\u6570\uff0c\u5982\uff1a</p> <pre><code>mysqlpump -A --single-transaction --default-parallelism=8 &gt; backup.sql\n\nDump progress: 1/1 tables, 0/0 rows\n\nDump progress: 25/37 tables, 881632/42965650 rows\n\nDump progress: 25/37 tables, 1683132/42965650 rows\n\n......\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u663e\u793a\u4e86\u901a\u8fc7 mysqlpump \u8fdb\u884c\u5907\u4efd\u3002\u53c2\u6570 <code>--default-parallelism</code> \u8868\u793a\u8bbe\u7f6e\u5907\u4efd\u7684\u5e76\u884c\u7ebf\u7a0b\u6570\u3002\u6b64\u5916\uff0c\u4e0e mysqldump \u4e0d\u540c\u7684\u662f\uff0cmysqlpump \u5728\u5907\u4efd\u8fc7\u7a0b\u4e2d\u53ef\u4ee5\u67e5\u770b\u5907\u4efd\u7684\u8fdb\u5ea6\u3002</p> <p>\u4e0d\u8fc7\u5728\u771f\u6b63\u7684\u7ebf\u4e0a\u751f\u4ea7\u73af\u5883\u4e2d\uff0c\u6211\u5e76\u4e0d\u63a8\u8350\u4f60\u4f7f\u7528 mysqlpump\uff0c \u56e0\u4e3a\u5f53\u5907\u4efd\u5e76\u53d1\u7ebf\u7a0b\u6570\u8d85\u8fc7 1 \u65f6\uff0c\u5b83\u4e0d\u80fd\u6784\u5efa\u4e00\u4e2a\u4e00\u81f4\u6027\u7684\u5907\u4efd\u3002\u89c1 mysqlpump \u7684\u63d0\u793a\uff1a</p> <p>\u53e6\u5916\uff0cmysqlpump \u7684\u5907\u4efd\u591a\u7ebf\u7a0b\u662f\u57fa\u4e8e\u591a\u4e2a\u8868\u7684\u5e76\u884c\u5907\u4efd\uff0c\u5982\u679c\u6570\u636e\u5e93\u4e2d\u5b58\u5728\u4e00\u4e2a\u8d85\u7ea7\u5927\u8868\uff0c\u90a3\u4e48\u5bf9\u4e8e\u8fd9\u4e2a\u8868\u7684\u5907\u4efd\u4f9d\u7136\u8fd8\u662f\u5355\u7ebf\u7a0b\u7684\u3002\u90a3\u4e48\u6709\u6ca1\u6709\u4e00\u79cd\u57fa\u4e8e\u8bb0\u5f55\u7ea7\u522b\u7684\u5e76\u884c\u5907\u4efd\uff0c\u4e14\u652f\u6301\u4e00\u81f4\u6027\u7684\u903b\u8f91\u5907\u4efd\u5de5\u5177\u5462\uff1f</p> <p></p> <p>\u6709\u7684\uff0c\u90a3\u5c31\u662f\u5f00\u6e90\u7684 mydumper \u5de5\u5177\uff0c\u5730\u5740\uff1ahttps://github.com/maxbube/mydumper\u3002mydumper \u7684\u5f3a\u5927\u4e4b\u5904\u5728\u4e8e\uff1a</p> <ul> <li>\u652f\u6301\u4e00\u81f4\u6027\u7684\u5907\u4efd\uff1b</li> <li>\u53ef\u4ee5\u6839\u636e\u8868\u4e2d\u7684\u8bb0\u5f55\u8fdb\u884c\u5206\u7247\uff0c\u4ece\u800c\u8fdb\u884c\u591a\u7ebf\u7a0b\u7684\u5907\u4efd\uff1b</li> <li>\u5bf9\u4e8e\u6062\u590d\u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u662f\u591a\u7ebf\u7a0b\u7684\u5907\u4efd\uff1b</li> <li>\u53ef\u4ee5\u6307\u5b9a\u5355\u4e2a\u8868\u8fdb\u884c\u591a\u7ebf\u7a0b\u7684\u6062\u590d\u3002</li> </ul> <p>mydumper \u51e0\u4e4e\u662f\u4e00\u4e2a\u5b8c\u7f8e\u7684\u903b\u8f91\u5907\u4efd\u5de5\u5177\uff0c\u662f\u6784\u5efa\u5907\u4efd\u7cfb\u7edf\u7684\u9996\u9009\u5de5\u5177\u3002\u6211\u63d0\u4f9b\u7ed9\u4f60\u4e00\u4e2a\u7b80\u5355\u7684 mydumper \u7684\u4f7f\u7528\u65b9\u6cd5\uff1a</p> <pre><code>mydumper -o /bak -r 100000 --trx-consistency-only -t 8\n</code></pre> <p>\u4e0a\u9762\u7684\u547d\u4ee4\u8868\u793a\uff0c\u5c06\u5907\u4efd\u6587\u4ef6\u4fdd\u5b58\u5230\u76ee\u5f55 <code>/bak</code>\u4e0b\uff0c\u5176\u4e2d\uff1a</p> <ul> <li>\u53c2\u6570 <code>-r</code>\u8868\u793a\u6bcf\u5f20\u8868\u5bfc\u51fa 100000 \u6761\u8bb0\u5f55\u540e\u4fdd\u5b58\u5230\u4e00\u5f20\u8868\uff1b</li> <li>\u53c2\u6570 <code>--trx-consistency-only</code>\u8868\u793a\u4e00\u81f4\u6027\u5907\u4efd\uff1b</li> <li>\u53c2\u6570 <code>-t</code> \u8868\u793a 8 \u4e2a\u7ebf\u7a0b\u5e76\u884c\u5907\u4efd\u3002</li> </ul> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5373\u4fbf\u5bf9\u4e8e\u4e00\u5f20\u5927\u8868\uff0c\u4e5f\u53ef\u4ee5\u4ee5 8 \u4e2a\u7ebf\u7a0b\uff0c\u6309\u7167\u6bcf\u6b21 10000 \u6761\u8bb0\u5f55\u7684\u65b9\u5f0f\u8fdb\u884c\u5907\u4efd\uff0c\u8fd9\u6837\u5927\u5927\u63d0\u5347\u4e86\u5907\u4efd\u7684\u6027\u80fd\u3002</p> <p>\u7269\u7406\u5907\u4efd</p> <p>\u5f53\u7136\uff0c\u903b\u8f91\u5907\u4efd\u867d\u7136\u597d\uff0c\u4f46\u662f\u5b83\u6240\u9700\u8981\u7684\u65f6\u95f4\u6bd4\u8f83\u957f\uff0c\u56e0\u4e3a\u672c\u8d28\u4e0a\u903b\u8f91\u5907\u4efd\u5c31\u662f\u8fdb\u884c <code>INSERT ... SELECT ...</code> \u7684\u64cd\u4f5c\u3002</p> <p>\u800c\u7269\u7406\u5907\u4efd\u76f4\u63a5\u5907\u4efd\u6570\u636e\u5e93\u7684\u7269\u7406\u8868\u7a7a\u95f4\u6587\u4ef6\u548c\u91cd\u505a\u65e5\u5fd7\uff0c\u4e0d\u7528\u901a\u8fc7\u903b\u8f91\u7684 SELECT \u53d6\u51fa\u6570\u636e\u3002\u6240\u4ee5\u7269\u7406\u5907\u4efd\u7684\u901f\u5ea6\uff0c\u901a\u5e38\u662f\u6bd4\u903b\u8f91\u5907\u4efd\u5feb\u7684\uff0c\u6062\u590d\u901f\u5ea6\u4e5f\u6bd4\u8f83\u5feb\u3002</p> <p>\u4f46\u5b83\u4e0d\u5982 mydumper \u7684\u662f\uff0c\u7269\u7406\u5907\u4efd\u53ea\u80fd\u6062\u590d\u6574\u4e2a\u5b9e\u4f8b\u7684\u6570\u636e\uff0c\u800c\u4e0d\u80fd\u6309\u6307\u5b9a\u8868\u8fdb\u884c\u6062\u590d\u3002MySQL 8.0 \u7684\u7269\u7406\u5907\u4efd\u5de5\u5177\u53ef\u4ee5\u9009\u62e9\u5b98\u65b9\u7684 Clone Plugin\u3002</p> <p>Clone Plugin \u662f MySQL 8.0.17 \u7248\u672c\u63a8\u51fa\u7684\u7269\u7406\u5907\u4efd\u5de5\u5177\u63d2\u4ef6\uff0c\u5728\u5b89\u88c5\u5b8c\u63d2\u4ef6\u540e\uff0c\u5c31\u53ef\u4ee5\u5bf9MySQL \u8fdb\u884c\u7269\u7406\u5907\u4efd\u4e86\u3002\u800c\u6211\u4eec\u8981\u4f7f\u7528 Clone Plugin \u5c31\u8981\u5148\u5b89\u88c5 Clone Plugin \u63d2\u4ef6\uff0c\u63a8\u8350\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8fdb\u884c\u5982\u4e0b\u8bbe\u7f6e\uff1a</p> <pre><code>[mysqld]\n\nplugin-load-add=mysql_clone.so\n\nclone=FORCE_PLUS_PERMANENT\n</code></pre> <p>\u8fd9\u65f6\u8fdb\u884c\u7269\u7406\u5907\u4efd\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>mysql&gt; CLONE LOCAL DATA DIRECTORY = '/path/to/clone_dir';\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728 mysql \u547d\u4ee4\u884c\u4e0b\u8f93\u5165 clone \u547d\u4ee4\uff0c\u5c31\u53ef\u4ee5\u8fdb\u884c\u672c\u5730\u5b9e\u4f8b\u7684 MySQL \u7269\u7406\u5907\u4efd\u4e86\u3002</p> <p>Clone Plugin \u63d2\u4ef6\u5f3a\u5927\u4e4b\u5904\u8fd8\u5728\u4e8e\u5176\u53ef\u4ee5\u8fdb\u884c\u8fdc\u7a0b\u7684\u7269\u7406\u5907\u4efd\uff0c\u547d\u4ee4\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>CLONE INSTANCE FROM 'user'@'host':port\n\nIDENTIFIED BY 'password'\n\n[DATA DIRECTORY [=] 'clone_dir']\n\n[REQUIRE [NO] SSL];\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u547d\u4ee4\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0cClone Plugin \u652f\u6301\u6307\u5b9a\u7684\u7528\u6237\u540d\u5bc6\u7801\uff0c\u5907\u4efd\u8fdc\u7a0b\u7684\u7269\u7406\u5907\u4efd\u5230\u5f53\u524d\u670d\u52a1\u5668\u4e0a\uff0c\u6839\u636e Clone Plugin \u53ef\u4ee5\u975e\u5e38\u5bb9\u6613\u5730\u6784\u5efa\u5907\u4efd\u7cfb\u7edf\u3002</p> <p>\u5bf9\u4e8e MySQL 8.0 \u4e4b\u524d\u7684\u7248\u672c\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u7b2c\u4e09\u65b9\u5f00\u6e90\u5de5\u5177 Xtrabackup\uff0c\u5b98\u65b9\u7f51\u5740\uff1ahttps://github.com/percona/percona-xtrabackup\u3002</p> <p>\u4e0d\u8fc7\uff0c\u7269\u7406\u5907\u4efd\u5b9e\u73b0\u673a\u5236\u8f83\u903b\u8f91\u5907\u4efd\u590d\u5236\u5f88\u591a\uff0c\u9700\u8981\u6df1\u5165\u4e86\u89e3 MySQL \u6570\u636e\u5e93\u5185\u6838\u7684\u5b9e\u73b0\uff0c\u6211\u5f3a\u70c8\u5efa\u8bae\u4f7f\u7528 MySQL \u5b98\u65b9\u7684\u7269\u7406\u5907\u4efd\u5de5\u5177\uff0c\u5f00\u6e90\u7b2c\u4e09\u65b9\u7269\u7406\u5907\u4efd\u5de5\u5177\u53ea\u4f5c\u4e3a\u4e00\u4e9b\u573a\u666f\u7684\u8f85\u52a9\u624b\u6bb5\u3002</p> <p>\u589e\u91cf\u5907\u4efd</p> <p>\u6240\u4ee5\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u201c\u5168\u91cf\u5907\u4efd + \u589e\u91cf\u5907\u4efd\u201d\u7684\u65b9\u5f0f\uff0c\u6784\u5efa\u5b8c\u6574\u7684\u5907\u4efd\u7b56\u7565\u3002\u589e\u91cf\u5907\u4efd\u5c31\u662f\u5bf9\u65e5\u5fd7\u6587\u4ef6\u8fdb\u884c\u5907\u4efd\uff0c\u5728 MySQL \u6570\u636e\u5e93\u4e2d\u5c31\u662f\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u3002</p> <p>\u56e0\u4e3a\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4fdd\u5b58\u4e86\u5bf9\u6570\u636e\u5e93\u6240\u6709\u53d8\u66f4\u7684\u4fee\u6539\uff0c\u6240\u4ee5\u201c\u5168\u91cf\u5907\u4efd + \u589e\u91cf\u5907\u4efd\u201d\uff0c\u5c31\u53ef\u4ee5\u5b9e\u73b0\u57fa\u4e8e\u65f6\u95f4\u70b9\u7684\u6062\u590d\uff08point in time recovery\uff09\uff0c\u4e5f\u5c31\u662f\u201c\u901a\u8fc7\u5168\u91cf + \u589e\u91cf\u5907\u4efd\u201d\u53ef\u4ee5\u6062\u590d\u5230\u4efb\u610f\u65f6\u95f4\u70b9\u3002</p> <p>\u5168\u91cf\u5907\u4efd\u65f6\u4f1a\u8bb0\u5f55\u8fd9\u4e2a\u5907\u4efd\u5bf9\u5e94\u7684\u65f6\u95f4\u70b9\u4f4d\uff0c\u4e00\u822c\u662f\u67d0\u4e2a GTID \u4f4d\u7f6e\uff0c\u589e\u91cf\u5907\u4efd\u53ef\u4ee5\u5728\u8fd9\u4e2a\u70b9\u4f4d\u540e\u91cd\u653e\u65e5\u5fd7\uff0c\u8fd9\u6837\u5c31\u80fd\u5b9e\u73b0\u57fa\u4e8e\u65f6\u95f4\u70b9\u7684\u6062\u590d\u3002</p> <p>\u5982\u679c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5b58\u5728\u4e00\u4e9b\u5220\u5e93\u7684\u64cd\u4f5c\uff0c\u53ef\u4ee5\u8df3\u8fc7\u8fd9\u4e9b\u70b9\uff0c\u7136\u540e\u63a5\u7740\u91cd\u653e\u540e\u7eed\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u8fd9\u6837\u5c31\u80fd\u5bf9\u6781\u7aef\u5220\u5e93\u573a\u666f\u8fdb\u884c\u707e\u96be\u6062\u590d\u4e86\u3002</p> <p>\u60f3\u8981\u51c6\u5b9e\u65f6\u5730\u589e\u91cf\u5907\u4efd MySQL \u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\uff1a</p> <pre><code>mysqlbinlog --read-from-remote-server --host=host_name --raw --stop-never binlog.000001\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u589e\u91cf\u5907\u4efd\u5c31\u662f\u4f7f\u7528\u4e4b\u524d\u4e86\u89e3\u7684 mysqlbinlog\uff0c</p> <ul> <li>\u4f46\u8fd9\u6b21\u989d\u5916\u52a0\u4e0a\u4e86\u53c2\u6570 <code>--read-from-remote-server</code>\uff0c\u8868\u793a\u53ef\u4ee5\u4ece\u8fdc\u7a0b\u67d0\u4e2a MySQL \u4e0a\u62c9\u53d6\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u8fd9\u4e2a\u8fdc\u7a0b MySQL \u5c31\u662f\u7531\u53c2\u6570 <code>--host</code> \u6307\u5b9a\u3002</li> <li>\u53c2\u6570 <code>--raw</code> \u8868\u793a\u6839\u636e\u4e8c\u8fdb\u5236\u7684\u65b9\u5f0f\u8fdb\u884c\u62c9\u53d6\uff0c\u53c2\u6570 <code>--stop-never</code> \u8868\u793a\u6c38\u8fdc\u4e0d\u8981\u505c\u6b62\uff0c\u5373\u4e00\u76f4\u62c9\u53d6\u4e00\u76f4\u4fdd\u5b58\uff0c\u53c2\u6570 <code>binlog.000001</code> \u8868\u793a\u4ece\u8fd9\u4e2a\u6587\u4ef6\u5f00\u59cb\u62c9\u53d6\u3002</li> <li>MySQL \u589e\u91cf\u5907\u4efd\u7684\u672c\u8d28\u662f\u901a\u8fc7 <code>mysqlbinlog</code> \u6a21\u62df\u4e00\u4e2a <code>slave</code> \u4ece\u670d\u52a1\u5668\uff0c\u7136\u540e\u4e3b\u670d\u52a1\u5668\u4e0d\u65ad\u5c06\u4e8c\u8fdb\u5236\u65e5\u5fd7\u63a8\u9001\u7ed9\u4ece\u670d\u52a1\u5668\uff0c\u5229\u7528\u4e4b\u524d\u4ecb\u7ecd\u7684\u590d\u5236\u6280\u672f\uff0c\u5b9e\u73b0\u6570\u636e\u5e93\u7684\u589e\u91cf\u5907\u4efd\u3002</li> </ul> <p>\u589e\u91cf\u5907\u4efd\u7684\u6062\u590d\uff0c\u5c31\u662f\u901a\u8fc7 mysqlbinlog \u89e3\u6790\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u7136\u540e\u8fdb\u884c\u6062\u590d\uff0c\u5982\uff1a</p> <pre><code>mysqlbinlog binlog.000001 binlog.000002 | mysql -u root -p\n</code></pre>"},{"location":"chap2_opt/6db_ha/#3-5","title":"3-5 \u5907\u4efd\u6587\u4ef6\u7684\u68c0\u67e5","text":"<p>\u4e3b\u4ece\u590d\u5236\u7684\u9ad8\u53ef\u7528\u67b6\u6784\uff0c\u8fd8\u9700\u8981\u8fdb\u884c\u4e3b\u4ece\u4e4b\u95f4\u7684\u6570\u636e\u6838\u5bf9\uff0c\u7528\u6765\u786e\u4fdd\u6570\u636e\u662f\u771f\u5b9e\u4e00\u81f4\u7684\u3002</p> <p>\u540c\u6837\uff0c\u5bf9\u4e8e\u5907\u4efd\u6587\u4ef6\uff0c\u4e5f\u9700\u8981\u8fdb\u884c\u6821\u9a8c\uff0c\u624d\u80fd\u786e\u4fdd\u5907\u4efd\u6587\u4ef6\u7684\u6b63\u786e\u7684\uff0c\u5f53\u771f\u7684\u53d1\u751f\u707e\u96be\u65f6\uff0c\u53ef\u901a\u8fc7\u5907\u4efd\u6587\u4ef6\u8fdb\u884c\u6062\u590d\u3002\u56e0\u6b64\uff0c\u5907\u4efd\u7cfb\u7edf\u8fd8\u9700\u8981\u4e00\u4e2a\u5907\u4efd\u6587\u4ef6\u7684\u6821\u9a8c\u529f\u80fd\u3002</p> <p>\u5907\u4efd\u6587\u4ef6\u6821\u9a8c\u7684\u5927\u81f4\u903b\u8f91\u662f\u6062\u590d\u5168\u90e8\u6587\u4ef6\uff0c\u63a5\u7740\u901a\u8fc7\u589e\u91cf\u5907\u4efd\u8fdb\u884c\u6062\u590d\uff0c\u7136\u540e\u5c06\u6062\u590d\u7684 MySQL\u5b9e\u4f8b\u8fde\u4e0a\u7ebf\u4e0a\u7684 MySQL \u670d\u52a1\u5668\u4f5c\u4e3a\u4ece\u670d\u52a1\u5668\uff0c\u7136\u540e\u518d\u6b21\u8fdb\u884c\u6570\u636e\u6838\u5bf9\u3002</p>"},{"location":"chap2_opt/7Dist_db/","title":"L7 \u5206\u5e03\u5f0f\u67b6\u6784\u7bc7","text":""},{"location":"chap2_opt/7Dist_db/#1","title":"1 \u5f7b\u5e95\u7406\u89e3\u4ec0\u4e48\u53eb\u5206\u5e03\u5f0f\u6570\u636e\u5e93","text":"<p>A distributed database is a database in which data is stored across different physical locations. It may be stored in multiple computers located in the same physical location (e.g. a data centre); or maybe dispersed over a network of interconnected computers.</p> <p>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u662f\u4e00\u79cd\u628a\u6570\u636e\u5206\u6563\u5b58\u50a8\u5728\u4e0d\u540c\u7269\u7406\u4f4d\u7f6e\u7684\u6570\u636e\u5e93\u3002</p> <p>\u4e4b\u524d\u5b66\u4e60\u7684\u6570\u636e\u5e93\uff0c\u6570\u636e\u90fd\u662f\u5b58\u653e\u5728\u4e00\u4e2a\u5b9e\u4f8b\u5bf9\u5e94\u7684\u7269\u7406\u5b58\u50a8\u4e0a\uff0c\u800c\u5728\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\uff0c\u6570\u636e\u5c06\u5b58\u653e\u5728\u4e0d\u540c\u7684\u6570\u636e\u5e93\u5b9e\u4f8b\u4e0a\u3002</p> <p></p> <p>\u5728\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e0b\uff0c\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u672c\u8eab\u5206\u4e3a\u8ba1\u7b97\u5c42\u3001\u5143\u6570\u636e\u5c42\u548c\u5b58\u50a8\u5c42\uff1a</p> <ul> <li>\u8ba1\u7b97\u5c42\u5c31\u662f\u4e4b\u524d\u5355\u673a\u6570\u636e\u5e93\u4e2d\u7684 SQL \u5c42\uff0c\u7528\u6765\u5bf9\u6570\u636e\u8bbf\u95ee\u8fdb\u884c\u6743\u9650\u68c0\u67e5\u3001\u8def\u7531\u8bbf\u95ee\uff0c\u4ee5\u53ca\u5bf9\u8ba1\u7b97\u7ed3\u679c\u7b49\u64cd\u4f5c\u3002</li> <li>\u5143\u6570\u636e\u5c42\u8bb0\u5f55\u4e86\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u96c6\u7fa4\u4e0b\u6709\u591a\u5c11\u4e2a\u5b58\u50a8\u8282\u70b9\uff0c\u5bf9\u5e94 IP\u3001\u7aef\u53e3\u7b49\u5143\u6570\u636e\u4fe1\u606f\u662f\u591a\u5c11\u3002\u5f53\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u7684\u8ba1\u7b97\u5c42\u542f\u52a8\u65f6\uff0c\u4f1a\u5148\u8bbf\u95ee\u5143\u6570\u636e\u5c42\uff0c\u83b7\u53d6\u6240\u6709\u96c6\u7fa4\u4fe1\u606f\uff0c\u624d\u80fd\u6b63\u786e\u8fdb\u884c SQL \u7684\u89e3\u6790\u548c\u8def\u7531\u7b49\u5de5\u4f5c\u3002\u53e6\u5916\uff0c\u56e0\u4e3a\u5143\u6570\u636e\u4fe1\u606f\u5b58\u653e\u5728\u5143\u6570\u636e\u5c42\uff0c\u90a3\u4e48\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u7684\u8ba1\u7b97\u5c42\u53ef\u4ee5\u6709\u591a\u4e2a\uff0c\u7528\u4e8e\u5b9e\u73b0\u6027\u80fd\u7684\u6269\u5c55\u3002</li> <li>\u5b58\u50a8\u5c42\u7528\u6765\u5b58\u653e\u6570\u636e\uff0c\u4f46\u5b58\u50a8\u5c42\u8981\u548c\u8ba1\u7b97\u5c42\u5728\u540c\u4e00\u53f0\u670d\u52a1\u5668\u4e0a\uff0c\u751a\u81f3\u4e0d\u6c42\u5728\u540c\u4e00\u4e2a\u8fdb\u7a0b\u4e2d\u3002</li> </ul> <p>\u5e03\u5f0f\u6570\u636e\u5e93\u7684\u4f18\u52bf\u662f\u628a\u6570\u636e\u6253\u6563\u5230\u4e0d\u540c\u7684\u670d\u52a1\u5668\u4e0a\uff0c\u8fd9\u79cd\u6a2a\u5411\u6269\u5c55\u7684 Scale Out \u80fd\u529b\uff0c\u80fd\u89e3\u51b3\u5355\u673a\u6570\u636e\u5e93\u7684\u6027\u80fd\u4e0e\u5b58\u50a8\u74f6\u9888\u3002</p> <p>\u4f18\u52bf</p> <p>\u4ece\u53ef\u7528\u6027\u7684\u89d2\u5ea6\u770b\uff0c\u5982\u679c\u5b58\u50a8\u5c42\u53d1\u751f\u5b95\u673a\uff0c\u90a3\u4e48\u53ea\u4f1a\u5f71\u54cd 1/N \u7684\u6570\u636e\uff0cN \u53d6\u51b3\u4e8e\u6570\u636e\u88ab\u6253\u6563\u5230\u591a\u5c11\u53f0\u670d\u52a1\u5668\u4e0a\u3002\u6240\u4ee5\uff0c\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u7684\u53ef\u7528\u6027\u5bf9\u6bd4\u5355\u673a\u4f1a\u6709\u5f88\u5927\u63d0\u5347\uff0c\u5355\u673a\u6570\u636e\u5e93\u8981\u5b9e\u73b099.999% \u7684\u53ef\u7528\u6027\u6216\u8bb8\u5f88\u96be\uff0c\u4f46\u662f\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u5c31\u5bb9\u6613\u591a\u4e86\u3002</p> <p>\u7f3a\u70b9</p> <p>\u6b63\u56e0\u4e3a\u6570\u636e\u88ab\u6253\u6563\u4e86\uff0c\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4f1a\u5f15\u5165\u5f88\u591a\u65b0\u95ee\u9898\uff0c\u6bd4\u5982\u81ea\u589e\u5b9e\u73b0\u3001\u7d22\u5f15\u8bbe\u8ba1\u3001\u5206\u5e03\u5f0f\u4e8b\u52a1\u7b49</p>"},{"location":"chap2_opt/7Dist_db/#mysql","title":"\u5206\u5e03\u5f0fMySQL\u67b6\u6784","text":"<p>\u90a3\u4e48\u5bf9\u4e8e\u5206\u5e03\u5f0f MySQL \u6570\u636e\u5e93\u67b6\u6784\uff0c\u5176\u6574\u4f53\u67b6\u6784\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5728\u5206\u5e03\u5f0f MySQL \u67b6\u6784\u4e0b\uff0c\u5ba2\u6237\u7aef\u4e0d\u518d\u662f\u8bbf\u95ee MySQL \u6570\u636e\u5e93\u672c\u8eab\uff0c\u800c\u662f\u8bbf\u95ee\u4e00\u4e2a\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\u3002</p> <p>\u8fd9\u4e2a\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\u7684\u901a\u4fe1\u534f\u8bae\u4f9d\u7136\u91c7\u7528 MySQL \u901a\u4fe1\u534f\u8bae\uff08\u56e0\u4e3a\u539f\u5148\u5ba2\u6237\u7aef\u662f\u5982\u4f55\u8bbf\u95ee\u7684MySQL \u7684\uff0c\u73b0\u5728\u5c31\u5982\u4f55\u8bbf\u95ee\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\uff09\u3002\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\u4f1a\u6839\u636e\u5143\u6570\u636e\u4fe1\u606f\uff0c\u81ea\u52a8\u5c06\u7528\u6237\u8bf7\u6c42\u8def\u7531\u5230\u4e0b\u9762\u7684 MySQL \u5206\u7247\u4e2d\uff0c\u4ece\u800c\u5c06\u5b58\u50a8\u5b58\u53d6\u5230\u6307\u5b9a\u7684\u8282\u70b9\u3002</p> <p>\u53e6\u5916\uff0c\u5206\u5e03\u5f0f MySQL \u6570\u636e\u5e93\u67b6\u6784\u7684\u6bcf\u4e00\u5c42\u90fd\u8981\u7531\u9ad8\u53ef\u7528\uff0c\u4fdd\u8bc1\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\u7684\u9ad8\u53ef\u7528\u6027\u3002</p> <p>\u5bf9\u4e8e\u4e0a\u5c42\u7684\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\uff0c\u662f\u53ef\u4ee5\u5e73\u884c\u6269\u5c55\u7684\uff1a\u5373\u7528\u6237\u53ef\u4ee5\u8bbf\u95ee\u591a\u4e2a\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u53d1\u751f\u5b95\u673a\uff0c\u90a3\u4e48\u76f4\u63a5\u5254\u9664\u5373\u53ef\u3002</p> <p>\u56e0\u4e3a\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\u662f\u65e0\u72b6\u6001\u7684\uff0c\u6570\u636e\u4fdd\u5b58\u5728\u5143\u6570\u636e\u670d\u52a1\u4e2d\uff0c\u5b83\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1\u6bd4\u8f83\u5bb9\u6613\u3002</p> <p>\u5bf9\u4e8e\u5143\u6570\u636e\u6765\u8bf4\uff0c\u867d\u7136\u5b83\u7684\u6570\u636e\u91cf\u4e0d\u5927\uff0c\u4f46\u6570\u636e\u975e\u5e38\u5173\u952e\uff0c\u4e00\u65e6\u5b95\u673a\u5219\u53ef\u80fd\u5bfc\u81f4\u4e2d\u95f4\u4ef6\u65e0\u6cd5\u5de5\u4f5c\uff0c\u6240\u4ee5\uff0c\u5143\u6570\u636e\u8981\u901a\u8fc7\u526f\u672c\u6280\u672f\u4fdd\u969c\u9ad8\u53ef\u7528\u3002</p> <p>\u6700\u540e\uff0c\u6bcf\u4e2a\u5206\u7247\u5b58\u50a8\u672c\u8eab\u90fd\u6709\u526f\u672c\uff0c\u901a\u8fc7\u6211\u4eec\u4e4b\u524d\u5b66\u4e60\u7684\u9ad8\u53ef\u7528\u6280\u672f\uff0c\u4fdd\u8bc1\u5206\u7247\u7684\u53ef\u7528\u6027\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u5206\u7247 1 \u7684 MySQL \u53d1\u751f\u5b95\u673a\uff0c\u5206\u7247 1 \u7684\u4ece\u670d\u52a1\u5668\u4f1a\u63a5\u66ff\u539f\u5148\u7684 MySQL \u4e3b\u670d\u52a1\u5668\uff0c\u7ee7\u7eed\u63d0\u4f9b\u670d\u52a1\u3002</p> <p>\u4f46\u7531\u4e8e\u4f7f\u7528\u4e86\u5206\u5e03\u5f0f\u67b6\u6784\uff0c\u90a3\u4e48\u5373\u4f7f\u5206\u7247 1 \u53d1\u751f\u5b95\u673a\uff0c\u9700\u8981 60 \u79d2\u7684\u65f6\u95f4\u6062\u590d\uff0c\u8fd9\u6bb5\u65f6\u95f4\u5bf9\u4e8e\u4e1a\u52a1\u7684\u8bbf\u95ee\u6765\u8bf4\uff0c\u53ea\u5f71\u54cd\u4e86 1/N \u7684\u6570\u636e\u8bf7\u6c42\u3002</p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5206\u5e03\u5f0f MySQL \u6570\u636e\u5e93\u67b6\u6784\u5b9e\u73b0\u4e86\u8ba1\u7b97\u5c42\u4e0e\u5b58\u50a8\u5c42\u7684\u5206\u79bb\uff0c\u6bcf\u4e00\u5c42\u90fd\u53ef\u4ee5\u8fdb\u884c Scale Out \u5e73\u884c\u6269\u5c55\uff0c\u6bcf\u4e00\u5c42\u53c8\u901a\u8fc7\u9ad8\u53ef\u7528\u6280\u672f\uff0c\u4fdd\u8bc1\u4e86\u8ba1\u7b97\u5c42\u4e0e\u5b58\u50a8\u5c42\u7684\u8fde\u7eed\u6027\uff0c\u5927\u5927\u63d0\u5347\u4e86MySQL \u6570\u636e\u5e93\u7684\u6027\u80fd\u548c\u53ef\u9760\u6027\uff0c\u4e3a\u6d77\u91cf\u4e92\u8054\u7f51\u4e1a\u52a1\u670d\u52a1\u6253\u4e0b\u4e86\u575a\u5b9e\u7684\u57fa\u7840\u3002</p>"},{"location":"chap2_opt/7Dist_db/#_1","title":"\u603b\u7ed3","text":"<p>MySQL \u6570\u636e\u5e93\u7684\u67b6\u6784\uff1a\u5206\u5e03\u5f0f MySQL \u67b6\u6784\u901a\u8fc7\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u8def\u7531\u5c42\u5c4f\u853d\u4e86\u4e0b\u5c42 MySQL \u5206\u7247\u7684\u4fe1\u606f\u3002</p> <p>\u7531\u4e8e\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\u901a\u4fe1\u91c7\u7528 MySQL \u901a\u4fe1\u534f\u8bae\uff0c\u7528\u6237\u539f\u5148\u600e\u4e48\u4f7f\u7528 MySQL \u6570\u636e\u5e93\uff0c\u90a3\u5c31\u600e\u4e48\u4f7f\u7528\u5206\u5e03\u5f0f\u4e2d\u95f4\u4ef6\u3002\u5bf9\u4e8e\u5f00\u53d1\u6765\u8bf4\uff0c\u8fd9\u4e9b\u90fd\u662f\u900f\u660e\u7684\uff0c\u4ed6\u4eec\u4e0d\u7528\u5173\u5fc3\u4e0b\u5c42\u6709\u591a\u5c11\u4e2a\u5206\u7247\uff0c\u6240\u6709\u7684\u8def\u7531\u548c\u8ba1\u7b97\u5de5\u4f5c\uff0c\u4ea4\u53cb\u4e2d\u95f4\u4ef6\u5c42\u5b8c\u6210\u3002</p>"},{"location":"chap2_opt/7Dist_db/#2","title":"2 \u5982\u4f55\u6b63\u786e\u5730\u5c06\u6570\u636e\u5206\u7247","text":"<p>\u53e6\u5916\uff0c\u5f88\u91cd\u8981\u7684\u4e00\u70b9\u662f\uff0c\u77e5\u9053\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u662f\u628a\u6570\u636e\u6253\u6563\u5b58\u50a8\u5728\u4e00\u4e2a\u4e2a\u5206\u7247\u4e2d\u3002\u5728\u57fa\u4e8eMySQL \u7684\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\u4e2d\uff0c\u5206\u7247\u5c31\u5b58\u5728\u4e8e MySQL \u5b9e\u4f8b\u4e2d\u3002</p>"},{"location":"chap2_opt/7Dist_db/#2-1","title":"2-1 \u9009\u51fa\u5206\u7247\u952e","text":"<p>\u5728\u5bf9\u8868\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u5206\u7247\u65f6\uff0c\u9996\u5148\u8981\u9009\u51fa\u4e00\u4e2a\u5206\u7247\u952e\uff08Shard Key\uff09\uff0c\u5373\u7528\u6237\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e2a\u5b57\u6bb5\u8fdb\u884c\u6570\u636e\u7684\u6c34\u5e73\u62c6\u5206\u3002</p> <pre><code>CREATE TABLE `orders` (\n\n  `O_ORDERKEY` int NOT NULL,\n\n  `O_CUSTKEY` int NOT NULL,\n\n  `O_ORDERSTATUS` char(1) NOT NULL,\n\n  `O_TOTALPRICE` decimal(15,2) NOT NULL,\n\n  `O_ORDERDATE` date NOT NULL,\n\n  `O_ORDERPRIORITY` char(15) NOT NULL,\n\n  `O_CLERK` char(15) NOT NULL,\n\n  `O_SHIPPRIORITY` int NOT NULL,\n\n  `O_COMMENT` varchar(79) NOT NULL,\n\n  PRIMARY KEY (`O_ORDERKEY`),\n\n  KEY `idx_custkey_orderdate` (`O_CUSTKEY`,`O_ORDERDATE`),\n\n  KEY `ORDERS_FK1` (`O_CUSTKEY`),\n\n  KEY `idx_custkey_orderdate_totalprice` (`O_CUSTKEY`,`O_ORDERDATE`,`O_TOTALPRICE`),\n\n  KEY `idx_orderdate` (`O_ORDERDATE`),\n\n  KEY `idx_orderstatus` (`O_ORDERSTATUS`),\n\n  CONSTRAINT `orders_ibfk_1` FOREIGN KEY (`O_CUSTKEY`) REFERENCES `customer` (`C_CUSTKEY`)\n\n) ENGINE=InnoDB\n</code></pre> <p>\u6539\u9020\u6210\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784</p> <p>\u800c\u7b2c\u4e00\u6b65\u5c31\u662f\u8981\u5bf9\u8868\u9009\u51fa\u4e00\u4e2a\u5206\u7247\u952e\uff0c\u7136\u540e\u8fdb\u884c\u5206\u5e03\u5f0f\u67b6\u6784\u7684\u8bbe\u8ba1\u3002</p> <p>\u5bf9\u4e8e\u4e0a\u9762\u7684\u8868orders\uff0c\u53ef\u4ee5\u9009\u62e9\u7684\u5206\u7247\u952e\u6709\uff1a<code>o_orderkey</code>\u3001<code>o_orderdate</code>\u3001\u4e5f\u53ef\u4ee5\u662f<code>o_custkey</code>\u3002\u5728\u9009\u51fa\u5206\u7247\u952e\u540e\uff0c\u5c31\u8981\u9009\u62e9\u5206\u7247\u7684\u7b97\u6cd5\uff0c\u6bd4\u8f83\u5e38\u89c1\u7684\u6709 RANGE \u548c HASH \u7b97\u6cd5\u3002</p> <p>\u6bd4\u5982\uff0c\u8868 orders\uff0c\u9009\u62e9\u5206\u7247\u952e <code>o_orderdate</code>\uff0c\u6839\u636e\u51fd\u6570 YEAR \u6c42\u51fa\u8ba2\u5355\u5e74\u4efd\uff0c\u7136\u540e\u6839\u636eRANGE \u7b97\u6cd5\u8fdb\u884c\u5206\u7247\uff0c\u8fd9\u6837\u5c31\u80fd\u8bbe\u8ba1\u51fa\u57fa\u4e8e RANGE \u5206\u7247\u7b97\u6cd5\u7684\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\uff1a</p> <p>\u91c7\u7528 RANGE \u7b97\u6cd5\u8fdb\u884c\u5206\u7247\u540e\uff0c\u8868 orders \u4e2d\uff0c1992 \u5e74\u7684\u8ba2\u5355\u6570\u636e\u5b58\u653e\u5728\u5206\u7247 1 \u4e2d\u30011993 \u5e74\u7684\u8ba2\u5355\u6570\u636e\u5b58\u653e\u5728\u5206\u7247 2 \u4e2d\u30011994 \u5e74\u7684\u8ba2\u5355\u6570\u636e\u5b58\u653e\u5728\u5206\u7247 3\u4e2d\uff0c\u4f9d\u6b21\u7c7b\u63a8\uff0c\u5982\u679c\u8981\u5b58\u653e\u65b0\u5e74\u4efd\u7684\u8ba2\u5355\u6570\u636e\uff0c\u8ffd\u52a0\u65b0\u7684\u5206\u7247\u5373\u53ef</p> <p>\u4e0d\u8fc7\uff0cRANGE \u5206\u7247\u7b97\u6cd5\u5728\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\u4e2d\uff0c\u662f\u4e00\u79cd\u975e\u5e38\u7cdf\u7cd5\u7684\u7b97\u6cd5</p> <p>\u56e0\u4e3a\u5bf9\u4e8e\u5206\u5e03\u5f0f\u67b6\u6784\uff0c\u901a\u5e38\u5e0c\u671b\u80fd\u89e3\u51b3\u4f20\u7edf\u5355\u5b9e\u4f8b\u6570\u636e\u5e93\u4e24\u4e2a\u75db\u70b9\uff1a</p> <ul> <li>\u6027\u80fd\u53ef\u6269\u5c55\uff0c\u901a\u8fc7\u589e\u52a0\u5206\u7247\u8282\u70b9\uff0c\u6027\u80fd\u53ef\u4ee5\u7ebf\u6027\u63d0\u5347\uff1b</li> <li>\u5b58\u50a8\u5bb9\u91cf\u53ef\u6269\u5c55\uff0c\u901a\u8fc7\u589e\u52a0\u5206\u7247\u8282\u70b9\uff0c\u89e3\u51b3\u5355\u70b9\u5b58\u50a8\u5bb9\u91cf\u7684\u6570\u636e\u74f6\u9888\u3002</li> </ul> <p>\u6240\u4ee5\u5728\u5206\u5e03\u5f0f\u67b6\u6784\u4e2d\uff0cRANGE \u5206\u533a\u7b97\u6cd5\u662f\u4e00\u79cd\u6bd4\u8f83\u7cdf\u7cd5\u7684\u7b97\u6cd5\u3002\u4f46\u5b83\u4e5f\u6709\u597d\u5904\uff1a\u53ef\u4ee5\u65b9\u4fbf\u6570\u636e\u5728\u4e0d\u540c\u673a\u5668\u95f4\u8fdb\u884c\u8fc1\u79fb\uff08migrate\uff09\uff0c\u6bd4\u5982\u8981\u628a\u5206\u7247 2 \u4e2d 1992 \u5e74\u7684\u6570\u636e\u8fc1\u79fb\u5230\u5206\u7247 1\uff0c\u76f4\u63a5\u5c06\u8868\u8fdb\u884c\u8fc1\u79fb\u5c31\u884c\u3002</p> <p>\u800c\u5bf9\u6d77\u91cf\u5e76\u53d1\u7684 OLTP \u4e1a\u52a1\u6765\u8bf4\uff0c\u4e00\u822c\u63a8\u8350\u7528 HASH \u7684\u5206\u533a\u7b97\u6cd5\u3002</p> <p>\u8fd9\u6837\u5206\u7247\u7684\u6bcf\u4e2a\u8282\u70b9\u90fd\u53ef\u4ee5\u6709\u5b9e\u65f6\u7684\u8bbf\u95ee\uff0c\u6bcf\u4e2a\u8282\u70b9\u8d1f\u8f7d\u90fd\u80fd\u76f8\u5bf9\u5e73\u8861\uff0c\u4ece\u800c\u5b9e\u73b0\u6027\u80fd\u548c\u5b58\u50a8\u5c42\u7684\u7ebf\u6027\u53ef\u6269\u5c55\u3002</p> <p>\u6211\u4eec\u6765\u770b\u8868 orders \u6839\u636e o_orderkey \u8fdb\u884c HASH \u5206\u7247\uff0c\u5206\u7247\u7b97\u6cd5\u5982\u4e0b\uff1a</p> <p></p> <p>\u5728\u4e0a\u8ff0\u5206\u7247\u7b97\u6cd5\u4e2d\uff0c\u5206\u7247\u952e\u662f <code>o_orderkey</code>\uff0c\u603b\u7684\u5206\u7247\u6570\u91cf\u662f 4\uff08\u5373\u628a\u539f\u6765 1 \u4efd\u6570\u636e\u6253\u6563\u5230 4 \u5f20\u8868\u4e2d\uff09\uff0c\u5177\u4f53\u6765\u8bb2\uff0c\u5206\u7247\u7b97\u6cd5\u662f\u5c06 <code>o_orderkey</code> \u9664\u4ee5 4 \u8fdb\u884c\u53d6\u6a21\u64cd\u4f5c\u3002</p> <p>\u5bf9\u4e8e\u8ba2\u5355\u53f7\u9664\u4ee5 4\uff0c\u4f59\u6570\u4e3a 0 \u7684\u6570\u636e\u5b58\u653e\u5728\u5206\u7247 1 \u4e2d\uff0c\u4f59\u6570\u4e3a 1 \u7684\u6570\u636e\u5b58\u653e\u5728\u5206\u7247 2 \u4e2d\uff0c\u4f59\u6570\u4e3a 2 \u7684\u6570\u636e\u5b58\u653e\u5728\u5206\u7247 3 \u4e2d\uff0c\u4ee5\u6b64\u7c7b\u63a8</p> <p></p> <p>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\u8bbe\u8ba1\u7684\u539f\u5219\u662f\uff1a\u9009\u62e9\u4e00\u4e2a\u9002\u5408\u7684\u5206\u7247\u952e\u548c\u5206\u7247\u7b97\u6cd5\uff0c\u628a\u6570\u636e\u6253\u6563\uff0c\u5e76\u4e14\u4e1a\u52a1\u7684\u7edd\u5927\u90e8\u5206\u67e5\u8be2\u90fd\u662f\u6839\u636e\u5206\u7247\u952e\u8fdb\u884c\u8bbf\u95ee\u3002</p>"},{"location":"chap2_opt/7Dist_db/#_2","title":"\u5206\u5e93\u5206\u8868","text":"<p>\u8bf4\u4e86\u8fd9\u4e48\u4e45\u5206\u7247\uff0c\u5206\u7247\u5230\u5e95\u662f\u4ec0\u4e48\u5462\uff1f\u5176\u5b9e\uff0c\u524d\u9762\u8bf4\u7684\u5206\u7247\u672c\u8d28\u662f\u4e00\u5f20\u5f20\u8868\uff0c\u800c\u4e0d\u662f\u6570\u636e\u5e93\u5b9e\u4f8b\uff0c\u53ea\u662f\u6bcf\u4e2a\u5206\u7247\u662f\u5728 MySQL \u6570\u636e\u5e93\u5b9e\u4f8b\u4e2d\uff0c\u4e25\u683c\u6765\u8bf4</p> <pre><code>\u5206\u7247 = \u5b9e\u4f8b + \u5e93 + \u8868 = ip@port:db_name:table_name\n</code></pre> <p>\u5bf9\u4e8e\u524d\u9762\u7684\u8868orders\uff0c\u5047\u8bbe\u6839\u636e HASH \u7b97\u6cd5\u8fdb\u884c\u5206\u7247\uff0c\u90a3\u4e48\u53ef\u4ee5\u8fdb\u884c\u5982\u4e0b\u7684\u5206\u5e93\u5206\u8868\u8bbe\u8ba1\uff1a</p> <ul> <li>\u6bcf\u4e2a\u5206\u7247\u7684\u8868\u540d\u5e93\u540d\u90fd\u4e00\u6837\uff0c\u5982\u5e93 tpch\uff0c\u8868\u540d orders\uff1b</li> <li>\u6bcf\u4e2a\u5206\u7247\u7684\u5e93\u540d\u4e0d\u4e00\u6837\uff0c\u8868\u540d\u4e00\u6837\uff0c\u5982\u5e93\u540d tpch01\u3001tpch02\u3001tpch03\u3001tpch04\uff0c\u8868\u540dorders\uff1b</li> <li>\u6bcf\u4e2a\u5206\u7247\u7684\u8868\u540d\u4e0d\u4e00\u6837\uff0c\u5e93\u540d\u4e00\u6837\uff0c\u5982\u5e93\u540d tpch\uff0c\u8868\u540d\u5206\u522b\u4e3a orders01\u3001orders02\u3001orders03\u3001orders04\uff1b</li> <li>\u6bcf\u4e2a\u5206\u7247\u7684\u5e93\u540d\u4e0d\u4e00\u6837\uff0c\u8868\u540d\u4e5f\u4e0d\u4e00\u6837\uff0c\u5982\u5206\u7247 1 \u7684\u8868\u5728\u5e93\u540d tpch01\u4e0b\uff0c\u8868\u540d\u4e3aoders01\uff1b\u5206\u7247 2 \u7684\u8868\u540d\u5728\u5e93\u540d tpch02\uff0c\u8868\u540d\u4e3a orders02\uff1b\u5206\u7247 3 \u7684\u8868\u540d\u5728\u5e93\u540dtpch03\uff0c\u8868\u540d\u4e3a orders03\uff1b\u5206\u7247 3 \u7684\u8868\u540d\u5728\u5e93\u540d tpch04\uff0c\u8868\u540d\u4e3a orders04\u3002</li> </ul> <p>\u5728\u8fd9 4 \u79cd\u5206\u5e93\u5206\u8868\u89c4\u5219\u4e2d\uff0c\u6700\u63a8\u8350\u7684\u662f\u7b2c 4 \u79cd\uff0c\u4e5f\u662f\u6211\u4eec\u901a\u5e38\u610f\u4e49\u8bf4\u7684\u5206\u5e93\u5206\u8868\uff0c\u8fd9\u6837\u505a\u7684\u597d\u5904\u6709\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>\u4e0d\u540c\u5206\u7247\u7684\u6570\u636e\u53ef\u4ee5\u5728\u540c\u4e00 MySQL \u6570\u636e\u5e93\u5b9e\u4f8b\u4e0a\uff0c\u4fbf\u4e8e\u505a\u5bb9\u91cf\u7684\u89c4\u5212\u548c\u540e\u671f\u7684\u6269\u5c55\uff1b</li> <li>\u540c\u4e00\u5206\u7247\u952e\u7684\u8868\u90fd\u5728\u540c\u4e00\u5e93\u4e0b\uff0c\u65b9\u4fbf\u505a\u6574\u4f53\u6570\u636e\u7684\u8fc1\u79fb\u548c\u6269\u5bb9\u3002</li> </ul> <p>\u5982\u679c\u6839\u636e\u7b2c 4 \u79cd\u6807\u51c6\u7684\u5206\u5e93\u5206\u8868\u89c4\u8303\uff0c\u90a3\u4e48\u5206\u5e03\u5f0f MySQL \u6570\u636e\u5e93\u7684\u67b6\u6784\u53ef\u4ee5\u662f\u8fd9\u6837\uff1a</p> <p></p> <p>\u6709\u6ca1\u6709\u53d1\u73b0\uff0c\u6309\u4e0a\u9762\u8fd9\u6837\u7684\u5206\u5e03\u5f0f\u8bbe\u8ba1\uff0c\u6570\u636e\u5206\u7247\u5b8c\u6210\u540e\uff0c\u6240\u6709\u7684\u5e93\u8868\u4f9d\u7136\u662f\u5728\u540c\u4e00\u4e2a MySQL\u5b9e\u4f8b\u4e0a\uff01\uff01\uff01</p> <p>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u5e76\u4e0d\u4e00\u5b9a\u8981\u6c42\u6709\u5f88\u591a\u4e2a\u5b9e\u4f8b\uff0c\u6700\u57fa\u672c\u7684\u8981\u6c42\u662f\u5c06\u6570\u636e\u8fdb\u884c\u6253\u6563\u5206\u7247\u3002\u63a5\u7740\uff0c\u7528\u6237\u53ef\u4ee5\u6839\u636e\u81ea\u5df1\u7684\u9700\u8981\uff0c\u8fdb\u884c\u6269\u7f29\u5bb9\uff0c\u4ee5\u6b64\u5b9e\u73b0\u6570\u636e\u5e93\u6027\u80fd\u548c\u5bb9\u91cf\u7684\u4f38\u7f29\u6027\u3002\u8fd9\u624d\u662f\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u771f\u6b63\u7684\u9b45\u529b\u6240\u5728\u3002</p> <p>\u5bf9\u4e8e\u4e0a\u8ff0\u7684\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\uff0c\u4e00\u5f00\u59cb\u6211\u4eec\u5c06 4 \u4e2a\u5206\u7247\u6570\u636e\u5b58\u50a8\u5728\u4e00\u4e2a MySQL \u5b9e\u4f8b\u4e0a\uff0c\u4f46\u662f\u5982\u679c\u9047\u5230\u4e00\u4e9b\u5927\u4fc3\u6d3b\u52a8\uff0c\u53ef\u4ee5\u5bf9\u5176\u8fdb\u884c\u6269\u5bb9\uff0c\u6bd4\u5982\u628a 4 \u4e2a\u5206\u7247\u6269\u5bb9\u5230 4 \u4e2aMySQL\u5b9e\u4f8b\u4e0a\uff1a</p> <p></p> <p>\u8fdb\u884c\u6269\u7f29\u5bb9</p> <p>\u4e00\u5f00\u59cb\u4e00\u5b9a\u8981\u8bbe\u8ba1\u8db3\u591f\u591a\u7684\u5206\u7247</p> <pre><code># \u5206\u72471\u4ece\u670d\u52a1\u5668\u914d\u7f6e\n\nreplicate_do_db =\"tpch01\"\n</code></pre> <p>\u6240\u4ee5\u5728\u8fdb\u884c\u6269\u5bb9\u65f6\uff0c\u9996\u5148\u6839\u636e\u4e0b\u56fe\u7684\u65b9\u5f0f\u5bf9\u6269\u5bb9\u7684\u5206\u7247\u8fdb\u884c\u8fc7\u6ee4\u590d\u5236\u7684\u914d\u7f6e\uff1a</p> <p></p> <p>\u7136\u540e\u518d\u627e\u4e00\u4e2a\u4e1a\u52a1\u4f4e\u5cf0\u671f\uff0c\u5c06\u4e1a\u52a1\u7684\u8bf7\u6c42\u8f6c\u5411\u65b0\u7684\u5206\u7247\uff0c\u5b8c\u6210\u6700\u7ec8\u7684\u6269\u5bb9\u64cd\u4f5c\uff1a</p> <p></p>"},{"location":"chap2_opt/7Dist_db/#_3","title":"\u603b\u7ed3","text":"<ul> <li>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u6570\u636e\u5206\u7247\u8981\u5148\u9009\u62e9\u4e00\u4e2a\u6216\u591a\u4e2a\u5b57\u6bb5\u4f5c\u4e3a\u5206\u7247\u952e\uff1b</li> <li>\u5206\u7247\u952e\u7684\u8981\u6c42\u662f\u4e1a\u52a1\u7ecf\u5e38\u8bbf\u95ee\u7684\u5b57\u6bb5\uff0c\u4e14\u4e1a\u52a1\u4e4b\u95f4\u7684\u8868\u5927\u591a\u80fd\u6839\u636e\u8fd9\u4e2a\u5206\u7247\u952e\u8fdb\u884c\u5355\u5143\u5316\uff1b</li> <li>\u5982\u679c\u9009\u4e0d\u51fa\u5206\u7247\u952e\uff0c\u4e1a\u52a1\u5c31\u65e0\u6cd5\u8fdb\u884c\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u7684\u6539\u9020\uff1b</li> <li>\u9009\u62e9\u5b8c\u5206\u7247\u952e\u540e\uff0c\u5c31\u8981\u9009\u62e9\u5206\u7247\u7b97\u6cd5\uff0c\u901a\u5e38\u662f RANGE \u6216 HASH \u7b97\u6cd5\uff1b</li> <li>\u6d77\u91cf OLTP \u4e1a\u52a1\u63a8\u8350\u4f7f\u7528 HASH \u7b97\u6cd5\uff0c\u5f3a\u70c8\u4e0d\u63a8\u8350\u4f7f\u7528 RANGE \u7b97\u6cd5\uff1b</li> <li>\u5206\u7247\u952e\u548c\u5206\u7247\u7b97\u6cd5\u9009\u62e9\u5b8c\u540e\uff0c\u5c31\u8981\u8fdb\u884c\u5206\u5e93\u5206\u8868\u8bbe\u8ba1\uff0c\u63a8\u8350\u4e0d\u540c\u5e93\u540d\u8868\u540d\u7684\u8bbe\u8ba1\uff0c\u8fd9\u6837\u80fd\u65b9\u4fbf\u540e\u7eed\u5bf9\u5206\u7247\u6570\u636e\u8fdb\u884c\u6269\u7f29\u5bb9\uff1b</li> <li>\u5b9e\u9645\u8fdb\u884c\u6269\u5bb9\u65f6\uff0c\u53ef\u4ee5\u4f7f\u7528\u8fc7\u6ee4\u590d\u5236\uff0c\u4ec5\u590d\u5236\u9700\u8981\u7684\u5206\u7247\u6570\u636e\u3002</li> </ul>"},{"location":"chap2_opt/7Dist_db/#3","title":"3 \u4e8c\u7ea7\u7d22\u5f15\u3001\u5168\u5c40\u7d22\u5f15\u7684\u6700\u4f73\u8bbe\u8ba1\u5b9e\u8df5","text":""},{"location":"chap2_opt/7Dist_db/#3-1","title":"3-1 \u4e3b\u952e\u9009\u62e9","text":"<p>\u5bf9\u4e3b\u952e\u6765\u8bf4\uff0c\u8981\u4fdd\u8bc1\u5728\u6240\u6709\u5206\u7247\u4e2d\u90fd\u552f\u4e00\uff0c\u5b83\u672c\u8d28\u4e0a\u5c31\u662f\u4e00\u4e2a\u5168\u5c40\u552f\u4e00\u7684\u7d22\u5f15\u3002</p> <p>\u56e0\u4e3a\u81ea\u589e\u5e76\u4e0d\u80fd\u5728\u63d2\u5165\u524d\u5c31\u83b7\u5f97\u503c\uff0c\u800c\u662f\u8981\u901a\u8fc7\u586b NULL \u503c\uff0c\u7136\u540e\u518d\u901a\u8fc7\u51fd\u6570 <code>last_insert_id()</code> \u83b7\u5f97\u81ea\u589e\u7684\u503c\u3002\u6240\u4ee5\uff0c\u5982\u679c\u5728\u6bcf\u4e2a\u5206\u7247\u4e0a\u901a\u8fc7\u81ea\u589e\u53bb\u5b9e\u73b0\u4e3b\u952e\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u540c\u6837\u7684\u81ea\u589e\u503c\u5b58\u5728\u4e8e\u4e0d\u540c\u7684\u5206\u7247\u4e0a\u3002</p> <p>\u5982\u679c\u628a <code>o_orderkey</code> \u8bbe\u8ba1\u6210\u4e0a\u56fe\u6240\u793a\u7684\u81ea\u589e\uff0c\u90a3\u4e48\u5f88\u53ef\u80fd o_orderkey \u540c\u4e3a 1 \u7684\u8bb0\u5f55\u5728\u4e0d\u540c\u7684\u5206\u7247\u51fa\u73b0\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u6240\u4ee5\uff0c\u5728\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\u4e0b\uff0c\u5c3d\u91cf\u4e0d\u8981\u7528\u81ea\u589e\u4f5c\u4e3a\u8868\u7684\u4e3b\u952e\uff0c\u8fd9\u4e5f\u662f\u6211\u4eec\u5728\u7b2c\u4e00\u6a21\u5757\u201c\u8868\u7ed3\u6784\u8bbe\u8ba1\u201d\u4e2d\u5f3a\u8c03\u8fc7\u7684\uff1a\u81ea\u589e\u6027\u80fd\u5f88\u5dee\u3001\u5b89\u5168\u6027\u4e0d\u9ad8\u3001\u4e0d\u9002\u7528\u4e8e\u5206\u5e03\u5f0f\u67b6\u6784\u3002</p> <p>\u603b\u4e4b\uff0c\u7528\u6709\u5e8f\u7684\u5168\u5c40\u552f\u4e00\u66ff\u4ee3\u81ea\u589e\uff0c\u662f\u8fd9\u4e2a\u65f6\u4ee3\u6570\u636e\u5e93\u4e3b\u952e\u7684\u4e3b\u6d41\u8bbe\u8ba1\u6807\u51c6</p>"},{"location":"chap2_opt/7Dist_db/#3-2","title":"3-2 \u7d22\u5f15\u8bbe\u8ba1","text":"<p>\u8fd8\u662f\u4ee5\u524d\u9762\u7684\u8868 orders \u4e3a\u4f8b\uff0c\u5982\u679c\u4e1a\u52a1\u8fd8\u8981\u6839\u636e o_orderkey \u5b57\u6bb5\u8fdb\u884c\u67e5\u8be2\uff0c\u6bd4\u5982\u67e5\u8be2\u8ba2\u5355 ID \u4e3a 1 \u7684\u8ba2\u5355\u8be6\u60c5\uff1a</p> <pre><code>SELECT * FROM orders WHERE o_orderkey = 1\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0c\u7531\u4e8e\u5206\u7247\u89c4\u5219\u4e0d\u662f\u5206\u7247\u952e\uff0c\u6240\u4ee5\u9700\u8981\u67e5\u8be2 4 \u4e2a\u5206\u7247\u624d\u80fd\u5f97\u5230\u6700\u7ec8\u7684\u7ed3\u679c\uff0c\u5982\u679c\u4e0b\u9762\u6709 1000 \u4e2a\u5206\u7247\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u6267\u884c 1000 \u6b21\u8fd9\u6837\u7684 SQL\uff0c\u8fd9\u65f6\u6027\u80fd\u5c31\u6bd4\u8f83\u5dee\u4e86\u3002</p> <p>\u4f46\u662f\uff0c\u6211\u4eec\u77e5\u9053 <code>o_orderkey</code> \u662f\u4e3b\u952e\uff0c\u5e94\u8be5\u53ea\u6709\u4e00\u6761\u8fd4\u56de\u8bb0\u5f55\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c<code>o_orderkey</code> \u53ea\u5b58\u5728\u4e8e\u4e00\u4e2a\u5206\u7247\u4e2d\u3002\u8fd9\u65f6\uff0c\u53ef\u4ee5\u6709\u4ee5\u4e0b\u4e24\u79cd\u8bbe\u8ba1\uff1a</p> <ul> <li>\u540c\u4e00\u4efd\u6570\u636e\uff0c\u8868 orders \u6839\u636e o_orderkey \u4e3a\u5206\u7247\u952e\uff0c\u518d\u505a\u4e00\u4e2a\u5206\u5e93\u5206\u8868\u7684\u5b9e\u73b0\uff1b</li> <li>\u5728\u7d22\u5f15\u4e2d\u989d\u5916\u6dfb\u52a0\u5206\u7247\u952e\u7684\u4fe1\u606f\u3002</li> </ul> <p>\u6539\u8fdb\u7684\u505a\u6cd5\u4e4b\u4e00\u662f\u5b9e\u73b0\u4e00\u4e2a\u7d22\u5f15\u8868\uff0c\u8868\u4e2d\u53ea\u5305\u542b<code>o_orderkey</code>\u548c\u5206\u7247\u952e<code>o_custkey</code>\uff0c\u5982</p> <pre><code>CREATE TABLE idx_orderkey_custkey \uff08\n\n  o_orderkey INT\n\n  o_custkey INT,\n\n  PRIMARY KEY (o_orderkey)\n\n)\n</code></pre> <p>\u5982\u679c\u8fd9\u5f20\u7d22\u5f15\u8868\u5f88\u5927\uff0c\u4e5f\u53ef\u4ee5\u5c06\u5176\u5206\u5e93\u5206\u8868\uff0c\u4f46\u662f\u5b83\u7684\u5206\u7247\u952e\u662f <code>o_orderkey</code>\uff0c\u5982\u679c\u8fd9\u65f6\u518d\u6839\u636e\u5b57\u6bb5 <code>o_orderkey</code> \u8fdb\u884c\u67e5\u8be2\uff0c\u53ef\u4ee5\u8fdb\u884c\u7c7b\u4f3c\u4e8c\u7ea7\u7d22\u5f15\u7684\u56de\u8868\u5b9e\u73b0\uff1a\u5148\u901a\u8fc7\u67e5\u8be2\u7d22\u5f15\u8868\u5f97\u5230\u8bb0\u5f55 <code>o_orderkey = 1</code> \u5bf9\u5e94\u7684\u5206\u7247\u952e <code>o_custkey</code>\u7684\u503c\uff0c\u63a5\u7740\u518d\u6839\u636e <code>o_custkey</code>\u8fdb\u884c\u67e5\u8be2\uff0c\u6700\u7ec8\u5b9a\u4f4d\u5230\u60f3\u8981\u7684\u6570\u636e\uff0c\u5982\uff1a</p> <pre><code>SELECT * FROM orders WHERE o_orderkey = 1\n\n=&gt;\n\n# step 1\n\nSELECT o_custkey FROM idx_orderkey_custkey \n\nWHERE o_orderkey = 1\n\n# step 2\n\nSELECT * FROM orders \n\nWHERE o_custkey = ? AND o_orderkey = 1\n</code></pre> <p>\u901a\u8fc7\u7d22\u5f15\u8868\u7684\u65b9\u5f0f\uff0c\u867d\u7136\u5b58\u50a8\u4e0a\u8f83\u5197\u4f59\u5168\u8868\u5bb9\u91cf\u5c0f\u4e86\u5f88\u591a\uff0c\u4f46\u662f\u8981\u6839\u636e\u53e6\u4e00\u4e2a\u5206\u7247\u952e\u8fdb\u884c\u6570\u636e\u7684\u5b58\u50a8\uff0c\u4f9d\u7136\u663e\u5f97\u4e0d\u591f\u4f18\u96c5\u3002</p> <p>\u56e0\u6b64\uff0c\u6700\u4f18\u7684\u8bbe\u8ba1\uff0c\u4e0d\u662f\u521b\u5efa\u4e00\u4e2a\u7d22\u5f15\u8868\uff0c\u800c\u662f\u5c06\u5206\u7247\u952e\u7684\u4fe1\u606f\u4fdd\u5b58\u5728\u60f3\u8981\u67e5\u8be2\u7684\u5217\u4e2d\uff0c\u8fd9\u6837\u901a\u8fc7\u67e5\u8be2\u7684\u5217\u5c31\u80fd\u76f4\u63a5\u77e5\u9053\u6240\u5728\u7684\u5206\u7247\u4fe1\u606f\u3002</p> <p>\u5982\u679c\u6211\u4eec\u5c06\u8ba2\u5355\u8868 orders \u7684\u4e3b\u952e\u8bbe\u8ba1\u4e3a\u4e00\u4e2a\u5b57\u7b26\u4e32\uff0c\u8fd9\u4e2a\u5b57\u7b26\u4e32\u4e2d\u6700\u540e\u4e00\u90e8\u5206\u5305\u542b\u5206\u7247\u952e\u7684\u4fe1\u606f\uff0c\u5982\uff1a</p> <pre><code>o_orderkey = string\uff08o_orderkey + o_custkey\uff09\n</code></pre> <p>\u90a3\u4e48\u8fd9\u65f6\u5982\u679c\u6839\u636e o_orderkey \u8fdb\u884c\u67e5\u8be2\uff1a</p> <pre><code>SELECT * FROM Orders\n\nWHERE o_orderkey = '1000-1';\n</code></pre> <p>\u7531\u4e8e\u5b57\u6bb5 <code>o_orderkey</code> \u7684\u8bbe\u8ba1\u4e2d\u76f4\u63a5\u5305\u542b\u4e86\u5206\u7247\u952e\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u77e5\u9053\u8fd9\u4e2a\u8ba2\u5355\u5728\u5206\u72471 \u4e2d\uff0c\u76f4\u63a5\u67e5\u8be2\u5206\u7247 1 \u5c31\u884c\u3002</p> <p>\u540c\u6837\u5730\uff0c\u5728\u63d2\u5165\u65f6\uff0c\u7531\u4e8e\u53ef\u4ee5\u77e5\u9053\u63d2\u5165\u65f6 o_custkey \u5bf9\u5e94\u7684\u503c\uff0c\u6240\u4ee5\u53ea\u8981\u5728\u4e1a\u52a1\u5c42\u505a\u4e00\u6b21\u5b57\u7b26\u7684\u62fc\u63a5\uff0c\u7136\u540e\u518d\u63d2\u5165\u6570\u636e\u5e93\u5c31\u884c\u4e86\u3002</p> <p>\u5f53\u7136\uff0c\u8fd9\u91cc\u6211\u4eec\u8c08\u7684\u8bbe\u8ba1\u90fd\u662f\u9488\u5bf9\u4e8e\u552f\u4e00\u7d22\u5f15\u7684\u8bbe\u8ba1\uff0c\u5982\u679c\u662f\u975e\u552f\u4e00\u7684\u4e8c\u7ea7\u7d22\u5f15\u67e5\u8be2\uff0c\u90a3\u4e48\u975e\u5e38\u53ef\u60dc\uff0c\u4f9d\u7136\u9700\u8981\u626b\u63cf\u6240\u6709\u7684\u5206\u7247\u624d\u80fd\u5f97\u5230\u6700\u7ec8\u7684\u7ed3\u679c\uff0c\u5982\uff1a</p> <pre><code>SELECT * FROM Orders\n\nWHERE o_orderate &gt;= ? o_orderdate &lt; ?\n</code></pre> <p>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u67b6\u6784\u8bbe\u8ba1\u7684\u8981\u6c42\u662f\u4e1a\u52a1\u7684\u7edd\u5927\u90e8\u5206\u8bf7\u6c42\u80fd\u591f\u6839\u636e\u5206\u7247\u952e\u5b9a\u4f4d\u5230 1 \u4e2a\u5206\u7247\u4e0a\u3002</p>"},{"location":"chap2_opt/7Dist_db/#3-3","title":"3-3 \u552f\u4e00\u7d22\u5f15","text":"<p>\u6700\u540e\u6211\u4eec\u6765\u8c08\u8c08\u552f\u4e00\u7d22\u5f15\u7684\u8bbe\u8ba1\uff0c\u4e0e\u4e3b\u952e\u4e00\u6837\uff0c\u5982\u679c\u53ea\u662f\u901a\u8fc7\u6570\u636e\u5e93\u8868\u672c\u8eab\u552f\u4e00\u7ea6\u675f\u521b\u5efa\u7684\u7d22\u5f15\uff0c\u5219\u65e0\u6cd5\u4fdd\u8bc1\u5728\u6240\u6709\u5206\u7247\u4e2d\u90fd\u662f\u552f\u4e00\u7684\u3002</p> <p>\u6240\u4ee5\uff0c\u5728\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\uff0c\u552f\u4e00\u7d22\u5f15\u4e00\u6837\u8981\u901a\u8fc7\u7c7b\u4f3c\u4e3b\u952e\u7684 UUID \u7684\u673a\u5236\u5b9e\u73b0\uff0c\u7528\u5168\u5c40\u552f\u4e00\u53bb\u66ff\u4ee3\u5c40\u90e8\u552f\u4e00\uff0c\u4f46\u5b9e\u9645\u4e0a\uff0c\u5373\u4fbf\u662f\u5355\u673a\u7684 MySQL \u6570\u636e\u5e93\u67b6\u6784\uff0c\u6211\u4eec\u4e5f\u63a8\u8350\u4f7f\u7528\u5168\u5c40\u552f\u4e00\u7684\u8bbe\u8ba1\u3002\u56e0\u4e3a\u4f60\u4e0d\u77e5\u9053\uff0c\u4ec0\u4e48\u65f6\u5019\uff0c\u4f60\u7684\u4e1a\u52a1\u5c31\u4f1a\u5347\u7ea7\u5230\u5168\u5c40\u552f\u4e00\u7684\u8981\u6c42\u4e86\u3002</p>"},{"location":"chap2_opt/7Dist_db/#3-4","title":"3-4 \u603b\u7ed3","text":"<ul> <li>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e3b\u952e\u8bbe\u8ba1\u4f7f\u7528\u6709\u5e8f UUID\uff0c\u5168\u5c40\u552f\u4e00\uff1b</li> <li>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u552f\u4e00\u7d22\u5f15\u8bbe\u8ba1\u4f7f\u7528 UUID \u7684\u5168\u5c40\u552f\u4e00\u8bbe\u8ba1\uff0c\u907f\u514d\u5c40\u90e8\u7d22\u5f15\u5bfc\u81f4\u7684\u552f\u4e00\u95ee\u9898\uff1b</li> <li>\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u552f\u4e00\u7d22\u5f15\u82e5\u4e0d\u662f\u5206\u7247\u952e\uff0c\u5219\u53ef\u4ee5\u5728\u8bbe\u8ba1\u65f6\u4fdd\u5b58\u5206\u7247\u4fe1\u606f\uff0c\u8fd9\u6837\u67e5\u8be2\u76f4\u63a5\u8def\u7531\u5230\u4e00\u4e2a\u5206\u7247\u5373\u53ef\uff1b</li> <li>\u5bf9\u4e8e\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\u7684\u5168\u5c40\u8868\uff0c\u53ef\u4ee5\u91c7\u7528\u5197\u4f59\u673a\u5236\uff0c\u5728\u6bcf\u4e2a\u5206\u7247\u4e0a\u8fdb\u884c\u4fdd\u5b58\u3002\u8fd9\u6837\u80fd\u907f\u514d\u67e5\u8be2\u65f6\u8de8\u5206\u7247\u7684\u67e5\u8be2\u3002</li> </ul>"},{"location":"chap2_opt/7Dist_db/#4-or","title":"4 \u67b6\u6784\u9009\u578b\uff1a\u5206\u5e93\u5206\u8868 or \u4e2d\u95f4\u4ef6","text":"<p>\u8bbf\u95ee\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u6709\u4e24\u79cd\u6a21\u5f0f\uff1a</p> <ul> <li>\u4e1a\u52a1\u76f4\u63a5\u6839\u636e\u5206\u5e93\u5206\u8868\u8bbf\u95ee MySQL \u6570\u636e\u5e93\u8282\u70b9\uff1b</li> <li>\u6839\u636e\u4e2d\u95f4\u4ef6\u8bbf\u95ee\u3002</li> </ul>"},{"location":"chap2_opt/7Dist_db/#4-1","title":"4-1 \u5206\u5e93\u5206\u8868\u76f4\u63a5\u8bbf\u95ee","text":"<p>\u5728\u8bbe\u8ba1\u5206\u7247\u65f6\uff0c\u6211\u4eec\u5df2\u7ecf\u660e\u786e\u4e86\u6bcf\u5f20\u8868\u7684\u5206\u7247\u952e\u4fe1\u606f\uff0c\u6240\u4ee5\u4e1a\u52a1\u6216\u670d\u52a1\u53ef\u4ee5\u76f4\u63a5\u6839\u636e\u5206\u7247\u952e\u5bf9\u5e94\u7684\u6570\u636e\u5e93\u4fe1\u606f\uff0c\u76f4\u63a5\u8bbf\u95ee\u5e95\u5c42\u7684 MySQL \u6570\u636e\u8282\u70b9\uff0c\u6bd4\u5982\u5728\u4ee3\u7801\u91cc\u53ef\u4ee5\u505a\u7c7b\u4f3c\u7684\u5904\u7406\uff1a</p> <pre><code>void InsertOrders(String orderKey, int userKey...) {\n\n\n\n  int shard_id = userKey % 4;\n\n  if (shard_id == 0) {\n\n    conn = MySQLConncetion('shard1',...);\n\n    conn.query(...);\n\n  } else if (shard_id == 1) {\n\n    conn = MySQLConncetion('shard2',...);\n\n    conn.query(...);   \n\n  } else if (shard_id == 2) {\n\n    conn = MySQLConncetion('shard3',...);\n\n    conn.query(...);   \n\n  } else if (shard_id == 3) {\n\n    conn = MySQLConncetion('shard4',...);\n\n    conn.query(...);   \n\n  }\n\n}\n</code></pre> <p>\u5728\u4e1a\u52a1\u4ee3\u7801\u4e2d\u4f1a\u5d4c\u5165\u5206\u5e93\u5206\u8868\u7684\u8def\u7531\u903b\u8f91\uff0c\u5728\u4e1a\u52a1\u5c42\u8ba1\u7b97\u51fa\u5bf9\u5e94\u5206\u7247\u7684\u4fe1\u606f\uff0c\u7136\u540e\u8bbf\u95ee\u6570\u636e\u5e93\uff1a</p> <ul> <li>\u8fd9\u79cd\u5904\u7406\u65b9\u5f0f\u7684\u597d\u5904\u662f\u4e0e\u5355\u5b9e\u4f8b\u6570\u636e\u5e93\u6ca1\u6709\u592a\u5927\u7684\u4e0d\u540c\uff0c\u53ea\u662f\u591a\u4e86\u4e00\u6b21\u8ba1\u7b97\u5206\u7247\u7684\u64cd\u4f5c\uff0c\u6ca1\u6709\u989d\u5916\u7684\u5f00\u9500\uff0c\u6027\u80fd\u975e\u5e38\u597d\uff08\u6211\u542c\u8bf4\u652f\u4ed8\u5b9d\u7684\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e3a\u4e86\u6700\u6c42\u6781\u81f4\u7684\u6027\u80fd\uff0c\u7528\u7684\u5c31\u662f\u76f4\u63a5\u8bbf\u95ee\u5206\u7247\u7684\u65b9\u5f0f\uff09\u3002</li> <li>\u8fd9\u79cd\u5904\u7406\u903b\u8f91\u7684\u7f3a\u70b9\u662f\u4e1a\u52a1\u9700\u8981\u77e5\u9053\u5206\u7247\u4fe1\u606f\uff0c\u611f\u77e5\u5206\u7247\u7684\u53d8\u5316\u3002\u5bf9\u4e8e\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u5982\u679c\u5206\u7247 shard1 \u53d1\u751f\u53d8\u5316\uff0c\u53c8\u6216\u8005\u8fdb\u884c\u4e86\u6269\u5bb9\uff0c\u4e1a\u52a1\u5c31\u9700\u8981\u8ddf\u7740\u4fee\u6539\u3002</li> </ul> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u7f3a\u70b9\uff0c\u6bd4\u8f83\u597d\u7684\u5904\u7406\u65b9\u5f0f\u662f\u4f7f\u7528\u540d\u5b57\u670d\u52a1\uff0c\u800c\u4e0d\u8981\u76f4\u63a5\u901a\u8fc7 IP \u8bbf\u95ee\u5206\u7247\u3002\u8fd9\u6837\u5f53\u5206\u7247\u53d1\u751f\u5207\u6362\uff0c\u53c8\u6216\u8005\u6269\u5bb9\u7f29\u5bb9\u65f6\uff0c\u4e1a\u52a1\u4e5f\u4e0d\u9700\u8981\u8fdb\u884c\u5f88\u5927\u7684\u6539\u52a8\u3002</p> <p>\u53c8\u56e0\u4e3a\u4e1a\u52a1\u6bd4\u8f83\u591a\uff0c\u9700\u8981\u8bbf\u95ee\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u5206\u7247\u903b\u8f91\u7684\u5730\u65b9\u4e5f\u6bd4\u8f83\u591a\u3002\u6240\u4ee5\uff0c\u53ef\u4ee5\u628a\u5206\u7247\u4fe1\u606f\u5b58\u50a8\u5728\u7f13\u5b58\u4e2d\uff0c\u5f53\u4e1a\u52a1\u542f\u52a8\u65f6\uff0c\u81ea\u52a8\u52a0\u8f7d\u5206\u7247\u4fe1\u606f\u3002\u6bd4\u5982\uff0c\u5728 Memcached \u6216 Redis \u4e2d\u4fdd\u5b58\u5982\u4e0b\u7684\u5206\u7247\u4fe1\u606f\uff0ckey \u53ef\u4ee5\u662f\u5206\u5e93\u5206\u8868\u7684\u8868\u540d\uff0cvalue\u901a\u8fc7 JSON \u6216\u5b57\u5178\u7684\u65b9\u5f0f\u5b58\u653e\u5206\u7247\u4fe1\u606f\uff1a</p> <pre><code>{\n\n  'key': 'orders',\n\n  'shard_info' : {\n\n    'shard_key' : 'o_custkey',\n\n    'shard_count' : 4\uff0c\n\n    'shard_host' : ['shard1.xxx.com','shard2.xxx.com','...']\uff0c\n\n    \u2018shard_table' : ['tpch00/orders01','tpch01/orders02','...'],\n\n  }\n\n}\n</code></pre>"},{"location":"chap2_opt/7Dist_db/#4-2","title":"4-2 \u4f7f\u7528\u4e2d\u95f4\u4ef6\u6280\u672f","text":"<p>\u53e6\u4e00\u79cd\u6bd4\u8f83\u6d41\u884c\u7684\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u8bbf\u95ee\u65b9\u5f0f\u662f\u901a\u8fc7\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u3002\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u672c\u8eab\u6a21\u62df\u6210\u4e00\u4e2a MySQL \u6570\u636e\u5e93\uff0c\u901a\u4fe1\u534f\u8bae\u4e5f\u90fd\u9075\u5faa MySQL \u534f\u8bae\uff1a\u4e1a\u52a1\u4e4b\u524d\u600e\u4e48\u8bbf\u95eeMySQL\u6570\u636e\u5e93\u7684\uff0c\u5c31\u5982\u4f55\u8bbf\u95eeMySQL\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u3002</p> <p>\u8fd9\u6837\u505a\u7684\u4f18\u70b9\u662f\uff1a\u4e1a\u52a1\u4e0d\u7528\u5173\u6ce8\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\u7684\u5206\u7247\u4fe1\u606f\uff0c\u628a\u5b83\u9ed8\u8ba4\u4e3a\u4e00\u4e2a\u5355\u673a\u6570\u636e\u5e93\u4f7f\u7528\u5c31\u597d\u4e86\u3002</p> <p></p> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u901a\u8fc7\u5206\u5e03\u5f0f MySQL \u4e2d\u95f4\u4ef6\uff0c\u7528\u6237\u53ea\u9700\u8981\u8bbf\u95ee\u4e2d\u95f4\u4ef6\u5c31\u884c\uff0c\u4e0b\u9762\u7684\u6570\u636e\u8def\u7531\u3001\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u5b9e\u73b0\u7b49\u64cd\u4f5c\u5168\u90e8\u4ea4\u7531\u4e2d\u95f4\u4ef6\u5b8c\u6210\u3002\u6240\u4ee5\uff0c\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u53d8\u6210\u4e00\u4e2a\u975e\u5e38\u5173\u952e\u7684\u6838\u5fc3\u7ec4\u4ef6\u3002</p> <p>\u4e1a\u754c\u6bd4\u8f83\u77e5\u540d\u7684 MySQL \u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4e2d\u95f4\u4ef6\u4ea7\u54c1\u6709\uff1aShardingShpere\u3001DBLE\u3001TDSQL \u7b49\u3002</p> <p>ShardingSphere\u4e8e 2020 \u5e74 4 \u6708 16 \u65e5\u6210\u4e3a Apache \u8f6f\u4ef6\u57fa\u91d1\u4f1a\u7684\u9876\u7ea7\u9879\u76ee\u3001\u793e\u533a\u719f\u5ea6\u3001\u529f\u80fd\u652f\u6301\u8f83\u591a\uff0c\u7279\u522b\u662f\u5bf9\u4e8e\u5206\u5e03\u5f0f\u4e8b\u52a1\u7684\u652f\u6301\uff0c\u6709\u591a\u79cd\u9009\u62e9\uff08ShardingSphere \u5b98\u7f51\u5730\u5740\uff09\u3002</p> <p>DBLE \u662f\u7531\u77e5\u540d MySQL \u670d\u52a1\u5546\u7231\u53ef\u751f\u516c\u53f8\u5f00\u6e90\u7684 MySQL \u4e2d\u95f4\u4ef6\u4ea7\u54c1\uff0c\u5df2\u7528\u4e8e\u56db\u5927\u884c\u6838\u5fc3\u4e1a\u52a1\uff0c\u5b8c\u7f8e\u652f\u6491\u4f20\u7edf\u94f6\u884c\u53bb IOE\uff0c\u8f6c\u578b\u5206\u5e03\u5f0f\u67b6\u6784\u7684\u63a2\u7d22\u3002\u9664\u4e86\u4e2d\u95f4\u4ef6\u6280\u672f\u5916\uff0c\u7231\u53ef\u751f\u516c\u53f8\u8fd8\u6709\u5f88\u591a\u5173\u4e8e MySQL \u6570\u636e\u5e93\u3001\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u8bbe\u8ba1\u7b49\u65b9\u9762\u7684\u7efc\u5408\u7ecf\u9a8c\u3002</p> <p>TDSQL MySQL \u7248\uff08TDSQL for MySQL\uff09\u662f\u817e\u8baf\u6253\u9020\u7684\u4e00\u6b3e\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u4ea7\u54c1\uff0c\u5177\u5907\u5f3a\u4e00\u81f4\u9ad8\u53ef\u7528\u3001\u5168\u7403\u90e8\u7f72\u67b6\u6784\u3001\u5206\u5e03\u5f0f\u6c34\u5e73\u6269\u5c55\u3001\u9ad8\u6027\u80fd\u3001\u4f01\u4e1a\u7ea7\u5b89\u5168\u7b49\u7279\u6027\uff0c\u540c\u65f6\u63d0\u4f9b\u667a\u80fd DBA\u3001\u81ea\u52a8\u5316\u8fd0\u8425\u3001\u76d1\u63a7\u544a\u8b66\u7b49\u914d\u5957\u8bbe\u65bd\uff0c\u4e3a\u5ba2\u6237\u63d0\u4f9b\u5b8c\u6574\u7684\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u76ee\u524d TDSQL \u5df2\u7ecf\u4e3a\u8d85\u8fc7500+\u7684\u653f\u4f01\u548c\u91d1\u878d\u673a\u6784\u63d0\u4f9b\u6570\u636e\u5e93\u7684\u516c\u6709\u4e91\u53ca\u79c1\u6709\u4e91\u670d\u52a1\uff0c\u5ba2\u6237\u8986\u76d6\u94f6\u884c\u3001\u4fdd\u9669\u3001\u8bc1\u5238\u3001\u4e92\u8054\u7f51\u91d1\u878d\u3001\u8ba1\u8d39\u3001\u7b2c\u4e09\u65b9\u652f\u4ed8\u3001\u7269\u8054\u7f51\u3001\u4e92\u8054\u7f51+\u3001\u653f\u52a1\u7b49\u9886\u57df\u3002TDSQL MySQL \u7248\u4ea6\u51ed\u501f\u5176\u9ad8\u8d28\u91cf\u7684\u4ea7\u54c1\u53ca\u670d\u52a1\uff0c\u83b7\u5f97\u4e86\u591a\u9879\u56fd\u9645\u548c\u56fd\u5bb6\u8ba4\u8bc1\uff0c\u5f97\u5230\u4e86\u5ba2\u6237\u53ca\u884c\u4e1a\u7684\u4e00\u81f4\u8ba4\u53ef\u3002</p>"},{"location":"chap2_opt/8opt_int/","title":"L8 Operation Interview","text":""},{"location":"chap2_opt/8opt_int/#1-","title":"1 \u8868\u7ed3\u6784\u8bbe\u8ba1\u7bc7 - \u6570\u636e\u7c7b\u578b","text":""},{"location":"chap2_opt/8opt_int/#1-1","title":"1-1 \u6570\u5b57\u7c7b\u578b","text":"<ul> <li>\u4e0d\u63a8\u8350\u4f7f\u7528\u6574\u578b\u7c7b\u578b\u7684\u5c5e\u6027 Unsigned\uff0c\u82e5\u975e\u8981\u4f7f\u7528\uff0c\u53c2\u6570 <code>sql_mode</code> \u52a1\u5fc5\u989d\u5916\u6dfb\u52a0\u4e0a\u9009\u9879 <code>NO_UNSIGNED_SUBTRACTION\uff1b</code></li> <li>\u5728\u6d77\u91cf\u5e76\u53d1\u7684\u4e92\u8054\u7f51\u4e1a\u52a1\u4e2d\u4f7f\u7528\uff0c\u91d1\u989d\u5b57\u6bb5\u7684\u8bbe\u8ba1\u5e76\u4e0d\u63a8\u8350\u4f7f\u7528 DECIMAL \u7c7b\u578b\uff0c\u800c\u66f4\u63a8\u8350\u4f7f\u7528 INT \u6574\u578b\u7c7b\u578b</li> <li>\u81ea\u589e\u6574\u578b\u7c7b\u578b\u505a\u4e3b\u952e\uff0c\u52a1\u5fc5\u4f7f\u7528\u7c7b\u578b BIGINT\uff0c\u800c\u975e INT\uff0c\u540e\u671f\u8868\u7ed3\u6784\u8c03\u6574\u4ee3\u4ef7\u5de8\u5927\uff1b</li> <li>MySQL 8.0 \u7248\u672c\u524d\uff0c\u81ea\u589e\u6574\u578b\u4f1a\u6709\u56de\u6eaf\u95ee\u9898\uff0c\u505a\u4e1a\u52a1\u5f00\u53d1\u7684\u4f60\u4e00\u5b9a\u8981\u4e86\u89e3\u8fd9\u4e2a\u95ee\u9898\uff1b<ul> <li>\u81ea\u589e\u503c\u5e76\u4e0d\u6301\u4e45\u5316\uff0c\u53ef\u80fd\u4f1a\u6709\u56de\u6eaf\u73b0\u8c61\uff08MySQL 8.0 \u7248\u672c\u524d\uff09</li> </ul> </li> <li>\u5f53\u8fbe\u5230\u81ea\u589e\u6574\u578b\u7c7b\u578b\u7684\u4e0a\u9650\u503c\u65f6\uff0c\u518d\u6b21\u81ea\u589e\u63d2\u5165\uff0cMySQL \u6570\u636e\u5e93\u4f1a\u62a5\u91cd\u590d\u9519\u8bef\uff1b</li> <li>\u4e0d\u8981\u518d\u4f7f\u7528\u6d6e\u70b9\u7c7b\u578b Float\u3001Double\uff0cMySQL \u540e\u7eed\u7248\u672c\u5c06\u4e0d\u518d\u652f\u6301\u4e0a\u8ff0\u4e24\u79cd\u7c7b\u578b\uff1b<ul> <li>\u7c7b\u578b DECIMAL \u662f\u901a\u8fc7\u4e8c\u8fdb\u5236\u5b9e\u73b0\u7684\u4e00\u79cd\u7f16\u7801\u65b9\u5f0f\uff0c\u8ba1\u7b97\u6548\u7387\u8fdc\u4e0d\u5982\u6574\u578b\u6765\u7684\u9ad8\u6548\u3002\u56e0\u6b64\uff0c\u63a8\u8350\u4f7f\u7528 BIG INT \u6765\u5b58\u50a8\u91d1\u989d\u76f8\u5173\u7684\u5b57\u6bb5\u3002</li> </ul> </li> <li>\u8d26\u6237\u4f59\u989d\u5b57\u6bb5\uff0c\u8bbe\u8ba1\u662f\u7528\u6574\u578b\u7c7b\u578b\uff0c\u800c\u4e0d\u662f DECIMAL \u7c7b\u578b\uff0c\u8fd9\u6837\u6027\u80fd\u66f4\u597d\uff0c\u5b58\u50a8\u66f4\u7d27\u51d1\u3002</li> </ul>"},{"location":"chap2_opt/8opt_int/#1-2-collation","title":"1-2 \u5b57\u7b26\u4e32\u7c7b\u578b\uff1a\u4e0d\u80fd\u5ffd\u7565\u7684 COLLATION","text":"<ul> <li>CHAR \u548c VARCHAR \u867d\u7136\u5206\u522b\u7528\u4e8e\u5b58\u50a8\u5b9a\u957f\u548c\u53d8\u957f\u5b57\u7b26\uff0c\u4f46\u5bf9\u4e8e\u53d8\u957f\u5b57\u7b26\u96c6\uff08\u5982 GBK\u3001UTF8MB4\uff09\uff0c\u5176\u672c\u8d28\u662f\u4e00\u6837\u7684\uff0c\u90fd\u662f\u53d8\u957f\uff0c\u8bbe\u8ba1\u65f6\u5b8c\u5168\u53ef\u4ee5\u7528 VARCHAR \u66ff\u4ee3 CHAR\uff1b<ul> <li>\u6240\u4ee5\u5728 MySQL \u6570\u636e\u5e93\u4e0b\uff0c\u7edd\u5927\u90e8\u5206\u573a\u666f\u4f7f\u7528\u7c7b\u578b VARCHAR \u5c31\u8db3\u591f\u4e86</li> </ul> </li> <li>\u63a8\u8350 MySQL \u5b57\u7b26\u96c6\u9ed8\u8ba4\u8bbe\u7f6e\u4e3a UTF8MB4\uff0c\u53ef\u4ee5\u7528\u4e8e\u5b58\u50a8 emoji \u7b49\u6269\u5c55\u5b57\u7b26\uff1b</li> <li>\u6392\u5e8f\u89c4\u5219\u5f88\u91cd\u8981\uff0c\u7528\u4e8e\u5b57\u7b26\u7684\u6bd4\u8f83\u548c\u6392\u5e8f\uff0c\u4f46\u5927\u90e8\u5206\u573a\u666f\u4e0d\u9700\u8981\u7528\u533a\u5206\u5927\u5c0f\u5199\u7684\u6392\u5e8f\u89c4\u5219\uff1b<ul> <li><code>SHOW CHARSET \u6765\u67e5\u770b</code></li> </ul> </li> <li>\u4fee\u6539\u8868\u4e2d\u5df2\u6709\u5217\u7684\u5b57\u7b26\u96c6\uff0c\u4f7f\u7528\u547d\u4ee4 <code>ALTER TABLE ... CONVERT TO ....\uff1b</code><ul> <li><code>ALTER TABLE emoji_test CONVERT TO CHARSET utf8mb4;</code></li> </ul> </li> <li>\u7528\u6237\u6027\u522b\uff0c\u8fd0\u884c\u72b6\u6001\u7b49\u6709\u9650\u503c\u7684\u5217\uff0cMySQL 8.0.16 \u7248\u672c\u76f4\u63a5\u4f7f\u7528 <code>CHECK</code> \u7ea6\u675f\u673a\u5236\uff0c\u4e4b\u524d\u7684\u7248\u672c\u53ef\u4f7f\u7528 <code>ENUM</code> \u679a\u4e3e\u5b57\u7b26\u4e32\u7c7b\u578b\uff0c\u5916\u52a0 <code>SQL_MODE</code> \u7684\u4e25\u683c\u6a21\u5f0f\uff1b<ul> <li><code>'sex' tinyint DEFAULT NULL,</code>.   \u4ee5\u524d\u7684\u7248\u672c</li> <li><code>'sex' enum('M','F') COLLATE utf8mb4_general_ci DEFAULT NULL,</code>  MySQL 8.0.16 \u7248\u672c</li> </ul> </li> <li>\u4e1a\u52a1\u9690\u79c1\u4fe1\u606f\uff0c\u5982\u5bc6\u7801\u3001\u624b\u673a\u3001\u4fe1\u7528\u5361\u7b49\u4fe1\u606f\uff0c\u9700\u8981\u52a0\u5bc6\u3002\u5207\u8bb0\u7b80\u5355\u7684MD5\u7b97\u6cd5\u662f\u53ef\u4ee5\u8fdb\u884c\u66b4\u529b\u7834\u89e3\uff0c\u5e76\u4e0d\u5b89\u5168\uff0c\u63a8\u8350\u4f7f\u7528\u52a8\u6001\u76d0+\u52a8\u6001\u52a0\u5bc6\u7b97\u6cd5\u8fdb\u884c\u9690\u79c1\u6570\u636e\u7684\u5b58\u50a8\u3002<ul> <li><code>$salt$cryption_algorithm$value</code></li> <li><code>$salt</code>\uff1a\u8868\u793a\u52a8\u6001\u76d0\uff0c\u6bcf\u6b21\u7528\u6237\u6ce8\u518c\u65f6\u4e1a\u52a1\u4ea7\u751f\u4e0d\u540c\u7684\u76d0\u503c\uff0c\u5e76\u5b58\u50a8\u5728\u6570\u636e\u5e93\u4e2d\u3002\u82e5\u505a\u5f97\u518d\u7cbe\u7ec6\u4e00\u70b9\uff0c\u53ef\u4ee5\u52a8\u6001\u76d0\u503c + \u7528\u6237\u6ce8\u518c\u65e5\u671f\u5408\u5e76\u4e3a\u4e00\u4e2a\u66f4\u4e3a\u52a8\u6001\u7684\u76d0\u503c\u3002</li> <li><code>$cryption_algorithm</code>\uff1a\u8868\u793a\u52a0\u5bc6\u7684\u7b97\u6cd5\uff0c\u5982 v1 \u8868\u793a MD5 \u52a0\u5bc6\u7b97\u6cd5\uff0cv2 \u8868\u793a AES256 \u52a0\u5bc6\u7b97\u6cd5\uff0cv3 \u8868\u793a AES512 \u52a0\u5bc6\u7b97\u6cd5\u7b49\u3002</li> <li><code>$value</code>\uff1a\u8868\u793a\u52a0\u5bc6\u540e\u7684\u5b57\u7b26\u4e32\u3002</li> </ul> </li> </ul>"},{"location":"chap2_opt/8opt_int/#1-3-timestamp","title":"1-3 \u65e5\u671f\u7c7b\u578b\uff1aTIMESTAMP \u53ef\u80fd\u662f\u5de8\u5751","text":"<ul> <li>MySQL 5.6 \u7248\u672c\u5f00\u59cb DATETIME \u548c TIMESTAMP \u7cbe\u5ea6\u652f\u6301\u5230\u6beb\u79d2\uff1b</li> <li>DATETIME \u5360\u7528 8 \u4e2a\u5b57\u8282\uff0cTIMESTAMP \u5360\u7528 4 \u4e2a\u5b57\u8282\uff0cDATETIME(6) \u4f9d\u7136\u5360\u7528 8 \u4e2a\u5b57\u8282\uff0cTIMESTAMP(6) \u5360\u7528 7 \u4e2a\u5b57\u8282\uff1b</li> <li>TIMESTAMP \u65e5\u671f\u5b58\u50a8\u7684\u4e0a\u9650\u4e3a <code>2038-01-19 03:14:07</code>\uff0c\u4e1a\u52a1\u7528 TIMESTAMP \u5b58\u5728\u98ce\u9669\uff1b</li> <li>\u4f7f\u7528 TIMESTAMP \u5fc5\u987b\u663e\u5f0f\u5730\u8bbe\u7f6e\u65f6\u533a\uff0c\u4e0d\u8981\u4f7f\u7528\u9ed8\u8ba4\u7cfb\u7edf\u65f6\u533a\uff0c\u5426\u5219\u5b58\u5728\u6027\u80fd\u95ee\u9898\uff0c\u63a8\u8350\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u8bbe\u7f6e\u53c2\u6570 <code>time_zone = '+08:00</code>'\uff1b</li> </ul> <pre><code>[mysqld]\n\ntime_zone = \"+08:00\"\n</code></pre> <ul> <li>\u5f3a\u70c8\u5efa\u8bae\u4f60\u6bcf\u5f20\u4e1a\u52a1\u6838\u5fc3\u8868\u90fd\u589e\u52a0\u4e00\u4e2a DATETIME \u7c7b\u578b\u7684 <code>last_modify_date</code> \u5b57\u6bb5\uff0c\u5e76\u8bbe\u7f6e\u4fee\u6539\u81ea\u52a8\u66f4\u65b0\u673a\u5236\uff0c \u5373\u4fbf\u6807\u8bc6\u6bcf\u6761\u8bb0\u5f55\u6700\u540e\u4fee\u6539\u7684\u65f6\u95f4\u3002</li> </ul> <pre><code>last_modify_date DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n</code></pre> <ul> <li>\u63a8\u8350\u65e5\u671f\u7c7b\u578b\u4f7f\u7528 DATETIME\uff0c\u800c\u4e0d\u662f TIMESTAMP \u548c INT \u7c7b\u578b\uff1b</li> </ul>"},{"location":"chap2_opt/8opt_int/#1-4-json","title":"1-4 \u975e\u7ed3\u6784\u5b58\u50a8\uff1a\u7528\u597d JSON","text":"<p>JSON \u7c7b\u578b\u662f MySQL 5.7 \u7248\u672c\u65b0\u589e\u7684\u6570\u636e\u7c7b\u578b\uff0c\u7528\u597d JSON \u6570\u636e\u7c7b\u578b\u53ef\u4ee5\u6709\u6548\u89e3\u51b3\u5f88\u591a\u4e1a\u52a1\u4e2d\u5b9e\u9645\u95ee\u9898</p> <ul> <li>\u4f7f\u7528 JSON \u6570\u636e\u7c7b\u578b\uff0c\u63a8\u8350\u7528 MySQL 8.0.17 \u4ee5\u4e0a\u7684\u7248\u672c\uff0c\u6027\u80fd\u66f4\u597d\uff0c\u540c\u65f6\u4e5f\u652f\u6301 <code>Multi-Valued Indexes</code>\uff1b</li> <li>JSON \u6570\u636e\u7c7b\u578b\u7684\u597d\u5904\u662f\u65e0\u987b\u9884\u5148\u5b9a\u4e49\u5217\uff0c\u6570\u636e\u672c\u8eab\u5c31\u5177\u6709\u5f88\u597d\u7684\u63cf\u8ff0\u6027\uff1b</li> <li>\u4e0d\u8981\u5c06\u6709\u660e\u663e\u5173\u7cfb\u578b\u7684\u6570\u636e\u7528 JSON \u5b58\u50a8\uff0c\u5982\u7528\u6237\u4f59\u989d\u3001\u7528\u6237\u59d3\u540d\u3001\u7528\u6237\u8eab\u4efd\u8bc1\u7b49\uff0c\u8fd9\u4e9b\u90fd\u662f\u6bcf\u4e2a\u7528\u6237\u5fc5\u987b\u5305\u542b\u7684\u6570\u636e\uff1b</li> <li>JSON \u6570\u636e\u7c7b\u578b\u63a8\u8350\u4f7f\u7528\u5728\u4e0d\u7ecf\u5e38\u66f4\u65b0\u7684\u9759\u6001\u6570\u636e\u5b58\u50a8\u3002</li> </ul>"},{"location":"chap2_opt/8opt_int/#2-","title":"2 \u8868\u7ed3\u6784\u8bbe\u8ba1\u7bc7 - \u8868\u8bbe\u8ba1","text":""},{"location":"chap2_opt/8opt_int/#2-1","title":"2-1 \u5fd8\u8bb0\u8303\u5f0f\u51c6\u5219","text":"<p>\u5728 MySQL \u6d77\u91cf\u5e76\u53d1\u7684\u5de5\u7a0b\u5b9e\u8df5\u4e0a\uff0c\u8868\u7ed3\u6784\u8bbe\u8ba1\u5e94\u9075\u5faa\u8fd9\u6837\u51e0\u4e2a\u89c4\u8303\uff1a</p> <ul> <li>\u4e00\u8303\u5f0f\u8981\u6c42\u6240\u6709\u5c5e\u6027\u90fd\u662f\u4e0d\u53ef\u5206\u7684\u57fa\u672c\u6570\u636e\u9879\uff1b\\ \u4e8c\u8303\u5f0f\u89e3\u51b3\u90e8\u5206\u4f9d\u8d56\uff1b \\ \u4e09\u8303\u5f0f\u89e3\u51b3\u4f20\u9012\u4f9d\u8d56\u3002</li> <li>\u6bcf\u5f20\u8868\u4e00\u5b9a\u8981\u6709\u4e00\u4e2a\u4e3b\u952e\uff08\u65b9\u6cd5\u6709\u81ea\u589e\u4e3b\u952e\u8bbe\u8ba1\u3001UUID \u4e3b\u952e\u8bbe\u8ba1\u3001\u4e1a\u52a1\u81ea\u5b9a\u4e49\u751f\u6210\u4e3b\u952e\uff09\uff1b\u81ea\u589e\u4e3b\u952e\u8bbe\u8ba1</li> <li>\u6bcf\u5f20\u8868\u4e00\u5b9a\u8981\u6709\u4e00\u4e2a\u4e3b\u952e\uff1b</li> <li>\u81ea\u589e\u4e3b\u952e\u53ea\u63a8\u8350\u7528\u5728\u975e\u6838\u5fc3\u4e1a\u52a1\u8868\uff0c\u751a\u81f3\u5e94\u907f\u514d\u4f7f\u7528\uff1b<ul> <li>\u6240\u4ee5\uff0c\u5982\u679c\u4f60\u60f3\u83b7\u5f97\u81ea\u589e\u503c\u7684\u6700\u5927\u5e76\u53d1\u6027\u80fd\uff0c\u628a\u53c2\u6570 <code>innodb_autoinc_lock_mode</code> \u8bbe\u7f6e\u4e3a2\u3002</li> </ul> </li> <li>\u6838\u5fc3\u4e1a\u52a1\u8868\u63a8\u8350\u4f7f\u7528 UUID \u6216\u4e1a\u52a1\u81ea\u5b9a\u4e49\u4e3b\u952e\uff1b<ul> <li>UUID\uff08Universally Unique Identifier\uff09\u4ee3\u8868\u5168\u5c40\u552f\u4e00\u6807\u8bc6 ID\u3002\u663e\u7136\uff0c\u7531\u4e8e\u5168\u5c40\u552f\u4e00\u6027\uff0c\u4f60\u53ef\u4ee5\u628a\u5b83\u7528\u6765\u4f5c\u4e3a\u6570\u636e\u5e93\u7684\u4e3b\u952e\u3002</li> <li><code>UUID = \u65f6\u95f4\u4f4e\uff084\u5b57\u8282\uff09- \u65f6\u95f4\u4e2d\u9ad8+\u7248\u672c\uff084\u5b57\u8282\uff09- \u65f6\u949f\u5e8f\u5217 - MAC\u5730\u5740</code></li> <li>\u9700\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f\uff0c\u5728\u5b58\u50a8\u65f6\u95f4\u65f6\uff0cUUID \u662f\u6839\u636e\u65f6\u95f4\u4f4d\u9006\u5e8f\u5b58\u50a8\uff0c \u4e5f\u5c31\u662f\u4f4e\u65f6\u95f4\u4f4e\u4f4d\u5b58\u653e\u5728\u6700\u524d\u9762\uff0c\u9ad8\u65f6\u95f4\u4f4d\u5728\u6700\u540e\uff0c\u5373 UUID \u7684\u524d 4 \u4e2a\u5b57\u8282\u4f1a\u968f\u7740\u65f6\u95f4\u7684\u53d8\u5316\u800c\u4e0d\u65ad\u201c\u968f\u673a\u201d\u53d8\u5316\uff0c\u5e76\u975e\u5355\u8c03\u9012\u589e\u3002</li> </ul> </li> <li>\u4e00\u4efd\u6570\u636e\u5e94\u5c3d\u53ef\u80fd\u4fdd\u7559\u4e00\u4efd\uff0c\u901a\u8fc7\u4e3b\u952e\u5173\u8054\u8fdb\u884c\u67e5\u8be2\uff0c\u907f\u514d\u5197\u4f59\u6570\u636e\uff1b</li> <li>\u5728\u4e00\u4e9b\u573a\u666f\u4e0b\uff0c\u53ef\u4ee5\u901a\u8fc7 JSON \u6570\u636e\u7c7b\u578b\u8fdb\u884c\u53cd\u8303\u5f0f\u8bbe\u8ba1\uff0c\u63d0\u5347\u5b58\u50a8\u6548\u7387\uff1b</li> </ul>"},{"location":"chap2_opt/8opt_int/#2-2","title":"2-2 \u8868\u538b\u7f29\uff1a\u4e0d\u4ec5\u4ec5\u662f\u7a7a\u95f4\u538b\u7f29","text":"<ul> <li>MySQL \u4e2d\u7684\u538b\u7f29\u90fd\u662f\u57fa\u4e8e\u9875\u7684\u538b\u7f29\uff1b<ul> <li>\u800c\u57fa\u4e8e\u9875\u7684\u538b\u7f29\uff0c\u65e2\u80fd\u63d0\u5347\u538b\u7f29\u6548\u7387\uff0c\u53c8\u80fd\u5728\u6027\u80fd\u4e4b\u95f4\u53d6\u5f97\u4e00\u79cd\u5e73\u8861\u3002</li> <li>\u501f\u52a9\u9875\u538b\u7f29\u6280\u672f\uff0cMySQL \u53ef\u4ee5\u628a\u4e00\u4e2a 16K \u7684\u9875\u538b\u7f29\u4e3a 8K\uff0c\u751a\u81f3 4K\uff0c\u8fd9\u6837\u5728\u4ece\u78c1\u76d8\u5199\u5165\u6216\u8bfb\u53d6\u65f6 </li> </ul> </li> <li>COMPRESS \u9875\u538b\u7f29\u9002\u5408\u7528\u4e8e\u6027\u80fd\u8981\u6c42\u4e0d\u9ad8\u7684\u4e1a\u52a1\u8868\uff0c\u5982\u65e5\u5fd7\u3001\u76d1\u63a7\u3001\u544a\u8b66\u8868\u7b49\uff1b\u538b\u7f29\u6bd4\u4f8b\u901a\u5e38\u80fd\u8fbe\u5230 50% \u5de6\u53f3\u3002<ul> <li>COMPRESS \u9875\u538b\u7f29\u662f MySQL 5.7 \u7248\u672c\u4e4b\u524d\u63d0\u4f9b\u7684\u9875\u538b\u7f29\u529f\u80fd\u3002\u53ea\u8981\u5728\u521b\u5efa\u8868\u65f6\u6307\u5b9a<code>ROW_FORMAT=COMPRESS</code>\uff0c\u5e76\u8bbe\u7f6e\u901a\u8fc7\u9009\u9879 <code>KEY_BLOCK_SIZE</code> \u8bbe\u7f6e\u538b\u7f29\u7684\u6bd4\u4f8b\u3002</li> <li>\u4e0b\u9762\u8fd9\u662f\u4e00\u5f20\u65e5\u5fd7\u8868\uff0cROW_FROMAT \u8bbe\u7f6e\u4e3a COMPRESS\uff0c\u8868\u793a\u542f\u7528 COMPRESS \u9875\u538b\u7f29\u529f\u80fd\uff0c<code>KEY_BLOCK_SIZE</code> \u8bbe\u7f6e\u4e3a 8\uff0c\u8868\u793a\u5c06\u4e00\u4e2a 16K \u7684\u9875\u538b\u7f29\u4e3a 8K\u3002</li> </ul> </li> </ul> <pre><code>ROW_FORMAT=COMPRESSED\nKEY_BLOCK_SIZE=8\n</code></pre> <ul> <li>COMPRESS \u9875\u538b\u7f29\u5185\u5b58\u7f13\u51b2\u6c60\u5b58\u5728\u538b\u7f29\u548c\u89e3\u538b\u7684\u4e24\u4e2a\u9875\uff0c\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd</li> <li>\u5bf9\u5b58\u50a8\u6709\u538b\u7f29\u9700\u6c42\uff0c\u53c8\u5e0c\u671b\u6027\u80fd\u4e0d\u8981\u6709\u660e\u663e\u9000\u5316\uff0c\u63a8\u8350\u4f7f\u7528 TPC \u538b\u7f29\uff1b</li> <li> <p>TPC\uff08Transparent Page Compression\uff09\u662f 5.7 \u7248\u672c\u63a8\u51fa\u7684\u4e00\u79cd\u65b0\u7684\u9875\u538b\u7f29\u529f\u80fd\uff0c\u5176\u5229\u7528\u6587\u4ef6\u7cfb\u7edf\u7684\u7a7a\u6d1e\uff08Punch Hole\uff09\u7279\u6027\u8fdb\u884c\u538b\u7f29\u3002\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u521b\u5efa TPC \u538b\u7f29\u8868\uff1a</p> <ul> <li><code>COMPRESSION=ZLIB | LZ4 | NONE;</code></li> </ul> </li> <li> <p>\u901a\u8fc7 ALTER TABLE \u542f\u7528 TPC \u538b\u7f29\u540e\uff0c\u8fd8\u9700\u8981\u6267\u884c\u547d\u4ee4 OPTIMIZE TABLE \u624d\u80fd\u7acb\u5373\u5b8c\u6210\u7a7a\u95f4\u7684\u538b\u7f29\u3002</p> </li> </ul> <pre><code>ALTER TABLE Transaction202102 COMPRESSION=ZLIB\uff1b\n\nOPTIMIZE TABLE Transaction202102;\n</code></pre>"},{"location":"chap2_opt/8opt_int/#2-3-sql-nosql","title":"2-3 \u8868\u7684\u8bbf\u95ee\u8bbe\u8ba1 SQL \u8fd8\u662f NoSQL","text":"<p>\u901a\u8fc7 SQL\u3001Memcache \u534f\u8bae\u3001X Protocol \u8bbf\u95ee MySQL \u4e2d\u7684\u8868\uff0c\u5373\u6211\u4eec\u53ef\u4ee5\u5c06 MySQL \u6253\u9020\u6210\u4e00\u4e2a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u3001KV \u6570\u636e\u5e93\u3001\u6587\u6863\u6570\u636e\u5e93\uff0c\u4f46\u5e95\u5c42\u90fd\u662f\u901a\u8fc7\u8868\u683c\u7684\u65b9\u5f0f\u8fdb\u884c\u6570\u636e\u7684\u5b58\u50a8\uff0c\u5e76\u4e14\u6570\u636e\u90fd\u5b58\u50a8\u5728 InnoDB \u5f15\u64ce\u4e2d\u3002</p> <p>\u8fd8\u5728\u4f7f\u7528 Memcached\u3001MongoDB \u6570\u636e\u5e93\u7684\u540c\u5b66\u53ef\u4ee5\u8003\u8651\u5c06\u6570\u636e\u8fc1\u79fb\u5230 MySQL\uff0c\u8fd9\u6837\u80fd\u5728\u517c\u5bb9\u539f\u6709\u4e1a\u52a1\u7684\u524d\u63d0\u4e0b\uff0c\u4f7f\u7528\u5230 InnoDB \u5b58\u50a8\u5f15\u64ce\u7684\u9ad8\u5e76\u53d1\u3001\u4e8b\u52a1\u5b89\u5168\u3001\u6570\u636e\u590d\u5236\u7b49\u9ad8\u7ea7\u529f\u80fd\u3002</p> <ul> <li> <p>\u901a\u8fc7 Memcached \u534f\u8bae\u8bbf\u95ee\u8868 </p> <ul> <li>\u57fa\u4e8e Memcached \u7684 KV \u8bbf\u95ee\uff0c\u53ef\u4ee5\u7ed5\u8fc7 SQL \u89e3\u6790\uff0c\u901a\u8fc7\u6620\u5c04\u5173\u7cfb\uff0c\u76f4\u63a5\u8bbf\u95ee\u5b58\u50a8\u5728 InnoDB \u5f15\u64ce\u4e2d\u7684\u6570\u636e\uff0c\u8fd9\u6837\u6570\u636e\u5e93\u7684\u6574\u4f53\u6027\u80fd\u4f1a\u5728\u4e0d\u82b1\u8d39\u989d\u5916\u6210\u672c\u7684\u524d\u63d0\u4e0b\u5f97\u5230\u6781\u5927\u7684\u63d0\u5347\u3002</li> <li>\u57fa\u4e8e Memcached \u7684 KV \u8bbf\u95ee\u65b9\u5f0f\u6bd4\u4f20\u7edf\u7684 SQL \u65b9\u5f0f\u8981\u5feb54.33%\uff0c\u800c\u4e14CPU \u7684\u5f00\u9500\u53cd\u800c\u8fd8\u8981\u4f4e20%\u3002</li> </ul> </li> <li> <p>\u901a\u8fc7 X Protocol \u8bbf\u95ee\u8868</p> </li> <li>\u540c\u65f6\uff0cMySQL \u4e5f\u63d0\u4f9b\u4e86 X Protocol \u8fd9\u6837\u7684 NoSQL \u8bbf\u95ee\u65b9\u5f0f\uff0c\u6240\u4ee5\uff0c\u73b0\u5728\u6211\u4eec MySQL \u6253\u9020\u6210\u4e00\u4e2aSQL &amp; NoSQL\u7684\u6587\u6863\u6570\u636e\u5e93\u3002</li> </ul>"},{"location":"chap2_opt/8opt_int/#3","title":"3 \u7d22\u5f15\u4f18\u5316","text":""},{"location":"chap2_opt/8opt_int/#3-1","title":"3-1 \u7d22\u5f15\uff1a\u6392\u5e8f","text":"<ul> <li>\u7d22\u5f15\u662f\u52a0\u5feb\u67e5\u8be2\u7684\u4e00\u79cd\u6570\u636e\u7ed3\u6784\uff0c\u5176\u539f\u7406\u662f\u63d2\u5165\u65f6\u5bf9\u6570\u636e\u6392\u5e8f\uff0c\u7f3a\u70b9\u662f\u4f1a\u5f71\u54cd\u63d2\u5165\u7684\u6027\u80fd\uff1b</li> <li>MySQL \u5f53\u524d\u652f\u6301 B+\u6811\u7d22\u5f15\u3001\u5168\u6587\u7d22\u5f15\u3001R \u6811\u7d22\u5f15\uff1b</li> <li><code>B+</code> \u6811\u7d22\u5f15\u7684\u9ad8\u5ea6\u901a\u5e38\u4e3a 3~4 \u5c42\uff0c\u9ad8\u5ea6\u4e3a 4 \u7684 <code>B+</code>\u6811\u80fd\u5b58\u653e 50 \u4ebf\u5de6\u53f3\u7684\u6570\u636e\uff1b</li> <li>\u7531\u4e8e B+ \u6811\u7684\u9ad8\u5ea6\u4e0d\u9ad8\uff0c\u67e5\u8be2\u6548\u7387\u6781\u9ad8\uff0c50 \u4ebf\u7684\u6570\u636e\u4e5f\u53ea\u9700\u8981\u63d2\u53d9 4 \u6b21 I/O\uff1b</li> <li>MySQL \u5355\u8868\u7684\u7d22\u5f15\u6ca1\u6709\u4e2a\u6570\u9650\u5236\uff0c\u4e1a\u52a1\u67e5\u8be2\u6709\u5177\u4f53\u9700\u8981\uff0c\u521b\u5efa\u5373\u53ef\uff0c\u4e0d\u8981\u8ff7\u4fe1\u4e2a\u6570\u9650\u5236\uff1b</li> <li>\u53ef\u4ee5\u901a\u8fc7\u8868 <code>sys.schema_unused_indexes</code> \u548c\u7d22\u5f15\u4e0d\u53ef\u89c1\u7279\u6027\uff0c\u5220\u9664\u65e0\u7528\u7684\u7d22\u5f15\u3002</li> </ul> <pre><code>SELECT * FROM schema_unused_indexes\n\nWHERE object_schema != 'performance_schema';\n</code></pre> <p>\u800c MySQL 8.0 \u7248\u672c\u63a8\u51fa\u4e86\u7d22\u5f15\u4e0d\u53ef\u89c1\uff08Invisible\uff09\u529f\u80fd\u3002</p> <pre><code>ALTER TABLE t1 \n\nALTER INDEX idx_name INVISIBLE/VISIBLE;\n</code></pre>"},{"location":"chap2_opt/8opt_int/#3-2","title":"3-2 \u7d22\u5f15\u7ec4\u7ec7\u8868","text":"<p>\u4ece MySQL 5.7 \u7248\u672c\u5f00\u59cb\uff0cMySQL \u5c31\u5f00\u59cb\u652f\u6301\u521b\u5efa\u51fd\u6570\u7d22\u5f15 \uff08\u5373\u7d22\u5f15\u952e\u662f\u4e00\u4e2a\u51fd\u6570\u8868\u8fbe\u5f0f\uff09\u3002 \u51fd\u6570\u7d22\u5f15\u6709\u4e24\u5927\u7528\u5904\uff1a</p> <ul> <li>\u4f18\u5316\u4e1a\u52a1 SQL \u6027\u80fd\uff1b</li> <li>\u914d\u5408\u865a\u62df\u5217\uff08Generated Column)</li> </ul> <p>\u4f60\u5e94\u8be5\u4e86\u89e3\u5230MySQL InnoDB \u5b58\u50a8\u5f15\u64ce\u662f\u7d22\u5f15\u7ec4\u7ec7\u8868\uff0c\u4ee5\u53ca\u7d22\u5f15\u7ec4\u7ec7\u8868\u548c\u5806\u8868\u4e4b\u95f4\u7684\u533a\u522b\u3002</p> <ul> <li>\u7d22\u5f15\u7ec4\u7ec7\u8868\u4e3b\u952e\u662f\u805a\u96c6\u7d22\u5f15\uff0c\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5b58\u653e\u8868\u4e2d\u4e00\u6574\u884c\u5b8c\u6574\u8bb0\u5f55\uff1b<ul> <li>\u9664\u4e86\u4e3b\u952e\u7d22\u5f15\u5916\uff0c\u5176\u4ed6\u7684\u7d22\u5f15\u90fd\u79f0\u4e4b\u4e3a\u4e8c\u7ea7\u7d22\u5f15\uff08Secondeary Index\uff09\uff0c \u6216\u975e\u805a\u96c6\u7d22\u5f15\uff08None Clustered Index\uff09\u3002</li> </ul> </li> <li>\u9664\u4e3b\u952e\u7d22\u5f15\u5916\u7684\u7d22\u5f15\u90fd\u662f\u4e8c\u7ea7\u7d22\u5f15\uff0c\u7d22\u5f15\u7684\u53f6\u5b50\u8282\u70b9\u5b58\u653e\u7684\u662f\uff08\u7d22\u5f15\u952e\u503c\uff0c\u4e3b\u952e\u503c\uff09\uff1b<ul> <li>\u901a\u8fc7\u4e8c\u7ea7\u7d22\u5f15 <code>idx_name</code> \u53ea\u80fd\u5b9a\u4f4d\u4e3b\u952e\u503c\uff0c\u9700\u8981\u989d\u5916\u518d\u901a\u8fc7\u4e3b\u952e\u7d22\u5f15\u8fdb\u884c\u67e5\u8be2\uff0c\u624d\u80fd\u5f97\u5230\u6700\u7ec8\u7684\u7ed3\u679c\u3002</li> </ul> </li> </ul> <pre><code>PRIMARY KEY(id), -- \u4e3b\u952e\u7d22\u5f15\nKEY idx_name(name) -- \u4e8c\u7ea7\u7d22\u5f15\n</code></pre> <ul> <li>\u7531\u4e8e\u4e8c\u7ea7\u7d22\u5f15\u4e0d\u5b58\u653e\u5b8c\u6574\u8bb0\u5f55\uff0c\u56e0\u6b64\u9700\u8981\u901a\u8fc7\u4e3b\u952e\u503c\u518d\u8fdb\u884c\u4e00\u6b21\u56de\u8868\u624d\u80fd\u5b9a\u4f4d\u5230\u5b8c\u6574\u6570\u636e\uff1b<ul> <li>\u8fd9\u79cd\u201c\u4e8c\u7ea7\u7d22\u5f15\u901a\u8fc7\u4e3b\u952e\u7d22\u5f15\u8fdb\u884c\u518d\u4e00\u6b21\u67e5\u8be2\u201d\u7684\u64cd\u4f5c\u53eb\u4f5c\u201c\u56de\u8868\u201d</li> </ul> </li> <li>\u7d22\u5f15\u7ec4\u7ec7\u8868\u5bf9\u6bd4\u5806\u8868\uff0c\u5728\u6d77\u91cf\u5e76\u53d1\u7684OLTP\u4e1a\u52a1\u4e2d\u80fd\u6709\u66f4\u597d\u7684\u6027\u80fd\u8868\u73b0\uff1b<ul> <li>\u201c\u7d22\u5f15\u7ec4\u7ec7\u8868\uff0c\u6570\u636e\u5373\u7d22\u5f15\uff0c\u7d22\u5f15\u5373\u6570\u636e\u201d\u3002\u90a3\u4e48\u4e3a\u4e86\u4fbf\u4e8e\u7406\u89e3\u4e8c\u7ea7\u7d22\u5f15\uff0c\u4f60\u53ef\u4ee5\u5c06\u4e8c\u7ea7\u7d22\u5f15\u6309\u7167\u4e00\u5f20\u8868\u6765\u8fdb\u884c\u7406\u89e3\uff0c\u6bd4\u5982\u7d22\u5f15 <code>idx_name</code> \u53ef\u4ee5\u7406\u89e3\u6210\u4e00\u5f20\u8868</li> </ul> </li> <li>\u6bcf\u79cd\u4e0d\u540c\u6570\u636e\uff0c\u5bf9\u4e8c\u7ea7\u7d22\u5f15\u7684\u6027\u80fd\u5f00\u9500\u5f71\u54cd\u662f\u4e0d\u4e00\u6837\u7684\uff1b</li> <li>\u6709\u65f6\u901a\u8fc7\u51fd\u6570\u7d22\u5f15\u53ef\u4ee5\u5feb\u901f\u89e3\u51b3\u7ebf\u4e0aSQL\u7684\u6027\u80fd\u95ee\u9898\uff1b</li> <li>\u865a\u62df\u5217\u4e0d\u5360\u7528\u5b9e\u9645\u5b58\u50a8\u7a7a\u95f4\uff0c\u5728\u865a\u62df\u5217\u4e0a\u521b\u5efa\u7d22\u5f15\u672c\u8d28\u5c31\u662f\u51fd\u6570\u7d22\u5f15\u3002</li> </ul>"},{"location":"chap2_opt/8opt_int/#3-3","title":"3-3 \u7ec4\u5408\u7d22\u5f15","text":"<p>\u7ec4\u5408\u7d22\u5f15\uff08Compound Index\uff09\u662f\u6307\u7531\u591a\u4e2a\u5217\u6240\u7ec4\u5408\u800c\u6210\u7684 B+\u6811\u7d22\u5f15\uff0c\u8fd9\u548c\u6211\u4eec\u4e4b\u524d\u4ecb\u7ecd\u7684B+ \u6811\u7d22\u5f15\u7684\u539f\u7406\u5b8c\u5168\u4e00\u6837\uff0c\u53ea\u662f\u4e4b\u524d\u662f\u5bf9\u4e00\u4e2a\u5217\u6392\u5e8f\uff0c\u73b0\u5728\u662f\u5bf9\u591a\u4e2a\u5217\u6392\u5e8f\u3002</p> <p>\u5f52\u7eb3\u7ec4\u5408\u7d22\u5f15\u7684\u4e09\u5927\u4f18\u52bf</p> <ul> <li>\u8986\u76d6\u591a\u4e2a\u67e5\u8be2\u6761\u4ef6\uff0c\u5982\uff08a\uff0cb\uff09\u7d22\u5f15\u53ef\u4ee5\u8986\u76d6\u67e5\u8be2 <code>a = ?</code>\u6216\u8005 <code>a = ? and b = ?\uff1b</code></li> <li>\u907f\u514d SQL \u7684\u989d\u5916\u6392\u5e8f\uff0c\u63d0\u5347 SQL \u6027\u80fd\uff0c\u5982 <code>WHERE a = ? ORDER BY b</code> \u8fd9\u6837\u7684\u67e5\u8be2\u6761\u4ef6\uff1b</li> <li>\u5229\u7528\u7ec4\u5408\u7d22\u5f15\u5305\u542b\u591a\u4e2a\u5217\u7684\u7279\u6027\uff0c\u53ef\u4ee5\u5b9e\u73b0\u7d22\u5f15\u8986\u76d6\u6280\u672f\uff0c\u63d0\u5347 SQL \u7684\u67e5\u8be2\u6027\u80fd\uff0c\u7528\u597d\u7d22\u5f15\u8986\u76d6\u6280\u672f\uff0c\u6027\u80fd\u63d0\u5347 10 \u500d\u4e0d\u662f\u96be\u4e8b\u3002</li> </ul>"},{"location":"chap2_opt/8opt_int/#3-4","title":"3-4  \u7d22\u5f15\u51fa\u9519","text":"<ul> <li>MySQL \u4f18\u5316\u5668\u662f CBO \u7684\uff1b\uff0c\u8fd9\u79cd\u4f18\u5316\u5668\u79f0\u4e4b\u4e3a\uff1aCBO\uff08Cost-based Optimizer\uff0c\u57fa\u4e8e\u6210\u672c\u7684\u4f18\u5316\u5668\uff09\u3002</li> <li>MySQL \u4f18\u5316\u5668\u8ba4\u4e3a\u4ece\u78c1\u76d8\u8bfb\u53d6\u7684\u5f00\u9500\u662f\u5185\u5b58\u5f00\u9500\u7684 4 \u500d\u3002</li> <li>MySQL \u4f1a\u9009\u62e9\u6210\u672c\u6700\u4f4e\u7684\u6267\u884c\u8ba1\u5212\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7 EXPLAIN \u547d\u4ee4\u67e5\u770b\u6bcf\u4e2a SQL \u7684\u6210\u672c\uff1b</li> <li>\u4e00\u822c\u53ea\u5bf9\u9ad8\u9009\u62e9\u5ea6\u7684\u5b57\u6bb5\u548c\u5b57\u6bb5\u7ec4\u5408\u521b\u5efa\u7d22\u5f15\uff0c\u4f4e\u9009\u62e9\u5ea6\u7684\u5b57\u6bb5\u5982\u6027\u522b\uff0c\u4e0d\u521b\u5efa\u7d22\u5f15\uff1b</li> <li>\u4f4e\u9009\u62e9\u6027\uff0c\u4f46\u662f\u6570\u636e\u5b58\u5728\u503e\u659c\uff0c\u901a\u8fc7\u7d22\u5f15\u627e\u51fa\u5c11\u90e8\u5206\u6570\u636e\uff0c\u53ef\u4ee5\u8003\u8651\u521b\u5efa\u7d22\u5f15\uff1b</li> <li>\u82e5\u6570\u636e\u5b58\u5728\u503e\u659c\uff0c\u53ef\u4ee5\u521b\u5efa\u76f4\u65b9\u56fe\uff0c\u8ba9\u4f18\u5316\u5668\u77e5\u9053\u7d22\u5f15\u4e2d\u6570\u636e\u7684\u5206\u5e03\uff0c\u8fdb\u4e00\u6b65\u6821\u51c6\u6267\u884c\u8ba1\u5212</li> </ul>"},{"location":"chap2_opt/8opt_int/#4","title":"4 \u67e5\u8be2\u4f18\u5316","text":"<p>MySQL \u6570\u636e\u5e93\u4e2d\u652f\u6301 JOIN \u8fde\u63a5\u7684\u7b97\u6cd5\u6709 Nested Loop Join \u548c Hash Join \u4e24\u79cd\uff0c\u524d\u8005\u901a\u5e38\u7528\u4e8e OLTP \u4e1a\u52a1\uff0c\u540e\u8005\u7528\u4e8e OLAP \u4e1a\u52a1\u3002</p> <p>\u5728 OLTP \u53ef\u4ee5\u5199 JOIN\uff0c\u4f18\u5316\u5668\u4f1a\u81ea\u52a8\u9009\u62e9\u6700\u4f18\u7684\u6267\u884c\u8ba1\u5212\u3002\u4f46\u82e5\u4f7f\u7528 JOIN\uff0c\u8981\u786e\u4fdd SQL \u7684\u6267\u884c\u8ba1\u5212\u4f7f\u7528\u4e86\u6b63\u786e\u7684\u7d22\u5f15\u4ee5\u53ca\u7d22\u5f15\u8986\u76d6\uff0c\u56e0\u6b64\u7d22\u5f15\u8bbe\u8ba1\u663e\u5f97\u5c24\u4e3a\u91cd\u8981\uff0c\u8fd9\u4e5f\u662fDBA\u5728\u67b6\u6784\u8bbe\u8ba1\u65b9\u9762\u7684\u91cd\u8981\u5de5\u4f5c\u4e4b\u4e00\u3002</p> <ul> <li><code>Left Join</code> \u6765\u8bf4\uff0c\u9a71\u52a8\u8868\u5c31\u662f\u5de6\u8868 R\uff1b <code>Right Join</code> \u4e2d\uff0c\u9a71\u52a8\u8868\u5c31\u662f\u53f3\u8868 S\u3002\u8fd9\u662f JOIN \u7c7b\u578b\u51b3\u5b9a\u5de6\u8868\u6216\u53f3\u8868\u7684\u6570\u636e\u4e00\u5b9a\u8981\u8fdb\u884c\u67e5\u8be2\u3002\u4f46\u5bf9\u4e8e <code>INNER JOIN</code>\uff0c\u9a71\u52a8\u8868\u53ef\u80fd\u662f\u8868 R\uff0c\u4e5f\u53ef\u80fd\u662f\u8868 S\u3002</li> </ul> <p>\u5206\u533a\u8868</p> <ul> <li>\u5f53\u524d MySQL \u7684\u5206\u533a\u8868\u652f\u6301 RANGE\u3001LIST\u3001HASH\u3001KEY\u3001COLUMNS \u7684\u5206\u533a\u7b97\u6cd5\uff1b</li> <li>\u5206\u533a\u8868\u7684\u521b\u5efa\u9700\u8981\u4e3b\u952e\u5305\u542b\u5206\u533a\u5217\uff1b</li> <li>\u5728\u5206\u533a\u8868\u4e2d\u552f\u4e00\u7d22\u5f15\u4ec5\u5728\u5f53\u524d\u5206\u533a\u6587\u4ef6\u552f\u4e00\uff0c\u800c\u4e0d\u662f\u5168\u5c40\u552f\u4e00\uff1b</li> <li>\u5206\u533a\u8868\u552f\u4e00\u7d22\u5f15\u63a8\u8350\u4f7f\u7528\u7c7b\u4f3c UUID \u7684\u5168\u5c40\u552f\u4e00\u5b9e\u73b0\uff1b</li> <li>\u5206\u533a\u8868\u4e0d\u89e3\u51b3\u6027\u80fd\u95ee\u9898\uff0c\u5982\u679c\u4f7f\u7528\u975e\u5206\u533a\u5217\u67e5\u8be2\uff0c\u6027\u80fd\u53cd\u800c\u4f1a\u66f4\u5dee\uff1b</li> <li>\u63a8\u8350\u5206\u533a\u8868\u7528\u4e8e\u6570\u636e\u7ba1\u7406\u3001\u901f\u5ea6\u5feb\u3001\u65e5\u5fd7\u5c0f\u3002</li> </ul> <p>\u5206\u533a\u8868\u5e76\u4e0d\u662f\u7528\u4e8e\u63d0\u5347\u6027\u80fd\u7684\u4e00\u79cd\u624b\u6bb5\uff0c\u5b83\u662f\u65b9\u4fbf\u7ba1\u7406\u6570\u636e\u7684\u4e00\u79cd\u65b9\u5f0f\u3002</p>"},{"location":"chap2_opt/8opt_int/#5-mysql","title":"5 \u9ad8\u53ef\u7528\u67b6\u6784 - MySQL \u590d\u5236","text":""},{"location":"chap2_opt/8opt_int/#5-1-mysql","title":"5-1  MySQL \u590d\u5236\u67b6\u6784","text":"<ul> <li>\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8bb0\u5f55\u4e86\u6240\u6709\u5bf9\u4e8e MySQL \u53d8\u66f4\u7684\u64cd\u4f5c\uff1b<ul> <li>MySQL \u6570\u636e\u5e93\u662f\u57fa\u4e8e\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff08binary log\uff09\u8fdb\u884c\u6570\u636e\u589e\u91cf\u540c\u6b65\uff0c\u800c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8bb0\u5f55\u4e86\u6240\u6709\u5bf9\u4e8e MySQL \u6570\u636e\u5e93\u7684\u4fee\u6539\u64cd\u4f5c\u3002</li> <li>\u5728\u9ed8\u8ba4 ROW \u683c\u5f0f\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e2d\uff0c\u4e00\u6761 SQL \u64cd\u4f5c\u5f71\u54cd\u7684\u8bb0\u5f55\u4f1a\u88ab\u5168\u90e8\u8bb0\u5f55\u4e0b\u6765\uff0c\u6bd4\u5982\u4e00\u6761 SQL\u8bed\u53e5\u66f4\u65b0\u4e86\u4e09\u884c\u8bb0\u5f55\uff0c\u5728\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e2d\u4f1a\u8bb0\u5f55\u88ab\u4fee\u6539\u7684\u8fd9\u4e09\u6761\u8bb0\u5f55\u7684\u524d\u9879\uff08before image\uff09\u548c\u540e\u9879\uff08after image\uff09\u3002</li> <li>\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e8c\u8fdb\u5236\u65e5\u5fd7\u8bb0\u5f55\u770b\u5230\u88ab\u5220\u9664\u8bb0\u5f55\u7684\u5b8c\u6574\u4fe1\u606f\uff0c\u8fd8\u6709\u6bcf\u4e2a\u5217\u7684\u5c5e\u6027\uff0c\u6bd4\u5982\u5217\u7684\u7c7b\u578b\uff0c\u662f\u5426\u5141\u8bb8\u4e3a NULL \u503c\u7b49\u3002</li> <li>\u5982\u679c\u662f UPDATE \u64cd\u4f5c\uff0c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e2d\u8fd8\u8bb0\u5f55\u4e86\u88ab\u4fee\u6539\u8bb0\u5f55\u5b8c\u6574\u7684\u524d\u9879\u548c\u540e\u9879\uff0c</li> </ul> </li> <li>\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 <code>SHOW BINLOG EVENTS IN ... FROM ...</code> \u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u57fa\u672c\u4fe1\u606f\uff1b</li> <li>\u53ef\u4ee5\u901a\u8fc7\u5de5\u5177 mysqlbinlog \u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u8be6\u7ec6\u5185\u5bb9\uff1b</li> <li>\u590d\u5236\u642d\u5efa\u867d\u7136\u7b80\u5355\uff0c\u4f46\u522b\u5fd8\u8bb0\u914d\u7f6e <code>crash safe</code> \u76f8\u5173\u53c2\u6570\uff0c\u5426\u5219\u53ef\u80fd\u5bfc\u81f4\u4e3b\u4ece\u6570\u636e\u4e0d\u4e00\u81f4\uff1b<ul> <li>Master \u670d\u52a1\u5668\u4f1a\u628a\u6570\u636e\u53d8\u66f4\u4ea7\u751f\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u901a\u8fc7 Dump \u7ebf\u7a0b\u53d1\u9001\u7ed9 Slave \u670d\u52a1\u5668\uff1b</li> <li>Slave \u670d\u52a1\u5668\u4e2d\u7684 I/O \u7ebf\u7a0b\u8d1f\u8d23\u63a5\u53d7\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u5e76\u4fdd\u5b58\u4e3a\u4e2d\u7ee7\u65e5\u5fd7\uff1b</li> <li>SQL/Worker \u7ebf\u7a0b\u8d1f\u8d23\u5e76\u884c\u6267\u884c\u4e2d\u7ee7\u65e5\u5fd7\uff0c\u5373\u5728 Slave \u670d\u52a1\u5668\u4e0a\u56de\u653e Master \u4ea7\u751f\u7684\u65e5\u5fd7\u3002</li> </ul> </li> <li>\u5f02\u6b65\u590d\u5236\u7528\u4e8e\u975e\u6838\u5fc3\u4e1a\u52a1\u573a\u666f\uff0c\u4e0d\u8981\u6c42\u6570\u636e\u4e00\u81f4\u6027\uff1b</li> <li>\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\u7528\u4e8e\u6838\u5fc3\u4e1a\u52a1\u573a\u666f\uff0c\u5982\u94f6\u884c\u3001\u4fdd\u9669\u3001\u8bc1\u5238\u7b49\u6838\u5fc3\u4e1a\u52a1\uff0c\u9700\u8981\u4e25\u683c\u4fdd\u969c\u6570\u636e\u4e00\u81f4\u6027\uff1b<ul> <li>\u534a\u540c\u6b65\u590d\u5236\u5e76\u4e0d\u662f MySQL \u5185\u7f6e\u7684\u529f\u80fd\uff0c\u800c\u662f\u8981\u5b89\u88c5\u534a\u540c\u6b65\u63d2\u4ef6\uff0c\u5e76\u542f\u7528\u534a\u540c\u6b65\u590d\u5236\u529f\u80fd\uff0c\u8bbe\u7f6e N \u4e2a Slave \u63a5\u53d7\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6210\u529f</li> </ul> </li> <li>\u591a\u6e90\u590d\u5236\u53ef\u5c06\u591a\u4e2a Master \u6570\u636e\u6c47\u603b\u5230\u4e00\u4e2a\u6570\u636e\u5e93\u793a\u4f8b\u8fdb\u884c\u5206\u6790\uff1b</li> <li>\u5ef6\u8fdf\u590d\u5236\u4e3b\u8981\u7528\u4e8e\u8bef\u64cd\u4f5c\u9632\u8303\uff0c\u91d1\u878d\u884c\u4e1a\u8981\u7279\u522b\u8003\u8651\u8fd9\u6837\u7684\u573a\u666f\u3002<ul> <li>\u800c\u5ef6\u8fdf\u590d\u5236\u5374\u5141\u8bb8Slave \u5ef6\u8fdf\u56de\u653e\u63a5\u6536\u5230\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7</li> <li><code>CHANGE MASTER TO master_delay = 3600</code></li> </ul> </li> </ul>"},{"location":"chap2_opt/8opt_int/#5-2","title":"5-2 \u9ad8\u53ef\u7528\u8bbe\u8ba1","text":"<ul> <li>\u9ad8\u53ef\u7528\u662f\u7cfb\u7edf\u6240\u80fd\u63d0\u4f9b\u65e0\u6545\u969c\u670d\u52a1\u7684\u4e00\u79cd\u80fd\u529b\uff0c\u5ea6\u91cf\u5355\u4f4d\u662f\u51e0\u4e2a 9\uff1b</li> <li>\u7ebf\u4e0a\u7cfb\u7edf\u9ad8\u53ef\u7528\u76ee\u6807\u5e94\u4e0d\u4f4e\u4e8e 99.995%\uff0c\u5426\u5219\u7cfb\u7edf\u9891\u7e41\u5b95\u673a\uff0c\u7528\u6237\u4f53\u9a8c\u4e0d\u597d\uff1b</li> <li>\u9ad8\u53ef\u7528\u5b9e\u73b0\u57fa\u7840\u662f\uff1a\u5197\u4f59 + \u6545\u969c\u8f6c\u79fb\uff1b</li> <li>\u65e0\u72b6\u6001\u670d\u52a1\u7684\u9ad8\u53ef\u7528\u8bbe\u8ba1\u8f83\u4e3a\u7b80\u5355\uff0c\u76f4\u63a5\u6545\u969c\u8f6c\u79fb\u6216\u5254\u9664\u5c31\u884c\uff1b</li> <li>\u6570\u636e\u5e93\u4f5c\u4e3a\u6709\u72b6\u6001\u7684\u670d\u52a1\uff0c\u8bbe\u8ba1\u6bd4\u8f83\u590d\u6742\uff08\u5197\u4f59\u901a\u8fc7\u590d\u5236\u6280\u672f\u5b9e\u73b0\uff0c\u6545\u969c\u8f6c\u79fb\u9700\u8981\u5bf9\u5e94\u7684\u9ad8\u53ef\u7528\u5957\u4ef6\uff09\uff1b<ul> <li>\u4e3a\u4e86\u5728\u6545\u969c\u8f6c\u79fb\u540e\u5bf9 Service \u670d\u52a1\u65e0\u611f\u77e5\uff0c\u6240\u4ee5\u9700\u8981\u5f15\u5165 VIP\uff08Virtual IP\uff09\u865a\u62df IP \u6280\u672f\uff0c\u5f53\u53d1\u751f\u5b95\u673a\u65f6\uff0cVIP \u4e5f\u9700\u8981\u6f02\u79fb\u5230\u65b0\u7684\u4e3b\u670d\u52a1\u5668\u3002</li> </ul> </li> <li>\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u6709\u4e09\u5927\u67b6\u6784\u8bbe\u8ba1\uff0c\u8bf7\u52a1\u5fc5\u7262\u8bb0\u8fd9\u51e0\u79cd\u8bbe\u8ba1\u3002<ul> <li>\u57fa\u4e8e\u6570\u636e\u5c42\u7684\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u67b6\u6784</li> <li>\u57fa\u4e8e\u4e1a\u52a1\u5c42\u7684\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u67b6\u6784</li> <li>\u878d\u5408\u7684\u9ad8\u53ef\u7528\u67b6\u6784\u8bbe\u8ba1</li> </ul> </li> </ul>"},{"location":"chap2_opt/8opt_int/#5-3","title":"5-3 \u8bfb\u5199\u5206\u79bb\u8bbe\u8ba1","text":"<p>\u57fa\u4e8e\u4e3b\u4ece\u590d\u5236\u673a\u5236\u642d\u5efa\u4e00\u4e2a\u8bfb\u5199\u5206\u79bb\u67b6\u6784\uff0c\u603b\u7684\u6765\u8bf4\uff1a</p> <ul> <li>MySQL \u4e8c\u8fdb\u5236\u65e5\u5fd7\u662f\u4e00\u79cd\u903b\u8f91\u65e5\u5fd7\uff0c\u4fbf\u4e8e\u5c06\u6570\u636e\u540c\u6b65\u5230\u5f02\u6784\u7684\u6570\u636e\u5e73\u53f0\uff1b</li> <li>\u903b\u8f91\u65e5\u5fd7\u5728\u4e8b\u52a1\u63d0\u4ea4\u65f6\u624d\u5199\u5165\uff0c\u82e5\u5b58\u5728\u5927\u4e8b\u52a1\uff0c\u5219\u63d0\u4ea4\u901f\u5ea6\u5f88\u6162\uff0c\u4e5f\u4f1a\u5f71\u54cd\u4e3b\u4ece\u6570\u636e\u4e4b\u95f4\u7684\u540c\u6b65\uff1b</li> <li>\u5728 MySQL \u4e2d\u52a1\u5fc5\u5c06\u5927\u4e8b\u52a1\u62c6\u5206\u6210\u5c0f\u4e8b\u52a1\u5904\u7406\uff0c\u8fd9\u6837\u624d\u80fd\u907f\u514d\u4e3b\u4ece\u6570\u636e\u5ef6\u8fdf\u7684\u95ee\u9898\uff1b<ul> <li>\u8bbe\u8ba1\u65f6\uff0c\u628a DELETE \u5220\u9664\u64cd\u4f5c\u8f6c\u5316\u4e3a DROP TABLE/PARTITION \u64cd\u4f5c\uff1b</li> <li>\u4e1a\u52a1\u8bbe\u8ba1\u65f6\uff0c\u628a\u5927\u4e8b\u52a1\u62c6\u6210\u5c0f\u4e8b\u52a1\u3002</li> </ul> </li> <li>\u901a\u8fc7\u914d\u7f6e MTS \u5e76\u884c\u590d\u5236\u673a\u5236\uff0c\u53ef\u4ee5\u8fdb\u4e00\u6b65\u7f29\u77ed\u4e3b\u4ece\u6570\u636e\u5ef6\u8fdf\u7684\u95ee\u9898\uff0c\u63a8\u8350\u4f7f\u7528 MySQL 5.7\u7248\u672c\uff0c\u5e76\u914d\u7f6e\u6210\u57fa\u4e8e WRITESET \u7684\u590d\u5236\uff1b</li> <li> <p>\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u76d1\u63a7\u4e0d\u80fd\u4f9d\u8d56 <code>Seconds_Behind_Master</code> \u7684\u503c\uff0c\u6700\u597d\u7684\u65b9\u6cd5\u662f\u989d\u5916\u914d\u7f6e\u4e00\u5f20\u5fc3\u8df3\u8868\uff1b</p> <ul> <li>\u60f3\u8981\u5b9e\u65f6\u51c6\u786e\u5730\u76d1\u63a7\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\uff0c\u53ef\u4ee5\u5728\u4e3b\u670d\u52a1\u5668\u4e0a\u5f15\u5165\u4e00\u5f20\u5fc3\u8df3\u8868 heartbeat\uff0c\u7528\u4e8e\u5b9a\u671f\u66f4\u65b0\u65f6\u95f4\uff08\u6bd4\u5982\u6bcf 3 \u79d2\u4e00\u6b21\uff09\u3002\u4e8e\u4e3b\u4ece\u590d\u5236\u673a\u5236\uff0c\u4e3b\u673a\u4e0a\u5199\u5165\u7684\u65f6\u95f4\u4f1a\u88ab\u590d\u5236\u5230\u4ece\u673a\uff0c\u8fd9\u65f6\u5bf9\u4e8e\u4e3b\u4ece\u590d\u5236\u5ef6\u8fdf\u7684\u5224\u65ad\u53ef\u4ee5\u6839\u636e\u5982\u4e0b\u89c4\u5219\uff1a</li> <li><code>\u4e3b\u4ece\u5ef6\u8fdf = \u4ece\u673a\u5f53\u524d\u65f6\u95f4 - \u8868 heartbeat \u4e2d\u7684\u65f6\u95f4</code></li> </ul> </li> <li> <p>\u8bfb\u5199\u5206\u79bb\u662f\u4e00\u79cd\u67b6\u6784\u4e0a\u975e\u5e38\u5e38\u89c1\u7684\u65b9\u6cd5\uff0c\u4f60\u4e00\u5b9a\u8981\u638c\u63e1\uff0c\u5e76\u505a\u597d\u8bfb\u5199\u5206\u79bb\u67b6\u6784\u5931\u6548\u60c5\u51b5\u4e0b\u7684\u515c\u5e95\u8bbe\u8ba1\u3002</p> <ul> <li>\u8bfb\u5199\u5206\u79bb\u8bbe\u8ba1\u662f\u6307\uff1a\u628a\u5bf9\u6570\u636e\u5e93\u7684\u8bfb\u5199\u8bf7\u6c42\u5206\u5e03\u5230\u4e0d\u540c\u7684\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e0a\u3002\u5bf9\u4e8e\u5199\u5165\u64cd\u4f5c\u53ea\u80fd\u8bf7\u6c42\u4e3b\u670d\u52a1\u5668\uff0c\u800c\u5bf9\u8bfb\u53d6\u64cd\u4f5c\u5219\u53ef\u4ee5\u5c06\u8bfb\u53d6\u8bf7\u6c42\u5206\u5e03\u5230\u4e0d\u540c\u7684\u4ece\u670d\u52a1\u5668\u4e0a</li> <li>\u8bfb\u5199\u5206\u79bb\u8bbe\u8ba1\u7684\u524d\u63d0\u662f\u4ece\u673a\u4e0d\u80fd\u843d\u540e\u4e3b\u673a\u5f88\u591a\uff0c\u6700\u597d\u662f\u80fd\u51c6\u5b9e\u65f6\u6570\u636e\u540c\u6b65\uff0c\u52a1\u5fc5\u4e00\u5b9a\u8981\u5f00\u59cb\u5e76\u884c\u590d\u5236\uff0c\u5e76\u786e\u4fdd\u7ebf\u4e0a\u5df2\u7ecf\u5c06\u5927\u4e8b\u52a1\u62c6\u6210\u5c0f\u4e8b\u52a1\u3002</li> </ul> </li> </ul>"},{"location":"chap2_opt/8opt_int/#6-mysql","title":"6 MySQL\u9ad8\u53ef\u7528\u67b6\u6784","text":""},{"location":"chap2_opt/8opt_int/#6-1-","title":"6-1 \u91d1\u878d\u7ea7\u9ad8\u53ef\u7528\u67b6\u6784 - \u6570\u636e\u6838\u5bf9","text":"<ul> <li>\u6838\u5fc3\u4e1a\u52a1\u590d\u5236\u52a1\u5fc5\u8bbe\u7f6e\u4e3a\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\uff1b<ul> <li>\u4e00\u6761\u6570\u636e\u90fd\u4e0d\u5141\u8bb8\u4e22\u5931\uff08\u4e00\u822c\u4e5f\u628a\u8fd9\u79cd\u6570\u636e\u590d\u5236\u65b9\u5f0f\u53eb\u4f5c\u201c\u5f3a\u540c\u6b65\u201d\uff09\u3002\u4e48\u8981\u60f3\u5b9e\u73b0\u6570\u636e\u7684\u5f3a\u540c\u6b65\uff0c\u5728\u8fdb\u884c\u590d\u5236\u7684\u914d\u7f6e\u65f6\uff0c\u5c31\u8981\u4f7f\u7528\u65e0\u635f\u534a\u540c\u6b65\u590d\u5236\u6a21\u5f0f\u3002</li> <li>\u5728 MySQL \u5185\u90e8\u5c31\u662f\u8981\u628a\u53c2\u6570 <code>rpl_semi_sync_master_wait_point</code> \u8bbe\u7f6e\u6210 <code>AFTER_SYNC</code> \u3002</li> </ul> </li> <li>\u540c\u57ce\u5bb9\u707e\u4f7f\u7528\u4e09\u56ed\u533a\u67b6\u6784\uff0c\u4e00\u5730\u4e09\u4e2d\u5fc3\uff0c\u6216\u8005\u4e24\u5730\u4e09\u4e2d\u5fc3\uff0c\u673a\u623f\u89c1\u7f51\u7edc\u5ef6\u8fdf\u4e0d\u8d85\u8fc7 5ms\uff1b</li> <li>\u8de8\u57ce\u5bb9\u707e\u4f7f\u7528\u201c\u4e09\u5730\u4e94\u4e2d\u5fc3\u201d\uff0c\u8de8\u57ce\u673a\u623f\u8ddd\u79bb\u8d85\u8fc7 200KM\uff0c\u5ef6\u8fdf\u8d85\u8fc7 25ms\uff1b</li> <li>\u8de8\u57ce\u5bb9\u707e\u67b6\u6784\u7531\u4e8e\u7f51\u7edc\u8017\u65f6\u9ad8\uff0c\u56e0\u6b64\u4e00\u822c\u4ec5\u7528\u4e8e\u8bfb\u591a\u5199\u5c11\u7684\u4e1a\u52a1\uff0c\u4f8b\u5982\u7528\u6237\u4e2d\u5fc3\uff1b</li> <li>\u9664\u4e86\u590d\u5236\u8fdb\u884c\u6570\u636e\u540c\u6b65\u5916\uff0c\u8fd8\u9700\u8981\u989d\u5916\u7684\u6838\u5bf9\u7a0b\u5e8f\u8fdb\u884c\u903b\u8f91\u6838\u5bf9\uff1b</li> <li>\u6570\u636e\u5e93\u5c42\u7684\u903b\u8f91\u6838\u5bf9\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>last_modify_date</code> \u5b57\u6bb5\uff0c\u53d6\u51fa\u6700\u8fd1\u4fee\u6539\u7684\u8bb0\u5f55\u3002<ul> <li>\u6570\u636e\u5728\u4e1a\u52a1\u903b\u8f91\u4e0a\u4e00\u81f4\uff1a \u8fd9\u4e2a\u4fdd\u969c\u4e1a\u52a1\u662f\u5bf9\u7684\uff1b</li> <li>\u4e3b\u4ece\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u6570\u636e\u4e00\u81f4\uff1a \u8fd9\u4e2a\u4fdd\u969c\u4ece\u670d\u52a1\u5668\u7684\u6570\u636e\u662f\u5b89\u5168\u7684\u3001\u53ef\u5207\u7684\u3002</li> <li>\u4e3b\u4ece\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u6838\u5bf9\uff0c\u662f\u7531\u6570\u636e\u5e93\u56e2\u961f\u8d1f\u8d23\u7684\u3002</li> </ul> </li> </ul>"},{"location":"chap2_opt/8opt_int/#6-2","title":"6-2 \u9ad8\u53ef\u7528\u5957\u4ef6","text":"<ul> <li>MHA(Master High Availability)\u662f\u4e00\u6b3e\u5f00\u6e90\u7684 MySQL \u9ad8\u53ef\u7528\u7a0b\u5e8f\uff0c\u5b83\u4e3a MySQL \u6570\u636e\u5e93\u4e3b\u4ece\u590d\u5236\u67b6\u6784\u63d0\u4f9b\u4e86 automating master failover \u7684\u529f\u80fd\u3002</li> <li>MHA Manager \u548c MHA Node \u7684\u901a\u4fe1\u662f\u91c7\u7528 ssh \u7684\u65b9\u5f0f\uff0c\u4e5f\u5c31\u662f\u9700\u8981\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u6253\u901a MHA Manager \u5230\u6240\u6709 MySQL \u8282\u70b9\u7684 ssh \u7b56\u7565\uff0c\u90a3\u4e48\u8fd9\u91cc\u5c31\u5b58\u5728\u6f5c\u5728\u7684\u5b89\u5168\u98ce\u9669\u3002</li> <li>Orchestrator \u662f\u53e6\u4e00\u6b3e\u5f00\u6e90\u7684 MySQL \u9ad8\u53ef\u7528\u5957\u4ef6\uff0c\u9664\u4e86\u652f\u6301 failover \u7684\u5207\u6362\uff0c\u8fd8\u53ef\u901a\u8fc7Orchestrator \u5b8c\u6210 MySQL \u6570\u636e\u5e93\u7684\u4e00\u4e9b\u7b80\u5355\u7684\u590d\u5236\u7ba1\u7406\u64cd\u4f5c</li> <li>\u5176\u57fa\u672c\u5b9e\u73b0\u539f\u7406\u4e0e MHA \u662f\u4e00\u6837\u7684\uff0c\u53ea\u662f\u628a\u5143\u6570\u636e\u4fe1\u606f\u5b58\u50a8\u5728\u4e86\u5143\u6570\u636e\u5e93\u4e2d\uff0c\u5e76\u4e14\u63d0\u4f9b\u4e86HTTP \u63a5\u53e3\u548c\u547d\u4ee4\u7684\u8bbf\u95ee\u65b9\u5f0f\uff0c\u4f7f\u7528\u4e0a\u66f4\u4e3a\u53cb\u597d\u3002</li> </ul>"},{"location":"chap2_opt/8opt_int/#6-3-innodb-cluster","title":"6-3  InnoDB Cluster","text":"<p>InnoDB Cluster\u3002\u8fd9\u79cd\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\u5927\u6982\u7387\u4f1a\u6210\u4e3a\u4e0b\u4e00\u4ee3\u91d1\u878d\u573a\u666f\u7684\u6807\u51c6\u6570\u636e\u5e93\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\uff0cInnoDB Cluster \u5e95\u5c42\u662f MGR\uff0c\u901a\u8fc7\u7c7b Paoxs \u7b97\u6cd5\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c\u6027\u80fd\u66f4\u597d\uff0c\u4e14\u80fd\u4fdd\u8bc1\u6570\u636e\u7684\u5b8c\u6574\u6027\u3002</p> <p>\u7ed3\u5408\u7ba1\u7406\u5de5\u5177 MySQL Shell\uff0c\u8def\u7531\u5de5\u5177 MySQL Router \u80fd\u6784\u5efa\u4e00\u4e2a\u5b8c\u6574\u7684 MySQL \u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\u3002</p> <p>\u5bf9\u4e8e\u91d1\u878d\u7528\u6237\u6765\u8bf4\uff0c\u6211\u975e\u5e38\u63a8\u8350\u8fd9\u79cd\u9ad8\u53ef\u7528\u89e3\u51b3\u65b9\u6848\u3002\u5f53\u7136\uff0c\u6211\u5efa\u8bae\u5728\u6700\u65b0\u7684 MySQL 8.0 \u7248\u672c\u4e2d\u4f7f\u7528 InnoDB Cluster\u3002</p>"},{"location":"chap2_opt/8opt_int/#6-4","title":"6-4 \u6570\u636e\u5e93\u5907\u4efd","text":"<ul> <li>\u7b2c\u4e00\u6b65\u8981\u505a\u597d\uff1a\u7ebf\u4e0a\u6570\u636e\u5e93\u4e0e\u79bb\u7ebf\u5907\u4efd\u7cfb\u7edf\u7684\u6743\u9650\u9694\u79bb\u3002</li> <li>\u903b\u8f91\u5907\u4efd<ul> <li><code>mysqldump -A --single-transaction &gt; backup.sql</code></li> </ul> </li> <li>\u8981\u6062\u590d\u903b\u8f91\u5907\u4efd\u975e\u5e38\u7b80\u5355\uff0c\u5c31\u662f\u6267\u884c\u6587\u4ef6\u4e2d\u7684 SQL \u8bed\u53e5\uff0c\u8fd9\u65f6\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 SQL\uff1a'<ul> <li><code>mysql &lt; backup.sql</code></li> </ul> </li> <li>\u7269\u7406\u5907\u4efd\u76f4\u63a5\u5907\u4efd\u6570\u636e\u5e93\u7684\u7269\u7406\u8868\u7a7a\u95f4\u6587\u4ef6\u548c\u91cd\u505a\u65e5\u5fd7\uff0c\u4e0d\u7528\u901a\u8fc7\u903b\u8f91\u7684 SELECT \u53d6\u51fa\u6570\u636e\u3002\u6240\u4ee5\u7269\u7406\u5907\u4efd\u7684\u901f\u5ea6\uff0c\u901a\u5e38\u662f\u6bd4\u903b\u8f91\u5907\u4efd\u5feb\u7684\uff0c\u6062\u590d\u901f\u5ea6\u4e5f\u6bd4\u8f83\u5feb\u3002</li> <li>\u589e\u91cf\u5907\u4efd: \u201c\u5168\u91cf\u5907\u4efd + \u589e\u91cf\u5907\u4efd\u201d\u7684\u65b9\u5f0f\uff0c\u6784\u5efa\u5b8c\u6574\u7684\u5907\u4efd\u7b56\u7565\u3002\u589e\u91cf\u5907\u4efd\u5c31\u662f\u5bf9\u65e5\u5fd7\u6587\u4ef6\u8fdb\u884c\u5907\u4efd\uff0c\u5728 MySQL \u6570\u636e\u5e93\u4e2d\u5c31\u662f\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u3002\u5c31\u53ef\u4ee5\u5b9e\u73b0\u57fa\u4e8e\u65f6\u95f4\u70b9\u7684\u6062\u590d\uff08point in time recovery\uff09\uff0c\u4e5f\u5c31\u662f\u201c\u901a\u8fc7\u5168\u91cf + \u589e\u91cf\u5907\u4efd\u201d\u53ef\u4ee5\u6062\u590d\u5230\u4efb\u610f\u65f6\u95f4\u70b9\u3002</li> </ul>"},{"location":"chap2_opt/9Mysql_copy/","title":"L8 MySQL\u7684\u96f6\u62f7\u8d1d\u6280\u672f","text":""},{"location":"chap2_opt/9Mysql_copy/#buffer-cache","title":"\u5148\u9700\u8981\u4e86\u89e3Buffer \u4e0e cache \u7684\u533a\u522b","text":"<p>Bbuffer \u4e0e Cache \u975e\u5e38\u7c7b\u4f3c\uff0c\u56e0\u4e3a\u5b83\u4eec\u90fd\u7528\u4e8e\u5b58\u50a8\u6570\u636e\u6570\u636e\uff0c\u88ab\u5e94\u7528\u5c42\u8bfb\u53d6\u5b57\u8282\u6570\u636e\u3002\u5728\u5f88\u591a\u573a\u5408\u5b83\u4eec\u6709\u7740\u76f8\u540c\u7684\u6982\u5ff5:</p> <p>\u9996\u5148\u4ece\u7ffb\u8bd1\u4e0a\uff0cBuffer\u5e94\u8be5\u7ffb\u8bd1\u4e3a\u201c\u7f13\u51b2\u201d\uff0cCache\u5e94\u8be5\u7ffb\u8bd1\u4e3a\u201c\u7f13\u5b58\u201d\uff0c\u4e24\u4e2a\u5b8c\u5168\u4e0d\u662f\u4e00\u4e2a\u4e1c\u897f\u3002</p> <p>\u5728\u786c\u4ef6\u8fd9\u4e00\u5c42\u770b\uff0cBuffer\u5e94\u8be5\u4e3a\u5185\u5b58\uff0cCache\u4e3aCPU\u96c6\u6210\u7684\u544a\u8bc9\u7f13\u5b58\u3002</p> <p>Buffer\u4e3a\u4e86\u8ba9\u4e0d\u540c\u901f\u5ea6\u7684\u8bbe\u5907\u80fd\u591f\u540c\u6b65\uff0c\u5efa\u7acb\u7684\u4e00\u4e2a\u7f13\u51b2\u533a\u57df\uff0c\u5199\u8fdbBuffer\u7684\u6570\u636e\u662f\u4e3a\u4e86\u4ece\u4e2d\u62ff\u51fa\u5199\u5165\u5176\u4ed6\u8bbe\u5907\u3002</p> <p>Cache\u662f\u4e3a\u4e86\u63d0\u9ad8\u8bfb\u53d6\u901f\u5ea6\uff0c\u5c06\u7ecf\u5e38\u6216\u9a6c\u4e0a\u9700\u8981\u7684\u6570\u636e\u9884\u8bfb\u5230\u7f13\u5b58\u4e2d\uff0c\u5199\u8fdbCache\u7684\u6570\u636e\u662f\u4e3a\u4e86\u5176\u4ed6\u8bbe\u5907\u4ece\u4e2d\u53bb\u8bfb\u53d6\u3002</p> <p>\u4ece\u8f6f\u4ef6\u8fd9\u4e00\u5c42\u6765\u8bf4\uff0cBuffer\u662f\u5757\u8bbe\u5907\u7684\u7f13\u51b2\uff0cCache\u662f\u6587\u4ef6\u7cfb\u7edf\u7684\u7f13\u5b58\u3002\u4ee5Linux\u4e3a\u4f8b\uff0c</p> <p>Buffer(Buffer Cache)\u4ee5\u5757\u5f62\u5f0f\u7f13\u51b2\u4e86\u5757\u8bbe\u5907\u7684\u64cd\u4f5c\uff0c\u5b9a\u65f6\u6216\u624b\u52a8\u7684\u540c\u6b65\u5230\u786c\u76d8\uff0c\u5b83\u662f\u4e3a\u4e86\u7f13\u51b2\u5199\u64cd\u4f5c\u7136\u540e\u4e00\u6b21\u6027\u5c06\u5f88\u591a\u6539\u52a8\u5199\u5165\u786c\u76d8\uff0c\u907f\u514d\u9891\u7e41\u5199\u786c\u76d8\uff0c\u63d0\u9ad8\u5199\u5165\u6548\u7387\u3002</p> <p>Cache(Page Cache)\u4ee5\u9875\u9762\u5f62\u5f0f\u7f13\u5b58\u4e86\u6587\u4ef6\u7cfb\u7edf\u7684\u6587\u4ef6\uff0c\u7ed9\u9700\u8981\u4f7f\u7528\u7684\u7a0b\u5e8f\u8bfb\u53d6\uff0c\u5b83\u662f\u4e3a\u4e86\u7ed9\u8bfb\u64cd\u4f5c\u63d0\u4f9b\u7f13\u51b2\uff0c\u907f\u514d\u9891\u7e41\u8bfb\u786c\u76d8\uff0c\u63d0\u9ad8\u8bfb\u53d6\u6548\u7387\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0cBuffer\u91cc\u9762\u7684\u4e1c\u897f\u662f\u4e3a\u4e86\u5199\u5230\u522b\u5904\u53bb\uff0cCache\u91cc\u9762\u7684\u4e1c\u897f\u662f\u4e3a\u4e86\u7ed9\u522b\u5904\u8bfb\u3002</p>"},{"location":"chap2_opt/9Mysql_copy/#buffer-cache_1","title":"Buffer \u4e0e Cache \u7684\u7528\u9014\u6709\u6240\u4e0d\u4e00\u5b9a\uff1a","text":"<ul> <li> <p>Buffer \u7684\u4e3b\u8981\u76ee\u7684\u662f\u5728\u4e0d\u540c\u5e94\u7528\u3001\u7ebf\u7a0b\u3001\u8fdb\u7a0b\u4e4b\u95f4\u5171\u4eab\u5b57\u8282\u6570\u636e\uff0c\u4f8b\u5982\u4e3a\u4e86\u8ba9\u4e0d\u540c\u901f\u5ea6\u7684\u8bbe\u5907\u80fd\u591f\u8fdb\u884c\u6570\u636e\u540c\u6b65\uff0c\u5c31\u4f1a\u4f7f\u7528\u5171\u4eab Buffer\uff1b</p> </li> <li> <p>Cache \u7684\u4e3b\u8981\u76ee\u7684\u662f\u63d0\u9ad8\u5b57\u8282\u6570\u636e\u7684\u8bfb\u53d6/\u5199\u5165\u901f\u5ea6\uff0c\u4f8b\u5982\u6839\u636e\u65f6\u95f4\u5c40\u90e8\u6027\u3001\u5730\u5740\u5c40\u90e8\u6027\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b page cache \u673a\u5236\uff1b</p> </li> </ul> <p>\u5f53\u7136\uff0c\u5728\u5f88\u591a\u573a\u5408\u4e0b Buffer \u4e0e Cache \u6709\u7740\u76f8\u540c\u7684\u8bed\u4e49\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\u7f13\u51b2\u533a\u65e2\u7528\u4e8e\u63d0\u9ad8\u8bfb\u5199\u901f\u5ea6\uff0c\u53c8\u7528\u4e8e\u6570\u636e\u5171\u4eab\u4e0e\u540c\u6b65\u3002</p>"},{"location":"chap2_opt/9Mysql_copy/#2-mysql","title":"2. MySQL \u7f13\u51b2\u533a\u8bbe\u8ba1","text":"<p>MySQL \u7684\u7f13\u51b2\u533a\u8bbe\u8ba1\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u5982\u4e0a\u56fe\u6240\u793a\uff0cMySQL \u5728\u4e0d\u540c\u5c42\u6b21\u4f7f\u7528\u4e86\u4e0e\u7f13\u5b58\u673a\u5236\u4e0d\u540c\u7684\u914d\u5957\u6280\u672f\u3002\u5176\u4e2d\u6709\uff1a</p> <p>\u5e94\u7528\u5c42\uff1a</p> <ul> <li>Redo Log Buffer\uff1a\u5bf9\u5199\u64cd\u4f5c\u8fdb\u884c\u7f13\u5b58\uff0c\u7528\u4e8e\u5b9e\u73b0 MySQL InnoDB \u7684\u4e8b\u52a1\u6027\uff1b</li> <li>InnoDB Buffer Pool\uff1a\u7528\u4e8e\u5bf9 MySQL table \u7684\u6570\u636e\u8fdb\u884c\u7f13\u5b58\u3002\u8bfb\u5185\u5b58\u800c\u4e0d\u662f\u78c1\u76d8\uff0c\u901a\u8fc7\u51cf\u5c11\u78c1\u76d8\u8bfb\u64cd\u7684\u65b9\u5f0f\u63d0\u9ad8\u8bfb\u64cd\u4f5c\u6027\u80fd\uff1b\u5199\u5185\u5b58\u800c\u4e0d\u662f\u78c1\u76d8\uff0c\u901a\u8fc7\u51cf\u5c11\u78c1\u76d8\u5199\u64cd\u7684\u65b9\u5f0f\u63d0\u9ad8\u5199\u64cd\u4f5c\u6027\u80fd\uff1b</li> </ul> <p>\u64cd\u4f5c\u7cfb\u7edf\u7684 VFS\uff08Virtual file system\uff0c\u865a\u62df\u6587\u4ef6\u7cfb\u7edf\uff09\u5c42\uff1a</p> <ul> <li>Page Cache\uff1a\u64cd\u4f5c\u7cfb\u7edf\u901a\u8fc7\u7f13\u5b58\u4ee5\u53ca\u9884\u8bfb\u673a\u5236\u5bf9\u6587\u4ef6\u7cfb\u7edf\u4e2d\u7684 block \u57fa\u4e8e page \u8fdb\u884c\u7f13\u5b58\u7ba1\u7406\uff1b</li> <li>Direct Buffer\uff1a\u5f53\u4f7f\u7528 Direct I/O \u63d0\u4f9b\u7684\u76f8\u5173 API \u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u4e0d\u518d\u63d0\u4f9b\u57fa\u4e8e Page Cache \u673a\u5236\u7684\u7f13\u5b58\uff0c\u800c\u662f\u76f4\u63a5\u4f7f\u7528 Direct Buffer\uff1b</li> </ul> <p>\u78c1\u76d8\u7684 Disk Buffer\uff1a\u78c1\u76d8\u4e5f\u53ef\u4ee5\u63d0\u4f9b\u78c1\u76d8\u7f13\u5b58\uff0c\u901a\u5e38\u5728 MySQL \u4e2d\u4f1a\u5173\u95ed\u78c1\u76d8\u7f13\u5b58\uff0c\u6211\u4eec\u4ec5\u4ec5\u9700\u8981\u4e86\u89e3\u6709 Disk Buffer \u8fd9\u4e00\u6982\u5ff5\u5373\u53ef\u3002</p> <p>Write Through/Back \u4e0e Direct I/O</p> <ul> <li> <p>Write Through\uff1a\u5199\u64cd\u4f5c\"\u7a7f\u8fc7\"\u7f13\u5b58\u533a\u76f4\u63a5\u843d\u76d8\uff0c\u8fd9\u79cd\u7b56\u7565\u80fd\u591f\u786e\u4fdd\u6570\u636e\u4e0d\u4f1a\u56e0\u4e3a\u5b95\u673a\u800c\u4e22\u5931\u5185\u5b58\u7f13\u51b2\u533a\u7684\u6570\u636e\uff1b</p> </li> <li> <p>Write Back\uff1a\u4e00\u6b21\u5199\u64cd\u4f5c\u4ec5\u4ec5\u66f4\u65b0\u4e86\u5185\u5b58\u7f13\u5b58\u533a\u4e2d\u7684\u6570\u636e\uff0c\u6570\u636e\u843d\u76d8\u901a\u5e38\u901a\u8fc7\u95f4\u9694\u4e00\u4e2a\u65f6\u95f4\u8fdb\u884c\u843d\u76d8\u4e00\u6b21\uff1b</p> </li> </ul> <p>MySQL \u4e3a\u6b64\u63d0\u4f9b\u4e86\u4e00\u4e9b\u53c2\u6570\u6765\u63a7\u5236 Page Cache \u6570\u636e\u843d\u76d8\u7684\u5177\u4f53\u884c\u4e3a\uff0c\u4f8b\u5982\uff1a</p>"},{"location":"chap2_opt/9Mysql_copy/#innodb_flush_log_at_trx_commit","title":"<code>innodb_flush_log_at_trx_commit</code>","text":"<ul> <li><code>innodb_flush_log_at_trx_commit</code> \u53c2\u6570\u7528\u4e8e\u63a7\u5236\u57fa\u4e8e Page Cache \u7684 Redo Log Buffer \u7684\u6570\u636e\u843d\u76d8\u673a\u5236\u3002\u6b64\u53c2\u6570\u7528\u4e8e\u63a7\u5236\u4ee5\u4e0b\u4e24\u4e2a\u7279\u6027\u4e4b\u95f4\u7684\u5e73\u8861\uff1a</li> <li><code>innodb_flush_log_at_trx_commit</code> \u6709\u4e09\u4e2a\u53ef\u9009\u914d\u7f6e\u503c\uff1a<ul> <li>1\uff08\u9ed8\u8ba4\u503c\uff09\uff1a\u6bcf\u6b21\u4e8b\u52a1\u63d0\u4ea4\u65f6\u90fd\u65e5\u5fd7\u5fc5\u987b\u5237\u65b0\u5230\u78c1\u76d8\u4e0a\uff0c\u63d0\u4f9b\u4e86\u6700\u53ef\u9760\u7684\u4e8b\u52a1\u6027\u4fdd\u8bc1\uff1b</li> <li>0\uff1a\u65e5\u5fd7\u6bcf\u95f4\u9694 1 \u79d2\u5237\u65b0\u5230\u78c1\u76d8\u4e0a\uff0c\u8fd9\u610f\u5473\u7740\u5728\u7f13\u5b58\u4e2d\u8fd8\u6ca1\u6709\u6765\u5f97\u53ca\u5237\u65b0\u5230\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u5728\u5b95\u673a\u65f6\u4f1a\u4e22\u5931\uff1b</li> <li>2\uff1a\u65e5\u5fd7\u5728\u4e8b\u52a1\u63d0\u4ea4\u540e\u4ee5\u53ca\u6bcf\u95f4\u9694 1 \u79d2\u5237\u65b0\u5230\u78c1\u76d8\u4e0a\uff0c\u8fd9\u610f\u5473\u7740\u5728\u7f13\u5b58\u4e2d\u8fd8\u6ca1\u6709\u6765\u5f97\u53ca\u5237\u65b0\u5230\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u5728\u5b95\u673a\u65f6\u4f1a\u4e22\u5931\uff1b</li> </ul> </li> </ul> <p>\u6ce8\u610f\u4e8b\u9879\uff1a\u914d\u7f6e 0 \u4e0e 2 \u5e76\u4e0d\u80fd\u4fdd\u8bc1 100% \u6bcf\u95f4\u9694\u4e00\u79d2\u5237\u65b0\u5230\u78c1\u76d8\u4e00\u6b21\uff0c\u8fd9\u662f\u56e0\u4e3a DDL \u7684\u4fee\u6539\u4ee5\u53ca InnoDB \u6d3b\u52a8\u53ef\u80fd\u4f1a\u5bfc\u81f4\u65e5\u5fd7\u5237\u65b0\u66f4\u9891\u7e41\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u7531\u4e8e\u4e8b\u52a1\u8c03\u5ea6\u95ee\u9898\uff0c\u5237\u65b0\u9891\u7387\u751a\u81f3\u4f1a\u964d\u4f4e\u3002</p> <p>\u5237\u65b0\u9891\u7387\u9ed8\u8ba4\u4e3a 1 s\uff0c\u7531\u53c2\u6570 <code>innodb_flush_log_at_timeout</code> \u8fdb\u884c\u914d\u7f6e\u3002</p>"},{"location":"chap2_opt/9Mysql_copy/#innodb_flush_method","title":"<code>innodb_flush_method</code>","text":"<ul> <li> <p><code>innodb_flush_method</code> \u53c2\u6570\u540c\u65f6\u63a7\u5236 <code>redo log buffe</code>r \u548c <code>innodb buffer pool</code> \u7f13\u51b2\u533a\u5237\u65b0\u7b56\u7565\uff0c\u5176\u4e2d\uff1a</p> <ul> <li>log files\uff1aredo log buffer \u662f log files \u5728\u5185\u5b58\u4e2d\u7684\u7f13\u5b58\u533a\uff0c log files \u662f\u78c1\u76d8\u4e0a\u7684 Redo Log \u6587\u4ef6\uff1b</li> <li>data files\uff1ainnodb buffer pool \u662f data files \u5728\u5185\u5b58\u4e2d\u7684\u7f13\u5b58\u533a\uff0cdata files \u662f\u78c1\u76d8\u4e0a\u7684\u6570\u636e\u6587\u4ef6\uff08B+tree\uff09\uff1b</li> </ul> </li> <li> <p><code>innodb_flush_method</code> \u53c2\u6570\u76ee\u524d\u6709 6 \u79cd\u53ef\u9009\u914d\u7f6e\u503c\uff1a</p> <ul> <li>fdatasync\uff1b</li> <li><code>O_DSYNC</code></li> <li><code>O_DIRECT</code></li> <li><code>O_DIRECT_NO_FSYNC</code></li> <li>littlesync</li> <li>nosync</li> </ul> </li> </ul> <p>\u8fd9\u91cc\u53ea\u8ba8\u8bba Unix-like \u64cd\u4f5c\u7cfb\u7edf\uff0c\u800c\u4e0d\u8ba8\u8bba Windows \u7cfb\u7edf\u3002</p> <p>\u5176\u4e2d\uff0clittlesync \u4e0e nosync \u4ec5\u4ec5\u7528\u4e8e\u5185\u90e8\u6027\u80fd\u6d4b\u8bd5\uff0c\u5e76\u4e0d\u5efa\u8bae\u4f7f\u7528\u3002</p> <ul> <li>fdatasync\uff0c\u5373\u53d6\u503c 0\uff0c\u8fd9\u662f\u9ed8\u8ba4\u914d\u7f6e\u503c\u3002\u5bf9 log files \u4ee5\u53ca data files \u90fd\u91c7\u7528 fsync \u7684\u65b9\u5f0f\u8fdb\u884c\u540c\u6b65\uff1b</li> <li><code>O_DSYNC</code>\uff0c\u5373\u53d6\u503c 1\u3002\u5bf9 log files \u4f7f\u7528 O_SYNC \u6253\u5f00\u4e0e\u5237\u65b0\u65e5\u5fd7\u6587\u4ef6\uff0c\u4f7f\u7528 fsync \u6765\u5237\u65b0 data files \u4e2d\u7684\u6570\u636e\uff1b</li> <li><code>O_DIRECT</code>\uff0c\u5373\u53d6\u503c 4\u3002\u5229\u7528 Direct I/O \u7684\u65b9\u5f0f\u6253\u5f00 data file\uff0c\u5e76\u4e14\u6bcf\u6b21\u5199\u64cd\u4f5c\u90fd\u901a\u8fc7\u6267\u884c fsync \u7cfb\u7edf\u8c03\u7528\u7684\u65b9\u5f0f\u843d\u76d8\uff1b</li> <li><code>O_DIRECT_NO_FSYNC</code>\uff0c\u5373\u53d6\u503c 5\u3002\u5229\u7528 Direct I/O \u7684\u65b9\u5f0f\u6253\u5f00 data files\uff0c\u4f46\u662f\u6bcf\u6b21\u5199\u64cd\u4f5c\u5e76\u4e0d\u4f1a\u8c03\u7528 fsync \u7cfb\u7edf\u8c03\u7528\u8fdb\u884c\u843d\u76d8\uff1b</li> </ul> <p>\u8865\u5145\u8bf4\u660e\uff1a\u4ee5 O_SYNC \u65b9\u5f0f\u6253\u5f00\u6587\u4ef6\u610f\u5473\u7740\u6587\u4ef6\u7684\u6bcf\u4e00\u6b21\u5199\u64cd\u4f5c\u90fd\u76f4\u63a5\u5bfc\u81f4\u5c06\u6570\u636e\u672c\u8eab\u4ee5\u53ca\u5143\u6570\u636e\u5237\u65b0\u5230\u78c1\u76d8\u4e0a\u3002</p> <p>\u4e3a\u4ec0\u4e48\u6709 <code>O_DIRECT</code> \u4e0e <code>O_DIRECT_NO_FSYNC</code> \u914d\u7f6e\u7684\u533a\u522b\uff1f</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u7406\u89e3\u66f4\u65b0\u64cd\u4f5c\u843d\u76d8\u5206\u4e3a\u4e24\u4e2a\u5177\u4f53\u7684\u5b50\u6b65\u9aa4\uff1a\u2460\u6587\u4ef6\u6570\u636e\u66f4\u65b0\u843d\u76d8\u2461\u6587\u4ef6\u5143\u6570\u636e\u66f4\u65b0\u843d\u76d8\u3002O_DIRECT \u7684\u5728\u90e8\u5206\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u4f1a\u5bfc\u81f4\u6587\u4ef6\u5143\u6570\u636e\u4e0d\u843d\u76d8\uff0c\u9664\u975e\u4e3b\u52a8\u8c03\u7528 fsync\uff0c\u4e3a\u6b64\uff0cMySQL \u63d0\u4f9b\u4e86 <code>O_DIRECT</code> \u4ee5\u53ca <code>O_DIRECT_NO_FSYNC</code> \u8fd9\u4e24\u4e2a\u914d\u7f6e\u3002</p> <p>\u5982\u679c\u4f60\u786e\u5b9a\u5728\u81ea\u5df1\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u5373\u4f7f\u4e0d\u8fdb\u884c fsync \u8c03\u7528\uff0c\u4e5f\u80fd\u591f\u786e\u4fdd\u6587\u4ef6\u5143\u6570\u636e\u843d\u76d8\uff0c\u90a3\u4e48\u8bf7\u4f7f\u7528 <code>O_DIRECT_NO_FSYNC</code> \u914d\u7f6e\uff0c\u8fd9\u5bf9 MySQL \u6027\u80fd\u7565\u6709\u5e2e\u52a9\u3002\u5426\u5219\uff0c\u8bf7\u4f7f\u7528 <code>O_DIRECT</code>\uff0c\u4e0d\u7136\u6587\u4ef6\u5143\u6570\u636e\u7684\u4e22\u5931\u53ef\u80fd\u4f1a\u5bfc\u81f4 MySQL \u8fd0\u884c\u9519\u8bef\u3002</p>"},{"location":"chap2_opt/9Mysql_copy/#mysql","title":"MySQL \u65e5\u5fd7\u7684\u5237\u65b0\u7b56\u7565","text":"<p>MySQL \u65e5\u5fd7\u5237\u65b0\u7b56\u7565\u901a\u8fc7 <code>sync_binlog</code> \u53c2\u6570\u8fdb\u884c\u914d\u7f6e\uff0c\u5176\u6709 3 \u4e2a\u53ef\u9009\u914d\u7f6e\uff1a</p> <ul> <li><code>sync_binlog=0</code>\uff1aMySQL \u5e94\u7528\u5c06\u5b8c\u5168\u4e0d\u8d1f\u8d23\u65e5\u5fd7\u540c\u6b65\u5230\u78c1\u76d8\uff0c\u5c06\u7f13\u5b58\u4e2d\u7684\u65e5\u5fd7\u6570\u636e\u5237\u65b0\u5230\u78c1\u76d8\u5168\u6743\u4ea4\u7ed9\u64cd\u4f5c\u7cfb\u7edf\u6765\u5b8c\u6210\uff1b</li> <li><code>sync_binlog=1</code>\uff1aMySQL \u5e94\u7528\u5728\u4e8b\u52a1\u63d0\u4ea4\u524d\u5c06\u7f13\u5b58\u533a\u7684\u65e5\u5fd7\u5237\u65b0\u5230\u78c1\u76d8\uff1b</li> <li><code>sync_binlog=N</code>\uff1a\u5f53 N \u4e0d\u4e3a 0 \u4e0e 1 \u65f6\uff0cMySQL \u5728\u6536\u96c6\u5230 N \u4e2a\u65e5\u5fd7\u63d0\u4ea4\u540e\uff0c\u624d\u4f1a\u5c06\u7f13\u5b58\u533a\u7684\u65e5\u5fd7\u540c\u6b65\u5230\u78c1\u76d8\u3002</li> </ul> <p>\u4e8b\u5b9e\u4e0a\uff0c\u8fd9\u4e2a\u53c2\u6570\u4e5f\u7528\u4e8e\u63a7\u5236\u65e5\u5fd7\u662f\u901a\u8fc7 Write Through \u8fd8\u662f Write Back \u7b56\u7565\u5237\u65b0\u5230\u78c1\u76d8\u4e0a\u3002</p> <p>\u6ce8\u610f\u4e8b\u9879\uff1a\u4f7f\u7528 Page Cache \u673a\u5236\u7684\u6570\u636e\u5237\u76d8\u673a\u5236\uff0c\u5373\u4f7f\u57fa\u4e8e\u540c\u6b65\u7b56\u7565\uff0c\u5373\u6bcf\u6b21\u5199\u64cd\u4f5c\u90fd\u8981\u6c42\u6570\u636e\u76f4\u63a5\u843d\u76d8\uff0c\u4f46\u5728\u6570\u636e\u843d\u76d8\u4e4b\u524d\uff0c\u6570\u636e\u603b\u662f\u5148\u8981\u5199\u4e8e Page Cache \u4e2d\uff0c\u518d\u5c06 Page Cache \u4e2d\u7684\u5177\u4f53 Page \u5237\u65b0\u5230\u78c1\u76d8\u4e0a</p>"},{"location":"chap2_opt/9Mysql_copy/#mysql_1","title":"MySQL \u7684\u5178\u578b\u914d\u7f6e","text":"<ul> <li><code>innodb_flush_log_at_trx_commit</code> \u53c2\u6570\u914d\u7f6e\u4e3a 1\uff1aRedo Log \u8d70 Page Cache\uff0c\u5e76\u4e14\u6bcf\u6b21\u5199\u64cd\u4f5c\u7684\u65e5\u5fd7\u5728\u4e8b\u52a1\u63d0\u4ea4\u524d\u90fd\u901a\u8fc7 fsync \u5237\u65b0\u5230\u78c1\u76d8\uff1b</li> <li><code>innodb_flush_method</code>\u53c2\u6570\u914d\u7f6e\u4e3a <code>O_DIRECT</code>\uff1aInnoDB Buffer Pool \u8d70 Direct I/O\uff0c\u5e76\u4e14\u6bcf\u6b21\u5199\u64cd\u4f5c\u5bfc\u81f4\u7684\u6587\u4ef6\u6570\u636e\uff08\u5305\u62ec\u6587\u4ef6\u5143\u6570\u636e\uff09\u90fd\u901a\u8fc7 fsync \u7cfb\u7edf\u8c03\u7528\u5237\u65b0\u5230\u78c1\u76d8\uff1b</li> </ul> <p>\u5199\u4e00\u6761 redo log \u6d89\u53ca\u5230\u7684\u6b65\u9aa4\u6709\uff1a</p> <ul> <li>\u65e5\u5fd7\u5199\u5165 Redo Log buffer\uff1b</li> <li>\u65e5\u5fd7\u5199\u5165 Page Cache\uff1b</li> <li>\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528 fsync \u5c06 Page Cache \u4e2d\u7684\u810f\u9875\u5237\u65b0\u5230\u78c1\u76d8\uff1b</li> <li>\u65e5\u5fd7\u63d0\u4ea4\uff1b</li> </ul> <p>\u4fee\u6539\u8868\u7684\u4e00\u884c\u8bb0\u5f55\u6d89\u53ca\u5230\u7684\u6b65\u9aa4\u6709\uff1a</p> <ul> <li>\u66f4\u65b0\u540e\u7684\u6570\u636e\u5199\u4e8e InnoDB Buffer Pool\uff1b</li> <li>\u5b9a\u65f6\u8fdb\u884c\u5982\u4e0b\u903b\u8f91\uff08\u5f02\u6b65\u8fdb\u884c\uff09\uff1a<ul> <li>InnoDB Buffer Pool \u810f\u6570\u636e\u8fdb\u884c\u5237\u65b0\uff0c\u901a\u8fc7\u6587\u4ef6\u7684 write \u65b9\u6cd5\u8fdb\u884c\uff1b</li> <li>\u6587\u4ef6\u7684 write \u65b9\u6cd5\u76f4\u63a5\u5bfc\u81f4\u6570\u636e\u5199\u4e8e\u78c1\u76d8\u4e0a\uff1b</li> <li>\u5b9a\u65f6\u8fdb\u884c\u6587\u4ef6\u7684 fysnc \u8c03\u7528\uff0c\u786e\u4fdd\u6587\u4ef6\u5143\u6570\u636e\u5199\u4e8e\u78c1\u76d8\u4e0a\uff1b</li> </ul> </li> </ul>"},{"location":"chap_k8s/1Mysql_k8s/","title":"\u7b2c\u4e00\u8282 Kubernetes \u90e8\u7f72 MySQL \u4e3b\u4ece\u670d\u52a1","text":"<p>\u4e00\u822c\u60c5\u51b5\u4e0b Kubernetes \u53ef\u4ee5\u901a\u8fc7 ReplicaSet \u4ee5\u4e00\u4e2a Pod \u6a21\u677f\u521b\u5efa\u591a\u4e2a pod \u526f\u672c\uff0c\u4f46\u662f\u5b83\u4eec\u90fd\u662f\u65e0\u72b6\u6001\u7684\uff0c\u4efb\u4f55\u65f6\u5019\u5b83\u4eec\u90fd\u53ef\u4ee5\u88ab\u4e00\u4e2a\u5168\u65b0\u7684 pod \u66ff\u6362\u3002\u7136\u800c\u6709\u72b6\u6001\u7684 pod \u9700\u8981\u53e6\u5916\u7684\u65b9\u6848\u786e\u4fdd\u5f53\u4e00\u4e2a\u6709\u72b6\u6001\u7684 pod \u6302\u6389\u540e\uff0c\u8fd9\u4e2a pod \u5b9e\u4f8b\u9700\u8981\u5728\u522b\u7684\u8282\u70b9\u4e0a\u91cd\u5efa\uff0c\u4f46\u662f\u65b0\u7684\u5b9e\u4f8b\u5fc5\u987b\u4e0e\u88ab\u66ff\u6362\u7684\u5b9e\u4f8b\u62e5\u6709\u76f8\u540c\u7684\u540d\u79f0\u3001\u7f51\u7edc\u6807\u8bc6\u548c\u72b6\u6001\u3002\u8fd9\u5c31\u662f Statefulset \u7ba1\u7406 pod \u7684\u624b\u6bb5\u3002</p> <p>\u5bf9\u4e8e\u5bb9\u5668\u96c6\u7fa4\uff0c\u6709\u72b6\u6001\u670d\u52a1\u7684\u6311\u6218\u5728\u4e8e\uff0c\u901a\u5e38\u96c6\u7fa4\u4e2d\u7684\u4efb\u4f55\u8282\u70b9\u90fd\u5e76\u975e100%\u53ef\u9760\u7684\uff0c\u670d\u52a1\u6240\u9700\u7684\u8d44\u6e90\u4e5f\u4f1a\u52a8\u6001\u5730\u66f4\u65b0\u6539\u53d8\u3002</p> <p>\u5f53\u8282\u70b9\u7531\u4e8e\u6545\u969c\u6216\u670d\u52a1\u7531\u4e8e\u9700\u8981\u66f4\u591a\u7684\u8d44\u6e90\u800c\u65e0\u6cd5\u7ee7\u7eed\u8fd0\u884c\u5728\u539f\u6709\u8282\u70b9\u4e0a\u65f6\uff0c\u96c6\u7fa4\u7ba1\u7406\u7cfb\u7edf\u4f1a\u4e3a\u8be5\u670d\u52a1\u91cd\u65b0\u5206\u914d\u4e00\u4e2a\u65b0\u7684\u8fd0\u884c\u4f4d\u7f6e\uff0c\u4ece\u800c\u786e\u4fdd\u4ece\u6574\u4f53\u4e0a\u770b\uff0c\u96c6\u7fa4\u5bf9\u5916\u7684\u670d\u52a1\u4e0d\u4f1a\u4e2d\u65ad\u3002\u82e5\u91c7\u7528\u672c\u5730\u5b58\u50a8\uff0c\u5f53\u670d\u52a1\u6f02\u79fb\u540e\u6570\u636e\u5e76\u4e0d\u4f1a\u968f\u7740\u670d\u52a1\u8f6c\u79fb\u5230\u65b0\u7684\u8282\u70b9\uff0c\u91cd\u542f\u670d\u52a1\u5c31\u4f1a\u51fa\u73b0\u6570\u636e\u4e22\u5931\u7684\u56f0\u5883\u3002</p> <p>\u672c\u6587\u76ee\u7684\u662f\u901a\u8fc7\u4e00\u4e2a mysql \u7684\u4e3b\u4ece\u96c6\u7fa4\u642d\u5efa\uff0c\u6df1\u5165\u4e86\u89e3 kubernetes \u7684 statfulset \u7ba1\u7406\u3002</p> <p>\u4e3a\u4e86\u964d\u4f4e\u5b9e\u9a8c\u7684\u5916\u90e8\u4f9d\u8d56\uff0c\u5b58\u50a8\u5c42\u9762\u4e0a\uff0c\u6211\u91c7\u7528\u7684\u662f\u672c\u5730\u5b58\u50a8\uff0c\u5f53\u7136\u751f\u4ea7\u4e0a\u4e0d\u5efa\u8bae\u8fd9\u6837\u505a\uff0c\u751f\u4ea7\u73af\u5883\u7684\u5b58\u50a8\u63a8\u8350\u5b98\u65b9\u4ecb\u7ecd\u5230\u7684\u7684 gce\u3001nfs\u3001ceph\u7b49\u5b58\u50a8\u65b9\u6848\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u65b9\u6848\u652f\u6301\u52a8\u6001\u4f9b\u7ed9\u7684\u7279\u6027\uff0c\u5141\u8bb8\u5f00\u53d1\u4eba\u5458\u901a\u8fc7 pvc \u7684\u5b9a\u4e49\uff0c\u5feb\u901f\u5b9e\u73b0\u6570\u636e\u6709\u6548\u5b58\u50a8\uff0c\u6240\u4ee5\u4f60\u7edd\u4e0d\u5e94\u8be5\u628a\u4e00\u4e2a\u5bbf\u4e3b\u673a\u4e0a\u7684\u76ee\u5f55\u5f53\u4f5c PV \u4f7f\u7528\uff0c \u53ea\u662f\u672c\u6587\u7528\u4e8e\u5b9e\u9a8c\u9700\u8981\uff0c\u91c7\u7528 Local Persistent Volume \u7684\u624b\u6bb5\uff0c\u76ee\u7684\u53ea\u662f\u4e3a\u4e86\u9a8c\u8bc1 Statefulset \u7684\u72b6\u6001\u7ba1\u7406\u529f\u80fd\u3002</p> <p>\u5b9e\u9a8c\u73af\u5883</p> <ul> <li>kubernetes Master</li> <li>kubernetes Node\uff08\u6d4b\u8bd5\u6f14\u793a\uff0c\u6240\u6709\u7684\u526f\u672c\u90fd\u4f1a\u5728\u5176\u4e0a\u8fd0\u884c\uff09</li> <li>kubernetes DNS \u670d\u52a1\u5df2\u5f00\u542f</li> </ul> <p>\u5b9e\u9a8c\u76ee\u7684</p> <ul> <li>\u642d\u5efa\u4e00\u4e2a\u4e3b\u4ece\u590d\u5236\uff08Master-Slave\uff09\u7684 MySQL \u96c6\u7fa4</li> <li>\u4ece\u8282\u70b9\u53ef\u4ee5\u6c34\u5e73\u6269\u5c55</li> <li>\u6240\u6709\u7684\u5199\u64cd\u4f5c\u53ea\u80fd\u5728\u4e3b\u8282\u70b9\u4e0a\u6267\u884c</li> <li>\u8bfb\u64cd\u4f5c\u53ef\u4ee5\u5728\u4e3b\u4ece\u8282\u70b9\u4e0a\u6267\u884c</li> <li>\u4ece\u8282\u70b9\u80fd\u540c\u6b65\u4e3b\u8282\u70b9\u7684\u6570\u636e</li> </ul> <p></p>"},{"location":"chap_k8s/1Mysql_k8s/#_1","title":"\u4e00\u3001\u672c\u5730\u5b58\u50a8\u539f\u7406","text":"<p>\u4e3a\u4e86\u5feb\u901f\u642d\u5efa\u6d4b\u8bd5\u73af\u5883\uff0c\u6211\u4eec\u8fd9\u91cc\u4f7f\u7528\u4e86\u672c\u5730\u5b58\u50a8\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u7528\u6237\u5e0c\u671b Kubernetes \u80fd\u591f\u76f4\u63a5\u4f7f\u7528\u5bbf\u4e3b\u673a\u4e0a\u7684\u672c\u5730\u78c1\u76d8\u76ee\u5f55\uff0c\u800c\u4e0d\u4f9d\u8d56\u4e8e\u8fdc\u7a0b\u5b58\u50a8\u670d\u52a1\uff0c\u6765\u63d0\u4f9b\u6301\u4e45\u5316\u7684\u5bb9\u5668 Volume\u3002\u4e0d\u8fc7\u8fd9\u91cc\u6709\u4e2a\u96be\u70b9\uff1a</p> <p>\u6211\u4eec\u628a\u5b58\u50a8\u56fa\u5b9a\u5728\u4e00\u4e2a\u8282\u70b9\u4e0a\uff0c\u4f46\u662fpod\u5728\u8c03\u5ea6\u7684\u65f6\u5019\uff0c\u662f\u98d8\u6765\u98d8\u53bb\u7684\uff0c\u600e\u4e48\u80fd\u8ba9pod\u901a\u8fc7pvc\u4e5f\u80fd\u56fa\u5b9a\u5728pv\u4e0a\uff1f</p> <p>\u7ed9\u8fd9\u4e2a Pod \u52a0\u4e0a\u4e00\u4e2a nodeAffinity \u884c\u4e0d\u884c\uff1f</p> <p>\u5f53\u7136\u884c\uff0c\u4f46\u662f\u8fd9\u53d8\u76f8\u7834\u574f\u4e86\u5f00\u53d1\u4eba\u5458\u5bf9\u8d44\u6e90\u5bf9\u8c61\u7684\u5b9a\u4e49\u89c4\u8303\u4e86\uff0c\u5f00\u53d1\u4eba\u5458\u5e94\u8be5\u4e0d\u9700\u8981\u65f6\u523b\u8003\u8651\u8c03\u5ea6\u7684\u7ec6\u8282\u3002\u8c03\u5ea6\u7684\u6539\u52a8\u5e94\u8be5\u4ea4\u7ed9\u8fd0\u7ef4\u5c31\u884c\u3002\u6240\u4ee5\u6211\u4eec\u4e3a\u4e86\u5b9e\u73b0\u672c\u5730\u5b58\u50a8\uff0c\u6211\u4eec\u91c7\u7528\u4e86 <code>\u5ef6\u8fdf\u7ed1\u5b9a</code> \u7684\u65b9\u6cd5\u3002</p> <p>\u65b9\u6cd5\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u90fd\u77e5\u9053 <code>storageclass</code> \u4e00\u822c\u7531\u8fd0\u7ef4\u4eba\u5458\u8bbe\u8ba1\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728<code>storageclass</code>\u6307\u5b9a <code>no-provisioner</code>\u3002</p> <p>\u8fd9\u662f\u56e0\u4e3a <code>Local Persistent Volume</code> \u76ee\u524d\u5c1a\u4e0d\u652f\u6301 <code>Dynamic Provisioning</code>\uff0c\u6240\u4ee5\u5b83\u6ca1\u529e\u6cd5\u5728\u7528\u6237\u521b\u5efa <code>PVC</code> \u7684\u65f6\u5019\uff0c\u5c31\u81ea\u52a8\u521b\u5efa\u51fa\u5bf9\u5e94\u7684 <code>PV</code>\u3002</p> <p>\u4e0e\u6b64\u540c\u65f6\uff0c\u8fd9\u4e2a <code>StorageClass</code> \u8fd8\u5b9a\u4e49\u4e86\u4e00\u4e2a <code>volumeBindingMode=WaitForFirstConsumer</code>\u7684\u5c5e\u6027\u3002\u5b83\u662f<code>Local Persistent Volume</code> \u91cc\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7279\u6027\uff0c\u5373\uff1a\u5ef6\u8fdf\u7ed1\u5b9a</p> <pre><code>kind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\n  name: local-storage\nprovisioner: kubernetes.io/no-provisioner\nvolumeBindingMode: WaitForFirstConsumer\n</code></pre> <p>\u5b9e\u9a8c\u6b65\u9aa4</p> <p>\u5148\u5728node \uff08\u5b9e\u9a8c\u7528\u7684node\u8282\u70b9IP\u662f<code>172.31.170.51</code> \uff09\u8282\u70b9\u4e0a\uff0c\u9884\u5148\u5206\u914d\u51e0\u4e2apv (\u4e0d\u5efa\u8bae\u5728\u751f\u4ea7\u4e0a\u8fd9\u6837\u64cd\u4f5c)</p> <p><code>01-persistentVolume-1.yaml</code></p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: example-mysql-pv\nspec:\n  capacity:\n    storage: 15Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/svr/projects/mysql\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - 172.31.170.51\n</code></pre> <p><code>01-persistentVolume-2.yaml</code></p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: example-mysql-pv-2\nspec:\n  capacity:\n    storage: 15Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/svr/projects/mysql2\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - 172.31.170.51\n</code></pre> <p><code>01-persistentVolume-3.yaml</code></p> <pre><code>apiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: example-mysql-pv-3\nspec:\n  capacity:\n    storage: 15Gi\n  volumeMode: Filesystem\n  accessModes:\n  - ReadWriteOnce\n  persistentVolumeReclaimPolicy: Delete\n  storageClassName: local-storage\n  local:\n    path: /data/svr/projects/mysql3\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - 172.31.170.51\n</code></pre> <p>\u8bb0\u4f4f\uff0c\u8fd9\u662f\u5728\u751f\u4ea7\u4e0a\u4e0d\u63a8\u8350\u7684\u505a\u6cd5\uff0c\u6211\u53ea\u662f\u5b9e\u9a8c\u7528\u9014\u624d\u8fd9\u6837\u624b\u52a8\u9884\u5148\u521b\u5efa\uff0c\u6b63\u89c4\u7684\u505a\u6cd5\u5e94\u8be5\u901a\u8fc7storageclass\u91c7\u7528 <code>Dynamic Provisioning</code>\uff0c \u800c\u4e0d\u662f <code>Static Provisioning</code> \u673a\u5236\u751f\u4ea7PV\u3002</p> <pre><code>kubectl apply -f 01-persistentVolume-{1..3}.yaml\n\npersistentvolume/example-mysql-pv1 created\npersistentvolume/example-mysql-pv2 created\npersistentvolume/example-mysql-pv3 created\n</code></pre>"},{"location":"chap_k8s/1Mysql_k8s/#storageclass","title":"\u4e8c\u3001\u521b\u5efa StorageClass","text":"<p>02-storageclass.yaml</p> <pre><code>kind: StorageClass\napiVersion: storage.k8s.io/v1\nmetadata:\n  name: local-storage\nprovisioner: kubernetes.io/no-provisioner\nvolumeBindingMode: WaitForFirstConsumer\n</code></pre> <p>\u6267\u884c\u521b\u5efa</p> <pre><code>kubectl apply -f 02-storageclass.yaml\n\nstorageclass.storage.k8s.io/local-storage created\n</code></pre>"},{"location":"chap_k8s/1Mysql_k8s/#namespace","title":"\u4e09\u3001\u521b\u5efaNamespace","text":"<pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: mysql\n  labels:\n    app: mysql\n</code></pre> <p>\u6267\u884c\u521b\u5efa</p> <pre><code>kubectl apply -f 03-mysql-namespace.yaml\n\nnamespace/mysql created\n</code></pre>"},{"location":"chap_k8s/1Mysql_k8s/#configmap-masterslave","title":"\u56db\u3001\u4f7f\u7528 ConfigMap \u4e3a Master/Slave \u8282\u70b9\u5206\u914d\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6","text":"<p><code>04-mysql-configmap.yaml</code></p> <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\ndata:\n  master.cnf: |\n    # Master\u914d\u7f6e\n    [mysqld]\n    log-bin=mysqllog\n    skip-name-resolve\n  slave.cnf: |\n    # Slave\u914d\u7f6e\n    [mysqld]\n    super-read-only\n    skip-name-resolve\n    log-bin=mysql-bin\n    replicate-ignore-db=mysql\n</code></pre> <p>\u521b\u5efa\u6267\u884c</p> <pre><code>kubectl apply -f 04-mysql-configmap.yaml\n\nconfigmap/mysql created\n</code></pre>"},{"location":"chap_k8s/1Mysql_k8s/#mysqlsecret","title":"\u4e94\u3001\u521b\u5efamysql\u5bc6\u7801Secret","text":"<p><code>05-mysql-secret.yaml</code></p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: mysql-secret\n  namespace: mysql\n  labels:\n    app: mysql\ntype: Opaque\ndata:\n  password: MTIzNDU2 # echo -n \"123456\" | base64\n</code></pre> <pre><code>kubectl apply -f 05-mysql-secret.yaml\n\nsecret/mysql-secret created\n</code></pre>"},{"location":"chap_k8s/1Mysql_k8s/#service-mysql","title":"\u516d\u3001\u4f7f\u7528 Service \u4e3a MySQL \u63d0\u4f9b\u8bfb\u5199\u5206\u79bb","text":"<p><code>06-mysql-services.yaml</code></p> <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n  clusterIP: None\n  selector:\n    app: mysql\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-read\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n  selector:\n    app: mysql\n</code></pre> <p>\u7528\u6237\u6240\u6709\u5199\u8bf7\u6c42\uff0c\u5fc5\u987b\u4ee5 DNS \u8bb0\u5f55\u7684\u65b9\u5f0f\u76f4\u63a5\u8bbf\u95ee\u5230 Master \u8282\u70b9\uff0c\u4e5f\u5c31\u662f <code>mysql-0.mysql</code>\u8fd9\u6761 DNS \u8bb0\u5f55\u3002</p> <p>\u7528\u6237\u6240\u6709\u8bfb\u8bf7\u6c42\uff0c\u5fc5\u987b\u8bbf\u95ee\u81ea\u52a8\u5206\u914d\u7684 DNS \u8bb0\u5f55\u53ef\u4ee5\u88ab\u8f6c\u53d1\u5230\u4efb\u610f\u4e00\u4e2a <code>Master</code> \u6216 <code>Slave</code> \u8282\u70b9\u4e0a\uff0c\u4e5f\u5c31\u662f <code>mysql-read</code>\u8fd9\u6761 DNS \u8bb0\u5f55</p> <pre><code>kubectl apply -f 06-mysql-services.yaml\n\n$ kubectl get svc -n mysql\nNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE\nmysql        ClusterIP   None         &lt;none&gt;        3306/TCP   20s\nmysql-read   ClusterIP   10.0.0.63    &lt;none&gt;        3306/TCP   20s\n</code></pre>"},{"location":"chap_k8s/1Mysql_k8s/#statefulset-mysql","title":"\u4e03\u3001\u4f7f\u7528 StatefulSet \u642d\u5efa MySQL \u4e3b\u4ece\u96c6\u7fa4","text":"<p><code>07-mysql-statefulset.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  selector:\n    matchLabels:\n      app: mysql\n  serviceName: mysql\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: mysql\n    spec:\n      initContainers:\n      - name: init-mysql\n        image: mysql:5.7\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          # \u4ece Pod \u7684\u5e8f\u53f7\uff0c\u751f\u6210 server-id\n          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1\n          ordinal=${BASH_REMATCH[1]}\n          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf\n          # \u7531\u4e8e server-id \u4e0d\u80fd\u4e3a 0\uff0c\u56e0\u6b64\u7ed9 ID \u52a0 100 \u6765\u907f\u5f00\u5b83\n          echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf\n          # \u5982\u679c Pod \u7684\u5e8f\u53f7\u4e3a 0\uff0c\u8bf4\u660e\u5b83\u662f Master \u8282\u70b9\uff0c\u4ece ConfigMap \u91cc\u628a Master \u7684\u914d\u7f6e\u6587\u4ef6\u62f7\u8d1d\u5230 /mnt/conf.d \u76ee\u5f55\u4e0b\n          # \u5426\u5219\uff0c\u62f7\u8d1d ConfigMap \u91cc\u7684 Slave \u7684\u914d\u7f6e\u6587\u4ef6\n          if [[ ${ordinal} -eq 0 ]]; then\n            cp /mnt/config-map/master.cnf /mnt/conf.d\n          else\n            cp /mnt/config-map/slave.cnf /mnt/conf.d\n          fi\n        volumeMounts:\n        - name: conf\n          mountPath: /mnt/conf.d\n        - name: config-map\n          mountPath: /mnt/config-map\n      - name: clone-mysql\n        image: gcr.io/google-samples/xtrabackup:1.0\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          # \u62f7\u8d1d\u64cd\u4f5c\u53ea\u9700\u8981\u5728\u7b2c\u4e00\u6b21\u542f\u52a8\u65f6\u8fdb\u884c\uff0c\u6240\u4ee5\u6570\u636e\u5df2\u7ecf\u5b58\u5728\u5219\u8df3\u8fc7\n          [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0\n          # Master \u8282\u70b9\uff08\u5e8f\u53f7\u4e3a 0\uff09\u4e0d\u9700\u8981\u8fd9\u4e2a\u64cd\u4f5c\n          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1\n          ordinal=${BASH_REMATCH[1]}\n          [[ $ordinal == 0 ]] &amp;&amp; exit 0\n          # \u4f7f\u7528 ncat \u6307\u4ee4\uff0c\u8fdc\u7a0b\u5730\u4ece\u524d\u4e00\u4e2a\u8282\u70b9\u62f7\u8d1d\u6570\u636e\u5230\u672c\u5730\n          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql\n          # \u6267\u884c --prepare\uff0c\u8fd9\u6837\u62f7\u8d1d\u6765\u7684\u6570\u636e\u5c31\u53ef\u4ee5\u7528\u4f5c\u6062\u590d\u4e86\n          xtrabackup --prepare --target-dir=/var/lib/mysql\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n      containers:\n      - name: mysql\n        image: mysql:5.7\n        env:\n#        - name: MYSQL_ALLOW_EMPTY_PASSWORD\n#          value: \"1\"\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        ports:\n        - name: mysql\n          containerPort: 3306\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n        resources:\n          requests:\n            cpu: 500m\n            memory: 1Gi\n        livenessProbe:\n          exec:\n            command: [\"mysqladmin\", \"ping\", \"-uroot\", \"-p${MYSQL_ROOT_PASSWORD}\"]\n          initialDelaySeconds: 30\n          periodSeconds: 10\n          timeoutSeconds: 5\n        readinessProbe:\n          exec:\n            command: [\"mysqladmin\", \"ping\", \"-uroot\", \"-p${MYSQL_ROOT_PASSWORD}\"]\n          initialDelaySeconds: 5\n          periodSeconds: 2\n          timeoutSeconds: 1\n      - name: xtrabackup\n        image: gcr.io/google-samples/xtrabackup:1.0\n        ports:\n        - name: xtrabackup\n          containerPort: 3307\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          cd /var/lib/mysql\n          # \u4ece\u5907\u4efd\u4fe1\u606f\u6587\u4ef6\u91cc\u8bfb\u53d6 MASTER_LOG_FILE \u548c MASTER_LOG_POS \u8fd9 2 \u4e2a\u5b57\u6bb5\u7684\u503c\uff0c\u7528\u6765\u62fc\u88c5\u96c6\u7fa4\u521d\u59cb\u5316 SQL\n          if [[ -f xtrabackup_slave_info ]]; then\n            # \u5982\u679c xtrabackup_slave_info \u6587\u4ef6\u5b58\u5728\uff0c\u8bf4\u660e\u8fd9\u4e2a\u5907\u4efd\u6570\u636e\u6765\u81ea\u4e8e\u53e6\u4e00\u4e2a Slave \u8282\u70b9\n            # \u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0cXtraBackup \u5de5\u5177\u5728\u5907\u4efd\u7684\u65f6\u5019\uff0c\u5c31\u5df2\u7ecf\u5728\u8fd9\u4e2a\u6587\u4ef6\u91cc\u81ea\u52a8\u751f\u6210\u4e86 \"CHANGE MASTER TO\" SQL \u8bed\u53e5\n            # \u6240\u4ee5\uff0c\u53ea\u9700\u8981\u628a\u8fd9\u4e2a\u6587\u4ef6\u91cd\u547d\u540d\u4e3a change_master_to.sql.in\uff0c\u540e\u9762\u76f4\u63a5\u4f7f\u7528\u5373\u53ef\n            mv xtrabackup_slave_info change_master_to.sql.in\n            # \u6240\u4ee5\uff0c\u4e5f\u5c31\u7528\u4e0d\u7740 xtrabackup_binlog_info \u4e86\n            rm -f xtrabackup_binlog_info\n          elif [[ -f xtrabackup_binlog_info ]]; then\n            # \u5982\u679c\u53ea\u662f\u5b58\u5728 xtrabackup_binlog_info \u6587\u4ef6\uff0c\u8bf4\u660e\u5907\u4efd\u6765\u81ea\u4e8e Master \u8282\u70b9\uff0c\u5c31\u9700\u8981\u89e3\u6790\u8fd9\u4e2a\u5907\u4efd\u4fe1\u606f\u6587\u4ef6\uff0c\u8bfb\u53d6\u6240\u9700\u7684\u4e24\u4e2a\u5b57\u6bb5\u7684\u503c\n            [[ $(cat xtrabackup_binlog_info) =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1\n            rm xtrabackup_binlog_info\n            # \u628a\u4e24\u4e2a\u5b57\u6bb5\u7684\u503c\u62fc\u88c5\u6210 SQL\uff0c\u5199\u5165 change_master_to.sql.in \u6587\u4ef6\n            echo \"CHANGE MASTER TO MASTER_LOG_FILE='${BASH_REMATCH[1]}',\\\n                  MASTER_LOG_POS=${BASH_REMATCH[2]}\" &gt; change_master_to.sql.in\n          fi\n          # \u5982\u679c\u5b58\u5728 change_master_to.sql.in\uff0c\u5c31\u610f\u5473\u7740\u9700\u8981\u505a\u96c6\u7fa4\u521d\u59cb\u5316\u5de5\u4f5c\n          if [[ -f change_master_to.sql.in ]]; then\n            # \u4f46\u4e00\u5b9a\u8981\u5148\u7b49 MySQL \u5bb9\u5668\u542f\u52a8\u4e4b\u540e\u624d\u80fd\u8fdb\u884c\u4e0b\u4e00\u6b65\u8fde\u63a5 MySQL \u7684\u64cd\u4f5c\n            echo \"Waiting for mysqld to be ready\uff08accepting connections\uff09\"\n            until mysql -h 127.0.0.1 -uroot -p${MYSQL_ROOT_PASSWORD} -e \"SELECT 1\"; do sleep 1; done\n            echo \"Initializing replication from clone position\"\n            # \u5c06\u6587\u4ef6 change_master_to.sql.in \u6539\u4e2a\u540d\u5b57\n            # \u9632\u6b62\u8fd9\u4e2a Container \u91cd\u542f\u7684\u65f6\u5019\uff0c\u56e0\u4e3a\u53c8\u627e\u5230\u4e86 change_master_to.sql.in\uff0c\u4ece\u800c\u91cd\u590d\u6267\u884c\u4e00\u904d\u521d\u59cb\u5316\u6d41\u7a0b\n            mv change_master_to.sql.in change_master_to.sql.orig\n            # \u4f7f\u7528 change_master_to.sql.orig \u7684\u5185\u5bb9\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u62fc\u88c5\u7684 SQL\uff0c\u7ec4\u6210\u4e00\u4e2a\u5b8c\u6574\u7684\u521d\u59cb\u5316\u548c\u542f\u52a8 Slave \u7684 SQL \u8bed\u53e5\n            mysql -h 127.0.0.1 -uroot -p${MYSQL_ROOT_PASSWORD} &lt;&lt; EOF\n          $(&lt; change_master_to.sql.orig),\n            MASTER_HOST='mysql-0.mysql.mysql',\n            MASTER_USER='root',\n            MASTER_PASSWORD='${MYSQL_ROOT_PASSWORD}',\n            MASTER_CONNECT_RETRY=10;\n          START SLAVE;\n          EOF\n          fi\n          # \u4f7f\u7528 ncat \u76d1\u542c 3307 \u7aef\u53e3\u3002\n          # \u5b83\u7684\u4f5c\u7528\u662f\uff0c\u5728\u6536\u5230\u4f20\u8f93\u8bf7\u6c42\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u6267\u884c xtrabackup --backup \u547d\u4ee4\uff0c\u5907\u4efd MySQL \u7684\u6570\u636e\u5e76\u53d1\u9001\u7ed9\u8bf7\u6c42\u8005\n          exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \\\n            \"xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root --password=${MYSQL_ROOT_PASSWORD}\"\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n      volumes:\n      - name: conf\n        emptyDir: {}\n      - name: config-map\n        configMap:\n          name: mysql\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - \"ReadWriteOnce\"\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 3Gi\n</code></pre> <p>\u6574\u4f53\u7684<code>statefulset</code>\u6709\u4e24\u4e2a<code>replicas</code>\uff0c\u4e00\u4e2a<code>Master</code>, \u4e00\u4e2a<code>Slave</code>\uff0c\u7136\u540e\u4f7f\u7528<code>init-mysql</code> \u8fd9\u4e2a <code>initContainers</code> \u8fdb\u884c\u914d\u7f6e\u6587\u4ef6\u7684\u521d\u59cb\u5316\u3002</p> <p>\u63a5\u7740\u4f7f\u7528 <code>clone-mysql</code> \u8fd9\u4e2a <code>initContainers</code> \u8fdb\u884c\u6570\u636e\u7684\u4f20\u8f93\uff1b\u540c\u65f6\u4f7f\u7528 <code>xtrabackup</code> \u8fd9\u4e2a sidecar \u5bb9\u5668\u8fdb\u884cSQL\u521d\u59cb\u5316\u548c\u6570\u636e\u4f20\u8f93\u529f\u80fd</p> <p>\u521b\u5efa StatefulSet</p> <pre><code>kubectl apply -f 07-mysql-statefulset.yaml\n\n$ kubectl get po -n mysql\nNAME      READY   STATUS    RESTARTS   AGE\nmysql-0   2/2     Running   0          70s\nmysql-1   0/2     Pending   0          5s\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cStatefulSet \u542f\u52a8\u6210\u529f\u540e\uff0c\u4f1a\u6709\u4e24\u4e2aPod\u8fd0\u884c\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u5411\u8fd9\u4e2aMySQL\u96c6\u7fa4\u53d1\u8d77\u8bf7\u6c42\uff0c\u6267\u884c\u4e00\u4e9bSQL\u64cd\u4f5c\u6765\u9a8c\u8bc1\u5b83\u662f\u5426\u6b63\u5e38</p>"},{"location":"chap_k8s/1Mysql_k8s/#_2","title":"\u670d\u52a1\u9a8c\u8bc1","text":"<p>\u9a8c\u8bc1\u4e3b\u4ece\u72b6\u6001</p> <pre><code>kubectl -n mysql exec mysql-1 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'show slave status \\G'\"\n\n\nmysql: [Warning] Using a password on the command line interface can be insecure.\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: mysql-0.mysql.mysql\n                  Master_User: root\n                  Master_Port: 3306\n                Connect_Retry: 10\n              Master_Log_File: mysqllog.000003\n          Read_Master_Log_Pos: 154\n               Relay_Log_File: mysql-1-relay-bin.000002\n                Relay_Log_Pos: 319\n        Relay_Master_Log_File: mysqllog.000003\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: \n          Replicate_Ignore_DB: mysql\n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n      Replicate_Wild_Do_Table: \n  Replicate_Wild_Ignore_Table: \n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 154\n              Relay_Log_Space: 528\n              Until_Condition: None\n               Until_Log_File: \n                Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n              Master_SSL_Cert: \n            Master_SSL_Cipher: \n               Master_SSL_Key: \n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error: \n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n  Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 100\n                  Master_UUID: 1bad4d64-6290-11ea-8376-0242ac113802\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: 0\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates\n           Master_Retry_Count: 86400\n                  Master_Bind: \n      Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n            Executed_Gtid_Set: \n                Auto_Position: 0\n         Replicate_Rewrite_DB: \n                 Channel_Name: \n           Master_TLS_Version:\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u901a\u8fc7Master\u5bb9\u5668\u521b\u5efa\u6570\u636e\u5e93\u548c\u8868\u3001\u63d2\u5165\u6570\u636e\u5e93</p> <pre><code>\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'create database test\u2019\"\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;create table counter(c int);\u2019\"\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;insert into counter values(123)\u2019\"\n</code></pre> <p>\u7136\u540e\uff0c\u6211\u4eec\u89c2\u5bdfSlave\u8282\u70b9\u662f\u5426\u90fd\u540c\u6b65\u5230\u6570\u636e\u4e86</p> <pre><code>kubectl -n mysql exec mysql-1 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;select * from counter\u2019\"  \nc\n123\n</code></pre> <p>\u5f53\u770b\u5230\u8f93\u51fa\u7ed3\u679c\uff0c\u4e3b\u4ece\u540c\u6b65\u6b63\u5e38\u4e86</p>"},{"location":"chap_k8s/1Mysql_k8s/#_3","title":"\u6269\u5c55\u4ece\u8282\u70b9","text":"<p>\u5728\u6709\u4e86 StatefulSet \u4ee5\u540e\uff0c\u4f60\u5c31\u53ef\u4ee5\u50cf Deployment \u90a3\u6837\uff0c\u975e\u5e38\u65b9\u4fbf\u5730\u6269\u5c55\u8fd9\u4e2a MySQL \u96c6\u7fa4\uff0c\u6bd4\u5982</p> <pre><code>\nkubectl -n mysql scale statefulset mysql -\u2014replicas=3\n\n$ kubectl get po -n mysql\nNAME      READY   STATUS    RESTARTS   AGE\nmysql-0   2/2     Running   0          22m\nmysql-1   2/2     Running   0          22m\nmysql-2   2/2     Running   0          20s\n</code></pre> <p>\u8fd9\u65f6\u5019\uff0c\u4e00\u4e2a\u65b0\u7684mysql-2\u5c31\u521b\u5efa\u51fa\u6765\u4e86\uff0c\u6211\u4eec\u7ee7\u7eed\u9a8c\u8bc1\u65b0\u6269\u5bb9\u7684\u8282\u70b9\u662f\u5426\u90fd\u540c\u6b65\u5230\u4e3b\u8282\u70b9\u7684\u6570\u636e</p> <pre><code>kubectl -n mysql exec mysql-2 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;select * from counter\u2019\"  \nc\n123\n</code></pre> <p>\u5f53\u770b\u5230\u8f93\u51fa\u7ed3\u679c\uff0c\u4e3b\u4ece\u540c\u6b65\u6b63\u5e38\u4e86\u3002\u4e5f\u5c31\u662f\u8bf4\u4ece StatefulSet \u4e3a\u6211\u4eec\u65b0\u521b\u5efa\u7684 mysql-2 \u4e0a\uff0c\u540c\u6837\u53ef\u4ee5\u8bfb\u53d6\u5230\u4e4b\u524d\u63d2\u5165\u7684\u8bb0\u5f55\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u7684\u6570\u636e\u5907\u4efd\u548c\u6062\u590d\uff0c\u90fd\u662f\u6709\u6548\u7684\u3002</p>"},{"location":"chap_k8s/2mysql_Master_slave/","title":"2 \u5728K8s\u4e2d\u90e8\u7f72\u4e3b\u4ece\u7ed3\u6784\u7684MySQL\u670d\u52a1","text":""},{"location":"chap_k8s/2mysql_Master_slave/#01","title":"01 \u4ecb\u7ecd","text":"<p>RC\u3001Deployment\u3001DaemonSet\u90fd\u662f\u9762\u5411\u65e0\u72b6\u6001\u7684\u670d\u52a1\uff0c\u5b83\u4eec\u6240\u7ba1\u7406\u7684Pod\u7684IP\u3001\u540d\u5b57\u3001\u542f\u505c\u987a\u5e8f\u7b49\u90fd\u662f\u968f\u673a\u5206\u914d\u7684\uff0c\u800cStatefulSet\uff0c\u7ba1\u7406\u6240\u6709\u6709\u72b6\u6001\u7684\u670d\u52a1\u3002</p> <p>StatefulSet\u4e3a\u4e86\u89e3\u51b3\u6709\u72b6\u6001\u670d\u52a1\u7684\u95ee\u9898\uff0c\u5b83\u6240\u7ba1\u7406\u7684Pod\u62e5\u6709\u56fa\u5b9a\u7684Pod\u540d\u79f0\uff0c\u4e00\u5b9a\u7684\u542f\u505c\u987a\u5e8f\uff0c\u5728StatefulSet\u4e2d\uff0cPod\u540d\u5b57\u79f0\u4e3a\u7f51\u7edc\u6807\u8bc6(hostname)\uff0c\u8fd8\u5fc5\u987b\u8981\u7528\u5230\u5171\u4eab\u5b58\u50a8\u3002</p> <p>\u5728Deployment\u4e2d\uff0c\u4e0e\u4e4b\u5bf9\u5e94\u7684\u670d\u52a1\u662fservice\uff0c\u800c\u5728StatefulSet\u4e2d\u4e0e\u4e4b\u5bf9\u5e94\u7684headless service\u3002</p> <p>headless service\uff0c\u5373\u65e0\u5934\u670d\u52a1\uff0c\u4e0eservice\u7684\u533a\u522b\u5c31\u662f\u5b83\u6ca1\u6709Cluster IP\uff0c\u89e3\u6790\u5b83\u7684\u540d\u79f0\u65f6\u5c06\u8fd4\u56de\u8be5Headless Service\u5bf9\u5e94\u7684\u5168\u90e8Pod\u7684\u8282\u70b9\u5217\u8868\u3002</p> <p>\u9664\u6b64\u4e4b\u5916\uff0cStatefulSet\u5728Headless Service\u7684\u57fa\u7840\u4e0a\u53c8\u4e3aStatefulSet\u63a7\u5236\u7684\u6bcf\u4e2aPod\u526f\u672c\u521b\u5efa\u4e86\u4e00\u4e2aDNS\u57df\u540d\uff0c\u8fd9\u4e2a\u57df\u540d\u7684\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>(podname).(headless server name).namespace.svc.cluster.local\n</code></pre>"},{"location":"chap_k8s/2mysql_Master_slave/#02-mysql","title":"02 \u90e8\u7f72mysql","text":"<p>MySQL \u793a\u4f8b\u90e8\u7f72\u5305\u542b\u4e00\u4e2aConfigMap\u3001\u4e24\u4e2a\u5b58\u50a8\u6302\u8f7dpv\u548cpvc\u3001\u4e24\u4e2a Service \u4e0e\u4e00\u4e2a StatefulSet\u3002</p>"},{"location":"chap_k8s/2mysql_Master_slave/#configmap","title":"\u521b\u5efa\u4e00\u4e2aConfigMap","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u7684 YAML \u914d\u7f6e\u6587\u4ef6\u521b\u5efa ConfigMap \uff1a</p> <p><code>mysql-master-cnf.yaml</code></p> <pre><code>#master--my.cnf\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mysql-master-cnf\n  namespace: bc-cnp\ndata:\n  my.cnf: |-\n    [client]\n    default-character-set=utf8\n    [mysql]\n    default-character-set=utf8\n    [mysqld]\n    init_connect='SET collation_connection = utf8_unicode_ci'\n    init_connect='SET NAMES utf8'\n    character-set-server=utf8\n    collation-server=utf8_unicode_ci\n    skip-character-set-client-handshake\n    skip-name-resolve\n    server_id=1\n    log-bin=mysql-bin\n    read-only=1\n    replicate-ignore-db=mysql\n    replicate-ignore-db=sys\n    replicate-ignore-db=information_schema\n    replicate-ignore-db=performance_schema\n</code></pre> <p><code>mysql-slave-cnf.yaml</code></p> <pre><code>#slave--my.cnf\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mysql-slave-cnf\n  namespace: bc-cnp\ndata:\n  my.cnf: |-\n    [client]\n    default-character-set=utf8\n    [mysql]\n    default-character-set=utf8\n    [mysqld]\n    init_connect='SET collation_connection = utf8_unicode_ci'\n    init_connect='SET NAMES utf8'\n    character-set-server=utf8\n    collation-server=utf8_unicode_ci\n    skip-character-set-client-handshake\n    skip-name-resolve\n    server_id=2\n    log-bin=mysql-bin\n    read-only=0\n    replicate-ignore-db=mysql\n    replicate-ignore-db=sys\n    replicate-ignore-db=information_schema\n    replicate-ignore-db=performance_schema\n</code></pre> <pre><code>$ kubectl create ns bc-cnp\n\n$ kubectl apply -f mysql-master-cnf.yaml\n\n$ kubectl apply -f mysql-slave-cnf.yaml\n</code></pre> <p>\u8fd9\u4e2a ConfigMap \u63d0\u4f9b <code>my.cnf</code> \u8986\u76d6\u8bbe\u7f6e\uff0c\u53ef\u4ee5\u72ec\u7acb\u63a7\u5236 MySQL \u4e3b\u670d\u52a1\u5668\u914d\u7f6e\u3002</p> <p>ConfigMap \u672c\u8eab\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u4e4b\u5904\uff0c\u56e0\u800c\u4e5f\u4e0d\u4f1a\u51fa\u73b0\u4e0d\u540c\u90e8\u5206\u5e94\u7528\u4e8e\u4e0d\u540c\u7684 Pod \u7684\u60c5\u51b5\u3002</p> <p>\u6bcf\u4e2a Pod \u90fd\u4f1a\u5728\u521d\u59cb\u5316\u65f6\u57fa\u4e8e StatefulSet \u63a7\u5236\u5668\u63d0\u4f9b\u7684\u4fe1\u606f\u51b3\u5b9a\u8981\u67e5\u770b\u7684\u90e8\u5206\u3002</p> <p>slave\u4ece\u670d\u52a1\u5668\u914d\u7f6e\u548c\u4e3b\u670d\u52a1\u5668\u914d\u7f6e\u57fa\u672c\u76f8\u540c\uff0c\u9700\u8981\u4fee\u6539</p> <ul> <li><code>metadata.name= mysql-slave-cnf</code></li> <li><code>server_id=2</code></li> <li><code>read-only=0</code></li> </ul> <p>\u83b7\u53d6<code>mysql-master-0</code>\u548c<code>mysql-slave-0</code>\u7684ConfigMap \uff1a</p> <pre><code>kubectl get cm -nbc-cnp\n\nNAME               DATA   AGE\nkube-root-ca.crt   1      2m24s\nmysql-master-cnf   1      115s\nmysql-slave-cnf    1      55s\n</code></pre>"},{"location":"chap_k8s/2mysql_Master_slave/#mysql-root-secret","title":"\u521b\u5efa\u4e00\u4e2aMYSQL ROOT Secret","text":"<p><code>mysql-secret.yaml</code></p> <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: mysql-secret\n  namespace: bc-cnp\n  labels:\n    app: mysql\ntype: Opaque\ndata:\n  MYSQL_ROOT_PASSWORD: MTIzNDU2 # echo -n \"123456\" | base64\n</code></pre> <pre><code>$ kubectl apply -f mysql-secret.yaml\n</code></pre>"},{"location":"chap_k8s/2mysql_Master_slave/#pvpvc","title":"\u521b\u5efapv\u548cpvc\uff0c\u5199\u5165\u7a33\u5b9a\u5b58\u50a8","text":"<p>\u4f7f\u7528\u4ee5\u4e0b YAML \u914d\u7f6e\u6587\u4ef6\u521b\u5efa\u670d\u52a1\uff1a</p> <p><code>master-pvc-pv.yaml</code></p> <pre><code>---\n#master--pv\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: mysql-pv-master\nspec:\n  accessModes:\n    - ReadWriteOnce\n  capacity:\n    storage: 1Gi\n  local:\n    path: /Users/i515190/k8s_test/mysql\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - docker-desktop \n---\n#master--pvc\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pvc-master\n  namespace: bc-cnp\nspec:\n  accessModes:\n    - ReadWriteOnce\n  # storageClassName: hostpath\n  resources:\n    requests:\n      storage: 1Gi\n  # volumeName: mysql-pv-master\n</code></pre> <p><code>slave-pvc-pv.yaml</code></p> <pre><code>---\n#slave--pv\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: mysql-pv-master\nspec:\n  accessModes:\n    - ReadWriteOnce\n  capacity:\n    storage: 1Gi\n  local:\n    path: /Users/i515190/k8s_test/mysql\n  nodeAffinity:\n    required:\n      nodeSelectorTerms:\n      - matchExpressions:\n        - key: kubernetes.io/hostname\n          operator: In\n          values:\n          - docker-desktop \n---\n#master--pvc\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pvc-master\n  namespace: bc-cnp\nspec:\n  accessModes:\n    - ReadWriteOnce\n  # storageClassName: hostpath\n  resources:\n    requests:\n      storage: 1Gi\n  # volumeName: mysql-pv-master\n</code></pre> <p>slave\u91c7\u7528\u540c\u6837\u7684\u65b9\u5f0f\u521b\u5efapv\u53capvc\uff0c\u53ea\u540d\u5b57\u4fee\u6539\u4e3aslave\u5373\u53ef\u3002</p> <p>\u83b7\u53d6master\u548cslave\u7684PersistentVolumeClaims\uff1a</p> <pre><code>$ kubectl apply -f master-pvc-pv.yaml \n\n$ kubectl apply -f slave-pvc-pv.yaml \n\nkubectl get pvc -nbc-cnp\n</code></pre> <p>\u4e3aStatefulSet \u63a7\u5236\u5668\u521b\u5efa\u4e86\u4e24\u4e2a PersistentVolumeClaims\uff0c \u7ed1\u5b9a\u5230\u4e24\u4e2a PersistentVolumes\u3002</p> <p>Mysql \u670d\u52a1\u5668\u9ed8\u8ba4\u4f1a\u52a0\u8f7d\u4f4d\u4e8e <code>/var/lib/mysql-files</code> \u7684\u6587\u4ef6\u3002</p> <p>StatefulSet spec \u4e2d\u7684 volumeMounts \u5b57\u6bb5\u4fdd\u8bc1\u4e86<code>/var/lib/mysql-files</code> \u6587\u4ef6\u5939\u7531\u4e00\u4e2a PersistentVolume \u5377\u652f\u6301\u3002</p>"},{"location":"chap_k8s/2mysql_Master_slave/#service","title":"\u521b\u5efa Service","text":"<p>\u4f7f\u7528\u4ee5\u4e0b YAML \u914d\u7f6e\u6587\u4ef6\u521b\u5efa\u670d\u52a1\uff1a</p> <p><code>mysql-master-services.yaml</code></p> <pre><code>#master--headless service\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: bc-cnp\n  labels:\n    app: mysql-master\n  annotations:\n    kubesphere.io/serviceType: statefulservice\n    kubesphere.io/alias-name: mysql-master\n  name: mysql-master\nspec:\n  sessionAffinity: ClientIP\n  selector:\n    app: mysql-master\n  ports:\n    - name: tcp-3306\n      protocol: TCP\n      port: 3306\n      targetPort: 3306\n    - name: tcp-33060\n      protocol: TCP\n      port: 33060\n      targetPort: 33060\n  clusterIP: None\n  sessionAffinityConfig:\n    clientIP:\n      timeoutSeconds: 10800\n\n---\n#master--nodePort service\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-master-front\n  labels:\n    app: mysql-master\n  namespace: bc-cnp\nspec:\n  selector:\n    app: mysql-master\n  type: NodePort\n  ports:\n    - name: ''\n      port: 3306\n      protocol: TCP\n      targetPort: 3306\n      nodePort: 30001  \n  sessionAffinity: None\n</code></pre> <p><code>mysql-slave-services.yaml</code></p> <pre><code>#master--headless service\napiVersion: v1\nkind: Service\nmetadata:\n  namespace: bc-cnp\n  labels:\n    app: mysql-slave\n  annotations:\n    kubesphere.io/serviceType: statefulservice\n    kubesphere.io/alias-name: mysql-slave\n  name: mysql-slave\nspec:\n  sessionAffinity: ClientIP\n  selector:\n    app: mysql-slave\n  ports:\n    - name: tcp-3306\n      protocol: TCP\n      port: 3306\n      targetPort: 3306\n    - name: tcp-33060\n      protocol: TCP\n      port: 33060\n      targetPort: 33060\n  clusterIP: None\n  sessionAffinityConfig:\n    clientIP:\n      timeoutSeconds: 10800\n\n---\n#master--nodePort service\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-slave-front\n  labels:\n    app: mysql-slave\n  namespace: bc-cnp\nspec:\n  selector:\n    app: mysql-slave\n  type: NodePort\n  ports:\n    - name: ''\n      port: 3306\n      protocol: TCP\n      targetPort: 3306\n      nodePort: 30002  \n  sessionAffinity: None\n</code></pre> <p>\u6267\u884cYAML\uff1a</p> <p>slave\u540c\u6837\u6267\u884c\u7c7b\u4f3cyaml\uff0c\u540d\u5b57\u9700\u8981\u4fee\u6539\u4e3amysql-slave\u76f8\u5173\uff0c\u66b4\u9732nodeport\u6539\u4e3a\uff1a30002\u3002</p> <p>\u8f93\u51fa\u7c7b\u4f3c\u4e8e\uff1a</p> <pre><code>$ kubectl apply -f mysql-master-services.yaml \n\n$ kubectl apply -f mysql-slave-services.yaml \n\n$ kubectl get svc -n bc-cnp \nNAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)              AGE\nmysql-master         ClusterIP   None             &lt;none&gt;        3306/TCP,33060/TCP   69s\nmysql-master-front   NodePort    10.101.3.70      &lt;none&gt;        3306:30001/TCP       69s\nmysql-slave          ClusterIP   None             &lt;none&gt;        3306/TCP,33060/TCP   62s\nmysql-slave-front    NodePort    10.107.251.175   &lt;none&gt;        3306:30002/TCP       62s\n</code></pre> <p>headless service \u7684 CNAME \u6307\u5411 SRV \u8bb0\u5f55\uff08\u8bb0\u5f55\u6bcf\u4e2a Running \u548c Ready \u72b6\u6001\u7684 Pod\uff09\u3002SRV \u8bb0\u5f55\u6307\u5411\u4e00\u4e2a\u5305\u542b Pod IP \u5730\u5740\u7684\u8bb0\u5f55\u8868\u9879\u3002</p> <p>headless service\u7ed9 StatefulSet \u63a7\u5236\u5668 \u4e3a\u96c6\u5408\u4e2d\u6bcf\u4e2a Pod \u521b\u5efa\u7684 DNS \u6761\u76ee\u63d0\u4f9b\u4e86\u4e00\u4e2a\u5bbf\u4e3b\u3002</p> <p>\u56e0\u4e3a\u65e0\u5934\u670d\u52a1\u540d\u4e3a mysql-master\uff0c\u6240\u4ee5\u53ef\u4ee5\u901a\u8fc7\u5728\u540c\u4e00 Kubernetes \u96c6\u7fa4\u548c\u547d\u540d\u7a7a\u95f4\u4e2d\u7684\u4efb\u4f55\u5176\u4ed6 Pod \u5185\u89e3\u6790 <code>&lt;Pod \u540d\u79f0&gt;.mysql-master</code> \u6765\u8bbf\u95ee Pod\u3002</p> <p>mysql-master-front\u662f\u4e00\u79cd\u5e38\u89c4 Service\uff0c\u5177\u6709\u5176\u81ea\u5df1\u7684\u96c6\u7fa4 IP\u3002\u8be5\u96c6\u7fa4 IP \u5728\u62a5\u544a\u5c31\u7eea\u7684\u6240\u6709 MySQL Pod \u4e4b\u95f4\u5206\u914d\u8fde\u63a5\u3002\u53ef\u80fd\u7684\u7aef\u70b9\u96c6\u5408\u5305\u62ec MySQL \u4e3b\u8282\u70b9\u548c\u4ece\u8282\u70b9\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u53ea\u6709\u8bfb\u67e5\u8be2\u624d\u80fd\u4f7f\u7528\u8d1f\u8f7d\u5e73\u8861\u7684\u5ba2\u6237\u7aef Service\u3002\u56e0\u4e3a\u53ea\u6709\u4e00\u4e2a MySQL \u4e3b\u670d\u52a1\u5668\uff0c\u6240\u4ee5\u5ba2\u6237\u7aef\u5e94\u76f4\u63a5\u8fde\u63a5\u5230 MySQL \u4e3b\u670d\u52a1\u5668 Pod \uff08\u901a\u8fc7\u5176\u5728headless service \u4e2d\u7684 DNS \u6761\u76ee\uff09\u4ee5\u6267\u884c\u5199\u5165\u64cd\u4f5c</p>"},{"location":"chap_k8s/2mysql_Master_slave/#statefulset","title":"\u521b\u5efa StatefulSet","text":"<p>\u6700\u540e\uff0c\u4f7f\u7528\u4ee5\u4e0b YAML \u914d\u7f6e\u6587\u4ef6\u521b\u5efa StatefulSet\uff1a</p> <p><code>mysql-master-statefulset.yaml</code></p> <pre><code>#master--statefulset\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  namespace: bc-cnp\n  labels:\n    app: mysql-master\n  name: mysql-master\n  annotations:\n    kubesphere.io/alias-name: mysql-master\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: mysql-master\n  template:\n    metadata:\n      labels:\n        app: mysql-master\n    spec:\n      containers:\n        - name: master-container\n         # type: worker\n          imagePullPolicy: IfNotPresent\n          resources:\n            requests:\n              cpu: '1'\n              memory: 1Gi\n            limits:\n              cpu: '1'\n              memory: 1Gi\n          image: mysql:8.0.18\n          env:\n            - name: MYSQL_ROOT_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: mysql-secret\n                  key: MYSQL_ROOT_PASSWORD\n          volumeMounts:\n            - name: master-cnf-volume\n              readOnly: false\n              mountPath: /etc/mysql\n            - name: master-data-volume\n              readOnly: false\n              mountPath: /var/lib/mysql-files\n      serviceAccount: default\n      # affinity:\n      #   podAntiAffinity:\n      #     preferredDuringSchedulingIgnoredDuringExecution:\n      #       - weight: 100\n      #         podAffinityTerm:\n      #           labelSelector:\n      #             matchLabels:\n      #               app: mysql-master\n      #           topologyKey: kubernetes.io/hostname\n      volumes:\n        - name: master-cnf-volume\n          configMap:\n            name: mysql-master-cnf\n            items:\n              - key: my.cnf\n                path: my.cnf\n        - name: master-data-volume\n          persistentVolumeClaim:\n            claimName: mysql-pvc-master\n  serviceName: mysql-master\n</code></pre> <p><code>mysql-slave-statefulset.yaml</code></p> <pre><code>#slave--statefulset\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  namespace: bc-cnp\n  labels:\n    app: mysql-slave\n  name: mysql-slave\n  annotations:\n    kubesphere.io/alias-name: mysql slave\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: mysql-slave\n  template:\n    metadata:\n      labels:\n        app: mysql-slave\n    spec:\n      containers:\n        - name: slave-container\n         # type: worker\n          imagePullPolicy: IfNotPresent\n          resources:\n            requests:\n              cpu: '1'\n              memory: 1Gi\n            limits:\n              cpu: '1'\n              memory: 1Gi\n          image: mysql:8.0.18\n          env:\n            - name: MYSQL_ROOT_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  name: mysql-secret\n                  key: MYSQL_ROOT_PASSWORD\n          volumeMounts:\n            - name: slave-cnf-volume\n              readOnly: false\n              mountPath: /etc/mysql\n            - name: slave-data-volume\n              readOnly: false\n              mountPath: /var/lib/mysql-files\n      serviceAccount: default\n      # affinity:\n      #   podAntiAffinity:\n      #     preferredDuringSchedulingIgnoredDuringExecution:\n      #       - weight: 100\n      #         podAffinityTerm:\n      #           labelSelector:\n      #             matchLabels:\n      #               app: mysql-slave\n      #           topologyKey: kubernetes.io/hostname\n      volumes:\n        - name: slave-cnf-volume\n          configMap:\n            name: mysql-slave-cnf\n            items:\n              - key: my.cnf\n                path: my.cnf\n        - name: slave-data-volume\n          persistentVolumeClaim:\n            claimName: mysql-pvc-slave\n  serviceName: mysql-slave\n</code></pre> <p>\u901a\u8fc7\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u542f\u52a8\u8fdb\u5ea6\uff1a</p> <p>\u53ef\u4ee5\u770b\u5230\u6240\u6709 2 \u4e2a Pod \u8fdb\u5165 Running \u72b6\u6001\uff1a</p> <pre><code>$ kubectl apply -f mysql-master-statefulset.yaml\nstatefulset.apps/mysql-master created\n$ kubectl apply -f mysql-slave-statefulset.yaml \nstatefulset.apps/mysql-slave created\n\n\n$ kubectl get pods -n bc-cnp \nNAME             READY   STATUS    RESTARTS   AGE\nmysql-master-0   1/1     Running   0          67s\nmysql-slave-0    1/1     Running   0          27s\n</code></pre> <p>StatefulSet \u4e2d\u7684\u6bcf\u4e2a Pod \u62e5\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u987a\u5e8f\u7d22\u5f15\u548c\u7a33\u5b9a\u7684\u7f51\u7edc\u8eab\u4efd\u6807\u8bc6\u3002</p> <p>\u8fd9\u4e2a\u6807\u5fd7\u57fa\u4e8e StatefulSet \u63a7\u5236\u5668\u5206\u914d\u7ed9\u6bcf\u4e2a Pod \u7684\u552f\u4e00\u987a\u5e8f\u7d22\u5f15\u3002Pod \u540d\u79f0\u7684\u683c\u5f0f\u4e3a <code>&lt;statefulset \u540d\u79f0&gt;-&lt;\u5e8f\u53f7\u7d22\u5f15&gt;</code>\u3002</p>"},{"location":"chap_k8s/2mysql_Master_slave/#03","title":"03 \u4e3b\u4ece\u540c\u6b65","text":"<p>\u8fdb\u5165mysql-master\u5bb9\u5668\u5185\u90e8</p> <pre><code>$ kubectl exec -it mysql-master-0 sh -n bc-cnp \nkubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.\n\n# 1.\u8fdb\u5165mysql\u5185\u90e8\n$ kubectl exec -it mysql-master-0 sh -n bc-cnp \nkubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.\n# mysql -uroot -p123456\n\n#\u5207\u6362\u5230 mysql DB\nmysql&gt; USE mysql;   \n\nDatabase changed\n\n# \u67e5\u770broot\u7528\u6237\u662f\u5426\u5177\u5907\u8fdc\u7a0b\u8bbf\u95ee\u6743\u9650\nmysql&gt; select Host,User,authentication_string,password_expired,password_last_changed from user;\n+-----------+------------------+------------------------------------------------------------------------+------------------+-----------------------+\n| Host      | User             | authentication_string                                                  | password_expired | password_last_changed |\n+-----------+------------------+------------------------------------------------------------------------+------------------+-----------------------+\n| %         | root             | $A$005$|`K{0M=_,;/x'-cRV#kTHWatUJJ7.ERa9WgkADdVtfvb4OzWkfa1qKjMwl/f1 | N                | 2023-03-12 06:15:14   |\n| localhost | mysql.infoschema | $A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED | N                | 2023-03-12 06:15:08   |\n| localhost | mysql.session    | $A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED | N                | 2023-03-12 06:15:08   |\n| localhost | mysql.sys        | $A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED | N                | 2023-03-12 06:15:08   |\n| localhost | root             | $A$005$\n                                        gb.,#;t)4ZPy+!IKDjAJA9Yh1nOzdQ5mRnBRy5srJq.M6iZ0KNxGaX9P1 | N                | 2023-03-12 06:15:14   |\n+-----------+------------------+------------------------------------------------------------------------+------------------+-----------------------+\n5 rows in set (0.00 sec)\n\n# 2.\u6388\u6743 root\u53ef\u4ee5\u8fdc\u7a0b\u8bbf\u95ee\uff08\u4e3b\u4ece\u65e0\u5173\uff0c\u5982root\u6ca1\u6709\u8bbf\u95ee\u6743\u9650\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u65b9\u4fbf\u6211\u4eec\u8fdc\u7a0b\u8fde\u63a5MySQL\uff09\n\nmysql&gt; grant all privileges on *.* to 'root'@'%';\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; flush privileges;\nQuery OK, 0 rows affected (0.00 sec)\n\n# 3.\u6dfb\u52a0\u7528\u6765\u540c\u6b65\u7684\u7528\u6237\nCREATE USER 'repl'@'%' IDENTIFIED BY 'Passw0rd';\nGRANT REPLICATION SLAVE ON *.* to 'repl'@'%';\n\n# 4.\u67e5\u770bmaster\u72b6\u6001\nmysql&gt; show master status\\G;\n*************************** 1. row ***************************\n             File: mysql-bin.000003\n         Position: 1095\n     Binlog_Do_DB: \n Binlog_Ignore_DB: \nExecuted_Gtid_Set: \n1 row in set (0.00 sec)\n</code></pre>"},{"location":"chap_k8s/2mysql_Master_slave/#mysql-slave","title":"\u7136\u540e\u8fdb\u5165\u5230mysql-slave\u5185\u90e8","text":"<pre><code>$ kubectl exec -it mysql-slave-0 sh -n bc-cnp \nkubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.\n\n# mysql -uroot -p123456     \nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor.  Commands end with ; or \\g.\nYour MySQL connection id is 8\nServer version: 8.0.18 MySQL Community Server - GPL\n\nmysql&gt; \n\nchange master to master_host='mysql-master.bc-cnp.svc.cluster.local',master_user='repl',master_password='Passw0rd',master_log_file='mysql_bin.000003',master_log_pos=0;\n\n# \u542f\u52a8\u4ece\u5e93\u540c\u6b65\nstart slave;\n# \u67e5\u770b\u4ece\u4ece\u5e93\u72b6\u6001\nshow slave status\\G;\n</code></pre> <p><code>mysql -h mysql-master.bc-cnp.svc.cluster.local  -urepl -pPassw0rd</code></p> <p>\u53ea\u6709\u5f53\u4ee5\u4e0b\u4e24\u9879\u90fd\u662fyes\uff0c\u624d\u610f\u5473\u7740\u540c\u6b65\u6210\u529f\u3002</p> <pre><code>mysql&gt; show slave status\\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: mysql-master.bc-cnp.svc.cluster.local\n                  Master_User: repl\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000003\n          Read_Master_Log_Pos: 1095\n               Relay_Log_File: mysql-slave-0-relay-bin.000005\n                Relay_Log_Pos: 1309\n        Relay_Master_Log_File: mysql-bin.000003\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB: \n          Replicate_Ignore_DB: mysql,sys,information_schema,performance_schema\n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n</code></pre> <p>\u5982\u679c\u540c\u6b65\u4e0d\u6210\u529f\uff0c\u5c1d\u8bd5\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u518d\u6b21\u67e5\u770b\u3002</p> <pre><code>top slave;\nreset slave;\nstart slave;\n</code></pre>"},{"location":"chap_k8s/2mysql_Master_slave/#04","title":"04 \u7ed3\u679c\u9a8c\u8bc1","text":"<p>\u6700\u7ec8\u9a8c\u8bc1\u7ed3\u679c\uff0c\u5728master mysql\u521b\u5efa\u4e00\u4e2adatabase\u53catable\uff0c\u63d2\u5165\u6570\u636e\uff0c\u5728slave\u4e2d\u4f9d\u7136\u80fd\u591f\u67e5\u770b\u76f8\u5173\u6570\u636e\uff0c\u786e\u8ba4\u4e3b\u4ece\u540c\u6b65\u6210\u529f</p> <p>\u8fdb\u5165\u4e3b\u7684mysql-master\u5bb9\u5668\u5185\u90e8\uff0c\u6267\u884c\u521b\u5efa\u64cd\u4f5c\uff0c\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl exec -it mysql-master-0 sh -n bc-cnp \nkubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.\n# mysql -uroot -p123456   \n\nmysql&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| sys                |\n+--------------------+\n4 rows in set (0.00 sec)\n\ncreate database repl_test;\nuse repl_test;\n\ncreate table student(Sno int, name varchar(10));\ninsert into student(Sno, name) values (20230312, \"ubsjx\");\nshow tables;\n\nselect * from student;\n\nmysql&gt; create database repl_test;\nQuery OK, 1 row affected (0.01 sec)\n\nmysql&gt; use repl_test;\nDatabase changed\nmysql&gt; create table student(Sno int, name varchar(10));\nQuery OK, 0 rows affected (0.02 sec)\n\nmysql&gt; insert into student(Sno, name) values (20230312, \"ubsjx\");\nQuery OK, 1 row affected (0.01 sec)\n\nmysql&gt; show tables;\n+---------------------+\n| Tables_in_repl_test |\n+---------------------+\n| student             |\n+---------------------+\n1 row in set (0.00 sec)\n\nmysql&gt; select * from student;\n+----------+-------+\n| Sno      | name  |\n+----------+-------+\n| 20230312 | ubsjx |\n+----------+-------+\n1 row in set (0.01 sec)\n</code></pre> <p>\u8fdb\u5165\u4ece\u7684mysql-slave\u5bb9\u5668\u5185\u90e8\uff0c\u6267\u884c\u521b\u5efa\u64cd\u4f5c\uff0c\u5982\u4e0b\uff1a</p> <pre><code>$ kubectl exec -it mysql-slave-0 sh -n bc-cnp \nkubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.\n# mysql -uroot -p123456   \n\nmysql&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| repl_test          |\n| sys                |\n+--------------------+\n5 rows in set (0.00 sec)\n\nmysql&gt; use repl_test;\nReading table information for completion of table and column names\nYou can turn off this feature to get a quicker startup with -A\n\nDatabase changed\nmysql&gt; show tables;\n+---------------------+\n| Tables_in_repl_test |\n+---------------------+\n| student             |\n+---------------------+\n1 row in set (0.01 sec)\n\n\nmysql&gt; select * from student;\n+----------+-------+\n| Sno      | name  |\n+----------+-------+\n| 20230312 | ubsjx |\n+----------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u81f3\u6b64\uff0c\u786e\u8ba4\u4ece\u5e93\u4e2d\u5df2\u6709\u4e3b\u5e93\u4e2d\u6570\u636e\uff0c\u540c\u6b65\u6210\u529f\u3002</p>"},{"location":"chap_k8s/2mysql_Master_slave/#05","title":"05 \u603b\u7ed3","text":"<p>StatefulSet \u4e2d\u6bcf\u4e2a Pod \u90fd\u62e5\u6709\u4e00\u4e2a\u57fa\u4e8e\u5176\u987a\u5e8f\u7d22\u5f15\u7684\u7a33\u5b9a\u7684\u4e3b\u673a\u540d\uff0c\u5982\u679cpod\u53d1\u751f\u6545\u969c\uff0cStatefulSet \u91cd\u542f\u4ed6\u4eec\uff0cPod \u7684\u5e8f\u53f7\u3001\u4e3b\u673a\u540d\u3001SRV \u6761\u76ee\u548c\u8bb0\u5f55\u540d\u79f0\u6ca1\u6709\u6539\u53d8\uff0c\u4f46\u548c Pod \u76f8\u5173\u8054\u7684 IP \u5730\u5740\u53ef\u80fd\u53d1\u751f\u4e86\u6539\u53d8\u3002\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u4e0d\u8981\u5728\u5176\u4ed6\u5e94\u7528\u4e2d\u4f7f\u7528 StatefulSet \u4e2d Pod \u7684 IP \u5730\u5740\u8fdb\u884c\u8fde\u63a5\uff0c\u8fd9\u70b9\u5f88\u91cd\u8981\u3002</p> <p>StatefulSet \u7684\u6d3b\u52a8\u6210\u5458\u662f\u548c CNAME \u76f8\u5173\u8054\u7684 SRV \u8bb0\u5f55\uff0c\u5176\u4e2d\u53ea\u4f1a\u5305\u542b StatefulSet \u4e2d\u5904\u4e8e Running \u548c Ready \u72b6\u6001\u7684 Pod\u3002</p> <p>\u5982\u679c\u6211\u4eec\u7684\u5e94\u7528\u5df2\u7ecf\u5b9e\u73b0\u4e86\u7528\u4e8e\u6d4b\u8bd5\u662f\u5426\u5df2\u5b58\u6d3b\uff08liveness\uff09\u5e76\u5c31\u7eea\uff08readiness\uff09\u7684\u8fde\u63a5\u903b\u8f91\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 Pod \u7684 SRV \u8bb0\u5f55\uff08mysql-master.default.svc.cluster.local\uff09\u3002\u5e76\u4e14\u5f53\u91cc\u9762\u7684 Pod \u7684\u72b6\u6001\u53d8\u4e3a Running \u548c Ready \u65f6\uff0c\u6211\u4eec\u7684\u5e94\u7528\u5c31\u80fd\u591f\u53d1\u73b0\u5404\u4e2apod\u7684\u5730\u5740\u3002</p> <p>\u867d\u7136 mysql-master-0 \u548c mysql-slave-0 \u6709\u65f6\u5019\u4f1a\u88ab\u91cd\u65b0\u8c03\u5ea6\uff0c\u4f46\u5b83\u4eec\u4ecd\u7136\u7ee7\u7eed\u76d1\u542c\u5404\u81ea\u7684\u4e3b\u673a\u540d\uff0c\u56e0\u4e3a\u548c\u5b83\u4eec\u7684 PersistentVolumeClaim \u76f8\u5173\u8054\u7684 PersistentVolume \u5377\u88ab\u91cd\u65b0\u6302\u8f7d\u5230\u4e86\u5404\u81ea\u7684 volumeMount \u4e0a\u3002\u4e0d\u7ba1mysql-master-0 \u548c mysql-slave-0 \u88ab\u8c03\u5ea6\u5230\u4e86\u54ea\u4e2a\u8282\u70b9\u4e0a\uff0c\u5b83\u4eec\u7684 PersistentVolume \u5377\u5c06\u4f1a\u88ab\u6302\u8f7d\u5230\u5408\u9002\u7684\u6302\u8f7d\u70b9\u4e0a\u3002</p> <p>\u81f3\u6b64\uff0c\u4ee5\u4e0a\u5206\u4eab\u53ea\u662f\u5176\u4e2d\u7684\u4e00\u79cd\u4e3b\u4ece\u65b9\u5f0f\u5bb9\u5668\u5316\u90e8\u7f72\uff0c\u8fd8\u6709\u5176\u4ed6\u7684\u65b9\u6848\uff0c\u540e\u9762\u4e5f\u4f1a\u9646\u7eed\u7684\u5206\u4eab\uff0c\u5e0c\u671b\u5927\u5bb6\u6301\u7eed\u7684\u5173\u6ce8\u3002</p>"},{"location":"db_ops/10db_logs/","title":"\u7b2c\u5341\u8282 MySQL \u65e5\u5fd7\u7ba1\u7406","text":""},{"location":"db_ops/10db_logs/#1mysql","title":"1\u3001MySQL\u9519\u8bef\u65e5\u5fd7","text":""},{"location":"db_ops/10db_logs/#1-1","title":"1-1\u3001\u9519\u8bef\u65e5\u5fd7\u4f5c\u7528","text":"<p>\u8bb0\u5f55MySQL\u542f\u52a8\u53ca\u5de5\u4f5c\u8fc7\u7a0b\u4e2d\uff0c\u72b6\u6001\u3001\u62a5\u9519\u3001\u8b66\u544a\u3002</p>"},{"location":"db_ops/10db_logs/#1-2","title":"1-2\u3001\u8bbe\u7f6e\u9519\u8bef\u65e5\u5fd7","text":"<p>1)\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u91cd\u542fMySQL</p> <p>\u914d\u7f6e\u9519\u8bef\u65e5\u5fd7</p> <pre><code>$ vim /etc/my.cnf\nlog_error=/data/3306/data/mysql.log #\u8fd9\u91cc\u7684\u8def\u5f84\u548c\u6587\u4ef6\u540d\u79f0\u53ef\u4ee5\u968f\u4fbf\u5b9a\u4e49\n</code></pre> <p>\u91cd\u542fMySQL\u751f\u6548</p> <pre><code>systemctl restart mysqld\n</code></pre> <p>2)\u67e5\u770b\u9519\u8bef\u65e5\u5fd7</p> <pre><code>mysql&gt; select @@log_error;\n+---------------------------+\n| @@log_error |\n+---------------------------+\n| /data/3306/data/mysql.log |\n+---------------------------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u6ce8\u610f\uff1a\u67e5\u770b\u9519\u8bef\u65e5\u5fd7\u5173\u6ce8[ERROR]\u7684\u4e0a\u4e0b\u6587.</p>"},{"location":"db_ops/10db_logs/#2mysql","title":"2\u3001MySQL \u4e8c\u8fdb\u5236\u65e5\u5fd7","text":""},{"location":"db_ops/10db_logs/#2-1","title":"2-1\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4f5c\u7528","text":"<p>\u6570\u636e\u6062\u590d\u5fc5\u5907\u7684\u65e5\u5fd7\u3002</p> <p>\u4e3b\u4ece\u590d\u5236\u4f9d\u8d56\u7684\u65e5\u5fd7\u3002</p>"},{"location":"db_ops/10db_logs/#2-2mysql","title":"2-2\u3001MySQL \u4e8c\u8fdb\u5236\u65e5\u5fd7\u8bbe\u7f6e","text":"<p>1)\u4fee\u6539\u914d\u7f6e\u6587\u4ef6</p> <pre><code># vim /etc/my.cnf\nserver_id=6\nlog_bin=/data/3306/binlog/mysql-bin\n</code></pre> <p>\u914d\u7f6e\u8bf4\u660e</p> <ul> <li><code>server_id</code> \u662f5.7\u4e4b\u540e\u5f00\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5fc5\u52a0\u7684\u53c2\u6570</li> <li><code>log_bin</code>= \u6253\u5f00\u4e8c\u8fdb\u5236\u529f\u80fd</li> <li><code>/data/3306/binlog/</code> \u6307\u5b9a\u5b58\u653e\u8def\u5f84</li> <li><code>mysql-bin</code> \u6587\u4ef6\u540d\u524d\u7f00</li> </ul> <p>2)\u521b\u5efa\u76ee\u5f55\u5e76\u6388\u6743</p> <pre><code># mkdir -p /data/3306/binlog/\n# chown -R mysql.mysql /data/3306/*\n</code></pre> <p>3)\u91cd\u542f\u6570\u636e\u5e93</p> <pre><code># systemctl restart mysqld\n# ll binlog/\ntotal 8\n-rw-r----- 1 mysql mysql 768 Aug 14 20:02 mysql-bin.000001\n-rw-r----- 1 mysql mysql 35 Aug 14 18:18 mysql-bin.index\n</code></pre> <p>\u914d\u7f6e\u8bf4\u660e </p> <ul> <li>mysql-bin \u662f\u5728\u914d\u7f6e\u6587\u4ef6\u914d\u7f6e\u7684\u524d\u7f00</li> <li>000001 MySQL\u6bcf\u6b21\u91cd\u542f\uff0c\u91cd\u65b0\u751f\u6210\u65b0\u7684</li> </ul>"},{"location":"db_ops/10db_logs/#3","title":"3\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5185\u5bb9","text":"<p>\u9664\u4e86\u67e5\u8be2\u7c7b\u7684\u8bed\u53e5\uff0c\u90fd\u4f1a\u8bb0\u5f55\uff0c\u5373\u6240\u6709\u6570\u636e\u5e93\u53d8\u66f4\u7c7b\u7684\u8bed\u53e5\u3002</p>"},{"location":"db_ops/10db_logs/#3-1","title":"3-1 \u8bb0\u5f55\u8bed\u53e5\u7684\u79cd\u7c7b","text":"<ul> <li>DDL\uff08\u6570\u636e\u5b9a\u4e49\u8bed\u8a00\uff09\uff1acreate\u3001drop</li> <li>DCL\uff08\u6570\u636e\u63a7\u5236\u8bed\u8a00\uff09\uff1agrant \u3001revoke</li> <li>DML\uff08\u6570\u636e\u64cd\u4f5c\u8bed\u8a00\uff09\uff1ainsert\u3001update\u3001delete</li> </ul>"},{"location":"db_ops/10db_logs/#3-2","title":"3-2 \u4e0d\u540c\u8bed\u53e5\u7684\u8bb0\u5f55\u683c\u5f0f\u8bf4\u660e","text":"<ul> <li>DDL\u3001DCL\u76f4\u63a5\u4ee5\u8bed\u53e5\uff08statement\uff09\u65b9\u5f0f\u8bb0\u5f55 .</li> <li>DML \u8bed\u53e5\u6709\u4e09\u79cd\u6a21\u5f0f\uff1aSBR\u3001RBR\u3001MBR</li> </ul> <pre><code>mysql&gt; select @@binlog_format;\n+-----------------+\n| @@binlog_format |\n+-----------------+\n| ROW |\n+-----------------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u914d\u7f6e\u8bf4\u660e </p> <ul> <li><code>statement----&gt;SBR</code>\uff1a\u505a\u4ec0\u4e48\u8bb0\u5f55\u4ec0\u4e48\uff0c\u5373SQL\u8bed\u53e5</li> <li><code>row----------&gt;RBR</code>\uff1a\u8bb0\u5f55\u6570\u636e\u884c\u7684\u53d8\u5316\uff08\u9ed8\u8ba4\u6a21\u5f0f\uff0c\u63a8\u8350\uff09</li> <li><code>mixed--------&gt;MBR</code>\uff1a\u81ea\u52a8\u5224\u65ad\u8bb0\u5f55\u6a21\u5f0f</li> </ul> <p>SBR\u548cRBR\u7684\u533a\u522b</p> <p></p>"},{"location":"db_ops/10db_logs/#4","title":"4\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5de5\u4f5c\u6a21\u5f0f","text":""},{"location":"db_ops/10db_logs/#4-1","title":"4-1 \u4e8c\u8fdb\u5236\u65e5\u5fd7\u5de5\u4f5c\u6a21\u5f0f","text":"<pre><code># vim /etc/my.cnf\n[mysqld]\nbinlog_format='ROW'\n</code></pre> <p>\u91cd\u542f\u6570\u636e\u5e93</p> <pre><code>systemctl restart mysqld\n</code></pre>"},{"location":"db_ops/10db_logs/#4-2","title":"4-2 \u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5de5\u4f5c\u6a21\u5f0f","text":"<pre><code>mysql&gt; show variables like \"binlog%\";\n+--------------------------------------------+--------------+\n| Variable_name | Value |\n+--------------------------------------------+--------------+\n| binlog_cache_size | 32768 |\n| binlog_checksum | CRC32 |\n| binlog_direct_non_transactional_updates | OFF |\n| binlog_error_action | ABORT_SERVER |\n| binlog_format | ROW |\n| binlog_group_commit_sync_delay | 0 |\n| binlog_group_commit_sync_no_delay_count | 0 |\n| binlog_gtid_simple_recovery | ON |\n| binlog_max_flush_queue_time | 0 |\n| binlog_order_commits | ON |\n| binlog_row_image | FULL |\n| binlog_rows_query_log_events | OFF |\n| binlog_stmt_cache_size | 32768 |\n| binlog_transaction_dependency_history_size | 25000 |\n| binlog_transaction_dependency_tracking | COMMIT_ORDER |\n+--------------------------------------------+--------------+\n15 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/10db_logs/#4-3","title":"4-3\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e09\u79cd\u6a21\u5f0f\u7684\u533a\u522b","text":"<p>1\uff09ROW: \u57fa\u4e8e\u884c\u7684\u590d\u5236</p> <p>\u4f18\u70b9\uff1a\u6240\u6709\u7684\u8bed\u53e5\u90fd\u53ef\u4ee5\u590d\u5236\uff0c\u4e0d\u8bb0\u5f55\u6267\u884c\u7684sql\u8bed\u53e5\u7684\u4e0a\u4e0b\u6587\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u4ec5\u9700\u8981\u8bb0\u5f55\u90a3\u4e00\u6761\u8bb0\u5f55\u88ab \u4fee\u6539\u6210\u4ec0\u4e48\u4e86</p> <p>\u7f3a\u70b9\uff1abinlog \u5927\u4e86\u5f88\u591a\uff0c\u590d\u6742\u7684\u56de\u6eda\u65f6 binlog \u4e2d\u4f1a\u5305\u542b\u5927\u91cf\u7684\u6570\u636e\uff1b\u4e3b\u670d\u52a1\u5668\u4e0a\u6267\u884cupdate\u8bed\u53e5\u65f6\uff0c \u6240\u6709\u53d1\u751f\u53d8\u5316\u7684\u8bb0\u5f55\u90fd\u4f1a\u5199\u5230 binlog \u4e2d\uff1b\u6bd4\u5982\u6709\u8fd9\u6837\u4e00\u6761update\u8bed\u53e5\uff1a<code>update product set owner_member_id='d' where owner_member_id='a'</code>,\u6267\u884c\u4e4b\u540e\uff0c\u65e5\u5fd7\u4e2d\u8bb0\u5f55\u7684\u4e0d\u662f\u8fd9\u6761update\u8bed\u53e5 \u6240\u5bf9\u5e94\u7684\u4e8b\u4ef6(mysql\u662f\u4ee5\u4e8b\u4ef6\u7684\u5f62\u5f0f\u6765\u8bb0\u5f55bin-log\u65e5\u5fd7)\uff0c\u800c\u662f\u8fd9\u6761\u8bed\u53e5\u6240\u66f4\u65b0\u7684\u6bcf\u4e00\u6761\u8bb0\u5f55\u7684\u53d8\u5316\u60c5 \u51b5\uff0c\u8fd9\u6837\u5c31\u8bb0\u5f55\u6210\u5f88\u591a\u6761\u8bb0\u5f55\u88ab\u66f4\u65b0\u7684\u5f88\u591a\u4e8b\u4ef6\u3002\u81ea\u7136\uff0cbin-log\u65e5\u5fd7\u7684\u91cf\u4f1a\u5f88\u5927\u3002</p> <p>2\uff09Statement: \u57fa\u4e8esql\u8bed\u53e5\u7684\u590d\u5236</p> <ul> <li> <p>\u4f18\u70b9\uff1a\u4e0d\u9700\u8981\u8bb0\u5f55\u6bcf\u4e00\u884c\u7684\u53d8\u5316\uff0c\u51cf\u5c11\u4e86binlog\u65e5\u5fd7\u91cf\uff0c\u8282\u7ea6\u4e86IO\uff0c\u63d0\u9ad8\u6027\u80fd</p> </li> <li> <p>\u7f3a\u70b9\uff1a\u7531\u4e8e\u5b83\u662f\u8bb0\u5f55\u7684\u6267\u884c\u8bed\u53e5\uff0c\u6240\u4ee5\u4e3a\u4e86\u8ba9\u8fd9\u4e9b\u8bed\u53e5\u5728slave\u7aef\u4e5f\u80fd\u6b63\u786e\u6267\u884c\uff0c\u90a3\u4e48\u4ed6\u8fd8\u5fc5\u987b\u8bb0\u5f55\u6bcf \u6761\u8bed\u53e5\u5728\u6267\u884c\u7684\u65f6\u5019\u7684\u4e00\u4e9b\u76f8\u5173\u4fe1\u606f\uff0c\u4e5f\u5c31\u662f\u4e0a\u4e0b\u6587\u4fe1\u606f\uff0c\u4ee5\u4fdd\u8bc1\u6240\u6709\u8bed\u53e5\u5728slave\u7aef\u88ab\u6267\u884c\u7684\u65f6\u5019\u80fd \u591f\u5f97\u5230\u548c\u5728master\u7aef\u6267\u884c\u65f6\u5019\u76f8\u540c\u7684\u7ed3\u679c\u3002\u53e6\u5916\u5c31\u662f,\u7531\u4e8emysql\u73b0\u5728\u53d1\u5c55\u6bd4\u8f83\u5feb\uff0c\u5f88\u591a\u7684\u65b0\u529f\u80fd\u52a0\u5165\uff0c \u4f7fmysql\u7684\u590d\u5236\u9047\u5230\u4e86\u4e0d\u5c0f\u7684\u6311\u6218,\u81ea\u7136\u590d\u5236\u7684\u65f6\u5019\u6d89\u53ca\u5230\u8d8a\u590d\u6742\u7684\u5185\u5bb9\uff0cbug\u4e5f\u5c31\u8d8a\u5bb9\u6613\u51fa\u73b0\u3002\u5728 statement level\u4e0b\uff0c\u76ee\u524d\u5df2\u7ecf\u53d1\u73b0\u7684\u5c31\u6709\u4e0d\u5c11\u60c5\u51b5\u4f1a\u9020\u6210mysql\u7684\u590d\u5236\u95ee\u9898\uff0c\u4e3b\u8981\u662f\u4fee\u6539\u6570\u636e\u7684\u65f6\u5019\u4f7f \u7528\u4e86\u67d0\u4e9b\u7279\u5b9a\u7684\u51fd\u6570\u6216\u8005\u529f\u80fd\u7684\u65f6\u5019\u4f1a\u51fa\u73b0\uff0c\u6bd4\u5982sleep()\u5728\u6709\u4e9b\u7248\u672c\u5c31\u4e0d\u80fd\u6b63\u786e\u590d\u5236\u3002</p> </li> </ul> <p>3\uff09mixed\u6a21\u5f0f \uff1arow \u4e0e statement \u7ed3\u5408</p> <p>\u5b9e\u9645\u4e0a\u5c31\u662f\u524d\u4e24\u79cd\u6a21\u5f0f\u7684\u7ed3\u5408\uff0c\u5728mixed\u6a21\u5f0f\u4e0b\uff0cmysql\u4f1a\u6839\u636e\u6267\u884c\u7684\u6bcf\u4e00\u6761\u5177\u4f53\u7684sql\u8bed\u53e5\u6765\u533a\u5206\u5bf9\u5f85 \u8bb0\u5f55\u7684\u65e5\u5fd7\u5f62\u5f0f\uff0c\u4e5f\u5c31\u662f\u5728statement\u548crow\u4e4b\u95f4\u9009\u4e00\u79cd\u3002</p> <p>\u65b0\u7248\u672c\u4e2d\u7684statement level\u8fd8\u662f\u548c\u4ee5\u524d\u4e00 \u6837\uff0c\u4ec5\u4ec5\u8bb0\u5f55\u6267\u884c\u7684\u8bed\u53e5\u3002\u800c\u65b0\u7248\u672c\u7684mysql\u4e2d\u5bf9row level\u6a21\u5f0f\u88ab\u505a\u4e86\u4f18\u5316\uff0c\u5e76\u4e0d\u662f\u6240\u6709\u7684\u4fee\u6539\u90fd\u4f1a\u4ee5 row level\u6765\u8bb0\u5f55\uff0c\u50cf\u9047\u5230\u8868\u7ed3\u6784\u53d8\u66f4\u7684\u65f6\u5019\u5c31\u4f1a\u4ee5statement\u6a21\u5f0f\u6765\u8bb0\u5f55\uff0c\u5982\u679csql\u8bed\u53e5\u786e\u5b9e\u5c31\u662f update\u6216\u8005delete \u7b49\u4fee\u6539\u6570\u636e\u7684\u8bed\u53e5\uff0c\u90a3\u4e48\u8fd8\u662f\u4f1a\u8bb0\u5f55\u6240\u6709\u884c\u7684\u53d8\u66f4\u3002</p>"},{"location":"db_ops/10db_logs/#5","title":"5\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e8b\u4ef6","text":""},{"location":"db_ops/10db_logs/#5-1","title":"5-1\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e8b\u4ef6\u7b80\u4ecb","text":"<p>\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5185\u5bb9\u4ee5\u4e8b\u4ef6\uff08binlog events\uff09\u4e3a\u6700\u5c0f\u8bb0\u5f55\u5355\u5143\u3002</p> <p>\u5bf9\u4e8eDDL\u548cDCL\uff0c\u4e00\u4e2a\u8bed\u53e5\u5c31\u662f\u4e00\u4e2a\u4e8b\u4ef6\u3002 </p> <p>\u5bf9\u4e8eDML\uff08\u6807\u51c6\u7684\u4e8b\u52a1\u8bed\u53e5\uff09\uff0c\u53ea\u8bb0\u5f55\u5df2\u63d0\u4ea4\u7684\u4e8b\u52a1\u7684DML\u8bed\u53e5</p> <pre><code>begin ; \u4e8b\u4ef61\na \u4e8b\u4ef62\nb \u4e8b\u4ef63\ncommit; \u4e8b\u4ef64\n</code></pre>"},{"location":"db_ops/10db_logs/#5-2","title":"5-2\u3001\u4e8b\u4ef6\u7684\u6784\u6210\uff08\u4e3a\u4e86\u622a\u53d6\u65e5\u5fd7\uff09","text":"<pre><code>mysqlbinlog mysql-bin.000001\n# at 219 \u4e8b\u4ef6\u5f00\u59cb\u7684\u4f4d\u7f6e(position)\n\nend_log_pos 319 \u4e8b\u4ef6\u7ed3\u675f\u7684\u4f4d\u7f6e(position)\n#200219 14:28:12 \u4e8b\u4ef6\u53d1\u751f\u7684\u65f6\u95f4\n\ncreate database qfedu \u4e8b\u4ef6\u5185\u5bb9\n</code></pre>"},{"location":"db_ops/10db_logs/#5-3","title":"5-3\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u57fa\u7840\u67e5\u770b","text":"<p>1\uff09\u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u914d\u7f6e\u4fe1\u606f</p> <pre><code>mysql&gt; show variables like '%log_bin%';\n+---------------------------------+--------------------------------+\n| Variable_name | Value |\n+---------------------------------+--------------------------------+\n| log_bin | ON |\n| log_bin_basename | /var/log/mysql/mysql-bin |\n| log_bin_index | /var/log/mysql/mysql-bin.index |\n| log_bin_trust_function_creators | OFF |\n| log_bin_use_v1_row_events | OFF |\n| sql_log_bin | ON |\n+---------------------------------+--------------------------------+\n6 rows in set (0.00 sec)\n</code></pre> <p>\u5b57\u6bb5\u8bf4\u660e</p> <ul> <li><code>log_bin</code> \u5f00\u542f\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u5f00\u5173</li> <li><code>log_bin_basename</code> \u4f4d\u7f6e </li> <li><code>sql_log_bin</code> \u4e34\u65f6\u5f00\u542f\u6216\u5173\u95ed\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u5c0f\u5f00\u5173</li> </ul> <p>2\uff09\u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u57fa\u672c\u4fe1\u606f</p> <p>\u6253\u5370\u51fa\u5f53\u524dMySQL\u7684\u6240\u6709\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u5e76\u4e14\u663e\u793a\u6700\u540e\u4f7f\u7528\u5230\u7684 position</p> <pre><code>mysql&gt; show binary logs;\n+------------------+-----------+\n| Log_name | File_size |\n+------------------+-----------+\n| mysql-bin.000001 | 316 |\n+------------------+-----------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u67e5\u770b\u5f53\u524d\u6b63\u5728\u4f7f\u7528\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7</p> <pre><code>mysql&gt; show binary logs;\n+------------------+-----------+\n| Log_name | File_size |\n+------------------+-----------+\n| mysql-bin.000001 | 316 |\n+------------------+-----------+\n1 row in set (0.00 sec)\n\n\n\nmysql&gt; show master status;\uff08\u5e38\u7528\uff09\n+------------------+----------+--------------+------------------+---------------\n----+\n| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |\nExecuted_Gtid_Set |\n+------------------+----------+--------------+------------------+---------------\n----+\n| mysql-bin.000001 | 316 | | |\n|\n+------------------+----------+--------------+------------------+---------------\n----+\n1 row in set (0.00 sec)\n</code></pre> <p>\u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u4e8b\u4ef6\u4fe1\u606f</p> <pre><code>mysql&gt; show master status;\n+------------------+----------+--------------+------------------+---------------\n----+\n| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |\nExecuted_Gtid_Set |\n+------------------+----------+--------------+------------------+---------------\n----+\n| mysql-bin.000001 | 316 | | |\n|\n+------------------+----------+--------------+------------------+---------------\n----+\n1 row in set (0.00 sec)\n\n\nmysql&gt; show binlog events in 'mysql-bin.000001';\n+------------------+-----+----------------+-----------+-------------+-----------\n----------------------------+\n| Log_name | Pos | Event_type | Server_id | End_log_pos | Info\n|\n+------------------+-----+----------------+-----------+-------------+-----------\n----------------------------+\n| mysql-bin.000001 | 4 | Format_desc | 6 | 123 | Server\nver: 5.7.29-log, Binlog ver: 4 |\n| mysql-bin.000001 | 123 | Previous_gtids | 6 | 154 |\n|\n| mysql-bin.000001 | 154 | Anonymous_Gtid | 6 | 219 | SET\n@@SESSION.GTID_NEXT= 'ANONYMOUS' |\n| mysql-bin.000001 | 219 | Query | 6 | 316 | create\ndatabase qfedu |\n+------------------+-----+----------------+-----------+-------------+-----------\n----------------------------+\n4 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/10db_logs/#5-4","title":"5-4\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5185\u5bb9\u7684\u67e5\u770b\u548c\u622a\u53d6","text":"<p>1)\u5185\u5bb9\u67e5\u770b\u547d\u4ee4</p> <pre><code># mysqlbinlog /data/3306/binlog/mysql-bin.000001\n\n# mysqlbinlog --base64-output=decode-rows -vvv\n/data/3306/binlog/mysql-bin.000001\n</code></pre> <p>\u8bb0\u4e0d\u4f4f\u53c2\u6570\u53ef\u4ee5\u53bb<code>mysqlbinlog --help</code>\u4e2d\u67e5\u770b</p> <p>2)\u65e5\u5fd7\u7684\u622a\u53d6</p> <p>\u622a\u53d6\u8bed\u6cd5:</p> <ul> <li><code>--start-position</code> \u5f00\u59cb\u622a\u53d6 pod \u70b9</li> <li><code>--stop-position</code> \u7ed3\u675f\u622a\u53d6 pod \u70b9</li> </ul> <pre><code># mysqlbinlog --start-position=xxx --stop-position=xxx\n/data/3306/binlog/mysql-bin.000001 &gt;/data/bin.sql\n</code></pre> <p>3)\u6570\u636e\u6062\u590d\u5b9e\u4f8b</p> <pre><code>mysql&gt; create database binlog charset utf8mb4;\nQuery OK, 1 row affected (0.00 sec)\n\nmysql&gt; use binlog;\nDatabase changed\n\nmysql&gt; create table t1(id int) engine=innodb charset=utf8mb4;\nQuery OK, 0 rows affected (0.02 sec)\n\nmysql&gt; insert into t1 values(1),(2),(3);\nQuery OK, 3 rows affected (0.00 sec)\nRecords: 3 Duplicates: 0 Warnings: 0\nmysql&gt; insert into t1 values(11),(12),(13);\nQuery OK, 3 rows affected (0.00 sec)\nRecords: 3 Duplicates: 0 Warnings: 0\nmysql&gt; commit;\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql&gt; update t1 set id=10 where id&gt;10;\nQuery OK, 3 rows affected (0.00 sec)\nRows matched: 3 Changed: 3 Warnings: 0\nmysql&gt; commit;\n\nmysql&gt; select * from t1;\n+------+\n| id |\n+------+\n| 1 |\n| 2 |\n| 3 |\n| 10 |\n| 10 |\n| 10 |\n+------+\n6 rows in set (0.00 sec)\n</code></pre> <p>\u5220\u9664\u6570\u636e</p> <pre><code>mysql&gt; drop database binlog;\nQuery OK, 1 row affected (0.00 sec)\n</code></pre> <p>\u6570\u636e\u6062\u590d</p> <p>\u786e\u8ba4\u8d77\u70b9\u548c\u7ec8\u70b9</p> <pre><code>mysql&gt; show master status;\n+------------------+----------+--------------+------------------+---------------\n----+\n| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |\nExecuted_Gtid_Set |\n+------------------+----------+--------------+------------------+---------------\n----+\n| mysql-bin.000001 | 1610 | | |\n|\n+------------------+----------+--------------+------------------+---------------\n----+\n1 row in set (0.00 sec)\n\nmysql&gt; show binlog events in 'mysql-bin.000001';\n\u8d77\u70b9\uff1a\n| mysql-bin.000001 | 381 | Query | 6 | 497 | create\ndatabase binlog charset utf8mb4 |\n\u7ec8\u70b9\uff1a\n| mysql-bin.000001 | 1575 | Query | 6 | 1673 | drop\ndatabase binlog\n</code></pre> <p>\u622a\u53d6\u65e5\u5fd7</p> <pre><code># mysqlbinlog --start-position=381 --stop-position=1575\n/data/3306/binlog/mysql-bin.000003&gt;/data/bin.sql\n</code></pre> <p>\u6062\u590d\u65e5\u5fd7</p> <pre><code>mysql&gt; set sql_log_bin=0; # \u4e34\u65f6\u5173\u95ed\u5f53\u524d\u4f1a\u8bdd\u7684binlog\u8bb0\u5f55\nmysql&gt; source /data/bin.sql;\nmysql&gt; set sql_log_bin=1; # \u6253\u5f00\u5f53\u524d\u4f1a\u8bdd\u7684binlog\n</code></pre>"},{"location":"db_ops/10db_logs/#5-5-gtid","title":"5-5\u3001\u57fa\u4e8e gtid","text":"<p>1)gtid\uff08Global Transaction ID\uff09\u7b80\u4ecb</p> <ul> <li>\u5168\u5c40\u552f\u4e00\u7684\u4e8b\u52a1\u7f16\u53f7\u3002 </li> <li>\u5e42\u7b49\u6027\u3002 </li> <li>GtID\u5305\u62ec\u4e24\u90e8\u5206\uff1a<code>Server_uuid\uff1aTx_id</code></li> </ul> <p>2)gtid \u914d\u7f6e</p> <p>\u67e5\u770b gtid</p> <pre><code>mysql&gt; show variables like '%gtid%';\n+----------------------------------+-----------+\n| Variable_name | Value |\n+----------------------------------+-----------+\n| binlog_gtid_simple_recovery | ON |\n| enforce_gtid_consistency | OFF |\n| gtid_executed_compression_period | 1000 |\n| gtid_mode | OFF |\n| gtid_next | AUTOMATIC |\n| gtid_owned | |\n| gtid_purged | |\n| session_track_gtids | OFF |\n+----------------------------------+-----------+\n8 rows in set (0.00 sec)\n</code></pre> <p>\u4fee\u6539\u914d\u7f6e</p> <pre><code>[root@qfedu.com ~]# vim /etc/my.cnf\n[mysqld]\ngtid_mode=on # \u5f00\u542f gtid\nenforce_gtid_consistency=true # \u5f3a\u5236GTID\u4e00\u81f4\u6027\nlog_slave_updates=1 # \u4e3b\u4ece\u590d\u5236\u4e2d\u4ece\u5e93\u8bb0\u5f55 binlog\uff0c\u5e76\u7edf\u4e00GTID\u4fe1\u606f\n</code></pre> <ul> <li><code>gtid_mode=on</code> # \u5f00\u542f gtid</li> <li><code>enforce_gtid_consistency=true</code># \u5f3a\u5236GTID\u4e00\u81f4\u6027</li> <li><code>log_slave_updates=1</code> # \u4e3b\u4ece\u590d\u5236\u4e2d\u4ece\u5e93\u8bb0\u5f55 binlog\uff0c\u5e76\u7edf\u4e00GTID\u4fe1\u606f</li> </ul> <p>\u91cd\u542f\u6570\u636e\u5e93</p> <pre><code>[root@qfedu.com ~]# systemcat restart mysqld\n</code></pre> <p>3)\u57fa\u4e8e gtid \u622a\u53d6\u65e5\u5fd7</p> <ul> <li>\u5bf9\u4e8e DDL\u548c DCL \u4e00\u4e2a\u64cd\u4f5c\u5c31\u662f\u4e00\u4e2a GTID\u3002 </li> <li>\u5bf9\u4e8e DML\uff0c\u4e00\u4e2a\u5b8c\u6574\u7684\u4e8b\u52a1\u5c31\u662f\u5df2\u7ed9 GTID\u3002</li> </ul> <pre><code>mysql&gt; show variables like '%gtid%';\n+----------------------------------+-----------+\n| Variable_name | Value |\n+----------------------------------+-----------+\n| binlog_gtid_simple_recovery | ON |\n| enforce_gtid_consistency | ON |\n| gtid_executed_compression_period | 1000 |\n| gtid_mode | ON |\n| gtid_next | AUTOMATIC |\n| gtid_owned | |\n| gtid_purged | |\n| session_track_gtids | OFF |\n+----------------------------------+-----------+\n8 rows in set (0.00 sec)\nmysql&gt; show master status;\n+------------------+----------+--------------+------------------+---------------\n---------------------------+\n| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |\nExecuted_Gtid_Set \n+------------------+----------+--------------+------------------+---------------\n---------------------------+\n| mysql-bin.000002 | 1359 | | | 827ddb16-4ec8-\n11ea-b734-000c293df1f0:1-5 |\n+------------------+----------+--------------+------------------+---------------\n---------------------------+\n1 row in set (0.00 sec)\nmysql&gt; show binlog events in 'mysql-bin.000002';\n+------------------+------+----------------+-----------+-------------+----------\n------------------------------------------------------------+\n| Log_name | Pos | Event_type | Server_id | End_log_pos | Info\n|\n+------------------+------+----------------+-----------+-------------+----------\n------------------------------------------------------------+\n| mysql-bin.000002 | 4 | Format_desc | 6 | 123 | Server\nver: 5.7.29-log, Binlog ver: 4 |\n| mysql-bin.000002 | 123 | Previous_gtids | 6 | 154 |\n|\n| mysql-bin.000002 | 154 | Gtid | 6 | 219 | SET\n@@SESSION.GTID_NEXT= '827ddb16-4ec8-11ea-b734-000c293df1f0:1' |\n| mysql-bin.000002 | 219 | Query | 6 | 338 | create\ndatabase binlog1 charset utf8mb4 |\n| mysql-bin.000002 | 338 | Gtid | 6 | 403 | SET\n@@SESSION.GTID_NEXT= '827ddb16-4ec8-11ea-b734-000c293df1f0:2' |\n| mysql-bin.000002 | 403 | Query | 6 | 536 | use\n`binlog1`; create table t1(id int) engine=innodb charset=utf8mb4 |\n| mysql-bin.000002 | 536 | Gtid | 6 | 601 | SET\n@@SESSION.GTID_NEXT= '827ddb16-4ec8-11ea-b734-000c293df1f0:3' |\n| mysql-bin.000002 | 601 | Query | 6 | 676 | BEGIN\n|\n| mysql-bin.000002 | 676 | Table_map | 6 | 724 | table_id:\n108 (binlog1.t1) |\n| mysql-bin.000002 | 724 | Write_rows | 6 | 774 | table_id:\n108 flags: STMT_END_F |\n| mysql-bin.000002 | 774 | Xid | 6 | 805 | COMMIT /*\nxid=11 */ |\n| mysql-bin.000002 | 805 | Gtid | 6 | 870 | SET\n@@SESSION.GTID_NEXT= '827ddb16-4ec8-11ea-b734-000c293df1f0:4' |\n| mysql-bin.000002 | 870 | Query | 6 | 945 | BEGIN\n|\n| mysql-bin.000002 | 945 | Table_map | 6 | 993 | table_id:\n108 (binlog1.t1) |\n| mysql-bin.000002 | 993 | Write_rows | 6 | 1043 | table_id:\n108 flags: STMT_END_F |\n| mysql-bin.000002 | 1043 | Xid | 6 | 1074 | COMMIT /*\nxid=12 */ |\n| mysql-bin.000002 | 1074 | Gtid | 6 | 1139 | SET\n@@SESSION.GTID_NEXT= '827ddb16-4ec8-11ea-b734-000c293df1f0:5' |\n| mysql-bin.000002 | 1139 | Query | 6 | 1214 | BEGIN\n|\n| mysql-bin.000002 | 1214 | Table_map | 6 | 1262 | table_id:\n108 (binlog1.t1) |\n| mysql-bin.000002 | 1262 | Update_rows | 6 | 1328 | table_id:\n108 flags: STMT_END_F |\n| mysql-bin.000002 | 1328 | Xid | 6 | 1359 | COMMIT /*\nxid=15 */ |\n| mysql-bin.000002 | 1359 | Gtid | 6 | 1424 | SET\n@@SESSION.GTID_NEXT= '827ddb16-4ec8-11ea-b734-000c293df1f0:6' |\n+------------------+------+----------------+-----------+-------------+----------\n------------------------------------------------------------+\n37 rows in set (0.00 sec)\n</code></pre> <p>4) \u57fa\u4e8e gtid \u622a\u53d6\u65e5\u5fd7</p> <ul> <li><code>--include-gtids=</code> \u5305\u542b</li> <li><code>--exclude-gtids=</code> \u6392\u9664 </li> <li><code>--skip-gtids=</code> \u8df3\u8fc7 </li> </ul> <p>\u622a\u53d61-3\u53f7\u4e8b\u52a1</p> <pre><code># mysqlbinlog --include-gtids=' 827ddb16-4ec8-11ea-b734-\n000c293df1f0:1-3' /data/binlog/mysql-bin.000001&gt;/data/gtid.sql\n</code></pre> <p>\u622a\u53d6 1-10 gtid\u4e8b\u52a1,\u8df3\u8fc76\u53f7\u548c8\u53f7\u4e8b\u52a1</p> <pre><code># mysqlbinlog --include-gtids=' 827ddb16-4ec8-11ea-b734-\n000c293df1f0:1-10 --exclude-gtids='545fd699-be48-11e9-8f0a000c2980e248:6,545fd699-be48-11e9-8f0a-000c2980e248:8' /data/binlog/mysqlbin.000001&gt;/data/gtid.sql\n</code></pre> <p>5)gtid \u622a\u53d6\u65e5\u5fd7\u5b9e\u4f8b</p> <p>\u51c6\u5907\u73af\u5883</p> <pre><code>mysql&gt; create database gtid charset utf8mb4;\nQuery OK, 1 row affected (0.00 sec)\n\n\nmysql&gt; use gtid;\nDatabase changed\n\n\nmysql&gt; create table t1(id int) engine=innodb charset=utf8mb4;\nQuery OK, 0 rows affected (0.02 sec)\n\n\nmysql&gt; insert into t1 values(1),(2),(3);\nQuery OK, 3 rows affected (0.06 sec)\nRecords: 3 Duplicates: 0 Warnings: 0\n\nmysql&gt; commit;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; insert into t1 values(11),(12),(13);\nQuery OK, 3 rows affected (0.00 sec)\nRecords: 3 Duplicates: 0 Warnings: 0\n\nmysql&gt; commit;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; select * from t1;\n+------+\n| id |\n+------+\n| 1 |\n| 2 |\n| 3 |\n| 11 |\n| 12 |\n| 13 |\n+------+\n6 rows in set (0.00 sec)\n</code></pre> <p>\u5220\u9664\u6570\u636e</p> <pre><code>mysql&gt; drop database gtid;\nQuery OK, 1 row affected (0.01 sec)\n\nmysql&gt; show databases;\n+--------------------+\n| Database |\n+--------------------+\n| information_schema |\n| mysql |\n| performance_schema |\n| sys |\n| test |\n+--------------------+\n6 rows in set (0.00 sec)\n</code></pre> <p>\u627e\u8d77\u70b9\u548c\u7ec8\u7aef(gtid)</p> <pre><code>mysql&gt; show master status;\n+------------------+----------+--------------+------------------+---------------\n----------------------------+\n| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |\nExecuted_Gtid_Set |\n+------------------+----------+--------------+------------------+---------------\n----------------------------+\n| mysql-bin.000002 | 2409 | | | 827ddb16-4ec8-\n11ea-b734-000c293df1f0:1-10 |\n+------------------+----------+--------------+------------------+---------------\n----------------------------+\n1 row in set (0.00 sec)\n\n\nmysql&gt; show binlog events in 'mysql-bin.000002';\n| mysql-bin.000002 | 1359 | Gtid | 6 | 1424 | SET\n@@SESSION.GTID_NEXT= '827ddb16-4ec8-11ea-b734-000c293df1f0:6' |\n| mysql-bin.000002 | 1424 | Query | 6 | 1534 | create\ndatabase gtid charset utf8mb4 |\n| mysql-bin.000002 | 2252 | Gtid | 6 | 2317 | SET\n@@SESSION.GTID_NEXT= '827ddb16-4ec8-11ea-b734-000c293df1f0:10' |\n| mysql-bin.000002 | 2317 | Query | 6 | 2409 | drop\ndatabase gtid \n</code></pre> <p>\u622a\u53d6\u65e5\u5fd7\uff08\u4ec5\u4f9b\u53c2\u8003\uff09</p> <pre><code># mysqlbinlog --skip-gtids --include-gtids='827ddb16-4ec8-\n11ea-b734-000c293df1f0:6-9' /data/3306/binlog/mysql-bin.000002 &gt; /data/gtid.sql\n</code></pre> <p>\u6062\u590d\u6570\u636e</p> <pre><code>mysql&gt; set sql_log_bin=0;\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; source /data/gtid.sql\n\nmysql&gt; set sql_log_bin=1;\n\nmysql&gt; show databases;\n+--------------------+\n| Database |\n+--------------------+\n| information_schema |\n| gtid |\n| mysql |\n| performance_schema |\n| sys |\n| test |\n+--------------------+\n6 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/10db_logs/#6","title":"6\u3001\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5176\u4ed6\u64cd\u4f5c","text":""},{"location":"db_ops/10db_logs/#6-1","title":"6-1 \u81ea\u52a8\u6e05\u7406\u65e5\u5fd7","text":"<p>\u67e5\u770b\u81ea\u52a8\u6e05\u7406\u5468\u671f</p> <pre><code>mysql&gt; show variables like '%expire%';\n+--------------------------------+-------+\n| Variable_name | Value |\n+--------------------------------+-------+\n| disconnect_on_expired_password | ON |\n| expire_logs_days | 0 |\n+--------------------------------+-------+\n2 rows in set (0.00 sec)\n</code></pre> <p>\u96f6\u65f6\u8bbe\u7f6e\u81ea\u52a8\u6e05\u7406\u5468\u671f</p> <pre><code>mysql&gt; set global expire_logs_days=8;\n\nmysql&gt; show variables like '%expire%';\n+--------------------------------+-------+\n| Variable_name | Value |\n+--------------------------------+-------+\n| disconnect_on_expired_password | ON |\n| expire_logs_days | 8 |\n+--------------------------------+-------+\n2 rows in set (0.00 sec)\n</code></pre> <p>\u6c38\u4e45\u751f\u6548</p> <ul> <li>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6</li> </ul> <pre><code># vim /etc/my.cnf\n[mysqld]\nexpire_logs_days=15;\n</code></pre> <p>\u4f01\u4e1a\u5efa\u8bae,\u81f3\u5c11\u4fdd\u7559\u4e24\u4e2a\u5168\u5907\u5468\u671f+1\u7684binlog</p> <p>\u91cd\u542f\u6570\u636e\u5e93</p> <pre><code> systemcat restart mysqld\n</code></pre>"},{"location":"db_ops/10db_logs/#6-2","title":"6-2 \u624b\u5de5\u6e05\u7406","text":"<pre><code>PURGE BINARY LOGS BEFORE now() - INTERVAL 3 day;\nPURGE BINARY LOGS TO 'mysql-bin.000009';\n</code></pre> <p>\u6ce8\u610f: \u4e0d\u8981\u624b\u5de5 rm binlog\u6587\u4ef6</p> <p>\u4e3b\u4ece\u5173\u7cfb\u4e2d\uff0c\u4e3b\u5e93\u6267\u884c\u6b64\u64cd\u4f5c reset master; \uff0c\u4e3b\u4ece\u73af\u5883\u5fc5\u5d29</p>"},{"location":"db_ops/10db_logs/#6-3","title":"6-3 \u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u6eda\u52a8","text":"<pre><code>mysql&gt; flush logs;\nmysql&gt; select @@max_binlog_size;\n</code></pre>"},{"location":"db_ops/10db_logs/#7","title":"7\u3001\u6162\u65e5\u5fd7\u7b80\u4ecb","text":"<p>\u8bb0\u5f55\u8fd0\u884c\u8f83\u6162\u7684\u8bed\u53e5\u8bb0\u5f55slowlog\u4e2d\u3002</p> <p>\u529f\u80fd\u662f\u8f85\u52a9\u4f18\u5316\u7684\u5de5\u5177\u65e5\u5fd7\u3002</p> <p>\u5e94\u6fc0\u6027\u7684\u6162\u53ef\u4ee5\u901a\u8fc7show processlist\u8fdb\u884c\u76d1\u63a7 </p> <p>\u4e00\u6bb5\u65f6\u95f4\u7684\u6162\u53ef\u4ee5\u8fdb\u884cslow\u8bb0\u5f55\u3001\u7edf\u8ba1</p>"},{"location":"db_ops/10db_logs/#8","title":"8\u3001\u6162\u65e5\u5fd7\u914d\u7f6e","text":""},{"location":"db_ops/10db_logs/#8-1","title":"8-1 \u67e5\u770b\u6162\u65e5\u5fd7","text":"<p>\u67e5\u770b\u662f\u5426\u5f00\u542f</p> <pre><code>mysql&gt; show variables like '%slow_query%';\n+---------------------+-----------------------------------+\n| Variable_name | Value |\n+---------------------+-----------------------------------+\n| slow_query_log | OFF |\n| slow_query_log_file | /var/lib/mysql/localhost-slow.log |\n+---------------------+-----------------------------------+\n2 rows in set (0.00 sec)\n</code></pre> <p>\u91cd\u8fde\u6216\u65b0\u5f00\u4e00\u4e2a\u4f1a\u8bdd\u624d\u80fd\u770b\u5230\u4fee\u6539\u503c</p> <p>\u67e5\u770b\u9608\u503c</p> <pre><code>mysql&gt; select @@long_query_time;\n+-------------------+\n| @@long_query_time |\n+-------------------+\n| 10.000000 |\n+-------------------+\n1 row in set (0.00 sec)\nmysql&gt; SHOW GLOBAL VARIABLES LIKE 'long_query_time%';\n+-----------------+-----------+\n| Variable_name | Value |\n+-----------------+-----------+\n| long_query_time | 10.000000 |\n+-----------------+-----------+\n1 row in set (0.00 sec)\nmysql&gt; SHOW VARIABLES LIKE 'long_query_time%';\n+-----------------+-----------+\n| Variable_name | Value |\n+-----------------+-----------+\n| long_query_time | 10.000000 |\n+-----------------+-----------+\n1 row in set (0.00 sec)\nmysql&gt; show variables like '%log_queries_not_using_indexes%';\n+-------------------------------+-------+\n| Variable_name | Value |\n+-------------------------------+-------+\n| log_queries_not_using_indexes | OFF |\n+-------------------------------+-------+\n1 row in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/10db_logs/#8-2","title":"8-2 \u914d\u7f6e\u6162\u65e5\u5fd7","text":"<p>\u96f6\u65f6\u8bbe\u7f6e\u5f00\u542f</p> <pre><code>SET GLOBAL slow_query_log = 1; #\u9ed8\u8ba4\u672a\u5f00\u542f\uff0c\u5f00\u542f\u4f1a\u5f71\u54cd\u6027\u80fd\uff0cmysql\u91cd\u542f\u4f1a\u5931\u6548\n</code></pre> <p>\u8bbe\u7f6e\u9608\u503c\uff1a</p> <pre><code>SET GLOBAL long_query_time=3;\n</code></pre>"},{"location":"db_ops/10db_logs/#8-3","title":"8-3 \u6c38\u4e45\u751f\u6548","text":"<p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6</p> <pre><code># vim /etc/my.cnf\n[mysqld]\nslow_query_log=1\nslow_query_log_file=/data/3306/data/qfedu-slow.log\nlong_query_time=0.1 \u9ed8\u8ba4\u914d\u7f6e10\u79d2\u949f\nlog_queries_not_using_indexes=1\n</code></pre> <pre><code>systemcat restart mysqld\n</code></pre>"},{"location":"db_ops/10db_logs/#9","title":"9\u3001\u6162\u8bed\u53e5\u6a21\u62df","text":"<pre><code>mysql&gt; set sql_log_bin=0;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; select sleep(4);\n+----------+\n| sleep(4) |\n+----------+\n| 0 |\n+----------+\n1 row in set (4.00 sec)\n\nmysql&gt; SHOW GLOBAL STATUS LIKE '%Slow_queries%';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| Slow_queries | 1 |\n+---------------+-------+\n1 row in set (0.00 sec)\nmysql&gt; set sql_log_bin=1;\nQuery OK, 0 rows affected (0.00 sec)\n</code></pre>"},{"location":"db_ops/10db_logs/#10","title":"10\u3001\u6162\u65e5\u5fd7\u5206\u6790\u5de5\u5177","text":"<pre><code># mysqldumpslow -s r -t 10 /data/3306/data/qfedu-slow.log\n# \u5f97\u5230\u8fd4\u56de\u8bb0\u5f55\u96c6\u6700\u591a\u768410\u4e2aSQL\n\n# mysqldumpslow -s c -t 10 /data/3306/data/qfedu-slow.log\n# \u5f97\u5230\u8bbf\u95ee\u6b21\u6570\u6700\u591a\u768410\u4e2aSQL\n\n# mysqldumpslow -s t -t 10 -g \"LEFT JOIN\"\n/data/3306/data/qfedu-slow.log # \u5f97\u5230\u6309\u7167\u65f6\u95f4\u6392\u5e8f\u7684\u524d10\u6761\u91cc\u9762\u542b\u6709\u5de6\u8fde\u63a5\u7684\u67e5\u8be2\u8bed\u53e5\n\n# mysqldumpslow -s r -t 10 /data/3306/data/qfedu-slow.log |\nmore # \u7ed3\u5408| more\u4f7f\u7528\uff0c\u9632\u6b62\u7206\u5c4f\u60c5\u51b5\ns\uff1a\u8868\u793a\u6309\u4f55\u79cd\u65b9\u5f0f\u6392\u5e8f\nc\uff1a\u8bbf\u95ee\u6b21\u6570\nl\uff1a\u9501\u5b9a\u65f6\u95f4\nr\uff1a\u8fd4\u56de\u8bb0\u5f55\nt\uff1a\u67e5\u8be2\u65f6\u95f4\nal\uff1a\u5e73\u5747\u9501\u5b9a\u65f6\u95f4\nar\uff1a\u5e73\u5747\u8fd4\u56de\u8bb0\u5f55\u6570\nat\uff1a\u5e73\u5747\u67e5\u8be2\u65f6\u95f4\nt\uff1a\u8fd4\u56de\u524d\u9762\u591a\u5c11\u6761\u7684\u6570\u636e\ng\uff1a\u540e\u8fb9\u642d\u914d\u4e00\u4e2a\u6b63\u5219\u5339\u914d\u6a21\u5f0f\uff0c\u5927\u5c0f\u5199\u4e0d\u654f\u611f\n</code></pre>"},{"location":"db_ops/11db_backup/","title":"\u7b2c\u5341\u4e00\u8282 MySQL\u5907\u4efd\u6982\u8ff0","text":""},{"location":"db_ops/11db_backup/#1","title":"1\u3001\u4e3a\u4ec0\u4e48\u8981\u5907\u4efd","text":"<p>\u80fd\u591f\u9632\u6b62\u7531\u4e8e\u673a\u68b0\u6545\u969c\u4ee5\u53ca\u4eba\u4e3a\u8bef\u64cd\u4f5c\u5e26\u6765\u7684\u6570\u636e\u4e22\u5931\uff0c\u4f8b\u5982\u5c06\u6570\u636e\u5e93\u6587\u4ef6\u4fdd\u5b58\u5728\u4e86\u5176\u5b83\u5730\u65b9\u3002</p> <p>\u5197\u4f59\uff1a\u6570\u636e\u6709\u591a\u4efd\u5197\u4f59\uff0c\u4f46\u4e0d\u7b49\u5907\u4efd\uff0c\u53ea\u80fd\u9632\u6b62\u673a\u68b0\u6545\u969c\u8fd8\u6765\u7684\u6570\u636e\u4e22\u5931\uff0c\u4f8b\u5982\u4e3b\u5907\u6a21\u5f0f\u3001\u6570\u636e \u5e93\u96c6\u7fa4\u3002</p>"},{"location":"db_ops/11db_backup/#2","title":"2\u3001\u5907\u4efd\u5fc5\u987b\u91cd\u89c6\u7684\u5185\u5bb9","text":"<p>\u5907\u4efd\u5185\u5bb9 <code>databases Binlog my.conf</code></p> <p>\u6240\u6709\u5907\u4efd\u6570\u636e\u90fd\u5e94\u653e\u5728\u975e\u6570\u636e\u5e93\u672c\u5730\uff0c\u800c\u4e14\u5efa\u8bae\u6709\u591a\u4efd\u526f\u672c\u3002 </p> <p>\u6d4b\u8bd5\u73af\u5883\u4e2d\u505a\u65e5\u5e38\u6062\u590d\u6f14\u7ec3\uff0c\u6062\u590d\u8f83\u5907\u4efd\u66f4\u4e3a\u91cd\u8981\u3002</p>"},{"location":"db_ops/11db_backup/#3","title":"3\u3001\u5907\u4efd\u8fc7\u7a0b\u4e2d\u5fc5\u987b\u8003\u8651\u56e0\u7d20\uff1a","text":"<p>\u6570\u636e\u7684\u4e00\u81f4\u6027 </p> <p>\u670d\u52a1\u7684\u53ef\u7528\u6027</p>"},{"location":"db_ops/11db_backup/#4mysql","title":"4\u3001MySQL \u5907\u4efd\u7c7b\u578b","text":""},{"location":"db_ops/11db_backup/#4-1","title":"4-1 \u7269\u7406\u5907\u4efd","text":"<p>\u5bf9\u6570\u636e\u5e93\u64cd\u4f5c\u7cfb\u7edf\u7684\u7269\u7406\u6587\u4ef6\uff08\u5982\u6570\u636e\u6587\u4ef6\u3001\u65e5\u5fd7\u6587\u4ef6\u7b49\uff09\u7684\u5907\u4efd\u3002</p> <p>\u7269\u7406\u5907\u4efd\u53c8\u53ef\u5206\u4e3a\u8131\u673a\u5907\u4efd\uff08\u51b7\u5907 \u4efd\uff09\u548c\u8054\u673a\u5907\u4efd\uff08\u70ed\u5907\u4efd\uff09\u3002\u8fd9\u79cd\u7c7b\u578b\u7684\u5907\u4efd\u9002\u7528\u4e8e\u51fa\u73b0\u95ee\u9898\u65f6\u9700\u8981\u5feb\u901f\u6062\u590d\u7684\u5927\u578b\u91cd\u8981\u6570\u636e\u5e93\u3002</p> <p>1. \u70ed\u5907(hot backup)</p> <p>\u5728\u7ebf\u5907\u4efd\uff0c\u6570\u636e\u5e93\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\uff0c\u8fd9\u79cd\u5907\u4efd\u65b9\u6cd5\u4f9d\u8d56\u4e8e\u6570\u636e\u5e93\u7684\u65e5\u5fd7\u6587\u4ef6</p> <p>\u5bf9\u5e94\u7528\u57fa\u672c\u65e0\u5f71\u54cd(\u5e94\u7528\u7a0b\u5e8f\u8bfb\u5199\u4e0d\u4f1a\u963b\u585e,\u4f46\u662f\u6027\u80fd\u8fd8\u662f\u4f1a\u6709\u4e0b\u964d,\u6240\u4ee5\u5c3d\u91cf\u4e0d\u8981\u5728\u4e3b\u4e0a\u505a\u5907\u4efd,\u5728 \u4ece\u5e93\u4e0a\u505a)</p> <p>2. \u51b7\u5907(cold backup)</p> <p>\u5907\u4efd\u6570\u636e\u6587\u4ef6,\u9700\u8981\u505c\u673a\uff0c\u662f\u5728\u5173\u95ed\u6570\u636e\u5e93\u7684\u65f6\u5019\u8fdb\u884c\u7684 </p> <p>\u5907\u4efd datadir \u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6</p> <p>3. \u6e29\u5907(warm backup)</p> <p>\u9488\u5bf9myisam\u7684\u5907\u4efd(myisam\u4e0d\u652f\u6301\u70ed\u5907),\u5907\u4efd\u65f6\u5019\u5b9e\u4f8b\u53ea\u8bfb\u4e0d\u53ef\u5199\uff0c\u6570\u636e\u5e93\u9501\u5b9a\u8868\u683c\uff08\u4e0d\u53ef\u5199\u5165 \u4f46\u53ef\u8bfb\uff09\u7684\u72b6\u6001\u4e0b\u8fdb\u884c\u7684 </p> <p>\u5bf9\u5e94\u7528\u5f71\u54cd\u5f88\u5927 </p>"},{"location":"db_ops/11db_backup/#4-2","title":"4-2 \u903b\u8f91\u5907\u4efd","text":"<p>\u5bf9\u6570\u636e\u5e93\u903b\u8f91\u7ec4\u4ef6\uff08\u5982\u8868\u7b49\u6570\u636e\u5e93\u5bf9\u8c61\uff09\u7684\u5907\u4efd\uff0c\u8868\u793a\u4e3a\u903b\u8f91\u6570\u636e\u5e93\u7ed3\u6784<code>create database</code>\u3001 <code>createtable</code>\u7b49\u8bed\u53e5\uff09\u548c\u5185\u5bb9\uff08insert \u8bed\u53e5\u6216\u5206\u5272\u6587\u672c\u6587\u4ef6\uff09\u7684\u4fe1\u606f\u3002</p> <p>\u8fd9\u79cd\u7c7b\u578b\u7684\u5907\u4efd\u9002\u7528\u4e8e\u53ef\u4ee5\u7f16\u8f91\u6570 \u636e\u503c\u6216\u8868\u7ed3\u6784\u8f83\u5c0f\u7684\u6570\u636e\u91cf\uff0c\u6216\u8005\u5728\u4e0d\u540c\u673a\u5668\u4f53\u7cfb\u7ed3\u6784\u4e0a\u91cd\u65b0\u521b\u5efa\u6570\u636e\u3002</p>"},{"location":"db_ops/11db_backup/#4-3","title":"4-3 \u7269\u7406\u548c\u903b\u8f91\u5907\u4efd\u7684\u533a\u522b","text":""},{"location":"db_ops/11db_backup/#4-4","title":"4-4 \u5907\u4efd\u65b9\u5f0f\u7684\u9009\u62e9","text":"<p>\u4ece\u4ee5\u4e0b\u51e0\u4e2a\u7ef4\u5ea6\u8003\u8651\u5907\u4efd\u65b9\u5f0f</p> <p>\u5907\u4efd\u901f\u5ea6     \u6062\u590d\u901f\u5ea6    \u5907\u4efd\u5927\u5c0f     \u5bf9\u4e1a\u52a1\u5f71\u54cd</p>"},{"location":"db_ops/11db_backup/#5mysql","title":"5\u3001MySQL \u5907\u4efd\u5de5\u5177","text":"<p>5-1 ibbackup</p> <ul> <li>\u5b98\u65b9\u5907\u4efd\u5de5\u5177 </li> <li>\u6536\u8d39 </li> <li>\u7269\u7406\u5907\u4efd</li> </ul> <p>5-2 xtrabackup</p> <ul> <li>\u5f00\u6e90\u793e\u533a\u5907\u4efd\u5de5\u5177 </li> <li>\u5f00\u6e90\u514d\u8d39,\u4e0a\u9762\u90a3\u4e1c\u897f\u7684\u514d\u8d39\u7248\u672c(\u8001\u7248\u672c\u6709\u95ee\u9898,\u5907\u4efd\u51fa\u6765\u7684\u6570\u636e\u53ef\u80fd\u6709\u95ee\u9898) </li> <li>\u7269\u7406\u5907\u4efd</li> </ul> <p>5-3 mysqldump </p> <ul> <li>\u5b98\u65b9\u81ea\u5e26\u5907\u4efd\u5de5\u5177 \u5f00\u6e90\u514d\u8d39 </li> <li>\u903b\u8f91\u5907\u4efd(\u901f\u5ea6\u6162) </li> <li>\u4e0d\u963b\u585edml,\u963b\u585eddl</li> </ul> <p>5-4 mysqlbackup</p> <ul> <li>mysql \u5b98\u65b9\u5907\u4efd\u5de5\u5177 </li> <li>innodb \u5f15\u64ce\u7684\u8868mysqlbackup\u53ef\u4ee5\u8fdb\u884c\u70ed\u5907 </li> <li>\u975einnodb\u8868mysqlbackup\u5c31\u53ea\u80fd\u6e29\u5907 </li> <li>\u7269\u7406\u5907\u4efd\uff0c\u5907\u4efd\u8fd8\u539f\u901f\u5ea6\u5feb </li> <li>\u9002\u5408\u5927\u89c4\u6a21\u6570\u636e\u4f7f\u7528 </li> </ul>"},{"location":"db_ops/11db_backup/#6mysql","title":"6\u3001MySQL \u5907\u4efd\u7b56\u7565","text":"<p>6-1 \u5b8c\u5168\u5907\u4efd </p> <p>\u6bcf\u6b21\u5bf9\u6570\u636e\u8fdb\u884c\u5b8c\u6574\u7684\u5907\u4efd\uff0c\u5373\u5bf9\u6574\u4e2a\u6570\u636e\u5e93\u7684\u5907\u4efd\u3001\u6570\u636e\u5e93\u7ed3\u6784\u548c\u6587\u4ef6\u7ed3\u6784\u7684\u5907\u4efd\uff0c\u4fdd\u5b58\u7684\u662f\u5907\u4efd\u5b8c \u6210\u65f6\u523b\u7684\u6570\u636e\u5e93\uff0c\u662f\u5dee\u5f02\u5907\u4efd\u4e0e\u589e\u91cf\u5907\u4efd\u7684\u57fa\u7840\u3002</p> <ul> <li>\u4f18\u70b9\uff1a\u5907\u4efd\u4e0e\u6062\u590d\u64cd\u4f5c\u7b80\u5355\u65b9\u4fbf. </li> <li>\u7f3a\u70b9\uff1a\u6570\u636e\u5b58\u5728\u5927\u91cf\u7684\u91cd\u590d\uff1b\u5360\u7528\u5927\u91cf\u7684\u7a7a\u95f4\uff1b\u5907\u4efd\u4e0e\u6062\u590d\u65f6\u95f4\u957f\u3002 </li> </ul> <p>6-2 \u5dee\u5f02\u5907\u4efd</p> <p>\u5907\u4efd\u90a3\u4e9b\u81ea\u4ece\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u4e4b\u540e\u88ab\u4fee\u6539\u8fc7\u7684\u6240\u6709\u6587\u4ef6\uff0c\u5907\u4efd\u7684\u65f6\u95f4\u8d77\u70b9\u662f\u4ece\u4e0a\u6b21\u5b8c\u6574\u5907\u4efd\u8d77\uff0c\u5907\u4efd\u6570\u636e \u91cf\u4f1a\u8d8a\u6765\u8d8a\u5927\u3002</p> <p>\u6062\u590d\u6570\u636e\u65f6\uff0c\u53ea\u9700\u6062\u590d\u4e0a\u6b21\u7684\u5b8c\u5168\u5907\u4efd\u4e0e\u6700\u8fd1\u7684\u4e00\u6b21\u5dee\u5f02\u5907\u4efd\u3002</p> <p></p> <p>6-3 \u589e\u91cf\u5907\u4efd</p> <p>\u53ea\u6709\u90a3\u4e9b\u5728\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u6216\u8005\u589e\u91cf\u5907\u4efd\u540e\u88ab\u4fee\u6539\u7684\u6587\u4ef6\u624d\u4f1a\u88ab\u5907\u4efd\u3002</p> <p>\u4ee5\u4e0a\u6b21\u5b8c\u6574\u5907\u4efd\u6216\u4e0a\u6b21\u7684\u589e\u91cf\u5907\u4efd \u7684\u65f6\u95f4\u4e3a\u65f6\u95f4\u70b9\uff0c\u4ec5\u5907\u4efd\u8fd9\u4e4b\u95f4\u7684\u6570\u636e\u53d8\u5316\uff0c\u56e0\u800c\u5907\u4efd\u7684\u6570\u636e\u91cf\u5c0f\uff0c\u5360\u7528\u7a7a\u95f4\u5c0f\uff0c\u5907\u4efd\u901f\u5ea6\u5feb\u3002</p> <p>\u4f46\u6062\u590d\u65f6\uff0c\u9700\u8981\u4ece\u4e0a\u4e00\u6b21\u7684\u5b8c\u6574\u5907\u4efd\u8d77\u5230\u6700\u540e\u4e00\u6b21\u589e\u91cf\u5907\u4efd\u4f9d\u6b21\u6062\u590d\uff0c\u5982\u4e2d\u95f4\u67d0\u6b21\u7684\u5907\u4efd\u6570\u636e\u635f\u574f\uff0c\u5c06\u5bfc\u81f4\u6570\u636e\u7684\u4e22\u5931\u3002</p> <p></p>"},{"location":"db_ops/12db_mysqldump/","title":"\u7b2c\u5341\u4e8c\u8282 MySQL\u903b\u8f91\u5907\u4efdmysqldump","text":""},{"location":"db_ops/12db_mysqldump/#mysqldump","title":"\u4e00\u3001mysqldump \u7b80\u4ecb","text":"<p>mysqldump \u662f MySQL \u81ea\u5e26\u7684\u903b\u8f91\u5907\u4efd\u5de5\u5177\u3002\u53ef\u4ee5\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\u548c\u670d\u52a1\u7684\u53ef\u7528\u6027\u3002</p> <p>\u5b83\u7684\u5907\u4efd\u539f\u7406\u662f\u901a\u8fc7\u534f\u8bae\u8fde\u63a5\u5230 MySQL \u6570\u636e\u5e93\uff0c\u5c06\u9700\u8981\u5907\u4efd\u7684\u6570\u636e\u67e5\u8be2\u51fa\u6765\uff0c\u5c06\u67e5\u8be2\u51fa\u7684\u6570\u636e\u8f6c \u6362\u6210\u5bf9\u5e94\u7684 insert \u8bed\u53e5\uff0c\u5f53\u6211\u4eec\u9700\u8981\u8fd8\u539f\u8fd9\u4e9b\u6570\u636e\u65f6\uff0c\u53ea\u8981\u6267\u884c\u8fd9\u4e9b insert \u8bed\u53e5\uff0c\u5373\u53ef\u5c06\u5bf9\u5e94\u7684 \u6570\u636e\u8fd8\u539f\u3002</p>"},{"location":"db_ops/12db_mysqldump/#_1","title":"\u4e8c\u3001\u5907\u4efd\u547d\u4ee4","text":""},{"location":"db_ops/12db_mysqldump/#1","title":"1\u3001\u547d\u4ee4\u683c\u5f0f","text":"<pre><code>mysqldump [\u9009\u9879] \u6570\u636e\u5e93\u540d [\u8868\u540d] &gt; \u811a\u672c\u540d\n</code></pre> <p>\u6216</p> <pre><code>mysqldump [\u9009\u9879] --\u6570\u636e\u5e93\u540d [\u9009\u9879 \u8868\u540d] &gt; \u811a\u672c\u540d\n</code></pre> <p>\u6216</p> <pre><code>mysqldump [\u9009\u9879] --all-databases [\u9009\u9879] &gt; \u811a\u672c\u540d\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#2","title":"2\u3001\u9009\u9879\u8bf4\u660e","text":""},{"location":"db_ops/12db_mysqldump/#3","title":"3\u3001\u5907\u4efd\u5b9e\u4f8b","text":"<p>\u5907\u4efd\u6240\u6709\u6570\u636e\u5e93\uff1a</p> <pre><code># mysqldump -uroot -p --all-databases &gt; \n/backup/mysqldump/all.db\n</code></pre> <p>\u5907\u4efd\u6307\u5b9a\u6570\u636e\u5e93\uff1a</p> <pre><code># mysqldump -uroot -p test &gt; /backup/mysqldump/test.db\n</code></pre> <p>\u5907\u4efd\u6307\u5b9a\u6570\u636e\u5e93\u6307\u5b9a\u8868(\u591a\u4e2a\u8868\u4ee5\u7a7a\u683c\u95f4\u9694)</p> <pre><code># mysqldump -uroot -p mysql db event &gt; \n/backup/mysqldump/2table.db\n</code></pre> <p>\u5907\u4efd\u6307\u5b9a\u6570\u636e\u5e93\u6392\u9664\u67d0\u4e9b\u8868</p> <pre><code># mysqldump -uroot -p test --ignore-table=test.t1 --ignoretable=test.t2 &gt; /backup/mysqldump/test2.db\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#4","title":"4\u3001\u8fd8\u539f\u547d\u4ee4","text":"<p>1 \u7cfb\u7edf\u884c\u547d\u4ee4</p> <pre><code># mysqladmin -uroot -p create db_name \n# mysql -uroot -p db_name &lt; /backup/mysqldump/db_name.db\n</code></pre> <p>\u5728\u5bfc\u5165\u5907\u4efd\u6570\u636e\u5e93\u524d\uff0c<code>db_name</code>\u5982\u679c\u6ca1\u6709\uff0c\u662f\u9700\u8981\u521b\u5efa\u7684\uff1b\u800c\u4e14\u4e0e<code>db_name.db</code>\u4e2d\u6570\u636e\u5e93\u540d\u662f\u4e00 \u6837\u7684\u624d\u53ef\u4ee5\u5bfc\u5165\u3002</p> <p>2 soure \u65b9\u6cd5</p> <pre><code>mysql &gt; use db_name\nmysql &gt; source /backup/mysqldump/db_name.db\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#mysql","title":"\u4e09\u3001MySQL \u903b\u8f91\u5907\u4efd","text":""},{"location":"db_ops/12db_mysqldump/#1mysql","title":"1\u3001MySQL \u73af\u5883","text":"<p>mysql: 5.7.28</p>"},{"location":"db_ops/12db_mysqldump/#2_1","title":"2\u3001\u5b8c\u6574\u5907\u4efd\u4e0e\u6062\u590d","text":"<p>1)\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\u5f00\u542f\u4e8c\u8fdb\u5236\u65e5\u5fd7</p> <pre><code># vim /etc/my.cnf\n[mysqld]\nbasedir=/soft/mysql\ndatadir=/soft/mysql/data\ndefault_password_lifetime=0\nserver-id = 2                   # id\u662f\u505a\u6807\u8bc6\uff0c\u968f\u4fbf\u586b\u5199\nlog-bin=/var/log/mysql/bin-log  # \u8bbe\u7f6e\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5b58\u653e\u7684\u4f4d\u7f6e\n</code></pre> <p>2)\u521b\u5efa\u5b58\u653e\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u7684\u76ee\u5f55\u5e76\u8d4b\u6743\u9650</p> <pre><code># mkdir -p /var/log/mysql \n# chown -R mysql:mysql /var/log/mysql\n</code></pre> <p>3)\u521b\u5efa\u5168\u91cf\u5907\u4efd\u6587\u4ef6\u5b58\u653e\u76ee\u5f55\u5e76\u8d4b\u6743\u9650</p> <pre><code># mkdir /backup/mysql -p\n# chown -R mysql:mysql /backup/mysql/\n</code></pre> <p>4)\u91cd\u542f\u6570\u636e\u5e93</p> <pre><code># systemctl restart mysqld\n</code></pre> <p>5)\u8fdb\u5165mysqld\u521b\u5efa\u4e00\u4e2a\u6570\u636e\u5e93 test1</p> <p>```]# mysql -uroot -hlocalhost -p'\u2018Qfedu.123com\u2019' mysql&gt; create database test1; mysql&gt; show databases; +--------------------+ | Database           | +--------------------+ | information_schema | | mysql             | | performance_schema | | sys               | | test1             | +--------------------+</p> <pre><code>\n**6)\u8fdb\u884c\u5168\u91cf\u5907\u4efd**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#mysqldump-uroot-hlocalhost-pqfedu123com-p3306-alldatabases-triggers-routines-events-single-transaction-master-data1-","title":"mysqldump -uroot -hlocalhost -p'Qfedu.123com' -P3306 --alldatabases --triggers --routines --events --single-transaction --master-data=1 --","text":"<p>flush-logs --set-gtid-purged=OFF &gt; /backup/mysql/$(date +%F%H)-mysql-all.sql</p> <pre><code>\n**7)\u5220\u9664\u6570\u636e\u5e93\u6587\u4ef6**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#systemctl-stop-mysqld","title":"systemctl stop mysqld","text":""},{"location":"db_ops/12db_mysqldump/#rm-rf-varlibmysql","title":"rm -rf /var/lib/mysql/*","text":"<pre><code>\n**8)\u5411\u5168\u91cf\u5907\u4efd\u6587\u4ef6\u91cc\u9762\u8ffd\u52a0\u4e0d\u8bb0\u5f55\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u547d\u4ee4**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#sed-i-23a-set-sql_log_bin0-backupmysql2019-11-2810-mysql-allsql","title":"sed -i '23a SET sql_log_bin=0;' /backup/mysql/2019-11-2810-mysql-all.sql","text":"<pre><code>\n\u5411\u5168\u91cf\u5907\u4efd\u6587\u4ef6\u91cc\u9762\u8ffd\u52a0\u4e0d\u8bb0\u5f55\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u547d\u4ee4\u7684\u539f\u56e0\u662f\u56e0\u4e3a\u6211\u4eec\u5728\u6062\u590d\u7684\u65f6\u5019\u8981\u91cd\u65b0\u6267\u884c\u4e00\u6b21 SQL\u8bed\u53e5\uff0c\u8fd9\u4e2a\u8bed\u53e5\u6ca1\u6709\u8bb0\u5f55\u7684\u5fc5\u8981\uff0c\u5982\u679c\u8bb0\u5f55\u7684\u8bdd\u8fd8\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6062\u590d\u5931\u8d25\u3002\n\n\n**9)\u91cd\u542f\u521d\u59cb\u5316\u6570\u636e\u5e93\u3001\u542f\u52a8\u6570\u636e\u5e93\u3001\u5e76\u4fee\u6539\u5bc6\u7801**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#systemctl-restart-mysqld","title":"systemctl restart mysqld","text":""},{"location":"db_ops/12db_mysqldump/#mysql-uroot-hlocalhost-pqfedu123com","title":"mysql -uroot -hlocalhost -p'\u2018Qfedu.123com\u2019'","text":""},{"location":"db_ops/12db_mysqldump/#grep-temporary-password-varlogmysqldlog","title":"grep 'temporary password' /var/log/mysqld.log","text":""},{"location":"db_ops/12db_mysqldump/#mysql-u-root-pu0ln8leue","title":"mysql -u root -p'U0ln8LE!ue=#'","text":"<p>mysql&gt; alter user 'root'@'localhost' identified by 'Qfedu.123com'; mysql&gt; show databases; +--------------------+ | Database           | +--------------------+ | information_schema | | mysql             | | performance_schema | | sys               | +--------------------+</p> <pre><code>\n\u7531\u4e8e\u8fd9\u662f\u4e00\u4e2a\u65b0\u7684\u6570\u636e\u5e93\uff0c\u91cc\u9762\u53ea\u6709\u9ed8\u8ba4\u7684\u5e93\uff0c\u5e76\u6ca1\u6709 test1 \u6570\u636e\u5e93\u3002\n\n**10)\u5bfc\u5165\u5168\u5907\u7684\u6570\u636e**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#mysql-u-root-pqfedu123com-backupmysql2019-11-2810-mysql-allsql","title":"mysql -u root -p'Qfedu.123com' &lt; /backup/mysql/2019-11-2810-mysql-all.sql","text":""},{"location":"db_ops/12db_mysqldump/#mysql-uroot-pqfedu123com","title":"mysql -uroot -p'Qfedu.123com'","text":"<p>mysql&gt;  set  sql_log_bin=1; Query OK, 0 rows affected (0.00 se mysql&gt; show databases; +--------------------+ | Database           | +--------------------+ | information_schema | | mysql             | | performance_schema | | sys               | | test1             | +--------------------+</p> <pre><code>\n\u5728\u6570\u636e\u5e93\u5185\u90e8\u4e5f\u53ef\u4ee5\u8fdb\u884c\u6062\u590d\n\n</code></pre> <p>mysql&gt; set sql_log_bin=0; mysql&gt; source /backup/mysql/2019-11-2810-mysql-all.sql mysql&gt;  set sql_log_bin=1; Query OK, 0 rows affected (0.00 se</p> <pre><code>\n\u5bfc\u5165\u4e4b\u540e\u5f53\u524d\u7684\u5bc6\u7801\u4f1a\u4e0d\u53d8\uff0c\u5f53\u8fdb\u5165\u6570\u636e\u5e93 flush privileges \u4e4b\u540e\uff0c\u5bc6\u7801\u53c8\u6062\u590d\u5230\u5907\u4efd\u65f6\u7684\u5bc6\u7801\n\n</code></pre> <p>mysql&gt; flush privileges</p> <pre><code>\n### **3\u3001\u589e\u91cf\u5907\u4efd\u4e0e\u6062\u590d**\n\n\u5907\u4efd\u4e0e\u6062\u590d\u73af\u5883 \n\n\u6570\u636e\u5e93\u5b8c\u6574\u5907\u4efd+\u6570\u636e\u5e93\u589e\u91cf\u5907\u4efd\n\n\u65b0\u5efa\u6570\u636e\u8868, \u8fdb\u884c\u5168\u91cf\u5907\u4efd, \u968f\u7740\u65f6\u95f4\u63a8\u79fb, \u6570\u636e\u5e93\u7a81\u7136\u5954\u6e83\n\n**1)\u5907\u4efd\u4e4b\u524d**\n\n</code></pre> <p>mysql&gt; create database test2; mysql&gt; create table test2.t1 (id int,name varchar(20)); mysql&gt; insert into test2.t1 values (1,\"test21\"); mysql&gt; insert into test2.t1 values (2,\"test22\"); mysql&gt; select * from test2.t1; +------+--------+ | id   | name   | +------+--------+ |    1 | test21 | |    2 | test22 | +------+--------+ 2 rows in set (0.00 sec)</p> <pre><code>\n\n**2)\u57fa\u4e8e\u5f53\u524d\u72b6\u6001\u505a\u4e00\u6b21\u5168\u5907**\n\n</code></pre> <p>[root@localhost ~]# mysqldump -uroot -hlocalhost -p'Qfedu.123com' -P3306 --alldatabases --triggers --routines --events --single-transaction --master-data=1 -- flush-logs --set-gtid-purged=OFF &gt; /backup/mysql/$(date +%F%H)-mysql-all.sql</p> <pre><code>\n**3)\u8fdb\u5165\u6570\u636e\u5e93\u518d\u63d2\u5165\u6570\u636e**\n\n</code></pre> <p>mysql&gt; insert into test2.t1 values (3,\"test23\"); mysql&gt; insert into test2.t1 values (5,\"tt\"); mysql&gt; select * from test2.t1; +------+--------+ | id   | name   | +------+--------+ |    1 | test21 | |    2 | test22 | |    3 | test23 | |    5 | tt     | +------+--------+ 4 rows in set (0.00 sec)</p> <pre><code>\n**4)\u6a21\u62df\u6570\u636e\u5e93\u5d29\u6e83**\n\n\u91cd\u542f\u521d\u59cb\u5316\uff0c\u542f\u52a8\u6570\u636e\u5e93,\u66f4\u6539\u9ed8\u8ba4\u5bc6\u7801\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#systemctl-stop-mysqld_1","title":"systemctl stop mysqld","text":""},{"location":"db_ops/12db_mysqldump/#rm-rf-varlibmysql_1","title":"rm -rf /var/lib/mysql/*","text":""},{"location":"db_ops/12db_mysqldump/#systemctl-start-mysqld","title":"systemctl start mysqld","text":""},{"location":"db_ops/12db_mysqldump/#grep-temporary-password-varlogmysqldlog_1","title":"grep 'temporary password' /var/log/mysqld.log","text":""},{"location":"db_ops/12db_mysqldump/#mysql-u-root-pu0ln8leue_1","title":"mysql -u root -p'U0ln8LE!ue=#'","text":"<p>mysql&gt; alter user 'root'@'localhost' identified by 'Qfedu.123com'; mysql&gt; \\q ]# mysql -uroot -p'Qfedu.123com' mysql&gt; show databases; +--------------------+ | Database           | +--------------------+ | information_schema | | mysql             | | performance_schema | | sys               | +--------------------+ 4 rows in set (0.00 sec)</p> <pre><code>\n**5)\u6062\u590d\u5168\u91cf\u6570\u636e**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#sed-i-23aset-sql_log_bin0-backupmysql2019-11-2810-mysql-allsql","title":"sed -i \"23aSET sql_log_bin=0;\" /backup/mysql/2019-11-2810-mysql-all.sql","text":""},{"location":"db_ops/12db_mysqldump/#mysql-uroot-pqfedu123com-backupmysql2019-11-2810-mysql-allsql","title":"mysql -uroot -p'Qfedu.123com' &lt; /backup/mysql/2019-11-2810-mysql-all.sql","text":""},{"location":"db_ops/12db_mysqldump/#mysql-u-root-pqfedu123com-e-select-from-test2t1","title":"mysql -u root -p'Qfedu.123com' -e \"select * from test2.t1\"","text":"<p>+------+--------+ | id   | name   | +------+--------+ |    1 | test21 | |    2 | test22 | +------+--------+</p> <pre><code>\n**6)\u6062\u590d\u589e\u91cf\u5907\u4efd** \n\n\u83b7\u53d6\u5168\u5907\u622a\u81f3\u70b9\n\n\u67e5\u770b\u4e00\u4e0b\u5168\u91cf\u5907\u4efd\uff0c\u5907\u4efd\u5230\u54ea\u4e2a\u70b9\u4e86\uff0c\u5982\u4e0b\u6240\u793a\u662f154\u8fd9\u4e2a\u70b9\uff0c000001\u8fd9\u4e2a\u65e5\u5fd7\u6587\u4ef6**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#sed-n-22p-backupmysql2019-11-2810-mysql-allsql","title":"sed -n '22p' /backup/mysql/2019-11-2810-mysql-all.sql","text":"<p>CHANGE MASTER TO MASTER_LOG_FILE='bin-log.000001', MASTER_LOG_POS=154;</p> <pre><code>\n\u5168\u91cf\u4ec5\u5907\u4efd\u5230\u4e86154\u8fd9\u4e2a\u70b9\uff0c154\u540e\u9762\u7684\u70b9\u5168\u5907\u6587\u4ef6\u91cc\u9762\u5c31\u6ca1\u6709\u4e86\uff0c\u9700\u8981\u53bb`000002`\u4ee5\u540e\u7684\u4e8c\u8fdb\u5236\u6587 \u4ef6\u91cc\u9762\u627e\n\n\n\u6839\u636e `MASTER_LOG_POS `\u6062\u590d\u589e\u91cf\u7684\u6570\u636e\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#pwd","title":"pwd","text":"<p>/log/mysql</p>"},{"location":"db_ops/12db_mysqldump/#mysqlbinlog-start-position154-bin-log000001-binlog000002-bin-log000003-bin-log000003-mysql-uroot-pqfedu123com","title":"mysqlbinlog --start-position=154 bin-log.000001 binlog.000002 bin-log.000003 bin-log.000003 | mysql -uroot -pQfedu.123com;","text":"<p>[root@mysql02 ~]# mysql -u root -pQfedu.123com -e \"select * from test2.t1\" +------+--------+ | id   | name   | +------+--------+ |    1 | test21 | |    2 | test22 | |    3 | test23 | |    5 | tt     | +------+--------+</p> <pre><code>\n### **4\u3001\u8bef\u64cd\u4f5c\u5220\u9664\u4e86\u5e93\uff08\u7ec3\u4e60\uff09**\n\n\u65b0\u6765\u7684\u5f00\u53d1\u5220\u4e86\u5e93\uff0c\u8fd9\u4ef6\u4e8b\u4e0d\u60f3\u518d\u56de\u5fc6\u4e86\uff0c\u4ee5\u540e\u6253\u6b7b\u4e5f\u4e0d\u4f1a\u628a\u6570\u636e\u5e93\u7684 root \u6743\u9650\u8f7b\u6613\u7ed9\u522b\u4eba\u4e86\u3002\u4eca\u5929\u628a\u5f53\u65f6\u7684\u573a\u666f\u7528\u865a\u62df\u673a\u8fd8\u539f\u4e00\u4e0b\uff0c\u7136\u540e\u590d\u73b0\u4e00\u4e0b\u6570\u636e\u6062\u590d\u7684\u8fc7\u7a0b\uff0c\u5c31\u5f53\u662f\u4e2a\u603b\u7ed3\u5427\uff01\u8bf4\u591a\u4e86\u90fd \u662f\u6cea\u554a~\n\n**1)\u6a21\u62df\u73af\u5883\u51c6\u5907**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#mysql-uroot-pqfedu123com_1","title":"mysql -uroot -p'Qfedu.123com'","text":"<p>mysql&gt; create database test2db; mysql&gt; use test2db; mysql&gt; create table t1 (id int,name varchar(20)); mysql&gt; insert into t1 values (1,\"ccr\"); mysql&gt; insert into t1 values (2,\"tfr\"); mysql&gt; select * from t1; +------+------+ | id   | name | +------+------+ |    1 | ccr | |    2 | tfr | +------+------+</p> <pre><code>\n**2)\u5168\u5907**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#mysqldump-uroot-hlocalhost-pqfedu123com-p3306-alldatabases-triggers-routines-events-single-transaction-master-data1-_1","title":"mysqldump -uroot -hlocalhost -p'Qfedu.123com' -P3306 --alldatabases --triggers --routines --events --single-transaction --master-data=1 --","text":"<p>flush-logs --set-gtid-purged=OFF &gt; /backup/mysql/$(date +%F%H)-mysql-all.sql</p> <pre><code>**3)\u518d\u6b21\u63d2\u5165\u6570\u636e**\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#mysql-uroot-pqfedu123com_2","title":"mysql -uroot -p'Qfedu.123com'","text":"<p>mysql&gt; insert into test2db.t1 values(3,'tr1'),(4,'zx'),(5,'wq'),(6,'tj'), (7,'gwt'); mysql&gt; select * from test2db.t1; +------+------+ | id   | name | +------+------+ |    1 | ccr | |    2 | tfr | |    3 | tr1 | |    4 | zx   | |    5 | wq   | |    6 | tj   | |    7 | gwt | +------+------+</p> <pre><code>\n**4)\u5f00\u53d1\u8bef\u64cd\u4f5c**\n\n</code></pre> <p>mysql&gt; delete from test2db.t1 where id = '2'; mysql&gt; drop database test2db;</p> <pre><code>\n**5)\u6062\u590d\u5168\u5907**\n\n</code></pre> <p>[root@mysql02 ~]# sed -i '23aSET sql_log_bin=0;' /backup/mysql/2019-11-2812-mysql-all.sql </p> <p>[root@mysql02 ~]# mysql -u root -p'Qfedu.123com' &lt; /backup/mysql/2019-11-2812-mysql-all.sql </p> <p>[root@mysql02 ~]# mysql -u root -p'Qfedu.123com' -e \"select * from test2db.t1\" +------+------+ | id   | name | +------+------+ |    1 | ccr | |    2 | tfr | +------+------+</p> <pre><code>\n**6)\u8df3\u8fc7 DELETE \u548c DROP \u8bed\u53e5**\n\n\u4e0b\u9762\u7684\u64cd\u4f5c\u5c31\u8981\u5c0f\u5fc3\u7ffc\u7ffc\u4e86\uff0c\u4e0d\u80fd\u4e00\u4e0b\u5b50\u628a\u4e8c\u8fdb\u5236\u65e5\u5fd7\u91cc\u9762\u5168\u5907\u4ee5\u540e\u7684\u64cd\u4f5c\u5168\u90e8\u6062\u590d\uff0c\u4e00\u65e6\u5168\u90e8\u6062 \u590d\u4e86\uff0c\u90a3\u5f00\u53d1\u5220\u9664\u64cd\u4f5c\u4e5f\u4f1a\u6062\u590d\uff0c\u6211\u4eec\u53ea\u80fd\u8df3\u8fc7\u8bef\u64cd\u4f5c\u7684\u5730\u65b9\u3002\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#sed-n-22p-backupmysql2019-11-2812-mysql-allsql","title":"sed -n '22p' /backup/mysql/2019-11-2812-mysql-all.sql","text":"<p>CHANGE MASTER TO MASTER_LOG_FILE='bin_log.000002', MASTER_LOG_POS=154;</p>"},{"location":"db_ops/12db_mysqldump/#ls-logmysql-bin_log000002","title":"ls /log/mysql/ #\u5168\u5907\u4e4b\u540e\u53ea\u6709\u4e00\u4e2a<code>bin_log.000002</code>\u4e8c\u8fdb\u7a0b\u65e5\u5fd7\u6587\u4ef6","text":"<p>]# mysql -u root -p'Qfedu.123com' mysql&gt; show binlog events in 'bin-log.000002'; +----------------+-----+----------------+-----------+-------------+------------- --------------------------+ | Log_name       | Pos | Event_type     | Server_id | End_log_pos | Info                                | +----------------+-----+----------------+-----------+-------------+------------- --------------------------+ | bin-log.000008 |   4 | Format_desc   |         2 |         123 | Server ver:  5.7.29-log, Binlog ver: 4 | | bin-log.000008 | 123 | Previous_gtids |         2 |         154 |                                      | | bin-log.000008 | 154 | Anonymous_Gtid |         2 |         219 | SET  @@SESSION.GTID_NEXT= 'ANONYMOUS' | | bin-log.000008 | 219 | Query         |         2 |         294 | BEGIN                                | | bin-log.000008 | 294 | Table_map     |         2 |         345 | table_id:  179 (test2db.t1)           | | bin-log.000008 | 345 | Write_rows     |         2 |         422 | table_id:  179 flags: STMT_END_F       | | bin-log.000008 | 422 | Xid           |         2 |         453 | COMMIT /  xid=980 /                 | | bin-log.000008 | 453 | Anonymous_Gtid |         2 |         518 | SET  @@SESSION.GTID_NEXT= 'ANONYMOUS' | | bin-log.000008 | 518 | Query         |         2 |         593 | BEGIN                                | | bin-log.000008 | 593 | Table_map     |         2 |         644 | table_id:  179 (test2db.t1)           | | bin-log.000008 | 644 | Delete_rows   |         2 |         688 | table_id:  179 flags: STMT_END_F       | | bin-log.000008 | 688 | Xid           |         2 |         719 | COMMIT /  xid=982 /                 | | bin-log.000008 | 719 | Anonymous_Gtid |         2 |         784 | SET  @@SESSION.GTID_NEXT= 'ANONYMOUS' | | bin-log.000008 | 784 | Query         |         2 |         885 | drop  database test2db                 | +----------------+-----+----------------+-----------+-------------+------------- --------------------------+</p>"},{"location":"db_ops/12db_mysqldump/#mysqlbinlog-start-position154-stop-position453-binlog000002-mysql-pqfedu1234com","title":"mysqlbinlog --start-position=154 --stop-position=453 binlog.000002 | mysql -p'Qfedu.1234com'","text":""},{"location":"db_ops/12db_mysqldump/#mysql-uroot-pqfedu123com-e-select-from-test2dbt1","title":"mysql -uroot -p'Qfedu.123com' -e \"select * from test2db.t1\"","text":"<p>+------+------+ | id   | name | +------+------+ |    1 | ccr | |    2 | tfr | |    3 | tr1 | |    4 | zx   | |    5 | wq   | |    6 | tj   | |    7 | gwt | +------+------+</p> <pre><code>\n\u6ce8\uff1a\u4e0a\u8ff0\u6848\u4f8b\u5728\u5168\u5907\u4e4b\u540e\u4ec5\u4ea7\u751f\u4e86\u591a\u4e2a\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u53ef\u8fdb\u884c\u5408\u5e76\u5904\u7406\n\n</code></pre>"},{"location":"db_ops/12db_mysqldump/#mysqlbinlog-base64-outputdecode-rows-v-bin_log000001-bin_log000002-test3sql","title":"mysqlbinlog --base64-output=\"decode-rows\" -v bin_log.000001 bin_log.000002 &gt; test3.sql","text":"<p>```</p>"},{"location":"db_ops/13db_xtrabackup/","title":"\u7b2c\u5341\u4e09\u8282 MySQL \u7269\u7406\u5907\u4efd xtrabackup","text":""},{"location":"db_ops/13db_xtrabackup/#xtrabackup","title":"\u4e00\u3001xtrabackup \u4ecb\u7ecd","text":"<p>Xtrabackup \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u514d\u8d39\u7684\u70ed\u5907\u5de5\u5177\uff0c\u5728 Xtrabackup \u5305\u4e2d\u4e3b\u8981\u6709 Xtrabackup \u548c innobackupex \u4e24\u4e2a\u5de5\u5177\u3002</p> <p>\u5176\u4e2d Xtrabackup \u53ea\u80fd\u5907\u4efd InnoDB \u548c XtraDB \u4e24\u79cd\u5f15\u64ce; innobackupex\u5219 \u662f\u5c01\u88c5\u4e86Xtrabackup\uff0c\u540c\u65f6\u589e\u52a0\u4e86\u5907\u4efdMyISAM\u5f15\u64ce\u7684\u529f\u80fd\u3002</p> <p>Xtrabackup\u5907\u4efd\u65f6\u4e0d\u80fd\u5907\u4efd\u8868\u7ed3\u6784\u3001\u89e6\u53d1\u5668\u7b49\u7b49\uff0c\u4e5f\u4e0d\u80fd\u667a\u80fd\u533a\u5206<code>.idb</code> \u6570\u636e\u6587\u4ef6\u3002</p> <p>\u53e6\u5916 innobackupex\u8fd8\u4e0d\u80fd\u5b8c\u5168\u652f\u6301\u589e\u91cf\u5907\u4efd\uff0c\u9700\u8981\u548cxtrabackup\u7ed3\u5408\u8d77\u6765\u5b9e\u73b0\u5168\u5907\u7684\u529f\u80fd\u3002</p>"},{"location":"db_ops/13db_xtrabackup/#xtrbackup","title":"\u4e8c\u3001xtrbackup \u5b89\u88c5","text":""},{"location":"db_ops/13db_xtrabackup/#1","title":"1\u3001\u4e0b\u8f7d\u5b89\u88c5\u5305","text":"<p>Xtrabackup \u4e0b\u8f7d\u5730\u5740 https://www.percona.com/downloads/ \u9009\u62e9\u81ea\u5df1\u7684\u7248\u672c\u4e0b\u8f7d\u3002</p> <p>https://www.percona.com/downloads/Percona-XtraBackup-2.4/Percona-XtraBackup-2.4.18/binary/redhat/7/x86_64/Percona-XtraBackup-2.4.18-r29b4ca5-el7-x86_64-bundle.tar </p> <p>\u4f9d\u8d56\u5305\u4e0b\u8f7d\uff0c\u4e0b\u8f7d\u5730\u5740 http://rpmfind.net/linux/atrpms/el6-x86_64/atrpms/stable/libev-4.04- 2.el6.x86_64.rpm\u3002</p>"},{"location":"db_ops/13db_xtrabackup/#2","title":"2\u3001\u89e3\u538b\u5b89\u88c5","text":"<pre><code># ls\nlibev-4.04-2.el6.x86_64.rpm Percona-XtraBackup-2.4.14-ref675d4-el7-x86_64-bundle.tar\n\n# rpm -ivh libev-4.04-2.el6.x86_64.rpm\nwarning: libev-4.04-2.el6.x86_64.rpm: Header V4 DSA/SHA1 Signature, key ID \n66534c2b: NOKEY\nPreparing...                          ################################# [100%]\nUpdating / installing...\n   1:libev-4.04-2.el6                 ################################# [100%]\n\n# tar -xf Percona-XtraBackup-2.4.14-ref675d4-el7-x86_64-bundle.tar\n\n# ls\nlibev-4.04-2.el6.x86_64.rpm\nPercona-XtraBackup-2.4.14-ref675d4-el7-x86_64-bundle.tar\npercona-xtrabackup-24-2.4.14-1.el7.x86_64.rpm\npercona-xtrabackup-24-debuginfo-2.4.14-1.el7.x86_64.rpm\npercona-xtrabackup-test-24-2.4.14-1.el7.x86_64.rpm\n\n# yum -y install percona-xtrabackup-24-2.4.14-\n1.el7.x86_64.rpm # \u8fd9\u91cc\u7528yum\u5b89\u88c5\uff0c\u56e0\u4e3a\u8fd8\u6709\u5176\u4ed6\u7684\u4f9d\u8d56\u5305\n</code></pre>"},{"location":"db_ops/13db_xtrabackup/#3","title":"3\u3001\u914d\u7f6e\u6587\u4ef6","text":"<p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6<code>/etc/my.cnf</code>\uff0c\u4fdd\u8bc1<code>[mysqld]</code>\u6a21\u5757\u5b58\u5728\u53c2\u6570<code>datadir=/var/lib/mysql</code>\uff08\u6307\u5411\u6570\u636e\u76ee \u5f55\uff09\uff0c\u56e0\u4e3a<code>xtrbackup</code>\u662f\u6839\u636e<code>/etc/my.cnf</code>\u914d\u7f6e\u6587\u4ef6\u6765\u83b7\u53d6\u9700\u8981\u5907\u4efd\u7684\u6587\u4ef6\u3002</p>"},{"location":"db_ops/13db_xtrabackup/#4mysqld","title":"4\u3001\u91cd\u542fmysqld","text":""},{"location":"db_ops/13db_xtrabackup/#xtrbackup_1","title":"\u4e09\u3001xtrbackup \u4f7f\u7528","text":"<p>\u4e00\u822c\u4f7f\u7528\u7684\u662f <code>innobackupex</code> \u811a\u672c\uff0c\u56e0\u4e3a <code>innobackupex</code> \u662f <code>perl</code> \u811a\u672c\u5bf9 <code>xtrbackup</code> \u7684\u5c01\u88c5\u548c\u529f\u80fd\u6269\u5c55\u3002</p>"},{"location":"db_ops/13db_xtrabackup/#1_1","title":"1\u3001\u7528\u6237\u6743\u9650\u8bf4\u660e","text":"<p>\u5907\u4efd\u6570\u636e\u5e93\u65f6\u4f1a\u6d89\u53ca\u5230\u4e24\u4e2a\u7528\u6237\uff1a\u7cfb\u7edf\u7528\u6237\u4e0e\u6570\u636e\u5e93\u5185\u90e8\u7684\u7528\u6237\u3002</p> <p>1)\u7cfb\u7edf\u7528\u6237</p> <p>\u9700\u8981\u5728 datadir\uff08\u914d\u7f6e\u6587\u4ef6\u5185\u8bbe\u7f6e\u7684\u76ee\u5f55\uff09\u4e0a\u5177\u6709\u8bfb\u5199\u6267\u884c\u6743\u9650\uff08rwx\uff09\u3002</p> <p>2)\u6570\u636e\u5e93\u5185\u90e8\u7528\u6237</p> <ul> <li><code>RELOAD</code> \u548c <code>LOCK TABLES</code> \u6743\u9650\uff0c\u6267\u884c <code>FLUSH TABLES WITH READ LOCK\uff1b</code></li> <li><code>REPLICATION CLIENT</code> \u6743\u9650\uff0c\u83b7\u53d6 <code>binary log</code>\uff08\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\uff09\u4f4d\u7f6e\uff1b</li> <li><code>CREATE TABLESPACE</code>\u6743\u9650\uff0c\u5bfc\u5165\u8868\uff0c\u7528\u6237\u8868\u7ea7\u522b\u7684\u6062\u590d\uff1b</li> <li>SUPER\u6743\u9650\uff0c\u5728slave\u73af\u5883\u4e0b\u5907\u4efd\u7528\u6765\u542f\u52a8\u548c\u5173\u95edslave\u7ebf\u7a0b\u3002</li> </ul>"},{"location":"db_ops/13db_xtrabackup/#2_1","title":"2\u3001\u5e38\u7528\u547d\u4ee4\u683c\u5f0f\u548c\u5e38\u7528\u53c2\u6570","text":"<p>1)\u547d\u4ee4\u683c\u5f0f\uff1a</p> <pre><code>innobackupex [\u53c2\u6570] [\u76ee\u7684\u5730\u5740|\u6e90\u5730\u5740]\n</code></pre> <p>2)\u5e38\u7528\u53c2\u6570</p> <pre><code>--user # \u4ee5\u4ec0\u4e48\u7528\u6237\u8eab\u4efd\u8fdb\u884c\u64cd\u4f5c\n--password   # \u6570\u636e\u5e93\u7528\u6237\u7684\u5bc6\u7801\n--port       # \u6570\u636e\u5e93\u7684\u7aef\u53e3\u53f7\uff0c\u9ed8\u8ba43306\n--stream   # \u6253\u5305\uff08\u6570\u636e\u6d41\uff09\n--defaults-file   # \u6307\u5b9a\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\uff0c\u9ed8\u8ba4\u8bfb\u53d6/etc/my.cnf\n--no-timestamp   # \u4e0d\u521b\u5efa\u65f6\u95f4\u6233\u6587\u4ef6\uff0c\u800c\u6539\u7528\u76ee\u7684\u5730\u5740\uff08\u53ef\u4ee5\u81ea\u52a8\u521b\u5efa\uff09\n--copy-back           # \u5907\u4efd\u8fd8\u539f\u7684\u4e3b\u8981\u9009\u9879\n--incremental         # \u4f7f\u7528\u589e\u91cf\u5907\u4efd\uff0c\u9ed8\u8ba4\u4f7f\u7528\u7684\u5b8c\u6574\u5907\u4efd\n--incremental-basedir # \u4e0e--incremental\u9009\u9879\u8054\u5408\u4f7f\u7528\uff0c\u8be5\u53c2\u6570\u6307\u5b9a\u4e0a\u4e00\u7ea7\u5907\u4efd\u7684\u5730\u5740\u6765\u505a\u589e\u91cf\u5907\u4efd\n</code></pre>"},{"location":"db_ops/13db_xtrabackup/#3xtrbackup","title":"3\u3001xtrbackup \u5b8c\u6574\u5907\u4efd\u548c\u8fd8\u539f","text":"<p>1)\u5b8c\u6574\u5907\u4efd</p> <pre><code># innobackupex --user=root --password=Qfedu.123com \n/backup/mysql/ # \u6709\u5927\u91cf\u8f93\u51fa\u5907\u4efd\u4fe1\u606f\n\n# innobackupex --user=root --password=Qfedu.123com \n/backup/mysql/ 2&gt;&gt;/backup/mysql/backup.log # \u5c06\u5907\u4efd\u8f93\u51fa\u4fe1\u606f\u4fdd\u5b58\u5230\u6587\u4ef6\n\n# ls /backup/mysql/\n2019-06-16_15-49-44  2019-06-16_15-51-23 backup.log\n\n# ls /backup/mysql/2019-06-16_15-49-44/\nbackup-my.cnf ibdata1 performance_schema xtrabackup_checkpoints \nxtrabackup_logfile ib_buffer_pool mysql sys xtrabackup_info\n\n# innobackupex --user=root --password=Qfedu.123com --notimestamp /backup/mysql/test/ 2&gt;&gt;/backup/mysql/backup.log \n# \u4e0d\u4f7f\u7528\u65f6\u95f4\u6233\u521b\u5efa\u76ee\u5f55\uff0c\u53ef\u81ea\u52a8\u521b\u5efa\u76ee\u7684\u5730\u5740\n\n ls /backup/mysql/\n2019-06-16_15-49-44  2019-06-16_15-51-23 backup.log test\n\n# ls /backup/mysql/test/\n2019-06-16_15-54-20\n\n# ls /backup/mysql/test/2019-06-16_15-54-20\nbackup-my.cnf   ibdata1 performance_schema xtrabackup_checkpoints \nxtrabackup_logfile\nib_buffer_pool mysql   sys                 xtrabackup_info\n</code></pre> <p>2)\u6570\u636e\u8fd8\u539f</p> <p>\u6ce8\u610f\uff1a<code>innobackupex-copy-back</code>\u4e0d\u4f1a\u8986\u76d6\u5df2\u5b58\u5728\u7684\u6587\u4ef6\u3002\u800c\u4e14\u8fd8\u539f\u65f6\u9700\u8981\u5148\u5173\u95ed\u670d\u52a1\uff0c\u5982\u679c\u670d\u52a1 \u662f\u542f\u52a8\u7684\uff0c\u90a3\u4e48\u5c31\u4e0d\u80fd\u8fd8\u539f\u5230 <code>datadir</code></p> <pre><code># systemctl stop mysqld\n# rm -rf /var/lib/mysql/*             # \u5371\u9669\u64cd\u4f5c\uff0c\u8bf7\u5728\u6d4b\u8bd5\u73af\u5883\u6d4b\u8bd5\n\n# innobackupex --copy-back /backup/mysql/2019-06-16_15-49-44/2&gt;&gt;/backup/mysql/copyback.log\n\n# ll /var/lib/mysql\n\u603b\u7528\u91cf 12324\n-rw-r----- 1 root root      292 6\u6708  16 17:08 ib_buffer_pool\n-rw-r----- 1 root root 12582912 6\u6708  16 17:08 ibdata1\ndrwxr-x--- 2 root root     4096 6\u6708  16 17:08 mysql\ndrwxr-x--- 2 root root     8192 6\u6708  16 17:08 performance_schema\ndrwxr-x--- 2 root root     8192 6\u6708  16 17:08 sys\n-rw-r----- 1 root root      423 6\u6708  16 17:08 xtrabackup_info\n\n# chown -R mysql:mysql /var/lib/mysql \n# \u91cd\u65b0\u6388\u6743\uff0c\u5426\u5219mysqld\u65e0\u6cd5\u542f\u52a8\n\n# systemctl start mysqld\n\n# mysql -uroot -pQfedu.123com\nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 2\nServer version: 5.7.26 MySQL Community Server (GPL)\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql             |\n| performance_schema |\n| sys               |\n+--------------------+\n4 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/13db_xtrabackup/#4xtrbackup","title":"4\u3001xtrbackup \u589e\u91cf\u5907\u4efd\u7684\u8fd8\u539f","text":"<p>\u589e\u91cf\u5907\u4efd\u7684\u5b9e\u73b0\uff0c\u4f9d\u8d56\u4e8einnodb \u9875\u4e0a\u9762\u7684 LSN\uff08log sequence number\uff09\uff0c\u6bcf\u6b21\u5bf9\u6570\u636e\u5e93\u7684\u4fee\u6539 \u90fd\u4f1a\u5bfc\u81f4 LSN \u81ea\u589e\u3002\u589e\u91cf\u5907\u4efd\u4f1a\u590d\u5236\u6307\u5b9a LSN&lt;\u65e5\u5fd7\u5e8f\u5217\u53f7&gt;\u4e4b\u540e\u7684\u6240\u6709\u6570\u636e\u9875\u3002</p> <p>1)\u67e5\u770b\u5b8c\u6574\u5907\u4efd\u7684LSN</p> <pre><code># innobackupex --user=root --password=Qfedu.123com \n/backup/mysql/\n\n# cat /backup/mysql/2020-03-12_16-45-17/xtrabackup_checkpoints\nbackup_type = full-backuped                          # \u4ee3\u8868\u5b8c\u6574\u5907\u4efd\nfrom_lsn = 0\nto_lsn = 2525919\nlast_lsn = 2525928\ncompact = 0\nrecover_binlog_info = 0\nflushed_lsn = 2525928\n</code></pre> <p>2)\u4ee5\u5168\u5907\u521b\u5efa\u589e\u91cf\u5907\u4efd</p> <p>\u521b\u5efa\u4e00\u4e9b\u6570\u636e\uff0c\u4ee5<code>2020-03-12_16-45-17</code>\u65f6\u95f4\u6233\u521b\u5efa\u7b2c\u4e00\u4e2a\u589e\u91cf\u5907\u4efd\uff0c\u5e76\u67e5\u770b LSN</p> <pre><code># mysql -uroot -pQfedu.123com\nmysql&gt; create database test_db;\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; use test_db;\nDatabase changed\nmysql&gt; create table user_tb(id int,name varchar(20));\nQuery OK, 0 rows affected (0.01 sec)\nmysql&gt; insert into user_tb values(1,'zhangsan');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; exit\nBye\n\n# innobackupex --user=root --password=Qfedu.123com --incremental /backup/mysql/ --incremental-basedir=/backup/mysql/2020-03-12_16-45-17/\n\n# innobackupex --user=root --password=Qfedu.123com --incremental --incremental-basedir=/backup/mysql/2020-03-12_16-45-17/ /backup/mysql/ 2&gt;&gt;/backup/mysql/backup.log\n\n# cat /backup/mysql/2020-03-12_16-48-08/xtrabackup_checkpoints\nbackup_type = incremental # \u8868\u793a\u589e\u91cf\u5907\u4efd\nfrom_lsn = 2525919\nto_lsn = 2530689\nlast_lsn = 2530698\ncompact = 0\nrecover_binlog_info = 0\nflushed_lsn = 2530698\n</code></pre> <p>3)\u6062\u590d\u6570\u636e\u51c6\u5907\u5168\u91cf\u5907\u4efd</p> <pre><code># innobackupex --apply-log --redo-only /backup/mysql/2020-03-12_16-45-17/ 2&gt;&gt;/backup/mysql/copyback.log\n</code></pre> <p>4)\u5e94\u7528\u7b2c\u4e00\u6b21\u589e\u91cf\u5907\u4efd\u5230\u5168\u91cf\u5907\u4efd</p> <pre><code># innobackupex --apply-log --redo-only /backup/mysql/2020-03-12_16-45-17/ --incremental-dir=/backup/mysql/2020-03-12_16-48-08 2&gt;&gt;/backup/mysql/copyback.log\n</code></pre> <p>5)\u67e5\u770b\u5168\u91cf\u5907\u4efd\u7684 <code>xtrabackup_checkpoints</code></p> <pre><code>#cat /backup/mysql/2019-06-16_15-49-44/xtrabackup_checkpoints\n</code></pre> <p>\u5bf9\u6bd4\u4e4b\u524d\u67e5\u770b\u7684\u7b2c\u4e00\u6b21\u589e\u91cf\u5907\u4efd\u7684 <code>last_lsn</code> \u4f4d\u7f6e\uff0c\u5728\u5e94\u7528\u7b2c\u4e00\u6b21\u589e\u91cf\u5907\u4efd\u5230\u5168\u91cf\u540e\uff0c\u53ef\u4ee5\u770b\u5230 <code>last_lsn</code> \u5df2\u7ecf\u88ab\u5e94\u7528\u548c\u7b2c\u4e00\u6b21\u5168\u91cf\u5907\u4efd\u7684\u4f4d\u7f6e\u76f8\u540c\u4e86</p> <p>6)\u628a\u5907\u4efd\u6574\u4f53\u8fdb\u884c\u4e00\u6b21apply\u64cd\u4f5c</p> <pre><code># innobackupex --apply-log /backup/mysql/2020-03-12_16-45-17/ 2&gt;&gt;/backup/mysql/copyback.log\n</code></pre> <p>7)\u505c\u6b62 mysql \u670d\u52a1\u5e76\u79fb\u9664\u6570\u636e\u76ee\u5f55\uff08\u751f\u4ea7\u73af\u5883\u5efa\u8bae\u7528 mv \uff09</p> <pre><code># systemctl stop mysqld\n# rm -rf /var/lib/mysql/* # \u5371\u9669\u64cd\u4f5c\u5efa\u8bae\u7528 mv\n</code></pre> <p>8)\u4f7f\u7528<code>--copy-back</code> \u53c2\u6570\u6062\u590d\u62f7\u8d1d\u5230data\u76ee\u5f55</p> <pre><code># innobackupex --copy-back /backup/mysql/2020-03-12_16-45-17/ 2&gt;/backup/mysql/copyback.log\n</code></pre> <p>9)\u9a8c\u8bc1\u6570\u636e\u8fd8\u539f</p> <pre><code># ls -l /var/lib/mysql\n</code></pre> <p>10)\u6388\u6743\u5e76\u542f\u52a8MySQL</p> <pre><code># ls -l /var/lib/mysql\n</code></pre> <p>11)\u9a8c\u8bc1\u6570\u636e\u5b8c\u6574\u6027</p> <pre><code>]# mysql -uroot -pQfedu.123com\nmysql&gt; use test_db;\nReading table information for completion of table and column names\nYou can turn off this feature to get a quicker startup with -A\nDatabase changed\nmysql&gt; select * from user_tb;\n+------+----------+\n| id   | name     |\n+------+----------+\n| 1   | zhangsan |\n| 2   | lisi     |\n+------+----------+\n2 rows in set (0.00 sec)\n</code></pre> <ul> <li>1\uff09\u589e\u91cf\u5907\u4efd\u9700\u8981\u4f7f\u7528\u53c2\u6570<code>--incremental</code>\u6307\u5b9a\u9700\u8981\u5907\u4efd\u5230\u54ea\u4e2a\u76ee\u5f55\uff0c\u4f7f\u7528<code>incremental-dir</code>\u6307\u5b9a\u5168\u5907\u76ee \u5f55\uff1b</li> <li>2\uff09\u8fdb\u884c\u6570\u636e\u5907\u4efd\u65f6\uff0c\u9700\u8981\u4f7f\u7528\u53c2\u6570<code>--apply-log redo-only</code>\u5148\u5408\u5e76\u5168\u5907\u6570\u636e\u76ee\u5f55\u6570\u636e\uff0c\u786e\u4fdd\u5168\u5907\u6570\u636e\u76ee \u5f55\u6570\u636e\u7684\u4e00\u81f4\u6027\uff1b</li> <li>3\uff09\u518d\u5c06\u589e\u91cf\u5907\u4efd\u6570\u636e\u4f7f\u7528\u53c2\u6570<code>--incremental-dir</code>\u5408\u5e76\u5230\u5168\u5907\u6570\u636e\u5f53\u4e2d\uff1b</li> <li>4\uff09\u6700\u540e\u901a\u8fc7\u6700\u540e\u7684\u5168\u5907\u6570\u636e\u8fdb\u884c\u6062\u590d\u6570\u636e\uff0c\u6ce8\u610f\uff0c\u5982\u679c\u6709\u591a\u4e2a\u589e\u91cf\u5907\u4efd\uff0c\u9700\u8981\u9010\u4e00\u5408\u5e76\u5230\u5168\u5907\u6570\u636e\u5f53\u4e2d\uff0c\u518d\u8fdb\u884c\u6062\u590d\u3002</li> </ul>"},{"location":"db_ops/13db_xtrabackup/#5xtrbackup","title":"5\u3001xtrbackup \u6570\u636e\u6d41\u538b\u7f29","text":"<p><code>-stream</code> \u9009\u9879 </p> <p>\u6ce8\u610f\uff1a\u4f7f\u7528<code>--stream</code>\u9009\u9879\u65f6\uff0c\u4f1a\u8f93\u51fa\u6253\u5305\u7684\u6570\u636e\u6d41\uff0c\u5e76\u4e0d\u4f1a\u76f4\u63a5\u751f\u6210\u6253\u5305\u6587\u4ef6\uff0c\u6b64\u65f6\u9700\u8981\u4f7f\u7528\u91cd\u5b9a \u5411\u6216\u5176\u4ed6\u547d\u4ee4\u5bf9\u6570\u636e\u6d41\u8fdb\u884c\u5904\u7406\u3002</p> <p>1)\u4f7f\u7528\u91cd\u5b9a\u5411\u751f\u6210\u538b\u7f29\u6587\u4ef6</p> <p>\u5c06\u6807\u51c6\u8f93\u51fa\u91cd\u5b9a\u5411\u4e3atar\u6587\u4ef6\uff0c\u5c06\u6807\u51c6\u9519\u8bef\u91cd\u5b9a\u5411\u5230\u65e5\u5fd7\u6587\u4ef6</p> <pre><code># innobackupex --databases=test_db --user=root --\npassword=Qfedu.123com --stream=tar /backup/mysql/&gt; /backup/mysql/`date +%F`.tar 2&gt; /backup/mysql/backup.log\n\n# ls //backup/mysql/\n2019-09-29.tar backup.log\n\n# cd //backup/mysql/\n\n# mkdir test_db.bak\n\n# tar xf 2019-09-29.tar -C ./test_db.bak     \n# \u6ce8\u610f: \u89e3\u538b\u65f6\u6307\u5b9a\u89e3\u538b\u76ee\u5f55\uff0c\u538b\u7f29\u4e2d\u6ca1\u6709\u5f52\u6863\u76ee\u5f55\n\n# ls test_db.bak\nib_buffer_pool xtrabackup_binlog_info xtrabackup_logfile\nbackup.log     ibdata1         xtrabackup_checkpoints\nbackup-my.cnf   test_db         xtrabackup_info\n</code></pre> <p>2)\u4f7f\u7528 ssh \u548c cat \u7ec4\u5408\u547d\u4ee4\uff0c\u76f4\u63a5\u5907\u4efd\u5230\u5176\u4ed6\u670d\u52a1\u5668\u4e0a</p> <pre><code># ssh-keygen\n\n# ssh-copy-id 192.168.5.70\n\n# ssh root@192.168.5.70 \"mkdir /backup/mysql\"\n\n# innobackupex --databases=test_db --user=root --\npassword=Qfedu.123com --stream=tar 2&gt;/backup/mysql/backup.log | ssh \nroot@192.168.5.70 \"cat - &gt; /backup/mysql/`date +%F`.tar \"\n\n# ssh 192.168.5.70\n\n# ls /backup/mysql   # \u67e5\u770b\u5907\u4efd\u6587\u4ef62019-09-29.tar  \n\n# mkdir /backup/mysql/test_db.bak\n\n# tar xf /2019-09-29.tar -C /backup/mysql/test_db.bak/ # \u89e3\u538b\u67e5\u770b\u89e3\u538b\u7ed3\u679c\n\n# ls /backup/mysql/test_db.bak\nbackup-my.cnf   ibdata1 xtrabackup_binlog_info xtrabackup_info\nib_buffer_pool test_db xtrabackup_checkpoints xtrabackup_logfile\n\n# exit\n</code></pre> <p>3)\u4f7f\u7528 gzip \u518d\u538b\u7f29\u4e00\u4e0b</p> <pre><code># rm -rf /backup/mysql/*\n\n# innobackupex --databases=test_db --user=root --password=Qfedu.123com --stream=tar /backup/mysql/ 2&gt;/backup/mysql/backup.log |  gzip &gt; /backup/mysql/`date +%F`.tar.gz\n\n# ls /backup/mysql/\n2019-09-29.tar.gz backup.log\n\n# mkdir /backup/mysql/test_db.bak\n\n# tar zxf /backup/mysql/2019-09-29.tar.gz -C \n/backup/mysql/test_db.bak\n\n# ls /backup/mysql/test_db.bak     # \u89e3\u538b\u67e5\u770b\nib_buffer_pool     xtrabackup_binlog_info xtrabackup_logfile\nbackup.log         ibdata1         xtrabackup_checkpoints\nbackup-my.cnf     test_db         xtrabackup_info\n</code></pre>"},{"location":"db_ops/14mysql_replicate/","title":"\u7b2c\u5341\u56db\u8282 MySQL \u4e3b\u4ece\u590d\u5236\u539f\u7406\u4ecb\u7ecd","text":""},{"location":"db_ops/14mysql_replicate/#1mysql","title":"1\u3001MySQL \u5f02\u6b65\u548c\u534a\u540c\u6b65\u590d\u5236","text":"<p>\u4f20\u7edf\u7684 MySQL \u590d\u5236\u63d0\u4f9b\u4e86\u4e00\u79cd\u7b80\u5355\u7684\u4e3b\u2013\u4ece\u590d\u5236\u65b9\u6cd5\u3002</p> <p>\u6709\u4e00\u4e2a\u4e3b\uff0c\u4ee5\u53ca\u4e00\u4e2a\u6216\u591a\u4e2a\u4ece\u3002</p> <p>\u4e3b\u8282\u70b9\u6267\u884c\u548c\u63d0\u4ea4\u4e8b\u52a1\uff0c\u7136\u540e\u5c06\u5b83\u4eec\uff08\u5f02\u6b65\u5730\uff09\u53d1\u9001\u5230\u4ece\u8282\u70b9\uff0c\u4ee5\u91cd\u65b0\u6267\u884c\uff08\u5728\u57fa\u4e8e\u8bed\u53e5\u7684\u590d\u5236\u4e2d\uff09\u6216\u5e94\u7528\uff08\u5728 \u57fa\u4e8e\u884c\u7684\u590d\u5236\u4e2d\uff09\u3002</p> <p>\u8fd9\u662f\u4e00\u4e2a <code>shared-nothing</code> \u7684\u7cfb\u7edf\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u6240\u6709 server \u6210\u5458\u90fd\u6709\u4e00\u4e2a\u5b8c\u6574\u7684 \u6570\u636e\u526f\u672c</p> <p></p> <p>\u8fd8\u6709\u4e00\u4e2a\u534a\u540c\u6b65\u590d\u5236\uff0c\u5b83\u5728\u534f\u8bae\u4e2d\u6dfb\u52a0\u4e86\u4e00\u4e2a\u540c\u6b65\u6b65\u9aa4\u3002\u8fd9\u610f\u5473\u7740\u4e3b\u8282\u70b9\u5728\u63d0\u4ea4\u65f6\u9700\u8981\u7b49\u5f85\u4ece\u8282\u70b9 \u786e\u8ba4\u5b83\u5df2\u7ecf\u63a5\u6536\u5230\u4e8b\u52a1\u3002\u53ea\u6709\u8fd9\u6837\uff0c\u4e3b\u8282\u70b9\u624d\u80fd\u7ee7\u7eed\u63d0\u4ea4\u64cd\u4f5c\u3002</p> <p></p> <p>\u5728\u4e0a\u9762\u7684\u4e24\u4e2a\u56fe\u7247\u4e2d\uff0c\u53ef\u4ee5\u770b\u5230\u4f20\u7edf\u5f02\u6b65 MySQL \u590d\u5236\u534f\u8bae\uff08\u4ee5\u53ca\u534a\u540c\u6b65\uff09\u7684\u56fe\u5f62\u5c55\u793a\u3002\u84dd\u8272\u7bad\u5934 \u8868\u793a\u5728\u4e0d\u540c server \u4e4b\u95f4\u6216\u8005 server \u4e0e client \u5e94\u7528\u4e4b\u95f4\u7684\u4fe1\u606f\u4ea4\u4e92\u3002</p>"},{"location":"db_ops/14mysql_replicate/#2mysql","title":"2\u3001MySQL \u4e3b\u4ece\u590d\u5236\u8fc7\u7a0b","text":"<p>\u5f00\u542fbinlog\u65e5\u5fd7\uff0c\u901a\u8fc7\u628a\u4e3b\u5e93\u7684 binlog \u4f20\u9001\u5230\u4ece\u5e93\uff0c\u4ece\u65b0\u89e3\u6790\u5e94\u7528\u5230\u4ece\u5e93\u3002 </p> <p>\u590d\u5236\u9700\u89813\u4e2a\u7ebf\u7a0b\uff08dump\u3001io\u3001sql\uff09\u5b8c\u6210\u3002</p> <p>\u590d\u5236\u662f\u5f02\u6b65\u7684\u8fc7\u7a0b\u3002\u4e3b\u4ece\u590d\u5236\u662f\u5f02\u6b65\u7684\u903b\u8f91\u7684SQL\u8bed\u53e5\u7ea7\u7684\u590d\u5236\u3002</p>"},{"location":"db_ops/14mysql_replicate/#3mysql","title":"3\u3001MySQL \u4e3b\u4ece\u590d\u5236\u524d\u63d0","text":"<ul> <li>\u4e3b\u670d\u52a1\u5668\u4e00\u5b9a\u8981\u6253\u5f00\u4e8c\u8fdb\u5236\u65e5\u5fd7</li> <li>\u5fc5\u987b\u4e24\u53f0\u670d\u52a1\u5668\uff08\u6216\u8005\u662f\u591a\u4e2a\u5b9e\u4f8b\uff09</li> <li>\u4ece\u670d\u52a1\u5668\u9700\u8981\u4e00\u6b21\u6570\u636e\u521d\u59cb\u5316</li> <li>\u5982\u679c\u4e3b\u4ece\u670d\u52a1\u5668\u90fd\u662f\u65b0\u642d\u5efa\u7684\u8bdd\uff0c\u53ef\u4ee5\u4e0d\u505a\u521d\u59cb\u5316</li> <li>\u5982\u679c\u4e3b\u670d\u52a1\u5668\u5df2\u7ecf\u8fd0\u884c\u4e86\u5f88\u957f\u65f6\u95f4\u4e86\uff0c\u53ef\u4ee5\u901a\u8fc7\u5907\u4efd\u5c06\u4e3b\u5e93\u6570\u636e\u6062\u590d\u5230\u4ece\u5e93\u3002</li> <li>\u4e3b\u5e93\u5fc5\u987b\u8981\u6709\u5bf9\u4ece\u5e93\u590d\u5236\u8bf7\u6c42\u7684\u7528\u6237\u3002</li> <li>\u4ece\u5e93\u9700\u8981\u6709<code>relay-log</code>\u8bbe\u7f6e\uff0c\u5b58\u653e\u4ece\u4e3b\u5e93\u4f20\u9001\u8fc7\u6765\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7 <code>show variables like '%relay%';</code></li> <li>\u5728\u7b2c\u4e00\u6b21\u7684\u65f6\u5019\uff0c\u4ece\u5e93\u9700\u8981change master to \u53bb\u8fde\u63a5\u4e3b\u5e93\u3002</li> <li>change master\u4fe1\u606f\u9700\u8981\u5b58\u653e\u5230 <code>master.info</code> \u4e2d <code>show variables like '%master_info%';</code></li> <li>\u4ece\u5e93\u600e\u4e48\u77e5\u9053\uff0c\u4e3b\u5e93\u53d1\u751f\u4e86\u65b0\u7684\u53d8\u5316\u901a\u8fc7<code>relay-log.info</code>\u8bb0\u5f55\u7684\u5df2\u7ecf\u5e94\u7528\u8fc7\u7684<code>relay-log</code>\u4fe1\u606f\u3002</li> <li>\u5728\u590d\u5236\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u5230\u7684\u7ebf\u7a0b<ul> <li>\u4ece\u5e93\u4f1a\u5f00\u542f\u4e00\u4e2aIO thread(\u7ebf\u7a0b)\uff0c\u8d1f\u8d23\u8fde\u63a5\u4e3b\u5e93\uff0c\u8bf7\u6c42binlog\uff0c\u63a5\u6536<code>binlog</code>\u5e76\u5199\u5165<code>relaylog</code>\u3002</li> <li>\u4ece\u5e93\u4f1a\u5f00\u542f\u4e00\u4e2a<code>SQL thread</code>(\u7ebf\u7a0b)\uff0c\u8d1f\u8d23\u6267\u884c<code>relay-log</code>\u4e2d\u7684\u4e8b\u4ef6\u3002</li> <li>\u4e3b\u5e93\u4f1a\u5f00\u542f\u4e00\u4e2a<code>dump thrad</code>(\u7ebf\u7a0b)\uff0c\u8d1f\u8d23\u54cd\u5e94\u4ece<code>IO thread</code>\u7684\u8bf7\u6c42\u3002</li> </ul> </li> </ul>"},{"location":"db_ops/14mysql_replicate/#4mysql","title":"4\u3001MySQL \u4e3b\u4ece\u590d\u5236\u5b9e\u73b0","text":"<ul> <li>\u901a\u8fc7\u4e8c\u8fdb\u5236\u65e5\u5fd7</li> <li>\u81f3\u5c11\u4e24\u53f0\uff08\u4e3b\u3001\u4ece\uff09</li> <li>\u4e3b\u670d\u52a1\u5668\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u201c\u62ff\u201d\u5230\u4ece\u670d\u52a1\u5668\u4e0a\u518d\u8fd0\u884c\u4e00\u904d\u3002</li> <li>\u901a\u8fc7\u7f51\u7edc\u8fde\u63a5\u4e24\u53f0\u673a\u5668\uff0c\u4e00\u822c\u90fd\u4f1a\u51fa\u73b0\u5ef6\u8fdf\u7684\u72b6\u6001\u3002\u4e5f\u53ef\u4ee5\u8bf4\u662f\u5f02\u6b65\u7684\u3002</li> <li>\u4ece\u5e93\u901a\u8fc7\u624b\u5de5\u6267\u884c<code>change master to</code>\u8bed\u53e5\u8fde\u63a5\u4e3b\u5e93\uff0c\u63d0\u4f9b\u4e86\u8fde\u63a5\u7684\u7528\u6237\u4e00\u5207\u6761\u4ef6 user\u3001 password\u3001port\u3001ip</li> <li>\u5e76\u4e14\u8ba9\u4ece\u5e93\u77e5\u9053\uff0c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u8d77\u70b9\u4f4d\u7f6e\uff08<code>file</code>\u540d <code>position</code>\u53f7\uff09</li> <li>\u542f\u52a8\u4ece\u5e93\u540c\u6b65\u670d\u52a1 <code>start slave</code></li> <li>\u4ece\u5e93\u7684IO\u548c\u4e3b\u5e93\u7684dump\u7ebf\u7a0b\u5efa\u7acb\u8fde\u63a5</li> <li>\u4ece\u5e93\u6839\u636e<code>change master to</code> \u8bed\u53e5\u63d0\u4f9b\u7684<code>file</code>\u540d\u548c<code>position</code>\u53f7\uff0cIO\u7ebf\u7a0b\u5411\u4e3b\u5e93\u53d1\u8d77binlog\u7684\u8bf7\u6c42</li> <li>\u4e3b\u5e93dump\u7ebf\u7a0b\u6839\u636e\u4ece\u5e93\u7684\u8bf7\u6c42\uff0c\u5c06\u672c\u5730binlog\u4ee5events\u7684\u65b9\u5f0f\u53d1\u7ed9\u4ece\u5e93IO\u7ebf\u7a0b</li> <li>\u4ece\u5e93IO\u7ebf\u7a0b\u63a5\u6536binlog evnets\uff0c\u5e76\u5b58\u653e\u5230\u672c\u5730<code>relay-log</code>\u4e2d\uff0c\u4f20\u9001\u8fc7\u6765\u7684\u4fe1\u606f\uff0c\u4f1a\u8bb0\u5f55\u5230 <code>master.info</code>\u4e2d\u3002</li> <li>\u4ece\u5e93SQL\u7ebf\u7a0b\u5e94\u7528<code>relay-log</code>\uff0c\u5e76\u4e14\u628a\u5e94\u7528\u8fc7\u7684\u8bb0\u5f55\u5230<code>relay-log.info</code>,\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5df2\u7ecf\u5e94\u7528\u8fc7\u7684 relay\u4f1a\u81ea\u52a8\u88ab\u6e05\u7406<code>purge</code>\u3002</li> </ul>"},{"location":"db_ops/14mysql_replicate/#5mysql","title":"5\u3001MySQL\u590d\u5236\u6709\u4e09\u79cd\u6838\u5fc3\u683c\u5f0f","text":"<p>\u590d\u5236\u7684\u5de5\u4f5c\u539f\u7406\u662f\u6570\u636e\u5e93\u4fee\u6539\u8bb0\u5f55\u5230bin log\u65e5\u5fd7\u5e76\u4f20\u9012\u5230slave\uff0c\u7136\u540eslave\u5728\u672c\u5730\u8fd8\u539f\u7684\u8fc7\u7a0b\u3002\u800c \u65f6\u95f4\u8bb0\u5f55\u5230bin log\u7684\u683c\u5f0f\u4f1a\u6709\u6240\u4e0d\u540c\u3002</p>"},{"location":"db_ops/14mysql_replicate/#1statement-based-replication","title":"1)\u57fa\u4e8e\u8bed\u53e5\u7684\u590d\u5236\uff08statement based replication\uff09","text":"<p>\u57fa\u4e8e\u4e3b\u5e93\u5c06SQL\u8bed\u53e5\u5199\u5165\u5230bin log\u4e2d\u5b8c\u6210\u590d\u5236\u3002</p>"},{"location":"db_ops/14mysql_replicate/#2row-based-replication","title":"2)\u57fa\u4e8e\u884c\u6570\u636e\u7684\u590d\u5236\uff08row based replication\uff09","text":"<p>\u57fa\u4e8e\u4e3b\u5e93\u5c06\u6bcf\u4e00\u884c\u6570\u636e\u53d8\u5316\u7684\u4fe1\u606f\u4f5c\u4e3a\u65f6\u95f4\u5199\u5165\u5230bin log\u4e2d\u5b8c\u6210\u65e5\u5fd7\u3002\u9ed8\u8ba4\u5c31\u662f\u57fa\u4e8e\u884c\u7ea7\u522b\u7684\u590d \u5236\uff0c\u56e0\u4e3a\u5b83\u76f8\u5bf9\u8bed\u53e5\u590d\u5236\u903b\u8f91\u66f4\u4e3a\u4e25\u8c28\u3002</p>"},{"location":"db_ops/14mysql_replicate/#3mixed-based-replication","title":"3)\u6df7\u5408\u590d\u5236\uff08mixed based replication\uff09","text":"<p>\u4e0a\u8ff0\u4e24\u8005\u7684\u7ed3\u5408\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f18\u5148\u4f7f\u7528\u57fa\u4e8e\u8bed\u53e5\u7684\u590d\u5236\uff0c\u53ea\u6709\u5f53\u90e8\u5206\u8bed\u53e5\u5982\u679c\u57fa\u4e8e\u8bed\u53e5\u590d\u5236\u4e0d\u5b8c\u5168 \u7684\u60c5\u51b5\u4e0b\u624d\u4f1a\u81ea\u52a8\u5207\u6362\u4e3a\u57fa\u4e8e\u884c\u6570\u636e\u7684\u590d\u5236\u3002</p> <pre><code># mysql -uroot -p'Qfedu.123com'\nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 6\nServer version: 5.7.25-log MySQL Community Server (GPL)\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt; \nmysql&gt; SHOW VARIABLES LIKE '%BINLOG_FORMAT%'; # \u9ed8\u8ba4\u5c31\u662f\u57fa\u4e8e\u884c\u590d\u5236\u7684\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| binlog_format | ROW   |\n+---------------+-------+\nrow in set (0.00 sec)\nmysql&gt; \nmysql&gt; SET binlog_format='STATEMENT'; # \u4fee\u6539\u6210\u57fa\u4e8e\u8bed\u53e5\u590d\u5236\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; \nmysql&gt; SHOW VARIABLES LIKE '%BINLOG_FORMAT%';\n+---------------+-----------+\n| Variable_name | Value     |\n+---------------+-----------+\n| binlog_format | STATEMENT |\n+---------------+-----------+\nrow in set (0.00 sec)\nmysql&gt; \nmysql&gt; quit\nBye\n</code></pre>"},{"location":"db_ops/15mysql_master_slave/","title":"\u7b2c\u5341\u4e94\u8282 MySQL \u4f20\u7edf\u4e3b\u4ece\u540c\u6b65\u914d\u7f6e","text":"<p>1\u3001MySQL \u4e3b\u4ece\u90e8\u7f72\u73af\u5883</p> <ul> <li>Master\uff1a192.168.172.110 </li> <li>Slave\uff1a192.168.172.111</li> <li>\u7aef\u53e3\uff1a3306</li> <li>Master, Slave \u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u5b89\u88c5mysql\u6570\u636e\u5e93</li> </ul> <p>2\u3001MySQL yum\u5305\u4e0b\u8f7d</p> <pre><code># wget http://repo.mysql.com/mysql57-community-releaseel7-10.noarch.rpm\n</code></pre> <p>3\u3001MySQL \u8f6f\u4ef6\u6e90\u5b89\u8f6c</p> <pre><code># yum -y install mysql57-community-release-el7-10.noarch.rpm\n</code></pre> <p>4\u3001MySQL \u670d\u52a1\u5b89\u88c5</p> <pre><code># yum install -y mysql-community-server mysql\n</code></pre> <p>5\u3001MySQL \u670d\u52a1\u542f\u52a8</p> <pre><code># systemctl status mysqld.service\n</code></pre> <p>6\u3001MySQL \u670d\u52a1\u8fd0\u884c\u72b6\u6001\u68c0\u67e5</p> <pre><code># systemctl status mysqld.service\n</code></pre> <p>7\u3001MySQL \u4fee\u6539\u4e34\u65f6\u5bc6\u7801</p> <ul> <li>1)\u83b7\u53d6MySQL\u7684\u4e34\u65f6\u5bc6\u7801</li> </ul> <p>\u4e3a\u4e86\u52a0\u5f3a\u5b89\u5168\u6027\uff0cMySQL5.7\u4e3aroot\u7528\u6237\u968f\u673a\u751f\u6210\u4e86\u4e00\u4e2a\u5bc6\u7801\uff0c\u5728error log\u4e2d\uff0c\u5173\u4e8eerror log\u7684\u4f4d \u7f6e\uff0c\u5982\u679c\u5b89\u88c5\u7684\u662fRPM\u5305\uff0c\u5219\u9ed8\u8ba4\u662f<code>/var/log/mysqld.log</code>\u3002 </p> <p>\u53ea\u6709\u542f\u52a8\u8fc7\u4e00\u6b21mysql\u624d\u53ef\u4ee5\u67e5\u770b\u4e34\u65f6\u5bc6\u7801</p> <pre><code>grep 'temporary password' /var/log/mysqld.log\n</code></pre> <ul> <li>2)\u767b\u9646\u5e76\u4fee\u6539\u5bc6\u7801</li> </ul> <p>\u4f7f\u7528\u9ed8\u8ba4\u7684\u5bc6\u7801\u767b\u9646</p> <pre><code> mysql -uroot -p\n</code></pre> <p>\u4fee\u6539\u5bc6\u7801</p> <pre><code>mysql&gt; ALTER USER 'root'@'localhost' IDENTIFIED BY 'Qfedu.123com';\n</code></pre> <p>\u89e3\u51b3\u4e0d\u7b26\u5408\u5bc6\u7801\u590d\u6742\u6027\u8981\u6c42</p> <pre><code>ERROR 1819 (HY000): Your password does not satisfy the current policy \nrequirements \n</code></pre> <p>\u4fee\u6539 \u5bc6\u7801\u7b56\u7565</p> <pre><code>mysql&gt; set global validate_password_policy=0;\n</code></pre> <p>\u4fee\u6539\u5bc6\u7801\u7684\u957f\u5ea6</p> <pre><code>mysql&gt; set global validate_password_length=1;\n</code></pre> <p>\u6267\u884c\u4fee\u6539\u5bc6\u7801\u6210\u529f</p> <pre><code>mysql&gt; ALTER USER 'root'@'localhost' IDENTIFIED BY 'root123';\n</code></pre> <p>8\u3001MySQL \u6388\u6743\u8fdc\u7a0b\u4e3b\u673a\u767b\u5f55</p> <pre><code>mysql&gt; GRANT ALL PRIVILEGES ON *.* TO 'slave'@'192.168.%.%' IDENTIFIED BY \n'mypassword' WITH GRANT OPTION;\nmysql&gt; FLUSH  PRIVILEGES\n</code></pre> <p>9\u3001MySQL \u7f16\u8f91\u914d\u7f6e\u6587\u4ef6</p> <ul> <li>1)Master \u914d\u7f6e\u6587\u4ef6</li> </ul> <pre><code># cat /etc/my.cnf\n[mysqld]\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\ndefault-storage-engine=INNODB\nsymbolic-links=0\nserver_id=6\nlog_bin=/var/log/mysql/mysql-bin\n</code></pre> <ul> <li>2)Slave \u914d\u7f6e\u6587\u4ef6</li> </ul> <pre><code># cat /etc/my.cnf\n[mysqld]\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\ndefault-storage-engine=INNODB\nsymbolic-links=0\nserver_id=8\nlog_bin=/var/log/mysql/mysql-bin\n</code></pre> <p>10\u3001MySQL \u521b\u5efa\u4e3b\u4ece\u540c\u6b65\u8d26\u53f7</p> <p>\u5728\u4e3b\u5e93\u521b\u5efa\u4e00\u4e2a\u4e13\u95e8\u7528\u6765\u590d\u5236\u7684\u6570\u636e\u5e93\u7528\u6237\uff0c\u6240\u6709\u4ece\u5e93\u90fd\u7528\u8fd9\u4e2a\u7528\u6237\u6765\u8fde\u63a5\u4e3b\u5e93\uff0c\u786e\u4fdd\u8fd9\u4e2a\u7528\u6237\u53ea \u6709\u590d\u5236\u7684\u6743\u9650</p> <pre><code># mysql -uroot -p\nEnter password: \nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 7\nServer version: 5.7.25-log MySQL Community Server (GPL)\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt; \nmysql&gt; CREATE USER 'slave'@'192.168.%.%' IDENTIFIED BY 'Qfedu.123com';\nQuery OK, 0 rows affected (0.01 sec)\nmysql&gt; \nmysql&gt; GRANT REPLICATION SLAVE ON *.* TO 'slave'@'192.168.%.%';\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; \nmysql&gt; quit\nBye\n</code></pre> <p>11\u3001MySQL \u6d4b\u8bd5\u8d26\u53f7\u8fdc\u7a0b\u767b\u5f55</p> <pre><code># mysql -uslave -p'Qfedu.123com' -P 3306 -h \nmaster.qfedu.com\nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 20\nServer version: 5.7.25-log MySQL Community Server (GPL)\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt; SHOW DATABASES;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql             |\n| performance_schema |\n| sys               |\n+--------------------+\n4 rows in set (0.00 sec)\nmysql&gt; \nmysql&gt; QUIT\nBye\n</code></pre> <p>12\u3001MySQL \u83b7\u53d6\u4e3b\u5e93\u7684\u65e5\u5fd7\u4fe1\u606f\u5e76\u751f\u6210\u4e3b\u5e93\u6570\u636e\u955c\u50cf</p> <pre><code>mysql&gt; FLUSH TABLES WITH READ LOCK; # \u5bf9\u4e3b\u5e93\u4e0a\u6240\u6709\u8868\u52a0\u9501\uff0c\u505c\u6b62\u4fee\u6539\uff0c\u5373\n\u5728\u4ece\u5e93\u590d\u5236\u7684\u8fc7\u7a0b\u4e2d\u4e3b\u5e93\u4e0d\u80fd\u6267\u884cUPDATA\uff0cDELETE\uff0cINSERT\u8bed\u53e5\uff01\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; \nmysql&gt; SHOW MASTER STATUS; # \u83b7\u53d6\u4e3b\u5e93\u7684\u65e5\u5fd7\u4fe1\u606f\uff0cfile \u8868\u793a\u5f53\n\u524d\u65e5\u5fd7\u6587\u4ef6\u540d\u79f0\uff0cposition \u8868\u793a\u5f53\u524d\u65e5\u5fd7\u7684\u4f4d\u7f6e\n+---------------------------------+----------+--------------+------------------\n+-------------------+\n| File | Position | Binlog_Do_DB | Binlog_Ignore_DB | \nExecuted_Gtid_Set |\n+---------------------------------+----------+--------------+------------------\n+-------------------+\n| /var/log/mysql/mysql-bin.000002 |     4095 |             | |\n|\n+---------------------------------+----------+--------------+------------------\n+-------------------+\n1 row in set (0.00 sec)\nmysql&gt; \n</code></pre> <p>13\u3001MySQL \u5907\u4efd\u4e3b\u5e93\u6570\u636e</p> <pre><code># mysqldump -u root -p'Qfedu.123com' --master-data --all-databases &gt; qfedu.com-master.sql \nmysqldump: [Warning] Using a password on the command line interface can be \ninsecure.\n[root@master.qfedu.com ~]# ll\ntotal 776\n-rw-r--r-- 1 root root 791962 Jun 10 19:24 qfedu.com-master.sql\n</code></pre> <p>\u4e3b\u5e93\u6570\u636e\u5907\u4efd\u5b8c\u6bd5\u540e\uff0c\u91ca\u653e\u4e3b\u5e93\u9501\uff0c\u9700\u8981\u6ce8\u610f\uff0c\u5728\u4e0a\u9501\u8fd9\u4e00\u6bb5\u671f\u95f4\uff0c\u65e0\u6cd5\u5bf9\u6570\u636e\u5e93\u8fdb\u884c\u5199\u64cd\u4f5c\uff0c\u6bd4 \u5982UPDATE\uff0cDELETE\uff0cINSERT</p> <pre><code>mysql&gt; UNLOCK TABLES; \nQuery OK, 0 rows affected (0.00 sec)\n</code></pre> <p>14\u3001MySQL \u4ece\u5e93\u8fd8\u539f\u6570\u636e</p> <p>\u5c06\u4e3b\u5e93\u7684\u955c\u50cf\u62f7\u8d1d\u5f53\u4ece\u5e93\u4e2d\uff0c\u5c06\u6570\u636e\u8fd8\u539f\u5230\u4ece\u5e93</p> <pre><code># ll\ntotal 776\n-rw-r--r-- 1 root root 791962 Jun 10 19:24 qfedu.com-master.sql\n\n# scp qfedu.com-master.sql slave.qfedu.com:/root/\nThe authenticity of host 'slave.qfedu.com (192.168.172.111)' can't be \nestablished.\nECDSA key fingerprint is SHA256:BkN6bKO2q5zMgvremE/3rOIsCaq9eTPudgfU0lhbqGo.\nECDSA key fingerprint is MD5:75:bd:cb:be:35:f8:45:a2:ea:74:bc:aa:29:74:4d:0d.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added 'slave.qfedu.com,192.168.172.107' (ECDSA) to the list \nof known hosts.\nroot@slave.qfedu.com's password: \nqfedu.com-master.sql                                      100%  773KB  60.7MB/s \n  00:00 \n</code></pre> <p>\u4ece\u5e93\u6570\u636e\u8fd8\u539f</p> <pre><code># pwd\n/root\n\n# ll\ntotal 776\n-rw-r--r-- 1 root root 791962 Jun 10 19:37 qfedu.com-master.sql\n\n# mysql -uroot -p'Qfedu.123com'\nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 5\nServer version: 5.7.25-log MySQL Community Server (GPL)\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt; source qfedu.com-master.sql;\nQuery OK, 0 rows affected (0.00 sec)\nQuery OK, 0 rows affected (0.00 sec)\n.......\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt;\n</code></pre> <p>15\u3001MySQL \u4ece\u5e93\u914d\u7f6e\u540c\u6b65</p> <p>\u5728\u4ece\u5e93\u4e0a\u5efa\u7acb\u590d\u5236\u5173\u7cfb\uff0c\u5373\u4ece\u5e93\u6307\u5b9a\u4e3b\u5e93\u7684\u65e5\u5fd7\u4fe1\u606f\u548c\u94fe\u63a5\u4fe1\u606f</p> <pre><code>mysql&gt; CHANGE MASTER TO\n   -&gt; MASTER_HOST='master.qfedu.com',\n   -&gt; MASTER_PORT=3306,\n   -&gt; MASTER_USER='slave',\n   -&gt; MASTER_PASSWORD='Qfedu.123com',\n   -&gt; MASTER_LOG_FILE='/var/log/mysql/mysql-bin.000002',\n   -&gt; MASTER_LOG_POS=4095;\nQuery OK, 0 rows affected, 2 warnings (0.01 sec)\nmysql&gt;\n</code></pre> <p>16\u3001MySQL \u4ece\u5e93\u542f\u52a8\u590d\u5236\u8fdb\u7a0b</p> <pre><code>mysql&gt; START SLAVE;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; \nmysql&gt; SHOW SLAVE STATUS\\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                 Master_Host: master.qfedu.com\n                 Master_User: copy\n                 Master_Port: 3306\n               Connect_Retry: 60\n             Master_Log_File: /var/log/mysql/mysql-bin.000002\n         Read_Master_Log_Pos: 4095\n               Relay_Log_File: node107-relay-bin.000002\n               Relay_Log_Pos: 332\n       Relay_Master_Log_File: /var/log/mysql/mysql-bin.000002\n             Slave_IO_Running: Yes # \u89c2\u5bdfIO\u8fdb\u7a0b\u662f\u5426\u4e3ayes\uff0c\u5982\u679c\u4e3ayes\u8bf4\u660e\u6b63\u5e38\uff0c\u5982\u679c\u957f\n\u65f6\u95f4\u5904\u4e8e\"Connecting\"\u72b6\u6001\u5c31\u5f97\u68c0\u67e5\u4f60\u7684\u4ece\u5e93\u6307\u5b9a\u7684\u4e3b\u5e93\u7684\u94fe\u63a5\u4fe1\u606f\u662f\u5426\u6b63\u786e\n           Slave_SQL_Running: Yes # \u89c2\u5bdfSQL\u8fdb\u7a0b\u662f\u5426\u4e3ayes\n             Replicate_Do_DB: \n         Replicate_Ignore_DB: \n           Replicate_Do_Table: \n       Replicate_Ignore_Table: \n     Replicate_Wild_Do_Table: \n Replicate_Wild_Ignore_Table: \n                   Last_Errno: 0\n                   Last_Error: \n                 Skip_Counter: 0\n         Exec_Master_Log_Pos: 4095\n             Relay_Log_Space: 541\n             Until_Condition: None\n               Until_Log_File: \n               Until_Log_Pos: 0\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File: \n           Master_SSL_CA_Path: \n             Master_SSL_Cert: \n           Master_SSL_Cipher: \n               Master_SSL_Key: \n       Seconds_Behind_Master: 0 #\u8be5\u53c2\u6570\u8868\u793a\u4ece\u5e93\u548c\u4e3b\u5e93\u6709\u591a\u5c11\u79d2\u7684\u5ef6\u8fdf\uff0c\u518d\u8fc7\u591a\u5c11\u79d2\u6570\u636e\n\u548c\u4e3b\u5e93\u4fdd\u6301\u4e00\u81f4\uff0c\u5982\u679c\u4e3a0\u8868\u793a\u5f53\u524d\u4ece\u5e93\u548c\u4e3b\u5e93\u7684\u6570\u636e\u662f\u4e00\u81f4\u7684\uff0c\u5982\u679c\u8be5\u6570\u8f83\u5927\u7684\u8bdd\u4f60\u5f97\u8003\u8651\u5b83\u7684\u5408\u7406\u6027\u3002\u9700\n\u8981\u6ce8\u610f\u4e0b\u8be5\u53c2\u6570\u7684\u503c\u3002\nMaster_SSL_Verify_Server_Cert: No\n               Last_IO_Errno: 0\n               Last_IO_Error: \n               Last_SQL_Errno: 0\n               Last_SQL_Error: \n Replicate_Ignore_Server_Ids: \n             Master_Server_Id: 106\n                 Master_UUID: 74227047-8b60-11e9-8cba-000c29985293\n             Master_Info_File: /var/lib/mysql/master.info\n                   SQL_Delay: 0\n         SQL_Remaining_Delay: NULL\n     Slave_SQL_Running_State: Slave has read all relay log; waiting for more \nupdates\n           Master_Retry_Count: 86400\n                 Master_Bind: \n     Last_IO_Error_Timestamp: \n     Last_SQL_Error_Timestamp: \n               Master_SSL_Crl: \n           Master_SSL_Crlpath: \n           Retrieved_Gtid_Set: \n           Executed_Gtid_Set: \n               Auto_Position: 0\n         Replicate_Rewrite_DB: \n                 Channel_Name: \n           Master_TLS_Version: \n1 row in set (0.00 sec)\nmysql&gt; \n</code></pre> <p>17\u3001MySQL \u9a8c\u8bc1\u4e3b\u4ece\u6570\u636e\u540c\u6b65</p> <ul> <li>1)\u4e3b\u5e93\u4e2d\u521b\u5efa qfedu \u6570\u636e\u5e93</li> </ul> <pre><code># mysql -uroot -p'Qfedu.123com'\nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 22\nServer version: 5.7.25-log MySQL Community Server (GPL)\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt; \nmysql&gt; CREATE DATABASE qfedu DEFAULT CHARACTER SET = utf8;\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; \nmysql&gt; GRANT ALL PRIVILEGES ON qfedu.* TO 'qfedu'@'192.168.172.%' IDENTIFIED BY \n'Qfedu.123com' WITH GRANT OPTION;\nQuery OK, 0 rows affected, 1 warning (0.01 sec)\nmysql&gt;\nmysql&gt; SHOW DATABASES;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| qfedu               |\n| mysql             |\n| performance_schema |\n| sys               |\n+--------------------+\n5 rows in set (0.00 sec)\nmysql&gt; QUIT\nBye\n</code></pre> <ul> <li>2)\u4ece\u5e93\u7684\u670d\u52a1\u5668\u89c2\u5bdf\u6570\u636e\u662f\u5426\u540c\u6b65</li> </ul> <pre><code># mysql -uroot -p'Qfedu.123com'\nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 12\nServer version: 5.7.25-log MySQL Community Server (GPL)\nCopyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt; \nmysql&gt; SHOW DATABASES;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| qfedu             |\n| mysql             |\n| performance_schema |\n| sys               |\n+--------------------+\n5 rows in set (0.00 sec)\nmysql&gt; QUIT\nBye\n</code></pre> <ul> <li>3)\u6d4b\u8bd5\u5b8c\u6210\u540e\u5220\u9664 qfedu \u5e93\uff0c</li> </ul> <pre><code>mysql&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| qfedu             |\n| mysql             |\n| performance_schema |\n| sys               |\n+--------------------+\n5 rows in set (0.00 sec)\nmysql&gt; drop database qfedu;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; \nmysql&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql             |\n| performance_schema |\n| sys               |\n+--------------------+\n4 rows in set (0.00 sec)\nmysql&gt;\n</code></pre>"},{"location":"db_ops/16mysq_gtid/","title":"\u7b2c\u5341\u516d\u8282 MySQL \u57fa\u4e8e GTID \u7684\u4e3b\u4ece\u590d\u5236","text":""},{"location":"db_ops/16mysq_gtid/#1gtid","title":"1\u3001GTID \u6982\u5ff5\u4ecb\u7ecd","text":"<p>GTID\u5373\u5168\u5c40\u4e8b\u52a1ID (global transaction identifier), \u5176\u4fdd\u8bc1\u4e3a\u6bcf\u4e00\u4e2a\u5728\u4e3b\u4e0a\u63d0\u4ea4\u7684\u4e8b\u52a1\u5728\u590d\u5236\u96c6\u7fa4 \u4e2d\u53ef\u4ee5\u751f\u6210\u4e00\u4e2a\u552f\u4e00\u7684ID\u3002</p> <p>GTID\u6700\u521d\u7531google\u5b9e\u73b0\uff0c\u5b98\u65b9MySQL\u57285.6\u624d\u52a0\u5165\u8be5\u529f\u80fd\u3002mysql\u4e3b\u4ece\u7ed3\u6784\u5728\u4e00\u4e3b\u4e00\u4ece\u60c5\u51b5\u4e0b\u5bf9\u4e8e GTID\u6765\u8bf4\u5c31\u6ca1\u6709\u4f18\u52bf\u4e86\uff0c\u800c\u5bf9\u4e8e2\u53f0\u4e3b\u4ee5\u4e0a\u7684\u7ed3\u6784\u4f18\u52bf\u5f02\u5e38\u660e\u663e\uff0c\u53ef\u4ee5\u5728\u6570\u636e\u4e0d\u4e22\u5931\u7684\u60c5\u51b5\u4e0b\u5207\u6362 \u65b0\u4e3b\u3002</p> <p>\u4f7f\u7528GTID\u9700\u8981\u6ce8\u610f: \u5728\u6784\u5efa\u4e3b\u4ece\u590d\u5236\u4e4b\u524d\uff0c\u5728\u4e00\u53f0\u5c06\u6210\u4e3a\u4e3b\u7684\u5b9e\u4f8b\u4e0a\u8fdb\u884c\u4e00\u4e9b\u64cd\u4f5c\uff08\u5982\u6570\u636e\u6e05\u7406 \u7b49\uff09\uff0c\u901a\u8fc7GTID\u590d\u5236\uff0c\u8fd9\u4e9b\u5728\u4e3b\u4ece\u6210\u7acb\u4e4b\u524d\u7684\u64cd\u4f5c\u4e5f\u4f1a\u88ab\u590d\u5236\u5230\u4ece\u670d\u52a1\u5668\u4e0a\uff0c\u5f15\u8d77\u590d\u5236\u5931\u8d25\u3002</p> <p>\u4e5f\u5c31\u662f\u8bf4\u901a\u8fc7GTID\u590d\u5236\u90fd\u662f\u4ece\u6700\u5148\u5f00\u59cb\u7684\u4e8b\u52a1\u65e5\u5fd7\u5f00\u59cb\uff0c\u5373\u4f7f\u8fd9\u4e9b\u64cd\u4f5c\u5728\u590d\u5236\u4e4b\u524d\u6267\u884c\u3002\u6bd4\u5982\u5728 <code>server1</code>\u4e0a\u6267\u884c\u4e00\u4e9b<code>drop</code>\u3001<code>delete</code>\u7684\u6e05\u7406\u64cd\u4f5c\uff0c\u63a5\u7740\u5728<code>server2</code>\u4e0a\u6267\u884c<code>change</code>\u7684\u64cd\u4f5c\uff0c\u4f1a\u4f7f\u5f97<code>server2</code>\u4e5f\u8fdb\u884c<code>server1</code>\u7684\u6e05\u7406\u64cd\u4f5c\u3002</p> <p>GTID\u5b9e\u9645\u4e0a\u662f\u7531UUID+TID (\u5373transactionId)\u7ec4\u6210\u7684\u3002</p> <p>\u5176\u4e2dUUID(\u5373server_uuid) \u4ea7\u751f\u4e8e auto.conf\u6587\u4ef6(<code>cat /data/mysql/data/auto.cn</code>f)\uff0c\u662f\u4e00\u4e2aMySQL\u5b9e\u4f8b\u7684\u552f\u4e00\u6807\u8bc6\u3002</p> <p>TID\u4ee3\u8868\u4e86\u8be5\u5b9e \u4f8b\u4e0a\u5df2\u7ecf\u63d0\u4ea4\u7684\u4e8b\u52a1\u6570\u91cf\uff0c\u5e76\u4e14\u968f\u7740\u4e8b\u52a1\u63d0\u4ea4\u5355\u8c03\u9012\u589e\uff0c\u6240\u4ee5GTID\u80fd\u591f\u4fdd\u8bc1\u6bcf\u4e2aMySQL\u5b9e\u4f8b\u4e8b\u52a1 \u7684\u6267\u884c\uff08\u4e0d\u4f1a\u91cd\u590d\u6267\u884c\u540c\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5e76\u4e14\u4f1a\u8865\u5168\u6ca1\u6709\u6267\u884c\u7684\u4e8b\u52a1\uff09\u3002GTID\u5728\u4e00\u7ec4\u590d\u5236\u4e2d\uff0c\u5168\u5c40\u552f\u4e00\u3002\u4e0b\u9762\u662f\u4e00\u4e2aGTID\u7684\u5177\u4f53\u5f62\u5f0f :</p>"},{"location":"db_ops/16mysq_gtid/#2gtid","title":"2\u3001GTID \u7684\u5de5\u4f5c\u6d41\u7a0b\u4e3a","text":"<ul> <li><code>master</code>\u66f4\u65b0\u6570\u636e\u65f6\uff0c\u4f1a\u5728\u4e8b\u52a1\u524d\u4ea7\u751f<code>GTID</code>\uff0c\u4e00\u540c\u8bb0\u5f55\u5230 <code>binlog</code> \u65e5\u5fd7\u4e2d\u3002</li> <li><code>slave</code> \u7aef\u7684 <code>i/o</code> \u7ebf\u7a0b\u5c06\u53d8\u66f4\u7684 <code>binlog</code>\uff0c\u5199\u5165\u5230\u672c\u5730\u7684<code>relay log</code> \u4e2d\u3002</li> <li><code>sql</code> \u7ebf\u7a0b\u4ece <code>relay log</code> \u4e2d\u83b7\u53d6 <code>GTID</code>\uff0c\u7136\u540e\u5bf9\u6bd4 <code>slave</code> \u7aef\u7684 <code>binlog</code> \u662f\u5426\u6709\u8bb0\u5f55\u3002</li> <li>\u5982\u679c\u6709\u8bb0\u5f55\uff0c\u8bf4\u660e\u8be5 <code>GTID</code> \u7684\u4e8b\u52a1\u5df2\u7ecf\u6267\u884c\uff0c<code>slave</code> \u4f1a\u5ffd\u7565\u3002</li> <li>\u5982\u679c\u6ca1\u6709\u8bb0\u5f55\uff0c<code>slave</code> \u5c31\u4f1a\u4ece <code>relay log</code> \u4e2d\u6267\u884c\u8be5 <code>GTID</code> \u7684\u4e8b\u52a1\uff0c\u5e76\u8bb0\u5f55\u5230 <code>binlog</code>\u3002</li> <li>\u5728\u89e3\u6790\u8fc7\u7a0b\u4e2d\u4f1a\u5224\u65ad\u662f\u5426\u6709\u4e3b\u952e\uff0c\u5982\u679c\u6ca1\u6709\u5c31\u7528\u4e8c\u7ea7\u7d22\u5f15\uff0c\u5982\u679c\u6ca1\u6709\u5c31\u7528\u5168\u90e8\u626b\u63cf\u3002</li> </ul>"},{"location":"db_ops/16mysq_gtid/#3gtid","title":"3\u3001GTID \u7684\u4f18\u70b9","text":"<p>\u4e00\u4e2a\u4e8b\u52a1\u5bf9\u5e94\u4e00\u4e2a\u552f\u4e00ID\uff0c\u4e00\u4e2aGTID\u5728\u4e00\u4e2a\u670d\u52a1\u5668\u4e0a\u53ea\u4f1a\u6267\u884c\u4e00\u6b21;</p> <p>GTID\u662f\u7528\u6765\u4ee3\u66ff\u4f20\u7edf\u590d\u5236\u7684\u65b9\u6cd5\uff0cGTID\u590d\u5236\u4e0e\u666e\u901a\u590d\u5236\u6a21\u5f0f\u7684\u6700\u5927\u4e0d\u540c\u5c31\u662f\u4e0d\u9700\u8981\u6307\u5b9a\u4e8c\u8fdb\u5236\u6587\u4ef6\u540d\u548c\u4f4d\u7f6e;</p> <p>\u51cf\u5c11\u624b\u5de5\u5e72\u9884\u548c\u964d\u4f4e\u670d\u52a1\u6545\u969c\u65f6\u95f4\uff0c\u5f53\u4e3b\u673a\u6302\u4e86\u4e4b\u540e\u901a\u8fc7\u8f6f\u4ef6\u4ece\u4f17\u591a\u7684\u5907\u673a\u4e2d\u63d0\u5347\u4e00\u53f0\u5907\u673a\u4e3a\u4e3b\u673a;</p>"},{"location":"db_ops/16mysq_gtid/#4gtid","title":"4\u3001GTID \u590d\u5236\u540c\u6b65\u8fc7\u7a0b","text":"<p>\u4e3b\u4ece\u67b6\u6784\uff1a<code>ServerC &lt;-----ServerA ----&gt; ServerB</code> \u5373\u4e00\u4e2a\u4e3b\u6570\u636e\u5e93<code>ServerA</code>\uff0c\u4e24\u4e2a\u4ece\u6570\u636e\u5e93<code>ServerB</code> \u548c<code>ServerC</code></p> <ul> <li>\u5f53\u4e3b\u673aServerA \u6302\u4e86\u4e4b\u540e \uff0c\u6b64\u65f6ServerB\u6267\u884c\u5b8c\u4e86\u6240\u6709\u4eceServerA \u4f20\u8fc7\u6765\u7684\u4e8b\u52a1\uff0cServerC \u5ef6\u65f6\u4e00 \u70b9\u3002\u8fd9\u4e2a\u65f6\u5019\u9700\u8981\u628a ServerB \u63d0\u5347\u4e3a\u4e3b\u673a \uff0cServer C \u7ee7\u7eed\u4e3a\u5907\u673a\uff1b</li> <li>\u5f53ServerC \u94fe\u63a5ServerB \u4e4b\u540e, \u9996\u5148\u5728\u81ea\u5df1\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u4e2d\u627e\u5230\u4eceServerA \u4f20\u8fc7\u6765\u7684\u6700\u65b0\u7684GTID\uff0c\u7136\u540e\u5c06\u8fd9\u4e2aGTID \u53d1\u9001\u5230 ServerB ,ServerB \u83b7\u5f97\u8fd9\u4e2aGTID\u4e4b\u540e,\u5c31\u5f00\u59cb\u4ece\u8fd9\u4e2aGTID\u7684\u4e0b\u4e00\u4e2aGTID\u5f00\u59cb\u53d1\u9001\u4e8b\u52a1\u7ed9ServerC\u3002</li> <li>\u8fd9\u79cd\u81ea\u6211\u5bfb\u627e\u590d\u5236\u4f4d\u7f6e\u7684\u6a21\u5f0f\u51cf\u5c11\u4e8b\u52a1\u4e22\u5931\u7684\u53ef\u80fd\u6027\u4ee5\u53ca\u6545\u969c\u6062\u590d\u7684\u65f6\u95f4\u3002</li> </ul>"},{"location":"db_ops/16mysq_gtid/#5gtid","title":"5\u3001GTID \u7684\u7f3a\u70b9(\u9650\u5236)","text":"<p>\u4e0d\u652f\u6301\u975e\u4e8b\u52a1\u5f15\u64ce;</p> <p>\u4e0d\u652f\u6301<code>create table ... select</code> \u8bed\u53e5\u590d\u5236(\u4e3b\u5e93\u76f4\u63a5\u62a5\u9519);(\u539f\u7406: \u4f1a\u751f\u6210\u4e24\u4e2asql, \u4e00\u4e2a\u662fDDL\u521b\u5efa\u8868</p> <ul> <li>SQL, \u4e00\u4e2a\u662finsert into \u63d2\u5165\u6570\u636e\u7684sql; </li> <li>\u7531\u4e8eDDL\u4f1a\u5bfc\u81f4\u81ea\u52a8\u63d0\u4ea4, \u6240\u4ee5\u8fd9\u4e2asql\u81f3\u5c11\u9700\u8981\u4e24\u4e2aGTID, \u4f46\u662fGTID\u6a21\u5f0f\u4e0b, \u53ea\u80fd\u7ed9\u8fd9\u4e2asql\u751f\u6210\u4e00\u4e2aGTID)</li> </ul> <p>\u4e0d\u5141\u8bb8\u4e00\u4e2aSQL\u540c\u65f6\u66f4\u65b0\u4e00\u4e2a\u4e8b\u52a1\u5f15\u64ce\u8868\u548c\u975e\u4e8b\u52a1\u5f15\u64ce\u8868;</p> <p>\u5728\u4e00\u4e2a\u590d\u5236\u7ec4\u4e2d\uff0c\u5fc5\u987b\u8981\u6c42\u7edf\u4e00\u5f00\u542fGTID\u6216\u8005\u662f\u5173\u95edGTID;</p> <p>\u5f00\u542fGTID\u9700\u8981\u91cd\u542f (mysql5.7\u9664\u5916);</p> <p>\u5f00\u542fGTID\u540e\uff0c\u5c31\u4e0d\u518d\u4f7f\u7528\u539f\u6765\u7684\u4f20\u7edf\u590d\u5236\u65b9\u5f0f;</p> <p>\u5bf9\u4e8e<code>create temporary table</code> \u548c <code>drop temporary table</code>\u8bed\u53e5\u4e0d\u652f\u6301</p>"},{"location":"db_ops/16mysq_gtid/#6gtid-binlog","title":"6\u3001GTID \u4e0e binlog\u5bf9\u5e94\u5173\u7cfb","text":"<p>\u5047\u8bbe\u67094\u4e2abinlog: bin.001,bin.002,bin.003,bin.004</p> <pre><code>bin.001 : Previous-GTIDs=empty; binlog_event\u6709\uff1a1-40\nbin.002 : Previous-GTIDs=1-40; binlog_event\u6709\uff1a41-80\nbin.003 : Previous-GTIDs=1-80; binlog_event\u6709\uff1a81-120\nbin.004 : Previous-GTIDs=1-120; binlog_event\u6709\uff1a121-160\n</code></pre> <p>\u5047\u8bbe\u73b0\u5728\u6211\u4eec\u8981\u627e<code>GTID=$A</code>\uff0c\u90a3\u4e48MySQL\u7684\u626b\u63cf\u987a\u5e8f\u4e3a\uff1a\u4ece\u6700\u540e\u4e00\u4e2abinlog\u5f00\u59cb\u626b\u63cf\uff08\u5373\uff1a<code>bin.004</code>\uff09</p> <ul> <li><code>bin.004</code>\u7684<code>Previous-GTIDs=1-120</code>\uff0c\u5982\u679c<code>$A=140 &gt; Previous-GTIDs,</code>\u90a3\u4e48\u80af\u5b9a\u5728<code>bin.004</code>\u4e2d</li> <li><code>bin.004</code>\u7684<code>Previous-GTIDs=1-120</code>\uff0c\u5982\u679c<code>$A=88</code> \u5305\u542b\u5728<code>Previous-GTIDs</code>\u4e2d,\u90a3\u4e48\u7ee7\u7eed\u5bf9\u6bd4\u4e0a\u4e00\u4e2a binlog\u6587\u4ef6 <code>bin.003</code>,\u7136\u540e\u518d\u5faa\u73af\u524d\u97622\u4e2a\u6b65\u9aa4\uff0c\u76f4\u5230\u627e\u5230\u4e3a\u6b62</li> </ul>"},{"location":"db_ops/16mysq_gtid/#7gtid","title":"7\u3001GTID \u76f8\u5173\u53c2\u6570","text":""},{"location":"db_ops/16mysq_gtid/#8gtid","title":"8\u3001GTID \u5f00\u542f\u5fc5\u5907\u7684\u6761\u4ef6","text":""},{"location":"db_ops/16mysq_gtid/#1-mysql-56","title":"1. MySQL 5.6","text":"<pre><code>gtid_mode=ON(\u5fc5\u9009)\nlog_bin=ON(\u5fc5\u9009)\nlog-slave-updates=ON(\u5fc5\u9009)\nenforce-gtid-consistency(\u5fc5\u9009)\n</code></pre>"},{"location":"db_ops/16mysq_gtid/#2-mysql-57","title":"2. MySQL 5.7","text":"<p>MySQL5.7.13 or higher</p> <pre><code>gtid_mode=ON(\u5fc5\u9009)\nenforce-gtid-consistency\uff08\u5fc5\u9009\uff09\nlog_bin=ON\uff08\u53ef\u9009\uff09--\u9ad8\u53ef\u7528\u5207\u6362\uff0c\u6700\u597d\u8bbe\u7f6eON\nlog-slave-updates=ON\uff08\u53ef\u9009\uff09--\u9ad8\u53ef\u7528\u5207\u6362\uff0c\u6700\u597d\u8bbe\u7f6eON\n</code></pre>"},{"location":"db_ops/16mysq_gtid/#9-gtid","title":"9\u3001 GTID \u5f00\u542f\u65f6\u9700\u8981\u6ce8\u610f\u7684\u95ee\u9898","text":"<ul> <li>slave\u4e0d\u80fd\u6267\u884c\u4efb\u4f55sql,\u5305\u62ec\u8d85\u7ea7\u7528\u6237;</li> <li><code>read_only=on</code>, slave\u5fc5\u987b\u8981\u5f00\u542f\u8fd9\u4e2a\uff0c\u907f\u514d\u4e1a\u52a1\u6267\u884csql;</li> <li>\u4fdd\u8bc1\u5f53\u524dslave\u7684\u4e8b\u52a1id\u4e3a1;</li> <li>\u5f53slave\u540c\u6b65\u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u624b\u52a8\u8df3\u8fc7\uff0c\u9700\u8981\u8003\u8651\u7684\u95ee\u9898</li> <li>\u6267\u884c\u7684sql\uff0c\u4e0d\u80fd\u8bb0\u5f55\u4e8b\u52a1id\uff0c\u5426\u5219slave\u5207\u6362\u4e3amaster\u65f6\uff0c\u4f1a\u5bfc\u81f4\u4ece\u540c\u6b65\u5931\u8d25\uff0c\u56e0\u4e3abinglog\u65e9\u5df2 \u5220\u9664\u3002</li> <li><code>SET @MYSQLDUMP_TEMP_LOG_BIN = @@SESSION.SQL_LOG_BIN;</code></li> <li><code>SET @@SESSION.SQL_LOG_BIN= 0;</code></li> </ul>"},{"location":"db_ops/16mysq_gtid/#10mysql-gtid","title":"10\u3001MySQL \u914d\u7f6e\u57fa\u4e8eGTID\u7684\u4e3b\u4ece\u590d\u5236","text":"<p>\u4f20\u7edf\u7684\u57fa\u4e8ebinlog position\u590d\u5236\u7684\u65b9\u5f0f\u6709\u4e2a\u4e25\u91cd\u7684\u7f3a\u70b9\uff1a\u5982\u679cslave\u8fde\u63a5master\u65f6\u6307\u5b9a\u7684binlog\u6587 \u4ef6\u9519\u8bef\u6216\u8005position\u9519\u8bef\uff0c\u4f1a\u9020\u6210\u9057\u6f0f\u6216\u8005\u91cd\u590d\uff0c \u5f88\u591a\u65f6\u5019\u524d\u540e\u6570\u636e\u662f\u6709\u4f9d\u8d56\u6027\u7684\uff0c\u8fd9\u6837\u5c31\u4f1a\u51fa \u9519\u800c\u5bfc\u81f4\u6570\u636e\u4e0d\u4e00\u81f4\u3002</p>"},{"location":"db_ops/16mysq_gtid/#_1","title":"\u7cfb\u7edf\u914d\u7f6e","text":"<pre><code>[root@mysql-master ~]# cat /etc/redhat-release\nCentOS Linux release 7.5.1804 (Core)\n# \u4e3a\u4e86\u65b9\u4fbf\u5b9e\u9a8c\uff0c\u5173\u95ed\u6240\u6709\u8282\u70b9\u7684\u9632\u706b\u5899\n[root@mysql-master ~]# systemctl stop firewalld\n[root@mysql-master ~]# cat /etc/sysconfig/selinux |grep \"SELINUX=disabled\"\nSELINUX=disabled\n[root@mysql-master ~]# setenforce 0              \nsetenforce: SELinux is disabled\n[root@mysql-master ~]# getenforce                \nDisabled\n</code></pre>"},{"location":"db_ops/16mysq_gtid/#mysql","title":"\u5b89\u88c5 Mysql","text":"<p>1)MySQL yum\u5305\u4e0b\u8f7d</p> <pre><code># wget http://repo.mysql.com/mysql57-community-releaseel7-10.noarch.rpm\n</code></pre> <p>2)MySQL \u8f6f\u4ef6\u6e90\u5b89\u8f6c</p> <pre><code># yum -y install mysql57-community-release-el7-10.noarch.rpm\n</code></pre> <p>3)MySQL \u670d\u52a1\u5b89\u88c5</p> <pre><code># yum install -y mysql-community-server mysql\n</code></pre> <p>4)MySQL \u670d\u52a1\u542f\u52a8</p> <pre><code># systemctl start mysqld.service\n</code></pre> <p>5)MySQL \u670d\u52a1\u8fd0\u884c\u72b6\u6001\u68c0\u67e5</p> <pre><code># systemctl status mysqld.service\n</code></pre> <p>6)MySQL \u4fee\u6539\u4e34\u65f6\u5bc6\u7801</p> <p>\u83b7\u53d6MySQL\u7684\u4e34\u65f6\u5bc6\u7801</p> <p>\u4e3a\u4e86\u52a0\u5f3a\u5b89\u5168\u6027\uff0cMySQL5.7\u4e3aroot\u7528\u6237\u968f\u673a\u751f\u6210\u4e86\u4e00\u4e2a\u5bc6\u7801\uff0c\u5728error log\u4e2d\uff0c\u5173\u4e8eerror log\u7684\u4f4d \u7f6e\uff0c\u5982\u679c\u5b89\u88c5\u7684\u662fRPM\u5305\uff0c\u5219\u9ed8\u8ba4\u662f<code>/var/log/mysqld.log</code>\u3002</p> <p>\u53ea\u6709\u542f\u52a8\u8fc7\u4e00\u6b21mysql\u624d\u53ef\u4ee5\u67e5\u770b\u4e34\u65f6\u5bc6\u7801</p> <pre><code> grep 'temporary password' /var/log/mysqld.log\n</code></pre> <p>\u767b\u9646\u5e76\u4fee\u6539\u5bc6\u7801</p> <p>\u4f7f\u7528\u9ed8\u8ba4\u7684\u5bc6\u7801\u767b\u9646</p> <pre><code># mysql -uroot -p\n</code></pre> <p>\u4fee\u6539\u5bc6\u7801</p> <pre><code>mysql&gt; ALTER USER 'root'@'localhost' IDENTIFIED BY 'Qfedu.123com';\n</code></pre> <p>\u89e3\u51b3\u4e0d\u7b26\u5408\u5bc6\u7801\u590d\u6742\u6027\u8981\u6c42</p> <pre><code>ERROR 1819 (HY000): Your password does not satisfy the current policy \nrequirements\n</code></pre> <p>\u4fee\u6539 \u5bc6\u7801\u7b56\u7565</p> <pre><code>mysql&gt; set global validate_password_policy=0;\n</code></pre> <p>\u4fee\u6539\u5bc6\u7801\u7684\u957f\u5ea6</p> <pre><code>mysql&gt; set global validate_password_length=1;\n</code></pre> <p>\u6267\u884c\u4fee\u6539\u5bc6\u7801\u6210\u529f</p> <pre><code>mysql&gt; ALTER USER 'root'@'localhost' IDENTIFIED BY 'root123';\n</code></pre>"},{"location":"db_ops/16mysq_gtid/#mysql_1","title":"MySQL \u6388\u6743\u8fdc\u7a0b\u4e3b\u673a\u767b\u5f55","text":"<pre><code>mysql&gt; GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'mypassword' WITH\nGRANT OPTION;\nmysql&gt; FLUSH  PRIVILEGES\n</code></pre>"},{"location":"db_ops/16mysq_gtid/#_2","title":"\u4e3b\u6570\u636e\u5e93\u4e0a\u7684\u64cd\u4f5c","text":"<p>1)\u5728<code>my.cnf</code>\u6587\u4ef6\u4e2d\u914d\u7f6eGTID\u4e3b\u4ece\u590d\u5236</p> <pre><code>[root@mysql-master ~]# cp /etc/my.cnf /etc/my.cnf.bak\n\n[root@mysql-master ~]# &gt;/etc/my.cnf\n\n[root@mysql-master ~]# cat /etc/my.cnf\n[mysqld]\ndatadir = /var/lib/mysql\nsocket = /var/lib/mysql/mysql.sock\n\nsymbolic-links = 0\n\nlog-error = /var/log/mysqld.log\npid-file = /var/run/mysqld/mysqld.pid\n\n#GTID:\nserver_id = 1\ngtid_mode = on\nenforce_gtid_consistency = on\n\n#binlog\nlog_bin = mysql-bin\nlog-slave-updates = 1\nbinlog_format = row\nsync-master-info = 1\nsync_binlog = 1\n\n#relay log\nskip_slave_start = 1\n</code></pre> <p>2)\u91cd\u542fmysql\u670d\u52a1</p> <pre><code># systemctl restart mysqld\n</code></pre> <p>3)\u767b\u5f55mysql\u5e76\u67e5\u770bmaster\u72b6\u6001</p> <p>\u53d1\u73b0\u591a\u4e86\u4e00\u9879<code>\"Executed_Gtid_Set \"</code></p> <pre><code># mysql -uroot -p'Qfedu.123com'\nmysql&gt; show master status;\n+-------------------+----------+--------------+------------------+--------------\n-----+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | \nExecuted_Gtid_Set |\n+-------------------+----------+--------------+------------------+--------------\n-----+\n| mysql-bin.000001 |      154 |             |                 |               \n    |\n+-------------------+----------+--------------+------------------+--------------\n-----+\n1 row in set (0.00 sec)\n\nmysql&gt; show global variables like '%uuid%';\n+---------------+--------------------------------------+\n| Variable_name | Value                               |\n+---------------+--------------------------------------+\n| server_uuid   | 317e2aad-1565-11e9-9c2e-005056ac6820 |\n+---------------+--------------------------------------+\n1 row in set (0.00 sec)\n</code></pre> <p>4)\u67e5\u770b\u786e\u8ba4 gtid \u529f\u80fd\u6253\u5f00</p> <pre><code>mysql&gt; show global variables like '%gtid%';\n+----------------------------------+-------+\n| Variable_name                   | Value |\n+----------------------------------+-------+\n| binlog_gtid_simple_recovery     | ON   |\n| enforce_gtid_consistency         | ON   |\n| gtid_executed                   |       |\n| gtid_executed_compression_period | 1000 |\n| gtid_mode                       | ON   |\n| gtid_owned                       |       |\n| gtid_purged                     |       |\n| session_track_gtids             | OFF   |\n+----------------------------------+-------+\n8 rows in set (0.00 sec)\n</code></pre> <p>5)\u67e5\u770b\u786e\u8ba4binlog\u65e5\u5fd7\u529f\u80fd\u6253\u5f00</p> <pre><code>mysql&gt; show variables like 'log_bin';\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| log_bin       | ON   |\n+---------------+-------+\n1 row in set (0.00 sec)\n</code></pre> <p>6)\u6388\u6743slave\u590d\u5236\u7528\u6237\u5e76\u5237\u65b0\u6743\u9650</p> <pre><code>mysql&gt; grant replication slave,replication client on *.* to\nslave@'192.168.152.%' identified by \"Qfedu.123com\";\nQuery OK, 0 rows affected, 1 warning (0.03 sec)\n\nmysql&gt; flush privileges;\nQuery OK, 0 rows affected (0.04 sec)\n\nmysql&gt; show grants for slave@'192.168.152.%';\n+-------------------------------------------------------------------------------\n+\n| Grants for slave@192.168.152.%                                               \n|\n+-------------------------------------------------------------------------------\n+\n| GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'192.168.152.%'\n|\n+-------------------------------------------------------------------------------\n+\n1 row in set (0.00 sec)\n</code></pre> <p>7)\u518d\u6b21\u67e5\u770bmaster\u72b6\u6001</p> <pre><code>mysql&gt; show master status;\n+-------------------+----------+--------------+------------------+--------------\n----------------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | \nExecuted_Gtid_Set                       |\n+-------------------+----------+--------------+------------------+--------------\n----------------------------+\n| mysql-bin.000001 |      622 |             |                 | 317e2aad-1565-\n11e9-9c2e-005056ac6820:1-2 |\n+-------------------+----------+--------------+------------------+--------------\n----------------------------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u542f\u52a8\u914d\u7f6e\u4e4b\u524d\uff0c\u540c\u6837\u9700\u8981\u5bf9\u4ece\u670d\u52a1\u5668\u8fdb\u884c\u521d\u59cb\u5316\u3002\u5bf9\u4ece\u670d\u52a1\u5668\u521d\u59cb\u5316\u7684\u65b9\u6cd5\u57fa\u672c\u548c\u57fa\u4e8e\u65e5\u5fd7\u70b9\u662f\u76f8 \u540c\u7684\uff0c\u53ea\u4e0d\u8fc7\u5728\u542f\u52a8\u4e86GTID\u6a21\u5f0f\u540e\uff0c\u5728\u5907\u4efd\u4e2d\u6240\u8bb0\u5f55\u7684\u5c31\u4e0d\u662f\u5907\u4efd\u65f6\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u6587\u4ef6\u540d\u548c\u504f\u79fb \u91cf\u4e86\uff0c\u800c\u662f\u8bb0\u5f55\u7684\u662f\u5907\u4efd\u65f6\u6700\u540e\u7684GTID\u503c\u3002</p> <p>\u9700\u8981\u5148\u5728\u4e3b\u6570\u636e\u5e93\u673a\u5668\u4e0a\u628a\u76ee\u6807\u5e93\u5907\u4efd\u4e00\u4e0b\uff0c\u5047\u8bbe\u8fd9\u91cc\u76ee\u6807\u5e93\u662fqfedu\uff08\u4e3a\u4e86\u6d4b\u8bd5\u6548\u679c\uff0c\u4e0b\u9762\u624b\u52a8 \u521b\u5efa\uff09</p> <pre><code>mysql&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql             |\n| performance_schema |\n| sys               |\n+--------------------+\n4 rows in set (0.00 sec)\n\nmysql&gt; CREATE DATABASE qfedu CHARACTER SET utf8 COLLATE utf8_general_ci;\nQuery OK, 1 row affected (0.02 sec)\n\nmysql&gt; use qfedu;\nDatabase changed\nmysql&gt; create table if not exists demo (id int(10) PRIMARY KEY\nAUTO_INCREMENT,name varchar(50) NOT NULL);\nQuery OK, 0 rows affected (0.27 sec)\n\nmysql&gt; insert into qfedu.demo values(1,\"congcong\"),(2,\"huihui\"),(3,\"grace\");   \nQuery OK, 3 rows affected (0.06 sec)\nRecords: 3 Duplicates: 0  Warnings: 0\n\nmysql&gt; select * from qfedu.demo;\n+----+----------+\n| id | name     |\n+----+----------+\n|  1 | congcong |\n|  2 | huihui   |\n|  3 | grace   |\n+----+----------+\n3 rows in set (0.00 sec)\n</code></pre> <p>9)\u5907\u4efdqfedu\u5e93</p> <pre><code>[root@mysql-master ~]# mysqldump --single-transaction --master-data=2 --triggers \n--routines --databases qfedu -uroot -p'Qfedu.123com' &gt; /root/qfedu.sql\n</code></pre> <ul> <li>mysql5.6\u4f7f\u7528mysqldump\u5907\u4efd\u65f6\uff0c\u6307\u5b9a\u5907\u4efd\u7684\u5177\u4f53\u5e93\uff0c\u4f7f\u7528<code>--database</code></li> <li>mysql5.7\u4f7f\u7528mysqldump\u5907\u4efd\u65f6\uff0c\u6307\u5b9a\u5907\u4efd\u7684\u5177\u4f53\u5e93\uff0c\u4f7f\u7528<code>--databases</code></li> </ul> <pre><code>[root@mysql-master ~]# ls /root/qfedu.sql\n/root/qfedu.sql\n[root@mysql-master ~]# cat /root/qfedu.sql\n-- MySQL dump 10.13 Distrib 5.7.24, for Linux (x86_64)\n--\n-- Host: localhost   Database: qfedu\n-- ------------------------------------------------------\n-- Server version       5.7.24-log\n.............\n.............\n--\n-- GTID state at the beginning of the backup\n--\n\nSET @@GLOBAL.GTID_PURGED='317e2aad-1565-11e9-9c2e-005056ac6820:1-5'; \n</code></pre> <p>10)\u540c\u6b65\u5907\u4efd\u5230\u4ece\u5e93</p> <p>\u628a\u5907\u4efd\u7684<code>/root/qfedu.sql</code>\u6587\u4ef6\u62f7\u8d1d\u5230mysql-slave\u4ece\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e0a</p> <pre><code>[root@mysql-master ~]# rsync -e \"ssh -p22\" -avpgolr /root/qfedu.sql  root@192.168.152.166:/root/\n</code></pre> <p>11)\u4ece\u6570\u636e\u5e93\u4e0a\u7684\u64cd\u4f5c</p> <ul> <li>\u5728my.cnf\u6587\u4ef6\u4e2d\u914d\u7f6eGTID\u4e3b\u4ece\u590d\u5236 </li> <li>\u4e0e\u4e3b\u670d\u52a1\u5668\u914d\u7f6e\u9664\u4e86<code>server_id</code>\u4e0d\u4e00\u81f4\u5916\uff0c\u4ece\u670d\u52a1\u5668\u8fd8\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u91cc\u9762\u6dfb\u52a0\uff1a<code>\"read_only\uff1don\"</code> ,</li> <li>\u4f7f\u4ece\u670d\u52a1\u5668\u53ea\u80fd\u8fdb\u884c\u8bfb\u53d6\u64cd\u4f5c\uff0c\u6b64\u53c2\u6570\u5bf9\u8d85\u7ea7\u7528\u6237\u65e0\u6548\uff0c\u5e76\u4e14\u4e0d\u4f1a\u5f71\u54cd\u4ece\u670d\u52a1\u5668\u7684\u590d\u5236\uff1b</li> </ul> <pre><code>[root@mysql-slave ~]# cp /etc/my.cnf /etc/my.cnf.bak\n[root@mysql-slave ~]# &gt;/etc/my.cnf\n[root@mysql-slave ~]# vim /etc/my.cnf\n[mysqld]\ndatadir = /var/lib/mysql\nsocket = /var/lib/mysql/mysql.sock\n\nsymbolic-links = 0\n\nlog-error = /var/log/mysqld.log\npid-file = /var/run/mysqld/mysqld.pid\n\n#GTID:\nserver_id = 2\ngtid_mode = on\nenforce_gtid_consistency = on\n\n#binlog\nlog_bin = mysql-bin\nlog-slave-updates = 1\nbinlog_format = row\nsync-master-info = 1\nsync_binlog = 1\n\n#relay log\nskip_slave_start = 1\nread_only = on\n</code></pre> <p>12)\u91cd\u542fmysql\u670d\u52a1</p> <pre><code>[root@mysql-slave ~]# systemctl restart mysqld\n</code></pre> <p>13)\u4ece\u5e93\u5bfc\u5165\u6570\u636e</p> <p>\u63a5\u7740\u5c06\u4e3b\u6570\u636e\u5e93\u76ee\u6807\u5e93\u7684\u5907\u4efd\u6570\u636eqfedu.sql\u5bfc\u5165\u5230\u4ece\u6570\u636e\u5e93\u91cc</p> <pre><code>[root@mysql-slave ~]# ls /root/qfedu.sql\n/root/qfedu.sql\n[root@mysql-slave ~]# mysql -p'Qfedu.123com'\n.........\nmysql&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql             |\n| performance_schema |\n| sys               |\n+--------------------+\n4 rows in set (0.00 sec)\n\nmysql&gt; source /root/qfedu.sql;\n\nmysql&gt; select * from qfedu.demo;\n+----+----------+\n| id | name     |\n+----+----------+\n|  1 | congcong |\n|  2 | huihui   |\n|  3 | grace   |\n+----+----------+\n3 rows in set (0.00 sec)\n</code></pre> <p>14)\u4ece\u5e93\u914d\u7f6e\u540c\u6b65</p> <p>\u5728\u4ece\u6570\u636e\u5e93\u91cc\uff0c\u4f7f\u7528change master \u914d\u7f6e\u4e3b\u4ece\u590d\u5236</p> <pre><code>mysql&gt; stop slave;\nQuery OK, 0 rows affected, 1 warning (0.00 sec)\n\nmysql&gt; change master to\nmaster_host='172.16.60.211',master_user='slave',master_password='Qfedu.123com',m\naster_auto_position=1;\nQuery OK, 0 rows affected, 2 warnings (0.26 sec)\n\nmysql&gt; start slave;\nQuery OK, 0 rows affected (0.02 sec)\n\nmysql&gt; show slave status \\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                 Master_Host: 172.16.60.211\n                 Master_User: slave\n                 Master_Port: 3306\n               Connect_Retry: 60\n             Master_Log_File: mysql-bin.000001\n         Read_Master_Log_Pos: 1357\n               Relay_Log_File: mysql-slave1-relay-bin.000002\n               Relay_Log_Pos: 417\n       Relay_Master_Log_File: mysql-bin.000001\n             Slave_IO_Running: Yes\n           Slave_SQL_Running: Yes\n................\n................\n           Executed_Gtid_Set: 317e2aad-1565-11e9-9c2e-005056ac6820:1-5\n               Auto_Position: 1\n</code></pre> <p>\u7531<code>IO/SQL</code>\u7ebf\u7a0b\u4e3a <code>yes</code>\u53ef\u77e5\uff0c<code>mysql-slave</code>\u8282\u70b9\u5df2\u7ecf\u548c <code>mysql-master</code>\u8282\u70b9\u914d\u7f6e\u4e86\u4e3b\u4ece\u540c\u6b65\u5173\u7cfb</p> <p>15)\u68c0\u6d4b\u4e3b\u4ece\u540c\u6b65</p> <p>mysql-master\u4e3b\u6570\u636e\u5e93\u4e0a\u8fdb\u884c\u72b6\u6001\u67e5\u770b\u548c\u6d4b\u8bd5\u6d4b\u8bd5\u63d2\u5165</p> <pre><code>mysql&gt; show master status;\n+-------------------+----------+--------------+------------------+--------------\n----------------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | \nExecuted_Gtid_Set                       |\n+-------------------+----------+--------------+------------------+--------------\n----------------------------+\n| mysql-bin.000001 |     1357 |             |                 | 317e2aad-1565-\n11e9-9c2e-005056ac6820:1-5 |\n+-------------------+----------+--------------+------------------+--------------\n----------------------------+\n1 row in set (0.00 sec)\n\nmysql&gt; show slave hosts;\n+-----------+------+------+-----------+--------------------------------------+\n| Server_id | Host | Port | Master_id | Slave_UUID                           |\n+-----------+------+------+-----------+--------------------------------------+\n|         2 |     | 3306 |         1 | 2c1efc46-1565-11e9-ab8e-00505688047c |\n+-----------+------+------+-----------+--------------------------------------+\n1 row in set (0.00 sec)\n\nmysql&gt; insert into qfedu.demo values(4,\"beijing\"),(5,\"hefei\"),(10,\"xihu\");\nQuery OK, 3 rows affected (0.06 sec)\nRecords: 3 Duplicates: 0  Warnings: 0\n\nmysql&gt; delete from qfedu.demo where id&lt;4;\nQuery OK, 3 rows affected (0.10 sec)\n\nmysql&gt; select * from qfedu.demo;\n+----+---------+\n| id | name   |\n+----+---------+\n|  4 | beijing |\n|  5 | hefei   |\n| 10 | xihu   |\n+----+---------+\n3 rows in set (0.00 sec)\n</code></pre> <p>mysql-slave\u4ece\u6570\u636e\u5e93\u4e0a\u67e5\u770b</p> <pre><code>mysql&gt; select * from qfedu.demo;\n+----+---------+\n| id | name   |\n+----+---------+\n|  4 | beijing |\n|  5 | hefei   |\n| 10 | xihu   |\n+----+---------+\n3 rows in set (0.00 sec)\n</code></pre> <p>\u53d1\u73b0 mysql-slave\u4ece\u6570\u636e\u5e93\u5df2\u7ecf\u5c06\u65b0\u63d2\u5165\u7684\u6570\u636e\u540c\u6b65\u5b8c\u6210</p>"},{"location":"db_ops/17ops_review/","title":"Mysql OPS Review","text":""},{"location":"db_ops/17ops_review/#1-sql","title":"1 \u67e5\u8be2\u8bed\u8a00 SQL","text":"<p>\u6570\u636e\u5b9a\u4e49\u8bed\u8a00 (DDL)</p> <pre><code>show databases; # \u67e5\u770b\u6240\u6709\u6570\u636e\u5e93\uff1a\nshow tables; # \u67e5\u770b\u6240\u6709\u8868\uff1a    \n\ndrop database db1; # \u5220\u9664\u6570\u636e\u5e93    \ncreate database db1 default character set utf8; # \u521b\u5efa\u6570\u636e\u5e93    \n\nuse database; # \u9009\u62e9\u6570\u636e\u5e93\ncreate table t1(id int(3),name varchar(20)); # \u521b\u5efa\u8868\ndesc t1 # \u67e5\u770b\u8868\n\ninsert into t1 values(1,'user1'); # \u63d2\u5165\u6570\u636e\nalter table t1 add(age int(3)); # \u6dfb\u52a0\u8868\u5b57\u6bb5\u8bed\u53e5  \nalter table t1 drop id; # \u5220\u9664\u8868\u5b57\u6bb5\u8bed\u53e5  \nalter table t1 modify age varchar(2); # \u4fee\u6539\u8868\u5b57\u6bb5\u7c7b\u578b\u683c\u5f0f  \nalter table t1 change age p1age int(3); # \u4fee\u6539\u8868\u5b57\u6bb5\u540d\u79f0  \nalter table t1 rname per; # \u4fee\u6539\u8868\u540d\ntruncate table t1; # \u6e05\u7a7a\u8868\u7ed3\u6784  \ndrop table t1; # \u5220\u9664\u8868\u7ed3\u6784  \n</code></pre>"},{"location":"db_ops/17ops_review/#dml","title":"\u6570\u636e\u64cd\u7eb5\u8bed\u8a00(DML)","text":"<pre><code>insert into test(id,name,address) values(102,'rose','beijing');\n\n# \u5220\u9664\u8868test01\u4e2d\u7684\u6240\u6709\u6570\u636e\u3002\ndelete from test;\n\n# \u5220\u9664\u8868\u4e2dtest01\u4e2d\u7684id\u4e3a101\u7684\u8bb0\u5f55\u3002\ndelete from test where id=101;\n\n# \u4fee\u6539\u8868 test01 \u4e2d\u7684 id \u4e3a 102 \u7684 address \u4e3aenglish\uff0c\u4eba\u540d\u4e3a micheal\u3002\nupdate test01 set address='english',name='micheal' where id=102;\n\n\n# \u5c06 id \u4e3a 102 \u7684 address \u6539\u4e3a null.\nupdate test01 set address=null where id=102;\n</code></pre>"},{"location":"db_ops/17ops_review/#tcl","title":"\u4e8b\u7269\u63a7\u5236\u8bed\u8a00(TCL)","text":"<p>\u4e8b\u7269\u63a7\u5236\u8bed\u8a00 \uff08Transation Control Language\uff09 \u6709\u65f6\u53ef\u80fd\u9700\u8981\u4f7f\u7528 DML \u8fdb\u884c\u6279\u91cf\u6570\u636e\u7684\u5220\u9664\uff0c \u4fee\u6539\uff0c\u589e\u52a0\u3002</p>"},{"location":"db_ops/17ops_review/#data-query-language","title":"\u6570\u636e\u67e5\u8be2\u8bed\u8a00\uff08Data Query Language\uff09","text":"<pre><code>#\u67e5\u8be2\u5458\u5de5\u8868\u4e2d\u90e8\u95e8\u53f7\u4e3a 10 \u548c 20 \u7684\u5458\u5de5\u7684\u7f16\u53f7\uff0c\u59d3\u540d\uff0c\u804c\u4f4d\uff0c\u5de5\u8d44\nselect testid,name,job,sal from test where deptid=10 or deptid =20;\n\n# \u4f7f\u7528in \uff0cnot in\u4fee\u6539\u4e0a\u9762\u7684\u7ec3\u4e60\nselect testid,name,job,sal from test where deptid in(10,20);\nselect * from test where deptid not in (10,20);\n\n# \u67e5\u8be2\u5458\u5de5test,blake,clark\u4e09\u4e2a\u4eba\u7684\u5de5\u8d44\nselect * from test where sal&gt;all(select sal from test where name in\n('test','blake','clark'));\n\n\n# \u67e5\u8be2\u5de5\u8d44\u5927\u4e8e\u7b49\u4e8e1500\u5e76\u4e14\u5c0f\u4e8e\u7b49\u4e8e2500\u7684\u5458\u5de5\u7684\u6240\u6709\u4fe1\u606f\u3002\nselect * from test where sal between 1500 and 2500;\n\n# \u67e5\u8be2\u5de5\u8d44\u5c0f\u4e8e2000\u548c\u5de5\u8d44\u5927\u4e8e2500\u7684\u6240\u6709\u5458\u5de5\u4fe1\u606f\u3002\nselect * from test where sal not between 2000 and 2500;\n\n# \u67e5\u8be2\u5458\u5de5\u59d3\u540d\u4e2d\u6709a\u548cs\u7684\u5458\u5de5\u4fe1\u606f\u3002\nselect name,job,sal,comm,deptid from test where name like '%a%' and name like\n'%s%';\n\n\n# \u6392\u5e8f\u89c4\u5219: ASC\uff1a\u5347\u5e8f \uff0cDESC: \u964d\u5e8f\uff0c\u9ed8\u8ba4\u662f\u5347\u5e8f\u6392\u5e8f\nselect * from test order by sal DESC;\n\n# Distinct \u53bb\u91cd\nselect distinct name from test;\n\n# \u5206\u7ec4\u67e5\u8be2 Group By \u5b50\u53e5\n# \u67e5\u8be2\u4ee5\u90e8\u95e8id\u4e3a\u5206\u7ec4\u5458\u5de5\u7684\u5e73\u5747\u5de5\u8d44\nselect deptid,avg(sal) as av from test group by deptid;\n\n# \u5206\u7ec4\u67e5\u8be2\u6dfb\u52a0\u6761\u4ef6 Having \u5b50\u53e5\n# \u67e5\u8be2\u4ee5\u90e8\u95e8id\u4e3a\u5206\u7ec4\u5458\u5de5\u7684\u5e73\u5747\u5de5\u8d44\u5e76\u4e14\u5927\u4e8e2000\u7684\u90e8\u95e8\nselect deptid,avg(sal) as av from test group by deptid having avg(sal)&gt;2000;\n\n# \u9ad8\u7ea7\u5173\u8054\u67e5\u8be2\n# \u67e5\u8be2\u8868\u4e2d\u5404\u90e8\u95e8\u4eba\u5458\u4e2d\u5927\u4e8e\u90e8\u95e8\u5e73\u5747\u5de5\u8d44\u7684\u4eba\nselect name,sal,a.deptid ,b.av\nfrom test a,\n(select deptid,avg(ifnull(sal,0)) as av from test group by deptid) b\nwhere a.deptid=b.deptid and a.sal&gt;b.av\norder by deptid ASC;\n</code></pre>"},{"location":"db_ops/17ops_review/#dcl","title":"\u6570\u636e\u63a7\u5236\u8bed\u8a00(DCL)","text":"<p>\u6570\u636e\u63a7\u5236\u8bed\u8a00 Data Control Language,\u4f5c\u7528\u662f\u7528\u6765\u521b\u5efa\u7528\u6237\uff0c\u7ed9\u7528\u6237\u6388\u6743\uff0c\u64a4\u9500\u6743\u9650\uff0c\u5220\u9664\u7528\u6237\u3002\u683c\u5f0f:</p> <pre><code># \u521b\u5efa\u7528\u6237\ncreate user username@ip identified by newPwd;\ncreate user 'test'@'192.168.152.166' identified by 'test.123com';\n\n# \u663e\u793a\u7528\u6237\u7684\u6743\u9650\nshow grants for username@ip;\n\n#  \u6388\u6743\ngrant select,drop,insert on test.* to 'test'@'192.168.152.166';\n\n# \u64a4\u9500\u6743\u9650\nrevoke drop on test.* to 'test'@'192.168.152.166';\n\n#  \u5220\u9664\u7528\u6237\ndrop user username;\ndrop user test;\n\n# \u4f7f\u6743\u9650\u7acb\u5373\u751f\u6548\nflush privileges\n</code></pre>"},{"location":"db_ops/17ops_review/#2-mysql","title":"2 MySQL \u64cd\u4f5c\u5b9e\u4f8b","text":"<pre><code>mysql&gt; create table slt(\nnum int auto_increment primary key,\nname char(10),\njob char(10),\nage int,\nsalary int,\ndescrip char(128)not null default ''\n)charset=utf8;\n</code></pre> <ul> <li><code>auto_increment</code> : \u81ea\u589e <code>1 primary key</code> : \u4e3b\u952e\u7d22\u5f15\uff0c\u52a0\u5feb\u67e5\u8be2\u901f\u5ea6, \u5217\u7684\u503c\u4e0d\u80fd\u91cd\u590d <code>NOT NULL</code> \u6807\u8bc6\u8be5\u5b57\u6bb5\u4e0d\u80fd\u4e3a\u7a7a <code>DEFAULT</code> \u4e3a\u8be5\u5b57\u6bb5\u8bbe\u7f6e\u9ed8\u8ba4\u503c</li> </ul> <pre><code>select distinct name, age from slt where job='teacher'\n\n# \u67e5\u770b\u5c97\u4f4d\u662fteacher\u4e14\u5e74\u9f84\u5927\u4e8e30\u5c81\u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u9f84\nmysql&gt; select distinct name, age from slt where job='teacher' and age&gt;30;\n\n# \u67e5\u770b\u5c97\u4f4d\u662f teacher\u4e14\u85aa\u8d44\u57281000-9000\u8303\u56f4\u5185\u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u9f84\u3001\u85aa\u8d44\nmysql&gt; select distinct name, age, salary from slt where job='teacher' and\n(salary&gt;1000 and salary&lt;9000)\n\n# \u67e5\u770b\u5c97\u4f4d\u63cf\u8ff0\u4e0d\u4e3aNULL\u7684\u5458\u5de5\u4fe1\u606f\nmysql&gt; select * from slt where descrip!=NULL\n\n# \u67e5\u770b\u5c97\u4f4d\u662fteacher\u4e14\u540d\u5b57\u662f'jin'\u5f00\u59cb\u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u85aa\nmysql&gt; select * from slt where job='teacher' and name like 'jin%' ;\n\n</code></pre>"},{"location":"db_ops/17ops_review/#_1","title":"\u4fee\u6539\u8868","text":"<pre><code># ALTER TABLE \u65e7\u8868\u540d RENAME \u65b0\u8868\u540d;\nalter table t3 rename t4;\n\nALTER TABLE \u8868\u540d\nADD \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570],\nADD \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570];\n\nalter table t88 add name varchar(32) not null default '';\n\n\n&lt;!--\u6dfb\u52a0\u5230\u5f00\u5934\u8bed\u6cd5\nALTER TABLE \u8868\u540d\nADD \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570] FIRST--&gt;\nalter table t88 add name3 varchar(32) not null default '' first;\n\n&lt;!--\u6dfb\u52a0\u5230\u6307\u5b9a\u5b57\u6bb5\u540e\u9762\nALTER TABLE \u8868\u540d\nADD \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570] AFTER \u5b57\u6bb5\u540d;--&gt;\nalter table t88 add name4 varchar(32) not null default '' after name;\n\n# \u5220\u9664\u5b57\u6bb5\n# ALTER TABLE \u8868\u540d  DROP \u5b57\u6bb5\u540d;\nalter table t88 drop name4;\n\n# \u4fee\u6539\u5b57\u6bb5\n# ALTER TABLE \u8868\u540d MODIFY \u5b57\u6bb5\u540d \u6570\u636e\u7c7b\u578b [\u5b8c\u6574\u6027\u7ea6\u675f\u6761\u4ef6\u2026];\nalter table t88 modify name char(20);\n</code></pre> <pre><code>\u5220\u9664\u8868\ndrop table t9;\n\n\u67e5\u8be2\u8868\nshow tables;\n\n\u590d\u5236\u8868\u7ed3\u6784\ncreate table t8 like t1;\n\ndelete from t1 where id&gt;=1 and id&lt;10;\ntruncate t1;\n</code></pre> <ul> <li>delete \u4e4b\u540e\uff0c\u63d2\u5165\u6570\u636e\u4ece\u4e0a\u4e00\u6b21\u4e3b\u952e\u81ea\u589e\u52a01\u5f00\u59cb\uff0c truncate\u5219\u662f\u4ece1\u5f00\u59cb</li> <li>delete \u5220\u9664\uff0c \u662f\u4e00\u884c\u4e00\u884c\u7684\u5220\u9664\uff0c truncate\uff1a\u5168\u9009\u5220\u9664 truncate\u5220\u9664\u7684\u901f\u5ea6\u662f\u9ad8\u4e8edelete\u7684</li> </ul>"},{"location":"db_ops/17ops_review/#_2","title":"\u4fee\u6539\u6570\u636e","text":"<pre><code># update \u8868\u540d set \u5217\u540d1=\u65b0\u503c1,\u5217\u540d2=\u65b0\u503c2 where \u6761\u4ef6;\nupdate t1 set name='qfx' where id=1;\n\n# \u5206\u7ec4\uff1aGroup By\n\u6ce8\u610f\uff1a\u51fa\u73b0 `sql_mode=only_full_group_by` \u9519\u8bef \u9700\u4fee\u6539 \u914d\u7f6e\u6587\u4ef6`/etc/my.cnf [mysqld] ` \u6bb5\u6dfb\u52a0 sql\u6a21\u5f0f\uff0c\u91cd\u542f mysqld\n\nsql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_\nZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\n\nselect depart_id,name, max(age) from test group by depart_id;\nselect depart_id,count(depart_id) from test group by depart_id;\nselect depart_id, avg(age) from test group by depart_id;\nselect depart_id, avg(age) from test group by depart_id having avg(age)&gt;35;\n\nselect * from test order by age asc, depart_id desc;\n\nselect * from test order by depart_id asc, age desc;\n\n#  Limit \u5206\u9875\uff1aLimit Offset, Size\n# offset \u8868\u793a \u884c\u6570\u636e\u7d22\u5f15\uff1bsize \u8868\u793a\u53d6\u591a\u5c11\u6761\u6570\u636e\n# \u4ece\u7b2c offset \u884c\u5f00\u59cb\uff0c\u53d6 size \u884c\u6570\u636e\u3002\n\n# \u4ece\u7b2c6\u884c\u5f00\u59cb\u53d610\u884c imit 6,10\nselect * from test limit 6,10;\n</code></pre>"},{"location":"db_ops/17ops_review/#_3","title":"\u591a\u8868\u64cd\u4f5c","text":"<pre><code># \u4e00\u5bf9\u591a\nconstraint \u5916\u952e\u540d foreign key (\u88ab\u7ea6\u675f\u7684\u5b57\u6bb5) references \u7ea6\u675f\u7684\u8868(\u7ea6\u675f\u7684\u5b57\u6bb5)\ncreate table dep(\nid int auto_increment primary key,\nname varchar(32) not null default ''\n)charset=utf8;\n\n\ncreate table userinfo (\nid int auto_increment primary key,\nname varchar(32) not null default '',\ndepart_id int not null default 1,\nconstraint fk_user_depart foreign key (depart_id) references dep(id)\n)charset utf8;\n\nselect * from boy left join b2g on boy.id=b2g.bid left join girl on girl.id=b2g.gid\n\n# \u591a\u5bf9\u591a\ncreate table b2g(\nid int auto_increment primary key,\nbid int not null default 1,\ngid int not null default 0,\nconstraint fk_b2g_boy foreign key (bid) references boy(id),\nconstraint fk_b2g_girl foreign key (gid) references girl(id)\n)charset utf8;\n\n# \u591a\u8868\u8054\u67e5\nselect userinfo.name as uname, dep.name as dname from userinfo left join dep on depart_id=dep.id\n</code></pre>"},{"location":"db_ops/17ops_review/#3-mysql","title":"3 MySQL \u6570\u636e\u7c7b\u578b\u7ea6\u675f","text":"<ul> <li>\u975e\u7a7a\u7ea6\u675f:  \u5c31\u662f\u9650\u5236\u6570\u636e\u5e93\u4e2d\u67d0\u4e2a\u503c\u662f\u5426\u53ef\u4ee5\u4e3a\u7a7a\uff0cnull\u5b57\u6bb5\u503c\u53ef\u4ee5\u4e3a\u7a7a\uff0cnot null\u5b57\u6bb5\u503c\u4e0d\u80fd\u4e3a\u7a7a</li> </ul> <pre><code>create table testnull(id int, username varchar(20) not null);  # \u521b\u5efatestnull \u8bbe\u7f6e username \u5b57\u6bb5\u4e3a\u975e\u7a7a\u7ea6\u675f notnull\n</code></pre> <ul> <li>\u552f\u4e00\u7ea6\u675f\uff1a \u5b57\u6bb5\u6dfb\u52a0\u552f\u4e00\u7ea6\u675f\u4e4b\u540e\uff0c\u8be5\u5b57\u6bb5\u7684\u503c\u4e0d\u80fd\u91cd\u590d\uff0c\u4e5f\u5c31\u662f\u8bf4\u5728\u4e00\u5217\u5f53\u4e2d\u4e0d\u80fd\u51fa\u73b0\u4e00\u6837\u7684\u503c</li> </ul> <pre><code># \u6dfb\u52a0\u552f\u4e00\u7ea6\u675f\nALTER TABLE tbl_name ADD [CONSTRAINT[symbol]]\nUNIQUE [INDEX|KEY] [index_name] [index_type] (index_col_name)\n\n# \u5220\u9664\u552f\u4e00\u7ea6\u675f\nALTERT TABLE tbl_name DROP {INDEX|KEY} index_name\n\nalter table testnull add unique(id);   # \u8bbe\u7f6e id \u5b57\u6bb5\u6dfb\u52a0\u4e00\u4e2a\u552f\u4e00\u7ea6\u675f unique\n</code></pre> <ul> <li>\u4e3b\u952e\u7ea6\u675f<ul> <li>\u4e3b\u952e\u4fdd\u8bc1\u8bb0\u5f55\u7684\u552f\u4e00\u6027\uff0c\u4e3b\u952e\u81ea\u52a8\u4e3aNOT NULL</li> <li>\u6bcf\u5f20\u6570\u636e\u8868\u53ea\u80fd\u5b58\u5728\u4e00\u4e2a\u4e3b\u952e NOT NULL + UNIQUE KEY \u4e00\u4e2aUNIQUE KEY</li> <li>\u4e00\u4e2aNOT NULL\u7684\u65f6\u5019\uff0c\u90a3\u4e48\u5b83\u88ab\u5f53\u505aPRIMARY KEY\u4e3b\u952e</li> <li>\u5f53\u4e00\u5f20\u8868\u91cc\u6ca1\u6709\u4e00\u4e2a\u4e3b\u952e\u7684\u65f6\u5019\uff0c\u7b2c\u4e00\u4e2a\u51fa\u73b0\u7684\u975e\u7a7a\u4e14\u4e3a\u552f\u4e00\u7684\u5217\u88ab\u89c6\u4e3a\u6709\u4e3b\u952e\u3002</li> </ul> </li> </ul> <pre><code># \u6dfb\u52a0\u4e3b\u952e\u7ea6\u675f\nALTER TABLE tbl_name ADD [CONSTRAINT[sysbol]]\nPRIMARY KEY [index_type] (index_col_name)\n\n# \u5220\u9664\u4e3b\u952e\u7ea6\u675f\nALTER TABLE tbl_name DROP PRIMARY KEY\n</code></pre> <ul> <li>\u81ea\u589e\u957f</li> </ul> <p>\u81ea\u589e\u957f <code>AUTO_INCREMENT</code> \u81ea\u52a8\u7f16\u53f7\uff0c\u4e14\u5fc5\u987b\u4e0e\u4e3b\u952e\u7ec4\u5408\u4f7f\u7528 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8d77\u59cb\u503c\u4e3a1\uff0c\u6bcf\u6b21\u7684 \u589e\u91cf\u4e3a1\u3002\u5f53\u63d2\u5165\u8bb0\u5f55\u65f6\uff0c\u5982\u679c\u4e3aAUTO_INCREMENT\u6570\u636e\u5217\u660e\u786e\u6307\u5b9a\u4e86\u4e00\u4e2a\u6570\u503c\uff0c\u5219\u4f1a\u51fa\u73b0\u4e24\u79cd \u60c5\u51b5\uff1a</p> <p>\u5982\u679c\u63d2\u5165\u7684\u503c\u4e0e\u5df2\u6709\u7684\u7f16\u53f7\u91cd\u590d\uff0c\u5219\u4f1a\u51fa\u73b0\u51fa\u9519\u4fe1\u606f\uff0c\u56e0\u4e3aAUTO_INCREMENT\u6570\u636e\u5217\u7684\u503c\u5fc5\u987b\u662f \u552f\u4e00\u7684\uff1b</p> <pre><code>ALTER TABLE user CHANGE id id INT NOT NULL AUTO_INCREMENT;\n\n\n#  \u5220\u9664\u81ea\u589e\u957f\nALTER TABLE user CHANGE id id INT NOT NULL;\n\n\u9ed8\u8ba4\u7ea6\u675f\n\u6dfb\u52a0/\u5220\u9664\u9ed8\u8ba4\u7ea6\u675f\nALTER TABLE tbl_name ALTER [COLUMN] col_name {SET DEFAULT literal | DROP DEFAULT}\n</code></pre>"},{"location":"db_ops/17ops_review/#mysql","title":"MySQL \u7d22\u5f15","text":"<ul> <li>\u666e\u901a\u7d22\u5f15\uff08INDEX\uff09\uff1a\u7d22\u5f15\u5217\u503c\u53ef\u91cd\u590d<ul> <li>\u666e\u901a\u7d22\u5f15\u5e38\u7528\u4e8e\u8fc7\u6ee4\u6570\u636e\u3002\u4f8b\u5982\uff0c\u4ee5\u5546\u54c1\u79cd\u7c7b\u4f5c\u4e3a\u7d22\u5f15\uff0c\u68c0\u7d22\u79cd\u7c7b\u4e3a\u201c\u624b\u673a\u201d\u7684\u5546\u54c1\u3002</li> </ul> </li> <li>\u552f\u4e00\u7d22\u5f15\uff08UNIQUE\uff09\uff1a\u7d22\u5f15\u5217\u503c\u5fc5\u987b\u552f\u4e00\uff0c\u53ef\u4ee5\u4e3aNULL<ul> <li>\u552f\u4e00\u7d22\u5f15\u4e3b\u8981\u7528\u4e8e\u6807\u8bc6\u4e00\u5217\u6570\u636e\u4e0d\u5141\u8bb8\u91cd\u590d\u7684\u7279\u6027\uff0c\u76f8\u6bd4\u4e3b\u952e\u7d22\u5f15\u4e0d\u5e38\u7528\u4e8e\u68c0\u7d22\u7684\u573a\u666f\u3002</li> </ul> </li> <li>\u4e3b\u952e\u7d22\u5f15\uff08PRIMARY KEY\uff09\uff1a\u7d22\u5f15\u5217\u503c\u5fc5\u987b\u552f\u4e00\uff0c\u4e0d\u80fd\u4e3aNULL\uff0c\u4e00\u4e2a\u8868\u53ea\u80fd\u6709\u4e00\u4e2a\u4e3b\u952e\u7d22\u5f15<ul> <li>\u4e3b\u952e\u7d22\u5f15\u662f\u884c\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u56e0\u800c\u5176\u4e3b\u8981\u7528\u9014\u662f\u68c0\u7d22\u7279\u5b9a\u6570\u636e\u3002 </li> </ul> </li> <li>\u5168\u6587\u7d22\u5f15\uff08FULL TEXT\uff09\uff1a\u7ed9\u6bcf\u4e2a\u5b57\u6bb5\u521b\u5efa\u7d22\u5f15<ul> <li>\u5168\u6587\u7d22\u5f15\u6548\u7387\u4f4e\uff0c\u5e38\u7528\u4e8e\u6587\u672c\u4e2d\u5185\u5bb9\u7684\u68c0\u7d22\u3002</li> </ul> </li> </ul> <pre><code># \u666e\u901a\u7d22\u5f15\uff08INDEX\uff09\n\n# \u5728\u521b\u5efa\u8868\u65f6\u6307\u5b9a\nmysql&gt; CREATE TABLE student (\n   id INT NOT NULL,\n   name VARCHAR(100) NOT NULL,\n   birthday DATE,\n   sex CHAR(1) NOT NULL,\n    INDEX nameIndex (name(50))\n);\n\n# \u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa\nmysql&gt; CREATE INDEX nameIndex ON student(name(50));\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u521b\u5efa\nmysql&gt; ALTER TABLE student ADD INDEX nameIndex(name(50));\n</code></pre> <ul> <li>\u5728\u521b\u5efa\u8868\u65f6\u6307\u5b9a\uff1a <code>INDEX nameIndex (name(50))</code></li> <li>\u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa\uff1a <code>CREATE INDEX nameIndex ON student(name(50));</code></li> <li>\u4fee\u6539\u8868\u7ed3\u6784\u521b\u5efa: <code>ALTER TABLE student ADD INDEX nameIndex(name(50));</code></li> </ul> <pre><code>\u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa: CREATE UNIQUE INDEX idIndex ON student(id)\n</code></pre> <ul> <li>\u4e3b\u952e\u7d22\u5f15\uff08PRIMARY KEY\uff09: \u4e3b\u952e\u7d22\u5f15\u4e0d\u80fd\u4f7f\u7528\u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa\u7684\u65b9\u5f0f\u521b\u5efa\u3002</li> </ul> <pre><code># \u4fee\u6539\u8868\u7ed3\u6784\u521b\u5efa\n\nALTER TABLE student ADD PRIMARY KEY (id):\n</code></pre>"},{"location":"db_ops/17ops_review/#_4","title":"\u5220\u9664\u7d22\u5f15","text":"<pre><code># \u666e\u901a\u7d22\u5f15\uff08INDEX\uff09\n\n# \u76f4\u63a5\u5220\u9664\nmysql&gt; DROP INDEX nameIndex ON student;\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u5220\u9664\nmysql&gt; ALTER TABLE student DROP INDEX nameIndex;\n\n# \u552f\u4e00\u7d22\u5f15\uff08UNIQUE\uff09\n# \u76f4\u63a5\u5220\u9664\nmysql&gt; DROP INDEX idIndex ON student;\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u5220\u9664\nmysql&gt; ALTER TABLE student DROP INDEX idIndex;\n\n# \u4e3b\u952e\u7d22\u5f15\uff08PRIMARY KEY\uff09\nmysql&gt; ALTER TABLE student DROP PRIMARY KEY;\n\n# \u67e5\u770b\u7d22\u5f15\nmysql&gt; SHOW INDEX FROM student;\n</code></pre>"},{"location":"db_ops/17ops_review/#mysql_1","title":"MySQL \u7684\u7528\u6237\u7ba1\u7406\u548c\u6743\u9650\u7ba1\u7406","text":"<p>DCL\uff08\u6570\u636e\u5e93\u63a7\u5236\u8bed\u8a00\uff09</p> <ul> <li>GRANT \u7528\u6237\u6388\u6743\uff0c\u4e3a\u7528\u6237\u8d4b\u4e88\u8bbf\u95ee\u6743\u9650</li> <li>REVOKE \u53d6\u6d88\u6388\u6743\uff0c\u64a4\u56de\u6388\u6743\u6743\u9650</li> </ul> <p>MySQL \u6743\u9650\u8868</p> <ul> <li> <p>mysql.user </p> <ul> <li>\u7528\u6237\u5b57\u6bb5\uff1aHost\u3001User\u3001Password</li> <li>\u6743\u9650\u5b57\u6bb5\uff1a<code>_Priv</code>\u7ed3\u5c3e\u7684\u5b57\u6bb5</li> <li>\u5b89\u5168\u5b57\u6bb5\uff1assl x509\u5b57\u6bb5</li> <li>\u8d44\u6e90\u63a7\u5236\u5b57\u6bb5\uff1a<code>max_</code>\u5f00\u5934\u7684\u5b57\u6bb5</li> </ul> </li> <li> <p>mysql.db</p> <ul> <li>\u7528\u6237\u5b57\u6bb5\uff1aHost\u3001User\u3001Password</li> <li>\u6743\u9650\u5b57\u6bb5\uff1a\u5269\u4e0b\u7684_Priv\u7ed3\u5c3e\u7684\u5b57\u6bb5</li> </ul> </li> <li> <p>\u6388\u6743\u7ea7\u522b\u6392\u5217</p> <ul> <li>mysql.user #\u5168\u5c40\u6388\u6743</li> <li>mysql.db #\u6570\u636e\u5e93\u7ea7\u522b\u6388\u6743</li> </ul> </li> <li> <p>\u7528\u6237\u548c IP\u683c\u5f0f</p> <ul> <li>\u7528\u6237\u540d@IP\u5730\u5740 \u7528\u6237\u53ea\u80fd\u5728\u6539IP\u4e0b\u624d\u80fd\u8bbf\u95ee</li> <li>\u7528\u6237\u540d@192.168.1.% \u7528\u6237\u53ea\u80fd\u5728\u6539IP\u6bb5\u4e0b\u624d\u80fd\u8bbf\u95ee(\u901a\u914d\u7b26%\u8868\u793a\u4efb\u610f)</li> <li>\u7528\u6237\u540d@%.qfedu.com</li> <li>\u7528\u6237\u540d@% \u7528\u6237\u53ef\u4ee5\u518d\u4efb\u610fIP\u4e0b\u8bbf\u95ee(\u9ed8\u8ba4IP\u5730\u5740\u4e3a%)</li> </ul> </li> </ul>"},{"location":"db_ops/17ops_review/#mysql_2","title":"MySQL \u7528\u6237\u7ba1\u7406","text":"<pre><code>\u521b\u5efa\u5b9e\u4f8b\n\nCREATE USER 'qfedu'@'localhost' IDENTIFIED BY '123456';\nCREATE USER 'qfedu'@'192.168.1.101' IDENDIFIED BY '123456';\nCREATE USER 'qfedu'@'192.168.1.%' IDENDIFIED BY '123456';\nCREATE USER 'qfedu'@'%' IDENTIFIED BY '123456';\nGRANT ALL ON *.* TO 'user3'@\u2019localhost\u2019 IDENTIFIED BY \u2018123456\u2019;\n# *.*\u6240\u6709\u6570\u636e\u5e93\n\n# DROP USER \u5220\u9664\nDROP USER 'user1'@\u2019localhost\u2019;\n\n# DELETE \u8bed\u53e5\u5220\u9664\nDELETE FROM mysql.user WHERE user=\u2019user2\u2019 AND host=\u2019localhost\u2019;\n\n# \u4fee\u6539\u7528\u6237\nRENAME USER 'old_user'@\u2018localhost\u2019 TO 'new_user'@'localhost';\n\n# \u4fee\u6539\u5bc6\u7801\n# \u6ce8\u610f\uff1a\u4fee\u6539\u5b8c\u5bc6\u7801\u5fc5\u987b\u5237\u65b0\u6743\u9650\n\nFLUSH PRIVILEGES;\n\n# root \u7528\u6237\u4fee\u6539\u81ea\u5df1\u5bc6\u7801\n\u65b9\u6cd5\u4e00\uff1a\nmysqladmin -uroot -p123 password 'new_password'  # 123\u4e3a\u65e7\u5bc6\u7801\n\n\u65b9\u6cd5\u4e8c\uff1a \nalter user 'root'@'localhost' identified by 'new_pssword';\n\n\u65b9\u6cd5\u4e09\uff1a\nSET PASSWORD=password(\u2018new_password\u2019);\n\n# root \u4fee\u6539\u5176\u4ed6\u7528\u6237\u5bc6\u7801\n\u65b9\u6cd5\u4e00\uff1a\nalter user 'qfedu'@'localhost' identified by 'Qfedu.1234com';\n\n\u65b9\u6cd5\u4e09\uff1a\nGRANT SELECT ON *.* TO \u7528\u6237\u540d@\u2019ip\u5730\u5740\u2019 IDENTIFIED BY \u2018yuan\u2019;\n\n# \u666e\u901a\u7528\u6237\u4fee\u6539\u81ea\u5df1\u5bc6\u7801\nSET password=password(\u2018new_password\u2019);\n</code></pre>"},{"location":"db_ops/17ops_review/#root","title":"\u627e\u56de root \u5bc6\u7801","text":"<p>\u5728[mysqld]\u4e0b\u9762\u52a0\u4e0a <code>skip-grant-tables</code></p> <pre><code># vim /etc/my.cnf\n[mysqld]\n\u00b7\u00b7\u00b7\n\n#\u8bbe\u7f6e\u514d\u5bc6\u767b\u5f55\nskip-grant-tables\n</code></pre> <p>\u8bbe\u7f6e\u5bc6\u7801</p> <pre><code>mysql&gt; update user set authentication_string=password('\u5bc6\u7801') where user='root';\n</code></pre>"},{"location":"db_ops/17ops_review/#_5","title":"\u5bc6\u7801\u590d\u6742\u5ea6","text":"<p>MySQL \u9ed8\u8ba4\u542f\u7528\u4e86\u5bc6\u7801\u590d\u6742\u5ea6\u8bbe\u7f6e\uff0c\u63d2\u4ef6\u540d\u5b57\u53eb\u505a <code>validate_password</code></p> <pre><code>mysql&gt; INSTALL PLUGIN validate_password SONAME 'validate_password.so';\n</code></pre> <p>\u4fee\u6539\u914d\u7f6e</p> <pre><code># vim /etc/my.cnf\n[mysqld]\nplugin-load=validate_password.so\nvalidate_password_policy=0\nvalidate-password=FORCE_PLUS_PERMANENT\n</code></pre> <p>\u67e5\u770b\u5bc6\u7801\u7b56\u7565</p> <pre><code>mysql&gt; select @@validate_password_policy; # \u67e5\u770b\u5bc6\u7801\u590d\u6742\u6027\u7b56\u7565\n\nmysql&gt; select @@validate_password_length; # \u67e5\u770b\u5bc6\u7801\u590d\u6742\u6027\u8981\u6c42\u5bc6\u7801\u6700\u4f4e\u957f\u5ea6\u5927\u5c0f\n</code></pre>"},{"location":"db_ops/17ops_review/#mysql_3","title":"MySQL \u6743\u9650\u7ba1\u7406","text":"<pre><code>\u67e5\u770b\u6743\u9650\nSHOW GRANTS FOR '\u7528\u6237'@'IP\u5730\u5740';\nSHOW GRANTS FOR 'root'@'localhost';\n\n\u6388\u6743\u53ca\u8bbe\u7f6e\u5bc6\u7801\nGRANT \u6743\u9650 [,\u6743\u9650...[,\u6743\u9650]] NO \u6570\u636e\u5e93.\u6570\u636e\u8868 TO '\u7528\u6237'@'IP\u5730\u5740';\n\nGRANT \u6743\u9650 [,\u6743\u9650...[,\u6743\u9650]] NO \u6570\u636e\u5e93.\u6570\u636e\u8868 TO '\u7528\u6237'@'IP\u5730\u5740' IDENTIFIED BY '\u5bc6\u7801';\n\nmysql&gt; GRANT ALL ON *.* TO admin1@'%' IDENTIFIED BY '(Qfedu.123com)';\n\nmysql&gt; GRANT ALL ON *.* TO admin2@'%' IDENTIFIED BY '(Qfedu.123com)' WITH GRANT\nOPTION;\n\nmysql&gt; GRANT ALL ON qfedu.* TO admin3@'%' IDENTIFIED BY '(Qfedu.123com)';\nmysql&gt; GRANT ALL ON qfedu.* TO admin3@'192.168.122.220' IDENTIFIED BY\n'(Qfedu.123com)';\n\nmysql&gt; GRANT ALL ON qfedu.user TO admin4@'%' IDENTIFIED BY '(Qfedu.123com)';\nmysql&gt; GRANT SELECT(col1),INSERT(col2,col3) ON qfedu.user TO admin5@'%'\nIDENTIFIED BY '(Qfedu.123com)';\n</code></pre>"},{"location":"db_ops/17ops_review/#10-mysql","title":"10 MySQL \u65e5\u5fd7\u7ba1\u7406","text":""},{"location":"db_ops/17ops_review/#mysql_4","title":"MySQL\u9519\u8bef\u65e5\u5fd7","text":"<pre><code>$ vim /etc/my.cnf\nlog_error=/data/3306/data/mysql.log #\u8fd9\u91cc\u7684\u8def\u5f84\u548c\u6587\u4ef6\u540d\u79f0\u53ef\u4ee5\u968f\u4fbf\u5b9a\u4e49\n\nsystemctl restart mysqld\n</code></pre> <p>\u67e5\u770b\u9519\u8bef\u65e5\u5fd7</p> <pre><code>mysql&gt; select @@log_error;\n+---------------------------+\n| @@log_error |\n+---------------------------+\n| /data/3306/data/mysql.log |\n+---------------------------+\n1 row in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/17ops_review/#mysql_5","title":"MySQL \u4e8c\u8fdb\u5236\u65e5\u5fd7","text":"<ul> <li>\u6570\u636e\u6062\u590d\u5fc5\u5907\u7684\u65e5\u5fd7\u3002</li> <li>\u4e3b\u4ece\u590d\u5236\u4f9d\u8d56\u7684\u65e5\u5fd7\u3002</li> </ul> <pre><code># vim /etc/my.cnf\nserver_id=6\nlog_bin=/data/3306/binlog/mysql-bin\n</code></pre> <p>\u914d\u7f6e\u8bf4\u660e</p> <ul> <li>mysql-bin \u662f\u5728\u914d\u7f6e\u6587\u4ef6\u914d\u7f6e\u7684\u524d\u7f00</li> <li>000001 MySQL\u6bcf\u6b21\u91cd\u542f\uff0c\u91cd\u65b0\u751f\u6210\u65b0\u7684</li> </ul>"},{"location":"db_ops/17ops_review/#_6","title":"\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5185\u5bb9","text":"<p>DML \u8bed\u53e5\u6709\u4e09\u79cd\u6a21\u5f0f\uff1aSBR\u3001RBR\u3001MBR</p> <pre><code>mysql&gt; select @@binlog_format;\n+-----------------+\n| @@binlog_format |\n+-----------------+\n| ROW |\n+-----------------+\n1 row in set (0.00 sec)\n</code></pre> <ul> <li><code>statement----&gt;SBR</code>\uff1a\u505a\u4ec0\u4e48\u8bb0\u5f55\u4ec0\u4e48\uff0c\u5373SQL\u8bed\u53e5</li> <li><code>row----------&gt;RBR</code>\uff1a\u8bb0\u5f55\u6570\u636e\u884c\u7684\u53d8\u5316\uff08\u9ed8\u8ba4\u6a21\u5f0f\uff0c\u63a8\u8350\uff09</li> <li><code>mixed--------&gt;MBR</code>\uff1a\u81ea\u52a8\u5224\u65ad\u8bb0\u5f55\u6a21\u5f0f</li> </ul> <p>\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5de5\u4f5c\u6a21\u5f0f</p> <pre><code># vim /etc/my.cnf\n[mysqld]\nbinlog_format='ROW'\n</code></pre> <p>\u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5de5\u4f5c\u6a21\u5f0f</p> <pre><code>show variables like \"binlog%\";\n</code></pre> <p>\u4e8c\u8fdb\u5236\u65e5\u5fd7\u4e09\u79cd\u6a21\u5f0f\u7684\u533a\u522b</p> <p>ROW: \u57fa\u4e8e\u884c\u7684\u590d\u5236</p> <ul> <li>\u4f18\u70b9\uff1a\u6240\u6709\u7684\u8bed\u53e5\u90fd\u53ef\u4ee5\u590d\u5236\uff0c\u4e0d\u8bb0\u5f55\u6267\u884c\u7684sql\u8bed\u53e5\u7684\u4e0a\u4e0b\u6587\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u4ec5\u9700\u8981\u8bb0\u5f55\u90a3\u4e00\u6761\u8bb0\u5f55\u88ab \u4fee\u6539\u6210\u4ec0\u4e48\u4e86</li> <li>\u7f3a\u70b9\uff1abinlog \u5927\u4e86\u5f88\u591a\uff0c\u590d\u6742\u7684\u56de\u6eda\u65f6 binlog \u4e2d\u4f1a\u5305\u542b\u5927\u91cf\u7684\u6570\u636e</li> </ul> <p>Statement: \u57fa\u4e8esql\u8bed\u53e5\u7684\u590d\u5236</p> <ul> <li>\u4f18\u70b9\uff1a\u4e0d\u9700\u8981\u8bb0\u5f55\u6bcf\u4e00\u884c\u7684\u53d8\u5316\uff0c\u51cf\u5c11\u4e86binlog\u65e5\u5fd7\u91cf\uff0c\u8282\u7ea6\u4e86IO\uff0c\u63d0\u9ad8\u6027\u80fd</li> </ul> <p>mixed\u6a21\u5f0f \uff1arow \u4e0e statement \u7ed3\u5408</p> <p>\u5b9e\u9645\u4e0a\u5c31\u662f\u524d\u4e24\u79cd\u6a21\u5f0f\u7684\u7ed3\u5408\uff0c\u5728mixed\u6a21\u5f0f\u4e0b\uff0cmysql\u4f1a\u6839\u636e\u6267\u884c\u7684\u6bcf\u4e00\u6761\u5177\u4f53\u7684sql\u8bed\u53e5\u6765\u533a\u5206\u5bf9\u5f85 \u8bb0\u5f55\u7684\u65e5\u5fd7\u5f62\u5f0f\uff0c\u4e5f\u5c31\u662f\u5728statement\u548crow\u4e4b\u95f4\u9009\u4e00\u79cd\u3002</p> <p>\u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u914d\u7f6e\u4fe1\u606f</p> <pre><code>mysql&gt; show variables like '%log_bin%';\n+---------------------------------+--------------------------------+\n| Variable_name | Value |\n+---------------------------------+--------------------------------+\n| log_bin | ON |\n| log_bin_basename | /var/log/mysql/mysql-bin |\n| log_bin_index | /var/log/mysql/mysql-bin.index |\n| log_bin_trust_function_creators | OFF |\n| log_bin_use_v1_row_events | OFF |\n| sql_log_bin | ON |\n+---------------------------------+--------------------------------+\n6 rows in set (0.00 sec)\n</code></pre> <ul> <li><code>log_bin</code> \u5f00\u542f\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u5f00\u5173</li> <li><code>log_bin_basename</code> \u4f4d\u7f6e</li> <li><code>sql_log_bin</code> \u4e34\u65f6\u5f00\u542f\u6216\u5173\u95ed\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u5c0f\u5f00\u5173</li> </ul> <p>\u6253\u5370\u51fa\u5f53\u524dMySQL\u7684\u6240\u6709\u4e8c\u8fdb\u5236\u65e5\u5fd7\uff0c\u5e76\u4e14\u663e\u793a\u6700\u540e\u4f7f\u7528\u5230\u7684 position</p> <pre><code>mysql&gt; show binary logs;\nmysql&gt; show master status;\uff08\u5e38\u7528\uff09\n</code></pre> <p>\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5185\u5bb9\u7684\u67e5\u770b\u548c\u622a\u53d6</p> <pre><code># mysqlbinlog /data/3306/binlog/mysql-bin.000001\n\n# mysqlbinlog --base64-output=decode-rows -vvv\n/data/3306/binlog/mysql-bin.000001\n\n# mysqlbinlog --start-position=xxx --stop-position=xxx\n/data/3306/binlog/mysql-bin.000001 &gt;/data/bin.sql\n</code></pre> <p>\u6570\u636e\u6062\u590d\u5b9e\u4f8b</p> <pre><code>mysql&gt; create database binlog charset utf8mb4;\n\nmysql&gt; use binlog;\n\nmysql&gt; show binlog events in 'mysql-bin.000001';\n\u8d77\u70b9\uff1a\n| mysql-bin.000001 | 381 | Query | 6 | 497 | create\ndatabase binlog charset utf8mb4 |\n\u7ec8\u70b9\uff1a\n| mysql-bin.000001 | 1575 | Query | 6 | 1673 | drop\ndatabase binlog\n\n# \u622a\u53d6\u65e5\u5fd7\n# mysqlbinlog --start-position=381 --stop-position=1575\n/data/3306/binlog/mysql-bin.000003&gt;/data/bin.sql\n\n# \u6062\u590d\u65e5\u5fd7\nmysql&gt; set sql_log_bin=0; # \u4e34\u65f6\u5173\u95ed\u5f53\u524d\u4f1a\u8bdd\u7684binlog\u8bb0\u5f55\nmysql&gt; source /data/bin.sql;\nmysql&gt; set sql_log_bin=1; # \u6253\u5f00\u5f53\u524d\u4f1a\u8bdd\u7684binlog\n</code></pre>"},{"location":"db_ops/17ops_review/#_7","title":"\u4e8c\u8fdb\u5236\u65e5\u5fd7\u5176\u4ed6\u64cd\u4f5c","text":"<pre><code># \u67e5\u770b\u81ea\u52a8\u6e05\u7406\u5468\u671f\nmysql&gt; show variables like '%expire%';\n+--------------------------------+-------+\n| Variable_name | Value |\n+--------------------------------+-------+\n| disconnect_on_expired_password | ON |\n| expire_logs_days | 0 |\n+--------------------------------+-------+\n2 rows in set (0.00 sec)\n\n# \u96f6\u65f6\u8bbe\u7f6e\u81ea\u52a8\u6e05\u7406\u5468\u671f\nmysql&gt; set global expire_logs_days=8;\n\nmysql&gt; show variables like '%expire%';\n+--------------------------------+-------+\n| Variable_name | Value |\n+--------------------------------+-------+\n| disconnect_on_expired_password | ON |\n| expire_logs_days | 8 |\n+--------------------------------+-------+\n2 rows in set (0.00 sec)\n</code></pre> <p>\u6c38\u4e45\u751f\u6548</p> <pre><code># vim /etc/my.cnf\n[mysqld]\nexpire_logs_days=15;\n</code></pre> <p>\u624b\u5de5\u6e05\u7406</p> <pre><code>PURGE BINARY LOGS BEFORE now() - INTERVAL 3 day;\nPURGE BINARY LOGS TO 'mysql-bin.000009';\n</code></pre> <ul> <li>\u6ce8\u610f: \u4e0d\u8981\u624b\u5de5 rm binlog\u6587\u4ef6</li> <li>\u4e3b\u4ece\u5173\u7cfb\u4e2d\uff0c\u4e3b\u5e93\u6267\u884c\u6b64\u64cd\u4f5c reset master; \uff0c\u4e3b\u4ece\u73af\u5883\u5fc5\u5d29</li> </ul> <p>\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u6eda\u52a8</p> <pre><code>mysql&gt; flush logs;\nmysql&gt; select @@max_binlog_size;\n</code></pre>"},{"location":"db_ops/17ops_review/#_8","title":"\u6162\u65e5\u5fd7\u7b80\u4ecb","text":"<ul> <li>\u8bb0\u5f55\u8fd0\u884c\u8f83\u6162\u7684\u8bed\u53e5\u8bb0\u5f55slowlog\u4e2d\u3002</li> <li>\u529f\u80fd\u662f\u8f85\u52a9\u4f18\u5316\u7684\u5de5\u5177\u65e5\u5fd7\u3002\u3001</li> <li>\u5e94\u6fc0\u6027\u7684\u6162\u53ef\u4ee5\u901a\u8fc7show processlist\u8fdb\u884c\u76d1\u63a7</li> <li>\u4e00\u6bb5\u65f6\u95f4\u7684\u6162\u53ef\u4ee5\u8fdb\u884cslow\u8bb0\u5f55\u3001\u7edf\u8ba1</li> </ul> <p>\u67e5\u770b\u6162\u65e5\u5fd7</p> <pre><code>mysql&gt; show variables like '%slow_query%';\n+---------------------+-----------------------------------+\n| Variable_name | Value |\n+---------------------+-----------------------------------+\n| slow_query_log | OFF |\n| slow_query_log_file | /var/lib/mysql/localhost-slow.log |\n+---------------------+-----------------------------------+\n2 rows in set (0.00 sec)\n</code></pre> <p>\u67e5\u770b\u9608\u503c</p> <pre><code>mysql&gt; select @@long_query_time;\n\nmysql&gt; SHOW GLOBAL VARIABLES LIKE 'long_query_time%';\n\nmysql&gt; SHOW VARIABLES LIKE 'long_query_time%';\n\nmysql&gt; show variables like '%log_queries_not_using_indexes%';\n</code></pre> <p>\u914d\u7f6e\u6162\u65e5\u5fd7</p> <pre><code># \u96f6\u65f6\u8bbe\u7f6e\u5f00\u542f\nSET GLOBAL slow_query_log = 1; #\u9ed8\u8ba4\u672a\u5f00\u542f\uff0c\u5f00\u542f\u4f1a\u5f71\u54cd\u6027\u80fd\uff0cmysql\u91cd\u542f\u4f1a\u5931\u6548\n\n#\u8bbe\u7f6e\u9608\u503c\uff1a\nSET GLOBAL long_query_time=3;\n</code></pre> <p>\u6c38\u4e45\u751f\u6548</p> <pre><code># vim /etc/my.cnf\n[mysqld]\nslow_query_log=1\nslow_query_log_file=/data/3306/data/qfedu-slow.log\nlong_query_time=0.1 \u9ed8\u8ba4\u914d\u7f6e10\u79d2\u949f\nlog_queries_not_using_indexes=1\n</code></pre> <p>\u6162\u65e5\u5fd7\u5206\u6790\u5de5\u5177</p> <pre><code># mysqldumpslow -s r -t 10 /data/3306/data/qfedu-slow.log\n# \u5f97\u5230\u8fd4\u56de\u8bb0\u5f55\u96c6\u6700\u591a\u768410\u4e2aSQL\n\n# mysqldumpslow -s c -t 10 /data/3306/data/qfedu-slow.log\n# \u5f97\u5230\u8bbf\u95ee\u6b21\u6570\u6700\u591a\u768410\u4e2aSQL\n\n# mysqldumpslow -s t -t 10 -g \"LEFT JOIN\"\n/data/3306/data/qfedu-slow.log # \u5f97\u5230\u6309\u7167\u65f6\u95f4\u6392\u5e8f\u7684\u524d10\u6761\u91cc\u9762\u542b\u6709\u5de6\u8fde\u63a5\u7684\u67e5\u8be2\u8bed\u53e5\n\n# mysqldumpslow -s r -t 10 /data/3306/data/qfedu-slow.log |\nmore # \u7ed3\u5408| more\u4f7f\u7528\uff0c\u9632\u6b62\u7206\u5c4f\u60c5\u51b5\n</code></pre>"},{"location":"db_ops/17ops_review/#11-mysql","title":"11 MySQL\u5907\u4efd\u6982\u8ff0","text":"<p>\u5907\u4efd\u5fc5\u987b\u91cd\u89c6\u7684\u5185\u5bb9</p> <p>\u5907\u4efd\u5185\u5bb9 <code>databases Binlog my.conf</code></p> <ul> <li>\u6570\u636e\u7684\u4e00\u81f4\u6027</li> <li>\u670d\u52a1\u7684\u53ef\u7528\u6027</li> </ul>"},{"location":"db_ops/17ops_review/#mysql_6","title":"MySQL \u5907\u4efd\u7c7b\u578b","text":"<ul> <li>\u7269\u7406\u5907\u4efd: \u5bf9\u6570\u636e\u5e93\u64cd\u4f5c\u7cfb\u7edf\u7684\u7269\u7406\u6587\u4ef6\uff08\u5982\u6570\u636e\u6587\u4ef6\u3001\u65e5\u5fd7\u6587\u4ef6\u7b49\uff09\u7684\u5907\u4efd\u3002</li> <li>\u70ed\u5907(hot backup):  \u5728\u7ebf\u5907\u4efd\uff0c\u6570\u636e\u5e93\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\uff0c\u8fd9\u79cd\u5907\u4efd\u65b9\u6cd5\u4f9d\u8d56\u4e8e\u6570\u636e\u5e93\u7684\u65e5\u5fd7\u6587\u4ef6<ul> <li>\u5bf9\u5e94\u7528\u57fa\u672c\u65e0\u5f71\u54cd(\u5e94\u7528\u7a0b\u5e8f\u8bfb\u5199\u4e0d\u4f1a\u963b\u585e,\u4f46\u662f\u6027\u80fd\u8fd8\u662f\u4f1a\u6709\u4e0b\u964d,\u6240\u4ee5\u5c3d\u91cf\u4e0d\u8981\u5728\u4e3b\u4e0a\u505a\u5907\u4efd,\u5728 \u4ece\u5e93\u4e0a\u505a)</li> </ul> </li> <li>\u51b7\u5907(cold backup)<ul> <li>\u5907\u4efd\u6570\u636e\u6587\u4ef6,\u9700\u8981\u505c\u673a\uff0c\u662f\u5728\u5173\u95ed\u6570\u636e\u5e93\u7684\u65f6\u5019\u8fdb\u884c\u7684 \u5907\u4efd datadir \u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6</li> </ul> </li> <li> <p>\u6e29\u5907(warm backup)</p> </li> <li> <p>\u903b\u8f91\u5907\u4efd</p> </li> </ul>"},{"location":"db_ops/17ops_review/#mysql_7","title":"MySQL \u5907\u4efd\u5de5\u5177","text":"<ul> <li>ibbackup</li> <li>xtrabackup</li> <li>mysqldump</li> <li>mysqlbackup<ul> <li>innodb \u5f15\u64ce\u7684\u8868mysqlbackup\u53ef\u4ee5\u8fdb\u884c\u70ed\u5907</li> <li>\u975einnodb\u8868mysqlbackup\u5c31\u53ea\u80fd\u6e29\u5907</li> </ul> </li> </ul>"},{"location":"db_ops/17ops_review/#mysql_8","title":"MySQL \u5907\u4efd\u7b56\u7565","text":"<ul> <li>\u5b8c\u5168\u5907\u4efd: \u6bcf\u6b21\u5bf9\u6570\u636e\u8fdb\u884c\u5b8c\u6574\u7684\u5907\u4efd\uff0c\u5373\u5bf9\u6574\u4e2a\u6570\u636e\u5e93\u7684\u5907\u4efd\u3001\u6570\u636e\u5e93\u7ed3\u6784\u548c\u6587\u4ef6\u7ed3\u6784\u7684\u5907\u4efd\uff0c\u4fdd\u5b58\u7684\u662f\u5907\u4efd\u5b8c \u6210\u65f6\u523b\u7684\u6570\u636e\u5e93\uff0c\u662f\u5dee\u5f02\u5907\u4efd\u4e0e\u589e\u91cf\u5907\u4efd\u7684\u57fa\u7840\u3002</li> <li>\u5dee\u5f02\u5907\u4efd: \u5907\u4efd\u90a3\u4e9b\u81ea\u4ece\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u4e4b\u540e\u88ab\u4fee\u6539\u8fc7\u7684\u6240\u6709\u6587\u4ef6\uff0c\u5907\u4efd\u7684\u65f6\u95f4\u8d77\u70b9\u662f\u4ece\u4e0a\u6b21\u5b8c\u6574\u5907\u4efd\u8d77\uff0c\u5907\u4efd\u6570\u636e\u91cf\u4f1a\u8d8a\u6765\u8d8a\u5927\u3002<ul> <li>\u6062\u590d\u6570\u636e\u65f6\uff0c\u53ea\u9700\u6062\u590d\u4e0a\u6b21\u7684\u5b8c\u5168\u5907\u4efd\u4e0e\u6700\u8fd1\u7684\u4e00\u6b21\u5dee\u5f02\u5907\u4efd\u3002</li> </ul> </li> <li>\u589e\u91cf\u5907\u4efd: \u53ea\u6709\u90a3\u4e9b\u5728\u4e0a\u6b21\u5b8c\u5168\u5907\u4efd\u6216\u8005\u589e\u91cf\u5907\u4efd\u540e\u88ab\u4fee\u6539\u7684\u6587\u4ef6\u624d\u4f1a\u88ab\u5907\u4efd\u3002<ul> <li>\u4ee5\u4e0a\u6b21\u5b8c\u6574\u5907\u4efd\u6216\u4e0a\u6b21\u7684\u589e\u91cf\u5907\u4efd \u7684\u65f6\u95f4\u4e3a\u65f6\u95f4\u70b9\uff0c\u4ec5\u5907\u4efd\u8fd9\u4e4b\u95f4\u7684\u6570\u636e\u53d8\u5316\uff0c\u56e0\u800c\u5907\u4efd\u7684\u6570\u636e\u91cf\u5c0f\uff0c\u5360\u7528\u7a7a\u95f4\u5c0f\uff0c\u5907\u4efd\u901f\u5ea6\u5feb\u3002</li> </ul> </li> </ul>"},{"location":"db_ops/17ops_review/#mysql_9","title":"MySQL \u4e3b\u4ece\u590d\u5236\u539f\u7406\u4ecb\u7ecd","text":""},{"location":"db_ops/17ops_review/#mysql_10","title":"MySQL \u4e3b\u4ece\u590d\u5236\u8fc7\u7a0b","text":"<ul> <li>\u5f00\u542fbinlog\u65e5\u5fd7\uff0c\u901a\u8fc7\u628a\u4e3b\u5e93\u7684 binlog \u4f20\u9001\u5230\u4ece\u5e93\uff0c\u4ece\u65b0\u89e3\u6790\u5e94\u7528\u5230\u4ece\u5e93\u3002</li> <li>\u590d\u5236\u9700\u89813\u4e2a\u7ebf\u7a0b\uff08dump\u3001io\u3001sql\uff09\u5b8c\u6210\u3002</li> <li>\u590d\u5236\u662f\u5f02\u6b65\u7684\u8fc7\u7a0b\u3002\u4e3b\u4ece\u590d\u5236\u662f\u5f02\u6b65\u7684\u903b\u8f91\u7684SQL\u8bed\u53e5\u7ea7\u7684\u590d\u5236\u3002</li> </ul>"},{"location":"db_ops/17ops_review/#mysql_11","title":"MySQL \u4e3b\u4ece\u590d\u5236\u524d\u63d0","text":"<ul> <li>\u4e3b\u670d\u52a1\u5668\u4e00\u5b9a\u8981\u6253\u5f00\u4e8c\u8fdb\u5236\u65e5\u5fd7</li> <li>\u5fc5\u987b\u4e24\u53f0\u670d\u52a1\u5668\uff08\u6216\u8005\u662f\u591a\u4e2a\u5b9e\u4f8b\uff09</li> <li>\u4ece\u670d\u52a1\u5668\u9700\u8981\u4e00\u6b21\u6570\u636e\u521d\u59cb\u5316</li> <li>\u5982\u679c\u4e3b\u4ece\u670d\u52a1\u5668\u90fd\u662f\u65b0\u642d\u5efa\u7684\u8bdd\uff0c\u53ef\u4ee5\u4e0d\u505a\u521d\u59cb\u5316</li> <li>\u5982\u679c\u4e3b\u670d\u52a1\u5668\u5df2\u7ecf\u8fd0\u884c\u4e86\u5f88\u957f\u65f6\u95f4\u4e86\uff0c\u53ef\u4ee5\u901a\u8fc7\u5907\u4efd\u5c06\u4e3b\u5e93\u6570\u636e\u6062\u590d\u5230\u4ece\u5e93\u3002</li> <li>\u4e3b\u5e93\u5fc5\u987b\u8981\u6709\u5bf9\u4ece\u5e93\u590d\u5236\u8bf7\u6c42\u7684\u7528\u6237\u3002</li> <li>\u4ece\u5e93\u9700\u8981\u6709relay-log\u8bbe\u7f6e\uff0c\u5b58\u653e\u4ece\u4e3b\u5e93\u4f20\u9001\u8fc7\u6765\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7 show variables like '%relay%';</li> <li>\u5728\u7b2c\u4e00\u6b21\u7684\u65f6\u5019\uff0c\u4ece\u5e93\u9700\u8981change master to \u53bb\u8fde\u63a5\u4e3b\u5e93\u3002</li> <li>change master\u4fe1\u606f\u9700\u8981\u5b58\u653e\u5230 master.info \u4e2d show variables like '%master_info%';</li> <li>\u4ece\u5e93\u600e\u4e48\u77e5\u9053\uff0c\u4e3b\u5e93\u53d1\u751f\u4e86\u65b0\u7684\u53d8\u5316\u901a\u8fc7relay-log.info\u8bb0\u5f55\u7684\u5df2\u7ecf\u5e94\u7528\u8fc7\u7684relay-log\u4fe1\u606f\u3002</li> <li>\u5728\u590d\u5236\u8fc7\u7a0b\u4e2d\u6d89\u53ca\u5230\u7684\u7ebf\u7a0b<ul> <li>\u4ece\u5e93\u4f1a\u5f00\u542f\u4e00\u4e2aIO thread(\u7ebf\u7a0b)\uff0c\u8d1f\u8d23\u8fde\u63a5\u4e3b\u5e93\uff0c\u8bf7\u6c42binlog\uff0c\u63a5\u6536binlog\u5e76\u5199\u5165relaylog\u3002</li> <li>\u4ece\u5e93\u4f1a\u5f00\u542f\u4e00\u4e2aSQL thread(\u7ebf\u7a0b)\uff0c\u8d1f\u8d23\u6267\u884c<code>relay-log</code>\u4e2d\u7684\u4e8b\u4ef6\u3002</li> <li>\u4e3b\u5e93\u4f1a\u5f00\u542f\u4e00\u4e2adump thrad(\u7ebf\u7a0b)\uff0c\u8d1f\u8d23\u54cd\u5e94\u4ece<code>IO thread</code>\u7684\u8bf7\u6c42\u3002</li> </ul> </li> </ul>"},{"location":"db_ops/17ops_review/#mysql_12","title":"MySQL \u4e3b\u4ece\u590d\u5236\u5b9e\u73b0","text":"<ul> <li>\u901a\u8fc7\u4e8c\u8fdb\u5236\u65e5\u5fd7</li> <li>\u81f3\u5c11\u4e24\u53f0\uff08\u4e3b\u3001\u4ece\uff09</li> <li>\u4e3b\u670d\u52a1\u5668\u7684\u4e8c\u8fdb\u5236\u65e5\u5fd7\u201c\u62ff\u201d\u5230\u4ece\u670d\u52a1\u5668\u4e0a\u518d\u8fd0\u884c\u4e00\u904d\u3002</li> <li>\u901a\u8fc7\u7f51\u7edc\u8fde\u63a5\u4e24\u53f0\u673a\u5668\uff0c\u4e00\u822c\u90fd\u4f1a\u51fa\u73b0\u5ef6\u8fdf\u7684\u72b6\u6001\u3002\u4e5f\u53ef\u4ee5\u8bf4\u662f\u5f02\u6b65\u7684\u3002</li> <li>\u4ece\u5e93\u901a\u8fc7\u624b\u5de5\u6267\u884cchange master to\u8bed\u53e5\u8fde\u63a5\u4e3b\u5e93\uff0c\u63d0\u4f9b\u4e86\u8fde\u63a5\u7684\u7528\u6237\u4e00\u5207\u6761\u4ef6 user\u3001 password\u3001port\u3001ip</li> <li>\u5e76\u4e14\u8ba9\u4ece\u5e93\u77e5\u9053\uff0c\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u8d77\u70b9\u4f4d\u7f6e\uff08file\u540d position\u53f7\uff09</li> <li>\u542f\u52a8\u4ece\u5e93\u540c\u6b65\u670d\u52a1 start slave</li> <li>\u4ece\u5e93\u7684IO\u548c\u4e3b\u5e93\u7684dump\u7ebf\u7a0b\u5efa\u7acb\u8fde\u63a5</li> <li>\u4ece\u5e93\u6839\u636e<code>change master to</code> \u8bed\u53e5\u63d0\u4f9b\u7684<code>file</code>\u540d\u548c<code>position</code>\u53f7\uff0cIO\u7ebf\u7a0b\u5411\u4e3b\u5e93\u53d1\u8d77binlog\u7684\u8bf7\u6c42</li> <li>\u4e3b\u5e93<code>dump</code>\u7ebf\u7a0b\u6839\u636e\u4ece\u5e93\u7684\u8bf7\u6c42\uff0c\u5c06\u672c\u5730binlog\u4ee5events\u7684\u65b9\u5f0f\u53d1\u7ed9\u4ece\u5e93IO\u7ebf\u7a0b</li> <li>\u4ece\u5e93IO\u7ebf\u7a0b\u63a5\u6536binlog evnets\uff0c\u5e76\u5b58\u653e\u5230\u672c\u5730<code>relay-log</code>\u4e2d\uff0c\u4f20\u9001\u8fc7\u6765\u7684\u4fe1\u606f\uff0c\u4f1a\u8bb0\u5f55\u5230 <code>master.info</code>\u4e2d\u3002</li> <li>\u4ece\u5e93SQL\u7ebf\u7a0b\u5e94\u7528<code>relay-log</code>\uff0c\u5e76\u4e14\u628a\u5e94\u7528\u8fc7\u7684\u8bb0\u5f55\u5230<code>relay-log.info</code>,\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5df2\u7ecf\u5e94\u7528\u8fc7\u7684 relay\u4f1a\u81ea\u52a8\u88ab\u6e05\u7406purge\u3002</li> </ul>"},{"location":"db_ops/18review_short/","title":"SQL\u64cd\u4f5c\u7cbe\u7b80\u7248","text":""},{"location":"db_ops/18review_short/#sql","title":"SQL\u64cd\u4f5c\u7cbe\u7b80\u7248","text":"<p>\u6570\u636e\u5b9a\u4e49\u8bed\u8a00 (DDL)</p> <pre><code>show databases; # \u67e5\u770b\u6240\u6709\u6570\u636e\u5e93\uff1a /  show  tables; # \u67e5\u770b\u6240\u6709\u8868\uff1a \ndrop database db1; # \u5220\u9664\u6570\u636e\u5e93   \n\ncreate database db1 default character set utf8; # \u521b\u5efa\u6570\u636e\u5e93    \nuse database; # \u9009\u62e9\u6570\u636e\u5e93\n\ncreate table t1(id int(3),name varchar(20)); # \u521b\u5efa\u8868\n\ninsert into t1 values(1,'user1'); # \u63d2\u5165\u6570\u636e \n\nalter table t1 \\...\\\n                        add(age int(3)); # \u6dfb\u52a0\u8868\u5b57\u6bb5\u8bed\u53e5\n                        drop id; # \u5220\u9664\u8868\u5b57\u6bb5\u8bed\u53e5  \n                        modify age varchar(2); # \u4fee\u6539\u8868\u5b57\u6bb5\u7c7b\u578b\u683c\u5f0f  \n                        age p1age int(3); # \u4fee\u6539\u8868\u5b57\u6bb5\u540d\u79f0     \n\ntruncate table t1; # \u6e05\u7a7a\u8868\u7ed3\u6784   /  drop table t1; # \u5220\u9664\u8868\u7ed3\u6784 \n</code></pre> <p>\u6570\u636e\u64cd\u7eb5\u8bed\u8a00(DML)</p> <pre><code>insert into test(id,name,address) values(102,'rose','beijing');\n\n# \u5220\u9664\u8868\u4e2dtest01\u4e2d\u7684id\u4e3a101\u7684\u8bb0\u5f55\u3002\ndelete from test where id=101;\n\nupdate test01 set address='english',name='micheal' where id=102;\n</code></pre> <p>\u4e8b\u7269\u63a7\u5236\u8bed\u8a00 \uff08Transation Control Language\uff09 \u6709\u65f6\u53ef\u80fd\u9700\u8981\u4f7f\u7528 DML \u8fdb\u884c\u6279\u91cf\u6570\u636e\u7684\u5220\u9664\uff0c \u4fee\u6539\uff0c\u589e\u52a0\u3002</p> <ul> <li>\u6570\u636e\u67e5\u8be2\u8bed\u8a00\uff08Data Query Language\uff09</li> </ul> <pre><code>from test where deptid=10 or deptid=20;\n\n# \u4f7f\u7528in \uff0cnot in\u4fee\u6539\u4e0a\u9762\u7684\u7ec3\u4e60\nwhere deptid in(10,20);\nwhere not in (10,20);\n\n# \u67e5\u8be2\u5458\u5de5test,blake,clark\u4e09\u4e2a\u4eba\u7684\u5de5\u8d44\nselect  ... sal &gt; all(select sal from test where name in ('test','blake','clark'))\n\n# \u67e5\u8be2\u5de5\u8d44\u5927\u4e8e\u7b49\u4e8e1500\u5e76\u4e14\u5c0f\u4e8e\u7b49\u4e8e2500\u7684\u5458\u5de5\u7684\u6240\u6709\u4fe1\u606f\u3002\nwhere sal between 1500 and 2500;\n\n# \u67e5\u8be2\u5de5\u8d44\u5c0f\u4e8e2000\u548c\u5de5\u8d44\u5927\u4e8e2500\u7684\u6240\u6709\u5458\u5de5\u4fe1\u606f\u3002\nnot between 2000 and 2500;\n\n# \u67e5\u8be2\u5458\u5de5\u59d3\u540d\u4e2d\u6709a\u548cs\u7684\u5458\u5de5\u4fe1\u606f\u3002\nwhere name like '%a%' and name like '%s%';\n\n# \u6392\u5e8f\u89c4\u5219: ASC\uff1a\u5347\u5e8f \uff0cDESC: \u964d\u5e8f\uff0c\u9ed8\u8ba4\u662f\u5347\u5e8f\u6392\u5e8f\norder by sal DESC;\nselect * from test order by depart_id asc, age desc;\n\n# Distinct \u53bb\u91cd\nselect distinct name from test;\n\n\n# \u5206\u7ec4\u67e5\u8be2 Group By \u5b50\u53e5 / # \u67e5\u8be2\u4ee5\u90e8\u95e8id\u4e3a\u5206\u7ec4\u5458\u5de5\u7684\u5e73\u5747\u5de5\u8d44\nselect deptid,avg(sal) as av from test group by deptid;\n\n# \u5206\u7ec4\u67e5\u8be2\u6dfb\u52a0\u6761\u4ef6 Having \u5b50\u53e5\ngroup by deptid having avg(sal)&gt;2000;\n\n# \u9ad8\u7ea7\u5173\u8054\u67e5\u8be2\n# \u67e5\u8be2\u8868\u4e2d\u5404\u90e8\u95e8\u4eba\u5458\u4e2d\u5927\u4e8e\u90e8\u95e8\u5e73\u5747\u5de5\u8d44\u7684\u4eba\nselect name,sal,a.deptid ,b.av\nfrom test a,\n(select deptid,avg(ifnull(sal,0)) as av from test group by deptid) b\nwhere a.deptid=b.deptid and a.sal&gt;b.av\norder by deptid ASC;\n\n#  Limit \u5206\u9875\uff1aLimit Offset, Size\n# offset \u8868\u793a \u884c\u6570\u636e\u7d22\u5f15\uff1bsize \u8868\u793a\u53d6\u591a\u5c11\u6761\u6570\u636e\n# \u4ece\u7b2c offset \u884c\u5f00\u59cb\uff0c\u53d6 size \u884c\u6570\u636e\u3002\nselect * from test limit 6,10;\n</code></pre> <ul> <li>\u6570\u636e\u63a7\u5236\u8bed\u8a00(DCL)</li> </ul> <p>\u6570\u636e\u63a7\u5236\u8bed\u8a00 Data Control Language,\u4f5c\u7528\u662f\u7528\u6765\u521b\u5efa\u7528\u6237\uff0c\u7ed9\u7528\u6237\u6388\u6743\uff0c\u64a4\u9500\u6743\u9650\uff0c\u5220\u9664\u7528\u6237\u3002\u683c\u5f0f:</p> <pre><code># \u521b\u5efa\u7528\u6237\ncreate user username@ip identified by newPwd;\n# \u663e\u793a\u7528\u6237\u7684\u6743\u9650\nshow grants for username@ip;\n#  \u6388\u6743\ngrant select,drop,insert on test.* to 'test'@'192.168.152.166';\n# \u64a4\u9500\u6743\u9650  revoke drop on test.* to 'test'@'192.168.152.166';\n#  \u5220\u9664\u7528\u6237 drop user username;   \n# \u4f7f\u6743\u9650\u7acb\u5373\u751f\u6548 flush privileges\n</code></pre> <ul> <li>\u591a\u8868\u64cd\u4f5c</li> </ul> <pre><code># \u4e00\u5bf9\u591a\nconstraint \u5916\u952e\u540d foreign key (\u88ab\u7ea6\u675f\u7684\u5b57\u6bb5) references \u7ea6\u675f\u7684\u8868(\u7ea6\u675f\u7684\u5b57\u6bb5)\n\nconstraint fk_user_depart foreign key (depart_id) references dep(id)\n\nselect * from boy left join b2g on boy.id=b2g.bid left join girl on girl.id=b2g.gid\n\n\n# \u591a\u5bf9\u591a\nconstraint fk_b2g_boy foreign key (bid) references boy(id),\nconstraint fk_b2g_girl foreign key (gid) references girl(id)\n# \u591a\u8868\u8054\u67e5\nselect userinfo.name as uname, dep.name as dname from userinfo left join dep on depart_id=dep.id\n</code></pre>"},{"location":"db_ops/18review_short/#mysql","title":"MySQL \u7d22\u5f15","text":"<pre><code># \u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa  CREATE INDEX nameIndex ON student(name(50));\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u521b\u5efa   ALTER TABLE student ADD INDEX nameIndex(name(50));\n\n# \u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa: CREATE UNIQUE INDEX idIndex ON student(id)\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u521b\u5efa ALTER TABLE student ADD PRIMARY KEY (id):\n</code></pre> <p>\u5220\u9664\u7d22\u5f15</p> <pre><code># \u76f4\u63a5\u5220\u9664 DROP INDEX nameIndex ON student;\n# \u4fee\u6539\u8868\u7ed3\u6784\u5220\u9664   ALTER TABLE student DROP INDEX nameIndex;\n\n# \u4e3b\u952e\u7d22\u5f15\uff08PRIMARY KEY\uff09 ALTER TABLE student DROP PRIMARY KEY;\n# \u67e5\u770b\u7d22\u5f15 SHOW INDEX FROM student;\n</code></pre>"},{"location":"db_ops/18review_short/#mysql_1","title":"MySQL \u65e5\u5fd7\u7ba1\u7406","text":"<p>``` $ vim /etc/my.cnf log_error=/data/3306/data/mysql.log #\u8fd9\u91cc\u7684\u8def\u5f84\u548c\u6587\u4ef6\u540d\u79f0\u53ef\u4ee5\u968f\u4fbf\u5b9a\u4e49</p> <p>\u67e5\u770b\u9519\u8bef\u65e5\u5fd7 mysql&gt; select @@log_error;</p> <p>\u67e5\u770b\u4e8c\u8fdb\u5236\u65e5\u5fd7\u7684\u914d\u7f6e\u4fe1\u606f mysql&gt; show variables like '%log_bin%';</p> <p>\u624b\u5de5\u6e05\u7406 PURGE BINARY LOGS BEFORE now() - INTERVAL 3 day; PURGE BINARY LOGS TO 'mysql-bin.000009';</p> <p>\u67e5\u770b\u6162\u65e5\u5fd7 show variables like '%slow_query%';</p> <p>``</p>"},{"location":"db_ops/1db_intro/","title":"1\u3001\u6570\u636e\u5e93\u7b80\u4ecb\u3001\u53ca\u5e38\u7528\u6570\u636e\u5e93\u4ecb\u7ecd","text":""},{"location":"db_ops/1db_intro/#1_1","title":"1\u3001\u4ec0\u4e48\u662f\u6570\u636e\u5e93","text":"<p>\u6570\u636e\u5e93\u5c31\u662f\u4e00\u4e2a\u5b58\u653e\u8ba1\u7b97\u673a\u6570\u636e\u7684\u4ed3\u5e93\uff0c\u8fd9\u4e2a\u4ed3\u5e93\u662f\u6309\u7167\u4e00\u5b9a\u7684\u6570\u636e\u7ed3\u6784\uff08\u6570\u636e\u7ed3\u6784\u662f\u6307\u6570\u636e\u7684\u7ec4 \u7ec7\u5f62\u5f0f\u6216\u6570\u636e\u4e4b\u95f4\u7684\u8054\u7cfb\uff09\u6765\u5bf9\u6570\u636e\u8fdb\u884c\u7ec4\u7ec7\u548c\u5b58\u50a8\u7684\uff0c\u53ef\u4ee5\u901a\u8fc7\u6570\u636e\u5e93\u63d0\u4f9b\u7684\u591a\u79cd\u65b9\u6cd5\u6765\u7ba1\u7406\u5176 \u4e2d\u7684\u6570\u636e\u3002</p>"},{"location":"db_ops/1db_intro/#2","title":"2\u3001\u6570\u636e\u5e93\u7684\u79cd\u7c7b","text":"<p>\u6700\u5e38\u7528\u7684\u6570\u636e\u5e93\u6a21\u5f0f\u4e3b\u8981\u6709\u4e24\u79cd\uff0c\u5373\u5173\u7cfb\u578b\u6570\u636e\u5e93\u548c\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u3002</p>"},{"location":"db_ops/1db_intro/#3","title":"3\u3001\u751f\u4ea7\u73af\u5883\u5e38\u7528\u6570\u636e\u5e93","text":"<p>\u751f\u4ea7\u73af\u5883\u4e3b\u6d41\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6709 Oracle\u3001Microsoft SQL Server\u3001MySQL/MariaDB\u7b49\u3002</p> <p>\u751f\u4ea7\u73af\u5883\u4e3b\u6d41\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6709 MongoDB Memcached Redis</p>"},{"location":"db_ops/1db_intro/#4","title":"4\u3001\u5173\u7cfb\u578b\u6570\u636e\u5e93","text":"<p>1)\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4ecb\u7ecd</p> <p>\u5173\u7cfb\u578b\u6570\u636e\u5e93\u6a21\u578b\u662f\u628a\u590d\u6742\u7684\u6570\u636e\u7ed3\u6784\u5f52\u7ed3\u4e3a\u7b80\u5355\u7684\u4e8c\u5143\u5173\u7cfb\uff08\u5373\u4e8c\u7ef4\u8868\u683c\u5f62\u5f0f\uff09\u3002\u5728\u5173\u7cfb\u578b\u6570\u636e \u5e93\u4e2d\uff0c\u5bf9\u6570\u636e\u7684\u64cd\u4f5c\u51e0\u4e4e\u5168\u90e8\u5efa\u7acb\u5728\u4e00\u4e2a\u6216\u591a\u4e2a\u5173\u7cfb\u8868\u683c\u4e0a\uff0c\u901a\u8fc7\u8fd9\u4e9b\u5173\u8054\u7684\u8868\u683c\u5206\u7c7b\u3001\u5408\u5e76\u3001\u8fde \u63a5\u6216\u9009\u53d6\u7b49\u8fd0\u7b97\u6765\u5b9e\u73b0\u6570\u636e\u7684\u7ba1\u7406\u3002</p> <p>\u5173\u7cfb\u578b\u6570\u636e\u5e93\u8bde\u751f\u8ddd\u4eca\u5df2\u6709 40 \u591a\u5e74\u4e86\uff0c\u4ece\u7406\u8bba\u4ea7\u751f\u5230\u53d1\u5c55\u5230\u5b9e\u73b0\u4ea7\u54c1\uff0c\u4f8b\u5982\uff1a\u5e38\u89c1\u7684 MySQL \u548c Oracle \u6570\u636e\u5e93\uff0cOracle \u5728\u6570\u636e\u5e93\u9886\u57df\u91cc\u4e0a\u5347\u5230\u4e86\u9738\u4e3b\u5730\u4f4d\uff0c\u5f62\u6210\u6bcf\u5e74\u9ad8\u8fbe\u6570\u767e\u4ebf\u7f8e\u5143\u7684\u5e9e\u5927\u4ea7\u4e1a \u5e02\u573a\uff0c\u800c MySQL \u4e5f\u662f\u4e0d\u5bb9\u5ffd\u89c6\u7684\u6570\u636e\u5e93\uff0c\u4ee5\u81f3\u4e8e\u88ab Oracle \u91cd\u91d1\u6536\u8d2d\u4e86\u3002</p> <p>2)\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5c0f\u7ed3</p> <ul> <li>\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5728\u5b58\u50a8\u6570\u636e\u65f6\u5b9e\u9645\u5c31\u662f\u91c7\u7528\u7684\u4e00\u5f20\u4e8c\u7ef4\u8868\uff08\u548c Word \u548c Excell \u91cc\u8868\u683c\u51e0\u4e4e\u4e00\u6837\uff09\u3002</li> <li>\u5e02\u573a\u5360\u6709\u91cf\u8f83\u5927\u7684\u662f MySQL \u548c Oracle \u6570\u636e\u5e93\uff0c\u800c\u4e92\u8054\u7f51\u573a\u666f\u6700\u5e38\u7528\u7684\u662f MySQL \u6570\u636e\u5e93\u3002</li> <li>\u901a\u8fc7 SQL \u7ed3\u6784\u5316\u67e5\u8be2\u8bed\u8a00\u6765\u5b58\u53d6\u3001\u7ba1\u7406\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u6570\u636e\u3002</li> <li>\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5728\u4fdd\u6301\u6570\u636e\u5b89\u5168\u548c\u6570\u636e\u4e00\u81f4\u6027\u65b9\u9762\u5f88\u5f3a\uff0c\u9075\u5faa ACID \u7406\u8bba</li> </ul>"},{"location":"db_ops/1db_intro/#5","title":"5\u3001\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93","text":"<p>1)\u975e\u5173\u7cfb\u6570\u636e\u5e93\u8bde\u751f\u7684\u80cc\u666f</p> <p>\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e5f\u88ab\u79f0\u4e3a NoSQL \u6570\u636e\u5e93\uff0cNoSQL \u7684\u672c\u610f\u662f \u201cNot Only SQL\u201d\uff0c\u6307\u7684\u662f\u975e\u5173\u7cfb\u578b\u6570 \u636e\u5e93\uff0c\u800c\u4e0d\u662f\u201cNO SQL\u201d\u7684\u610f\u601d\uff0c\u56e0\u6b64\uff0cNoSQL \u7684\u4ea7\u751f\u5e76\u4e0d\u662f\u8981\u5f7b\u5e95\u5426\u5b9a\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0c\u800c\u662f\u4f5c\u4e3a \u4f20\u7edf\u6570\u636e\u5e93\u7684\u4e00\u4e2a\u6709\u6548\u8865\u5145\u3002NoSQL \u6570\u636e\u5e93\u5728\u7279\u5b9a\u7684\u573a\u666f\u4e0b\u53ef\u4ee5\u53d1\u6325\u96be\u4ee5\u60f3\u8c61\u7684\u9ad8\u6548\u7387\u548c\u9ad8\u6027\u80fd\u3002</p> <p>\u968f\u7740 Web2.0 \u7f51\u7ad9\u7684\u5174\u8d77\uff0c\u4f20\u7edf\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5728\u5e94\u4ed8 Web2.0 \u7f51\u7ad9\uff0c\u7279\u522b\u662f\u5bf9\u4e8e\u89c4\u6a21\u65e5\u76ca\u6269\u5927 \u7684\u6d77\u91cf\u6570\u636e\uff0c\u8d85\u5927\u89c4\u6a21\u548c\u9ad8\u5e76\u53d1\u7684\u5fae\u535a\u3001\u5fae\u4fe1\u3001SNS \u7c7b\u578b\u7684 Web2.0 \u7eaf\u52a8\u6001\u7f51\u7ad9\u5df2\u7ecf\u663e\u5f97\u529b\u4e0d\u4ece \u5fc3\uff0c\u66b4\u9732\u4e86\u5f88\u591a\u96be\u4ee5\u514b\u670d\u7684\u95ee\u9898\uff0c\u4f8b\u5982\uff1a\u4f20\u7edf\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93IO\u74f6\u9888\u3001\u6027\u80fd\u74f6\u9888\u90fd\u96be\u4ee5\u6709\u6548\u7a81\u7834\uff0c\u4e8e\u662f\u5f00\u59cb\u51fa\u73b0\u4e86\u5927\u6279\u9488\u5bf9\u7279\u5b9a\u573a\u666f\uff0c\u4ee5\u9ad8\u6027\u80fd\u548c\u4f7f\u7528\u4fbf\u5229\u4e3a\u76ee\u7684\u529f\u80fd\u7279\u5f02\u5316\u7684\u6570\u636e\u5e93\u4ea7\u54c1\u3002NoSQL\uff08\u975e\u5173\u7cfb\u578b\uff09\u7c7b\u7684\u6570\u636e\u5e93\u5c31\u662f\u8fd9\u6837\u7684\u60c5\u666f\u4e2d\u8bde\u751f\u5e76\u5f97\u5230\u4e86\u975e\u5e38\u8fc5\u901f\u7684\u53d1\u5c55\u3002</p> <p>NoSQL \u662f\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u5e7f\u4e49\u5b9a\u4e49\u3002\u5b83\u6253\u7834\u4e86\u957f\u4e45\u4ee5\u6765\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e0eACID\u7406\u8bba\u5927\u4e00\u7edf\u7684\u5c40 \u9762\u3002NoSQL\u6570\u636e\u5b58\u50a8\u4e0d\u9700\u8981\u56fa\u5b9a\u7684\u8868\u7ed3\u6784\uff0c\u901a\u5e38\u4e5f\u4e0d\u5b58\u5728\u8fde\u7eed\u64cd\u4f5c\u3002\u5728\u5927\u6570\u636e\u5b58\u53d6\u4e0a\u5177\u5907\u5173\u7cfb\u578b \u6570\u636e\u5e93\u65e0\u6cd5\u6bd4\u62df\u7684\u6027\u80fd\u4f18\u52bf\u3002\u8be5\u672f\u8bed\uff08NoSQL\uff09\u57282009\u5e74\u521d\u5f97\u5230\u4e86\u5e7f\u6cdb\u8ba4\u540c\u3002</p> <p>\u5f53\u4eca\u7684\u5e94\u7528\u4f53\u7cfb\u7ed3\u6784\u9700\u8981\u6570\u636e\u5b58\u50a8\u5728\u6a2a\u5411\u4f38\u7f29\u6027\u4e0a\u80fd\u591f\u6ee1\u8db3\u9700\u6c42\u3002\u800cNoSQL\u5b58\u50a8\u5c31\u662f\u4e3a\u4e86\u5b9e\u73b0\u8fd9 \u4e2a\u9700\u6c42\u800c\u8bde\u751f\u7684\u3002Google\u7684 BigTable \u4e0eAmazon\u7684Dynamo\u662f\u975e\u5e38\u6210\u529f\u7684\u5546\u4e1a NoSQL \u5b9e\u73b0\u3002\u4e00 \u4e9b\u5f00\u6e90\u7684 NoSQL \u4f53\u7cfb\uff0c\u5982 Facebook \u7684 Cassandra\uff0cApache \u7684 HBase\uff0c\u4e5f\u5f97\u5230\u4e86\u5e7f\u6cdb\u8ba4\u540c\uff0c Redis\uff0cMongoDB \u4e5f\u9010\u6e10\u7684\u8d8a\u6765\u8d8a\u53d7\u5230\u5404\u7c7b\u5927\u4e2d\u5c0f\u578b\u516c\u53f8\u7684\u6b22\u8fce\u548c\u8ffd\u6367\u3002</p> <p>2)\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5c0f\u7ed3</p> <ul> <li>NoSQL \u6570\u636e\u5e93\u4e0d\u662f\u5426\u5b9a\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0c\u800c\u662f\u4f5c\u4e3a\u5173\u7cfb\u6570\u636e\u5e93\u7684\u4e00\u4e2a\u91cd\u8981\u8865\u5145\u3002</li> <li>NoSQL \u6570\u636e\u5e93\u4e3a\u4e86\u7075\u6d3b\u53ca\u9ad8\u6027\u80fd\u3001\u9ad8\u5e76\u53d1\u800c\u751f\uff0c\u5ffd\u7565\u5f71\u54cd\u9ad8\u6027\u80fd\u3001\u9ad8\u5e76\u53d1\u7684\u529f\u80fd\u3002</li> <li>\u5728NoSQL \u6570\u636e\u5e93\u9886\u57df\uff0c\u5f53\u4eca\u7684\u6700\u5178\u578b\u4ea7\u54c1\u4e3a Redis\uff08\u6301\u4e45\u5316\u7f13\u5b58\uff09\u3001MongoDB\u3001 Memcached\uff08\u7eaf\u5185\u5b58\uff09\u7b49\u3002</li> <li>NoSQL \u6570\u636e\u5e93\u6ca1\u6709\u6807\u51c6\u7684\u67e5\u8be2\u8bed\u8a00\uff08SQL\uff09\uff0c\u901a\u5e38\u4f7f\u7528REST\u5f0f\u7684\u6570\u636e\u63a5\u53e3\u6216\u8005\u67e5\u8be2API\u3002</li> </ul> <p>3)\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u79cd\u7c7b</p> <p>1. \u952e\u503c\uff08Key-Value\uff09\u5b58\u50a8\u6570\u636e\u5e93</p> <p>\u952e\u503c\u6570\u636e\u5e93\u5c31\u7c7b\u4f3c\u4f20\u7edf\u8bed\u8a00\u4e2d\u4f7f\u7528\u7684\u54c8\u5e0c\u8868\u3002\u53ef\u4ee5\u901a\u8fc7key\u6765\u6dfb\u52a0\u3001\u67e5\u8be2\u6216\u8005\u5220\u9664\u6570\u636e\uff0c\u56e0\u4e3a\u4f7f\u7528 key\u4e3b\u952e\u8bbf\u95ee\uff0c\u6240\u4ee5\u4f1a\u83b7\u5f97\u5f88\u9ad8\u7684\u6027\u80fd\u53ca\u6269\u5c55\u6027\u3002</p> <p>\u952e\u503c\uff08Key-Value\uff09\u6570\u636e\u5e93\u4e3b\u8981\u662f\u4f7f\u7528\u4e00\u4e2a\u54c8\u5e0c\u8868\uff0c\u8fd9\u4e2a\u8868\u4e2d\u6709\u4e00\u4e2a\u7279\u5b9a\u7684\u952e\u548c\u4e00\u4e2a\u6307\u9488\u6307\u5411\u7279\u5b9a \u7684\u6570\u636e\u3002Key-Value\u6a21\u578b\u5bf9\u4e8eIT\u7cfb\u7edf\u6765\u8bf4\u7684\u4f18\u52bf\u5728\u4e8e\u7b80\u5355\u3001\u6613\u90e8\u7f72\u3001\u9ad8\u5e76\u53d1\u3002</p> <p>\u5178\u578b\u4ea7\u54c1\uff1aMemcached\u3001Redis\u3001MemcachedB\u3001Berkeley DB</p> <p>2. \u5217\u5b58\u50a8\uff08Column-Oriented\uff09\u6570\u636e\u5e93</p> <p>\u5217\u5b58\u50a8\u6570\u636e\u5e93\u5c06\u6570\u636e\u5b58\u50a8\u5b58\u5728\u5217\u65cf\uff08Column Family\uff09\u4e2d\uff0c\u4e00\u4e2a\u5217\u65cf\u5b58\u50a8\u7ecf\u5e38\u88ab\u4e00\u8d77\u67e5\u8be2\u7684\u76f8\u5173\u6570 \u636e\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5982\u679c\u6709\u4e00\u4e2a Person \u7c7b\uff0c\u901a\u5e38\u4f1a\u4e00\u8d77\u67e5\u8be2\u4ed6\u4eec\u7684\u59d3\u540d\u548c\u5e74\u9f84\u800c\u4e0d\u662f\u85aa\u8d44\u3002\u8fd9\u79cd\u60c5\u51b5 \u4e0b\uff0c\u59d3\u540d\u548c\u5e74\u9f84\u5c31\u4f1a\u88ab\u653e\u5165\u4e00\u4e2a\u5217\u65cf\u4e2d\uff0c\u800c\u85aa\u8d44\u5219\u5728\u53e6\u4e00\u4e2a\u5217\u65cf\u4e2d\u3002\u8fd9\u90e8\u5206\u6570\u636e\u5e93\u901a\u5e38\u7528\u6765\u5e94\u5bf9\u5206 \u5e03\u5f0f\u5b58\u50a8\u7684\u6d77\u91cf\u6570\u636e\u3002\u952e\u4ecd\u7136\u5b58\u5728\uff0c\u4f46\u662f\u4ed6\u4eec\u7684\u7279\u70b9\u662f\u6307\u5411\u4e86\u591a\u4e2a\u5217\u3002\u8fd9\u4e9b\u5217\u662f\u7531\u5217\u5bb6\u65cf\u6765\u5b89\u6392 \u7684\u3002</p> <p>\u5178\u578b\u4ea7\u54c1\uff1aCassandra\uff0cHBase</p> <p>3. \u9762\u5411\u6587\u6863\uff08Document-Oriented\uff09\u7684\u6570\u636e\u5e93</p> <p>\u6587\u6863\u578b\u6570\u636e\u5e93\u7684\u7075\u611f\u662f\u6765\u81ea\u4e8eLotus Notes\u529e\u516c\u8f6f\u4ef6\u7684\uff0c\u800c\u4e14\u5b83\u540c\u7b2c\u4e00\u79cd\u952e\u503c\u5b58\u50a8\u76f8\u7c7b\u4f3c\u3002\u8be5\u7c7b\u578b \u7684\u6570\u636e\u6a21\u578b\u662f\u7248\u672c\u5316\u7684\u6587\u6863\uff0c\u534a\u7ed3\u6784\u5316\u7684\u6587\u6863\u4ee5\u7279\u5b9a\u7684\u683c\u5f0f\u5b58\u50a8\uff0c\u6bd4\u5982JSON\u3002\u6587\u6863\u578b\u6570\u636e\u5e93\u53ef\u4ee5 \u770b\u4f5c\u662f\u952e\u503c\u6570\u636e\u5e93\u7684\u5347\u7ea7\u7248\uff0c\u5141\u8bb8\u4e4b\u95f4\u5d4c\u5957\u952e\u503c\u3002\u800c\u4e14\u6587\u6863\u578b\u6570\u636e\u5e93\u6bd4\u952e\u503c\u6570\u636e\u5e93\u7684\u67e5\u8be2\u6548\u7387\u66f4\u9ad8\u3002</p> <p>\u9762\u5411\u6587\u6863\u6570\u636e\u5e93\u4f1a\u5c06\u6570\u636e\u4ee5\u6587\u6863\u7684\u5f62\u5f0f\u5b58\u50a8\u3002\u6bcf\u4e2a\u6587\u6863\u90fd\u662f\u81ea\u5305\u542b\u7684\u6570\u636e\u5355\u5143\uff0c\u662f\u4e00\u7cfb\u5217\u6570\u636e\u9879\u7684 \u96c6\u5408\u3002\u6bcf\u4e2a\u6570\u636e\u9879\u90fd\u6709\u4e00\u4e2a\u540d\u79f0\u4e0e\u5bf9\u5e94\u7684\u503c\uff0c\u503c\u65e2\u53ef\u4ee5\u662f\u7b80\u5355\u7684\u6570\u636e\u7c7b\u578b\uff0c\u5982\u5b57\u7b26\u4e32\u3001\u6570\u5b57\u548c\u65e5\u671f \u7b49\uff1b\u4e5f\u53ef\u4ee5\u662f\u590d\u6742\u7684\u7c7b\u578b\uff0c\u5982\u6709\u5e8f\u5217\u8868\u548c\u5173\u8054\u5bf9\u8c61\u3002\u6570\u636e\u5b58\u50a8\u7684\u6700\u5c0f\u5355\u4f4d\u662f\u6587\u6863\uff0c\u540c\u4e00\u4e2a\u8868\u4e2d\u5b58\u50a8 \u7684\u6587\u6863\u5c5e\u6027\u53ef\u4ee5\u662f\u4e0d\u540c\u7684\uff0c\u6570\u636e\u53ef\u4ee5\u4f7f\u7528XML\u3001JSON \u6216\u8005 JsonB \u7b49\u591a\u79cd\u5f62\u5f0f\u5b58\u50a8</p> <p>\u5178\u578b\u4ea7\u54c1\uff1aMongDB\u3001CouchDB</p> <p>4. \u56fe\u5f62\uff08Graph\uff09\u6570\u636e\u5e93</p> <p>\u56fe\u5f62\u6570\u636e\u5e93\u5141\u8bb8\u6211\u4eec\u5c06\u6570\u636e\u4ee5\u56fe\u7684\u65b9\u5f0f\u5b58\u50a8\u3002\u5b9e\u4f53\u4f1a\u88ab\u4f5c\u4e3a\u9876\u70b9\uff0c\u800c\u5b9e\u4f53\u4e4b\u95f4\u7684\u5173\u7cfb\u5219\u4f1a\u88ab\u4f5c\u4e3a \u8fb9\u3002\u6bd4\u5982\u6211\u4eec\u6709\u4e09\u4e2a\u5b9e\u4f53\uff0cSteve Jobs\u3001Apple\u548cNext\uff0c\u5219\u4f1a\u6709\u4e24\u4e2a\u201cFounded by\u201d \u7684\u8fb9\u5c06 Apple \u548c Next \u8fde\u63a5\u5230 Steve Jobs\u3002</p> <p>\u56fe\u5f62\u7ed3\u6784\u7684\u6570\u636e\u5e93\u540c\u5176\u4ed6\u884c\u5217\u4ee5\u53ca\u521a\u6027\u7ed3\u6784\u7684 SQL \u6570\u636e\u5e93\u4e0d\u540c\uff0c\u5b83\u662f\u4f7f\u7528\u7075\u6d3b\u7684\u56fe\u5f62\u6a21\u578b\uff0c\u5e76\u4e14 \u80fd\u591f\u6269\u5c55\u5230\u591a\u4e2a\u670d\u52a1\u5668\u4e0a\u3002NoSQL \u6570\u636e\u5e93\u6ca1\u6709\u6807\u51c6\u7684\u67e5\u8be2\u8bed\u8a00\uff08SQL\uff09\uff0c\u56e0\u6b64\u8fdb\u884c\u6570\u636e\u67e5\u8be2\u9700\u8981 \u5b9a\u5236\u6570\u636e\u6a21\u578b\u3002\u8bb8\u591a NoSQL \u6570\u636e\u5e93\u90fd\u6709 REST \u7684\u6570\u636e\u63a5\u53e3\u6216\u8005\u67e5\u8be2 API\u3002</p> <p>\u5178\u578b\u4ea7\u54c1\uff1aNeo4J\u3001InfoGr id</p>"},{"location":"db_ops/1db_intro/#6","title":"6\u3001\u5e38\u7528\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf","text":""},{"location":"db_ops/1db_intro/#1oracle","title":"1)Oracle \u6570\u636e\u5e93","text":"<p>Oracle \u524d\u8eab\u53eb SDL\uff0c\u7531 Larry Ellison \u548c\u53e6\u4e24\u4e2a\u7f16\u7a0b\u4eba\u5458\u57281977\u521b\u529e\uff0c\u4ed6\u4eec\u5f00\u53d1\u4e86\u81ea\u5df1\u7684\u62f3\u5934\u4ea7 \u54c1\uff0c\u5728\u5e02\u573a\u4e0a\u5927\u91cf\u9500\u552e\uff0c1979\u5e74\uff0cOracle \u516c\u53f8\u5f15\u5165\u4e86\u7b2c\u4e00\u4e2a\u5546\u7528 SQL\u5173\u7cfb\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u3002Oracle\u516c\u53f8\u662f\u6700\u65e9\u5f00\u53d1\u5173\u7cfb\u6570\u636e\u5e93\u7684\u5382\u5546\u4e4b\u4e00\uff0c\u5176\u4ea7\u54c1\u652f\u6301\u6700\u5e7f\u6cdb\u7684\u64cd\u4f5c\u7cfb\u7edf\u5e73\u53f0\u3002\u76ee\u524d Oracle \u5173\u7cfb\u6570\u636e\u5e93\u4ea7\u54c1\u7684\u5e02\u573a\u5360\u6709\u7387\u6570\u4e00\u6570\u4e8c\u3002</p> <p>Oracle \u516c\u53f8\u662f\u76ee\u524d\u5168\u7403\u6700\u5927\u7684\u6570\u636e\u5e93\u8f6f\u4ef6\u516c\u53f8\uff0c\u4e5f\u662f\u8fd1\u5e74\u4e1a\u52a1\u589e\u957f\u6781\u4e3a\u8fc5\u901f\u7684\u8f6f\u4ef6\u63d0\u4f9b\u4e0e\u670d\u52a1 \u5546\u3002 2007\u5e747\u670812\u65e5\uff0c\u7532\u9aa8\u6587\u516c\u53f8\u5728\u7f8e\u56fd\u7ebd\u7ea6\u5ba3\u5e03\u63a8\u51fa\u6570\u636e\u5e93 Oracle llg\uff0c\u8fd9\u662f Oracle \u6570\u636e\u5e93\u7684\u6700\u65b0 \u7248\u672c\u3002Oracle \u4ecb\u7ecd\u8bf4\uff0cOraclellg \u6709400\u591a\u9879\u529f\u80fd\uff0c\u7ecf\u8fc7\u4e861500\u4e07\u4e2a\u5c0f\u65f6\u7684\u6d4b\u8bd5\uff0c\u5f00\u53d1\u5de5\u4f5c\u91cf\u8fbe\u5230 \u4e863.6\u4e07\u4eba/\u6708\u3002Oraclellg \u5728\u5b89\u5168\uff0cXML DB\uff0c\u5907\u4efd\u7b49\u65b9\u9762\u5f97\u5230\u4e86\u5f88\u5927\u63d0\u5347\u3002</p> <ul> <li>\u4e3b\u8981\u5e94\u7528\u8303\u56f4\uff1a\u4f20\u7edf\u5927\u4f01\u4e1a\uff0c\u5927\u516c\u53f8\uff0c\u653f\u5e9c\uff0c\u91d1\u878d\uff0c\u8bc1\u5238\u7b49\u7b49\u3002</li> <li>\u7248\u672c\u5347\u7ea7\uff1aOracle8i\uff0cOracle9i\uff0cOracle10g\uff0cOracle11g\uff0cOracle12c\u3002</li> </ul>"},{"location":"db_ops/1db_intro/#2mysql","title":"2)MySQL \u6570\u636e\u5e93","text":"<p>MySQL \u6570\u636e\u5e93\u662f\u4e00\u4e2a\u4e2d\u5c0f\u578b\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\uff0c\u8f6f\u4ef6\u5f00\u53d1\u8005\u4e3a\u745e\u5178 MySQL AB \u516c\u53f8\u3002\u5728 2008\u5e741\u670816\u53f7\u88ab Sun \u516c\u53f8\u6536\u8d2d\uff0c\u540e Sun \u516c\u53f8\u53c8\u88ab Oracle \u516c\u53f8\u6536\u8d2d\u3002\u76ee\u524dMySQL \u88ab\u5e7f\u6cdb\u5730\u5e94\u7528 \u5728 Internet \u4e0a\u7684\u5927\u4e2d\u5c0f\u578b\u7f51\u7ad9\u4e2d\u3002\u7531\u4e8e\u5176\u4f53\u79ef\u5c0f\u3001\u901f\u5ea6\u5feb\u3001\u603b\u4f53\u62e5\u6709\u6210\u672c\u4f4e\uff0c\u5c24\u5176\u662f\u5f00\u653e\u6e90\u7801\u8fd9 \u4e00\u7279\u70b9\uff0c\u8bb8\u591a\u5927\u4e2d\u5c0f\u578b\u7f51\u7ad9\u4e3a\u4e86\u964d\u4f4e\u7f51\u7ad9\u603b\u4f53\u62e5\u6709\u6210\u672c\u800c\u9009\u62e9\u4e86 MySQL \u4f5c\u4e3a\u7f51\u7ad9\u6570\u636e\u5e93\uff0c\u751a\u81f3\u56fd \u5185\u77e5\u540d\u7684\u6dd8\u5b9d\u7f51\u4e5f\u9009\u62e9\u5f03\u7528 Oracle \u800c\u66f4\u6362\u4e3a\u66f4\u5f00\u653e\u7684 MySQL\u3002</p> <p>MySQL \u6570\u636e\u5e93\u4e3b\u8981\u5e94\u7528\u8303\u56f4\uff1a\u4e92\u8054\u7f51\u9886\u57df\uff0c\u5927\u4e2d\u5c0f\u578b\u7f51\u7ad9\uff0c\u6e38\u620f\u516c\u53f8\uff0c\u7535\u5546\u5e73\u53f0\u7b49\u7b49\u3002</p>"},{"location":"db_ops/1db_intro/#3mariadb","title":"3)MariaDB \u6570\u636e\u5e93","text":"<p>MariaDB \u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf\u662f MySQL \u6570\u636e\u5e93\u7684\u4e00\u4e2a\u5206\u652f\uff0c\u4e3b\u8981\u7531\u5f00\u6e90\u793e\u533a\u7ef4\u62a4\uff0c\u91c7\u7528 GPL \u6388\u6743\u8bb8 \u53ef\u3002\u5f00\u53d1\u8fd9\u4e2a MariaDB \u6570\u636e\u5e93\u5206\u652f\u7684\u53ef\u80fd\u539f\u56e0\u4e4b\u4e00\u662f\uff1a\u7532\u9aa8\u6587\u516c\u53f8\u6536\u8d2d\u4e86MySQL \u540e\uff0c\u6709\u5c06 MySQL \u95ed\u6e90\u7684\u6f5c\u5728\u98ce\u9669\uff0c\u56e0\u6b64 MySQL \u5f00\u6e90\u793e\u533a\u91c7\u7528\u5206\u652f\u7684\u65b9\u5f0f\u6765\u907f\u5f00\u8fd9\u4e2a\u98ce\u9669\u3002</p> <p>\u5f00\u53d1 MariaDB \u6570\u636e\u5e93\u7684\u76ee\u7684\u662f\u5b8c\u5168\u517c\u5bb9 MySQL \u6570\u636e\u5e93\uff0c\u5305\u62ec API \u548c\u547d\u4ee4\u884c\uff0c\u4f7f\u4e4b\u80fd\u8f7b\u677e\u7684\u6210\u4e3a MySQL \u7684\u4ee3\u66ff\u54c1\u3002\u5728\u5b58\u50a8\u5f15\u64ce\u65b9\u9762\uff0c\u4f7f\u7528 XtraDB \uff08\u82f1\u8bed\uff1aXtraDB\uff09\u6765\u4ee3\u66ffMySQL \u7684 InnoDB MariaDB \u7531 MySQL \u7684\u521b\u59cb\u4eba Michael Widenius\uff08\u82f1\u8bed\uff1aMichael Widenius\uff09\u4e3b\u5bfc\u5f00\u53d1\uff0c\u4ed6\u65e9\u524d \u66fe\u4ee5 10 \u4ebf\u7f8e\u5143\u7684\u4ef7\u683c\uff0c\u5c06\u81ea\u5df1\u521b\u5efa\u7684\u516c\u53f8MySQL AB\u5356\u7ed9\u4e86 SUN\uff0c\u6b64\u540e\uff0c\u968f\u7740 SUN \u88ab\u7532\u9aa8\u6587\u6536 \u8d2d\uff0cMySQL \u7684\u6240\u6709\u6743\u4e5f\u843d\u5165Oracle \u7684\u624b\u4e2d\uff0cMariaDB \u6570\u636e\u5e93\u7684\u540d\u79f0\u6765\u81ea MySQL \u7684\u521b\u59cb\u4eba Michael Widenius \u7684\u5973\u513f Maria \u7684\u540d\u5b57\u3002</p> <p>MariaDB \u57fa\u4e8e\u4e8b\u52a1\u7684 Maria \u5b58\u50a8\u5f15\u64ce\uff0c\u66ff\u6362\u4e86MySQL \u7684 MylSAM \u5b58\u50a8\u5f15\u64ce\uff0c\u5b83\u4f7f\u7528\u4e86 Percona \u7684 XtraDB\uff08InnoDB\u7684\u53d8\u4f53\uff09\u3002\u8fd9\u4e2a\u7248\u672c\u8fd8\u5305\u62ec\u4e86 PrimeBaseXT\uff08PBXT\uff09\u548c FederatedX \u5b58\u50a8\u5f15 \u64ce\u3002</p>"},{"location":"db_ops/1db_intro/#4sql-server","title":"4)SQL Server \u6570\u636e\u5e93","text":"<p>Microsoft SQL Server\u662f\u5fae\u8f6f\u516c\u53f8\u5f00\u53d1\u7684\u5927\u578b\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7cfb\u7edf\u30021987\u5e74\uff0c\u5fae\u8f6f\u548cIBM\u5408\u4f5c\u5f00\u53d1\u5b8c \u6210 OS/2\uff0cIBM \u5728\u5176\u9500\u552e\u7684 OS/2 ExtendedEdition \u7cfb\u7edf\u4e2d\u7ed1\u5b9a\u4e86 OS/2 DatabaseManager\uff0c\u800c\u5fae \u8f6f\u4ea7\u54c1\u7ebf\u4e2d\u5c1a\u7f3a\u5c11\u6570\u636e\u5e93\u4ea7\u54c1\u3002\u4e3a\u6b64\uff0c\u5fae\u8f6f\u5c06\u76ee\u5149\u6295\u5411 Sybase\uff0c\u540c Sybase \u7b7e\u8ba2\u4e86\u5408\u4f5c\u534f\u8bae\uff0c\u4f7f \u7528 Sybase \u7684\u6280\u672f\u5f00\u53d1\u57fa\u4e8e OS/2 \u5e73\u53f0\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u30021989\u5e74\uff0c\u5fae\u8f6f\u53d1\u5e03\u4e86 SQLServer1.0 \u7248\u3002Microsoft \u5728\u4e0e Sybase\u5206\u9053\u626c\u9573\u540e\uff0c\u968f\u540e\u5728\u51766.05\u548c7.0\u7248\u672c\u4e2d\u91cd\u5199\u4e86\u6838\u5fc3\u6570\u636e\u5e93\u7cfb\u7edf\u3002</p> <p>SQL Server \u7684\u529f\u80fd\u6bd4\u8f83\u5168\u9762\uff0c\u6548\u7387\u9ad8\uff0c\u53ef\u4ee5\u4f5c\u4e3a\u4e2d\u578b\u4f01\u4e1a\u6216\u5355\u4f4d\u7684\u6570\u636e\u5e93\u5e73\u53f0\u3002</p> <p>SQL Server \u53ef\u4ee5\u4e0e Windows \u64cd\u4f5c\u7cfb\u7edf\u7d27\u5bc6\u96c6\u6210\uff0c\u4e0d\u8bba\u662f\u5e94\u7528\u7a0b\u5e8f\u5f00\u53d1\u901f\u5ea6\u8fd8\u662f\u7cfb\u7edf\u4e8b\u52a1\u5904\u7406\u8fd0 \u884c\u901f\u5ea6\uff0c\u90fd\u80fd\u5f97\u5230\u8f83\u5927\u7684 \u63d0\u5347\u3002\u5bf9\u4e8e\u5728 Windows \u5e73\u53f0\u4e0a\u5f00\u53d1\u7684\u5404\u79cd\u4f01\u4e1a\u7ea7\u4fe1\u606f\u7ba1\u7406\u7cfb\u7edf\u6765\u8bf4\uff0c \u4e0d\u8bba\u662fC/S\uff08\u5ba2\u6237\u673a/ \u670d\u52a1\u5668\uff09\u67b6\u6784\u8fd8\u662fB/S\uff08\u6d4f\u89c8\u5668/\u670d\u52a1\u5668\uff09\u67b6\u6784\uff0cSQL Server \u90fd\u662f\u4e00\u4e2a\u5f88\u597d\u7684 \u9009\u62e9\u3002SQL Server \u7684\u7f3a\u70b9\u662f\u53ea\u80fd\u5728 Windows \u7cfb\u7edf\u4e0b\u8fd0\u884c\u3002</p> <p>\u4e3b\u8981\u5e94\u7528\u8303\u56f4\uff1a\u90e8\u5206\u4f01\u4e1a\u7535\u5546\uff08\u592e\u89c6\u8d2d\u7269\uff09\uff0c\u4f7f\u7528windows\u670d\u52a1\u5668\u5e73\u53f0\u7684\u4f01\u4e1a\u3002</p>"},{"location":"db_ops/1db_intro/#5_1","title":"5)\u5176\u4ed6\u5173\u7cfb\u578b\u6570\u636e\u5e93","text":"<p>DB2, PostgreSQL,Informix,Sybase\u7b49\u3002\u8fd9\u4e9b\u5173\u7cfb\u578b\u6570\u636e\u5e93\u9010\u6b65\u7684\u6de1\u51fa\u4e86\u666e\u901a\u8fd0\u7ef4\u7684\u89c6\u7ebf\uff0c\u7279\u522b\u662f\u4e92\u8054\u7f51\u516c\u53f8\u51e0\u4e4e\u89c1\u4e0d\u5230\u3002</p>"},{"location":"db_ops/1db_intro/#7","title":"7\u3001\u5e38\u7528\u975e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7ba1\u7406\u7cfb\u7edf","text":""},{"location":"db_ops/1db_intro/#1memcachedkey-value","title":"1)Memcached\uff08Key-Value\uff09","text":"<p>Memcached \u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u3001\u9ad8\u6027\u80fd\u7684\u3001\u5177\u6709\u5206\u5e03\u5f0f\u5185\u5b58\u5bf9\u8c61\u7684\u7f13\u5b58\u7cfb\u7edf\u3002\u901a\u8fc7\u5b83\u53ef\u4ee5\u51cf\u8f7b\u6570\u636e\u5e93 \u8d1f\u8f7d\uff0c\u52a0\u901f\u52a8\u6001\u7684 Web \u5e94\u7528\uff0c\u6700\u521d\u7248\u672c\u7531 LiveJoumal \u7684 Brad Fitzpatrick\u57282003\u5e74\u5f00\u53d1\u5b8c\u6210\u3002\u76ee \u524d\u5168\u7403\u6709\u975e\u5e38\u591a\u7684\u7528\u6237\u90fd\u5728\u4f7f\u7528\u5b83\u6765\u6784\u5efa\u81ea\u5df1\u7684\u5927\u8d1f\u8f7d\u7f51\u7ad9\u6216\u63d0\u9ad8\u81ea\u5df1\u7684\u9ad8\u8bbf\u95ee\u7f51\u7ad9\u7684\u54cd\u5e94\u901f\u5ea6\u3002\u6ce8\u610f\uff1aMemcache \u662f\u8fd9\u4e2a\u9879\u76ee\u7684\u540d\u79f0\uff0c\u800cMemcached \u662f\u670d\u52a1\u5668\u7aef\u7684\u4e3b\u7a0b\u5e8f\u6587\u4ef6\u540d\u3002</p> <p>\u7f13\u5b58\u4e00\u822c\u7528\u6765\u4fdd\u5b58\u4e00\u4e9b\u7ecf\u5e38\u88ab\u5b58\u53d6\u7684\u5bf9\u8c61\u6216\u6570\u636e\uff08\u4f8b\u5982\uff0c\u6d4f\u89c8\u5668\u4f1a\u628a\u7ecf\u5e38\u8bbf\u95ee\u7684\u7f51\u9875\u7f13\u5b58\u8d77\u6765\u4e00 \u6837\uff09\uff0c\u901a\u8fc7\u7f13\u5b58\u6765\u5b58\u53d6\u5bf9\u8c61\u6216\u6570\u636e\u8981\u6bd4\u5728\u78c1\u76d8\u4e0a\u5b58\u53d6\u5feb\u5f88\u591a\uff0c\u524d\u8005\u662f\u5185\u5b58\uff0c\u540e\u8005\u662f\u78c1\u76d8\u3002Memcached \u662f\u4e00\u79cd\u7eaf\u5185\u5b58\u7f13\u5b58\u7cfb\u7edf\uff0c\u628a\u7ecf\u5e38\u5b58\u53d6\u7684\u5bf9\u8c61\u6216\u6570\u636e\u7f13\u5b58\u5728 Memcached \u7684\u5185\u5b58\u4e2d\uff0c \u8fd9\u4e9b\u88ab\u7f13\u5b58\u7684\u6570\u636e\u88ab\u7a0b\u5e8f\u901a\u8fc7API\u7684\u65b9\u5f0f\u88ab\u5b58\u53d6\uff0cMemcached\u91cc\u9762\u7684\u6570\u636e\u5c31\u50cf</p> <p>\u4e00\u5f20\u5de8\u5927\u7684 HASH \u8868\uff0c\u6570\u636e\u4ee5 Key-Value \u5bf9\u7684\u65b9\u5f0f\u5b58\u5728\u3002Memcached \u901a\u8fc7\u7f13\u5b58\u7ecf\u5e38\u88ab\u5b58\u53d6\u7684\u5bf9 \u8c61\u6216\u6570\u636e\uff0c\u4ece\u800c\u51cf\u8f7b\u9891\u7e41\u8bfb\u53d6\u6570\u636e\u5e93\u7684\u538b\u529b\uff0c\u63d0\u9ad8\u7f51\u7ad9\u7684\u54cd\u5e94\u901f\u5ea6\uff0c\u6784\u5efa\u51fa\u901f\u5ea6\u66f4\u5feb\u7684\u53ef\u6269\u5c55\u7684 Web\u5e94\u7528\u3002\u5b98\u65b9\uff1ahttp://Memcached.org/</p> <p>\u7531\u4e8eMemcached \u4e3a\u7eaf\u5185\u5b58\u7f13\u5b58\u8f6f\u4ef6\uff0c\u4e00\u65e6\u91cd\u542f\u6240\u6709\u6570\u636e\u90fd\u4f1a\u4e22\u5931\uff0c\u56e0\u6b64\uff0c\u65b0\u6d6a\u7f51\u57fa\u4e8e Memcached \u5f00\u53d1\u4e86\u4e00\u4e2a\u5f00\u6e90\u9879\u76ee MemcacheDB\u3002\u901a\u8fc7\u4e3a Memcached \u589e\u52a0 Berkeley DB \u7684\u6301 \u4e45\u5316\u5b58\u50a8\u673a\u5236\u548c\u5f02\u6b65\u4e3b\u8f85\u590d\u5236\u673a\u5236\uff0c\u4f7f Memcached \u5177\u5907\u4e86\u4e8b\u52a1\u6062\u590d\u80fd\u529b\u3001\u6301\u4e45\u5316\u6570\u636e\u5b58\u50a8\u80fd\u529b \u548c\u5206\u5e03\u5f0f\u590d\u5236\u80fd\u529b\uff0cMemcacheDB\u975e\u5e38\u9002\u5408\u9700\u8981\u8d85\u9ad8\u6027\u80fd\u8bfb\u5199\u901f\u5ea6\u3001\u6301\u4e45\u5316\u4fdd\u5b58\u7684\u5e94\u7528\u573a\u666f\uff0c\u4f46 \u662f\u6700\u8fd1\u51e0\u5e74\u9010\u6e10\u88ab\u5176\u4ed6\u7684\u6301\u4e45\u5316\u4ea7\u54c1\u66ff\u4ee3\u4f8b\u5982Redis\u3002</p>"},{"location":"db_ops/1db_intro/#2rediskey-value","title":"2)Redis\uff08Key-Value\uff09","text":"<p>Redis \u662f\u4e00\u4e2aKey-Value \u578b\u5b58\u50a8\u7cfb\u7edf\u3002\u4f46Redis\u652f\u6301\u7684\u5b58\u50a8value \u7c7b\u578b\u76f8\u5bf9\u66f4\u591a\uff0c\u5305\u62ec string\uff08\u5b57\u7b26 \u4e32\uff09\u3001list\uff08\u94fe\u8868\uff09\u3001set\uff08\u96c6\u5408\uff09\u548c zset\uff08\u6709\u5e8f\u96c6\u5408\uff09\u7b49\u3002\u8fd9\u4e9b\u6570\u636e\u7c7b\u578b\u90fd\u652f\u6301 push/pop\u3001 add/remove \u53ca\u53d6\u4ea4\u96c6\u3001\u5e76\u96c6\u548c\u5dee\u96c6\u53ca\u66f4\u4e30\u5bcc\u7684\u64cd\u4f5c\uff0c\u800c\u4e14\u8fd9\u4e9b\u64cd\u4f5c\u90fd \u662f\u539f\u5b50\u6027\u7684\u3002\u5728\u6b64\u57fa\u7840 \u4e0a\uff0cRedis \u652f\u6301\u5404\u79cd\u4e0d\u540c\u65b9\u5f0f\u7684\u6392\u5e8f\u3002\u4e0e Memcached \u4e00\u6837\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6548\u7387\uff0cRedis \u7684\u6570\u636e\u90fd\u662f\u7f13 \u5b58\u5728\u5185\u5b58\u4e2d\u3002\u533a\u522b\u662f Redis \u4f1a\u5468\u671f\u6027\u7684\u628a\u66f4\u65b0\u7684\u6570\u636e\u5199\u5165\u78c1\u76d8\u6216\u8005\u628a\u4fee\u6539\u64cd\u4f5c\u5199\u5165\u8ffd\u52a0\u7684\u8bb0\u5f55\u6587 \u4ef6\uff0c\u5e76\u4e14\u5728\u6b64\u57fa\u7840\u4e0a\u5b9e\u73b0\u4e86 Master-Slave\uff08\u4e3b\u4ece\uff09\u540c\u6b65\u3002</p> <p>Redis \u662f\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684 Key-Value \u6570\u636e\u5e93\u3002Redis \u7684\u51fa\u73b0\uff0c\u5f88\u5927\u7a0b\u5ea6\u8865\u507f\u4e86 Memcached \u8fd9\u7c7b Key-Value \u5b58\u50a8\u7684\u4e0d\u8db3\uff0c\u5728\u90e8\u5206\u573a\u5408\u53ef\u4ee5\u5bf9\u5173\u7cfb\u6570\u636e\u5e93\u7db1\u5f88\u597d\u7684\u8865\u5145\u4f5c\u7528\u3002\u5b83\u63d0\u4f9b\u4e86 Python\uff0c Ruby\uff0cErlang\uff0cPHP \u5ba2\u6237\u7aef\uff0c\u4f7f\u7528\u5f88\u65b9\u4fbf\u3002\u5b98\u65b9\uff1ahttp://www.Redis.io/documentation</p> <p>Redis \u7279\u70b9\uff1a</p> <ul> <li>\u652f\u6301\u5185\u5b58\u7f13\u5b58\uff0c\u8fd9\u4e2a\u529f\u80fd\u76f8\u5f53\u4e8e Memcached\u3002</li> <li>\u652f\u6301\u6301\u4e45\u5316\u5b58\u50a8\uff0c\u8fd9\u4e2a\u529f\u80fd\u76f8\u5f53\u4e8e MemcacheDB\uff0cTtserver\u3002</li> <li>\u6570\u636e\u7c7b\u578b\u66f4\u4e30\u5bcc\u3002\u6bd4\u5176\u4ed6 Key-Value \u5e93\u529f\u80fd\u66f4\u5f3a\u3002</li> <li>\u652f\u6301\u4e3b\u4ece\u96c6\u7fa4\uff0c\u5206\u5e03\u5f0f\u3002</li> <li>\u652f\u6301\u961f\u5217\u7b49\u7279\u6b8a\u529f\u80fd\u3002</li> </ul>"},{"location":"db_ops/1db_intro/#3mongodb-document-web","title":"3)MongoDB \uff08Document-Web\uff09","text":"<p>MongoDB \u662f\u4e00\u4e2a\u4ecb\u4e8e\u5173\u7cfb\u6570\u636e\u5e93\u548c\u975e\u5173\u7cfb\u6570\u636e\u5e93\u4e4b\u95f4\u7684\u4ea7\u54c1\uff0c\u662f\u975e\u5173\u7cfb\u6570\u636e\u5e93\u5f53\u4e2d\u529f\u80fd\u6700\u4e30\u5bcc\uff0c \u6700\u50cf\u5173\u7cfb\u6570\u636e\u5e93\u7684\u3002\u4ed6\u652f\u6301\u7684\u6570\u636e\u7ed3\u6784\u975e\u5e38\u677e\u6563\uff0c\u7c7b\u4f3c Json \u7684 Bjson \u683c\u5f0f\uff0c\u56e0\u6b64\u53ef\u4ee5\u5b58\u50a8\u6bd4\u8f83\u590d \u6742\u7684\u6570\u636e\u7c7b\u578b\u3002MongoDB \u6700\u5927\u7684\u7279\u70b9\u662f\u4ed6\u652f\u6301\u67e5\u8be2\u8bed\u8a00\u975e\u5e38\u5f3a\u5927\uff0c\u5176\u8bed\u6cd5\u6709\u70b9\u7c7b\u4f3c\u4e8e\u9762\u5411\u5bf9\u8c61\u7684 \u67e5\u8be2\u8bed\u8a00\uff0c\u51e0\u4e4e\u53ef\u4ee5\u5b9e\u73b0\u7c7b\u4f3c\u5173\u7cfb\u6570\u636e\u5e93\u5355\u8868\u67e5\u8be2\u7684\u7edd\u5927\u90e8\u5206\u529f\u80fd\uff0c\u800c\u4e14\u8fd8\u652f\u6301\u5bf9\u6570\u636e\u5efa\u7acb\u7d22\u5f15\u3002\u5b83\u7684\u7279\u70b9\u662f\u9ad8\u6027\u80fd\u3001\u6613\u90e8\u7f72\u3001\u6613\u4f7f\u7528\uff0c\u5b58\u50a8\u6570\u636e\u975e\u5e38\u65b9\u4fbf\u3002</p> <p>\u4e3b\u8981\u529f\u80fd\u7279\u6027\uff1a</p> <ol> <li> <p>\u9762\u5411\u96c6\u5408\uff08Collenction-Orented\uff09\u5b58\u50a8\uff0c\u6613\u5b58\u50a8\u5bf9\u8c61\u7c7b\u578b\u7684\u6570\u636e \uff0c\u6570\u636e\u88ab\u5206\u7ec4\u5b58\u50a8\u5728\u6570\u636e\u96c6\u4e2d\uff0c \u88ab\u79f0\u4e3a\u4e00\u4e2a\u96c6\u5408\uff08Collenction\uff09\u3002\u6bcf\u4e2a\u96c6\u5408\u5728\u6570\u636e\u5e93\u4e2d\u90fd\u6709\u4e00\u4e2a\u552f\u4e00\u7684\u6807\u8bc6\u540d\uff0c\u5e76\u4e14\u53ef\u4ee5\u5305\u542b\u65e0 \u9650\u6570\u76ee\u7684\u6587\u6321\u3002\u96c6\u5408\u7684\u6982\u5ff5\u7c7b\u4f3c\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08RDBMS\uff09\u91cc\u7684\u8868\uff08table\uff09\uff0c\u4e0d\u540c\u7684\u662f\u5b83\u4e0d\u9700\u8981\u5b9a \u4e49\u4efb\u4f55\u6a21\u5f0f\uff08schema\uff09\u3002</p> </li> <li> <p>\u6a21\u5f0f\u81ea\u7531\uff08Schema-Free)\uff0c\u610f\u5473\u7740\u5bf9\u4e8e\u5b58\u50a8\u5728 MongoDB \u6570\u636e\u5e93\u4e2d\u7684\u6587\u4ef6\uff0c\u6211\u4eec  \u4e0d\u9700\u8981\u77e5\u9053\u5b83\u7684 \u4efb\u4f55\u7ed3\u6784\u5b9a\u4e49\u3002\u5982\u679c\u9700\u8981\uff0c\u4f60\u5b8c\u5168\u53ef\u4ee5\u628a\u4e0d\u540c\u7ed3\u6784\u7684\u6587\u4ef6\u5b58\u50a8\u5728\u540c\u4e00\u4e2a\u6570\u636e\u5e93\u91cc\u3002</p> </li> <li> <p>\u652f\u6301\u52a8\u6001\u67e5\u8be2</p> </li> <li>\u652f\u6301\u5b8c\u5168\u7d22\u5f15\uff0c\u5305\u542b\u5185\u90e8\u5bf9\u8c61</li> <li>\u652f\u6301\u67e5\u8be2</li> <li>\u652f\u6301\u590d\u5236\u548c\u6545\u969c\u6062\u590d</li> <li>\u4f7f\u7528\u9ad8\u6548\u7684\u4e8c\u8fdb\u5236\u6570\u636e\u5b58\u50a8\uff0c\u5305\u62ec\u5927\u578b\u5bf9\u8c61\uff08\u5982\u89c6\u9891\u7b49\uff09</li> <li>\u81ea\u52a8\u5904\u7406\u788e\u7247\uff0c\u4ee5\u652f\u6301\u4e91\u8ba1\u7b97\u5c42\u6b21\u7684\u6269\u5c55\u6027</li> <li>\u652f\u6301 Ruby\uff0cPython\uff0cJava\uff0cC++\uff0c PHP \u7b49\u591a\u79cd\u8bed\u8a00</li> <li>\u6587\u4ef6\u5b58\u50a8\u683c\u5f0f\u4e3a Bson \uff08\u2014\u79cd Json \u7684\u6269\u5c55\uff09Bson \uff08Binary Serialized document Format\uff09\u5b58\u50a8 \u5f62\u5f0f\u662f\u6307\uff1a\u5b58\u50a8\u5728\u96c6\u5408\u4e2d\u7684\u6587\u6863\uff0c\u88ab\u5b58\u50a8\u4e3a\u952e-\u503c\u5bf9\u7684\u5f62\u5f0f\u3002\u952e\u7528\u4e8e\u552f\u4e00\u6807\u8bc6\u4e00\u4e2a\u6587\u6863\uff0c\u4e3a\u5b57\u7b26\u4e32 \u7c7b\u578b\uff0c\u800c\u503c\u5219\u53ef\u4ee5\u662f\u5404\u4e2d\u590d\u6742\u7684\u6587\u4ef6\u7c7b\u578b\u3002</li> <li>\u53ef\u901a\u8fc7\u7f51\u7edc\u8bbf\u95ee<ul> <li>MongoDB \u670d\u52a1\u7aef\u53ef\u8fd0\u884c\u5728 Linux\u3001Windows \u6216 OS X \u5e73\u53f0\uff0c\u652f\u630132\u4f4d\u548c64\u4f4d\u5e94\u7528\uff0c\u9ed8\u8ba4\u7aef\u53e3\u4e3a 27017\u3002\u63a8\u8350\u8fd0\u884c\u572864\u4f4d\u5e73\u53f0\u3002</li> <li>McmgoDB \u628a\u6570\u636e\u5b58\u50a8\u5728\u6587\u4ef6\u4e2d\uff08\u9ed8\u8ba4\u8def\u5f84\u4e3a\uff1a/data/db\uff09\uff0c\u4e3a\u63d0\u9ad8\u6548\u7387\u4f7f\u7528\u5185\u5b58\u6620\u5c04\u6587\u4ef6\u8fdb\u884c \u7ba1\u7406\u3002</li> </ul> </li> </ol>"},{"location":"db_ops/2db_install/","title":"\u7b2c\u4e8c\u8282 \u5b89\u88c5 MySQL Repository & Jam db install","text":""},{"location":"db_ops/2db_install/#mysql-repository","title":"\u7b2c\u4e8c\u8282 \u5b89\u88c5 MySQL Repository","text":""},{"location":"db_ops/2db_install/#1-yum","title":"1\u3001\u9ed8\u8ba4 yum \u5b58\u50a8\u5e93\u5b89\u88c5","text":"<pre><code>$ yum -y install wget     # \u5b89\u88c5 wget\u4e0b\u8f7d\u5de5\u5177\n$ wget https://repo.mysql.com/mysql57-community-release-el7-11.noarch.rpm # \u4e0b\u8f7d mysql \u5b98\u65b9 yum \u6e90\u5b89\u88c5\u5305\n\n$ yum -y localinstall mysql57-community-release-el7-11.noarch.rpm # \u5b89\u88c5 mysql \u5b98\u65b9 yum \u6e90\n</code></pre>"},{"location":"db_ops/2db_install/#2","title":"2\u3001\u9009\u62e9\u6307\u5b9a\u53d1\u884c\u7248\u672c\u5b89\u88c5","text":"<p>\u4f7f\u7528 MySQL Yum \u5b58\u50a8\u5e93\u65f6\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f1a\u9009\u62e9\u8981\u5b89\u88c5\u7684\u6700\u65b0GA\u7248\u672cMySQL\u3002\u9ed8\u8ba4\u542f\u7528\u6700\u65b0GA \u7cfb\u5217\uff08\u5f53\u524d\u4e3aMySQL 8.0\uff09\u7684\u5b50\u5b58\u50a8\u5e93\uff0c\u800c\u6240\u6709\u5176\u4ed6\u7cfb\u5217\uff08\u4f8b\u5982\uff0cMySQL 5.7\u7cfb\u5217\uff09\u7684\u5b50\u5b58\u50a8\u5e93\u5747 \u88ab\u7981\u7528\u3002\u67e5\u770b\u5df2\u542f\u7528\u6216\u7981\u7528\u4e86\u5b58\u50a8\u5e93\u3002</p>"},{"location":"db_ops/2db_install/#2-1","title":"2-1 \u5217\u51fa\u6240\u6709\u7248\u672c","text":"<pre><code>$ yum repolist all | grep mysql\n</code></pre> <p>\u53d1\u73b0\u542f\u7528\u6700\u65b0<code>8.0</code>\u7248\u672c\u662f <code>enabled</code> \u7684\uff0c<code>5.7</code>\u7248\u672c\u662f <code>disabled</code> \u7684\uff0c\u9700\u8981\u5b89\u88c55.7\u7248\u672c\u65f6\uff0c\u6240\u4ee5\u628a8.0\u7684\u8fdb\u884c\u7981\u7528\uff0c\u7136\u540e\u518d\u542f\u75285.7\u7248\u672c</p>"},{"location":"db_ops/2db_install/#2-2-yum","title":"2-2 \u5b89\u88c5 yum \u914d\u7f6e\u5de5\u5177","text":"<pre><code>$ yum -y install yum-utils\n</code></pre>"},{"location":"db_ops/2db_install/#2-3-80","title":"2-3 \u7981\u7528 8.0 \u7248\u672c","text":"<pre><code>$ yum-config-manager --disable mysql80-community\n</code></pre>"},{"location":"db_ops/2db_install/#2-4-57","title":"2-4 \u542f\u7528 5.7 \u7248\u672c","text":"<pre><code>yum-config-manager --enable mysql57-community\n</code></pre>"},{"location":"db_ops/2db_install/#2-5","title":"2-5 \u68c0\u67e5\u542f\u7528\u7248\u672c","text":"<p>\u6ce8\u610f\uff1a\u8fdb\u884c\u5b89\u88c5\u65f6\u8bf7\u786e\u4fdd\u53ea\u6709\u4e00\u4e2a\u7248\u672c\u542f\u7528\uff0c\u5426\u5219\u4f1a\u663e\u793a\u7248\u672c\u51b2\u7a81</p> <pre><code>$ yum repolist enabled | grep mysql\n</code></pre>"},{"location":"db_ops/2db_install/#3-mysql","title":"3\u3001\u5b89\u88c5 MySQL","text":"<p>\u9700\u8981\u5b89\u88c5MySQL Server, MySQL client \u5df2\u7ecf\u5305\u62ec\u5728 server \u5957\u4ef6\u5185</p> <pre><code>$ yum -y install mysql-community-server mysql     # \u5b89\u88c5\u670d\u52a1\u7aef\uff0c\u5ba2\u6237\u7aef\n\n$ systemctl start mysqld # \u542f\u52a8 mysql\u670d\u52a1\n\n$ systemctl enable mysqld             # \u8bbe\u7f6e mysql\u670d\u52a1\u5f00\u673a\u542f\u52a8\n\n$ ls /var/lib/mysql           # \u67e5\u770b mysql\u5b89\u88c5\n\n$  grep 'tqfeduorary password' /var/log/mysqld.log # \u83b7\u53d6\u9996\u6b21\u767b\u5f55\u5bc6\u7801\n\n$ mysql -uroot -p'awm3&gt;!QFl6zR'         # \u767b\u5f55mysql\u6570\u636e\u5e93\n\nmysql &gt; alter user 'root'@'localhost' identified by 'Qf.123com';     # \u4fee\u6539 mysql \u6570\u636e\u5e93\u5bc6\u7801\uff08\u5bc6\u7801\u5fc5\u987b\u7b26\u5408\u590d\u6742\u6027\u8981\u6c42\uff0c\u5305\u542b\u5b57\u6bcd\u5927\u5c0f\u5199\uff0c\u6570\u5b57\uff0c\u7279\u8d66\u7b26\u53f7\uff0c\u957f\u5ea6\u4e0d\u5c11\u4e8e8\u4f4d\uff09\n\n$ mysql -uroot -p'Qf.123com'                       # \u7528\u65b0\u5bc6\u7801\u767b\u5f55\u6570\u636e\u5e93\n</code></pre> <p>\u91cd\u542f MySQL</p> <pre><code>\u91cd\u542f MySQL\n</code></pre> <p>\u521b\u5efa qfedu \u5e93\u5e76\u8bbe\u7f6e\u6743\u9650</p> <pre><code>mysql -u root -p\nEnter password:\nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 3\nServer version: 5.6.39 MySQL Community Server (GPL)\nCopyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt;CREATE DATABASE qfedudb CHARACTER SET utf8 COLLATE utf8_bin;\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt;GRANT SELECT,INSERT,UPDATE,DELETE,CREATE,DROP,ALTER,INDEX on qfedudb.* TO\n'qfedu'@'localhost' IDENTIFIED BY 'Yangge.123com';\nQuery OK, 0 rows affected, 1 warning (0.00 sec)\nmysql&gt; FLUSH PRIVILEGES;\nQuery OK, 0 rows affected (0.00 sec)\nmysql&gt; SHOW GRANTS FOR 'qfedu'@'localhost';\n+-------------------------------------------------------------------------------\n------------------------------+\n| Grants for qfedu@localhost                                                    \n                              |\n+-------------------------------------------------------------------------------\n------------------------------+\n| GRANT USAGE ON *.* TO 'qfedu'@'localhost' IDENTIFIED BY PASSWORD\n'*841E9705B9F4BD3195B7314CA58A7E3B3B349F71' |\n| GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON\n`qfedudb`.* TO 'qfedu'@'localhost'       |\n+-------------------------------------------------------------------------------\n------------------------------+\n2 rows in set (0.00 sec)\nmysql&gt; SHOW GRANTS FOR 'qfedu'@'172.16.0.122';\n+-------------------------------------------------------------------------------\n---------------------------------+\n| Grants for qfedu@172.16.0.122\n|\n+-------------------------------------------------------------------------------\n---------------------------------+\n| GRANT USAGE ON *.* TO 'qfedu'@'172.16.0.122' IDENTIFIED BY PASSWORD\n'*841E9705B9F4BD3195B7314CA58A7E3B3B349F71' |\n| GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER ON\n`qfedudb`.* TO 'qfedu'@'172.16.0.122'       |\n+-------------------------------------------------------------------------------\n---------------------------------+\n2 rows in set (0.01 sec)\nmysql&gt; \\q\nBye\n</code></pre>"},{"location":"db_ops/2db_install/#4jam","title":"4\u3001Jam \u6570\u636e\u5e93\u5b89\u88c5","text":""},{"location":"db_ops/2db_install/#4-1-download-these-rpm","title":"4-1 Download these rpm:","text":"<pre><code>ssh dc25jamint3db01\n\n$ sudo -i\n\ndc25jamint3db01:~ # mkdir tmp &amp;&amp; cd tmp\n\nwget https://downloads.mysql.com/archives/get/p/23/file/mysql-community-server-5.7.30-1.sles12.x86_64.rpm\n\nwget https://downloads.mysql.com/archives/get/p/23/file/mysql-community-client-5.7.30-1.sles12.x86_64.rpm\n\nwget https://downloads.mysql.com/archives/get/p/23/file/mysql-community-devel-5.7.30-1.sles12.x86_64.rpm\n\nwget https://downloads.mysql.com/archives/get/p/23/file/mysql-community-embedded-devel-5.7.30-1.sles12.x86_64.rpm\n\nwget https://downloads.mysql.com/archives/get/p/23/file/mysql-community-common-5.7.30-1.sles12.x86_64.rpm\n\nwget https://downloads.mysql.com/archives/get/p/23/file/mysql-community-libs-5.7.30-1.sles12.x86_64.rpm\n\nwget https://downloads.mysql.com/archives/get/p/23/file/mysql-community-test-5.7.30-1.sles12.x86_64.rpm\n\nwget https://downloads.mysql.com/archives/get/p/23/file/mysql-community-embedded-5.7.30-1.sles12.x86_64.rpm\n\n\nsudo zypper install libatomic1\nsudo zypper install perl-JSON\n\nrpm -ivh *.rpm\n</code></pre> <pre><code>$ rpm -qa | grep mysql\nmysql-community-libs-5.7.30-1.sles12.x86_64\nmysql-community-embedded-devel-5.7.30-1.sles12.x86_64\nmysql-community-server-5.7.30-1.sles12.x86_64\nmysql-community-test-5.7.30-1.sles12.x86_64\nmysql-community-common-5.7.30-1.sles12.x86_64\nmysql-community-devel-5.7.30-1.sles12.x86_64\nmysql-community-embedded-5.7.30-1.sles12.x86_64\nmysql-community-client-5.7.30-1.sles12.x86_64\n\n$ rpm -qa | grep perl-JSON\nperl-JSON-2.90-2.15.noarch\n\n$ rpm -qa | grep libatomic1\nlibatomic1-11.2.1+git610-1.3.2.x86_64\n</code></pre>"},{"location":"db_ops/2db_install/#4-2-edit-etcmycnf","title":"4-2 Edit <code>/etc/my.cnf</code>","text":"<ul> <li>Attention that master and slave have the different configuration file</li> </ul> <pre><code>[client]\nport            = 3306\nsocket          = /mysqldata/data/mysqld.sock\n#character-sets-dir=/opt/mysql/current/charsets\n\n[mysqld_safe]\nsocket          = /mysqldata/data/mysqld.sock\nnice            = 0\n\n[mysqld]\n#large-pages\nauto-increment-increment = 2\nauto-increment-offset = 1\nread_only=OFF\n# read_only=ON   SLAVE\n\ncharacter-set-server = utf8\ncollation-server = utf8_unicode_ci\nperformance_schema = ON\ninnodb_stats_persistent_sample_pages=512\n#large_pages=0\n#skip-name-resolve\n\nuser            = mysql\npid-file        = /mysqldata/data/mysqld.pid\nsocket          = /mysqldata/data/mysqld.sock\nport            = 3306\nbasedir         = /opt/mysql/current\ndatadir         = /mysqldata/data\ntmpdir          = /mysqltemp/tmp\n#language        = /opt/mysql/current/share/english\nskip-external-locking\n\n#key_buffer = 384M\nmax_allowed_packet      = 100M\nthread_stack            = 1M\n#thread_cache_size       = 8\nmax_connections        = 1024\ntable_open_cache            = 3000\n#thread_concurrency     = 8\ninnodb_thread_concurrency = 8\nsort_buffer_size = 64M\nread_buffer_size = 32M\nread_rnd_buffer_size = 256M\nmyisam_sort_buffer_size = 256M\nthread_cache_size = 250\nquery_cache_limit       = 0\nquery_cache_type = 0\nquery_cache_size = 0\nwait_timeout=300\njoin_buffer_size = 18M\ntmp_table_size= 2G\nmax_heap_table_size=1G\nlog-slave-updates = ON\nsql_mode                = NO_ENGINE_SUBSTITUTION,STRICT_ALL_TABLES\ninnodb_data_home_dir = /mysqldata/data/\ninnodb_data_file_path = ibdata1:2000M;ibdata2:10M:autoextend\ninnodb_log_group_home_dir = /mysqldata/data/\n\ninnodb_buffer_pool_size = 15G\n#innodb_additional_mem_pool_size = 64M\ninnodb_adaptive_hash_index_parts = 18\ninnodb_log_file_size = 512M\ninnodb_log_buffer_size = 32M\ninnodb_flush_log_at_trx_commit = 1\ninnodb_flush_method=O_DIRECT\ninnodb_read_io_threads = 16\ninnodb_write_io_threads = 16\ninnodb_lock_wait_timeout = 50\ninnodb_file_per_table\ninnodb_buffer_pool_instances = 8\ninnodb_buffer_pool_dump_pct = 75\n#innodb_numa_interleave = 1\nsafe_user_create  = 1\nlocal-infile  = 0\n# Log monitoring output to a file (inndb_status.&lt;pid&gt; in the data directory) when monitoring is enabled\ninnodb-status-file=1\n\nserver-id               = 888\nlog_bin                 = /mysqllog/data/mysql-bin\nlog_bin_index           = /mysqllog/data/mysql-bin.index\nexpire_logs_days        = 7\nmax_binlog_size         =1073741824\nbinlog_format           =ROW\nbinlog_error_action     =IGNORE_ERROR\nsync_binlog             =1\nlog_error               =/mysqllog/data/mp13jamdb46.err\n#log-slow-queries       =/mysqllog/data/mp13jamdb46-slow-queries.log\n#log-queries-not-using-indexes\nlong_query_time         =2\nslow_query_log = 1\nreplicate-wild-ignore-table = roltatusc.%\nreplicate-wild-ignore-table = cmdb.%\nrelay-log-info-repository=TABLE\nmaster-info-repository=TABLE\n\n[mysqldump]\nquick\nquote-names\nmax_allowed_packet      = 100M\n\n[mysql]\n#no-auto-rehash # faster start of mysql but no tab completition\n\n[isamchk]\nkey_buffer = 256M\nsort_buffer_size = 256M\nread_buffer = 2M\nwrite_buffer = 2M\n</code></pre>"},{"location":"db_ops/2db_install/#4-3-change-user-to-root","title":"4-3 change user to root","text":"<pre><code>$ sudo userdel -r mysql\n\nno crontab for mysql\nuserdel: mysql mail spool (/var/mail/mysql) not found\n\n\n$ sudo groupdel mysql\n\n$ sudo groupadd -r -g 116 mysql\n\n* -g, --gid GID\n* -r, --system\n\nCreate a system group.\n\n\n$ sudo useradd -g mysql -u 116 -M mysql\n</code></pre> <pre><code>sudo su root\n\nchown mysql:mysql /opt/mysql/\n\nchown mysql:mysql /app\n\nchown mysql:mysql /var/run/mysql/\n\n## mkdir /mysqlbackup /mysqldata /mysqllog /mysqltemp #if not exist\n\ncd /mysql\nmysqlbackup/ mysqldata/   mysqllog/    mysqltemp/\n\nchown mysql:mysql /mysql*\n</code></pre> <pre><code>/ # ls -la | grep mysql\ndrwxr-xr-x   3 mysql    mysql       18 Oct 22 16:53 app\ndrwxr-xr-x   2 mysql    mysql     4096 Oct 26 15:08 mysqlbackup\ndrwxr-xr-x   2 mysql    mysql        6 Oct 22 16:51 mysqldata\ndrwxr-xr-x   2 mysql    mysql        6 Oct 22 16:51 mysqllog\ndrwxr-xr-x   2 mysql    mysql        6 Oct 22 16:51 mysqltemp\n</code></pre> <pre><code># change user to mysql\n\nsudo -i\nsu mysql\n\nmysql@dc25jamint3db01:/root&gt;\n\ncd /opt/mysql\n\nln -s /usr current\n\n$ ls -la\ntotal 0\ndrwxr-xr-x 2 mysql mysql  21 Oct 29 09:02 .\ndrwxr-xr-x 8 root  root  100 Oct 25 20:49 ..\nlrwxrwxrwx 1 mysql mysql   4 Oct 29 09:02 current -&gt; /usr\n\nmkdir /mysqllog/data\n\nmkdir /mysqltemp/tmp\n\n\n## change user back to root\n\nexit\n\n/usr/sbin/mysqld --defaults-file=/etc/my.cnf --initialize --user=mysql\n\n\n## Get the temporary password from /mysqllog/data/*.* (the log file configured in /etc/my.conf)\n\n2021-10-29T09:22:54.034162Z 1 [Note] A temporary password is generated for root@localhost: +uzoCaBR%5sr\n\nsystemctl start mysql\n\nmysql -uroot -p (as root user)\n\nmysql&gt; set password=PASSWORD('***');\nQuery OK, 0 rows affected, 1 warning (0.00 sec)\n</code></pre>"},{"location":"db_ops/2db_install/#4-4-configure-master-server","title":"4-4 Configure master server","text":"<p>Create a user which slave uses to login the master</p> <pre><code>mysql -uroot -p\n\n# CREATE USER 'jeffrey'@'localhost' IDENTIFIED BY 'password';\n\ncreate user 'repl'@'10.181.40.83' identified by 'repl@***';\n\nQuery OK, 0 rows affected (0.01 sec)\n\n# GRANT REPLICATION SLAVE ON *.* TO 'user'@'host'\n\n\n# How to grant replication privilege to a database\ngrant replication slave on *.*  to  'repl'@'10.181.40.83';\n\nmysql&gt; show master status \\G;\n*************************** 1. row ***************************\n             File: mysql-bin.000002\n         Position: 876\n     Binlog_Do_DB:\n Binlog_Ignore_DB:\nExecuted_Gtid_Set:\n1 row in set (0.00 sec)\n\nERROR:\nNo query specified\n\n\nshow master status;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000002 |      876 |              |                  |                   |\n+------------------+----------+--------------+------------------+-------------------+\n1 row in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/2db_install/#4-5-configure-slave-server","title":"4-5 Configure slave server","text":"<pre><code>sudo mysql -uroot -p\n\n\n\nchange master to master_host='10.181.40.68',  master_user='repl', master_password='repl@***',master_log_file='mysql-bin.000002', master_log_pos=0;\n\nQuery OK, 0 rows affected, 2 warnings (0.01 sec)\n\n\nmysql&gt; start slave;\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql&gt; show slave status \\G;\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: 10.181.40.68\n                  Master_User: repl\n                  Master_Port: 3306\n                Connect_Retry: 60\n              Master_Log_File: mysql-bin.000002\n          Read_Master_Log_Pos: 876\n               Relay_Log_File: dc25jamint3db02-relay-bin.000002\n                Relay_Log_Pos: 1089\n        Relay_Master_Log_File: mysql-bin.000002\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n\n...\n      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates            \n\n</code></pre> <p>On slave node, there are 3 processes started.</p> <pre><code>mysql&gt; show processlist\\G;\n*************************** 1. row ***************************\n     Id: 4\n   User: root\n   Host: localhost\n     db: NULL\nCommand: Query\n   Time: 0\n  State: starting\n   Info: show processlist\n*************************** 2. row ***************************\n     Id: 5\n   User: system user\n   Host:\n     db: NULL\nCommand: Connect\n   Time: 303\n  State: Waiting for master to send event\n   Info: NULL\n*************************** 3. row ***************************\n     Id: 6\n   User: system user\n   Host:\n     db: NULL\nCommand: Connect\n   Time: 1169\n  State: Slave has read all relay log; waiting for more updates\n   Info: GRANT REPLICATION SLAVE ON *.* TO 'repl'@'10.181.40.83'\n3 rows in set (0.00 sec)\n\nERROR:\nNo query specified\n</code></pre> <p>On master nodes, there are 2 processes started:</p> <pre><code>mysql&gt;  show processlist\\G;\n*************************** 1. row ***************************\n     Id: 23\n   User: repl\n   Host: dc25jamint3db02.dc025.sf.priv:47150\n     db: NULL\nCommand: Binlog Dump\n   Time: 635\n  State: Master has sent all binlog to slave; waiting for more updates\n   Info: NULL\n*************************** 2. row ***************************\n     Id: 24\n   User: root\n   Host: localhost\n     db: NULL\nCommand: Query\n   Time: 0\n  State: starting\n   Info: show processlist\n2 rows in set (0.00 sec)\n\nERROR:\nNo query specified\n</code></pre>"},{"location":"db_ops/2db_install/#4-6-configure-other-important-parameters","title":"4-6 Configure other important parameters","text":"<pre><code>set global local_infile=on;\nQuery OK, 0 rows affected (0.00 sec)\n\nsudo vim /etc/my.cnf\n\n[mysqld]\n\nlocal_infile=on\n\nset global innodb_stats_auto_recalc=off;\n</code></pre> <pre><code>show global variables like \"innodb_stats_auto_recalc\";\n+--------------------------+-------+\n| Variable_name            | Value |\n+--------------------------+-------+\n| innodb_stats_auto_recalc | OFF   |\n+--------------------------+-------+\n1 row in set (0.01 sec)\n\nmysql&gt; show global variables like \"local_infile\";\n+---------------+-------+\n| Variable_name | Value |\n+---------------+-------+\n| local_infile  | ON    |\n+---------------+-------+\n1 row in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/2db_install/#4-7-create-schemacreate-database","title":"4-7 CREATE SCHEMA\u548cCREATE DATABASE\u662f\u7b49\u6548\u7684.","text":"<pre><code>create schema ct_stage default character set utf8 collate utf8_general_ci;\n\ncreate schema ps_stage default character set utf8 collate utf8_general_ci;\n\ncreate schema tenant_migration_transient_ct default character set utf8 collate utf8_general_ci;\n\ncreate schema tenant_migration_transient_ps default character set utf8 collate utf8_general_ci;\n</code></pre> <pre><code>mysql&gt; show databases;\n+-------------------------------+\n| Database                      |\n+-------------------------------+\n| information_schema            |\n| ct_stage                      |\n| mysql                         |\n| performance_schema            |\n| ps_stage                      |\n| sys                           |\n| tenant_migration_transient_ct |\n| tenant_migration_transient_ps |\n+-------------------------------+\n8 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/3db_sql/","title":"\u7b2c\u4e09\u8282 \u7ed3\u6784\u5316\u67e5\u8be2\u8bed\u8a00 SQL","text":""},{"location":"db_ops/3db_sql/#1-ddl","title":"1\u3001\u6570\u636e\u5b9a\u4e49\u8bed\u8a00 (DDL)","text":"<ul> <li>Data Dafinitaon Language</li> <li>\u5982\u521b\u5efa\u8868 create</li> <li>\u5220\u9664\u8868 drop</li> <li>\u4fee\u6539\u8868 alter</li> <li>\u6e05\u7a7a\u8868 truncate\uff0c\u5f7b\u5e95\u6e05\u7a7a\uff0c\u65e0\u6cd5\u627e\u56de</li> </ul> <pre><code>show databases; # \u67e5\u770b\u6240\u6709\u6570\u636e\u5e93\uff1a\nshow tables; # \u67e5\u770b\u6240\u6709\u8868\uff1a    \n\ndrop database db1; # \u5220\u9664\u6570\u636e\u5e93    \ncreate database db1 default character set utf8; # \u521b\u5efa\u6570\u636e\u5e93    \n\nuse database; # \u9009\u62e9\u6570\u636e\u5e93\ncreate table t1(id int(3),name varchar(20)); # \u521b\u5efa\u8868\ndesc t1 # \u67e5\u770b\u8868\n\ninsert into t1 values(1,'user1'); # \u63d2\u5165\u6570\u636e\nalter table t1 add(age int(3)); # \u6dfb\u52a0\u8868\u5b57\u6bb5\u8bed\u53e5  \nalter table t1 drop id; # \u5220\u9664\u8868\u5b57\u6bb5\u8bed\u53e5  \nalter table t1 modify age varchar(2); # \u4fee\u6539\u8868\u5b57\u6bb5\u7c7b\u578b\u683c\u5f0f  \nalter table t1 change age p1age int(3); # \u4fee\u6539\u8868\u5b57\u6bb5\u540d\u79f0  \nalter table t1 rname per; # \u4fee\u6539\u8868\u540d\ntruncate table t1; # \u6e05\u7a7a\u8868\u7ed3\u6784  \ndrop table t1; # \u5220\u9664\u8868\u7ed3\u6784  \n</code></pre>"},{"location":"db_ops/3db_sql/#2dml","title":"2\u3001\u6570\u636e\u64cd\u7eb5\u8bed\u8a00(DML)","text":"<ul> <li>insert\uff1a\u5411\u8868\u4e2d\u63d2\u5165\u6570\u636e</li> <li>delete\uff1a\u5220\u9664\u8868\u4e2d\u7684\u6570\u636e\uff0c\u683c\u5f0f\uff1a<code>delete from tablname [where \u6761\u4ef6]</code></li> <li>update\uff1a\u4fee\u6539\u8868\u4e2d\u7684\u6570\u636e \u683c\u5f0f\uff1a<code>update tablname set colName1=value1[,colName2=value2] [where \u6761\u4ef6]</code></li> <li> <p>where : \u5bf9\u8868\u4e2d\u7684\u6570\u636e\u589e\u52a0\u6761\u4ef6\u8fdb\u884c\u9650\u5236\uff0c\u8d77\u5230\u8fc7\u6ee4\u7684\u4f5c\u7528\u3002</p> <ul> <li>\u683c\u5f0f: <code>where colName</code> \u5173\u7cfb\u8fd0\u7b97\u7b26 <code>value [or|and \u6761\u4ef62]</code></li> <li>\u5173\u7cfb\u8fd0\u7b97\u7b26: <code>&gt;\uff0c&gt;=\uff0c&lt;\uff0c&lt;=</code>, \u7b49\u4e8e\uff1a<code>=</code>\uff0c\u4e0d\u7b49\u4e8e\uff1a<code>!=</code> \u6216<code>&lt;&gt;</code></li> </ul> </li> <li> <p>null\u503c\u64cd\u4f5c\uff1a\u6bd4\u8f83null\u65f6\uff0c\u4e0d\u80fd\u4f7f\u7528=\u6216\u8005!= \u6216\u8005&lt;&gt;\uff0c\u800c\u662f\u4f7f\u7528<code>is</code>\u6216\u8005<code>is not</code>\uff0c\u5728<code>select</code>\u5b50\u53e5\u4e2d\uff0c\u4f7f \u7528\u5173\u7cfb\u8fd0\u7b97\u7b26</p> </li> </ul>"},{"location":"db_ops/3db_sql/#2-1","title":"2-1 \u5b9e\u9a8c\u6848\u4f8b","text":"<p>1)\u521b\u5efa\u4e00\u4e2a\u8868</p> <pre><code>create table test(\nid int,\nname varchar(20),\nbirth date,\naddress varchar(50)\n);\n</code></pre> <p>2)\u63d2\u5165\u6570\u636e</p> <pre><code>\u63d2\u5165\u6570\u636e  100\uff0c'jack' ,'shanghai' \uff0c\u4e0b\u9762\u662f\u4e24\u79cd\u63d2\u5165\u65b9\u5f0f\uff0c\u7b2c\u4e8c\u79cd\u53ef\u4ee5\u6279\u91cf\u63d2\u5165\u3002\u53ea\u9700\u6dfb\u52a0\u591a\u4e2a\u7528\n\u9017\u53f7\u9694\u5f00\u5373\u53ef\n\ninsert into test values (101,'jack',null,'shanghai');\ninsert into test(id,name,address) values(102,'rose','beijing');\n</code></pre> <p>3)\u5220\u9664\u6570\u636e</p> <pre><code># \u5220\u9664\u8868test01\u4e2d\u7684\u6240\u6709\u6570\u636e\u3002\ndelete from test;\n\n# \u5220\u9664\u8868\u4e2dtest01\u4e2d\u7684id\u4e3a101\u7684\u8bb0\u5f55\u3002\ndelete from test where id=101;\n\n# \u5220\u9664\u8868test \u4e2d id\u4e3a102\u548c\u5730\u5740\u4e3a\u4e0a\u6d77\u7684\u7684\u6570\u636e\n\nselect * from test;\ndelete from test where id=102 and address='shanghai';\n</code></pre> <p>4)\u4fee\u6539\u6570\u636e</p> <pre><code>#\u4fee\u6539\u8868 test01 \u4e2d\u7684\u5b57\u6bb5 address \u4e3a\u4e2d\u56fd\u3002\nupdate test01 set address='china';\n\n# \u4fee\u6539\u8868 test01 \u4e2d\u7684 id \u4e3a 102 \u7684 address \u4e3aenglish\uff0c\u4eba\u540d\u4e3a micheal\u3002\nupdate test01 set address='english',name='micheal' where id=102;\n\n# \u5c06\u751f\u65e5\u4e3a null \u7684\u8bb0\u5f55\u7684 name \u6539\u4e3a 'general'\nupdate test01 set name='general' where tbirth is null;\n\n# \u5c06 id \u4e3a 101 \u7684 birth \u6539\u4e3a'2000-8-8';\nupdate test01 set birth = '2000-8-8' where id = 101;\n\n# \u5c06 id \u4e3a 102 \u7684 address \u6539\u4e3a null.\nupdate test01 set address=null where id=102;\n</code></pre>"},{"location":"db_ops/3db_sql/#2-3-tcl","title":"2-3 \u4e8b\u7269\u63a7\u5236\u8bed\u8a00(TCL)","text":"<p>\u4e8b\u7269\u63a7\u5236\u8bed\u8a00 \uff08Transation Control Language\uff09 \u6709\u65f6\u53ef\u80fd\u9700\u8981\u4f7f\u7528 DML \u8fdb\u884c\u6279\u91cf\u6570\u636e\u7684\u5220\u9664\uff0c \u4fee\u6539\uff0c\u589e\u52a0\u3002</p> <p>\u6bd4\u5982\uff0c\u5728\u4e00\u4e2a\u5458\u5de5\u7cfb\u7edf\u4e2d\uff0c\u60f3\u5220\u9664\u4e00\u4e2a\u4eba\u7684\u4fe1\u606f\u3002\u9664\u4e86\u5220\u9664\u8fd9\u4e2a\u4eba\u7684\u57fa\u672c\u4fe1\u606f\u5916\uff0c\u8fd8 \u5e94\u8be5\u5220\u9664\u4e0e\u6b64\u4eba\u6709\u5173\u7684\u5176\u4ed6\u4fe1\u606f\uff0c\u5982\u90ae\u7bb1\uff0c\u5730\u5740\u7b49\u7b49\u3002\u90a3\u4e48\u4ece\u5f00\u59cb\u6267\u884c\u5230\u7ed3\u675f\uff0c\u5c31\u4f1a\u6784\u6210\u4e00\u4e2a\u4e8b \u52a1\u3002\u5bf9\u4e8e\u4e8b\u52a1\uff0c\u8981\u4fdd\u8bc1\u4e8b\u52a1\u7684\u5b8c\u6574\u6027\u3002\u8981\u4e48\u6210\u529f\uff0c\u8981\u4e48\u64a4\u56de\u3002</p> <p>\u4e8b\u52a1\u8981\u7b26\u5408\u56db\u4e2a\u6761\u4ef6(ACID)\uff1a</p> <ul> <li>\u539f\u5b50\u6027(Atomicity)\uff1a\u4e8b\u52a1\u8981\u4e48\u6210\u529f\uff0c\u8981\u4e48\u64a4\u56de\u3002\u4e0d\u53ef\u5207\u5272\u6027\u3002</li> <li>\u4e00\u81f4\u6027(Consistency)\uff1a\u4e8b\u52a1\u5f00\u59cb\u524d\u548c\u7ed3\u675f\u540e\uff0c\u8981\u4fdd\u8bc1\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002\u8f6c\u8d26\u524d\u8d26\u53f7A\u548c\u8d26\u53f7B\u7684\u94b1\u7684\u603b\u6570\u4e3a10000\uff0c\u8f6c\u8d26\u540e\u8d26\u53f7A\u548c\u8d26\u53f7B\u7684\u524d\u7684\u603b\u6570\u5e94\u8be5\u8fd8\u662f10000;</li> <li>\u9694\u79bb\u6027(Isolation)\uff1a\u5f53\u6d89\u53ca\u5230\u591a\u7528\u6237\u64cd\u4f5c\u540c\u4e00\u5f20\u8868\u65f6\uff0c\u6570\u636e\u5e93\u4f1a\u4e3a\u6bcf\u4e00\u4e2a\u7528\u6237\u5f00\u542f\u4e00\u4e2a\u4e8b\u52a1\u3002\u90a3\u4e48\u5f53\u5176\u4e2d\u4e00\u4e2a\u4e8b\u52a1\u6b63\u5728\u8fdb\u884c\u65f6\uff0c\u5176\u4ed6\u4e8b\u52a1\u5e94\u8be5\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\u3002\u4fdd\u8bc1\u4e8b\u52a1\u4e4b\u95f4\u4e0d\u4f1a\u53d7\u5f71\u54cd\u3002</li> <li> <p>\u6301\u4e45\u6027(Durability)\uff1a\u5f53\u4e00\u4e2a\u4e8b\u52a1\u88ab\u63d0\u4ea4\u540e\uff0c\u6211\u4eec\u8981\u4fdd\u8bc1\u6570\u636e\u5e93\u91cc\u7684\u6570\u636e\u662f\u6c38\u4e45\u6539\u53d8\u7684\u3002\u5373\u4f7f\u6570\u636e\u5e93\u5d29\u6e83\u4e86\uff0c\u6211\u4eec\u4e5f\u8981\u4fdd\u8bc1\u4e8b\u52a1\u7684\u5b8c\u6574\u6027\u3002</p> </li> <li> <p>commit \u63d0\u4ea4 rollback \u64a4\u56de\uff0c\u56de\u6eda\u3002</p> </li> <li>savepoint \u4fdd\u5b58\u70b9 \u53ea\u6709DML\u64cd\u4f5c\u4f1a\u89e6\u53d1\u4e00\u4e2a\u4e8b\u52a1\u3002</li> </ul> <p>\u5b58\u50a8\u5f15\u64ce(ENGINE):\u5c31\u662f\u6307\u8868\u7c7b\u578b.\u5f53\u5b58\u50a8\u5f15\u64ce\u4e3ainnodb\u65f6\uff0c\u624d\u652f \u6301\u4e8b\u52a1\u3002\u9ed8\u8ba4\u7684\u5b58\u50a8\u5f15\u64ce\u4e3a Myisam\u3002\u4e0d\u652f\u6301\u4e8b\u52a1\u3002</p> <p>\u4e8b\u52a1\u7684\u9a8c\u8bc1\uff1a</p> <ul> <li>\u7b2c\u4e00\u6b65\uff1astart transaction (\u4ea4\u6613) </li> <li>\u7b2c\u4e8c\u6b65\uff1asavepoint \u4fdd\u5b58\u70b9\u540d\u79f0\u3002</li> <li>\u7b2c\u4e09\u6b65\uff1aDML </li> <li>\u7b2c\u56db\u6b65\uff1acommit/rollback;</li> </ul>"},{"location":"db_ops/3db_sql/#3data-query-language","title":"3\u3001\u6570\u636e\u67e5\u8be2\u8bed\u8a00\uff08Data Query Language\uff09","text":"<p>\u6570\u636e\u67e5\u8be2\u8bed\u8a00\uff08Data Query Language\uff09</p> <p>1\u3001Select/for \u57fa\u672c\u67e5\u8be2\u8bed\u53e5</p> <pre><code>\u683c\u5f0f\uff1aselect\u5b50\u53e5  from\u5b50\u53e5     select colName[,colName.......]  from tablname;\n</code></pre> <p>2\u3001\u7ed9\u5217\u8d77\u522b\u540d</p> <pre><code>\u683c\u5f0f\uff1aselect \u5217\u540d1 as \"\u8981\u8d77\u7684\u540d\" [, \u5217\u540d2 as \"\u8981\u8d77\u7684\u540d\" ,... ]  from tablname;\n</code></pre> <p>3\u3001Where</p> <p>\u4f5c\u7528\uff1a\u5728\u589e\u5220\u6539\u67e5\u65f6\uff0c\u8d77\u5230\u6761\u4ef6\u9650\u5236\u7684\u4f5c\u7528 \u591a\u6761\u4ef6\u5199\u6cd5\uff1a</p> <ul> <li><code>in | not in</code> (\u96c6\u5408\u5143\u7d20\uff0c\u4f7f\u7528\u9017\u53f7\u5206\u5f00); \u6ce8\u610f\uff1a\u540c\u4e00\u4e2a\u5b57\u6bb5\u6709\u591a\u4e2a\u503c\u7684\u60c5\u51b5\u4e0b\u4f7f\u7528\u3002</li> <li>in \u76f8\u5f53\u4e8e or\uff0c </li> <li><code>not in</code> \u76f8\u5f53\u4e8e <code>and all | any</code>\u4e0e\u96c6\u5408\u8fde\u7528\uff0c\u6b64\u65f6\u96c6\u5408\u4e2d\u7684\u5143\u7d20\u4e0d\u80fd\u662f\u56fa\u5b9a\u7684\u5fc5\u987b\u662f\u4ece\u8868\u4e2d\u67e5\u8be2\u5230\u7684\u6570\u636e\u3002</li> <li>\u8303\u56f4\u67e5\u8be2\uff1a<code>colName between val1 and val2;</code> \u67e5\u8be2\u6307\u5b9a\u5217\u540d\u4e0b\u7684<code>val1</code>\u5230<code>val2</code>\u8303\u56f4\u4e2d\u7684\u6570\u636e \u6a21\u7cca\u67e5\u8be2\uff1a<code>like</code><ul> <li>\u901a\u914d\u7b26\uff1a<code>%</code> \u8868\u793a<code>0</code>\u6216<code>0</code>\u4e2a\u4ee5\u4e0a\u5b57\u7b26\u3002<code>_</code>\u8868\u793a\u5339\u914d\u4e00\u4e2a\u5b57\u7b26</li> <li>\u683c\u5f0f: <code>colName like value;</code></li> </ul> </li> </ul>"},{"location":"db_ops/3db_sql/#4","title":"4\u3001 \u5b9e\u9a8c\u5b9e\u4f8b","text":""},{"location":"db_ops/3db_sql/#4-1","title":"4-1 \u521b\u5efa\u8868","text":"<pre><code>create table test (\ntestid int(5),\nname VARCHAR(10),\njob VARCHAR(9),\nmgr int(4),\nhiredate DATE,\nsal int(7),\ncomm int(7),\ndeptid int(2)\n);\n</code></pre>"},{"location":"db_ops/3db_sql/#4-2","title":"4-2 \u6dfb\u52a0\u6570\u636e","text":"<pre><code>insert into test (testid,name,job,mgr,hiredate,sal,comm,deptid) values\n(7369 ,'SMITH','CLERK',7902,'1980-12-17',800,NULL,20),\n(7499 ,'test','SALESMAN' , 7698 , '1981-2-10' ,  1600 , 300 , 30),\n(7521 ,'WARD', 'SALESMAN' , 7698,  '1981-2-22' ,  1250 , 500 , 30),\n(7566 ,'JONES','MANAGER' ,  7839,  '1981-4-2' ,  2975 , NULL , 20),\n(7654 ,'MARTIN','SALESMAN' , 7698,  '1981-9-28',   1250 , 1400 , 30),\n(7698 ,'BLAKE','MANAGER' ,  7839 , '1981-5-1' ,   2850 , NULL , 30),\n(7782 ,'CLARK','MANAGER' ,  7839 , '1981-6-9' ,   2450 , NULL , 10),\n(7788 ,'SCOTT','ANALYST' ,  7566,  '1987-4-19',   3000 , NULL , 20),\n(7839 ,'KING','PRESIDENT' ,NULL,  '1981-11-17',  5000 , NULL , 10),\n(7844 ,'TURNER','SALESMAN' , 7698,  '1981-9-8',    1500 , 0   ,  30),\n(7876 ,'ADAMS','CLERK' ,   7788 , '1987-5-23',   1100,  NULL , 20),\n(7900 ,'JAMES','CLERK' ,    7698 , '1981-12-3',   950 ,  NULL , 30),\n(7902 ,'FORD','ANALYST' ,  7566 , '1981-12-3' ,  3000 , NULL , 20),\n(7934 ,'MILLER','CLERK',     7782 , '1982-1-23',   1300 , NULL , 10),\n(8002 ,'IRONMAN','MANAGER',   7839 , '1981-6-9',    1600, NULL , 10),\n(8003 ,'SUPERMAN','MANAGER',   7839 , '1981-6-9',    1600 , NULL , NULL);\n</code></pre>"},{"location":"db_ops/3db_sql/#4-3","title":"4-3 \u67e5\u8be2\u6570\u636e","text":"<pre><code># \u67e5\u8be2\u5458\u5de5\u8868 test \u4e2d\u7684 \u5458\u5de5\u59d3\u540d\uff0c\u5458\u5de5\u804c\u4f4d\uff0c\u5458\u5de5\u5165\u804c\u65e5\u671f\u548c\u5458\u5de5\u6240\u5728\u90e8\u95e8\u3002\nselect name,job,hiredate,deptid from test;\n</code></pre>"},{"location":"db_ops/3db_sql/#4-4","title":"4-4 \u7ed9\u5217\u8d77\u522b\u540d","text":"<pre><code># \u67e5\u8be2\u5458\u5de5\u59d3\u540d\u548c\u5458\u5de5\u804c\u4f4d\u3002\u5206\u522b\u8d77\u522b\u540d\uff0c\u59d3\u540d\u548c\u804c\u4f4d\u3002\nselect name as \"\u59d3\u540d\" ,job as \"\u804c\u4f4d\" from test;\n</code></pre>"},{"location":"db_ops/3db_sql/#4-5-where","title":"4-5 Where \u5b50\u53e5","text":"<pre><code>#\u67e5\u8be2\u5458\u5de5\u8868\u4e2d\u90e8\u95e8\u53f7\u4e3a 10 \u548c 20 \u7684\u5458\u5de5\u7684\u7f16\u53f7\uff0c\u59d3\u540d\uff0c\u804c\u4f4d\uff0c\u5de5\u8d44\nselect testid,name,job,sal from test where deptid=10 or deptid =20;\n\n# \u67e5\u8be2\u5458\u5de5\u8868\u4e2d\u90e8\u95e8\u53f7\u4e0d\u662f 10 \u548c 20 \u7684\u5458\u5de5\u7684\u6240\u6709\u4fe1\u606f\u3002\nselect * from test where deptid&lt;&gt;10 and deptid&lt;&gt;20;\n\n# \u4f7f\u7528in \uff0cnot in\u4fee\u6539\u4e0a\u9762\u7684\u7ec3\u4e60\nselect testid,name,job,sal from test where deptid in(10,20);\nselect * from test where deptid not in (10,20);\n</code></pre>"},{"location":"db_ops/3db_sql/#4-6-allany","title":"4-6 <code>All|Any</code>\u4e0e\u96c6\u5408\u8fde\u7528","text":"<pre><code># \u67e5\u8be2\u5458\u5de5test,blake,clark\u4e09\u4e2a\u4eba\u7684\u5de5\u8d44\nselect * from test where sal&gt;all(select sal from test where name in\n('test','blake','clark'));\n</code></pre>"},{"location":"db_ops/3db_sql/#4-7","title":"4-7 \u8303\u56f4\u67e5\u8be2","text":"<pre><code># \u67e5\u8be2\u5de5\u8d44\u5927\u4e8e\u7b49\u4e8e1500\u5e76\u4e14\u5c0f\u4e8e\u7b49\u4e8e2500\u7684\u5458\u5de5\u7684\u6240\u6709\u4fe1\u606f\u3002\nselect * from test where sal between 1500 and 2500;\n\n# \u67e5\u8be2\u5de5\u8d44\u5c0f\u4e8e2000\u548c\u5de5\u8d44\u5927\u4e8e2500\u7684\u6240\u6709\u5458\u5de5\u4fe1\u606f\u3002\nselect * from test where sal not between 2000 and 2500;\n</code></pre>"},{"location":"db_ops/3db_sql/#4-8-like","title":"4-8 \u6a21\u7cca\u67e5\u8be2\uff1aLike","text":"<pre><code># \u67e5\u8be2\u5458\u5de5\u59d3\u540d\u4e2d\u6709a\u548cs\u7684\u5458\u5de5\u4fe1\u606f\u3002\nselect name,job,sal,comm,deptid from test where name like '%a%' and name like\n'%s%';\n\nselect name,job,sal,comm,deptid from test where name like '%a%s%' or name like\n'%s%a%';\n</code></pre>"},{"location":"db_ops/3db_sql/#4-9-order-by","title":"4-9\u3001\u6392\u5e8f\u67e5\u8be2 Order By\u5b50\u53e5","text":"<p>\u5f53\u5728\u67e5\u8be2\u8868\u4e2d\u6570\u636e\u65f6\uff0c\u8bb0\u5f55\u6bd4\u8f83\u591a\uff0c\u6709\u53ef\u80fd\u9700\u8981\u8fdb\u884c\u6392\u5e8f\uff0c\u6b64\u65f6\u53ef\u4ee5\u4f7f\u7528 order by\u5b50\u53e5\u3002</p> <pre><code>select...from tablname [where \u5b50\u53e5][order by \u5b50\u53e5]\n</code></pre> <p>\u6ce8\u610f: \u53ef\u4ee5\u901a\u8fc7\u4e00\u4e2a\u6216\u591a\u4e2a\u5b57\u6bb5\u6392\u5e8f\u3002</p> <p>\u683c\u5f0f</p> <pre><code>order by colName [ ASC | DESC ][ , colName1....[ ASC | DESC ] ];\n</code></pre> <p>\u6392\u5e8f\u89c4\u5219: ASC\uff1a\u5347\u5e8f \uff0cDESC: \u964d\u5e8f\uff0c\u9ed8\u8ba4\u662f\u5347\u5e8f\u6392\u5e8f</p> <pre><code>select * from test order by sal DESC;\n</code></pre>"},{"location":"db_ops/3db_sql/#4-10distinct","title":"4-10\u3001Distinct \u53bb\u91cd","text":"<p>\u6709\u7684\u65f6\u5019\u6211\u4eec\u9700\u8981\u5bf9\u91cd\u590d\u7684\u8bb0\u5f55\u8fdb\u884c\u53bb\u91cd\u64cd\u4f5c\uff0c\u6bd4\u5982\uff0c\u67e5\u8be2\u8868\u4e2d\u6709\u54ea\u4e9b\u804c\u4f4d\uff0c\u6b64\u65f6\uff0c\u4e00\u79cd\u804c\u4f4d\u53ea\u9700 \u8981\u663e\u793a\u4e00\u6761\u8bb0\u5f55\u5c31\u591f\u3002</p> <p>\u4f4d\u7f6e\uff1a\u5fc5\u987b\u5199\u5728select\u5173\u952e\u5b57\u540e</p> <pre><code>select distinct name from test;\n</code></pre>"},{"location":"db_ops/3db_sql/#4-11-group-by","title":"4-11\u3001\u5206\u7ec4\u67e5\u8be2 Group By \u5b50\u53e5","text":"<p>\u5206\u7ec4\u67e5\u8be2\u4e0e\u5206\u7ec4\u51fd\u6570(\u805a\u5408\u51fd\u6570)\uff1a\u6709\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ef\u80fd\u9700\u8981\u67e5\u8be2\u8868\u4e2d\u7684\u8bb0\u5f55\u603b\u6570\uff0c\u6216\u8005\u67e5\u8be2\u8868\u4e2d\u6bcf \u4e2a\u90e8\u95e8\u7684\u603b\u5de5\u8d44,\u5e73\u5747\u5de5\u8d44\uff0c\u603b\u4eba\u6570\u3002\u8fd9\u79cd\u60c5\u51b5\u9700\u8981\u5bf9\u8868\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u5206\u7ec4\u7edf\u8ba1\u3002\u9700\u8981group by\u5b50\u53e5\u3002</p> <p>\u4f4d\u7f6e\uff1a</p> <pre><code>select...from name [where \u6761\u4ef6] [group by\u5b50\u53e5] [order by\u5b50\u53e5]\n</code></pre> <p>\u7528\u6cd5:</p> <pre><code>group by Field1[,Field2]\n</code></pre> <p>\u6ce8\u610f\uff1a\u5728\u5206\u7ec4\u67e5\u8be2\u65f6\uff0cselect\u5b50\u53e5\u4e2d\u7684\u5b57\u6bb5\uff0c\u9664\u4e86\u805a\u5408\u51fd\u6570\u5916\uff0c\u53ea\u80fd\u5199\u5206\u7ec4\u5b57\u6bb5\u3002</p> <pre><code># \u67e5\u8be2\u4ee5\u90e8\u95e8id\u4e3a\u5206\u7ec4\u5458\u5de5\u7684\u5e73\u5747\u5de5\u8d44\nselect deptid,avg(sal) as av from test group by deptid;\n</code></pre> <p>\u805a\u5408\u51fd\u6570:</p> <ol> <li>count(Filed) \u7edf\u8ba1\u6307\u5b9a\u5b57\u6bb5\u7684\u8bb0\u5f55\u6570\u3002</li> <li>sum(Filed) \u7edf\u8ba1\u6307\u5b9a\u5b57\u6bb5\u7684\u548c\u3002</li> <li>avg(Filed) \u7edf\u8ba1\u6307\u5b9a\u5b57\u6bb5\u7684\u5e73\u5747\u503c</li> <li>max(Filed) \u8fd4\u56de\u6307\u5b9a\u5b57\u6bb5\u4e2d\u7684\u6700\u5927\u503c\u3002</li> <li>min(Filed) \u8fd4\u56de\u6307\u5b9a\u5b57\u6bb5\u4e2d\u7684\u6700\u5c0f\u503c\u3002</li> </ol> <p>\u805a\u5408\u51fd\u6570\u4f1a\u5ffd\u7565null\u503c\u3002\u56e0\u6b64\u6709\u65f6\u5019\u9700\u8981\u4f7f\u7528\u51fd\u6570\uff1a<code>ifnull(field,value)</code>\uff08\u5982\u679cfield\u5b57\u6bb5\u5bf9\u5e94\u7684\u503c\u4e0d \u662fnull,\u5c31\u4f7f\u7528field\u7684\u503c\uff0c\u5982\u679c\u662f<code>null</code>,\u5c31\u4f7f\u7528value.\uff09</p> <p>\u6ce8\u610f\uff1a\u591a\u5b57\u6bb5\u5206\u7ec4\u65f6\uff08\u591a\u8868\u8054\u5408\u67e5\u8be2\u65f6\u4e0d\u52a0\u4efb\u4f55\u6761\u4ef6\uff09\uff0c\u6700\u591a\u5206\u7ec4\u7684\u6570\u76ee\u4e3a Filed1Field2[Filed3....]</p>"},{"location":"db_ops/3db_sql/#4-12-having","title":"4-12 \u5206\u7ec4\u67e5\u8be2\u6dfb\u52a0\u6761\u4ef6 Having \u5b50\u53e5","text":"<p>\u5728\u5206\u7ec4\u67e5\u8be2\u65f6\uff0c\u6709\u7684\u65f6\u5019\u53ef\u80fd\u9700\u8981\u518d\u6b21\u4f7f\u7528\u6761\u4ef6\u8fdb\u884c\u8fc7\u6ee4\uff0c\u8fd9\u4e2a\u65f6\u5019\u4e0d\u80fd where\u5b50\u53e5\uff0c\u5e94\u8be5\u4f7f\u7528 having\u5b50\u53e5\u3002having\u5b50\u53e5\u540e\u53ef\u4ee5\u4f7f\u7528\u805a\u5408\u51fd\u6570\u3002</p> <p>\u4f4d\u7f6e\uff1a\u4f4d\u4e8e<code>group by</code>\u5b50\u53e5\u540e</p> <pre><code># \u67e5\u8be2\u4ee5\u90e8\u95e8id\u4e3a\u5206\u7ec4\u5458\u5de5\u7684\u5e73\u5747\u5de5\u8d44\u5e76\u4e14\u5927\u4e8e2000\u7684\u90e8\u95e8\nselect deptid,avg(sal) as av from test group by deptid having avg(sal)&gt;2000;\n</code></pre>"},{"location":"db_ops/3db_sql/#4-13","title":"4-13 \u57fa\u672c\u67e5\u8be2\u603b\u7ed3","text":"<p>\u57fa\u672c\u7684\u67e5\u8be2\u8bed\u53e5\u5305\u542b\u7684\u5b50\u53e5\u6709\uff1aselect\u5b50\u53e5\uff0cfrom\u5b50\u53e5\uff0cwhere\u5b50\u53e5\uff0cgroup by\u5b50\u53e5\uff0chaving\u5b50 \u53e5\uff0corder by\u5b50\u53e5</p> <p>\u5b8c\u6574\u7684\u67e5\u8be2\u8bed\u53e5\uff1a</p> <pre><code>select..from..[where..][group by..][having..][order by..]\n</code></pre> <p>\u6267\u884c\u987a\u5e8f\uff1a\u5148\u6267\u884cfrom\u5b50\u53e5\uff0c\u518d\u6267\u884cwhere\u5b50\u53e5\uff0c\u7136\u540egroup by\u5b50\u53e5\uff0c\u518d\u6b21having\u5b50\u53e5\uff0c\u4e4b\u540e select\u5b50\u53e5\uff0c\u6700\u540eorder by\u5b50\u53e5</p>"},{"location":"db_ops/3db_sql/#4-14","title":"4-14 \u9ad8\u7ea7\u5173\u8054\u67e5\u8be2","text":"<p>\u6709\u7684\u65f6\u5019\uff0c\u67e5\u8be2\u7684\u6570\u636e\u4e00\u4e2a\u7b80\u5355\u7684\u67e5\u8be2\u8bed\u53e5\u6ee1\u8db3\u4e0d\u4e86\uff0c\u5e76\u4e14\u4f7f\u7528\u7684\u6570\u636e\u5728\u8868\u4e2d\u4e0d\u80fd\u76f4\u89c2\u4f53\u73b0\u51fa\u6765\u3002\u800c\u662f\u9700\u8981\u9884\u5148\u7ecf\u8fc7\u4e00\u6b21\u67e5\u8be2\u624d\u4f1a\u6709\u6240\u4f53\u73b0\u3002\u5148\u6267\u884c\u7684\u5b50\u67e5\u8be2\u3002\u5b50\u67e5\u8be2\u5d4c\u5165\u5230\u7684\u67e5\u8be2\u8bed\u53e5\u79f0\u4e4b\u4e3a\u7236\u67e5 \u8be2\u3002</p> <p>\u5b50\u67e5\u8be2\u8fd4\u56de\u7684\u6570\u636e\u7279\u70b9\uff1a</p> <ol> <li>\u53ef\u80fd\u662f\u5355\u884c\u5355\u5217\u7684\u6570\u636e\u3002</li> <li>\u53ef\u80fd\u662f\u591a\u884c\u5355\u5217\u7684\u6570\u636e</li> <li>\u53ef\u80fd\u662f\u5355\u884c\u591a\u5217\u7684\u6570\u636e</li> <li>\u53ef\u80fd\u662f\u591a\u884c\u591a\u5217\u7684\u6570\u636e</li> </ol> <p>\u5b50\u67e5\u8be2\u53ef\u4ee5\u5728where\u3001from\u3001having\u3001select\u5b57\u53e5\u4e2d\uff0c\u5728select\u5b50\u53e5\u4e2d\u65f6\u76f8\u5f53\u4e8e\u5916\u8fde\u63a5\u7684\u53e6\u5916\u4e00\u79cd \u5199\u6cd5</p> <pre><code># \u67e5\u8be2\u8868\u4e2d\u5404\u90e8\u95e8\u4eba\u5458\u4e2d\u5927\u4e8e\u90e8\u95e8\u5e73\u5747\u5de5\u8d44\u7684\u4eba\nselect name,sal,a.deptid ,b.av\nfrom test a,\n(select deptid,avg(ifnull(sal,0)) as av from test group by deptid) b\nwhere a.deptid=b.deptid and a.sal&gt;b.av\norder by deptid ASC;\n</code></pre>"},{"location":"db_ops/3db_sql/#5dcl","title":"5\u3001\u6570\u636e\u63a7\u5236\u8bed\u8a00(DCL)","text":"<p>\u6570\u636e\u63a7\u5236\u8bed\u8a00 Data Control Language,\u4f5c\u7528\u662f\u7528\u6765\u521b\u5efa\u7528\u6237\uff0c\u7ed9\u7528\u6237\u6388\u6743\uff0c\u64a4\u9500\u6743\u9650\uff0c\u5220\u9664\u7528\u6237\u3002\u683c\u5f0f:</p>"},{"location":"db_ops/3db_sql/#5-1","title":"5-1 \u521b\u5efa\u7528\u6237","text":"<pre><code>create user username@ip identified by newPwd;\ncreate user 'test'@'192.168.152.166' identified by 'test.123com';\n</code></pre>"},{"location":"db_ops/3db_sql/#5-2","title":"5-2 \u663e\u793a\u7528\u6237\u7684\u6743\u9650","text":"<pre><code>show grants for username@ip;\n</code></pre>"},{"location":"db_ops/3db_sql/#5-3","title":"5-3 \u6388\u6743","text":"<pre><code>grant \u6743\u96501\uff0c\u6743\u96502... on \u6570\u636e\u5e93\u540d.* to username@ip;\ngrant select,drop,insert on test.* to 'test'@'192.168.152.166';\n</code></pre> <ul> <li>DML \u6743\u9650\uff1ainsert,delete,update</li> <li>DQL \u6743\u9650\uff1aselect</li> <li>DDL \u6743\u9650\uff1acreate,alter,drop</li> </ul>"},{"location":"db_ops/3db_sql/#5-4","title":"5-4 \u64a4\u9500\u6743\u9650","text":"<pre><code>revoke \u6743\u96501\uff0c\u6743\u96502..on \u6570\u636e\u5e93\u540d.* from username@ip;\nrevoke drop on test.* to 'test'@'192.168.152.166';\n</code></pre>"},{"location":"db_ops/3db_sql/#5-5","title":"5-5 \u5220\u9664\u7528\u6237","text":"<pre><code>drop user username;\ndrop user test;\n</code></pre>"},{"location":"db_ops/3db_sql/#5-6","title":"5-6 \u4f7f\u6743\u9650\u7acb\u5373\u751f\u6548","text":"<pre><code>flush privileges\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/","title":"\u7b2c\u56db\u8282 MySQL \u64cd\u4f5c\u5b9e\u4f8b(\u4e0a)","text":""},{"location":"db_ops/4db_sql_ops1/#1","title":"1\u3001\u521b\u5efa\u8868","text":""},{"location":"db_ops/4db_sql_ops1/#1-1","title":"1-1 \u8bed\u6cd5","text":"<pre><code>create table \u8868\u540d(\n \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570], # \u8bb0\u4f4f\u52a0\u9017\u53f7\n \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570], # \u8bb0\u4f4f\u52a0\u9017\u53f7\n \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570]  # \u6700\u540e\u4e00\u884c\u4e0d\u52a0\u9017\u53f7\n)charset=utf8; # \u540e\u9762\u52a0\u5206\u53f7\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#1-2","title":"1-2 \u5217\u7ea6\u675f","text":"<ul> <li><code>auto_increment</code> : \u81ea\u589e 1 primary key : \u4e3b\u952e\u7d22\u5f15\uff0c\u52a0\u5feb\u67e5\u8be2\u901f\u5ea6, \u5217\u7684\u503c\u4e0d\u80fd\u91cd\u590d <code>NOT NULL</code> \u6807\u8bc6\u8be5\u5b57\u6bb5\u4e0d\u80fd\u4e3a\u7a7a <code>DEFAULT</code> \u4e3a\u8be5\u5b57\u6bb5\u8bbe\u7f6e\u9ed8\u8ba4\u503c</li> </ul>"},{"location":"db_ops/4db_sql_ops1/#1-3","title":"1-3 \u5b9e\u4f8b","text":"<pre><code>mysql&gt; create table slt(\nnum int auto_increment primary key,\nname char(10),\njob char(10),\nage int,\nsalary int,\ndescrip char(128)not null default ''\n)charset=utf8;\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#2","title":"2\u3001\u67e5\u770b\u8868\u7ed3\u6784","text":"<p><code>desc slt;</code></p> <pre><code>mysql&gt; desc slt;\n+---------+-----------+------+-----+---------+----------------+\n| Field   | Type     | Null | Key | Default | Extra         |\n+---------+-----------+------+-----+---------+----------------+\n| num     | int(11)   | NO   | PRI | NULL   | auto_increment |\n| name   | char(10) | YES |     | NULL   |               |\n| job     | char(10) | YES |     | NULL   |               |\n| age     | int(11)   | YES |     | NULL   |               |\n| salary | int(11)   | YES |     | NULL   |               |\n| descrip | char(128) | NO   |     |   |               |\n+---------+-----------+------+-----+---------+----------------+\n6 rows in set (0.02 sec)\n</code></pre> <p>\u6b64\u65f6\u8868\u6570\u636e\u4e3a\u7a7a</p> <pre><code>mysql&gt; select * from slt;\nqfeduty set (0.00 sec)\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#3","title":"3\u3001\u63d2\u5165\u6570\u636e","text":""},{"location":"db_ops/4db_sql_ops1/#3-1","title":"3-1 \u8bed\u6cd5","text":"<pre><code>insert into \u8868\u540d (\u52171, \u52172) values (\u503c1,'\u503c2');\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#3-2","title":"3-2 \u5b9e\u4f8b","text":"<pre><code>mysql&gt; insert into slt(name, job, age, salary,descrip) values\n('Tom','teacher',30,20000,'level2'),\n('frank','teacher',31,21000,'level2'),\n('jack','teacher',32,22000,'level2'),\n('jhon','asistant',23,8000,'level3'),\n('hugo','manager',45,30000,'level4'),\n('jinhisan','teacher',26,9000,'level1')\n;\nQuery OK, 6 row affected (0.01 sec)\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#4","title":"4 \u6570\u636e\u67e5\u8be2","text":""},{"location":"db_ops/4db_sql_ops1/#4-1","title":"4-1 \u8bed\u6cd5","text":"<pre><code>select \u52171, \u52172 from \u8868\u540d; \uff08*\u4ee3\u8868\u67e5\u8be2\u6240\u6709\u7684\u5217\uff09\n</code></pre> <p>\u67e5\u770b\u5c97\u4f4d\u662f teacher \u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u9f84</p> <pre><code>mysql&gt; select distinct name, age from slt where job='teacher\n</code></pre> <p>\u67e5\u770b\u5c97\u4f4d\u662fteacher\u4e14\u5e74\u9f84\u5927\u4e8e30\u5c81\u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u9f84</p> <pre><code>mysql&gt; select distinct name, age from slt where job='teacher' and age&gt;30;\n</code></pre> <p>\u67e5\u770b\u5c97\u4f4d\u662f teacher\u4e14\u85aa\u8d44\u57281000-9000\u8303\u56f4\u5185\u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u9f84\u3001\u85aa\u8d44</p> <pre><code>mysql&gt; select distinct name, age, salary from slt where job='teacher' and\n(salary&gt;1000 and salary&lt;9000)\n</code></pre> <p>\u67e5\u770b\u5c97\u4f4d\u63cf\u8ff0\u4e0d\u4e3aNULL\u7684\u5458\u5de5\u4fe1\u606f</p> <pre><code>mysql&gt; select * from slt where descrip!=NULL\n</code></pre> <p>\u67e5\u770b\u5c97\u4f4d\u662fteacher\u4e14\u85aa\u8d44\u662f10000\u62169000\u621630000\u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u9f84\u3001\u85aa\u8d44</p> <pre><code>mysql&gt; select distinct name, age, salary from slt where job='teacher' and\n(salary=10000 or salary=9000 or salary=30000);\n</code></pre> <p>\u67e5\u770b\u5c97\u4f4d\u662fteacher\u4e14\u85aa\u8d44\u4e0d\u662f10000\u62169000\u621630000\u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u9f84\u3001\u85aa\u8d44</p> <pre><code>mysql&gt; select distinct name, age, salary from slt where job='teacher' and\n(salary not in (10000,9000,30000));\n</code></pre> <p>\u67e5\u770b\u5c97\u4f4d\u662fteacher\u4e14\u540d\u5b57\u662f'jin'\u5f00\u59cb\u7684\u5458\u5de5\u59d3\u540d\u3001\u5e74\u85aa</p> <pre><code>mysql&gt; select * from slt where job='teacher' and name like 'jin%' ;\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#4-2","title":"4-2 \u5b9e\u4f8b","text":"<pre><code>\u4f8b\u5b501\uff1a\n\u521b\u5efa\u8868\nmysql&gt; create table t1(\n   id int,\n   name char(5)\n)charset=utf8;\nQuery OK, 0 rows affected (0.72 sec)   # \u5982\u679c\u56de\u663e\u662fqueryok\uff0c\u4ee3\u8868\u521b\u5efa\u6210\u529f\n\n\n\u63d2\u5165\u6570\u636e\uff1a\nmysql&gt; insert into t1 (id, name) values (1, 'qfedu');\nQuery OK, 1 row affected (0.00 sec)\n\nmysql&gt; select * from t1;\n+------+-------+\n| id   | name |\n+------+-------+\n|    1 | qfedu |\n+------+-------+\n1 row in set (0.00 sec)\n\n\n\u4f8b\u5b502:\nmysql&gt; create table t2(\n   id int auto_increment primary key,\n   name char(10)\n)charset=utf8;\n\nmysql&gt; insert into t2 (name) values ('qfedu1');\n\n\n\n\u4f8b\u5b503: (\u63a8\u8350)\nmysql&gt; create table t3(\n   id  int unsigned auto_increment primary key,\n   name char(10) not null default 'xxx',\n   age int not null default 0\n)charset=utf8;\n\n\nmysql&gt; insert into t3 (age) values (10);\nQuery OK, 1 row affected (0.00 sec)\n\n\nmysql&gt; select * from t3;\n+----+------+-----+\n| id | name | age |\n+----+------+-----+\n|  1 | xxx |  10 |\n+----+------+-----+\n1 row in set (0.00 sec) \n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#5","title":"5\u3001\u4fee\u6539\u8868","text":""},{"location":"db_ops/4db_sql_ops1/#5-1","title":"5-1 \u4fee\u6539\u8868\u540d","text":"<pre><code>ALTER TABLE \u65e7\u8868\u540d RENAME \u65b0\u8868\u540d;\n</code></pre> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; alter table t3 rename t4;\nQuery OK, 0 rows affected (0.19 sec)\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#5-2","title":"5-2 \u589e\u52a0\u5b57\u6bb5","text":"<p>\u6dfb\u52a0\u5230\u6700\u540e\u8bed\u6cd5</p> <pre><code>ALTER TABLE \u8868\u540d\nADD \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570],\nADD \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570];\n</code></pre> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; create table t88(\n   id int,\n   age int\n)charset=utf8;\n\nmysql&gt; alter table t88 add name varchar(32) not null default '';\nQuery OK, 0 rows affected (0.82 sec)\nRecords: 0 Duplicates: 0  Warnings: 0\n</code></pre> <p>\u4e0a\u9762\u6dfb\u52a0\u7684\u5217\u6c38\u8fdc\u662f\u6dfb\u52a0\u5728\u6700\u540e\u4e00\u5217\u4e4b\u540e,\u8fd8\u53ef\u4ee5\u6dfb\u52a0\u5230\u6700\u524d\u9762</p> <p>\u6dfb\u52a0\u5230\u5f00\u5934\u8bed\u6cd5</p> <pre><code>ALTER TABLE \u8868\u540d\nADD \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570] FIRST;\n</code></pre> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; alter table t88 add name3 varchar(32) not null default '' first;\nQuery OK, 0 rows affected (0.83 sec)\nRecords: 0 Duplicates: 0  Warnings:0\n</code></pre> <p>\u6dfb\u52a0\u5230\u6307\u5b9a\u5b57\u6bb5\u540e\u9762</p> <pre><code>ALTER TABLE \u8868\u540d\nADD \u5b57\u6bb5\u540d \u5217\u7c7b\u578b [\u53ef\u9009\u7684\u53c2\u6570] AFTER \u5b57\u6bb5\u540d;\n</code></pre> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; alter table t88 add name4 varchar(32) not null default '' after name;\n\nQuery OK, 0 rows affected (0.68 sec)\nRecords: 0 Duplicates: 0  Warnings: 0\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#5-3","title":"5-3 \u5220\u9664\u5b57\u6bb5","text":"<p>\u8bed\u6cd5</p> <pre><code>ALTER TABLE \u8868\u540d  DROP \u5b57\u6bb5\u540d;\n</code></pre> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; alter table t88 drop name4;\nQuery OK, 0 rows affected (0.66 sec)\nRecords: 0 Duplicates: 0  Warnings: 0\n</code></pre>"},{"location":"db_ops/4db_sql_ops1/#5-4","title":"5-4 \u4fee\u6539\u5b57\u6bb5","text":"<p>\u8bed\u6cd51</p> <pre><code>ALTER TABLE \u8868\u540d MODIFY \u5b57\u6bb5\u540d \u6570\u636e\u7c7b\u578b [\u5b8c\u6574\u6027\u7ea6\u675f\u6761\u4ef6\u2026];\n</code></pre> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; alter table t88 modify name char(20);\n\nQuery OK, 1 row affected (0.88 sec)\nRecords: 1 Duplicates: 0  Warnings: 0\n</code></pre> <p>\u8bed\u6cd52</p> <pre><code>ALTER TABLE \u8868\u540d CHANGE \u65e7\u5b57\u6bb5\u540d \u65b0\u5b57\u6bb5\u540d \u65b0\u6570\u636e\u7c7b\u578b [\u5b8c\u6574\u6027\u7ea6\u675f\u6761\u4ef6\n</code></pre> <p>\u5b9e\u4f8b2</p> <pre><code>mysql&gt; alter table t88 change name name2 varchar(32) not null default '';\nQuery OK, 1 row affected (0.82 sec)\nRecords: 1 Duplicates: 0  Warnings:0\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/","title":"\u7b2c\u4e94\u8282 MySQL \u64cd\u4f5c\u5b9e\u4f8b(\u4e2d)","text":""},{"location":"db_ops/5db_sql_ops2/#1","title":"1\u3001\u5220\u51fa\u8868","text":"<pre><code>drop table \u8868\u540d;  # \u7ebf\u4e0a\u7981\u7528\n</code></pre> <pre><code>mysql&gt; drop table t9;\nQuery OK, 0 rows affected (0.18 sec)\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/#2","title":"2\u3001\u67e5\u8be2\u8868","text":"<pre><code>mysql&gt; show tables;\n+----------------+\n| Tables_in_test |\n+----------------+\n| t1             |\n+----------------+\n1 row in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/#3","title":"3\u3001\u590d\u5236\u8868\u7ed3\u6784","text":"<pre><code>mysql&gt; create table t8 like t1;\nQuery OK, 0 rows affected (0.33 sec)\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/#4","title":"4\u3001\u64cd\u4f5c\u8868\u6570\u636e\u884c","text":""},{"location":"db_ops/5db_sql_ops2/#4-1","title":"4-1 \u589e\u52a0\u6570\u636e","text":"<pre><code>insert into \u8868\u540d (\u52171, \u52172) values (\u503c1,'\u503c2');\n</code></pre> <pre><code># \u66b4\u529b\u590d\u5236\nmysql&gt; insert into t1 (name) select name from t8;\nQuery OK, 4 rows affected (0.09 sec)\nRecords: 4 Duplicates: 0  Warnings: 0\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/#4-2","title":"4-2 \u5220\u9664\u6570\u636e","text":"<p>delete from \u8868\u540d where \u6761\u4ef6;</p> <pre><code>mysql&gt; insert into t1 (id, name) values (1, 'qf1');\nmysql&gt; insert into t1 (id, name) values (2, 'qf2');\nmysql&gt; insert into t1 (id, name) values (3, 'qf3');\nmysql&gt; insert into t1 (id, name) values (4, 'qf4');\nmysql&gt; delete from t1 where id=1;\nmysql&gt; delete from t1 where id&gt;1;\nmysql&gt; delete from t1 where id&gt;=1;\nmysql&gt; delete from t1 where id&lt;1;\nmysql&gt; delete from t1 where id&lt;=1;\nmysql&gt; delete from t1 where id&gt;=1 and id&lt;10;\nQuery OK, 1 row affected (0.06 sec\n</code></pre> <p>truncate \u8868\u540d; # \u6ca1\u6709where\u6761\u4ef6\u7684</p> <pre><code>mysql&gt; truncate t1;\nQuery OK, 0 rows affected (0.25 sec)\n\nmysql&gt; select * from t1;\nEmpty set (0.00 sec)\n\nmysql&gt; insert into t1 (id, name) values (1, 'qf1');\nQuery OK, 1 row affected (0.06 sec)\n\nmysql&gt; select * from t1;\n+------+------+\n| id   | name |\n+------+------+\n|    1 | qf1 |\n+------+------+\n1 row in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/#4-3","title":"4-3 \u533a\u522b","text":"<ul> <li>delete \u4e4b\u540e\uff0c\u63d2\u5165\u6570\u636e\u4ece\u4e0a\u4e00\u6b21\u4e3b\u952e\u81ea\u589e\u52a01\u5f00\u59cb\uff0c truncate\u5219\u662f\u4ece1\u5f00\u59cb</li> <li>delete \u5220\u9664\uff0c \u662f\u4e00\u884c\u4e00\u884c\u7684\u5220\u9664\uff0c truncate\uff1a\u5168\u9009\u5220\u9664 truncate\u5220\u9664\u7684\u901f\u5ea6\u662f\u9ad8\u4e8edelete\u7684</li> </ul>"},{"location":"db_ops/5db_sql_ops2/#5","title":"5\u3001\u4fee\u6539\u6570\u636e","text":"<pre><code>update \u8868\u540d set \u5217\u540d1=\u65b0\u503c1,\u5217\u540d2=\u65b0\u503c2 where \u6761\u4ef6;\n</code></pre> <pre><code>mysql&gt; insert into t1 (id, name) values (1, 'qf1');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; insert into t1 (id, name) values (2, 'qf2');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; insert into t1 (id, name) values (3, 'qf3');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; insert into t1 (id, name) values (4, 'qf4');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; select * from t1;\n+------+------+\n| id   | name |\n+------+------+\n|    1 | qf1 |\n|    2 | qf2 |\n|    3 | qf3 |\n|    4 | qf4 |\n+------+------+\n4 rows in set (0.00 sec)\nmysql&gt; update t1 set name='qfx' where id=1;\nQuery OK, 1 row affected (0.00 sec)\nRows matched: 1  Changed: 1  Warnings: 0\nmysql&gt; select * from t1 ;\n+------+------+\n| id   | name |\n+------+------+\n|    1 | qfx |\n|    2 | qf2 |\n|    3 | qf3 |\n|    4 | qf4 |\n+------+------+\n4 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/#6","title":"6\u3001\u67e5\u8be2\u6570\u636e","text":"<pre><code>select \u52171, \u52172 from \u8868\u540d; \uff08*\u4ee3\u8868\u67e5\u8be2\u6240\u6709\u7684\u5217\uff09\nselect * from \u8868\u540d; \uff08*\u4ee3\u8868\u67e5\u8be2\u6240\u6709\u7684\u5217\uff09\n</code></pre> <pre><code>mysql&gt; select * from t1;\n+------+------+------+\n| id   | name | age |\n+------+------+------+\n|    1 | qfx | NULL |\n|    2 | qf2 | NULL |\n|    3 | qf3 | NULL |\n|    4 | qf4 | NULL |\n|    5 | qf3 | NULL |\n+------+------+------+\n6 rows in set (0.00 sec)\n\n# between..and...: \u53d6\u503c\u8303\u56f4\u662f\u95ed\u533a\u95f4\n\nmysql&gt; select * from t1 where id between 2 and 3;\n+------+------+------+\n| id   | name | age |\n+------+------+------+\n|    2 | qf2 | NULL |\n|    3 | qf3 | NULL |\n+------+------+------+\n2 rows in set (0.00 sec)\n\n# \u907f\u514d\u91cd\u590dDISTINCT\nmysql&gt; insert into t1 (id, name) values (5, 'qf3');\nQuery OK, 1 row affected (0.00 sec)\nmysql&gt; select * from t1;\n+------+------+\n| id   | name |\n+------+------+\n|    1 | qfx |\n|    2 | qf2 |\n|    3 | qf3 |\n|    4 | qf4 |\n|    5 | qf3 |\n+------+------+\n5 rows in set (0.00 sec)\nmysql&gt; select distinct name from t1;\n+------+\n| name |\n+------+\n| qfx |\n| qf2 |\n| qf3 |\n| qf4 |\n+------+\n4 rows in set (0.00 sec)\n\n# \u901a\u8fc7\u56db\u5219\u8fd0\u7b97\u67e5\u8be2 \uff08\u4e0d\u8981\u7528\uff09\nmysql&gt; alter table t1 add age int;\nQuery OK, 0 rows affected (0.03 sec)\nRecords: 0 Duplicates: 0  Warnings: 0\nmysql&gt; insert into t1 (id, name,age) values (5, 'qf3',10);\nQuery OK, 1 row affected (0.01 sec)\nmysql&gt; select * from t1;\n+------+------+------+\n| id   | name | age |\n+------+------+------+\n|    1 | qfx | NULL |\n|    2 | qf2 | NULL |\n|    3 | qf3 | NULL |\n|    4 | qf4 | NULL |\n|    5 | qf3 | NULL |\n|    5 | qf3 |   10 |\n+------+------+------+\n6 rows in set (0.00 sec)\nmysql&gt; select name, age*10 from t1;\n+------+--------+\n| name | age*10 |\n+------+--------+\n| qfx |   NULL |\n| qf2 |   NULL |\n| qf3 |   NULL |\n| qf4 |   NULL |\n| qf3 |   NULL |\n| qf3 |    100 |\n+------+--------+\n6 rows in set (0.00 sec)\nmysql&gt;  select name, age*10 as age from t1;\n+------+------+\n| name | age |\n+------+------+\n| qfx | NULL |\n| qf2 | NULL |\n| qf3 | NULL |\n| qf4 | NULL |\n| qf3 | NULL |\n| qf3 |  100 |\n+------+------+\n6 rows in set (0.00 sec)\nmysql&gt; select * from t1 where id in (3,5,6);\n+------+------+------+\n| id   | name | age |\n+------+------+------+\n|    3 | qf3 | NULL |\n|    5 | qf3 | NULL |\n|    5 | qf3 |   10 |\n+------+------+------+\n3 rows in set (0.00 sec)\n# like : \u6a21\u7cca\u67e5\u8be2\n# \u4ee5x\u5f00\u5934\uff1a\nmysql&gt; select * from t1 where name like 'q%';\n+------+------+------+\n| id   | name | age |\n+------+------+------+\n|    1 | qfx | NULL |\n|    2 | qf2 | NULL |\n|    3 | qf3 | NULL |\n|    4 | qf4 | NULL |\n|    5 | qf3 | NULL |\n|    5 | qf3 |   10 |\n+------+------+------+\n6 rows in set (0.00 sec)\n\n# \u4ee5x\u7ed3\u5c3e\nmysql&gt; select * from t1 where name like '%3';\n+------+------+------+\n| id   | name | age |\n+------+------+------+\n|    3 | qf3 | NULL |\n|    5 | qf3 | NULL |\n|    5 | qf3 |   10 |\n+------+------+------+\n3 rows in set (0.00 sec)\n\n# \u5305\u542bx\u7684\uff1a\nmysql&gt; select * from t1 where name like '%2%';\n+------+------+------+\n| id   | name | age |\n+------+------+------+\n|    2 | qf2 | NULL |\n+------+------+------+\n1 row in set (0.00 sec)\n</code></pre> <p>\u67e5\u8be2\u65f6\u7528\u2018Name Is Null\u2019 \u4f5c\u4e3a\u6761\u4ef6</p> <pre><code>mysql&gt;create table t8(\nid int auto_increment primary key,\nname varchar(32),\nemail varchar(32)\n)charset=utf8;\nmysql&gt;insert into t8(email) values ('test');\nmysql&gt; select * from t8;\n+----+------+-------+\n| id | name | email |\n+----+------+-------+\n|  1 | NULL | test |\n+----+------+-------+\n1 row in set (0.01 sec)\nmysql&gt; select * from t8 where name is null;\n+----+------+-------+\n| id | name | email |\n+----+------+-------+\n|  1 | NULL | test |\n+----+------+-------+\n1 row in set (0.00 sec)\n</code></pre> <ul> <li>\u67e5\u8be2\u65f6\u7528<code>\u2018Name=\u2019\u2018 \u2019</code>\u4f5c\u4e3a\u67e5\u8be2\u6761\u4ef6</li> </ul> <pre><code>mysql&gt; create table t9(\nid int auto_increment primary key,\nname varchar(32) not null default '',\nemail varchar(32) not null default ''\n)charset=utf8;\nmysql&gt; insert into t9 (email) values ('test');\nmysql&gt; select * from t9;\n+----+------+-------+\n| id | name | email |\n+----+------+-------+\n|  1 |     | test |\n+----+------+-------+\n1 row in set (0.00 sec)\nmysql&gt; select * from t9 where name='';\n+----+------+-------+\n| id | name | email |\n+----+------+-------+\n|  1 |     | test |\n+----+------+-------+\n1 row in set (0.01 sec)\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/#7","title":"7\u3001\u5355\u8868\u64cd\u4f5c","text":""},{"location":"db_ops/5db_sql_ops2/#7-1","title":"7-1 \u5355\u8868\u67e5\u8be2\u7684\u8bed\u6cd5\uff1a","text":"<pre><code>select \u5b57\u6bb51\uff0c\u5b57\u6bb52 from \u8868\u540d  \n                        where \u6761\u4ef6\n                        group by field\n                        having \u7b5b\u9009\n                        order by field\n                        limit \u9650\u5236\u6761\u6570\n</code></pre>"},{"location":"db_ops/5db_sql_ops2/#7-2-group-by","title":"7-2 \u5206\u7ec4\uff1aGroup By","text":"<p>\u5206\u7ec4\u6307\u7684\u662f\uff1a\u5c06\u6240\u6709\u8bb0\u5f55\u6309\u7167\u67d0\u4e2a\u76f8\u540c\u5b57\u6bb5\u8fdb\u884c\u5f52\u7c7b\uff0c\u6bd4\u5982 \u9488\u5bf9\u5458\u5de5\u4fe1\u606f\u8868\u7684\u804c\u4f4d\u5206\u7ec4\uff0c\u6216\u8005\u6309\u7167 \u6027\u522b\u8fdb\u884c\u5206\u7ec4\u7b49</p> <p>\u7528\u6cd5\uff1aselect \u805a\u5408\u51fd\u6570\uff0c\u5b57\u6bb5\u540d from \u8868\u540d</p> <ul> <li>group by \u5206\u7ec4\u7684\u5b57\u6bb5\uff1bgroup by \u662f\u5206\u7ec4\u7684\u5173\u952e\u8bcd\uff0c \u5fc5\u987b\u548c\u805a\u5408\u51fd\u6570 \u4e00\u8d77\u51fa\u73b0</li> <li>where \u6761\u4ef6\u8bed\u53e5\u548c group by \u5206\u7ec4\u8bed\u53e5\u7684\u5148\u540e\u987a\u5e8f\uff1a</li> <li><code>where &gt; group by &gt; having</code></li> </ul> <p>\u521b\u5efa\u8868</p> <pre><code>create table test(\nid int not null unique auto_increment,\nname varchar(20) not null,\ngender enum('male','female') not null default 'male',\nage int(3) unsigned not null default 28,\nhire_date date not null,\npost varchar(50),\npost_comment varchar(100),\nsalary double(15,2),\noffice int,          \ndepart_id int\n);\n</code></pre> <p>2. \u63d2\u5165\u6570\u636e</p> <p>\u6559\u5b66\u90e8 1\uff0c\u9500\u552e\u90e8\u95e8 2 \uff0c\u8fd0\u8425\u90e8\u95e8 3.</p> <pre><code>insert into test(name,gender,age,hire_date,post,salary,office,depart_id) values\n('egon','male',18,'20170301','www.test.com',7300.33,401,1),    \n('yangsheng','male',78,'20150302','teacher',1000000.31,401,1),\n('yangqiang','male',81,'20130305','teacher',8300,401,1),\n('liuchao','male',73,'20140701','teacher',3500,401,1),\n('luoyinsheng','male',28,'20121101','teacher',2100,401,1),\n('nana','female',18,'20110211','teacher',9000,401,1),\n('jinxin','male',18,'19000301','teacher',30000,401,1),\n('xingdian','male',48,'20101111','teacher',10000,401,1),\n\n('meiling','female',48,'20150311','sale',3000.13,402,2),\n('lili','female',38,'20101101','sale',2000.35,402,2),\n('xiaomei','female',18,'20110312','sale',1000.37,402,2),\n('zhenzhen','female',18,'20160513','sale',3000.29,402,2),\n('qianqian','female',28,'20170127','sale',4000.33,402,2),\n\n('zhangye','male',28,'20160311','operation',10000.13,403,3),\n('xiaolong','male',18,'19970312','operation',20000,403,3),\n('zhaowei','female',18,'20130311','operation',19000,403,3),\n('wujing','male',18,'20150411','operation',18000,403,3),\n('liying','female',18,'20140512','operation',17000,403,3)\n</code></pre> <p>\u4ee5\u6027\u522b\u4e3a\u4f8b\uff0c \u8fdb\u884c\u5206\u7ec4\uff0c \u7edf\u8ba1\u4e00\u4e0b\u7537\u751f\u548c\u5973\u751f\u7684\u4eba\u6570\u662f\u591a\u5c11\u4e2a\uff1a</p> <p><code>group by gender</code></p> <pre><code>mysql&gt; select count(id), gender from test group by gender;\n+-----------+--------+\n| count(id) | gender |\n+-----------+--------+\n|        10 | male   |\n|         8 | female |\n+-----------+--------+\n2 rows in set (0.00 sec)\n</code></pre> <p>\u5bf9\u90e8\u95e8\u8fdb\u884c\u5206\u7ec4\uff0c \u6c42\u51fa\u6bcf\u4e2a\u90e8\u95e8\u5e74\u9f84\u6700\u5927\u7684\u90a3\u4e2a\u4eba</p> <p>\u6ce8\u610f\uff1a\u51fa\u73b0 <code>sql_mode=only_full_group_by</code> \u9519\u8bef \u9700\u4fee\u6539 \u914d\u7f6e\u6587\u4ef6<code>/etc/my.cnf [mysqld]</code> \u6bb5\u6dfb\u52a0 sql\u6a21\u5f0f\uff0c\u91cd\u542f <code>mysqld</code></p> <pre><code>sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_\nZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION\n</code></pre> <pre><code>mysql&gt; select depart_id,name, max(age) from test group by depart_id;\n+-----------+---------+----------+\n| depart_id | name   | max(age) |\n+-----------+---------+----------+\n|         1 | egon   |       81 |\n|         2 | meiling |       48 |\n|         3 | zhangye |       28 |\n+-----------+---------+----------+\n3 rows in set (0.00 sec)\n</code></pre> <ul> <li>Min : \u6c42\u6700\u5c0f\u7684</li> <li>Sum \uff1a\u6c42\u548c</li> </ul> <pre><code>mysql&gt; select depart_id, sum(age) from test group by depart_id;\n+-----------+----------+\n| depart_id | sum(age) |\n+-----------+----------+\n|         1 |      362 |\n|         2 |      150 |\n|         3 |      100 |\n+-----------+----------+\n3 rows in set (0.00 sec)\n</code></pre> <p>Count \uff1a\u8ba1\u6570</p> <pre><code>mysql&gt; select depart_id,count(depart_id) from test group by depart_id;\n+-----------+------------------+\n| depart_id | count(depart_id) |\n+-----------+------------------+\n|         1 |                8 |\n|         2 |                5 |\n|         3 |                5 |\n+-----------+------------------+\n3 rows in set (0.00 sec)\n</code></pre> <p>Avg \uff1a\u5e73\u5747\u6570</p> <pre><code>mysql&gt; select depart_id, avg(age) from test group by depart_id;\n+-----------+----------+\n| depart_id | avg(age) |\n+-----------+----------+\n|         1 |  45.2500 |\n|         2 |  30.0000 |\n|         3 |  20.0000 |\n+-----------+----------+\n3 rows in set (0.00 sec)\n</code></pre> <p>3. Having</p> <p>Having \u7528\u4e8e\u5bf9 Group By \u4e4b\u540e\u7684\u6570\u636e\u8fdb\u884c\u8fdb\u4e00\u6b65\u7684\u7b5b\u9009</p> <pre><code>mysql&gt; select depart_id, avg(age) from test group by depart_id having avg(age)&gt;35;\n+-----------+----------+\n| depart_id | avg(age) |\n+-----------+----------+\n|         1 |  45.2500 |\n+-----------+----------+\n1 row in set (0.01 sec)\n</code></pre> <p>4. Order By: Order By \u5b57\u6bb5\u540d Asc\uff08\u5347\u5e8f\uff09/Desc(\u964d\u5e8f)</p> <p>\u5bf9\u591a\u4e2a\u5b57\u6bb5\u8fdb\u884c\u6392\u5e8f\uff1a</p> <p><code>age asc</code>, <code>depart_id desc;</code> \u8868\u793a\u5148\u5bf9age\u8fdb\u884c\u964d\u5e8f\uff0c\u518d\u628aage\u76f8\u7b49\u7684\u884c\u6309\u90e8\u95e8\u53f7\u8fdb\u884c\u5347\u5e8f\u6392\u5217</p> <pre><code>mysql&gt; select * from test order by age asc, depart_id desc;\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n| id | name       | gender | age | hire_date | post         | post_comment |\nsalary     | office | depart_id |\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n| 18 | liying     | female |  18 | 2014-05-12 | operation     | NULL         |\n  17000.00 |    403 |         3 |\n| 17 | wujing     | male   |  18 | 2015-04-11 | operation     | NULL         |\n  18000.00 |    403 |         3 |\n| 16 | zhaowei     | female |  18 | 2013-03-11 | operation     | NULL         |\n  19000.00 |    403 |         3 |\n| 15 | xiaolong   | male   |  18 | 1997-03-12 | operation     | NULL         |\n  20000.00 |    403 |         3 |\n| 11 | xiaomei     | female |  18 | 2011-03-12 | sale         | NULL         |\n   1000.37 |    402 |         2 |\n| 12 | zhenzhen   | female |  18 | 2016-05-13 | sale         | NULL         |\n   3000.29 |    402 |         2 |\n|  6 | nana       | female |  18 | 2011-02-11 | teacher       | NULL         |\n   9000.00 |    401 |         1 |\n|  7 | jinxin     | male   |  18 | 1900-03-01 | teacher       | NULL         |\n  30000.00 |    401 |         1 |\n|  1 | egon       | male   |  18 | 2017-03-01 | www.test.com | NULL         |\n   7300.33 |    401 |         1 |\n| 14 | zhangye     | male   |  28 | 2016-03-11 | operation     | NULL         |\n  10000.13 |    403 |         3 |\n| 13 | qianqian   | female |  28 | 2017-01-27 | sale         | NULL         |\n   4000.33 |    402 |         2 |\n|  5 | luoyinsheng | male   |  28 | 2012-11-01 | teacher       | NULL         |\n   2100.00 |    401 |         1 |\n| 10 | lili       | female |  38 | 2010-11-01 | sale         | NULL         |\n   2000.35 |    402 |         2 |\n|  9 | meiling     | female |  48 | 2015-03-11 | sale         | NULL         |\n   3000.13 |    402 |         2 |\n|  8 | xingdian   | male   |  48 | 2010-11-11 | teacher       | NULL         |\n  10000.00 |    401 |         1 |\n|  4 | liuchao     | male   |  73 | 2014-07-01 | teacher       | NULL         |\n   3500.00 |    401 |         1 |\n|  2 | yangsheng   | male   |  78 | 2015-03-02 | teacher       | NULL         |\n1000000.31 |    401 |         1 |\n|  3 | yangqiang   | male   |  81 | 2013-03-05 | teacher       | NULL         |\n   8300.00 |    401 |         1 |\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n18 rows in set (0.00 sec)\n</code></pre> <p><code>select * from test order by depart_id asc, age desc;</code></p> <pre><code>mysql&gt; select * from test order by depart_id asc, age desc;\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n| id | name       | gender | age | hire_date | post         | post_comment |\nsalary     | office | depart_id |\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n|  3 | yangqiang   | male   |  81 | 2013-03-05 | teacher       | NULL         |\n   8300.00 |    401 |         1 |\n|  2 | yangsheng   | male   |  78 | 2015-03-02 | teacher       | NULL         |\n1000000.31 |    401 |         1 |\n|  4 | liuchao     | male   |  73 | 2014-07-01 | teacher       | NULL         |\n   3500.00 |    401 |         1 |\n|  8 | xingdian   | male   |  48 | 2010-11-11 | teacher       | NULL         |\n  10000.00 |    401 |         1 |\n|  5 | luoyinsheng | male   |  28 | 2012-11-01 | teacher       | NULL         |\n   2100.00 |    401 |         1 |\n|  6 | nana       | female |  18 | 2011-02-11 | teacher       | NULL         |\n   9000.00 |    401 |         1 |\n|  7 | jinxin     | male   |  18 | 1900-03-01 | teacher       | NULL         |\n  30000.00 |    401 |         1 |\n|  1 | egon       | male   |  18 | 2017-03-01 | www.test.com | NULL         |\n   7300.33 |    401 |         1 |\n|  9 | meiling     | female |  48 | 2015-03-11 | sale         | NULL         |\n   3000.13 |    402 |         2 |\n| 10 | lili       | female |  38 | 2010-11-01 | sale         | NULL         |\n   2000.35 |    402 |         2 |\n| 13 | qianqian   | female |  28 | 2017-01-27 | sale         | NULL         |\n   4000.33 |    402 |         2 |\n| 11 | xiaomei     | female |  18 | 2011-03-12 | sale         | NULL         |\n   1000.37 |    402 |         2 |\n| 12 | zhenzhen   | female |  18 | 2016-05-13 | sale         | NULL         |\n   3000.29 |    402 |         2 |\n| 14 | zhangye     | male   |  28 | 2016-03-11 | operation     | NULL         |\n  10000.13 |    403 |         3 |\n| 15 | xiaolong   | male   |  18 | 1997-03-12 | operation     | NULL         |\n  20000.00 |    403 |         3 |\n| 16 | zhaowei     | female |  18 | 2013-03-11 | operation     | NULL         |\n  19000.00 |    403 |         3 |\n| 17 | wujing     | male   |  18 | 2015-04-11 | operation     | NULL         |\n  18000.00 |    403 |         3 |\n| 18 | liying     | female |  18 | 2014-05-12 | operation     | NULL         |\n  17000.00 |    403 |         3 |\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n18 rows in set (0.00 sec)\n</code></pre> <p>5. Limit \u5206\u9875\uff1aLimit Offset, Size</p> <ul> <li>offset \u8868\u793a \u884c\u6570\u636e\u7d22\u5f15\uff1bsize \u8868\u793a\u53d6\u591a\u5c11\u6761\u6570\u636e</li> <li>\u4ece\u7b2c offset \u884c\u5f00\u59cb\uff0c\u53d6 size \u884c\u6570\u636e\u3002</li> </ul> <p><code>limit 0,10</code></p> <pre><code>mysql&gt; select * from test limit 0,10;\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n| id | name       | gender | age | hire_date | post         | post_comment |\nsalary     | office | depart_id |\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n|  1 | egon       | male   |  18 | 2017-03-01 | www.test.com | NULL         |\n   7300.33 |    401 |         1 |\n|  2 | yangsheng   | male   |  78 | 2015-03-02 | teacher       | NULL         |\n1000000.31 |    401 |         1 |\n|  3 | yangqiang   | male   |  81 | 2013-03-05 | teacher       | NULL         |\n   8300.00 |    401 |         1 |\n|  4 | liuchao     | male   |  73 | 2014-07-01 | teacher       | NULL         |\n   3500.00 |    401 |         1 |\n|  5 | luoyinsheng | male   |  28 | 2012-11-01 | teacher       | NULL         |\n   2100.00 |    401 |         1 |\n|  6 | nana       | female |  18 | 2011-02-11 | teacher       | NULL         |\n   9000.00 |    401 |         1 |\n|  7 | jinxin     | male   |  18 | 1900-03-01 | teacher       | NULL         |\n  30000.00 |    401 |         1 |\n|  8 | xingdian   | male   |  48 | 2010-11-11 | teacher       | NULL         |\n  10000.00 |    401 |         1 |\n|  9 | meiling     | female |  48 | 2015-03-11 | sale         | NULL         |\n   3000.13 |    402 |         2 |\n| 10 | lili       | female |  38 | 2010-11-01 | sale         | NULL         |\n   2000.35 |    402 |         2 |\n+----+-------------+--------+-----+------------+---------------+--------------+-\n-----------+--------+-----------+\n10 rows in set (0.00 sec)\n</code></pre> <p>\u4ece\u7b2c6\u884c\u5f00\u59cb\u53d610\u884c  <code>imit 6,10</code></p> <pre><code>mysql&gt; select * from test limit 6,10;\n+----+-----------+--------+-----+------------+-----------+--------------+-------\n---+--------+-----------+\n| id | name     | gender | age | hire_date | post     | post_comment | salary\n  | office | depart_id |\n+----+-----------+--------+-----+------------+-----------+--------------+-------\n---+--------+-----------+\n|  7 | jinxin   | male   |  18 | 1900-03-01 | teacher   | NULL         |\n30000.00 |    401 |         1 |\n|  8 | \u6210\u9f99     | male   |  48 | 2010-11-11 | teacher   | NULL         |\n10000.00 |    401 |         1 |\n|  9 | \u6b6a\u6b6a     | female |  48 | 2015-03-11 | sale     | NULL         |\n3000.13 |    402 |         2 |\n| 10 | \u4e2b\u4e2b     | female |  38 | 2010-11-01 | sale     | NULL         |\n2000.35 |    402 |         2 |\n| 11 | \u4e01\u4e01     | female |  18 | 2011-03-12 | sale     | NULL         |\n1000.37 |    402 |         2 |\n| 12 | \u661f\u661f     | female |  18 | 2016-05-13 | sale     | NULL         |\n3000.29 |    402 |         2 |\n| 13 | \u683c\u683c     | female |  28 | 2017-01-27 | sale     | NULL         |\n4000.33 |    402 |         2 |\n| 14 | \u5f20\u91ce     | male   |  28 | 2016-03-11 | operation | NULL         |\n10000.13 |    403 |         3 |\n| 15 | \u7a0b\u54ac\u91d1   | male   |  18 | 1997-03-12 | operation | NULL         |\n20000.00 |    403 |         3 |\n| 16 | \u7a0b\u54ac\u94f6   | female |  18 | 2013-03-11 | operation | NULL         |\n19000.00 |    403 |         3 |\n+----+-----------+--------+-----+------------+-----------+--------------+-------\n---+--------+-----------+\n10 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/6db_sql_ops3/","title":"\u7b2c\u516d\u8282 Mysql\u64cd\u4f5c\u5b9e\u4f8b(\u4e0b)","text":""},{"location":"db_ops/6db_sql_ops3/#1","title":"1\u3001\u591a\u8868\u64cd\u4f5c","text":"<p>\u6982\u5ff5\uff1a\u5f53\u5728\u67e5\u8be2\u65f6\uff0c\u6240\u9700\u8981\u7684\u6570\u636e\u4e0d\u5728\u4e00\u5f20\u8868\u4e2d\uff0c\u53ef\u80fd\u5728\u4e24\u5f20\u8868\u6216\u591a\u5f20\u8868\u4e2d\u3002\u6b64\u65f6\u9700\u8981\u540c\u65f6\u64cd\u4f5c\u8fd9 \u4e9b\u8868\u3002\u5373\u5173\u8054\u67e5\u8be2\u3002</p> <ul> <li>\u7b49\u503c\u8fde\u63a5\uff1a\u5728\u505a\u591a\u5f20\u8868\u67e5\u8be2\u65f6\uff0c\u8fd9\u4e9b\u8868\u4e2d\u5e94\u8be5\u5b58\u5728\u7740\u6709\u5173\u8054\u7684\u4e24\u4e2a\u5b57\u6bb5\u3002\u4f7f\u7528\u67d0\u4e00\u5f20\u8868\u4e2d\u7684\u4e00\u6761\u8bb0 \u5f55\u4e0e\u53e6\u5916\u4e00\u5f20\u8868\u901a\u8fc7\u76f8\u5173\u8054\u7684\u4e24\u4e2a\u5b57\u6bb5\u8fdb\u884c\u5339\u914d\uff0c\u7ec4\u5408\u6210\u4e00\u6761\u8bb0\u5f55\u3002</li> <li>\u7b1b\u5361\u5c14\u79ef\uff1a\u5728\u505a\u591a\u5f20\u8868\u67e5\u8be2\u65f6\uff0c\u4f7f\u7528\u67d0\u4e00\u5f20\u8868\u4e2d\u7684\u6bcf\u4e00\u6761\u8bb0\u5f55\u90fd\u4e0e\u53e6\u5916\u4e00\u5f20\u8868\u7684\u6240\u6709\u8bb0\u5f55\u8fdb\u884c\u7ec4 \u5408\u3002\u6bd4\u5982\u8868A\u6709x\u6761\uff0c\u8868B\u6709y\u6761\uff0c\u6700\u7ec8\u7ec4\u5408\u6570\u4e3a<code>x*y</code>\uff0c\u8fd9\u4e2a\u503c\u5c31\u662f\u7b1b\u5361\u5c14\u79ef\uff0c\u901a\u5e38\u6ca1\u6709\u610f\u4e49\u3002</li> <li>\u5185\u8fde\u63a5\uff1a\u53ea\u8981\u4f7f\u7528\u4e86<code>join on</code>\u3002\u5c31\u662f\u5185\u8fde\u63a5\u3002\u67e5\u8be2\u6548\u679c\u4e0e\u7b49\u503c\u8fde\u63a5\u4e00\u6837\u3002</li> </ul> <p>\u7528\u6cd5</p> <pre><code>\u8868A [inner] join \u8868B on \u5173\u8054\u6761\u4ef6\n</code></pre> <ul> <li> <p>\u5916\u8fde\u63a5\uff1a\u5728\u505a\u591a\u5f20\u8868\u67e5\u8be2\u65f6\uff0c\u6240\u9700\u8981\u7684\u6570\u636e\uff0c\u9664\u4e86\u6ee1\u8db3\u5173\u8054\u6761\u4ef6\u7684\u6570\u636e\u5916\uff0c\u8fd8\u6709\u4e0d\u6ee1\u8db3\u5173\u8054\u6761\u4ef6\u7684 \u6570\u636e\u3002\u6b64\u65f6\u9700\u8981\u4f7f\u7528\u5916\u8fde\u63a5\u3002</p> <ul> <li>\u9a71\u52a8\u8868(\u4e3b\u8868)\uff1a\u9664\u4e86\u663e\u793a\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\uff0c\u8fd8\u9700\u8981\u663e\u793a\u4e0d\u6ee1\u8db3\u6761\u4ef6\u7684\u6570\u636e\u7684\u8868 </li> <li>\u4ece\u8868(\u526f\u8868)\uff1a\u53ea\u663e\u793a\u6ee1\u8db3\u5173\u8054\u6761\u4ef6\u7684\u6570\u636e\u7684\u8868 </li> <li>\u5916\u8fde\u63a5\u5206\u4e3a\u4e09\u79cd</li> </ul> </li> </ul> <p>\u5de6\u5916\u8fde\u63a5\uff1a\u8868A left [outer] join \u8868B on \u5173\u8054\u6761\u4ef6\uff0c\u8868A\u662f\u9a71\u52a8\u8868\uff0c\u8868B\u662f\u4ece\u8868 \u53f3\u5916\u8fde\u63a5\uff1a</p> <p>\u8868A right [outer] join \u8868B on \u5173\u8054\u6761\u4ef6\uff0c\u8868B\u662f\u9a71\u52a8\u8868\uff0c\u8868A\u662f\u4ece\u8868 \u5168\u5916\u8fde\u63a5\uff1a</p> <p>\u8868A full [outer] join \u8868B on \u5173\u8054\u6761\u4ef6\uff0c\u4e24\u5f20\u8868\u7684\u6570\u636e\u4e0d\u7ba1\u6ee1\u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u90fd\u505a\u663e\u793a\u3002</p> <ul> <li>\u81ea\u8fde\u63a5\uff1a\u5728\u591a\u5f20\u8868\u8fdb\u884c\u5173\u8054\u67e5\u8be2\u65f6\uff0c\u8fd9\u4e9b\u8868\u7684\u8868\u540d\u662f\u540c\u4e00\u4e2a\u3002\u5373\u81ea\u8fde\u63a5\u3002\u5916\u952e\uff1a\u5360\u7528\u7a7a\u95f4\u5c11\uff0c\u65b9\u4fbf\u4fee\u6539\u6570\u636e</li> </ul>"},{"location":"db_ops/6db_sql_ops3/#1-1","title":"1-1 \u4e00\u5bf9\u591a","text":"<pre><code>constraint \u5916\u952e\u540d foreign key (\u88ab\u7ea6\u675f\u7684\u5b57\u6bb5) references \u7ea6\u675f\u7684\u8868(\u7ea6\u675f\u7684\u5b57\u6bb5)\n</code></pre> <pre><code>mysql&gt; create table dep(\nid int auto_increment primary key,\nname varchar(32) not null default ''\n)charset=utf8;\n\nmysql&gt; insert into dep (name) values ('\u7814\u53d1\u90e8'),('\u8fd0\u7ef4\u90e8'),('\u884c\u653f\u90e8'),('\u5e02\u573a\u90e8');\n\nmysql&gt; create table userinfo (\nid int auto_increment primary key,\nname varchar(32) not null default '',\ndepart_id int not null default 1,\nconstraint fk_user_depart foreign key (depart_id) references dep(id)\n)charset utf8;\n\nmysql&gt; insert into userinfo (name, depart_id) values ('qfedu a',1);\nmysql&gt; insert into userinfo (name, depart_id) values ('qfedu b',2);\nmysql&gt; insert into userinfo (name, depart_id) values ('qfedu c',3);\nmysql&gt; insert into userinfo (name, depart_id) values ('qfedu d',4);\nmysql&gt; insert into userinfo (name, depart_id) values ('qfedu e',1);\nmysql&gt; insert into userinfo (name, depart_id) values ('qfedu f',2);\nmysql&gt; insert into userinfo (name, depart_id) values ('qfedu g',3);\n\n# \u4ee5\u4e0a7\u884c\u7b26\u5408\u5916\u952e\u8981\u6c42\uff0c\u6240\u4ee5\u80fd\u63d2\u5165\u4e0d\u62a5\u9519\uff0c\u4f46\u4e0b\u8fb9\u4e00\u884c\u63d2\u5165\u65f6\u4f1a\u62a5\u9519\nmysql&gt; insert into userinfo (name, depart_id) values ('qfedu h',5);\nERROR 1064 (42000): You have an error in your SQL syntax; check the manual that\ncorresponds to your MySQL server version for the right syntax to use near\n'mysql&gt; insert into userinfo (name, depart_id) values ('qfedu h',5)' at line \n</code></pre>"},{"location":"db_ops/6db_sql_ops3/#1-2","title":"1-2 \u591a\u5bf9\u591a","text":"<p>\u521b\u5efa\u7537\u751f\u8868</p> <pre><code>mysql&gt; create table boy(\nid int auto_increment primary key,\nbname varchar(32) not null default ''\n)charset=utf8;\n\nmysql&gt; insert into boy (bname) values ('xiaoming'),('xiaogang'),('xiaoqiang');\n</code></pre> <p>\u521b\u5efa\u5973\u751f\u8868</p> <pre><code>mysql&gt; create table girl(\nid int auto_increment primary key,\ngname varchar(32) not null default ''\n)charset=utf8;\n\nmysql&gt; insert into girl (gname) values ('xiaohong'),('xiaoli'),('xiaojiao');\n</code></pre> <p>\u521b\u5efa\u5173\u8054\u8868</p> <pre><code>mysql&gt; create table b2g(\nid int auto_increment primary key,\nbid int not null default 1,\ngid int not null default 0,\nconstraint fk_b2g_boy foreign key (bid) references boy(id),\nconstraint fk_b2g_girl foreign key (gid) references girl(id)\n)charset utf8;\n\nmysql&gt; insert into b2g (bid, gid) values (1,1),(1,2),(2,3),(3,3),(2,2);\n</code></pre> <p>\u7528\u5230 left jion</p> <pre><code>mysql&gt; select * from boy left join b2g on boy.id=b2g.bid left join girl on girl.id=b2g.gid;\n+----+-----------+------+------+------+------+----------+\n| id | bname     | id   | bid | gid | id   | gname   |\n+----+-----------+------+------+------+------+----------+\n|  1 | xiaoming |    1 |    1 |    1 |    1 | xiaohong |\n|  1 | xiaoming |    2 |    1 |    2 |    2 | xiaoli   |\n|  2 | xiaogang |    5 |    2 |    2 |    2 | xiaoli   |\n|  2 | xiaogang |    3 |    2 |    3 |    3 | xiaojiao |\n|  3 | xiaoqiang |    4 |    3 |    3 |    3 | xiaojiao |\n+----+-----------+------+------+------+------+----------+\n5 rows in set (0.01 sec)\n\n\nmysql&gt; select bname, gname from boy left join b2g on boy.id=b2g.bid left join girl on girl.id=b2g.gid;\n+-----------+----------+\n| bname     | gname   |\n+-----------+----------+\n| xiaoming | xiaohong |\n| xiaoming | xiaoli   |\n| xiaogang | xiaoli   |\n| xiaogang | xiaojiao |\n| xiaoqiang | xiaojiao |\n+-----------+----------+\n5 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/6db_sql_ops3/#1-3","title":"1-3 \u4e00\u5bf9\u4e00","text":"<p>\u521b\u5efa\u5458\u5de5\u4fe1\u606f\u8868</p> <pre><code>mysql&gt; create table user(\nid int auto_increment primary key,\nname varchar(32) not null default ''\n)charset=utf8;\n\nmysql&gt; insert into user (name) values ('xiaoming'),('xiaogang'),('xiaoqiang');\n\nmysql&gt; select * from user;\n+----+-----------+\n| id | name     |\n+----+-----------+\n|  1 | xiaoming |\n|  2 | xiaogang |\n|  3 | xiaoqiang |\n+----+-----------+\n3 rows in set (0.00 sec)\n</code></pre> <p>\u521b\u5efa\u5458\u5de5\u5de5\u8d44\u8868</p> <pre><code>mysql&gt; create table priv(\nid int auto_increment primary key,\nsalary int not null default 0,\nuid int not null default 1,\nconstraint fk_priv_user foreign key (uid) references user(id),\nunique(uid)\n)charset=utf8;\n\nmysql&gt; insert into priv (salary, uid) values (2000, 1),(2500,2),(3000,3);\n\nmysql&gt; select * from priv;\n+----+--------+-----+\n| id | salary | uid |\n+----+--------+-----+\n|  1 |   2000 |   1 |\n|  2 |   2500 |   2 |\n|  3 |   3000 |   3 |\n+----+--------+-----+\n3 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/6db_sql_ops3/#2","title":"2\u3001\u591a\u8868\u8054\u67e5","text":"<pre><code>mysql&gt;  select userinfo.name as uname, dep.name as dname from userinfo left join dep on depart_id=dep.id;\n+---------+-----------+\n| uname   | dname     |\n+---------+-----------+\n| qfedu a | \u7814\u53d1\u90e8   |\n| qfedu e | \u7814\u53d1\u90e8   |\n| qfedu b | \u8fd0\u7ef4\u90e8   |\n| qfedu f | \u8fd0\u7ef4\u90e8   |\n| qfedu c | \u884c\u653f\u90e8   |\n| qfedu g | \u884c\u653f\u90e8   |\n| qfedu d | \u5e02\u573a\u90e8   |\n+---------+-----------+\n7 rows in set (0.00 sec)\n\nmysql&gt; select userinfo.name as uname, dep.name as dname from userinfo left join\ndep on depart_id=dep.id;\n+---------+-----------+\n| uname   | dname     |\n+---------+-----------+\n| qfedu a | \u7814\u53d1\u90e8   |\n| qfedu e | \u7814\u53d1\u90e8   |\n| qfedu b | \u8fd0\u7ef4\u90e8   |\n| qfedu f | \u8fd0\u7ef4\u90e8   |\n| qfedu c | \u884c\u653f\u90e8   |\n| qfedu g | \u884c\u653f\u90e8   |\n| qfedu d | \u5e02\u573a\u90e8   |\n+---------+-----------+\n7 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/6db_sql_ops3/#3","title":"3\u3001\u5355\u8868\u591a\u8868\u67e5\u8be2\u7ec3\u4e60","text":""},{"location":"db_ops/6db_sql_ops3/#3-1","title":"3-1 \u521b\u5efa\u73ed\u7ea7\u8868","text":"<pre><code>mysql&gt; create table class1(\ncid int auto_increment primary key,\ncaption varchar(32) not null default ''\n)charset=utf8;\nmysql&gt; insert into class1 (caption) values ('\u4e09\u5e74\u4e8c\u73ed'),('\u4e00\u5e74\u4e09\u73ed'),('\u4e09\u5e74\u4e00\u73ed');\n\n\nmysql&gt; select * from class1;\n+-----+--------------+\n| cid | caption     |\n+-----+--------------+\n|   1 | \u4e09\u5e74\u4e8c\u73ed     |\n|   2 | \u4e00\u5e74\u4e09\u73ed     |\n|   3 | \u4e09\u5e74\u4e00\u73ed     |\n+-----+--------------+\n3 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/6db_sql_ops3/#3-2","title":"3-2 \u521b\u5efa\u5b66\u751f\u8868","text":"<pre><code>mysql&gt; create table stu(\nsid int auto_increment primary key,\nsname varchar(32) not null default '',\ngender varchar(32) not null default '',\nclass_id int not null default 1,\nconstraint fk_stu_class1 foreign key (class_id) references class1(cid)\n)charset=utf8;\n\n\nmysql&gt; insert into stu (sname, gender, class_id) values ('\u5c0f\u8587','\u5973',1),('\u5c0f\u96ea','\u5973',1),('\u5c0f\u660e','\u7537',2);\n\nmysql&gt; select * from stu;\n+-----+--------+--------+----------+\n| sid | sname | gender | class_id |\n+-----+--------+--------+----------+\n|   1 | \u5c0f\u8587   | \u5973     |        1 |\n|   2 | \u5c0f\u96ea   | \u5973     |        1 |\n|   3 | \u5c0f\u660e   | \u7537     |        2 |\n+-----+--------+--------+----------+\n3 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/6db_sql_ops3/#3-3","title":"3-3 \u521b\u5efa\u8001\u5e08\u8868","text":"<pre><code>mysql&gt; create table tea(\ntid int auto_increment primary key,\ntname varchar(32) not null default ''\n)charset=utf8;\n\nmysql&gt; insert into tea (tname) values ('qfedu'),('Frank'),('Julie');\n\nmysql&gt; select * from tea;\n+-----+-------+\n| tid | tname |\n+-----+-------+\n|   1 | qfedu |\n|   2 | Frank |\n|   3 | Julie |\n+-----+-------+\n3 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/6db_sql_ops3/#3-4","title":"3-4 \u521b\u5efa\u8bfe\u7a0b\u8868","text":"<pre><code>mysql&gt; create table cour(\ncid int auto_increment primary key,\ncname varchar(32) not null default '',\ntea_id int not null default 1,\nconstraint fk_cour_tea foreign key (tea_id) references tea(tid)\n)charset=utf8;\n\nmysql&gt; insert into cour(cname, tea_id) values ('\u751f\u7269',1),('\u4f53\u80b2',1),('\u7269\u7406',2);\n\nmysql&gt; select * from cour;\n+-----+--------+--------+\n| cid | cname | tea_id |\n+-----+--------+--------+\n|   1 | \u751f\u7269   |      1 |\n|   2 | \u4f53\u80b2   |      1 |\n|   3 | \u7269\u7406   |      2 |\n+-----+--------+--------+\n3 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/6db_sql_ops3/#3-5","title":"3-5 \u6210\u7ee9\u8868","text":"<pre><code>mysql&gt; create table sco(\nsid int auto_increment primary key,\nstu_id int not null default 1,\ncou_id int not null default 1,\nnumber int not null default 0,\nconstraint fk_sco_stu foreign key (stu_id) references stu(sid),\nconstraint fk_sco_cour foreign key (cou_id) references cour(cid)\n)charset utf8;\n\nmysql&gt; insert into sco (stu_id, cou_id, number) values (1,1,60),(1,2,59), (2,2,100);\n\nmysql&gt; select * from sco;\n+-----+--------+--------+--------+\n| sid | stu_id | cou_id | number |\n+-----+--------+--------+--------+\n|   1 |      1 |      1 |     60 |\n|   2 |      1 |      2 |     59 |\n|   3 |      2 |      2 |    100 |\n+-----+--------+--------+--------+\n3 rows in set (0.00 sec)\n</code></pre> <p>3-6 \u67e5\u8be2\u6240\u6709\u5927\u4e8e60\u5206\u7684\u5b66\u751f\u7684\u59d3\u540d\u548c\u5b66\u53f7 (DISTINCT: \u53bb\u91cd)</p> <pre><code>mysql&gt; select distinct stu.sid,stu.sname from sco left join stu on\nstu.sid=stu_id where number&gt;=60;\n+------+--------+\n| sid | sname |\n+------+--------+\n|    1 | \u5c0f\u8587   |\n|    2 | \u5c0f\u96ea   |\n+------+--------+\n2 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/7db_type/","title":"\u7b2c\u4e03\u8282 MySQL \u6570\u636e\u7c7b\u578b\u7ea6\u675f","text":"<p>\u7ea6\u675f\u662f\u4e00\u79cd\u9650\u5236\uff0c\u5b83\u901a\u8fc7\u5bf9\u8868\u7684\u884c\u6216\u8005\u5217\u7684\u6570\u636e\u505a\u51fa\u9650\u5236\uff0c\u6765\u786e\u4fdd\u8868\u6570\u636e\u7684\u5b8c\u6574\u6027\u548c\u552f\u4e00\u6027. \u5728 mysql\u5f53\u4e2d\u4e00\u822c\u6709\u4e00\u4e0b\u8fd9\u51e0\u79cd\u7ea6\u675f</p> <p></p>"},{"location":"db_ops/7db_type/#1","title":"1\u3001\u975e\u7a7a\u7ea6\u675f","text":"<p>\u5c31\u662f\u9650\u5236\u6570\u636e\u5e93\u4e2d\u67d0\u4e2a\u503c\u662f\u5426\u53ef\u4ee5\u4e3a\u7a7a\uff0cnull\u5b57\u6bb5\u503c\u53ef\u4ee5\u4e3a\u7a7a\uff0cnot null\u5b57\u6bb5\u503c\u4e0d\u80fd\u4e3a\u7a7a</p> <pre><code>mysql&gt; create table testnull(id int, username varchar(20) not null);  # \u521b\u5efatestnull \u8bbe\u7f6e username \u5b57\u6bb5\u4e3a\u975e\u7a7a\u7ea6\u675f notnull\nQuery OK, 0 rows affected (0.00 sec)\n\n\nmysql&gt; insert into testnull(id,username) values(1,'qfedu');      # \u63d2\u51652\u4e2a\u6570\u636e2\u4e2a\u5b57\u6bb5\nQuery OK, 1 row affected (0.01 sec)\n\n\nmysql&gt; insert into testnull (id) values(2); # \u6ca1\u6709\u63d2\u5165 username \u5b57\u6bb5\u62a5\u9519\uff0cusername \u5fc5\u987b\u6709\u4e00\u4e2a\u9ed8\u8ba4\u503c\nERROR 1364 (HY000): Field 'username' doesn't have a default value\n\n\nmysql&gt; desc testnull;\n+----------+-------------+------+-----+---------+-------+\n| Field   | Type       | Null | Key | Default | Extra |\n+----------+-------------+------+-----+---------+-------+\n| id       | int(11)     | YES |     | NULL   |       |\n| username | varchar(20) | NO   |     | NULL   |       |\n+----------+-------------+------+-----+---------+-------+\n2 rows in set (0.00 sec)\n\n</code></pre> <p>\u6ce8\u610f\uff1a\u5982\u679c\u7ea6\u675f\u4e0d\u751f\u6548\u53ef\u4ee5\u5148\u8bbe\u7f6e\u4e00\u4e0b<code>sql_mode</code></p> <pre><code>mysql&gt; set session sql_mode='STRICT_TRANS_TABLES';\n</code></pre>"},{"location":"db_ops/7db_type/#2","title":"2\u3001\u552f\u4e00\u7ea6\u675f","text":"<p>\u5b57\u6bb5\u6dfb\u52a0\u552f\u4e00\u7ea6\u675f\u4e4b\u540e\uff0c\u8be5\u5b57\u6bb5\u7684\u503c\u4e0d\u80fd\u91cd\u590d\uff0c\u4e5f\u5c31\u662f\u8bf4\u5728\u4e00\u5217\u5f53\u4e2d\u4e0d\u80fd\u51fa\u73b0\u4e00\u6837\u7684\u503c</p>"},{"location":"db_ops/7db_type/#2-1","title":"2-1 \u6dfb\u52a0\u552f\u4e00\u7ea6\u675f","text":"<pre><code># \u6dfb\u52a0\u552f\u4e00\u7ea6\u675f\nALTER TABLE tbl_name ADD [CONSTRAINT[symbol]]\nUNIQUE [INDEX|KEY] [index_name] [index_type] (index_col_name)\n</code></pre>"},{"location":"db_ops/7db_type/#2-1_1","title":"2-1 \u5220\u9664\u552f\u4e00\u7ea6\u675f","text":"<pre><code># \u5220\u9664\u552f\u4e00\u7ea6\u675f\nALTERT TABLE tbl_name DROP {INDEX|KEY} index_name\n</code></pre> <p>\u5df2\u7ecf\u6dfb\u52a0\u7684\u503c\u4e0d\u80fd\u518d\u91cd\u590d\u7684\u63d2\u5165</p> <pre><code>mysql&gt; select * from testnull;  # \u67e5\u8be2\u8868\u91cc\u9762\u7684\u6570\u636e\n+------+----------+\n| id   | username |\n+------+----------+\n|    1 | qfedu   |\n+------+----------+\n1 row in set (0.00 sec)\n\n\nmysql&gt; alter table testnull add unique(id);   # \u8bbe\u7f6e id \u5b57\u6bb5\u6dfb\u52a0\u4e00\u4e2a\u552f\u4e00\u7ea6\u675f unique\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0 Duplicates: 0  Warnings: 0\n\nmysql&gt; insert into testnull(id,username) values(1,'qfedu1');  # \u63d2\u5165\u4e00\u4e2a\u503c\uff081\uff09\u7ed9 id \u62a5\u9519\uff0c\u63d0\u793a\u4e0d\u80fd\u91cd\u590d\u503c\nERROR 1062 (23000): Duplicate entry '1' for key 'id'\n</code></pre>"},{"location":"db_ops/7db_type/#3","title":"3\u3001\u4e3b\u952e\u7ea6\u675f","text":"<ul> <li>\u4e3b\u952e\u4fdd\u8bc1\u8bb0\u5f55\u7684\u552f\u4e00\u6027\uff0c\u4e3b\u952e\u81ea\u52a8\u4e3a<code>NOT NULL</code></li> <li>\u6bcf\u5f20\u6570\u636e\u8868\u53ea\u80fd\u5b58\u5728\u4e00\u4e2a\u4e3b\u952e <code>NOT NULL + UNIQUE KEY</code> \u4e00\u4e2a<code>UNIQUE KEY</code></li> <li>\u4e00\u4e2a<code>NOT NULL</code>\u7684\u65f6\u5019\uff0c\u90a3\u4e48\u5b83\u88ab\u5f53\u505a<code>PRIMARY KEY</code>\u4e3b\u952e</li> <li>\u5f53\u4e00\u5f20\u8868\u91cc\u6ca1\u6709\u4e00\u4e2a\u4e3b\u952e\u7684\u65f6\u5019\uff0c\u7b2c\u4e00\u4e2a\u51fa\u73b0\u7684\u975e\u7a7a\u4e14\u4e3a\u552f\u4e00\u7684\u5217\u88ab\u89c6\u4e3a\u6709\u4e3b\u952e\u3002</li> </ul> <pre><code># \u6dfb\u52a0\u4e3b\u952e\u7ea6\u675f\nALTER TABLE tbl_name ADD [CONSTRAINT[sysbol]]\nPRIMARY KEY [index_type] (index_col_name)\n\n# \u5220\u9664\u4e3b\u952e\u7ea6\u675f\nALTER TABLE tbl_name DROP PRIMARY KEY\n</code></pre> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; create table user(id int primary key, name varchar(20),number int);\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql&gt; desc user;\n+--------+-------------+------+-----+---------+-------+\n| Field | Type       | Null | Key | Default | Extra |\n+--------+-------------+------+-----+---------+-------+\n| id     | int(11)     | NO   | PRI | NULL   |       |\n| name   | varchar(20) | YES |     | NULL   |       |\n| number | int(11)     | YES |     | NULL   |       |\n+--------+-------------+------+-----+---------+-------+\n3 rows in set (0.00 sec)\n\nmysql&gt; insert into user(id,name,number) values(1,'1',1);\nQuery OK, 1 row affected (0.00 sec)\n\nmysql&gt; select * from user;\n+----+------+--------+\n| id | name | number |\n+----+------+--------+\n|  1 | 1   |      1 |\n+----+------+--------+\n1 row in set (0.00 sec)\n\nmysql&gt; insert into user(id,name,number) values(1,'1',1);\nERROR 1062 (23000): Duplicate entry '1' for key 'PRIMARY'\n\nmysql&gt; insert into user(id,name,number) values(1,'2',2);\nERROR 1062 (23000): Duplicate entry '1' for key 'PRIMARY'\n\nmysql&gt; insert into user(id,name,number) values(2,'2',2);\nQuery OK, 1 row affected (0.00 sec)\n\nmysql&gt; select * from user;\n+----+------+--------+\n| id | name | number |\n+----+------+--------+\n|  1 | 1   |      1 |\n|  2 | 2   |      2 |\n+----+------+--------+\n2 rows in set (0.00 sec)\n\nmysql&gt; insert into user(id,name,number) values(0,'3',3);\nQuery OK, 1 row affected (0.01 sec)\n\nmysql&gt; select * from user;\n+----+------+--------+\n| id | name | number |\n+----+------+--------+\n|  0 | 3   |      3 |\n|  1 | 1   |      1 |\n|  2 | 2   |      2 |\n+----+------+--------+\n3 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/7db_type/#4","title":"4\u3001\u81ea\u589e\u957f","text":"<p>\u81ea\u589e\u957f <code>AUTO_INCREMENT</code> \u81ea\u52a8\u7f16\u53f7\uff0c\u4e14\u5fc5\u987b\u4e0e\u4e3b\u952e\u7ec4\u5408\u4f7f\u7528 \u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8d77\u59cb\u503c\u4e3a1\uff0c\u6bcf\u6b21\u7684 \u589e\u91cf\u4e3a1\u3002\u5f53\u63d2\u5165\u8bb0\u5f55\u65f6\uff0c\u5982\u679c\u4e3a<code>AUTO_INCREMENT</code>\u6570\u636e\u5217\u660e\u786e\u6307\u5b9a\u4e86\u4e00\u4e2a\u6570\u503c\uff0c\u5219\u4f1a\u51fa\u73b0\u4e24\u79cd \u60c5\u51b5\uff1a</p> <p>\u5982\u679c\u63d2\u5165\u7684\u503c\u4e0e\u5df2\u6709\u7684\u7f16\u53f7\u91cd\u590d\uff0c\u5219\u4f1a\u51fa\u73b0\u51fa\u9519\u4fe1\u606f\uff0c\u56e0\u4e3a<code>AUTO_INCREMENT</code>\u6570\u636e\u5217\u7684\u503c\u5fc5\u987b\u662f \u552f\u4e00\u7684\uff1b</p> <p>\u5982\u679c\u63d2\u5165\u7684\u503c\u5927\u4e8e\u5df2\u7f16\u53f7\u7684\u503c\uff0c\u5219\u4f1a\u628a\u8be5\u63d2\u5165\u5230\u6570\u636e\u5217\u4e2d\uff0c\u5e76\u4f7f\u5728\u4e0b\u4e00\u4e2a\u7f16\u53f7\u5c06\u4ece\u8fd9\u4e2a\u65b0\u503c\u5f00\u59cb\u9012 \u589e\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u53ef\u4ee5\u8df3\u8fc7\u4e00\u4e9b\u7f16\u53f7\u3002\u5982\u679c\u81ea\u589e\u5e8f\u5217\u7684\u6700\u5927\u503c\u88ab\u5220\u9664\u4e86\uff0c\u5219\u5728\u63d2\u5165\u65b0\u8bb0\u5f55\u65f6\uff0c\u8be5\u503c\u88ab \u91cd\u7528\u3002</p>"},{"location":"db_ops/7db_type/#4-1","title":"4-1 \u6dfb\u52a0\u81ea\u589e\u957f","text":"<pre><code>mysql&gt; ALTER TABLE user CHANGE id id INT NOT NULL AUTO_INCREMENT;\nQuery OK, 0 rows affected (0.01 sec)\nRecords: 0 Duplicates: 0  Warnings: 0\n\nmysql&gt; DESCRIBE user;\n+--------+-------------+------+-----+---------+----------------+\n| Field | Type       | Null | Key | Default | Extra         |\n+--------+-------------+------+-----+---------+----------------+\n| id     | int(11)     | NO   | PRI | NULL   | auto_increment |\n| name   | varchar(20) | YES |     | NULL   |               |\n| number | int(11)     | YES |     | NULL   |               |\n+--------+-------------+------+-----+---------+----------------+\n3 rows in set (0.00 sec)\n\nmysql&gt; SELECT * FROM user;\nEmpty set (0.00 sec\n</code></pre>"},{"location":"db_ops/7db_type/#4-2","title":"4-2 \u63d2\u5165\u503c","text":"<pre><code>mysql&gt; INSERT INTO user(name, number) VALUES('take',2), ('which',4);\nQuery OK, 2 rows affected (0.00 sec)\nRecords: 2 Duplicates: 0  Warnings: 0\n\nmysql&gt; SELECT * FROM `user`;\n+----+-------+--------+\n| id | name | number |\n+----+-------+--------+\n|  1 | take |      2 |\n|  2 | which |      4 |\n+----+-------+--------+\n2 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/7db_type/#4-3","title":"4-3 \u5220\u9664\u81ea\u589e\u957f","text":"<pre><code>mysql&gt; ALTER TABLE user CHANGE id id INT NOT NULL;\nQuery OK, 2 rows affected (0.01 sec)\nRecords: 2 Duplicates: 0  Warnings: 0\n\nmysql&gt; DESCRIBE user;\n+--------+-------------+------+-----+---------+-------+\n| Field | Type       | Null | Key | Default | Extra |\n+--------+-------------+------+-----+---------+-------+\n| id     | int(11)     | NO   | PRI | NULL   |       |\n| name   | varchar(20) | YES |     | NULL   |       |\n| number | int(11)     | YES |     | NULL   |       |\n+--------+-------------+------+-----+---------+-------+\n3 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/7db_type/#5","title":"5\u3001\u9ed8\u8ba4\u7ea6\u675f","text":""},{"location":"db_ops/7db_type/#5-1","title":"5-1 \u6dfb\u52a0/\u5220\u9664\u9ed8\u8ba4\u7ea6\u675f","text":"<pre><code>ALTER TABLE tbl_name ALTER [COLUMN] col_name {SET DEFAULT literal | DROP DEFAULT}\n</code></pre>"},{"location":"db_ops/7db_type/#5-2","title":"5-2 \u8bbe\u7f6e\u9ed8\u8ba4\u503c","text":"<pre><code>mysql&gt; ALTER TABLE user ALTER number SET DEFAULT 0;\nQuery OK, 0 rows affected (0.00 sec)\nRecords: 0 Duplicates: 0  Warnings: 0\n\nmysql&gt; DESCRIBE user;\n+--------+-------------+------+-----+---------+-------+\n| Field | Type       | Null | Key | Default | Extra |\n+--------+-------------+------+-----+---------+-------+\n| id     | int(11)     | NO   | PRI | NULL   |       |\n| name   | varchar(20) | YES |     | NULL   |       |\n| number | int(11)     | YES |     | 0       |       |\n+--------+-------------+------+-----+---------+-------+\n3 rows in set (0.00 sec\n</code></pre>"},{"location":"db_ops/7db_type/#5-3","title":"5-3 \u63d2\u5165\u503c","text":"<pre><code>mysql&gt; ALTER TABLE user CHANGE id id INT NOT NULL AUTO_INCREMENT;\nQuery OK, 2 rows affected (0.01 sec)\nRecords: 2 Duplicates: 0  Warnings: 0\n\nmysql&gt; INSERT INTO user(name) VALUES('rock');\nQuery OK, 1 row affected (0.00 sec)\n\nmysql&gt; INSERT INTO user(name) VALUES('rock');\nQuery OK, 1 row affected (0.01 sec)\n\nmysql&gt; SELECT * FROM user;\n+----+-------+--------+\n| id | name | number |\n+----+-------+--------+\n|  1 | take |      2 |\n|  2 | which |      4 |\n|  3 | rock |      0 |\n|  4 | rock |      0 |\n+----+-------+--------+\n4 rows in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/7db_type/#6","title":"6\u3001\u5916\u952e\u7ea6\u675f","text":"<p>\u5916\u952e\u7ea6\u675f\u8981\u6c42\u6570\u636e\u8868\u7684\u5b58\u50a8\u5f15\u64ce\u53ea\u80fd\u4e3a InnoDB</p> <p>\u67e5\u770b\u5f53\u524dmysql\u670d\u52a1\u5668\u652f\u6301\u7684\u5b58\u50a8\u5f15\u64ce</p> <pre><code>mysql&gt; SHOW ENGINES;\n</code></pre>"},{"location":"db_ops/7db_type/#6-1","title":"6-1 \u7f16\u8f91\u6570\u636e\u8868\u7684\u9ed8\u8ba4\u5b58\u50a8\u5f15\u64ce","text":"<pre><code>[root@qfedu.com ~]# vim /etc/my.cnf\n[mysqld]\ndatadir=/var/lib/mysql\nsocket=/var/lib/mysql/mysql.sock\ncharacter-set-server=utf8mb4\ndefault-storage-engine=INNODB\n[root@qfedu.com ~]# systemctl restart mysqld\n</code></pre> <pre><code>mysql&gt; create table teacher(id int primary key auto_increment, name varchar(20)\nnot null);   # \u521b\u5efa\u8001\u5e08\u8868\n\nQuery OK, 0 rows affected (0.00 sec)\n\nmysql&gt; create table students(id int primary key auto_increment, name varchar(20)\nnot null,teacher_id int,foreign key(teacher_id) references teacher(id));  # \u521b\u5efa\u5b66\u751f\u8868\nQuery OK, 0 rows affected (0.01 sec)\n\nmysql&gt; insert into teacher(id,name) values(1,'qfedu');\nQuery OK, 1 row affected (0.00 sec)\n\nmysql&gt; insert into students(id,name,teacher_id) values(1,'qfedu',1);     # \u63d2\u5165\u8001\u5e08\u8868\u4e2did\u6765\u5173\u8054\nQuery OK, 1 row affected (0.00 sec)\n\nmysql&gt; select * from students;\n+----+-------+------------+\n| id | name | teacher_id |\n+----+-------+------------+\n|  1 | qfedu |          1 |\n+----+-------+------------+\n1 row in set (0.00 sec)\n\nmysql&gt; select * from teacher;\n+----+-------+\n| id | name |\n+----+-------+\n|  1 | qfedu |\n+----+-------+\n1 row in set (0.00 sec)\n</code></pre>"},{"location":"db_ops/8db_index/","title":"\u7b2c\u516b\u8282 MySQL \u7d22\u5f15","text":"<p>\u7d22\u5f15\u4f5c\u4e3a\u4e00\u79cd\u6570\u636e\u7ed3\u6784\uff0c\u5176\u7528\u9014\u662f\u7528\u4e8e\u63d0\u5347\u68c0\u7d22\u6570\u636e\u7684\u6548\u7387\u3002</p>"},{"location":"db_ops/8db_index/#1mysql","title":"1\u3001MySQL \u7d22\u5f15\u7684\u5206\u7c7b","text":"<ul> <li>\u666e\u901a\u7d22\u5f15\uff08INDEX\uff09\uff1a\u7d22\u5f15\u5217\u503c\u53ef\u91cd\u590d</li> <li>\u552f\u4e00\u7d22\u5f15\uff08UNIQUE\uff09\uff1a\u7d22\u5f15\u5217\u503c\u5fc5\u987b\u552f\u4e00\uff0c\u53ef\u4ee5\u4e3aNULL</li> <li>\u4e3b\u952e\u7d22\u5f15\uff08PRIMARY KEY\uff09\uff1a\u7d22\u5f15\u5217\u503c\u5fc5\u987b\u552f\u4e00\uff0c\u4e0d\u80fd\u4e3aNULL\uff0c\u4e00\u4e2a\u8868\u53ea\u80fd\u6709\u4e00\u4e2a\u4e3b\u952e\u7d22\u5f15</li> <li>\u5168\u6587\u7d22\u5f15\uff08FULL TEXT\uff09\uff1a\u7ed9\u6bcf\u4e2a\u5b57\u6bb5\u521b\u5efa\u7d22\u5f15</li> </ul>"},{"location":"db_ops/8db_index/#2mysql","title":"2\u3001MySQL \u4e0d\u540c\u7c7b\u578b\u7d22\u5f15\u7528\u9014\u548c\u533a\u522b","text":"<p>\u666e\u901a\u7d22\u5f15\u5e38\u7528\u4e8e\u8fc7\u6ee4\u6570\u636e\u3002\u4f8b\u5982\uff0c\u4ee5\u5546\u54c1\u79cd\u7c7b\u4f5c\u4e3a\u7d22\u5f15\uff0c\u68c0\u7d22\u79cd\u7c7b\u4e3a\u201c\u624b\u673a\u201d\u7684\u5546\u54c1\u3002</p> <p>\u552f\u4e00\u7d22\u5f15\u4e3b\u8981\u7528\u4e8e\u6807\u8bc6\u4e00\u5217\u6570\u636e\u4e0d\u5141\u8bb8\u91cd\u590d\u7684\u7279\u6027\uff0c\u76f8\u6bd4\u4e3b\u952e\u7d22\u5f15\u4e0d\u5e38\u7528\u4e8e\u68c0\u7d22\u7684\u573a\u666f\u3002</p> <p>\u4e3b\u952e\u7d22\u5f15\u662f\u884c\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u56e0\u800c\u5176\u4e3b\u8981\u7528\u9014\u662f\u68c0\u7d22\u7279\u5b9a\u6570\u636e\u3002</p> <p>\u5168\u6587\u7d22\u5f15\u6548\u7387\u4f4e\uff0c\u5e38\u7528\u4e8e\u6587\u672c\u4e2d\u5185\u5bb9\u7684\u68c0\u7d22\u3002</p>"},{"location":"db_ops/8db_index/#3mysql","title":"3\u3001MySQL \u4f7f\u7528\u7d22\u5f15","text":""},{"location":"db_ops/8db_index/#3-1","title":"3-1 \u521b\u5efa\u7d22\u5f15","text":"<p>\u666e\u901a\u7d22\u5f15\uff08INDEX\uff09</p> <pre><code># \u5728\u521b\u5efa\u8868\u65f6\u6307\u5b9a\nmysql&gt; CREATE TABLE student (\n   id INT NOT NULL,\n   name VARCHAR(100) NOT NULL,\n   birthday DATE,\n   sex CHAR(1) NOT NULL,\n    INDEX nameIndex (name(50))\n);\n\n# \u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa\nmysql&gt; CREATE INDEX nameIndex ON student(name(50));\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u521b\u5efa\nmysql&gt; ALTER TABLE student ADD INDEX nameIndex(name(50));\n</code></pre> <ul> <li>\u5728\u521b\u5efa\u8868\u65f6\u6307\u5b9a\uff1a <code>INDEX nameIndex (name(50))</code></li> <li>\u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa\uff1a <code>CREATE INDEX nameIndex ON student(name(50));</code></li> <li>\u4fee\u6539\u8868\u7ed3\u6784\u521b\u5efa:  <code>ALTER TABLE student ADD INDEX nameIndex(name(50));</code></li> </ul>"},{"location":"db_ops/8db_index/#3-2-unique","title":"3-2 \u552f\u4e00\u7d22\u5f15\uff08UNIQUE\uff09","text":"<pre><code># \u5728\u521b\u5efa\u8868\u65f6\u6307\u5b9a\nmysql&gt; CREATE TABLE student (\n   id INT NOT NULL,\n   name VARCHAR(100) NOT NULL,\n   birthday DATE,\n   sex CHAR(1) NOT NULL,\n    UNIQUE idIndex (id)\n);\n\n# \u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa\nmysql&gt; CREATE UNIQUE INDEX idIndex ON student(id)\n</code></pre> <ul> <li><code>UNIQUE idIndex (id)</code></li> <li>\u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa: <code>CREATE UNIQUE INDEX idIndex ON student(id)</code></li> </ul>"},{"location":"db_ops/8db_index/#3-3-primary-key","title":"3-3 \u4e3b\u952e\u7d22\u5f15\uff08PRIMARY KEY\uff09","text":"<pre><code># \u521b\u5efa\u8868\u65f6\u65f6\u6307\u5b9a\nmysql&gt; CREATE TABLE student (\n   id INT,\n   name VARCHAR(100) NOT NULL,\n   birthday DATE,\n   sex CHAR(1) NOT NULL,\n    PRIMARY KEY (id)\n);\n\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u521b\u5efa\nmysql&gt; ALTER TABLE student ADD PRIMARY KEY (id):\n</code></pre> <p>\u4e3b\u952e\u7d22\u5f15\u4e0d\u80fd\u4f7f\u7528\u57fa\u4e8e\u8868\u7ed3\u6784\u521b\u5efa\u7684\u65b9\u5f0f\u521b\u5efa\u3002</p>"},{"location":"db_ops/8db_index/#3-4","title":"3-4 \u5220\u9664\u7d22\u5f15","text":"<p>\u666e\u901a\u7d22\u5f15\uff08INDEX\uff09</p> <pre><code># \u76f4\u63a5\u5220\u9664\nmysql&gt; DROP INDEX nameIndex ON student;\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u5220\u9664\nmysql&gt; ALTER TABLE student DROP INDEX nameIndex;\n</code></pre> <p>\u552f\u4e00\u7d22\u5f15\uff08UNIQUE\uff09</p> <pre><code># \u76f4\u63a5\u5220\u9664\nmysql&gt; DROP INDEX idIndex ON student;\n\n# \u4fee\u6539\u8868\u7ed3\u6784\u5220\u9664\nmysql&gt; ALTER TABLE student DROP INDEX idIndex;\n</code></pre> <p>\u4e3b\u952e\u7d22\u5f15\uff08PRIMARY KEY\uff09</p> <pre><code>mysql&gt; ALTER TABLE student DROP PRIMARY KEY;\n</code></pre> <p>\u4e3b\u952e\u4e0d\u80fd\u91c7\u7528\u76f4\u63a5\u5220\u9664\u7684\u65b9\u5f0f\u5220\u9664\u3002</p>"},{"location":"db_ops/8db_index/#3-5","title":"3-5 \u67e5\u770b\u7d22\u5f15","text":"<pre><code>mysql&gt; SHOW INDEX FROM student;\n</code></pre>"},{"location":"db_ops/8db_index/#4","title":"4\u3001\u9009\u62e9\u7d22\u5f15\u7684\u539f\u5219","text":"<p>\u5e38\u7528\u4e8e\u67e5\u8be2\u6761\u4ef6\u7684\u5b57\u6bb5\u8f83\u9002\u5408\u4f5c\u4e3a\u7d22\u5f15\uff0c\u4f8b\u5982WHERE\u8bed\u53e5\u548cJOIN\u8bed\u53e5\u4e2d\u51fa\u73b0\u7684\u5217\uff1b</p> <p>\u552f\u4e00\u6027\u592a\u5dee\u7684\u5b57\u6bb5\u4e0d\u9002\u5408\u4f5c\u4e3a\u7d22\u5f15\uff0c\u4f8b\u5982\u6027\u522b\uff1b</p> <p>\u66f4\u65b0\u8fc7\u4e8e\u9891\u7e41\uff08\u66f4\u65b0\u9891\u7387\u8fdc\u9ad8\u4e8e\u68c0\u7d22\u9891\u7387\uff09\u7684\u5b57\u6bb5\u4e0d\u9002\u5408\u4f5c\u4e3a\u7d22\u5f15\uff1b</p> <p>\u4f7f\u7528\u7d22\u5f15\u7684\u597d\u5904\u662f\u7d22\u5f15\u901a\u8fc7\u4e00\u5b9a\u7684\u7b97\u6cd5\u5efa\u7acb\u4e86\u7d22\u5f15\u503c\u4e0e\u5217\u503c\u76f4\u63a5\u7684\u8054\u7cfb\uff0c\u53ef\u4ee5\u901a\u8fc7\u7d22\u5f15\u76f4\u63a5\u83b7\u53d6\u5bf9 \u5e94\u7684\u884c\u6570\u636e\uff0c\u800c\u65e0\u9700\u8fdb\u884c\u5168\u8868\u641c\u7d22\uff0c\u56e0\u800c\u52a0\u5feb\u4e86\u68c0\u7d22\u901f\u5ea6\uff1b</p> <p>\u4f46\u7531\u4e8e\u7d22\u5f15\u4e5f\u662f\u4e00\u79cd\u6570\u636e\u7ed3\u6784\uff0c\u5b83\u9700\u8981\u5360\u636e\u989d\u5916\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5e76\u4e14\u8bfb\u53d6\u7d22\u5f15\u4e5f\u52a0\u4f1a\u5927IO\u8d44\u6e90\u7684\u6d88\u8017\uff0c\u56e0\u800c\u7d22\u5f15\u5e76\u975e\u8d8a\u591a\u8d8a\u597d\uff0c\u4e14\u5bf9\u8fc7\u5c0f\u7684\u8868\u4e5f\u6ca1\u6709\u6dfb\u52a0\u7d22\u5f15\u7684\u5fc5\u8981\u3002</p>"},{"location":"db_ops/9db_mgt/","title":"\u7b2c\u4e5d\u8282 MySQL \u7684\u7528\u6237\u7ba1\u7406\u548c\u6743\u9650\u7ba1\u7406","text":""},{"location":"db_ops/9db_mgt/#1dcl","title":"1\u3001DCL\uff08\u6570\u636e\u5e93\u63a7\u5236\u8bed\u8a00\uff09","text":"<p>\u6570\u636e\u5e93\u6388\u6743\u3001\u89d2\u8272\u63a7\u5236\u7b49\u64cd\u4f5c</p> <ul> <li><code>GRANT</code> \u7528\u6237\u6388\u6743\uff0c\u4e3a\u7528\u6237\u8d4b\u4e88\u8bbf\u95ee\u6743\u9650</li> <li><code>REVOKE</code> \u53d6\u6d88\u6388\u6743\uff0c\u64a4\u56de\u6388\u6743\u6743\u9650</li> </ul>"},{"location":"db_ops/9db_mgt/#2mysql","title":"2\u3001MySQL \u6743\u9650\u8868","text":""},{"location":"db_ops/9db_mgt/#2-1-mysqluser","title":"2-1 <code>mysql.user</code>","text":"<ul> <li>\u7528\u6237\u5b57\u6bb5\uff1aHost\u3001User\u3001Password</li> <li>\u6743\u9650\u5b57\u6bb5\uff1a<code>_Priv</code>\u7ed3\u5c3e\u7684\u5b57\u6bb5</li> <li>\u5b89\u5168\u5b57\u6bb5\uff1a<code>ssl x509</code>\u5b57\u6bb5</li> <li>\u8d44\u6e90\u63a7\u5236\u5b57\u6bb5\uff1a<code>max_</code>\u5f00\u5934\u7684\u5b57\u6bb5</li> </ul>"},{"location":"db_ops/9db_mgt/#2-2-mysqldb","title":"2-2 mysql.db","text":"<ul> <li>\u7528\u6237\u5b57\u6bb5\uff1aHost\u3001User\u3001Password</li> <li>\u6743\u9650\u5b57\u6bb5\uff1a\u5269\u4e0b\u7684<code>_Priv</code>\u7ed3\u5c3e\u7684\u5b57\u6bb5 </li> </ul>"},{"location":"db_ops/9db_mgt/#2-3-mysqltables_privmysqlcolumns_privprocs_priv","title":"2-3 <code>mysql.tables_priv</code>\uff0c<code>mysql.columns_priv</code>\u3001<code>procs_priv</code>","text":"<p>\u8868\u3001\u5217\u3001\u5b58\u50a8\u8fc7\u7a0b\u7684\u6388\u6743\u8868</p>"},{"location":"db_ops/9db_mgt/#2-4","title":"2-4 \u6388\u6743\u7ea7\u522b\u6392\u5217","text":"<ul> <li><code>mysql.user</code> #\u5168\u5c40\u6388\u6743</li> <li><code>mysql.db</code> #\u6570\u636e\u5e93\u7ea7\u522b\u6388\u6743</li> <li>\u5176\u4ed6 #\u8868\u7ea7\uff0c\u5217\u7ea7\u6388\u6743</li> </ul>"},{"location":"db_ops/9db_mgt/#2-5","title":"2-5 \u6570\u636e\u5e93\u548c\u8868\u683c\u5f0f","text":"<ul> <li>\u6570\u636e\u5e93\u540d.* \u6570\u636e\u5e93\u4e2d\u7684\u6240\u6709</li> <li>\u6570\u636e\u5e93\u540d.\u8868\u540d \u6307\u5b9a\u6570\u636e\u5e93\u4e2d\u7684\u67d0\u5f20\u8868</li> <li>\u6570\u636e\u5e93\u540d.\u5b58\u50a8\u8fc7\u7a0b \u6307\u5b9a\u6570\u636e\u5e93\u4e2d\u7684\u5b58\u50a8\u8fc7\u7a0b</li> <li><code>*.*</code>\u6240\u6709\u6570\u636e\u5e93</li> </ul>"},{"location":"db_ops/9db_mgt/#2-6-ip","title":"2-6 \u7528\u6237\u548c IP\u683c\u5f0f","text":"<ul> <li>\u7528\u6237\u540d@IP\u5730\u5740 \u7528\u6237\u53ea\u80fd\u5728\u6539IP\u4e0b\u624d\u80fd\u8bbf\u95ee</li> <li>\u7528\u6237\u540d@192.168.1.%   \u7528\u6237\u53ea\u80fd\u5728\u6539IP\u6bb5\u4e0b\u624d\u80fd\u8bbf\u95ee(\u901a\u914d\u7b26%\u8868\u793a\u4efb\u610f)</li> <li>\u7528\u6237\u540d@%.qfedu.com</li> <li>\u7528\u6237\u540d@% \u7528\u6237\u53ef\u4ee5\u518d\u4efb\u610fIP\u4e0b\u8bbf\u95ee(\u9ed8\u8ba4IP\u5730\u5740\u4e3a%)</li> </ul>"},{"location":"db_ops/9db_mgt/#3mysql","title":"3\u3001MySQL \u7528\u6237\u7ba1\u7406","text":""},{"location":"db_ops/9db_mgt/#3-1","title":"3-1 \u521b\u5efa\u7528\u6237","text":"<p><code>CREATE USER</code>\u8bed\u53e5\u521b\u5efa</p> <pre><code>CREATE USER '\u7528\u6237\u540d'@'IP\u5730\u5740' [ IDENTIFIED BY '\u5bc6\u7801' ]\uff1b\n</code></pre> <p>GRANT\u8bed\u53e5\u521b\u5efa</p> <pre><code>GRANT SELECT ON *.* TO '\u7528\u6237\u540d'@\u2019IP\u5730\u5740\u2019 IDENTIFIED BY \"\u5bc6\u7801\"\uff1b\n</code></pre> <p>\u521b\u5efa\u5b9e\u4f8b</p> <pre><code>CREATE USER 'qfedu'@'localhost' IDENTIFIED BY '123456';\nCREATE USER 'qfedu'@'192.168.1.101' IDENDIFIED BY '123456';\nCREATE USER 'qfedu'@'192.168.1.%' IDENDIFIED BY '123456';\nCREATE USER 'qfedu'@'%' IDENTIFIED BY '123456';\nGRANT ALL ON *.* TO 'user3'@\u2019localhost\u2019 IDENTIFIED BY \u2018123456\u2019;\n</code></pre>"},{"location":"db_ops/9db_mgt/#3-2","title":"3-2 \u5220\u9664\u7528\u6237","text":"<p>DROP USER \u5220\u9664</p> <pre><code>DROP USER \u5220\u9664\n</code></pre> <pre><code>DROP USER 'user1'@\u2019localhost\u2019;\n</code></pre> <p>DELETE \u8bed\u53e5\u5220\u9664</p> <pre><code>DELETE FROM mysql.user WHERE user='\u7528\u6237\u540d' AND host='IP\u5730\u5740'\n</code></pre> <pre><code>DELETE FROM mysql.user WHERE user=\u2019user2\u2019 AND host=\u2019localhost\u2019;\n</code></pre>"},{"location":"db_ops/9db_mgt/#3-3","title":"3-3 \u4fee\u6539\u7528\u6237","text":"<pre><code>RENAME USER '\u65e7\u7528\u6237\u540d'@'IP\u5730\u5740' TO '\u65b0\u7528\u6237\u540d'@'IP\u5730\u5740' ;\n</code></pre> <pre><code>RENAME USER 'old_user'@\u2018localhost\u2019 TO 'new_user'@'localhost';\n</code></pre>"},{"location":"db_ops/9db_mgt/#3-4","title":"3-4 \u4fee\u6539\u5bc6\u7801","text":"<p>\u6ce8\u610f\uff1a\u4fee\u6539\u5b8c\u5bc6\u7801\u5fc5\u987b\u5237\u65b0\u6743\u9650</p> <pre><code>FLUSH PRIVILEGES;\n</code></pre> <p>root \u7528\u6237\u4fee\u6539\u81ea\u5df1\u5bc6\u7801</p> <pre><code>\u65b9\u6cd5\u4e00\uff1a\nmysqladmin -uroot -p123 password 'new_password'  # 123\u4e3a\u65e7\u5bc6\u7801\n\n\u65b9\u6cd5\u4e8c\uff1a \nalter user 'root'@'localhost' identified by 'new_pssword';\n\n\u65b9\u6cd5\u4e09\uff1a\nSET PASSWORD=password(\u2018new_password\u2019);\n</code></pre> <p>root \u4fee\u6539\u5176\u4ed6\u7528\u6237\u5bc6\u7801</p> <pre><code>\u65b9\u6cd5\u4e00\uff1a\nalter user 'qfedu'@'localhost' identified by 'Qfedu.1234com';\n\n\u65b9\u6cd5\u4e09\uff1a\nGRANT SELECT ON *.* TO \u7528\u6237\u540d@\u2019ip\u5730\u5740\u2019 IDENTIFIED BY \u2018yuan\u2019;\n</code></pre> <p>\u666e\u901a\u7528\u6237\u4fee\u6539\u81ea\u5df1\u5bc6\u7801</p> <pre><code>SET password=password(\u2018new_password\u2019);\n</code></pre>"},{"location":"db_ops/9db_mgt/#3-5-root","title":"3-5 \u627e\u56de root \u5bc6\u7801","text":"<p>\u4fee\u6539 MySQL \u914d\u7f6e\u6587\u4ef6</p> <p>\u5728<code>[mysqld]</code>\u4e0b\u9762\u52a0\u4e0a <code>skip-grant-tables</code></p> <pre><code>[root@qfedu.com ~]# vim /etc/my.cnf\n[mysqld]\n\u00b7\u00b7\u00b7\n\n#\u8bbe\u7f6e\u514d\u5bc6\u767b\u5f55\nskip-grant-tables\n</code></pre> <pre><code>[root@qfedu.com ~]# vim /etc/my.cnf\n[mysqld]\n</code></pre> <p>\u91cd\u542f MySQL</p> <pre><code>[root@qfedu.com ~]# systemctl restart mysqld\n</code></pre> <p>\u7ec8\u7aef\u8f93\u5165 mysql \u76f4\u63a5\u767b\u5f55 MySQL\u6570\u636e\u5e93</p> <pre><code>\u5207\u6362\u5230 MySQL \u7cfb\u7edf\u5e93 mysql\n</code></pre> <p>\u8bbe\u7f6e\u5bc6\u7801</p> <pre><code>mysql&gt; update user set authentication_string=password('\u5bc6\u7801') where user='root';\n</code></pre>"},{"location":"db_ops/9db_mgt/#3-6","title":"3-6 \u6ce8\u91ca\u6389\u514d\u5bc6\u767b\u5f55","text":"<pre><code>[root@qfedu.com ~]# vim /etc/my.cnf\n[mysqld]\n\u00b7\u00b7\u00b7\n#\u8bbe\u7f6e\u514d\u5bc6\u767b\u5f55\n#skip-grant-tables\n</code></pre>"},{"location":"db_ops/9db_mgt/#3-7-mysql","title":"3-7 \u91cd\u542f MySQL \u7136\u540e\u767b\u5f55","text":"<pre><code>[root@qfedu.com ~]# systemctl restart mysqld\n[root@qfedu.com ~]# mysql -uroot -p\n</code></pre>"},{"location":"db_ops/9db_mgt/#3-8","title":"3-8 \u5bc6\u7801\u590d\u6742\u5ea6","text":"<p>\u5b89\u88c5\u5bc6\u7801\u63d2\u4ef6</p> <p>MySQL \u9ed8\u8ba4\u542f\u7528\u4e86\u5bc6\u7801\u590d\u6742\u5ea6\u8bbe\u7f6e\uff0c\u63d2\u4ef6\u540d\u5b57\u53eb\u505a <code>validate_password</code></p> <pre><code>mysql&gt; INSTALL PLUGIN validate_password SONAME 'validate_password.so';\n</code></pre> <p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6</p> <p>\u4fee\u6539\u914d\u7f6e</p> <pre><code>[root@qfedu.com ~]# vim /etc/my.cnf\n[mysqld]\nplugin-load=validate_password.so\nvalidate_password_policy=0\nvalidate-password=FORCE_PLUS_PERMANENT\n</code></pre> <p>\u91cd\u542fMySQL\u751f\u6548</p> <pre><code>[root@qfedu.com ~]# systemctl restart mysqld\n</code></pre> <p>\u67e5\u770b\u9519\u8bef\u65e5\u5fd7</p> <p>\u767b\u9646\u6570\u636e\u5e93\u67e5\u770b</p> <pre><code>mysql&gt; show variables like 'validate%';\n+--------------------------------------+--------+\n| Variable_name | Value |\n+--------------------------------------+--------+\n| validate_password_check_user_name | OFF |\n| validate_password_dictionary_file | |\n| validate_password_length | 8 |\n| validate_password_mixed_case_count | 1 |\n| validate_password_number_count | 1 |\n| validate_password_policy | MEDIUM |\n| validate_password_special_char_count | 1 |\n+--------------------------------------+--------+\n7 rows in set (0.04 sec)\n</code></pre> <p><code>validate_password_policy</code></p> <p>\u4ee3\u8868\u7684\u5bc6\u7801\u7b56\u7565\uff0c\u53ef\u914d\u7f6e\u7684\u503c\u6709\u4ee5\u4e0b\uff1a\u9ed8\u8ba4\u662f<code>MEDIUM 0 or LOW</code> \u4ec5\u9700\u9700\u7b26\u5408\u5bc6\u7801\u957f\u5ea6\uff08\u7531\u53c2\u6570<code>validate_password_length</code>\u6307\u5b9a\uff09</p> <ul> <li>1 or MEDIUM \u6ee1\u8db3LOW\u7b56\u7565\uff0c\u540c\u65f6\u8fd8\u9700\u6ee1\u8db3\u81f3\u5c11\u67091\u4e2a\u6570\u5b57\uff0c\u5c0f\u5199\u5b57\u6bcd\uff0c\u5927\u5199\u5b57\u6bcd\u548c\u7279\u6b8a\u5b57\u7b26</li> <li>2 or STRONG \u6ee1\u8db3MEDIUM\u7b56\u7565\uff0c\u540c\u65f6\u5bc6\u7801\u4e0d\u80fd\u5b58\u5728\u5b57\u5178\u6587\u4ef6\uff08dictionary file\uff09\u4e2d</li> </ul> <p><code>validate_password_dictionary_file</code></p> <p>\u7528\u4e8e\u914d\u7f6e\u5bc6\u7801\u7684\u5b57\u5178\u6587\u4ef6\uff0c\u5f53<code>validate_password_policy</code>\u8bbe\u7f6e\u4e3a<code>STRONG</code>\u65f6\u53ef\u4ee5\u914d\u7f6e\u5bc6\u7801\u5b57\u5178\u6587 \u4ef6\uff0c\u5b57\u5178\u6587\u4ef6\u4e2d\u5b58\u5728\u7684\u5bc6\u7801\u4e0d\u5f97\u4f7f\u7528\u3002</p> <p><code>validate_password_length</code></p> <p>\u7528\u6765\u8bbe\u7f6e\u5bc6\u7801\u7684\u6700\u5c0f\u957f\u5ea6\uff0c\u9ed8\u8ba4\u503c\u662f8\u6700\u5c0f\u662f0</p> <p><code>validate_password_mixed_case_count</code></p> <p>\u5f53<code>validate_password_policy</code>\u8bbe\u7f6e\u4e3a<code>MEDIUM</code>\u6216\u8005<code>STRONG</code>\u65f6\uff0c\u5bc6\u7801\u4e2d\u81f3\u5c11\u540c\u65f6\u62e5\u6709\u7684\u5c0f\u5199\u548c\u5927\u5199 \u5b57\u6bcd\u7684\u6570\u91cf\uff0c\u9ed8\u8ba4\u662f1\u6700\u5c0f\u662f0\uff1b\u9ed8\u8ba4\u662f\u81f3\u5c11\u62e5\u6709\u4e00\u4e2a\u5c0f\u5199\u548c\u4e00\u4e2a\u5927\u5199\u5b57\u6bcd\u3002</p> <p><code>validate_password_number_count</code></p> <p>\u5f53<code>validate_password_policy</code>\u8bbe\u7f6e\u4e3aMEDIUM\u6216\u8005STRONG\u65f6\uff0c\u5bc6\u7801\u4e2d\u81f3\u5c11\u62e5\u6709\u7684\u6570\u5b57\u7684\u4e2a\u6570\uff0c\u9ed8 \u8ba41\u6700\u5c0f\u662f0</p> <p><code>validate_password_special_char_count</code></p> <p>\u5f53<code>validate_password_policy</code>\u8bbe\u7f6e\u4e3aMEDIUM\u6216\u8005STRONG\u65f6\uff0c\u5bc6\u7801\u4e2d\u81f3\u5c11\u62e5\u6709\u7684\u7279\u6b8a\u5b57\u7b26\u7684\u4e2a \u6570\uff0c\u9ed8\u8ba41\u6700\u5c0f\u662f0</p>"},{"location":"db_ops/9db_mgt/#3-9","title":"3-9 \u5bc6\u7801\u4e0d\u7b26\u5408\u590d\u6742\u6027","text":"<pre><code>mysql&gt; GRANT ALL ON *.* TO admin1@'%' IDENTIFIED BY '123';\nERROR 1819 (HY000): Your password does not satisfy the current policy\nrequirements\n</code></pre> <p>\u5904\u7406\u65b9\u6cd5\uff1a</p> <p>\u67e5\u770b\u5bc6\u7801\u7b56\u7565</p> <pre><code>mysql&gt; select @@validate_password_policy; # \u67e5\u770b\u5bc6\u7801\u590d\u6742\u6027\u7b56\u7565\n\nmysql&gt; select @@validate_password_length; # \u67e5\u770b\u5bc6\u7801\u590d\u6742\u6027\u8981\u6c42\u5bc6\u7801\u6700\u4f4e\u957f\u5ea6\u5927\u5c0f\n</code></pre> <p>\u66f4\u6362\u7b26\u5408\u590d\u6742\u6027\u8981\u6c42\u7684\u5bc6\u7801</p> <pre><code>mysql&gt; set global validate_password_length=1; # \u8bbe\u7f6e\u5bc6\u7801\u590d\u6742\u6027\u8981\u6c42\u5bc6\u7801\u6700\u4f4e\u957f\u5ea6\u4e3a1\n</code></pre> <p>\u5173\u95ed\u590d\u6742\u6027\u7b56\u7565</p> <pre><code>mysql&gt; set global validate_password_policy=0; # \u5173\u95ed\u5bc6\u7801\u590d\u6742\u6027\u7b56\u7565\n</code></pre>"},{"location":"db_ops/9db_mgt/#4mysql","title":"4\u3001MySQL \u767b\u5f55","text":"<pre><code>mysql -u\u7528\u6237\u540d -p\u5bc6\u7801 [ -h\u4e3b\u673a ] [ -P\u7aef\u53e3 ]\uff1b\n\nmysql -u\u7528\u6237\u540d -p\u5bc6\u7801 [ -h\u4e3b\u673a ] [ -P\u7aef\u53e3 ] [ -e\"SQL\u8bed\u53e5\" ]\uff1b\n</code></pre> <p>\u5b9e\u4f8b</p> <pre><code>[root@qfedu.com ~]# mysql -uroot -hlocalhost -p'qfedu.123com' -P3306\n\nmysql: [Warning] Using a password on the command line interface can be insecure.\nWelcome to the MySQL monitor. Commands end with ; or \\g.\nYour MySQL connection id is 8\nServer version: 5.7.29 MySQL Community Server (GPL)\nCopyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.\nmysql&gt;\n</code></pre>"},{"location":"db_ops/9db_mgt/#5mysql","title":"5\u3001MySQL \u6743\u9650\u7ba1\u7406","text":""},{"location":"db_ops/9db_mgt/#5-1","title":"5-1 \u67e5\u770b\u6743\u9650","text":"<pre><code>SHOW GRANTS FOR '\u7528\u6237'@'IP\u5730\u5740';\n</code></pre> <p>\u53ef\u4ee5\u4e0d\u6307\u5b9a\u7528\u6237\uff0c\u5219\u663e\u793a\u5f53\u524d\u7528\u6237\u6743\u9650</p> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; SHOW GRANTS FOR 'root'@'localhost';\n</code></pre>"},{"location":"db_ops/9db_mgt/#5-2","title":"5-2 \u6388\u6743\u53ca\u8bbe\u7f6e\u5bc6\u7801","text":"<p>\u6388\u6743\u53ca\u8bbe\u7f6e\u5bc6\u7801</p> <pre><code>GRANT \u6743\u9650 [,\u6743\u9650...[,\u6743\u9650]] NO \u6570\u636e\u5e93.\u6570\u636e\u8868 TO '\u7528\u6237'@'IP\u5730\u5740';\n\nGRANT \u6743\u9650 [,\u6743\u9650...[,\u6743\u9650]] NO \u6570\u636e\u5e93.\u6570\u636e\u8868 TO '\u7528\u6237'@'IP\u5730\u5740' IDENTIFIED BY '\u5bc6\u7801';\n</code></pre> <p>\u53ef\u4ee5\u7b80\u5316\u591a\u6b21\u6388\u6743\uff0c\u5e76\u7528\u9017\u53f7\u5206\u9694</p> <p>GRANT\u9700\u8981\u660e\u786e\u4e00\u4e0b\u4fe1\u606f \u8981\u6388\u4e88\u7684\u6743\u9650 \u88ab\u6388\u4e88\u6743\u9650\u7684\u6570\u636e\u5e93\u6216\u8868 \u7528\u6237\u540d</p> <p>\u6743\u9650\u7b80\u4ecb</p> <p></p> <p>\u6388\u6743\u8bbe\u7f6e\u5bc6\u7801\u5b9e\u4f8b</p> <pre><code>mysql&gt; GRANT ALL ON *.* TO admin1@'%' IDENTIFIED BY '(Qfedu.123com)';\n\nmysql&gt; GRANT ALL ON *.* TO admin2@'%' IDENTIFIED BY '(Qfedu.123com)' WITH GRANT\nOPTION;\n\nmysql&gt; GRANT ALL ON qfedu.* TO admin3@'%' IDENTIFIED BY '(Qfedu.123com)';\nmysql&gt; GRANT ALL ON qfedu.* TO admin3@'192.168.122.220' IDENTIFIED BY\n'(Qfedu.123com)';\n\nmysql&gt; GRANT ALL ON qfedu.user TO admin4@'%' IDENTIFIED BY '(Qfedu.123com)';\nmysql&gt; GRANT SELECT(col1),INSERT(col2,col3) ON qfedu.user TO admin5@'%'\nIDENTIFIED BY '(Qfedu.123com)';\n</code></pre>"},{"location":"db_ops/9db_mgt/#5-3-mysql-8x","title":"5-3 MySQL 8.x \u6388\u6743\u65b9\u5f0f","text":"<p>\u521b\u5efa\u65b0\u7684\u7528\u6237</p> <pre><code>CREATE USER '\u7528\u6237\u540d'@'localhost' IDENTIFIED BY '\u5bc6\u7801';\n</code></pre> <p>\u6570\u636e\u5e93\u6388\u6743</p> <pre><code>GRANT ALL PRIVILEGES ON \u6570\u636e\u5e93\u540d.* TO '\u7528\u6237\u540d'@'IP\u5730\u5740';\n</code></pre> <p>\u56de\u6536\u6743\u9650</p> <pre><code>REVOKE \u6743\u9650 ON \u6570\u636e\u5e93.\u6570\u636e\u8868 FROM '\u7528\u6237'@'IP\u5730\u5740';\n</code></pre> <p>\u88ab\u56de\u6536\u7684\u6743\u9650\u5fc5\u987b\u5b58\u5728\uff0c\u5426\u5219\u4f1a\u51fa\u9519</p> <ul> <li>\u6574\u4e2a\u670d\u52a1\u5668\uff0c\u4f7f\u7528 <code>GRANT ALL</code> \u548c <code>REVOKE ALL</code>\uff1b</li> <li>\u6574\u4e2a\u6570\u636e\u5e93\uff0c\u4f7f\u7528 <code>ON datebase.*</code>\uff1b</li> <li>\u7279\u5b9a\u7684\u8868\uff1a\u4f7f\u7528 <code>ON datebase.table</code>\uff1b</li> </ul> <p>\u5b9e\u4f8b</p> <pre><code>mysql&gt; REVOKE DELETE ON *.* FROM admin1@\u2019%\u2019;\n# \u56de\u6536\u6307\u5b9a\u6743\u9650\n\nmysql&gt; REVOKE ALL PRIVILEGES ON *.* FROM admin2@\u2019%\u2019;\n# \u56de\u6536\u6240\u6709\u6743\u9650\n\nmysql&gt; REVOKE ALL PRIVILEGES,GRANT OPTION ON *.* FROM 'admin2'@'%';\n# \u56de\u6536\u591a\u4e2a\u6307\u5b9a\u6743\u9650\n</code></pre>"},{"location":"db_ops/9db_mgt/#5-4","title":"5-4 \u5237\u65b0\u6743\u9650","text":"<pre><code>mysql&gt; FLUSH PRIVILEGES;\n</code></pre> <p>flush privileges \u547d\u4ee4\u672c\u8d28\u4e0a\u7684\u4f5c\u7528\u662f\u5c06\u5f53\u524duser\u548cprivilige\u8868\u4e2d\u7684\u7528\u6237\u4fe1\u606f/\u6743\u9650\u8bbe\u7f6e\u4ecemysql\u5e93 (MySQL\u6570\u636e\u5e93\u7684\u5185\u7f6e\u5e93)\u4e2d\u63d0\u53d6\u5230\u5185\u5b58\u91cc\u3002</p> <p>MySQL\u7528\u6237\u6570\u636e\u548c\u6743\u9650\u6709\u4fee\u6539\u540e\uff0c\u641c\u7d22\u5e0c\u671b\u5728\"\u4e0d\u91cd\u542fMySQL\u670d\u52a1\"\u7684\u60c5\u51b5\u4e0b\u76f4\u63a5\u751f\u6548\uff0c\u90a3\u4e48\u5c31\u9700 \u8981\u6267\u884c\u8fd9\u4e2a\u547d\u4ee4</p>"},{"location":"extra/mkdoc_gitbook/","title":"GitHub+Travis+Mkdocs\u81ea\u52a8\u5316\u6784\u5efa\u6587\u6863\u5e93(DataBase)","text":"<pre><code>mkdocs new jxdatabasebook\n\ncd jxdatabasebook\n\n$ ls\ndocs            mkdocs.yml\n\n$  git init\nInitialized empty Git repository in /Users/../Devops_sap/Tech_Books/jxdatabasebook/.git/\n\n\uffe5 git remote add origin https://github.com/Chao-Xi/jxdatabasebook.git\n\n$  mkdocs gh-deploy --clean\nINFO    -  Cleaning site directory \nINFO    -  Building documentation to directory: /Users/.../Devops_sap/Tech_Books/jxdatabasebook/site \nINFO    -  Documentation built in 0.10 seconds \nWARNING -  Version check skipped: No version specified in previous deployment. \nINFO    -  Copying '/Users/.../Devops_sap/Tech_Books/jxdatabasebook/site' to 'gh-pages' branch and pushing to GitHub. \nINFO    -  Your documentation should shortly be available at: https://Chao-Xi.github.io/jxdatabasebook/\n\n\n$ pip3 install mkdocs-awesome-pages-plugin\n$  mkdocs gh-deploy --clean\n</code></pre> <ul> <li>https://travis-ci.com</li> <li> <p>https://travis-ci.com/github/Chao-Xi/jxdatabasebook</p> <ul> <li><code>GITHUB_NAME</code>: <code>github password</code></li> <li><code>GITHUB_EMAIL</code>: <code>xichao2015@outlook.com</code></li> <li><code>GITHUB_API_KEY</code>: <code>73c...7d98</code></li> </ul> </li> </ul>"},{"location":"mongo1/10mongodb_index_adv/","title":"10 \u7d22\u5f15\u5c5e\u6027","text":""},{"location":"mongo1/10mongodb_index_adv/#unique-indexes","title":"\u552f\u4e00\u7d22\u5f15\uff08Unique Indexes)","text":"<p>\u5728\u73b0\u5b9e\u573a\u666f\u4e2d\uff0c\u552f\u4e00\u6027\u662f\u5f88\u5e38\u89c1\u7684\u4e00\u79cd\u7d22\u5f15\u7ea6\u675f\u9700\u6c42\uff0c\u91cd\u590d\u7684\u6570\u636e\u8bb0\u5f55\u4f1a\u5e26\u6765\u8bb8\u591a\u5904\u7406\u4e0a\u7684\u9ebb\u70e6\uff0c\u6bd4\u5982\u8ba2\u5355\u7684\u7f16\u53f7\u3001\u7528\u6237\u7684\u767b\u5f55\u540d\u7b49\u3002\u901a\u8fc7\u5efa\u7acb\u552f\u4e00\u6027\u7d22\u5f15\u53ef\u4ee5\u4fdd\u8bc1\u96c6\u5408\u4e2d\u6587\u6863\u7684\u6307\u5b9a\u5b57\u6bb5\u62e5\u6709\u552f\u4e00\u503c\u3002</p> <pre><code>\uff03\u521b\u5efa\u552f\u4e00\u7d22\u5f15 \ndb.values.createIndex({title:1}, {unique:true}} \n\n\uff03\u590d\u5408\u7d22\u5f15\u652f\u6301\u552f\u4e00\u6027\u7ea6\u675f \ndb.values.createIndex({title:1.type:1}, {unique:true}) \n\n\uff03\u591a\u952e\u7d22\u5f15\u652f\u552f\u4e00\u7d22\u5f15\u6027\u7ea6\u675f \ndb.inventory.createIndex({ratings:1},{unique:true}) \n</code></pre> <ul> <li>\u552f\u4e00\u6027\u7d22\u5f15\u5bf9\u4e8e\u6587\u6863\u4e2d\u7f3a\u5931\u7684\u5b57\u6bb5\uff0c\u4f1a\u4f7f\u7528null\u503c\u4ee3\u66ff\uff0c\u56e0\u6b64\u4e0d\u5141\u8bb8\u5b58\u5728\u591a\u4e2a\u6587\u6863\u7f3a\u5931\u7d22\u5f15\u5b57\u6bb5\u7684\u60c5\u51b5\u3002 </li> <li>\u5bf9\u4e8e\u5206\u7247\u7684\u96c6\u5408\uff0c\u552f\u4e00\u6027\u7ea6\u675f\u5fc5\u987b\u5339\u914d\u5206\u7247\u89c4\u5219\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u5168\u5c40\u7684\u552f\u4e00\u6027\uff0c\u5206\u7247\u952e\u5fc5\u987b\u4f5c\u4e3a\u552f\u4e00\u6027\u7d22\u5f15\u7684\u524d\u7f00\u5b57\u6bb5\u3002 </li> </ul> <pre><code>&gt; db.values.drop()\n\n&gt; db.values.insert({x:1})\nWriteResult({ \"nInserted\" : 1 })\n\n&gt; db.values.insert({x:1})\nWriteResult({ \"nInserted\" : 1 })\n\n&gt; db.values.drop()\ntrue\n\n&gt; db.values.insert({x:1})\nWriteResult({ \"nInserted\" : 1 })\n\n&gt; db.values.createIndex({x:1},{unique:true})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n\n&gt; db.values.insert({x:1})\nWriteResult({\n    \"nInserted\" : 0,\n    \"writeError\" : {\n        \"code\" : 11000,\n        \"errmsg\" : \"E11000 duplicate key error collection: appdb.values index: x_1 dup key: { x: 1.0 }\"\n    }\n})\n\n\n&gt; db.values.drop()\ntrue\n\n&gt; db.values.insert({x:[1,2,3]})\nWriteResult({ \"nInserted\" : 1 })\n\n&gt; db.values.createIndex({x:1},{unique:true})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n\n&gt; db.values.insert({x:[1,2,3]})\nWriteResult({\n    \"nInserted\" : 0,\n    \"writeError\" : {\n        \"code\" : 11000,\n        \"errmsg\" : \"E11000 duplicate key error collection: appdb.values index: x_1 dup key: { x: 1.0 }\"\n    }\n})\n\n&gt; db.values.insert({x:[1]})\nWriteResult({\n    \"nInserted\" : 0,\n    \"writeError\" : {\n        \"code\" : 11000,\n        \"errmsg\" : \"E11000 duplicate key error collection: appdb.values index: x_1 dup key: { x: 1.0 }\"\n    }\n})\n\n&gt; db.values.drop()\ntrue\n\n&gt; db.values.insert([{x:4},{y:1}])\nBulkWriteResult({\n    \"writeErrors\" : [ ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 2,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\n\n&gt; db.values.find()\n{ \"_id\" : ObjectId(\"626363b461515830838dcb7c\"), \"x\" : 4 }\n{ \"_id\" : ObjectId(\"626363b461515830838dcb7d\"), \"y\" : 1 }\n\n\n&gt; db.values.createIndex({x:1},{unique:true})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n\n&gt; db.values.insert({y:1})\nWriteResult({\n    \"nInserted\" : 0,\n    \"writeError\" : {\n        \"code\" : 11000,\n        \"errmsg\" : \"E11000 duplicate key error collection: appdb.values index: x_1 dup key: { x: null }\"\n    }\n})\n</code></pre>"},{"location":"mongo1/10mongodb_index_adv/#partial-indexes","title":"\u90e8\u5206\u7d22\u5f15\uff08Partial Indexes)","text":"<p>\u90e8\u5206\u7d22\u5f15\u4ec5\u5bf9\u6ee1\u8db3\u6307\u5b9a\u8fc7\u6ee4\u5668\u8868\u8fbe\u5f0f\u7684\u6587\u6863\u8fdb\u884c\u7d22\u5f15\u3002\u901a\u8fc7\u5728\u4e00\u4e2a\u96c6\u5408\u4e2d\u4e3a\u6587\u6863\u7684\u4e00\u4e2a\u5b50\u96c6\u5efa\u7acb\u7d22\uff0c\u90e8\u5206\u7d22\u5f15\u5177\u6709\u66f4\u4f4e\u7684\u5b58\u50a8\u9700\u6c42\u548c\u66f4\u4f4e\u7684\u7d22\u5f15\u521b\u5efa\u548c\u7ef4\u62a4\u7684\u6027\u80fd\u6210\u672c\u3002 3.2\u65b0\u7248\u529f\u80fd\u3002</p> <p>\u90e8\u5206\u7d22\u5f15\u63d0\u4f9b\u4e86\u7a00\u758f\u7d22\u5f15\u529f\u80fd\u7684\u8d85\u96c6\uff0c\u5e94\u8be5\u4f18\u5148\u4e8e\u7a00\u758f\u7d22\u5f15\u3002 </p> <pre><code>db.restaurants.createIndex(\n    {cuisine: 1, name: 1},\n    {partialFilterExpression: { rating: {$gt:5 }}}\n)\n</code></pre> <p>partialFilterExpression\u9009\u9879\u63a5\u53d7\u6307\u5b9a\u8fc7\u6ee4\u6761\u4ef6\u7684\u6587\u6863\uff1a</p> <ul> <li>\u7b49\u5f0f\u8868\u8fbe\u5f0f\uff08\u4f8b\u5982\uff1a<code>field:Value</code>\u6216\u4f7f\u7528<code>\uff04eq</code>\u64cd\u4f5c\u7b26\uff09 </li> <li><code>$exists:true</code> </li> <li><code>$gt</code>,<code>$gte</code>,<code>$It</code>,<code>$lte</code> </li> <li><code>$type</code> </li> <li>\u9876\u5c42\u7684<code>\uff04and</code> </li> </ul> <pre><code>\uff03\u7b26\u5408\u6761\u4ef6\uff0c\u4f7f\u7528\u7d22\u5f15 \ndb.restaurants.find({cuisine:\"Italian\",rating:{$gte:8}}) \n\n\uff03\u4e0d\u7b26\u5408\u6761\u4ef6\uff0c\u4e0d\u80fd\u4f7f\u7528\u7d22\u5f15\ndb.restaurants.find({cuisine:\"Italian\"}) \n</code></pre> <p>\u6848\u4f8b</p> <pre><code>db.restaurants.insert({ \n    \"_id\" : ObjectId(\"5641f6a7522545bc535b5dc9\"), \n    \"address\" : { \n        \"building\" : \"1007\", \n        \"coord\" : \n            [ -73.856077, \n            40.8484471 \n            ], \n        \"street\" : \"Morris Park Ave\", \n        \"zipcode\" : \"10462\" \n}, \n    \"borough\" : \"Bronx\", \n    \"cuisine\" : \"Bakery\", \n    \"rating\" : { \"date\" : ISODate(\"2014-03-03T00:00:00Z\"), \n                        \"grade\" : \"A\", \n                        \"score\" : 2 \n                    }, \n    \"name\" : \"Morris Park Bake Shop\", \n    \"restaurant_id\" : \"30075445\" \n}) \n</code></pre> <pre><code>WriteResult({ \"nInserted\" : 1 })\n</code></pre> <p>\u521b\u5efa\u7d22\u5f15</p> <pre><code>db.restaurants.createIndex( \n    {borough:1, cuisine: 1}, \n    {partialFilterExpression:{'rating.grade': {$eq: \"A\" }}}\n) \n</code></pre> <pre><code>{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <p>\u6d4b\u8bd5</p> <pre><code>db.restaurants.find({borough: \"Bronx\" , 'rating.grade': \"A\"})\n\ndb.restaurants.find({borough: \"Bronx\", cuisine: \"Bakery\"  })\n</code></pre> <pre><code>&gt; db.restaurants.find({borough: \"Bronx\" , 'rating.grade': \"A\"})\n{ \"_id\" : ObjectId(\"5641f6a7522545bc535b5dc9\"), \"address\" : { \"building\" : \"1007\", \"coord\" : [ -73.856077, 40.8484471 ], \"street\" : \"Morris Park Ave\", \"zipcode\" : \"10462\" }, \"borough\" : \"Bronx\", \"cuisine\" : \"Bakery\", \"rating\" : { \"date\" : ISODate(\"2014-03-03T00:00:00Z\"), \"grade\" : \"A\", \"score\" : 2 }, \"name\" : \"Morris Park Bake Shop\", \"restaurant_id\" : \"30075445\" }\n</code></pre> <pre><code>&gt; db.restaurants.find({borough: \"Bronx\", cuisine: \"Bakery\"  })\n{ \"_id\" : ObjectId(\"5641f6a7522545bc535b5dc9\"), \"address\" : { \"building\" : \"1007\", \"coord\" : [ -73.856077, 40.8484471 ], \"street\" : \"Morris Park Ave\", \"zipcode\" : \"10462\" }, \"borough\" : \"Bronx\", \"cuisine\" : \"Bakery\", \"rating\" : { \"date\" : ISODate(\"2014-03-03T00:00:00Z\"), \"grade\" : \"A\", \"score\" : 2 }, \"name\" : \"Morris Park Bake Shop\", \"restaurant_id\" : \"30075445\" }\n</code></pre> <p>\u552f\u4e00\u7ea6\u675f\u7ed3\u5408\u90e8\u5206\u7d22\u5f15\u4f7f\u7528\u5bfc\u81f4\u552f\u4e00\u7ea6\u675f\u5931\u6548\u7684\u95ee\u9898 </p> <p>\u6ce8\u610f\uff1a\u5982\u679c\u540c\u65f6\u6307\u5b9a\u4e86<code>partialFilterExpression</code>\u548c\u552f\u4e00\u7ea6\u675f\uff0c\u90a3\u4e48\u552f\u4e00\u7ea6\u675f\u53ea\u9002\u7528\u4e8e\u6ee1\u8db3\u7b5b\u9009\u5668\u8868\u8fbe\u5f0f\u7684\u6587\u6863\u3002\u5982\u679c\u6587\u6863\u4e0d\u6ee1\u8db3\u7b5b\u9009\u6761\u4ef6\uff0c\u90a3\u4e48\u5e26\u6709\u552f\u4e00\u7ea6\u675f\u7684\u90e8\u5206\u7d22\u5f15\u4e0d\u4f1a\u963b\u6b62\u63d2\u5165\u4e0d\u6ee1\u8db3\u60df\u4e00\u7ea6\u675f\u7684\u6587\u6863\u3002 </p> <p>\u6848\u4f8b2 users\u96c6\u5408\u6570\u636e\u51c6\u5907</p> <pre><code>db.users.insertMany([\n    {username: \"david\", age:29 },\n    {username: \"amanda\", age:35 },\n    {username: \"rajiv\", age:57 },\n])\n</code></pre> <pre><code>{\n    \"acknowledged\" : true,\n    \"insertedIds\" : [\n        ObjectId(\"6263c08c61515830838dcb7f\"),\n        ObjectId(\"6263c08c61515830838dcb80\"),\n        ObjectId(\"6263c08c61515830838dcb81\")\n    ]\n}\n</code></pre> <p>\u6d4b\u8bd5 </p> <p>\u7d22\u5f15\u9632\u6b62\u4e86\u4ee5\u4e0b\u6587\u6863\u7684\u63d2\u5165\uff0c\u56e0\u4e3a\u6587\u6863\u5df2\u7ecf\u5b58\u5728\uff0c\u4e14\u6307\u5b9a\u7684\u7528\u6237\u540d\u548c\u5e74\u9f84\u5b57\u6bb5\u5927\u4e8e21 </p> <pre><code>db.users.insertMany([\n    {username: \"david\", age:29 },\n    {username: \"amanda\", age:35 },\n    {username: \"rajiv\", age:57 },\n])\n</code></pre> <p>\u521b\u5efa\u7d22\u5f15\u6307\u5b9ausername\u5b57\u6bb5\u548c\u90e8\u5206\u8fc7\u6ee4\u5668\u8868\u8fbe\u5f0f<code>age: {$gte: 21\uff5d</code> \u7684\u552f\u4e00\u7ea6\u675f\u3002 </p> <pre><code>db.users.createIndex( \n    { username: 1 }, \n    { unique: true , partialFilterExpression: { age: { $gte:21 } } } \n)\n</code></pre> <pre><code>{\n    \"createdCollectionAutomatically\" : true,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <p>\u6d4b\u8bd5</p> <p>\u7d22\u5f15\u9632\u6b62\u4e86\u4ee5\u4e0b\u6587\u6863\u7684\u63d2\u5165\uff0c\u56e0\u4e3a\u6587\u6863\u5df2\u7ecf\u5b58\u5728\uff0c\u4e14\u6307\u5b9a\u7684\u7528\u6237\u540d\u548c\u5e74\u9f84\u5b57\u6bb5\u5927\u4e8e21 </p> <pre><code>db.users.insertMany([\n    {username: \"david\", age:29 },\n    {username: \"amanda\", age:35 },\n    {username: \"rajiv\", age:57 },\n])\n</code></pre> <pre><code>{\n    \"acknowledged\" : true,\n    \"insertedIds\" : [\n        ObjectId(\"6263cbe77e25e70e549f7a34\"),\n        ObjectId(\"6263cbe77e25e70e549f7a35\"),\n        ObjectId(\"6263cbe77e25e70e549f7a36\")\n    ]\n}\n</code></pre> <p>\u4f46\u662f\uff0c\u4ee5\u4e0b\u5177\u6709\u91cd\u590d\u7528\u6237\u540d\u7684\u6587\u6863\u662f\u5141\u8bb8\u7684\uff0c\u56e0\u4e3a\u552f\u4e00\u7ea6\u675f\u53ea\u9002\u7528\u4e8e\u5e74\u9f84\u5927\u4e8e\u6216\u7b49\u4e8e21\u5c81\u7684\u6587\u6863\u3002 </p> <pre><code>db.users.insertMany([\n    {username: \"david\", age:29 },\n    {username: \"amanda\" },\n    {username: \"rajiv\", age:null },\n])\n</code></pre> <pre><code>&gt; db.users.insertMany([\n... {username: \"david\", age:29 },\n... {username: \"amanda\" },\n... {username: \"rajiv\", age:null },\n... ])\nuncaught exception: BulkWriteError({\n    \"writeErrors\" : [\n        {\n            \"index\" : 0,\n            \"code\" : 11000,\n            \"errmsg\" : \"E11000 duplicate key error collection: test.users index: username_1 dup key: { username: \\\"david\\\" }\",\n            \"op\" : {\n                \"_id\" : ObjectId(\"6263cc0b7e25e70e549f7a37\"),\n                \"username\" : \"david\",\n                \"age\" : 29\n            }\n        }\n    ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 0,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n}) :\nBulkWriteError({\n    \"writeErrors\" : [\n        {\n            \"index\" : 0,\n            \"code\" : 11000,\n            \"errmsg\" : \"E11000 duplicate key error collection: test.users index: username_1 dup key: { username: \\\"david\\\" }\",\n            \"op\" : {\n                \"_id\" : ObjectId(\"6263cc0b7e25e70e549f7a37\"),\n                \"username\" : \"david\",\n                \"age\" : 29\n            }\n        }\n    ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 0,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\nBulkWriteError@src/mongo/shell/bulk_api.js:367:48\nBulkWriteResult/this.toError@src/mongo/shell/bulk_api.js:332:24\nBulk/this.execute@src/mongo/shell/bulk_api.js:1186:23\nDBCollection.prototype.insertMany@src/mongo/shell/crud_api.js:326:5\n@(shell):1:1\n\n</code></pre>"},{"location":"mongo1/10mongodb_index_adv/#sparse-indexes","title":"\u7a00\u758f\u7d22\u5f15\uff08Sparse Indexes)","text":"<p>\u7d22\u5f15\u7684\u7a00\u758f\u5c5e\u6027\u786e\u4fdd\u7d22\u5f15\u53ea\u5305\u542b\u5177\u6709\u7d22\u5f15\u5b57\u6bb5\u7684\u6587\u6863\u7684\u6761\u76ee\uff0c\u7d22\u5f15\u5c06\u8df3\u8fc7\u6ca1\u6709\u7d22\u5f15\u5b57\u6bb5\u7684\u6587\u6863\u3002 </p> <p>\u7279\u6027\uff1a\u53ea\u5bf9\u5b58\u5728\u5b57\u6bb5\u7684\u6587\u6863\u8fdb\u884c\u7d22\u5f15\uff08\u5305\u62ec\u5b57\u6bb5\u503c\u4e3anull\u7684\u6587\u6863\uff09 </p> <pre><code>\uff03\u7d22\u5f15\u4e0d\u5305\u542bxmpp_id\u5b57\u6bb5\u7684\u6587\u6863 \ndb.addresses.createIndex({\"xmpp_id\":1},{sparse:true}) \n</code></pre> <p>\u5982\u679c\u7a00\u758f\u7d22\u5f15\u4f1a\u5bfc\u81f4\u67e5\u8be2\u548c\u6392\u5e8f\u64cd\u4f5c\u7684\u7ed3\u679c\u96c6\u4e0d\u5b8c\u6574\uff0cMongoDB\u5c06\u4e0d\u4f1a\u4f7f\u7528\u8be5\u7d22\u5f15\u9664\u975e<code>hint()</code>\u660e\u786e\u6307\u5b9a\u7d22\u5f15\u3002 </p> <p>\u6848\u4f8b1</p> <p>\u6570\u636e\u51c6\u5907 </p> <pre><code>db.scores.insertMany([ \n    {\"userid\": \"newbie\"}, \n    {\"userid\":\"abby\",  \"score\": 82}, \n    {\"userid\": \"nina\", \"score\": 90} \n]) \n</code></pre> <pre><code>&gt; db.scores.insertMany([\n... {\"userid\": \"newbie\"},\n... {\"userid\":\"abby\",  \"score\": 82},\n... {\"userid\": \"nina\", \"score\": 90}\n... ])\n{\n    \"acknowledged\" : true,\n    \"insertedIds\" : [\n        ObjectId(\"6263cf897e25e70e549f7a3a\"),\n        ObjectId(\"6263cf897e25e70e549f7a3b\"),\n        ObjectId(\"6263cf897e25e70e549f7a3c\")\n    ]\n}\n</code></pre> <p>\u521b\u5efa\u7a00\u758f\u7d22\u5f15 </p> <pre><code>db.scores.createIndex({score: 1},{sparse: true}) \n</code></pre> <pre><code>&gt; db.scores.createIndex({score: 1},{sparse: true})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>&gt; db.scores.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"score\" : 1\n        },\n        \"name\" : \"score_1\",\n        \"sparse\" : true\n    }\n]\n</code></pre> <p>\u6d4b\u8bd5 </p> <pre><code># \u4f7f\u7528\u7a00\u758f\u7d22\u5f15 \ndb.scores.find({score:{$lt:90}}).explan()\n</code></pre> <pre><code>&gt; db.scores.find({score:{$lt:90}})\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3b\"), \"userid\" : \"abby\", \"score\" : 82 }\n</code></pre> <pre><code>&gt; db.scores.find({score:{$lt:90}}).explain()\n{\n    \"queryPlanner\" : {\n        \"plannerVersion\" : 1,\n        \"namespace\" : \"test.scores\",\n        \"indexFilterSet\" : false,\n        \"parsedQuery\" : {\n            \"score\" : {\n                \"$lt\" : 90\n            }\n        },\n        \"queryHash\" : \"36A7AA2F\",\n        \"planCacheKey\" : \"84D0C5E1\",\n        \"winningPlan\" : {\n            \"stage\" : \"FETCH\",\n            \"inputStage\" : {\n                \"stage\" : \"IXSCAN\",\n</code></pre> <pre><code>\uff03\u5373\u4f7f\u6392\u5e8f\u5740\u901a\u8fc7\u7d22\u5f15\u5b57\u6bb5\uff0cMongoDB\u4e5f\u4e0d\u4f1a\u9009\u5f89\u7a00\u758f\u7d22\u5f15\u6765\u5b8c\u6210\u67e5\u8be2\uff0c\u4ee5\u8fd4\u56de\u5b8c\u62db\u7684\u7ed3\u679c \ndb.scores.find().sort({sore:-1}) \n</code></pre> <pre><code>\uff03\u8981\u4f7f\u7528\u7a00\u758f\u7d22\u5f15\uff0c\u4f7f\u7528hint()\u663e\u793a\u6307\u5b9a\u7d22\u5f15 \ndb.scores.find().sort({score:-1}).hint({score: 1}) \n</code></pre> <p>\u540c\u65f6\u5177\u6709\u7a00\u758f\u6027\u548c\u552f\u4e00\u6027\u7684\u7d22\u5f15\u53ef\u4ee5\u9632\u6b62\u96c6\u53f0\u4e2d\u5b58\u5728\u5b57\u6bb5\u503c\u91cd\u590d\u7684\u6587\u6863\uff0c\u4f46\u5141\u8bb8\u4e0d\u5305\u542b\u6b64\u7d22\u5f15\u5b57\u6bb5\u7684\u6587\u6863\u63d2\u5165\u3002 </p> <pre><code>&gt; db.scores.find()\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3a\"), \"userid\" : \"newbie\" }\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3b\"), \"userid\" : \"abby\", \"score\" : 82 }\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3c\"), \"userid\" : \"nina\", \"score\" : 90 }\n</code></pre> <pre><code>&gt; db.scores.find().sort({score:-1})\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3c\"), \"userid\" : \"nina\", \"score\" : 90 }\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3b\"), \"userid\" : \"abby\", \"score\" : 82 }\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3a\"), \"userid\" : \"newbie\" }\n</code></pre> <pre><code>&gt; db.scores.find().sort({score:-1}).hint({score: 1})\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3c\"), \"userid\" : \"nina\", \"score\" : 90 }\n{ \"_id\" : ObjectId(\"6263cf897e25e70e549f7a3b\"), \"userid\" : \"abby\", \"score\" : 82 }\n</code></pre> <pre><code>db.scores.dropIndex(\"sccore_1\")\n\n&gt; db.scores.dropIndex(\"score_1\")\n{ \"nIndexesWas\" : 2, \"ok\" : 1 }\n</code></pre> <p>\u6848\u4f8b2 </p> <pre><code>\uff03\u521b\u5efa\u5177\u6709\u552f\u4e00\u7ea6\u675f\u7684\u7a00\u758f\u7d22\u5f15 \ndb.scores.createIndex({score:1}, {sparse:true, unique:true}) \n</code></pre> <pre><code>{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <p>\u6d4b\u8bd5 </p> <p>\u8fd9\u4e2a\u7d22\u5f15\u5c06\u5141\u8bb8\u8bb8\u63d2\u5165\u5177\u6709\u552f\u4e00\u7684\u5206\u6570\u5b57\u6bb5\u503c\u6216\u4e0d\u5305\u542b\u5206\u6570\u5b57\u6bb5\u7684\u6587\u6863\u3002\u56e0\u6b64\uff0c \u7ed9\u5b9a<code>scores</code>\u96c6\u5408\u4e2d\u7684\u73b0\u6709\u6587\u6863\uff0c\u7d22\u5f15\u5141\u8bb8\u4ee5\u4e0b\u63d2\u5165\u64cd\u4f5c\uff1a</p> <pre><code>db.scores.insertMany([\n    { \"userid\": \"AAAAAAA\", \"score\":43 },\n    { \"userid\": \"BBBBBBB\", \"score\":34 },\n    { \"userid\": \"ccccccc\" },\n    { \"userid\": \"ccccccc\" },\n])\n</code></pre> <pre><code>{\n    \"acknowledged\" : true,\n    \"insertedIds\" : [\n        ObjectId(\"6263e8677e25e70e549f7a3d\"),\n        ObjectId(\"6263e8677e25e70e549f7a3e\"),\n        ObjectId(\"6263e8677e25e70e549f7a3f\"),\n        ObjectId(\"6263e8677e25e70e549f7a40\")\n    ]\n}\n</code></pre> <p>\u7d22\u5f15\u4e0d\u5141\u8bb8\u6dfb\u52a0\u4e0b\u5217\u6587\u4ef6\uff0c\u56e0\u4e3a\u5df2\u7ecf\u5b58\u5728\u8bc4\u5206\u4e3a82\u548c90\u7684\u6587\u4ef6 </p> <p>\u9009\u62e9\u8bed\u8a00 </p> <pre><code>db.scores.insertMany([\n    { \"userid\": \"AAAAAAA\", \"score\":82 },\n    { \"userid\": \"BBBBBBB\", \"score\":90 }\n])\n</code></pre> <pre><code>uncaught exception: BulkWriteError({\n    \"writeErrors\" : [\n        {\n            \"index\" : 0,\n            \"code\" : 11000,\n            \"errmsg\" : \"E11000 duplicate key error collection: test.scores index: score_1 dup key: { score: 82.0 }\",\n            \"op\" : {\n                \"_id\" : ObjectId(\"6263e89b7e25e70e549f7a41\"),\n                \"userid\" : \"AAAAAAA\",\n                \"score\" : 82\n            }\n        }\n    ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 0,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n}) :\nBulkWriteError({\n    \"writeErrors\" : [\n        {\n            \"index\" : 0,\n            \"code\" : 11000,\n            \"errmsg\" : \"E11000 duplicate key error collection: test.scores index: score_1 dup key: { score: 82.0 }\",\n            \"op\" : {\n                \"_id\" : ObjectId(\"6263e89b7e25e70e549f7a41\"),\n                \"userid\" : \"AAAAAAA\",\n                \"score\" : 82\n            }\n        }\n    ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 0,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\n</code></pre>"},{"location":"mongo1/10mongodb_index_adv/#ttlttl-indexes","title":"TTL\u7d22\u5f15\uff08TTL Indexes)","text":"<p>\u5728\u4e00\u822c\u7684\u5e94\u7528\u7cfb\u7edf\u4e2d\uff0c\u5e76\u975e\u6240\u6709\u7684\u6570\u636e\u90fd\u9700\u8981\u6c38\u4e45\u5b58\u50a8\u3002\u4f8b\u5982\u4e00\u4e9b\u7cfb\u7edf\u4e8b\u4ef6\u3001\u7528\u6237\u6d88\u606f\u7b49\uff0c\u8fd9\u4e9b\u6570\u636e\u968f\u770b\u65f6\u95f4\u7684\u63a8\u79fb\uff0c\u5176\u91cd\u8981\u7a0b\u5ea6\u9010\u6e10\u964d\u4f4e\u3002\u66f4\u91cd\u8981\u7684\u662f\uff0c\u5b58\u50a8\u8fd9\u4e9b\u5927\u91cf\u7684\u5386\u53f2\u6570\u636e\u9700\u8981\u82b1\u8d39\u8f83\u9ad8\u7684\u6210\u672c\uff0c\u56e0\u6b64\u9879\u76ee\u4e2d\u901a\u5e38\u4f1a\u5bf9\u8fc7\u671f\u4e14\u4e0d\u518d\u4f7f\u7528\u7684\u6570\u636e\u8fdb\u884c\u8001\u5316\u5904\u7406\u3002 </p> <p>\u901a\u5e38\u7684\u505a\u6cd5\u5982\u4e0b\uff1a </p> <ul> <li>\u65b9\u6848\u4e00\uff1a\u4e3a\u6bcf\u4e2a\u6570\u636e\u8bb0\u5f55\u4e00\u4e2a\u65f6\u95f4\u6233\uff0c\u5e94\u7528\u4fa7\u5f00\u542f\u4e00\u4e2a\u5b9a\u65f6\u5668\uff0c\u6309\u65f6\u95f4\u6233\u5b9a\u671f\u5220\u9664\u8fc7\u671f\u7684\u6570\u636e\u3002</li> <li>\u65b9\u6848\u4e8c\uff1a\u6570\u636e\u6309\u65e5\u671f\u8fdb\u884c\u5206\u8868\uff0c\u540c\u4e00\u6c0f\u7684\u6570\u636e\u5f52\u6863\u5230\u540c\u4e00\u5f20\u8868\uff0c\u540c\u6837\u4f7f\u7528\u5b9a\u65f6\u5668\u5220\u9664\u8fc7\u671f\u7684\u8868\u3002 </li> </ul> <p>\u5bf9\u4e8e\u6570\u636e\u8001\u5316\uff0cMongoDB\u63d0\u4f9b\u4e86\u4e00\u79cd\u66f4\u52a0\u4fbf\u6377\u7684\u505a\u6cd5\uff1aTTL(Tome to Live)\u7d22\u5f15\u3002TTL\u7d22\u5f15\u9700\u8981\u58f0\u660e\u5728\u4e00\u4e2a\u65e5\u671f\u7c7b\u578b\u7684\u5b57\u6bb5\u4e2d\uff0cTTL\u7d22\u5f15\u662f\u7279\u6b8a\u7684\u5355\u5b57\u6bb5\u7d22\u5f15MongoDB\u53ef\u4ee5\u4f7f\u7528\u5b83\u5728\u4e00\u5b9a\u65f6\u95f4\u6216\u7279\u5b9a\u65f6\u949f\u65f6\u95f4\u540e\u81ea\u52a8\u4ece\u96c6\u5408\u4e2d\u5220\u9664\u6587\u6863\u3002 </p> <pre><code>\uff03\u521b\u5efaTTL\u7d22\u5f15,TTL\u503c\u4e3a3600\u79d2\ndb.eventlog.CreateIndex({\"lastModifiedDate\":1}, {expireAfterSeconds:3600}) \n\n</code></pre> <p>\u5bf9\u96c6\u5408\u521b\u5efaTTL\u7d22\u5f15\u4e4b\u540e\uff0cMongoDB\u4f1a\u5728\u5468\u671f\u6027\u8fd0\u884c\u7684\u540e\u53f0\u7ebf\u7a0b\u4e2d\u5bf9\u8be5\u96c6\u5408\u8fdb\u884c\u68c0\u67e5\u53ca\u6570\u636e\u6e05\u7406\u5de5\u4f5c\u3002\u9664\u4e86\u6570\u636e\u8001\u5316\u529f\u80fd\uff0cTTL\u7d22\u5f15\u5177\u6709\u666e\u901a\u7d22\u5f15\u7684\u529f\u80fd\uff0c\u540c\u6837\u53ef\u4ee5\u7528\u4e8e\u52a0\u901f\u6570\u636e\u7684\u67e5\u8be2\u3002 </p> <p>TTL\u7d22\u5f15\u4e0d\u4fdd\u8bc1\u8fc7\u671f\u6570\u636e\u4f1a\u5728\u8fc7\u671f\u540e\u7acb\u5373\u88ab\u5220\u9664\u3002\u6587\u6863\u8fc7\u671f\u548cMongoDB\u4ece\u6570\u636e\u5e93\u4e2d\u5220\u9664\u6587\u6863\u7684\u65f6\u95f4\u4e4b\u95f4\u53ef\u80fd\u5b58\u5728\u5ef6\u8fdf\u3002\u5220\u9664\u8fc7\u671f\u6587\u6863\u7684 \u540e\u53f0\u4efb\u52a1\u6bcf60\u79d2\u8fd0\u884c\u4e00\u6b21\u3002\u56e0\u6b64\uff0c\u5728\u6587\u6863\u5230\u671f\u548c\u540e\u53f0\u4efb\u52a1\u8fd0\u884c\u4e4b\u95f4\u7684\u65f6\u95f4\u6bb5\u5185\uff0c\u6587\u6863\u53ef\u80fd\u4f1a\u4fdd\u7559\u5728\u96c6\u5408\u4e2d\u3002 </p> <p>\u6848\u4f8b</p> <p>\u6570\u636e\u51c6\u5907 </p> <pre><code>db.log_events.insertOne({ \n    \"CreatedAt\": new Date(),\n    \"logEvent\":2, \n    \"logMessage\":\"Success!\" \n})\n</code></pre> <pre><code>{\n    \"acknowledged\" : true,\n    \"insertedId\" : ObjectId(\"6263ee9120b8b386588f0dec\")\n}\n</code></pre> <p>\u521b\u5efaTTL\u7d22\u5f15</p> <pre><code>db.log_events.createIndex({\"CreatedAt\":1},{expireAfterSeconds:20}) \n</code></pre> <pre><code>{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>&gt; db.log_events.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"CreatedAt\" : 1\n        },\n        \"name\" : \"CreatedAt_1\",\n        \"expireAfterSeconds\" : 20\n    }\n]\n</code></pre> <pre><code>&gt; db.log_events.find()\n{ \"_id\" : ObjectId(\"6263efe920b8b386588f0ded\"), \"CreatedAt\" : ISODate(\"2022-04-23T12:24:09.085Z\"), \"logEvent\" : 2, \"logMessage\" : \"Success!\" }\n\n# 20s past\n\n&gt; db.log_events.find()\n</code></pre> <p>TTL\u7d22\u5f15\u5728\u521b\u5efa\u4e4b\u540e\uff0c\u4ecd\u7136\u53ef\u4ee5\u5bf9\u8fc7\u671f\u65f6\u95f4\u8fdb\u884c\u4fee\u6539\u3002\u8fd9\u9700\u8981\u4f7f\u7528collMod\u547d\u4ee4\u5bf9\u7d22\u5f15\u7684\u5b9a\u4e49\u8fdb\u884c\u53d8\u66f4 </p> <pre><code>db.runCommand({collMod:\"log_events\",index:{keyPattern:{createdAt:1},expireAfterSeconds:600}}) \n</code></pre> <pre><code>{\n    \"ok\" : 0,\n    \"errmsg\" : \"cannot find index { createdAt: 1.0 } for ns test.log_events\",\n    \"code\" : 27,\n    \"codeName\" : \"IndexNotFound\"\n}\n</code></pre>"},{"location":"mongo1/10mongodb_index_adv/#_1","title":"\u4f7f\u7528\u7ea6\u675f","text":"<p>TTL\u7d22\u5f15\u7d22\u5f15\u7684\u786e\u53ef\u4ee5\u51cf\u5c11\u5f00\u53d1\u7684\u5de5\u4f5c\u91cf\uff0c\u800c\u4e14\u901a\u8fc7\u6570\u636e\u5e93\u81ea\u52a8\u6e05\u7406\u7684\u65b9\u5f0f\u4f1a\u66f4\u52a0\u9ad8\u6548\u3001\u53ef\u9760\uff0c\u4f46\u662f\u5728\u4f7f\u7528TTL\u7d22\u5f15\u65f6\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u7684\u9650\u5236\uff1a </p> <ul> <li>TTL\u7d22\u5f15\u53ea\u80fd\u652f\u6301\u5355\u4e2a\u5b57\u6bb5\uff0c\u5e76\u4e14\u5fc5\u987b\u662f\u975e<code>_Id</code>\u5b57\u6bb5\u3002 </li> <li>TTL\u7d22\u5f15\u4e0d\u80fd\u7528\u4e8e\u56fa\u5b9a\u96c6\u5408\u3002</li> <li>TTL\u7d22\u5f15\u65e0\u6cd5\u4fdd\u8bc1\u53ca\u65f6\u7684\u6570\u636e\u8001\u5316\uff0cMongoDB\u4f1a\u901a\u8fc7\u540e\u53f0\u7684TTLMonitor\u5b9a\u65f6\u5668\u6765\u6e05\u7406\u8001\u5316\u6570\u636e\uff0c\u9ed8\u8ba4\u7684\u95f4\u9694\u65f6\u95f4\u662f1\u5206\u949f\u3002</li> <li>\u5f53\u7136\u5982\u679c\u5728\u6570\u636e\u5e93\u8d1f\u8f7d\u8fc7\u9ad8\u7684\u60c5\u51b5\u4e0b\uff0cTTL\u7684\u884c\u4e3a\u5219\u4f1a\u8fdb\u4e00\u6b65\u53d7\u5230\u5f71\u54cd\u3002 </li> <li>TTL\u7d22\u5f15\u5bf9\u4e8e\u6570\u636e\u7684\u6e05\u7406\u4ec5\u4ec5\u4f7f\u7528\u4e86remove\u547d\u4ee4\uff0c\u8fd9\u79cd\u65b9\u5f0f\u5e76\u4e0d\u662f\u5f88\u9ad8\u6548\u3002\u56e0\u6b64TTL Monitor\u5728\u8fd0\u884c\u671f\u95f4\u5bf9\u7cfb\u7edfCPU\u3001\u78c1\u76d8\u90fd\u4f1a\u9020\u6210\u4e00\u5b9a\u7684\u538b\u529b\u3002\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u6309\u65e5\u671f\u5206\u8868\u7684\u65b9\u5f0f\u64cd\u4f5c\u4f1a\u66f4\u52a0\u9ad8\u6548\u3002 </li> </ul>"},{"location":"mongo1/10mongodb_index_adv/#hidden-indexes","title":"\u9690\u85cf\u7d22\u5f15\uff08Hidden Indexes)","text":"<p>\u9690\u85cf\u7d22\u5f15\u5bf9\u67e5\u8be2\u89c4\u5212\u5668\u4e0d\u53ef\u89c1\uff0c\u4e0d\u80fd\u7528\u4e8e\u652f\u6301\u67e5\u8be2\u3002</p> <p>\u901a\u8fc7\u5bf9\u89c4\u5212\u5668\u9690\u85cf\u7d22\u5f15\uff0c\u7528\u6237\u53ef\u4ee5\u5728\u4e0d\u5b9e\u9645\u5220\u9664\u7d22\u5f15\u7684\u60c5\u51b5\u4e0b\u8bc4\u4f30\u5220\u9664\u7d22\u5f15\u7684\u6f5c\u5728\u5f71\u54cd\u3002\u5982\u679c\u5f71\u54cd\u662f\u8d1f\u9762\u7684\uff0c\u7528\u6237\u53ef\u4ee5\u53d6\u6d88\u9690\u85cf\u7d22\u5f15\uff0c\u800c\u4e0d\u5fc5\u91cd\u65b0\u521b\u5efa\u5df2\u5220\u9664\u7684\u7d22\u5f15\u30024.4\u65b0\u7248\u529f\u80fd\u3002</p> <pre><code>\u521b\u5efa\u9690\u85cf\u7d22\u5f15\ndb.restaurants.createIndex({borough:1},{hidden:true}); \n\n\n# \u9690\u85cf\u73b0\u6709\u7d22\u5f15 \ndb.restaurants.hideIndex({borough:1}); \ndb.restaurants.hideIndex({\"\u7d22\u5f15\u540d\u79f0\"}); \n\n\n\uff03\u53d6\u6d88\u9690\u85cf\u7d22\u5f15 \ndb.restaurants.unhideIndex({borough:1}); \ndb.restaurants.unhideIndex({\"\u7d22\u5f15\u540d\u79f0\"}); \n</code></pre> <pre><code>db.scores.insertMany([ \n    {\"userid\": \"newbie\"}, \n    {\"userid\": \"abby\", \"score\" :82},\n    {\"userid\": \"nina\", \"score\" :90}\n]) \n\n</code></pre> <pre><code>{\n    \"acknowledged\" : true,\n    \"insertedIds\" : [\n        ObjectId(\"6263f70b20b8b386588f0df1\"),\n        ObjectId(\"6263f70b20b8b386588f0df2\"),\n        ObjectId(\"6263f70b20b8b386588f0df3\")\n    ]\n}\n</code></pre> <p>\u521b\u5efa\u9690\u85cf\u7d22\u5f15 </p> <pre><code>db.scores.createIndex( \n    {userid: 1}, \n    {hidden:true} \n) \n</code></pre> <pre><code>{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <p>\u67e5\u770b\u7d22\u5f15\u4fe1\u606f</p> <pre><code>db.scores.getIndexes() \n</code></pre> <p>\u7d22\u5f15\u5c5e\u6027hidden\u53ea\u5728\u503c\u4e3atrue\u65f6\u8fd4\u56de</p> <pre><code>&gt; db.scores.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"hidden\" : true,\n        \"key\" : {\n            \"userid\" : 1\n        },\n        \"name\" : \"userid_1\"\n    }\n]\n</code></pre> <p>\u6d4b\u8bd5</p> <pre><code># \u4e0d\u7528\u7d22\u5f15\ndb.scores.find({ userid: \"abby\" }).explain()\n\n\n&gt; db.scores.find({ userid: \"abby\" }).explain()\n{\n    \"queryPlanner\" : {\n        \"plannerVersion\" : 1,\n        \"namespace\" : \"test.scores\",\n        \"indexFilterSet\" : false,\n        \"parsedQuery\" : {\n            \"userid\" : {\n                \"$eq\" : \"abby\"\n            }\n        },\n        \"queryHash\" : \"37A12FC3\",\n        \"planCacheKey\" : \"7FDF74EC\",\n        \"winningPlan\" : {\n            \"stage\" : \"COLLSCAN\",\n\u00b7\u00b7\u00b7\n\n# \u53d6\u6d88\u5f71\u85cf\u7d22\u5f15\n&gt; db.scores.unhideIndex({ userid: 1 })\n\n { \"hidden_old\" : true, \"hidden_new\" : false, \"ok\" : 1 }\n\n# \u7528\u7d22\u5f15\n&gt; db.scores.find({ userid: \"abby\" }).explain()\n...\n\"winningPlan\" : {\n            \"stage\" : \"FETCH\",\n            \"inputStage\" : {\n                \"stage\" : \"IXSCAN\",\n                \"keyPattern\" : {\n</code></pre>"},{"location":"mongo1/11mongodb_explain/","title":"11 explain\u6267\u884c\u8ba1\u5212\u8be6\u89e3","text":"<p>\u901a\u5e38\u6211\u4eec\u9700\u8981\u5173\u5fc3\u7684\u95ee\u9898\uff1a </p> <ul> <li>\u67e5\u8be2\u662f\u5426\u4f7f\u7528\u4e86\u7d22\u5f15 </li> <li>\u7d22\u5f15\u662f\u5426\u51cf\u5c11\u4e86\u626b\u63cf\u7684\u8bb0\u5f55\u6570\u91cf </li> <li>\u662f\u5426\u5b58\u5728\u4e86\u4f4e\u6548\u7684\u5185\u5b58\u6392\u5e8f </li> </ul> <p>MongoDB\u63d0\u4f9b\u4e86explain\u547d\u4ee4\uff0c\u5b83\u53ef\u4ee5\u5e2e\u52a9\u6211\u4eec\u8bc4\u4f30\u6307\u5b9a\u67e5\u8be2\u6a21\u578b(querymodel\uff09\u7684\u6267\u884c\u8ba1\u5212\uff0c\u6839\u636e\u5b9e\u9645\u60c5\u51b5\u8fdb\u884c\u8c03\u6574\uff0c\u7136\u540e\u63d0\u9ad8\u67e5\u8be2\u6548\u7387\u3002 </p> <p>explain(\uff09\u65b9\u6cd5\u7684\u5f62\u5f0f\u5982\u4e0b\uff1a </p> <pre><code>db.collection.find().explain(&lt;verbose&gt;) \n</code></pre> <p>verbose\u53ef\u9009\u53c2\u6570\uff0c\u8868\u793a\u6267\u884c\u8ba1\u5212\u7684\u8f93\u51fa\u6a21\u5f0f\uff0c\u9ed8\u8ba4queryPlanner </p> <p></p> <p></p> <p>executionStats </p> <p>executionStats\u6a21\u5f0f\u7684\u8fd4\u56de\u4fe1\u606f\u4e2d\u5305\u542b\u4e86queryPlanner\u6a21\u5f0f\u7684\u6240\u6709\u5b57\u6bb5\uff0c\u5e76\u4e14\u8fd8\u5305\u542b\u4e86\u6700\u4f73\u6267\u884c\u8ba1\u5212\u7684\u6267\u884c\u6e05\u51b5 </p> <pre><code>\uff03\u521b\u5efa\u7d22\u5f15 \ndb.books.createIndex({title:1}) \n\ndb.books.find({title:\"book-1\"}).explain(\"executionStats\") \n</code></pre> <p></p> <p>aliPlansExecution </p> <p>allPlansExecution\u8fd4\u56de\u7684\u4fe1\u606f\u5305\u542bexecutionStats\u6a21\u5f0f\u7684\u5185\u5bb9\uff0c\u4e14\u5305\u542b<code>allPlansExecution:[]</code>\u5757 </p> <p></p> <p>stage\u72b6\u6001</p> <p></p> <p>\u6267\u884c\u8ba1\u5212\u7684\u8fd4\u56de\u7ed3\u679c\u4e2d\u5c3d\u91cf\u4e0d\u8981\u51fa\u73b0\u4ee5\u4e0bstage: </p> <ul> <li>COLLSCAN(\u5168\u8868\u626b\u63cf\uff09 </li> <li>SORT\uff08\u4f7f\u7528sort\u4f46\u662f\u65e0index) </li> <li>\u4e0d\u5408\u7406\u7684SKIP </li> <li>SUBPLA\uff08\u672a\u7528\u5230index\u7684\uff04or) </li> <li>COUNTSCAN\uff08\u4e0d\u4f7f\u7528index\u8fdb\u884ccount) </li> </ul>"},{"location":"mongo1/1mongodb_intro/","title":"1 MongoDB\u4ecb\u7ecd","text":""},{"location":"mongo1/1mongodb_intro/#11-mongodb","title":"1.1 \u4ec0\u4e48\u662fMongoDB","text":"<p>MongoDB\u662f\u4e00\u4e2a\u6587\u6863\u6570\u636e\u5e93\uff08\u4ee5JSON\u4e3a\u6570\u636e\u6a21\u578b\uff09\uff0c\u7531c+\uff0b\u8bed\u8a00\u7f16\u5199\uff0c\u65e8\u5728\u4e3aWEB\u5e94\u7528\u63d0\u4f9b\u53ef\u6269\u5c55\u7684\u9ad8\u6027\u80fd\u6570\u636e\u5b58\u50a8\u89e3\u51b3\u65b9\u6848\u3002 </p> <p>\u6587\u6863\u6765\u81ea\u4e8e \u201cJSON Document\u201d\uff0c\u5e76\u975e\u4e00\u822c\u7406\u89e3\u7684PDF, WORD \u6587\u6863\u3002 </p> <p>MongoDB\u662f\u4e00\u4e2a\u4ecb\u4e8e\u5173\u7cfb\u6570\u636e\u5e93\u548c\u975e\u5173\u7cfb\u6570\u636e\u5e93\u4e4b\u95f4\u7684\u4ea7\u54c1\uff0c\u662f\u975e\u5173\u7cfb\u6570\u636e\u5e93\u5f53\u4e2d\u529f\u80fd\u6700\u4e30\u5bcc\uff0c\u6700\u50cf\u5173\u7cfb\u6570\u636e\u5e93\u7684\u3002</p> <p>\u5b83\u652f\u6301\u7684\u6570\u636e\u7ed3\u6784 \u975e\u5e38\u677e\u6563\uff0c\u6570\u636e\u683c\u5f0f\u662fBSON\uff0c\u4e00\u79cd\u7c7b\u4f3c\u4e8eJSON\u7684\u4e8c\u8fdb\u5236\u5f62\u5f0f\u7684\u5b58\u50a8\u683c\u5f0f\uff0c\u7b80\u79f0Binary JSON\uff0c\u548cJSON\u4e00\u6837\u652f\u6301\u5185\u5d4c\u7684\u6587\u6863\u5bf9\u8c61\u548c\u6570\u7ec4\u5bf9\u8c61\uff0c\u56e0\u6b64\u53ef\u4ee5\u5b58\u50a8\u6bd4\u8f83\u590d\u6742\u7684\u6570\u636e\u7c7b\u578b\u3002</p> <p>MongoDB\u6700\u5927\u7684\u7279\u70b9\u662f\u5b83\u652f\u6301\u7684\u67e5\u8be2\u8bed\u8a00\u975e\u5e38\u5f3a\u5927\uff0c\u5176\u8bed\u6cd5\u6709\u70b9\u7c7b\u4f3c\u4e8e\u9762\u5411\u5bf9\u8c61\u7684\u67e5\u8be2\u8bed\u8a00\uff0c\u51e0\u4e4e\u53ef\u4ee5\u5b9e\u73b0\u7c7b\u4f3c\u5173\u7cfb\u6570\u636e\u5e93\u5355\u8868\u67e5\u8be2\u7684\u7edd\u5927\u90e8\u5206\u529f\u80fd\uff0c\u800c\u4e14\u8fd8\u652f\u6301\u5bf9\u6570\u636e\u5efa\u7acb\u7d22\u5f15\u3002</p> <p>\u539f\u5219\u4e0aOracle\u548cMySQL\u80fd\u505a\u7684\u4e8b\u60c5 MongoDB\u90fd\u80fd\u505a\uff08\u5305\u62ecACID\u4e8b\u52a1\uff09</p> <p>MongoDB\u5728\u6570\u636e\u5e93\u603b\u6392\u540d\u7b2c5 \u6307\u6570\u6301\u7eed\u4e0a\u5347\u3002 \u4ec5\u6b21\u4e8eOracle\u3001 MySQL\u7b49RDBMS\uff0c\u5728NoSQL\u6570\u636e\u5e93\u6392\u540d\u9996\u4f4d\u3002\u4ece\u8bde\u751f\u4ee5\u6765\uff0c\u5176\u9879\u76ee\u5e94\u7528\u5e7f\u5ea6\u3001\u793e\u533a\u6d3b\u8dc3\u6301\u7eed\u4e0a\u5347</p> <p></p> <p>MongoDB\u7684\u6982\u5ff5\u4e0e\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08RDBMS)\u975e\u5e38\u7c7b\u4f3c</p> <p></p> <ul> <li>\u6570\u636e\u5e93\uff08database)\uff1a\u6700\u5916\u5c42\u7684\u6982\u5ff5\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u903b\u8f91\u4e0a\u7684\u540d\u79f0\u7a7a\u95f4\uff0c\u4e00\u4e2a\u6570\u636e\u5e93\u5305\uff0e\u542b\u591a\u4e2a\u4e0d\u540c\u540d\u79f0\u7684\u96c6\u5408\u3002 </li> <li>\u96c6\u5408\uff08Collection)\uff1a\u76f8\u5f53\u4e8eSQL\u4e2d\u7684\u8868\uff0c\u4e00\u4e2a\u96c6\u5408\u53ef\u4ee5\u5b58\u653e\u591a\u4e2a\u4e0d\u540c\u7684\u6587\u6863\u3002 </li> <li>\u6587\u6863\uff08document)\uff1a\u4e00\u4e2a\u6587\u6863\u76f8\u5f53\u4e8e\u6570\u636e\u8868\u4e2d\u7684\u4e00\u884c\uff0c\u7531\u591a\u4e2a\u4e0d\u540c\u7684\u5b57\u6bb5\u7ec4\u6210\u3002 </li> <li>\u5b57\u6bb5\uff08field)\uff1a\u6587\u6863\u4e2d\u7684\u4e00\u4e2a\u5c5e\u6027\uff0c\u7b49\u540c\u4e8e\u5217\uff08column)\u3002 </li> <li>\u7d22\u5f15\uff08index)\uff1a\u72ec\u7acb\u7684\u68c0\u7d22\u5f0f\u6570\u636e\u7ed3\u6784\uff0c\u4e0eSQL\u6982\u5ff5\u4e00\u81f4\u3002 </li> <li>Id:\u6bcf\u4e2a\u6587\u6863\u4e2d\u90fd\u62e5\u6709\u4e00\u4e2a\u552f\u4e00\u7684id\u5b57\u6bb5\uff0c\u76f8\u5f53\u4e8eSQL\u4e2d\u7684\u4e3b\u952e(primary key)\u3002 </li> <li>\u89c6\u56fe\uff08view\uff09\u4e8c\u53ef\u4ee5\u770b\u4f5c\u4e00\u79cd\u865a\u62df\u7684\uff08\u975e\u771f\u5b9e\u5b58\u5728\u7684\uff09\u96c6\u5408\uff0c\u4e0eSQL\u4e2d\u7684\u89c6\u56fe\u7c7b\u4f3c\u3002\u4eceMongoDB 3.4\u7248\u672c\u5f00\u59cb\u63d0\u4f9b\u4e86\u89c6\u56fe\u529f\u80fd\uff0c\u5176\u901a\u8fc7\u805a\u5408\u7ba1\u9053\u6280\u672f\u5b9e\u73b0\u3002 </li> <li>\u805a\u5408\u64cd\u4f5c\uff08<code>$lookup</code>):MongoDB\u7528\u4e8e\u5b9e\u73b0\u201c\u7c7b\u4f3c\u201d\u8868\u8fde\u63a5\uff08tablejoin\uff09\u7684\u805a\u5408\u64cd\u4f5c\u7b26\u3002 </li> </ul> <p></p> <p>\u5c3d\u7ba1\u8fd9\u4e9b\u6982\u5ff5\u5927\u591a\u4e0eSQL\u6807\u51c6\u5b9a\u4e49\u7c7b\u4f3c\uff0c\u4f46MongoDB\u4e0e\u4f20\u7edfRDBMS\u4ecd\u7136\u5b58\u5728\u4e0d\u5c11\u5dee\u5f02\uff0c\u5305\u62ec\uff1a </p> <ul> <li>\u534a\u7ed3\u6784\u5316\uff0c\u5728\u4e00\u4e2a\u96c6\u5408\u4e2d\uff0c\u6587\u6863\u6240\u62e5\u6709\u7684\u5b57\u6bb5\u5e76\u4e0d\u9700\u8981\u662f\u6cea\u540c\u7684\uff0c\u800c\u4e14\u4e5f\u4e0d\u9700\u8981\u5bf9\u6240\u7528\u7684\u5b57\u6bb5\u8fdb\u884c\u58f0\u660e\u3002\u56e0\u6b64\uff0cMongoDB\u5177\u6709\u5f88\u660e \u663e\u7684\u534a\u7ed3\u6784\u5316\u7279\u70b9\u3002\u9664\u4e86\u677e\u6563\u7684\u8868\u7ed3\u6784\uff0c\u6587\u6863\u8fd8\u53ef\u4ee5\u652f\u6301\u591a\u7ea7\u7684\u5d4c\u5957\u3001\u6570\u7ec4\u7b49\u7075\u6d3b\u7684\u6570\u636e\u7c7b\u578b\uff0c\u975e\u5e38\u5951\u5408\u9762\u5411\u5bf9\u8c61\u7684\u7f16\u7a0b\u6a21\u578b\u3002 </li> <li>\u5f31\u5173\u7cfb\uff0cMongoDB\u6ca1\u6709\u5916\u5065\u7684\u7ea6\u675f\uff0c\u4e5f\u6ca1\u6709\u975e\u5e38\u5f3a\u5927\u7684\u8868\u8fde\u63a5\u80fd\u529b\u3002\u7c7b\u4f3c\u7684\u529f\u80fd\u9700\u8981\u4f7f\u7528\u805a\u5408\u7ba1\u9053\u6280\u672f\u6765\u5f25\u8865\u3002 </li> </ul>"},{"location":"mongo1/1mongodb_intro/#12-mongodb","title":"1.2 MongoDB\u6280\u672f\u4f18\u52bf","text":"<p>MongoDB\u57fa\u4e8e\u7075\u6d3b\u7684JSON\u6587\u6863\u6a21\u578b\uff0c\u975e\u5e38\u9002\u5408\u654f\u6377\u5f0f\u7684\u5feb\u901f\u5f00\u53d1\u3002\u4e0e\u6b64\u540c\u65f6\uff0c\u5176\u4e0e\u751f\u4ff1\u6765\u7684\u9ad8\u53ef\u7528\u3001\u9ad8\u6c34\u5e73\u6269\u5c55\u80fd\u529b\u4f7f\u5f97\u5b83\u5728\u5904\u7406\u6d77 \u91cf\u3001\u9ad8\u5e76\u53d1\u7684\u6570\u636e\u5e94\u7528\u65f6\u9887\u5177\u4f18\u52bf\u3002 </p> <ul> <li>JSON\u7ed3\u6784\u548c\u5bf9\u8c61\u6a21\u578b\u63a5\u8fd1\uff0c\u5f00\u53d1\u4ee3\u7801\u91cf\u4f4e </li> <li>JSON\u7684\u52a8\u6001\u6a21\u578b\u610f\u5473\u7740\u66f4\u5bb9\u6613\u54cd\u5e94\u65b0\u7684\u4e1a\u52a1\u9700\u6c42</li> <li>\u590d\u5236\u96c6\u63d0\u4f9b99.999\uff05\u9ad8\u53ef\u7528 </li> <li>\u5206\u7247\u67b6\u6784\u652f\u6301\u6d77\u91cf\u6570\u636e\u548c\u65e0\u7f1d\u6269\u53f8 </li> </ul> <p>\u7b80\u5355\u76f4\u89c2\uff1a\u4ece\u9519\u7efc\u590d\u6742\u7684\u5173\u7cfb\u6a21\u578b\u5230\u4e00\u76ee\u4e86\u7136\u7684\u5bf9\u8c61\u6a21\u578b </p> <p></p>"},{"location":"mongo1/1mongodb_intro/#_1","title":"\u5feb\u901f\uff1a \u6700\u7b80\u5355\u7684\u5feb\u901f\u7684\u5f00\u53d1\u65b9\u5f0f","text":"<p>JSON\u6a21\u578b\u4e4b\u5feb\u901f\u7279\u6027\uff1a </p> <ul> <li>\u6570\u636e\u5e93\u5f15\u64ce\u53ea\u9700\u8981\u5728\u4e00\u4e2a\u5b58\u50a8\u533a\u8bfb\u5199 </li> <li>\u53cd\u8303\u5f0f\u3001\u65e0\u5173\u8054\u7684\u7ec4\u7ec7\u6781\u5927\u4f18\u5316\u67e5\u8be2\u901f\u5ea6 </li> <li>\u7a0b\u5e8fAPI\u81ea\u7136\uff0c\u5f00\u53d1\u5feb\u901f </li> </ul>"},{"location":"mongo1/1mongodb_intro/#_2","title":"\u5feb\u901f\uff1a \u5feb\u901f\u54cd\u5e94\u4e1a\u52a1\u53d8\u5316","text":"<p>\u52a8\u6001\u589e\u52a0\u65b0\u5b57\u6bb5</p> <ul> <li>\u591a\u5f62\u6027: \u540c\u4e00\u4e2a\u96c6\u5408\u4e2d\u53ef\u4ee5\u5305\u542b\u4e0d\u540c\u5b57\u6bb5\uff08\u7c7b\u578b\uff09\u7684\u6587\u6863\u5bf9\u8c61 </li> <li>\u52a8\u6001\u6027\uff1b\u7ebf\u4e0a\u4fee\u6539\u6570\u636e\u6a21\u5f0f\uff0c\u4fee\u6539\u662f\u5e94\u7528\u4e0e\u6570\u636e\u5e93\u5747\u65e0\u987b\u4e0b\u7ebf </li> <li>\u636e\u6cbb\u7406\u652f\u6301\u4f7f\u7528: <code>JSON Schema</code>\u6765\u89c4\u8303\u6570\u636e\u6a21\u5f0f\u3002\u5728\u4fdd\u8bc1\u6a21\u5f0f\u7075\u6d3b\u52a8\u6001\u7684\u524d\u63d0\u4e0b\uff0c\u63d0\u4f9b\u6570\u636e\u6cbb\u7406\u80fd\u529b </li> </ul>"},{"location":"mongo1/1mongodb_intro/#mongodb","title":"MongoDB\u4f18\u52bf\uff1a \u539f\u751f\u7684\u9ad8\u53ef\u7528","text":"<ul> <li>Replica Set \u2014\u2014 2 to 50\u4e2a\u6210\u5458 </li> <li>\u81ea\u6062\u590d </li> <li>\u591a\u4e2d\uff0c\u81ea\u5bb9\u707e\u80fd\u529b </li> <li>\u6eda\u52a8\u670d\u52a1\u4e00\u6700\u5c0f\u5316\u670d\u52a1\u7ec8\u7aef </li> </ul>"},{"location":"mongo1/1mongodb_intro/#mongodb_1","title":"MongoDB\u4f18\u52bf\uff1a\u6a2a\u5411\u6269\u5c55\u80fd\u529b","text":"<ul> <li>\u9700\u8981\u7684\u65f6\u5019\u65e0\u7f1d\u6269\u5c55 </li> <li>\u5e94\u7528\u5168\u900f\u660e </li> <li>4\u591a\u79cd\u6570\u636e\u5206\u5e03\u7b56\u7565 </li> <li>\u8f7b\u677e\u652f\u6301TB\u4e00PB\u6570\u91cf\u7ea7 </li> </ul>"},{"location":"mongo1/1mongodb_intro/#13-mongodb","title":"1.3 MongoDB","text":"<p>\u5e94\u7528\u573a\u666f \u4ece\u76ee\u524d\u963f\u91cc\u4e91MongoDB\u4e91\u6570\u636e\u5e93\u4e0a\u7684\u7528\u6237\u770b\uff0cMongoDB\u7684\u5e94\u7528\u5df2\u7ecf\u6e17\u900f\u5230\u5404\u4e2a\u9886\u57df\uff1a </p> <ul> <li>\u6e38\u620f\u573a\u666f\uff0c\u4f7f\u7528MongoDB\u5b58\u8bf8\u65c5\u620f\u7528\u6237\u4fe1\u606f\uff0c\u7528\u6237\u7684\u88c5\u5907\u3001\u79ef\u5206\u7b49\u76f4\u63a5\u4ee5\u5185\u5d4c\u6587\u6863\u7684\u5f62\u5f0f\u5b58\u50a8\uff0c\u65b9\u4fbf\u67e5\u8be2\u3001\u66f4\u65b0\uff1b </li> <li>\u7269\u6d41\u573a\u666f\uff0c\u4f7f\u7528MongoDB\u5b58\u50a8\u8ba2\u5355\u4fe1\u606f\uff0c\u8ba2\u8983\u72b6\u6001\u5728\u8fd0\u9001\u8fc7\u7a0b\u4e2d\u4f1a\u4e0d\u65ad\u66f4\u65b0\uff0c\u4ee5MongoDB\u5185\u5d4c\u6570\u7ec4\u7684\u5f62\u5f0f\u6765\u5b58\u50a8\uff0c\u4e00\u6b21\u67e5\u8be2\u5c31\u80fd \u5c06\u8ba2\u5355\u6240\u6709\u7684\u53d8\u66f4\u8bfb\u53d6\u51fa\u6765\uff1b </li> <li>\u793e\u4ea4\u573a\u666f\uff0c\u4f7f\u7528MongoDB\u5b58\u50a8\u5b58\u50a8\u7528\u6237\u4fe1\u606f\uff0c\u4ee5\u53ca\u7528\u6237\u53d1\u8868\u7684\u670b\u53cb\u5708\u4fe1\u606f\uff0c\u901a\u8fc7\u5730\u7406\u4f4d\u7f6e\u7d22\u5f15\u5b9e\u73b0\u9644\u8fd1\u7684\u4eba\u3001\u5730\u70b9\u7b49\u529f\u80fd\uff1b </li> <li>\u7269\u8054\u7f51\u573a\u666f\uff0c\u4f7f\u7528MongoDB\u5b58\u50a8\u6240\u6709\u63a5\u5165\u7684\u667a\u80fd\u8bbe\u5907\u4fe1\u606f\uff0c\u4ee5\u53ca\u4e00\u8bbe\u5907\u6c47\u62a5\u7684\u65e5\u5fd7\u4fe1\u606f\uff0c\u5e76\u5bf9\u8fd9\u4e9b\u4fe1\u606f\u8fdb\u884c\u591a\u7ef4\u5ea6\u7684\u5206\u6790\uff1b </li> <li>\u89c6\u9891\u76f4\u64ad\uff0c\u4f7f\u7528MongoDB\u5b58\u50a8\u7528\u6237\u4fe1\u606f\u3001\u793c\u7269\u4fe1\u606f\u7b49\uff1b </li> <li>\u5927\u6570\u636e\u5e94\u7528\uff0c\u4f7f\u7528\u4e91\u6570\u636e\u5e93MongoDB\u4f5c\u4e3a\u5927\u6570\u636e\u7684\u4e91\u5b58\u50a8\u7cfb\u7edf\uff0c\u968f\u65f6\u8fdb\u884c\u6570\u636e\u63d0\u53d6\u5206\u6790\uff0c\u638c\u63e1\u884c\u4e1a\u52a8\u6001\u3002</li> </ul>"},{"location":"mongo1/1mongodb_intro/#mongodb_2","title":"\u5982\u4f55\u8003\u8651\u662f\u5426\u9009\u62e9MongoDB?","text":"<p>\u6ca1\u6709\u67d0\u4e2a\u4e1a\u52a1\u573a\u666f\u5fc5\u987b\u8981\u4f7f\u7528MongoDB\u624d\u80fd\u89e3\u51b3\uff0c\u4f46\u4f7f\u7528MongoDB\u901a\u5e38\u80fd\u8ba9\u4f60\u4ee5\u66f4\u4f4e\u7684\u6210\u672c\u89e3\u51b3\u95ee\u9898\u3002\u5982\u679c\u4f60\u4e0d\u6e05\u695a\u5f53\u524d\u4e1a\u52a1\u662f\u5426\u9002 \u5408\u4f7f\u7528MongoDB\uff0c\u53ef\u4ee5\u901a\u8fc7\u505a\u51e0\u9053\u9009\u62e9\u9898\u6765\u8f85\u52a9\u51b3\u7b56\u3002 </p> <p></p>"},{"location":"mongo1/2mongodb_install/","title":"2 MongoDB \u5feb\u901f\u5b89\u88c5","text":""},{"location":"mongo1/2mongodb_install/#21-linuxmongodb","title":"2.1 linux\u5b89\u88c5MongoDB \u73af\u5883\u51c6\u5907\uff1a","text":"<ul> <li>linux\u7cfb\u7edf\uff1acentos7 \u5b89\u88c5MongoDB\u793e\u533a\u7248 </li> </ul> <p>\u4e0b\u8f7dMongoDB Community Server \u4e0b\u8f7d\u5730\u5740\uff1a</p> <p>https://www.mongodb.com/try/download/community</p> <p></p> <pre><code>\uff03\u4e0b\u8f7dMongoDB\n\nsudo su\nwget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.4.13.tgz\n\ntar -zxvf mongodb-linux-x86_64-rhel70-4.4.13.tgz\n\ncd mongodb-linux-x86_64-rhel70-4.4.13\n</code></pre> <pre><code># cd tmp/mongodb-linux-x86_64-rhel70-4.4.13/bin\n# ./mongod --help\n</code></pre>"},{"location":"mongo1/2mongodb_install/#mongodb-server","title":"\u542f\u52a8MongoDB Server","text":"<pre><code># \u521b\u5efadbpath \u548c logpath \nmkdir -p /mongodb/data /mongodb/log \n\n# \u8fdb\u5165mongodb\u76ee\u5f55\uff0c\u542f\u52a8mongodb\u670d\u52a1 \nbin/mongod --port=27017 --dbpath=/mongodb/data  --logpath=/mongodb/log/mongodb.log --bind_ip=0.0.0.0 --fork \n</code></pre> <ul> <li><code>--dbpath</code>:\u6307\u5b9a\u6570\u636e\u6587\u4ef6\u5b58\u653e\u76ee\u5f55</li> <li><code>--logpath</code>:\u6307\u5b9a\u65e5\u5fd7\u6587\u4ef6\uff0c\u6ce8\u610f\u662f\u6307\u5b9a\u6587\u4ef6\u4e0d\u662f\u76ee\u5f55  </li> <li><code>--logappend</code>:\u4f7f\u7528\u8ffd\u52a0\u7684\u65b9\u5f0f\u8bb0\u5f55\u65e5\u5fd7 </li> <li><code>--port</code>\uff1a\u6307\u5b9a\u7aef\u53e3\uff0c\u9ed8\u8ba4\u4e3a27017</li> <li><code>--bind_ip</code>:\u9ed8\u8ba4\u53ea\u76d1\u542clocaihost\u7f51\u5361 </li> <li><code>--fork</code>:\u540e\u53f0\u542f\u52a8 </li> <li><code>--auth</code>:\u5f00\u542f\u8ba4\u8bc1\u6a21\u5f0f </li> </ul> <pre><code>[root@jabox bin]# ./mongod --port=27017 --dbpath=/mongodb/data  --logpath=/mongodb/log/mongodb.log --bind_ip=0.0.0.0 --fork\nabout to fork child process, waiting until server is ready for connections.\nforked process: 3087\nchild process started successfully, parent exiting\n</code></pre> <pre><code>./mongo\nMongoDB shell version v4.4.13\nconnecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb\nImplicit session: session { \"id\" : UUID(\"e688e93e-3a2a-4f13-9c38-c090a6b96762\") }\nMongoDB server version: 4.4.13\nWelcome to the MongoDB shell.\nFor interactive help, type \"help\".\nFor more comprehensive documentation, see\n    https://docs.mongodb.com/\nQuestions? Try the MongoDB Developer Community Forums\n    https://community.mongodb.com\n---\nThe server generated these startup warnings when booting:\n        2022-03-22T09:56:35.598+00:00: Access control is not enabled for the database. Read and write access to data and configuration is unrestricted\n        2022-03-22T09:56:35.598+00:00: You are running this process as the root user, which is not recommended\n        2022-03-22T09:56:35.599+00:00: /sys/kernel/mm/transparent_hugepage/enabled is 'always'. We suggest setting it to 'never'\n        2022-03-22T09:56:35.599+00:00: /sys/kernel/mm/transparent_hugepage/defrag is 'always'. We suggest setting it to 'never'\n        2022-03-22T09:56:35.599+00:00: Soft rlimits too low\n        2022-03-22T09:56:35.599+00:00:         currentValue: 1024\n        2022-03-22T09:56:35.599+00:00:         recommendedMinimum: 64000\n---\n---\n        Enable MongoDB's free cloud-based monitoring service, which will then receive and display\n        metrics about your deployment (disk utilization, CPU, operation statistics, etc).\n\n        The monitoring data will be available on a MongoDB website with a unique URL accessible to you\n        and anyone you share the URL with. MongoDB may use this information to make product\n        improvements and to suggest MongoDB products and deployment options to you.\n\n        To enable free monitoring, run the following command: db.enableFreeMonitoring()\n        To permanently disable this reminder, run the following command: db.disableFreeMonitoring()\n---\n\n&gt; show dbs\nadmin   0.000GB\nconfig  0.000GB\nlocal   0.000GB\n</code></pre> <p>\u5173\u95ed\u6570\u636e\u5e93</p> <pre><code>&gt; use admin\nswitched to db admin\n\ndb.shutdownServer()\nserver should be down...\n</code></pre>"},{"location":"mongo1/2mongodb_install/#_1","title":"\u73af\u5883\u53d8\u91cf\u542f\u52a8","text":"<pre><code>sudo -i\n\nvim .bash_profile\nexport MONGODATA=/mongodb/data \nexport MONGOHOME=/home/vagrant/tmp/mongodb-linux-x86_64-rhel70-4.4.13\nexport MONGOTOOL=/home/vagrant/tmp/mongodb-database-tools-rhel70-x86_64-100.5.2\nexport PATH=$MONGOHOME/bin:$MONGOTOOL/bin::$PATH:.\n\nsource .bash_profile\n</code></pre> <pre><code>[root]mongod --port=27017 --dbpath=/mongodb/data  --logpath=/mongodb/log/mongodb.log --bind_ip=0.0.0.0 --fork\n</code></pre> <pre><code>mongo\nMongoDB shell version v4.4.13\nconnecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb\nImplicit session: session { \"id\" : UUID(\"23fcb1a7-2a20-4f2b-8576-31643ae25961\") }\nMongoDB server version: 4.4.13\n\n&gt; show dbs\nadmin     0.000GB\nconfig    0.000GB\nlocal     0.000GB\n</code></pre>"},{"location":"mongo1/2mongodb_install/#_2","title":"\u5229\u7528\u914d\u7f6e\u6587\u4ef6\u542f\u52a8\u670d\u52a1","text":"<pre><code>mkdir /mongodb/conf/\n</code></pre> <p>\u7f16\u8f91<code>/mongodb/conf/mongo.conf</code>\u6587\u4ef6\uff0c\u5185\u5bb9\u5982\u4e0b</p> <p><code>vim /mongodb/conf/mongo.conf</code></p> <pre><code>systemLog:\n  destination: file\n  path: /mongodb/log/mongod.log    # log path\n  logAppend: true\nstorage:\n  dbPath: /mongodb/data #data directory\n  engine: wiredTiger\n  journal:\n    enabled: true\nnet:\n  bindIp: 0.0.0.0\n  port: 27017  #port\nprocessManagement:\n  fork: true\n</code></pre> <p>\u6ce8\u610f\uff1a\u4e00\u5b9a\u8981yaml\u683c\u5f0f </p> <p>\u542f\u52a8 mongod</p> <pre><code># ./mongod -f /mongodb/conf/mongo.conf\nabout to fork child process, waiting until server is ready for connections.\nforked process: 5618\nchild process started successfully, parent exiting\n</code></pre>"},{"location":"mongo1/2mongodb_install/#mongodb","title":"\u5173\u95edMongoDB\u670d\u52a1","text":"<p>\u65b9\u5f0f1:</p> <pre><code>mongod --port=27017 --dbpath=/mongodb/data --shutdown \n</code></pre> <pre><code># ./mongod --port=27017 --dbpath=/mongodb/data --shutdown\n{\"t\":{\"$date\":\"2022-03-22T10:48:58.873+00:00\"},\"s\":\"I\",  \"c\":\"CONTROL\",  \"id\":23285,   \"ctx\":\"main\",\"msg\":\"Automatically disabling TLS 1.0, to force-enable TLS 1.0 specify --sslDisabledProtocols 'none'\"}\n{\"t\":{\"$date\":\"2022-03-22T10:48:58.879+00:00\"},\"s\":\"W\",  \"c\":\"ASIO\",     \"id\":22601,   \"ctx\":\"main\",\"msg\":\"No TransportLayer configured during NetworkInterface startup\"}\n{\"t\":{\"$date\":\"2022-03-22T10:48:58.879+00:00\"},\"s\":\"I\",  \"c\":\"NETWORK\",  \"id\":4648601, \"ctx\":\"main\",\"msg\":\"Implicit TCP FastOpen unavailable. If TCP FastOpen is required, set tcpFastOpenServer, tcpFastOpenClient, and tcpFastOpenQueueSize.\"}\nkilling process with pid: 5618\n</code></pre> <p>\u65b9\u5f0f2</p> <p>\u8fdb\u5165mongo shell </p> <pre><code>&gt; use admin\nswitched to db admin      # \u5fc5\u987b\u5728admin\u5e93\u4f7f\u7528\n\ndb.shutdownServer()\nserver should be down...   # \u6210\u529f\u5173\u95edmongoDB\u670d\u52a1\n</code></pre>"},{"location":"mongo1/2mongodb_install/#22-mongo-shell","title":"2.2 Mongo Shell \u4f7f\u7528","text":"<p>\u662fMongoDB\u7684\u4ea4\u4e92\u5f0f<code>JavaScript Shell</code>\u754c\u9762\uff0c\u5b83\u4e3a\u7cfb\u7edf\u7ba1\u7406\u5458\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u754c\u9762\uff0c\u5e76\u4e3a\u5f00\u53d1\u4eba\u5458\u63d0\u4f9b\u4e86\u76f4\u63a5\u6d4b\u8bd5\u6570\u636e\u5e93\u67e5\u8be2\u548c\u64cd\u4f5c \u7684\u65b9\u6cd5\u3002 </p> <pre><code>mongo --port=27017 \n</code></pre> <ul> <li><code>--port</code>: \u6307\u5b9a\u5b9a\u7aef\u53e3\uff0c\u9ed8\u8ba4\u4e3a<code>27017</code> </li> <li><code>--host</code>: \u8fde\u63a5\u7684\u4e3b\u673a\u5730\u5740\uff0c\u9ed8\u8ba4\u4e3a<code>127.0.0.1</code> </li> </ul>"},{"location":"mongo1/2mongodb_install/#javascript","title":"JavaScript\u652f\u6301","text":"<p>mongo shell\u662f\u57fa\u4e8eJavaScript\u8bed\u6cd5\u7684rMongoDB\u4f7f\u7528\u4e86SpiderMonkey\u4f5c\u4e3a\u5176\u5185\u90e8javaScript\u89e3\u91ca\u5668\u5f15\u64ce\uff0c\u8fd9\u662f\u7531Mozilla\u5b98\u65b9\u63d0\u4f9b\u7684JavaScript\u5185\u6838\u89e3\u91ca\u5668\uff0c\u8be5\u89e3\u91ca\u5668\u4e5f\u88ab\u540c\u6837\u7528\u4e8e\u5927\u540d\u9f0e\u9f0e\u7684<code>Firefox</code>\u6d4f\u89c8\u5668\u4ea7\u54c1\u4e4b\u4e2d\u3002</p> <p>SpiderMonkey\u5bf9<code>ECMA Script</code>\u6807\u51c6\u517c\u5bb9\u6027\u975e\u5e38\u597d\uff0c\u53ef\u4ee5\u652f\u6301<code>ECMA Script 6</code>\u3002\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u547d\u4ee4JavaScript\u89e3\u91ca\u5668\u7684\u7248\u672c\uff1a </p> <pre><code>./mongo\n\n&gt; interpreterVersion()\nMozJS-60\n</code></pre> <p>\u6570\u636e\u5e93\u64cd\u4f5c</p> <pre><code>\uff03\u67e5\u770b\u6240\u6709\u5e93\nshow dbs\n\n\uff03\u5207\u6362\u5230\u6307\u5b9a\u6570\u636e\u5e93\uff0c\u4e0d\u5b58\u5728\u5219\u521b\u5efa \nuse test \n\n\uff03\u5220\u9664\u4e0e\u524d\u6570\u636e\u5e93 \ndb.dropDatabase() \n</code></pre> <p>\u96c6\u5408\u64cd\u4f5c</p> <pre><code># \u67e5\u770b\u6240\u6709\u96c6\u5408 \nshow collecdons \n\n\uff03\u521b\u5efa\u96c6\u5408 \ndb.createCollection ('emp\") \n\n\uff03\u5220\u9664\u96c6\u5408 \ndb.emp.drop() \n</code></pre> <p>\u521b\u5efa\u96c6\u5408\u8bed\u6cd5</p> <pre><code>db.createCollection(name, options) \n</code></pre> <p>Mongo Shell \u5e38\u7528\u547d\u4ee4</p> <p></p> <p>Options \u53c2\u6570</p> <p></p>"},{"location":"mongo1/2mongodb_install/#23","title":"2.3 \u5b89\u5168\u8ba4\u8bc1","text":""},{"location":"mongo1/2mongodb_install/#_3","title":"\u521b\u5efa\u7ba1\u7406\u5458\u8d26\u53f7","text":"<pre><code>\uff03\u8bbe\u7f6e\u7ba1\u7406\u5458\u7528\u6237\u540d\u5bc6\u7801\u9700\u8981\u5207\u6362\u5230admin\u5e93\nuse admin \n\n\uff03\u521b\u5efa\u7ba1\u7406\u5458\ndb.createUser({user:\"fox\", pwd:\"fox\", roles: [\"root\"] }) \n\nSuccessfully added user: { \"user\" : \"fox\", \"roles\" : [ \"root\" ] }\n\n# \u67e5\u770b\u6240\u6709\u7528\u6237\u4fe1\u606f \nshow users  \n\n{\n    \"_id\" : \"admin.fox\",\n    \"userId\" : UUID(\"8e6a0d0f-7204-4e94-b53f-c060b8b06a21\"),\n    \"user\" : \"fox\",\n    \"db\" : \"admin\",\n    \"roles\" : [\n        {\n            \"role\" : \"root\",\n            \"db\" : \"admin\"\n        }\n    ],\n    \"mechanisms\" : [\n        \"SCRAM-SHA-1\",\n        \"SCRAM-SHA-256\"\n    ]\n}\n\n&gt; db.auth(\"fox\",\"fox\")\n1\n\n# \u5220\u9664\u7528\u6237 \ndb.dropUser(\"fox\") \n</code></pre>"},{"location":"mongo1/2mongodb_install/#_4","title":"\u5e38\u7528\u6743\u9650","text":"<pre><code>{\n    \"role\" : \"__queryableBackup\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"__system\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"backup\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"clusterAdmin\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"clusterManager\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"clusterMonitor\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"dbAdmin\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"dbAdminAnyDatabase\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"dbOwner\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"enableSharding\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"hostManager\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"read\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"readAnyDatabase\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"readWrite\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"readWriteAnyDatabase\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"restore\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"root\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"userAdmin\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n{\n    \"role\" : \"userAdminAnyDatabase\",\n    \"db\" : \"admin\",\n    \"isBuiltin\" : true,\n    \"roles\" : [ ],\n    \"inheritedRoles\" : [ ]\n}\n</code></pre> <p>\u7528\u6237\u8ba4\u8bc1\uff0c\u8fd4\u56de1\u8868\u793a\u8ba4\u8bc1\u6210\u529f</p> <p></p>"},{"location":"mongo1/2mongodb_install/#_5","title":"\u521b\u5efa\u5e94\u7528\u6570\u636e\u5e93\u7528\u6237","text":"<pre><code>use appdb\n\ndb.createUser({user:\"appdb\", pwd:\"jack\", roles: [\"dbOwner\"] }) \n</code></pre> <pre><code>use appdb\nswitched to db appdb\n\ndb.createUser({user:\"appdb\", pwd:\"jack\", roles: [\"dbOwner\"] })\nSuccessfully added user: { \"user\" : \"appdb\", \"roles\" : [ \"dbOwner\" ] }\n</code></pre> <pre><code>&gt; use admin\nswitched to db admin\n\ndb.shutdownServer()\nserver should be down...\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cMongoDB\u4e0d\u4f1a\u542f\u7528\u9274\u6743\uff0c\u4ee5\u9274\u6743\u6a21\u5f0f\u542f\u52a8MongoDB</p> <pre><code># ./mongod -f /mongodb/conf/mongo.conf --auth\nabout to fork child process, waiting until server is ready for connections.\nforked process: 11967\nchild process started successfully, parent exiting\n</code></pre> <pre><code>./mongo localhost:27017 -u fox -p fox --authenticationDatabase=admin\n\nMongoDB shell version v4.4.13\nconnecting to: mongodb://localhost:27017/test?authSource=admin&amp;compressors=disabled&amp;gssapiServiceName=mongodb\nImplicit session: session { \"id\" : UUID(\"b964da45-44d2-41e1-a0f6-ce06eed70b9d\") }\nMongoDB server version: 4.4.13\n\nshow dbs\nadmin   0.000GB\nconfig  0.000GB\nlocal   0.000GB\n</code></pre> <pre><code>use appdb\n&gt; show users\n{\n    \"_id\" : \"appdb.appdb\",\n    \"userId\" : UUID(\"472c8289-e2c9-42e9-ae1d-63ead575fad8\"),\n    \"user\" : \"appdb\",\n    \"db\" : \"appdb\",\n    \"roles\" : [\n        {\n            \"role\" : \"dbOwner\",\n            \"db\" : \"appdb\"\n        }\n    ],\n    \"mechanisms\" : [\n        \"SCRAM-SHA-1\",\n        \"SCRAM-SHA-256\"\n    ]\n}\n\n./mongo localhost:27017 -u appdb -p jack --authenticationDatabase=appdb\n\nMongoDB shell version v4.4.13\nconnecting to: mongodb://localhost:27017/test?authSource=appdb&amp;compressors=disabled&amp;gssapiServiceName=mongodb\nImplicit session: session { \"id\" : UUID(\"ff0d8084-b915-4581-ae5a-cd203f061f9b\") }\nMongoDB server version: 4.4.13\n</code></pre>"},{"location":"mongo1/3mongodb_k8s_cluster/","title":"3 \u5728 Kubernetes \u4e0a\u7f16\u6392 MongoDB \u96c6\u7fa4","text":"<p>\u65e0\u72b6\u6001\u5e94\u7528\u5728 <code>Kubernetes</code> \u4e2d\u7684\u4f7f\u7528\u975e\u5e38\u65b9\u4fbf\uff0c\u4f46\u662f\u5bf9\u4e8e\u4e00\u4e9b\u6709\u72b6\u6001\u5e94\u7528\u90e8\u7f72\u8fd8\u662f\u76f8\u5bf9\u8f83\u9ebb\u70e6\uff0c\u867d\u7136\u4e5f\u6709\u5355\u72ec\u7684 StatefulSets \u8d44\u6e90\u5bf9\u8c61\u6765\u5904\u7406\u6709\u72b6\u6001\u5e94\u7528\uff0c\u4f46\u662f\u6bd5\u7adf\u4e0d\u5177\u6709\u901a\u7528\u6027\uff0c\u6709\u72b6\u6001\u5e94\u7528\u7684\u7f16\u6392\u548c\u5177\u4f53\u7684\u5e94\u7528\u606f\u606f\u76f8\u5173\uff0c\u6bd4\u5982 <code>MongoDB</code>\u3001<code>ElasticSearch</code>\u3001<code>Redis</code>\u3001<code>Zookeeper</code> \u7b49\u5e94\u7528\u3002\u6211\u4eec\u8fd9\u91cc\u4e0d\u518d\u5bf9 <code>StatefulSets</code> \u7684\u5177\u4f53\u4f7f\u7528\u5c55\u5f00\u4ecb\u7ecd\u4e86\uff0c\u5c06\u901a\u8fc7\u90e8\u7f72\u4e00\u4e2a\u53ef\u6269\u5c55\u7684 <code>MongoDB</code> \u96c6\u7fa4\u4e3a\u4f8b\u8fdb\u884c\u8bf4\u660e\u3002</p> <p></p> <p>\u9996\u5148\u6211\u4eec\u8fd0\u884c\u4e00\u4e2a <code>DaemonSet</code> \u7684\u63a7\u5236\u5668\u6765\u7ba1\u7406\u8282\u70b9\uff0c\u7981\u7528\u5de8\u9875\uff0c\u56e0\u4e3a MongoDB \u662f\u5efa\u8bae\u5173\u95ed\u6389 <code>Transparent Hugepage</code> \u7684\uff0c\u5426\u5219\u53ef\u80fd\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d\uff0c\u5185\u5b58\u9501\uff0c\u751a\u81f3\u7cfb\u7edf\u91cd\u542f\u7b49\u95ee\u9898\uff0c\u5f53\u7136\u6700\u597d\u7684\u8fd8\u662f\u53ea\u8c03\u6574 <code>MongoDB</code> \u7684 <code>Pod</code> \u6240\u5728\u7684\u8282\u70b9\uff1a</p> <p><code>hostvm-ds.yaml</code></p> <pre><code>apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: hostvm-configurer\n  labels:\n    app: startup-script\nspec:\n  selector:\n    matchLabels:\n      app: startup-script\n  template:\n    metadata:\n      labels:\n        app: startup-script\n    spec:\n      hostPID: true\n      containers:\n      - name: hostvm-configurer\n        image: cnych/startup-script:v1\n        securityContext:\n          privileged: true\n        env:\n        - name: STARTUP_SCRIPT\n          value: |\n            #! /bin/bash\n            set -o errexit\n            set -o pipefail\n            set -o nounset\n\n            # Disable hugepages\n            echo 'never' &gt; /sys/kernel/mm/transparent_hugepage/enabled\n            echo 'never' &gt; /sys/kernel/mm/transparent_hugepage/defrag\n</code></pre>"},{"location":"mongo1/3mongodb_k8s_cluster/#1dev","title":"1.Dev \u5b9e\u9a8c\u914d\u7f6e","text":"<p>\u7136\u540e\u914d\u7f6e <code>ServiceAccount</code>\u3001<code>NodePort SVC</code> \u548c <code>StatefulSet</code>\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <p><code>mongo.yaml</code></p> <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: mongo\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: mongo\n  namespace: mongo\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: mongo\nsubjects:\n  - kind: ServiceAccount\n    name: mongo\n    namespace: mongo\nroleRef:\n  kind: ClusterRole\n  name: cluster-admin\n  apiGroup: rbac.authorization.k8s.io\n---\napiVersion: v1\nkind: Service\nmetadata:\n name: mongo\n namespace: mongo\n labels:\n   name: mongo\nspec:\n  selector:\n   role: mongo\n  type: NodePort\n  ports:\n  - port: 27017\n    targetPort: 27017\n    nodePort: 32017\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mongo\n  namespace: mongo\nspec:\n  serviceName: mongo\n  replicas: 1\n  selector:\n    matchLabels:\n      role: mongo\n      environment: staging\n  template:\n    metadata:\n      labels:\n        role: mongo\n        environment: staging\n        replicaset: MainRepSet\n    spec:\n      affinity:\n        podAntiAffinity:  # \u6dfb\u52a0 Pod \u53cd\u4eb2\u548c\u6027\uff0c\u5c06\u526f\u672c\u6253\u6563\u5728\u4e0d\u540c\u7684\u8282\u70b9\n          preferredDuringSchedulingIgnoredDuringExecution:  # \u8f6f\u7b56\u7565\n          - weight: 100\n            podAffinityTerm:\n              labelSelector:\n                matchExpressions:\n                - key: replicaset\n                  operator: In\n                  values:\n                  - MainRepSet\n              topologyKey: kubernetes.io/hostname\n      terminationGracePeriodSeconds: 10\n      serviceAccountName: mongo\n      containers:\n        - name: mongo\n          image: mongo:4.0\n          command:\n            - mongod\n            - \"--wiredTigerCacheSizeGB\"\n            - \"0.25\"\n            - \"--bind_ip\"\n            - \"0.0.0.0\"\n            - \"--replSet\"\n            - MainRepSet\n            - \"--smallfiles\"\n            - \"--noprealloc\"\n          ports:\n            - containerPort: 27017\n          volumeMounts:\n            - name: mongo-data\n              mountPath: /data/db\n          resources:\n            requests:\n              cpu: 1\n              memory: 2Gi\n        - name: mongo-sidecar\n          image: cvallance/mongo-k8s-sidecar\n          env:\n            - name: MONGO_SIDECAR_POD_LABELS\n              value: \"role=mongo,environment=staging\"\n            - name: KUBE_NAMESPACE\n              value: \"mongo\"\n            - name: KUBERNETES_MONGO_SERVICE_NAME\n              value: \"mongo\"\n  volumeClaimTemplates:\n  - metadata:\n      name: mongo-data\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: hostpath  # \u63d0\u4f9b\u4e00\u4e2a\u53ef\u7528\u7684 Storageclass\n      resources:\n        requests:\n          storage: 2Gi\n</code></pre> <p>\u8fd9\u91cc\u6211\u4eec\u7ed9 <code>Mongo</code> \u7684 <code>Pod</code> \u6dfb\u52a0\u4e86\u4e00\u4e2a <code>sidecar</code> \u5bb9\u5668\uff0c\u4e3b\u8981\u7528\u4e8e\u526f\u672c\u96c6\u7684\u914d\u7f6e\uff0c\u8be5 <code>sidecar</code> \u4f1a\u6bcf5s\u68c0\u67e5\u4e00\u6b21\u65b0\u6210\u5458\u3002\u901a\u8fc7\u51e0\u4e2a\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u6307\u5b9a\u4e86 <code>Pod</code> \u7684\u6807\u7b7e\u3001\u547d\u540d\u7a7a\u95f4\u548c <code>Service</code>\u3002 \u4e3a\u4e86\u4fdd\u8bc1\u5e94\u7528\u7684\u7a33\u5b9a\u6027\uff0c\u6211\u4eec\u901a\u8fc7 <code>podAntiAffinity</code> \u6307\u5b9a\u4e86 <code>Pod</code> \u7684\u53cd\u4eb2\u548c\u6027\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u4e0d\u4f1a\u6709\u4e24\u4e2a\u526f\u672c\u51fa\u73b0\u5728\u540c\u4e00\u4e2a\u8282\u70b9\u4e0a\u3002</p> <p>\u6b64\u5916\u9700\u8981\u63d0\u4f9b\u4e00\u4e2a\u53ef\u7528\u7684 <code>StorageClass</code>\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u4e0d\u540c\u7684\u526f\u672c\u6570\u636e\u6301\u4e45\u5316\u5230\u4e0d\u540c\u7684 PV\u3002</p> <p>\u76f4\u63a5\u8fd0\u884c\u4e0a\u9762\u7684\u4e24\u4e2a\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5373\u53ef\uff1a</p> <pre><code>\n$ kubectl apply -f hostvm-ds.yaml\n$ kubectl apply -f mongo.yaml\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u68c0\u67e5\u5e94\u7528\u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code> kubectl get all -n mongo \nNAME          READY   STATUS    RESTARTS   AGE\npod/mongo-0   2/2     Running   0          14h\n\nNAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)           AGE\nservice/mongo   NodePort   10.99.236.50   &lt;none&gt;        27017:32017/TCP   14h\n\nNAME                     READY   AGE\nstatefulset.apps/mongo   1/1     14h\n</code></pre> <p>\u6211\u8fd9\u91cc\u672c\u5730\u662f <code>Mac</code>\u7cfb\u7edf\uff0c\u4f7f\u7528\u7684\u662f Robo 3T \u4f5c\u4e3a <code>mongo</code> \u5ba2\u6237\u7aef\uff0c\u8fde\u63a5\u5230\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\u5e76\u8fd0\u884c <code>rs.status()</code> \u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u526f\u672c\u96c6\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c</p> <p></p>"},{"location":"mongo1/3mongodb_k8s_cluster/#pod-mongodb","title":"\u767b\u5f55pod \u53bb\u8fd0\u884c mongoDB","text":"<pre><code>show dbs\n2022-03-22T04:09:39.789+0000 E QUERY    [js] Error: listDatabases failed:{\n        \"ok\" : 0,\n        \"errmsg\" : \"not master and slaveOk=false\",\n        \"code\" : 13435,\n        \"codeName\" : \"NotMasterNoSlaveOk\"\n} :\n_getErrorWithCode@src/mongo/shell/utils.js:25:13\nMongo.prototype.getDBs@src/mongo/shell/mongo.js:151:1\nshellHelper.show@src/mongo/shell/utils.js:882:13\nshellHelper@src/mongo/shell/utils.js:766:15\n@(shellhelp2):1:1\n</code></pre> <pre><code>&gt; rs.slaveOk();\nWARNING: slaveOk() is deprecated and may be removed in the next major release. Please use secondaryOk() instead.\n</code></pre> <p>\u6216\u8005\u4f7f\u7528 </p> <pre><code>&gt; secondaryOk()\n2022-03-22T04:02:22.293+0000 E QUERY    [js] ReferenceError: secondaryOk is not defined :\n@(shell):1:1\n</code></pre> <p><code>rs.initiate()</code></p> <pre><code>&gt; rs.initiate()\n{\n        \"info2\" : \"no configuration specified. Using a default configuration for the set\",\n        \"me\" : \"mongo-0:27017\",\n        \"ok\" : 1\n}\n</code></pre> <p><code>MainRepSet:OTHER&gt; show dbs</code></p>"},{"location":"mongo1/3mongodb_k8s_cluster/#stage-prod","title":"Stage-Prod \u914d\u7f6e","text":"<p>\u7136\u540e\u914d\u7f6e ServiceAccount\u3001Headless SVC \u548c StatefulSet\uff0c\u8d44\u6e90\u6e05\u5355\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code># mongo.yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: mongo\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: mongo\n  namespace: mongo\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: mongo\nsubjects:\n  - kind: ServiceAccount\n    name: mongo\n    namespace: mongo\nroleRef:\n  kind: ClusterRole\n  name: cluster-admin\n  apiGroup: rbac.authorization.k8s.io\n---\napiVersion: v1\nkind: Service\nmetadata:\n name: mongo\n namespace: mongo\n labels:\n   name: mongo\nspec:\n ports:\n - port: 27017\n   targetPort: 27017\n clusterIP: None\n selector:\n   role: mongo\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mongo\n  namespace: mongo\nspec:\n  serviceName: mongo\n  replicas: 3\n  selector:\n    matchLabels:\n      role: mongo\n      environment: staging\n  template:\n    metadata:\n      labels:\n        role: mongo\n        environment: staging\n        replicaset: MainRepSet\n    spec:\n      affinity:\n        podAntiAffinity:  # \u6dfb\u52a0 Pod \u53cd\u4eb2\u548c\u6027\uff0c\u5c06\u526f\u672c\u6253\u6563\u5728\u4e0d\u540c\u7684\u8282\u70b9\n          preferredDuringSchedulingIgnoredDuringExecution:  # \u8f6f\u7b56\u7565\n          - weight: 100\n            podAffinityTerm:\n              labelSelector:\n                matchExpressions:\n                - key: replicaset\n                  operator: In\n                  values:\n                  - MainRepSet\n              topologyKey: kubernetes.io/hostname\n      terminationGracePeriodSeconds: 10\n      serviceAccountName: mongo\n      containers:\n        - name: mongo\n          image: mongo:4.0\n          command:\n            - mongod\n            - \"--wiredTigerCacheSizeGB\"\n            - \"0.25\"\n            - \"--bind_ip\"\n            - \"0.0.0.0\"\n            - \"--replSet\"\n            - MainRepSet\n            - \"--smallfiles\"\n            - \"--noprealloc\"\n          ports:\n            - containerPort: 27017\n          volumeMounts:\n            - name: mongo-data\n              mountPath: /data/db\n          resources:\n            requests:\n              cpu: 1\n              memory: 2Gi\n        - name: mongo-sidecar\n          image: cvallance/mongo-k8s-sidecar\n          env:\n            - name: MONGO_SIDECAR_POD_LABELS\n              value: \"role=mongo,environment=staging\"\n            - name: KUBE_NAMESPACE\n              value: \"mongo\"\n            - name: KUBERNETES_MONGO_SERVICE_NAME\n              value: \"mongo\"\n  volumeClaimTemplates:\n  - metadata:\n      name: mongo-data\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      storageClassName: hostpath  # \u63d0\u4f9b\u4e00\u4e2a\u53ef\u7528\u7684 Storageclass\n      resources:\n        requests:\n          storage: 10Gi\n</code></pre> <pre><code>$ kubectl apply -f hostvm-ds.yaml\n$ kubectl apply -f mongo.yaml\n</code></pre> <p>\u90e8\u7f72\u5b8c\u6210\u540e\u53ef\u4ee5\u901a\u8fc7\u5982\u4e0b\u547d\u4ee4\u68c0\u67e5\u5e94\u7528\u8fd0\u884c\u72b6\u6001\uff1a</p> <pre><code>$ kubectl -n mongo get all\nkubectl -n mongo get all\nNAME          READY   STATUS              RESTARTS   AGE\npod/mongo-0   2/2     Running             0          28m\npod/mongo-1   2/2     Running             0          23m\npod/mongo-2   2/2     Running             0          16m\n\nNAME            TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)     AGE\nservice/mongo   ClusterIP   None         &lt;none&gt;        27017/TCP   51m\n\nNAME                     READY   AGE\nstatefulset.apps/mongo   3/3     28m\n</code></pre> <p>\u7531\u4e8e\u6211\u4eec\u8fd9\u91cc\u7684 Service \u662f\u65e0\u5934\u670d\u52a1\uff0c\u6ca1\u6709 ClusterIP\uff0c\u4e5f\u6ca1\u6709 ExternalIP\uff0c\u8fd9\u4e2a Service \u4f1a\u76f4\u63a5\u89e3\u6790\u5230 Pod \u7684 IP \u5217\u8868\uff0c\u5f53\u5e94\u7528\u5b8c\u5168\u90e8\u7f72\u5230 Kubernetes \u96c6\u7fa4\u4e0a\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6309\u7167\u4e0d\u540c\u7684\u8282\u70b9\u6765\u8fdb\u884c\u8bbf\u95ee\u4e86\uff1a</p> <pre><code>Node-0: mongo-0.mongo.mongo.svc.cluster.local:27017\nNode-1: mongo-1.mongo.mongo.svc.cluster.local:27017\nNode-2: mongo-2.mongo.mongo.svc.cluster.local:27017\n</code></pre> <p>\u5f53\u7136\u5982\u679c\u60f3\u4ece\u96c6\u7fa4\u5916\u90e8\u8bbf\u95ee mongo\uff0c\u53ef\u4ee5\u4e3a\u8fd9\u4e9b Pod \u90e8\u7f72\u4e00\u4e9b\u5185\u90e8\u7684\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u6216\u8005\u4f7f\u7528 nginx-ingress\u3001traefik \u8fd9\u4e9b Ingress \u63a7\u5236\u5668\u6765\u521b\u5efa Ingress \u66b4\u9732\u51fa\u53bb\u3002</p> <p>\u6211\u4eec\u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e86 Traefik v2.2 \u7248\u672c\uff0c\u8be5\u7248\u672c\u662f\u652f\u6301 TCP \u670d\u52a1\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u521b\u5efa\u4e00\u4e2a\u5982\u4e0b\u6240\u793a\u7684 <code>IngressRoute</code> \u5bf9\u8c61\u6765\u66b4\u9732 <code>mongo</code> \u670d\u52a1\uff1a</p> <pre><code># ingressroute-tcp.yaml\napiVersion: traefik.containo.us/v1alpha1\nkind: IngressRouteTCP\nmetadata:\n  name: mongo\n  namespapce: mongo\nspec:\n  entryPoints:\n  - mongo  # \u9700\u8981\u901a\u8fc7\u9759\u6001\u65b9\u5f0f\u5f00\u542f mongo \u7684\u5165\u53e3\u70b9\n  routes:\n  - match: HostSNI(`*`)\n    services:\n    - name: mongo\n      port: 27017\n</code></pre> <p>\u7531\u4e8e Traefik \u66b4\u9732 TCP \u670d\u52a1\u9700\u8981 SNI \u7684\u652f\u6301\uff0c\u6211\u4eec\u8fd9\u91cc\u6ca1\u6709\u6307\u5b9a\u7279\u5b9a\u7684\u57df\u540d\uff0c\u6240\u4ee5\u9700\u8981\u901a\u8fc7\u4e00\u4e2a\u4e13\u95e8\u7684\u5165\u53e3\u70b9 mongo \u6765\u66b4\u9732\uff0c\u9700\u8981\u5728 Traefik \u4e2d\u58f0\u660e\u5e76\u5f00\u542f\u8fd9\u4e2a\u5165\u53e3\u70b9\uff0c\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u8fd9\u6837\u9759\u6001\u914d\u7f6e\uff1a</p> <pre><code>......\n- name: mongo\n  containerPort: 27017\n  hostPort: 27017\nargs:\n- --entryPoints.mongo.address=:27017\n......\n</code></pre> <p>\u76f4\u63a5\u8fd0\u884c\u4e0a\u9762\u7684 IngressRouteTCP \u5bf9\u8c61\u5373\u53ef\uff1a</p> <pre><code>$ kubectl apply -f ingressroute-tcp.yaml -n mongo\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5e94\u7528\u7a0b\u5e8f\u81f3\u5c11\u8981\u77e5\u9053\u4e00\u4e2a\u5f53\u524d\u6b63\u5728\u8fd0\u884c\u7684 mongo \u8282\u70b9\uff0c\u8fd9\u6837\u624d\u53ef\u4ee5\u53d1\u73b0\u6240\u6709\u5176\u4ed6\u8282\u70b9\u3002</p> <p>\u6211\u8fd9\u91cc\u672c\u5730\u662f Mac \u7cfb\u7edf\uff0c\u4f7f\u7528\u7684\u662f Robo 3T \u4f5c\u4e3a mongo \u5ba2\u6237\u7aef\uff0c\u8fde\u63a5\u5230\u5176\u4e2d\u4e00\u4e2a\u8282\u70b9\u5e76\u8fd0\u884c <code>rs.status()</code> \u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u67e5\u770b\u5230\u526f\u672c\u96c6\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5e76\u68c0\u67e5\u5176\u4ed6\u4e24\u4e2a Pod \u662f\u5426\u88ab\u914d\u7f6e\u5e76\u81ea\u52a8\u8fde\u63a5\u5230\u526f\u672c\u96c6\u4e0a\u3002</p> <p></p> <p>\u5728\u6210\u5458\u5217\u8868\u4e2d\u4e5f\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a\u6210\u5458\u7684 FQDN \u540d\u79f0\u548c\u72b6\u6001\uff0c\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f FQDN \u53ea\u80fd\u5728 Kubernetes \u96c6\u7fa4\u5185\u90e8\u8bbf\u95ee\uff1a</p> <p></p> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5bf9 Mongo \u8fdb\u884c\u6269\u5bb9\uff0c\u4ee5\u68c0\u67e5\u65b0\u7684 Pod \u662f\u5426\u88ab\u6dfb\u52a0\u5230\u526f\u672c\u96c6\u4e2d\u53bb\uff1a</p> <pre><code>$ kubectl -n mongo scale statefulsets mongo --replicas=4\nstatefulset.apps/mongo scaled\n$ kubectl -n mongo get pods -o wide\nNAME      READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES\nmongo-0   2/2     Running   0          32m     10.244.8.29    ydzs-node6   &lt;none&gt;           &lt;none&gt;\nmongo-1   2/2     Running   0          27m     10.244.7.175   ydzs-node5   &lt;none&gt;           &lt;none&gt;\nmongo-2   2/2     Running   0          20m     10.244.2.175   ydzs-node2   &lt;none&gt;           &lt;none&gt;\nmongo-3   2/2     Running   0          4m29s   10.244.3.95    ydzs-node3   &lt;none&gt;           &lt;none&gt;\n</code></pre> <p>\u7531\u4e8e\u4e0a\u9762\u6211\u4eec\u914d\u7f6e\u4e86 Pod \u7684\u53cd\u4eb2\u548c\u6027\uff0c\u4f46\u662f\u662f\u8f6f\u7b56\u7565\uff0c\u6240\u4ee54\u4e2a Pod \u4f1a\u7ecf\u91cf\u5206\u6563\u5230\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\u3002\u6269\u5bb9\u540e\u540c\u6837\u65b0\u7684 Pod \u4e5f\u4f1a\u81ea\u52a8\u63d0\u4f9b\u4e00\u4e2a\u6301\u4e45\u5238\uff1a</p> <pre><code>$ kubectl -n mongo get pvc\nNAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE\nmongo-data-mongo-0   Bound    pvc-ac306842-f6a9-413c-bf92-576dd6a3b092   10Gi       RWO            rook-ceph-block   56m\nmongo-data-mongo-1   Bound    pvc-d319e5d2-ac99-4a2b-898c-feb4bdf0f256   10Gi       RWO            rook-ceph-block   27m\nmongo-data-mongo-2   Bound    pvc-fc8ded1d-0649-4b64-963e-0b9e2fc1f27d   10Gi       RWO            rook-ceph-block   21m\nmongo-data-mongo-3   Bound    pvc-762b4b91-432e-4409-8d8f-e3e809d6a159   10Gi       RWO            rook-ceph-block   4m51s\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u518d\u53bb<code>Robo 3T</code> \u5ba2\u6237\u7aef\u91cd\u65b0\u6267\u884c <code>rs.status()</code>\u68c0\u67e5\u65b0\u7684 <code>Pod</code>  \u662f\u5426\u88ab\u6dfb\u52a0\u5230\u526f\u672c\u96c6\u4e2d\u4e86\uff1a</p> <p></p> <p>\u65b0\u589e\u7684 Pod \u4e0e\u4e4b\u524d\u7684\u6210\u5458\u90fd\u91c7\u7528\u76f8\u540c\u7684 FQDN \u65b9\u6848\uff0c\u5e76\u540c\u6b65\u5230\u540c\u4e00\u4e2a Primary \u8282\u70b9\u53bb\u3002</p> <p></p> <p>\u5230\u8fd9\u91cc\u6211\u4eec\u5c31\u6210\u529f\u5730\u5c06 MongoDB \u90e8\u7f72\u5230\u4e86 Kubernetes \u96c6\u7fa4\uff0c\u800c\u4e14\u8fd8\u662f\u53ef\u4f38\u7f29\u7684\u3002\u540e\u7eed\u6211\u4eec\u8fd8\u53ef\u4ee5\u8003\u8651\u9488\u5bf9\u5e94\u7528\u90e8\u7f72 VPA\uff0c\u6216\u8005\u589e\u52a0\u4e00\u4e9b\u7f51\u7edc\u7b56\u7565\u6216 Istio \u6765\u63a7\u5236\u5e94\u7528\uff0c\u5f53\u7136\u8fd9\u79cd\u65b9\u5f0f\u6574\u4f53\u6765\u8bf4\u662f\u53ef\u884c\u7684\uff0c\u4f46\u662f\u53ef\u7ef4\u62a4\u6027\u8fd8\u4e0d\u662f\u975e\u5e38\u9ad8\uff0c\u5982\u679c\u53ef\u4ee5\uff0c\u6211\u4eec\u5e94\u8be5\u53bb\u6839\u636e\u81ea\u5df1\u7684\u4e1a\u52a1\u9700\u6c42\u5f00\u53d1\u5bf9\u5e94\u7684 Operator\uff0c\u6216\u8005\u4f7f\u7528\u7b2c\u4e09\u65b9\u9ad8\u8d28\u91cf\u7684 Operator \u6765\u7f16\u6392 MongoDB\u3002</p>"},{"location":"mongo1/4mongodb_opt/","title":"4. MongoDB\u6587\u6863\u64cd\u4f5c","text":""},{"location":"mongo1/4mongodb_opt/#41","title":"4.1 \u63d2\u5165\u6587\u6863","text":"<p>3.2 \u7248\u672c\u4e4b\u540e\u65b0\u589e\u4e86<code>db.collection.insertOne()</code>\u548c<code>db.collection.insertMany()</code></p>"},{"location":"mongo1/4mongodb_opt/#_1","title":"\u65b0\u589e\u5355\u4e2a\u6587\u6863","text":"<ul> <li>InsertOne\uff1a\u652f\u6301 <code>writeConcern</code></li> </ul> <pre><code>db.collection.insertOne(\n    &lt;document&gt;, \n    { \n        writeConcern: &lt;document&gt; \n    } \n) \n</code></pre> <p>writeConcern \u51b3\u5b9a\u4e00\u4e2a\u5199\u64cd\u4f5c\u843d\u5230\u591a\u5c11\u4e2a\u8282\u70b9\u4e0a\u624d\u7b97\u6210\u529f\u3002writeConcern\u7684\u53d6\u503c\u5305\u62ec\uff1a</p> <p>0: \u53d1\u8d77\u5199\u64cd\u4f5c\uff0c\u4e0d\u5173\u5fc3\u662f\u5426\u6210\u529f\uff1b </p> <p>1\u4e00 \u96c6\u7fa4\u6700\u5927\u6570\u636e\u8282\u70b9\u6570\uff1a\u5199\u64cd\u4f5c\u9700\u8981\u88ab\u590d\u5236\u5230\u6307\u5b9a\u8282\u70b9\u6570\u624d\u7b97\u6210\u529f\uff1b </p> <p>majority\uff1a\u5199\u64cd\u4f5c\u9700\u8981\u88ab\u590d\u5236\u5230\u5927\u591a\u6570\u8282\u70b9\u4e0a\u624d\u7b97\u6210\u529f\u3002 </p> <ul> <li>insert: \u82e5\u63d2\u5165\u7684\u6570\u636e\u4e3b\u952e\u5df2\u7ecf\u5b58\u5728\uff0c\u5219\u4f1a\u629b<code>DuplicateKeyException</code>\u5f02\u5e38\uff0c\u63d0\u793a\u4e3b\u952e\u91cd\u590d\uff0c\u4e0d\u4fdd\u5b58\u5f53\u524d\u6570\u636e\u3002 </li> <li>save\uff1a\u5982\u679c<code>_id</code>\u4e3b\u952e\u5b58\u5728\u5219\u66f4\u65b0\u6570\u636e\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u5c31\u63d2\u5165\u6570\u636e\u3002 </li> </ul> <pre><code>cd tmp/mongodb/bin\n</code></pre> <pre><code>&gt; use appdb\nswitched to db appdb\n\n&gt; db.emps.save({x:1})\nWriteResult({ \"nInserted\" : 1 })\n\n&gt; db.emps.save({x:2})\nWriteResult({ \"nInserted\" : 1 })\n\n&gt; db.emps.insert({x:3})\nWriteResult({ \"nInserted\" : 1 })\n\n&gt; db.emps.insertOne({x:3})\n{\n    \"acknowledged\" : true,\n    \"insertedId\" : ObjectId(\"623af68d22bf9364d532766e\")\n}\n\n&gt; db.emps.find()\n{ \"_id\" : ObjectId(\"623af5ed22bf9364d532766b\"), \"x\" : 1 }\n{ \"_id\" : ObjectId(\"623af5f622bf9364d532766c\"), \"x\" : 2 }\n{ \"_id\" : ObjectId(\"623af62622bf9364d532766d\"), \"x\" : 3 }\n{ \"_id\" : ObjectId(\"623af68d22bf9364d532766e\"), \"x\" : 3 }\n</code></pre> <pre><code>&gt; db.user.insert({\"name\":\"jacob\"})\nWriteResult({ \"nInserted\" : 1 })\n\n\n&gt; db.user.find()\n{ \"_id\" : ObjectId(\"623af9c722bf9364d532766f\"), \"name\" : \"jacob\" }\n\ndb.user.insert({\"name\":\"jacob\", \"age\":\"31\"})\n\n&gt; db.user.find()\n{ \"_id\" : ObjectId(\"623af9c722bf9364d532766f\"), \"name\" : \"jacob\" }\n{ \"_id\" : ObjectId(\"623af9ff22bf9364d5327670\"), \"name\" : \"jacob\", \"age\" : \"31\" }\n\n&gt; db.user.insertMany([{\"name\":\"jack\", \"age\":\"30\"}, {\"name\":\"christine\", \"age\":\"28\"}])\n{\n    \"acknowledged\" : true,\n    \"insertedIds\" : [\n        ObjectId(\"623afa4a22bf9364d5327671\"),\n        ObjectId(\"623afa4a22bf9364d5327672\")\n    ]\n}\n\n&gt; db.user.find()\n{ \"_id\" : ObjectId(\"623af9c722bf9364d532766f\"), \"name\" : \"jacob\" }\n{ \"_id\" : ObjectId(\"623af9ff22bf9364d5327670\"), \"name\" : \"jacob\", \"age\" : \"31\" }\n{ \"_id\" : ObjectId(\"623afa4a22bf9364d5327671\"), \"name\" : \"jack\", \"age\" : \"30\" }\n{ \"_id\" : ObjectId(\"623afa4a22bf9364d5327672\"), \"name\" : \"christine\", \"age\" : \"28\" }\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_2","title":"\u6279\u91cf\u65b0\u589e\u6587\u6863","text":"<ul> <li><code>insertMany</code>\uff1a\u5411\u6307\u5b9a\u96c6\u5408\u4e2d\u63d2\u5165\u591a\u6761\u6587\u6863\u6570\u636e </li> </ul> <pre><code>db.collection.insertMany(\n    [ &lt;document 1&gt; &lt;document 2&gt;, ...], \n    {\n        writeConcern: &lt;document&gt;, \n        ordered: &lt;boolean&gt;\n    }\n) \n</code></pre> <ul> <li>writeConcern\uff1a\u5199\u5165\u7b56\u7565\uff0c\u9ed8\u8ba4\u4e3a 1, \u5373\u8981\u6c42\u786e\u8ba4\u5199\u64cd\u4f5c\uff0c0\u662f\u4e0d\u8981\u6c42\u3002 </li> <li>ordered\uff1a\u6307\u5b9a\u662f\u5426\u6309\u987a\u5e8f\u5199\u5165\uff0c\u9ed8\u8ba4true\uff0c\u6309\u987a\u5e8f\u5199\u5165\u3002</li> <li>insert\u548csave\u4e5f\u53ef\u4ee5\u5b9e\u73b0\u6279\u91cf\u63d2\u5165 </li> </ul> <pre><code>&gt; db.emps.insert([{x:3},{y:5}])\nBulkWriteResult({\n    \"writeErrors\" : [ ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 2,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\n</code></pre> <pre><code>&gt; db.emps.save([{x:3, y:0},{y:5, z:7}])\nBulkWriteResult({\n    \"writeErrors\" : [ ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 2,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\n</code></pre> <pre><code>&gt; db.emps.insertMany([{x:3, y:0},{y:5, z:7}])\n{\n    \"acknowledged\" : true,\n    \"insertedIds\" : [\n        ObjectId(\"623afead22bf9364d5327678\"),\n        ObjectId(\"623afead22bf9364d5327679\")\n    ]\n}\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_3","title":"\u6d4b\u8bd5\uff1a","text":"<p>\u6279\u91cf\u63d2\u516550\u6761\u968f\u673a\u6570\u636e \u7f16\u8f91\u811a\u672cbook.js </p> <pre><code>var tags = [\"nosql\",\"mongodb\",\"document\",\"developer\",\"popular\"]; \nvar types = [\"technology\",\"sociality\",\"travel\",\"novel\",\"literature\"]; \nvar books=[]; \nfor(var i=0;i&lt;50;i++){ \n    var typeIdx = Math.floor(Math.random()*types.length); \n    var tagIdx = Math.floor(Math.random()*tags.length); \n    var favCount = Math.floor(Math.random()-100);\n    var book = { \n        title: \"book-\" +i, \n        type: types[typeIdx], \n        tag: tags[tagIdx], \n        favCount: favCount, \n        author: \"xxx\"+i \n    };\n    books.push(book)\n} \ndb.books.insertMany(books); \n</code></pre> <p><code>vim book.js</code></p> <pre><code>[root@jabox bin]# ./mongo localhost:27017 -u appdb -p jack --authenticationDatabase=appdb\nMongoDB shell version v4.4.13\nconnecting to: mongodb://localhost:27017/test?authSource=appdb&amp;compressors=disabled&amp;gssapiServiceName=mongodb\nImplicit session: session { \"id\" : UUID(\"71e14edf-9b18-4acd-9a47-8f40178950b9\") }\nMongoDB server version: 4.4.13\n&gt; use appdb\nswitched to db appdb\n\n&gt; load(\"book.js\")\ntrue\n\n&gt; pwd()\n/home/vagrant/tmp/mongodb-linux-x86_64-rhel70-4.4.13/bin\n\n</code></pre> <pre><code>&gt; db.books.find()\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e75\"), \"title\" : \"book-0\", \"type\" : \"novel\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx0\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e76\"), \"title\" : \"book-1\", \"type\" : \"literature\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx1\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e77\"), \"title\" : \"book-2\", \"type\" : \"sociality\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx2\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e78\"), \"title\" : \"book-3\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx3\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e79\"), \"title\" : \"book-4\", \"type\" : \"literature\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx4\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7a\"), \"title\" : \"book-5\", \"type\" : \"technology\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx5\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7b\"), \"title\" : \"book-6\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx6\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7c\"), \"title\" : \"book-7\", \"type\" : \"travel\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx7\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7d\"), \"title\" : \"book-8\", \"type\" : \"sociality\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx8\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7e\"), \"title\" : \"book-9\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx9\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e80\"), \"title\" : \"book-11\", \"type\" : \"literature\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx11\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e81\"), \"title\" : \"book-12\", \"type\" : \"novel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx12\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e82\"), \"title\" : \"book-13\", \"type\" : \"sociality\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx13\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e83\"), \"title\" : \"book-14\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx14\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e84\"), \"title\" : \"book-15\", \"type\" : \"sociality\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx15\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e85\"), \"title\" : \"book-16\", \"type\" : \"travel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx16\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e86\"), \"title\" : \"book-17\", \"type\" : \"travel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx17\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e87\"), \"title\" : \"book-18\", \"type\" : \"sociality\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx18\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e88\"), \"title\" : \"book-19\", \"type\" : \"travel\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx19\" }\nType \"it\" for more\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#32","title":"3.2 \u67e5\u8be2\u6587\u6863","text":"<p><code>find</code> \u67e5\u8be2\u96c6\u5408\u4e2d\u7684\u82e5\u5e72\u6587\u6863\u3002\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\uff1a </p> <pre><code>db.collection.find(query, projection)\n</code></pre> <p>\u9009\u62e9\u8bed\u8a00 </p> <ul> <li>query\uff1a\u53ef\u9009, \u4f7f\u7528\u67e5\u8be2\u64cd\u4f5c\u7b26\u6307\u5b9a\u67e5\u8be2\u6761\u4ef6 </li> <li>projection: \u53ef\u9009\uff0c\u4f7f\u7528\u6295\u5f71\u64cd\u4f5c\u7b26\u6307\u5b9a\u8fd4\u56de\u7684\u952e\u3002 \u67e5\u8be2\u65f6\u8fd4\u56de\u6587\u6863\u4e2d\u6240\u6709\u952e\u503c\uff0c\u53ea\u9700\u7701\u7565\u8be5\u53c2\u6570\u5373\u53ef\uff08\u9ed8\u8ba4\u7701\u7565\uff09\u3002\u6295\u5f71\u65f6\uff0cId\u4e3a1\u7684\u65f6\u5019\uff0c \u5176\u4ed6\u5b57\u6bb5\u5fc5\u987b\u4e3a1; Id\u662f0\u7684\u65f6\u5019\uff0c\u5176\u4ed6\u5b57\u6bb5\u53ef\u4ee5\u662f0\uff1b\u5982\u679c\u6ca1\u6709<code>_id</code>\u5b57\u6bb5\u7ea6\u675f\uff0c\u591a\u4e2a\u540c\u4e3a0\u6216\u540c\u3002 </li> </ul> <pre><code>&gt; show tables\nbooks\nemps\nuser\n\n&gt; db.books.find()\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e75\"), \"title\" : \"book-0\", \"type\" : \"novel\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx0\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e76\"), \"title\" : \"book-1\", \"type\" : \"literature\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx1\" }\n...\n</code></pre> <p>\u5982\u679c\u67e5\u8be2\u8fd4\u56de\u7684\u6761\u76ee\u6570\u91cf\u8f83\u591a\uff0cmongo shell\u5219\u4f1a\u81ea\u52a8\u5b9e\u73b0\u5206\u6279\u663e\u793a\u3002\u9ed8\u8ba4\u5029\u51b5\u4e0b\u6bcf\u6b21\u53ea\u663e\u793a20\u3002\u6761\uff0c\u53ef\u4ee5\u8f93\u5165<code>it</code>\u547d\u4ee4\u8bfb\u53d6\u4e0b\u4e00\u6279\u3002 findOne\u67e5\u8be2\u96c6\u5408\u4e2d\u7684\u7b2c\u4e00\u4e2a\u6587\u6863\u3002\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\uff1a </p> <pre><code>&gt; it\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e9d\"), \"title\" : \"book-40\", \"type\" : \"technology\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx40\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e9e\"), \"title\" : \"book-41\", \"type\" : \"novel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx41\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e9f\"), \"title\" : \"book-42\", \"type\" : \"novel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx42\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea0\"), \"title\" : \"book-43\", \"type\" : \"novel\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx43\" }\n...\n</code></pre> <pre><code>&gt; db.books.find({title:\"book-20\"})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e89\"), \"title\" : \"book-20\", \"type\" : \"sociality\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx20\" }\n</code></pre> <pre><code>&gt; db.books.find({type:\"travel\", tag:\"developer\"})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e85\"), \"title\" : \"book-16\", \"type\" : \"travel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx16\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e86\"), \"title\" : \"book-17\", \"type\" : \"travel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx17\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e92\"), \"title\" : \"book-29\", \"type\" : \"travel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx29\" }\n</code></pre> <pre><code>&gt; db.books.find({type:\"travel\", tag:\"developer\"},{title:1,favCount:1})\n\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e85\"), \"title\" : \"book-16\", \"favCount\" : -100 }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e86\"), \"title\" : \"book-17\", \"favCount\" : -100 }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e92\"), \"title\" : \"book-29\", \"favCount\" : -100 }\n</code></pre> <pre><code>&gt; db.books.findOne({type:\"travel\", tag:\"developer\"},{title:1,favCount:1})\n{\n    \"_id\" : ObjectId(\"623b0766b815b989a2335e85\"),\n    \"title\" : \"book-16\",\n    \"favCount\" : -100\n}\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_4","title":"\u6761\u4ef6\u67e5\u8be2","text":"<p>\u6307\u5b9a\u6761\u4ef6\u67e5\u8be2</p> <pre><code>\uff03\u67e5\u8be2\u5e26\u6709nosql\u6807\u7b7e\u7684book\u6587\u6863\ndb.books.find({tag:\"nosql\"})\n\n\n&gt; db.books.find({tag:\"nosql\"})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7b\"), \"title\" : \"book-6\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx6\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8c\"), \"title\" : \"book-23\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx23\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8f\"), \"title\" : \"book-26\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx26\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e94\"), \"title\" : \"book-31\", \"type\" : \"technology\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx31\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e99\"), \"title\" : \"book-36\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx36\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e9f\"), \"title\" : \"book-42\", \"type\" : \"novel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx42\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea2\"), \"title\" : \"book-45\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx45\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea5\"), \"title\" : \"book-48\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx48\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea6\"), \"title\" : \"book-49\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx49\" }\n</code></pre> <pre><code>\u6309\u7167Id\u67e5\u8be2\u5355\u4e2abook\u6587\u6863\uff1a \n\n&gt; db.books.find({_id:ObjectId(\"623b0766b815b989a2335e8f\")})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8f\"), \"title\" : \"book-26\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx26\" }\n</code></pre> <pre><code>\uff03\u6c7d\u8be2\u5206\u7c7b\u4e3a\"travel\"\u3001\u6536\u85cf\u6570\u8d85\u8fc760\u4e2a\u7684book\u4e4b\u6863\uff1a \n\ndb.books.find({type:\"travel\",favCount:{$gt:60}}) \n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_5","title":"\u67e5\u8be2\u6761\u4ef6\u5bf9\u7167\u8868","text":""},{"location":"mongo1/4mongodb_opt/#_6","title":"\u67e5\u8be2\u903b\u8f91\u5bf9\u7167\u8868","text":"<pre><code>db.books.find({tag:{$in:[\"nosql\",\"document\"]}}) \n</code></pre> <pre><code>&gt; db.books.find({tag:{$in:[\"nosql\",\"document\"]}})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e75\"), \"title\" : \"book-0\", \"type\" : \"novel\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx0\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7b\"), \"title\" : \"book-6\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx6\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e89\"), \"title\" : \"book-20\", \"type\" : \"sociality\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx20\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8c\"), \"title\" : \"book-23\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx23\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8f\"), \"title\" : \"book-26\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx26\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e90\"), \"title\" : \"book-27\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx27\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e93\"), \"title\" : \"book-30\", \"type\" : \"travel\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx30\" }\n...\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_7","title":"\u67e5\u8be2\u903b\u8f91\u8fd0\u7b97\u7b26.","text":"<ul> <li><code>$It</code>\uff1a\u5b58\u5728\u5e76\u5c0f\u4e8e</li> <li><code>$Ite</code>:\u5b58\u5728\u5e76\u5c0f\u4e8e\u7b49\u4e8e </li> <li><code>$gt</code>: \u5b58\u5728\u5e76\u5927\u4e8e </li> <li><code>$gte</code>:   \u5b58\u5728\u5e76\u5927\u4e8e\u7b49\u4e8e </li> <li><code>$ne</code>: \u4e0d\u5b58\u5728\u6216\u5b58\u5728\u4f46\u4e0d\u7b49\u4e8e </li> <li><code>$in</code>\uff1a\u5b58\u5728\u5e76\u5728\u6307\u5b9a\u6570\u7ec4\u4e2d </li> <li><code>$nin</code>:\u4e0d\u5b58\u5728\u6216\u4e0d\u5728\u6307\u5b9a\u6570\u7ec4\u4e2d </li> <li><code>$or</code>\uff1a\u5339\u914d\u4e24\u4e2a\u6216\u591a\u4e2a\u6761\u4ef6\u4e2d\u7684\u4e00\u4e2a </li> <li><code>$and</code>:\u5339\u914d\u5168\u90e8\u6761\u4ef6 </li> </ul> <pre><code>&gt; db.books.find({$and:[{tag:\"nosql\"}, {favCount:{$gte:-100}}]})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7b\"), \"title\" : \"book-6\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx6\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8c\"), \"title\" : \"book-23\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx23\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8f\"), \"title\" : \"book-26\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx26\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e94\"), \"title\" : \"book-31\", \"type\" : \"technology\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx31\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e99\"), \"title\" : \"book-36\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx36\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e9f\"), \"title\" : \"book-42\", \"type\" : \"novel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx42\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea2\"), \"title\" : \"book-45\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx45\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea5\"), \"title\" : \"book-48\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx48\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea6\"), \"title\" : \"book-49\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx49\" }\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_8","title":"\u6392\u5e8f\uff06\u5206\u9875","text":"<p>\u6307\u5b9a\u6392\u5e8f:</p> <p>\u5728MongoDB\u4e2d\u4f7f\u7528<code>sort()</code>\u65b9\u6cd5\u5bf9\u6570\u636e\u8fdb\u884c\u6392\u5e8f</p> <pre><code>\uff03\u6307\u5b9a\u6309\u6536\u85cf\u6570(favcount\uff09\u964d\u5e8f\u8fd4\u56de \ndb.books.find({type:\"travel\"}).sort({favCount:-1}) \n</code></pre> <p>\u5206\u9875\u67e5\u8be2 </p> <p>skip\u7528\u4e8e\u6307\u5b9a\u8df3\u8fc7\u8bb0\u5f55\u6570\uff0climit \u5219\u7528\u4e8e\u9650\u5b9a\u8fd4\u56de\u7ed3\u679c\u6570\u91cf\u3002\u53ef\u4ee5\u5728\u6267\u884c<code>find</code>\u547d\u4ee4\u7684\u540c\u65f6\u6307\u5b9askip,limit\u53c2\u6570\uff0c\u4e00\u6b21\u5b9e\u73b0\u5206\u9875\u7684\u529f\u80fd\u3002\u6bd4\u5982\uff0c\u5047\u5b9a\u6bcf\u9875\u5927\u5c0f\u4e3a8\u6761\uff0c \u67e5\u8be2\u7b2c3\u9875\u7684book\u6587\u6863\uff1a</p> <pre><code>&gt; db.books.find().skip(8).limit(4)\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7d\"), \"title\" : \"book-8\", \"type\" : \"sociality\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx8\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7e\"), \"title\" : \"book-9\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx9\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e80\"), \"title\" : \"book-11\", \"type\" : \"literature\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx11\" }\n</code></pre> <pre><code>&gt; db.books.find({tag:{$in:[\"nosql\",\"document\"]}}).sort({favCount:-1})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e75\"), \"title\" : \"book-0\", \"type\" : \"novel\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx0\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7b\"), \"title\" : \"book-6\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx6\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e89\"), \"title\" : \"book-20\", \"type\" : \"sociality\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx20\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8c\"), \"title\" : \"book-23\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx23\" }\n...\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_9","title":"\u6b63\u5219\u8868\u8fbe\u5f0f\u5339\u914d\u67e5\u8be2","text":"<p>MongoDB\u4f7f\u7528<code>$regex</code>\u64cd\u4f5c\u7b26\u6765\u8bbe\u7f6e\u5339\u914d\u5b57\u7b26\u4e32\u7684\u6b63\u5219\u8868\u8fbe\u5f0f\u3002</p> <pre><code>//\u4f7f\u7528\u6b62\u5219\u8868\u8fbe\u5f0f\u67e5\u627etype\u5305\u542bso \u5b57\u7b26\u4e32\u7684 books\ndb.books.find({type:{$regex:\"so\"}}) \n\n&gt; db.books.find({type:{$regex:\"so\"}})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e77\"), \"title\" : \"book-2\", \"type\" : \"sociality\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx2\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e78\"), \"title\" : \"book-3\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx3\" }\n\n\n\n/\uff0f\u6216\u8005 \ndb.books.find({type:/so/}) \n\ndb.books.find({type:/so/})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e77\"), \"title\" : \"book-2\", \"type\" : \"sociality\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx2\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e78\"), \"title\" : \"book-3\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx3\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7d\"), \"title\" : \"book-8\", \"type\" : \"sociality\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx8\" }\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#33","title":"3.3 \u66f4\u65b0\u6587\u6863","text":"<p>\u53ef\u4ee5\u7528update\u547d\u4ee4\u5bf9\u6307\u5b9a\u7684\u6570\u636e\u8fdb\u884c\u66f4\u65b0\uff0c\u547d\u4ee4\u7684\u683c\u5f0f\u5982\u4e0b\uff1a </p> <pre><code>db.collection.update(query,update,options)\n</code></pre> <ul> <li>query\uff1a \u63cf\u8ff0\u66f4\u65b0\u7684\u67e5\u8be2\u6761\u4ef6\uff1b </li> <li>update:   \u63cf\u8ff0\u66f4\u65b0\u7684\u52a8\u4f5c\u53ca\u65b0\u7684\u5185\u5bb9 </li> <li>options\uff1a\u63cf\u8ff0\u66f4\u65b0\u7684\u9009\u9879 <ul> <li>upsert\uff1a\u53ef\u9009\uff0c\u5982\u679c\u4e0d\u5b58\u5728update\u7684\u8bb0\u5f55\uff0c\u662f\u5426\u63d2\u5165\u65b0\u7684i\u5df1\u5f55\u3002\u9ed8\u8ba4false\uff0c\u4e0d\u63d2\u5165 </li> <li>multi: \u53ef\u9009\uff0c\u662f\u5426\u6309\u6761\u4ef6\u67e5\u8be2\u51fa\u7684\u591a\u6761\u8bb0\u5f55\u5168\u90e8\u66f4\u65b0\u3002\u9ed8\u8ba4false\uff0c\u53ea\u66f4\u65b0\u627e\u5230\u7684\u7b2c\u4e00\u6761\u8bb0\u5f55 </li> <li>writeConcern\uff1a\u53ef\u9009\uff0c\u51b3\u5b9a\u4e00\u4e2a\u5199\u64cd\u4f5c\u843d\u5230\u591a\u5c11\u4e2a\u8282\u70b9\u4e0a\u624d\u7b97\u6210\u529f\u3002 </li> </ul> </li> </ul>"},{"location":"mongo1/4mongodb_opt/#_10","title":"\u66f4\u65b0\u64cd\u4f5c\u7b26","text":""},{"location":"mongo1/4mongodb_opt/#_11","title":"\u66f4\u65b0\u5355\u4e2a\u6587\u6863","text":"<p>\u67d0\u4e2a<code>book</code>\u6587\u6863\u88ab\u6536\u85cf\u4e86\uff0c\u5219\u9700\u8981\u5c06\u8be5\u6587\u6863\u7684<code>favCount</code> \u5b57\u6bb5\u81ea\u589e</p> <pre><code>&gt; show dbs\nappdb  0.000GB\n&gt; use appdb\nswitched to db appdb\n&gt; show tables\nbooks\nemps\nuser\n</code></pre> <pre><code>db.books.update({_id: ObjectId(\"623b0766b815b989a2335e84\")},{$inc:{favCount: 160}})\n</code></pre> <pre><code>db.books.update({_id: ObjectId(\"623b0766b815b989a2335e84\")},{$inc:{favCount: 160}})\nWriteResult({ \"nMatched\" : 1, \"nUpserted\" : 0, \"nModified\" : 1 })\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_12","title":"\u66f4\u65b0\u591a\u4e2a\u6587\u6863","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cupdate\u547d\u4ee4\u53ea\u5728\u66f4\u65b0\u7b2c\u4e00\u4e2a\u6587\u6863\u4e4b\u540e\u8fd4\u56de\uff0c\u5982\u679c\u9700\u8981\u66f4\u65b0\u591a\u4e2a\u6587\u6863\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528multi\u9009\u9879\u3002</p> <p>\u5c06\u5206\u7c7b\u4e3a\"novel\"\u7684\u6587\u6863\u7684\u589e\u52a0\u53d1\u5e03\u65f6\u95f4\uff08publishedDate)</p> <pre><code>db.books.update({tag: \"novel\"},{$set:{publishDate: new Date()}}, {\"multi\": true})\n</code></pre> <pre><code>&gt; db.books.find({tag: \"nosql\"})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7b\"), \"title\" : \"book-6\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx6\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8c\"), \"title\" : \"book-23\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx23\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8f\"), \"title\" : \"book-26\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx26\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e94\"), \"title\" : \"book-31\", \"type\" : \"technology\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx31\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e99\"), \"title\" : \"book-36\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx36\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e9f\"), \"title\" : \"book-42\", \"type\" : \"novel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx42\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea2\"), \"title\" : \"book-45\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx45\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea5\"), \"title\" : \"book-48\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx48\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea6\"), \"title\" : \"book-49\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx49\" }\n</code></pre> <pre><code>db.books.update({tag: \"nosql\"},{$set:{publishDate: new Date()}})\n</code></pre> <pre><code>db.books.update({tag: \"nosql\"},{$set:{publishDate: new Date()}})\nWriteResult({ \"nMatched\" : 1, \"nUpserted\" : 0, \"nModified\" : 1 })\n</code></pre> <pre><code>&gt; db.books.update({tag: \"nosql\"},{$set:{publishDate: new Date()}}, {\"multi\": true})\nWriteResult({ \"nMatched\" : 10, \"nUpserted\" : 0, \"nModified\" : 10 })\n</code></pre> <p>multi:\u53ef\u9009\uff0cmongodb\u9ed8\u8ba4\u662ffalse\uff0c\u53ea\u66f4\u65b0\u627e\u5230\u7684\u7b2c\u4e00\u6761\u8bb0\u5f55\uff0c\u5982\u679c\u8fd9\u4e2a\u53c2\u6570\u4e3atrue\uff0c\u5c31\u628a\u6309\u6761\u4ef6\u67e5\u51fa\u6765\u591a\u6761\u8bb0\u5f55\u5168\u90e8\u66f4\u65b0 </p> <pre><code>&gt; db.books.find({tag: \"nosql\"})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7b\"), \"title\" : \"book-6\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx6\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8c\"), \"title\" : \"book-23\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx23\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8f\"), \"title\" : \"book-26\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx26\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e94\"), \"title\" : \"book-31\", \"type\" : \"technology\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx31\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e99\"), \"title\" : \"book-36\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx36\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e9f\"), \"title\" : \"book-42\", \"type\" : \"novel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx42\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea2\"), \"title\" : \"book-45\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx45\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea5\"), \"title\" : \"book-48\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx48\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335ea6\"), \"title\" : \"book-49\", \"type\" : \"sociality\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx49\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n</code></pre> <p>update\u547d\u4ee4\u7684\u9009\u9879\u914d\u7f6e\u8f83\u591a\uff0c\u4e3a\u4e86\u7b80\u5316\u4f7f\u7528\u8fd8\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b\u5feb\u6377\u547d\u4ee4\uff1a </p> <ul> <li>updateOne:\u66f4\u65b0\u5355\u4e2a\u6587\u6863\u3002 </li> <li>updateMany\uff1a\u66f4\u65b0\u591a\u4e2a\u6587\u6863\u3002 </li> <li>replaceOne\uff1a\u66ff\u6362\u5355\u4e2a\u6587\u6863\u3002 </li> </ul> <pre><code>&gt; db.books.updateMany({type: \"novel\"},{$set:{publishDate: new Date()}})\n</code></pre> <pre><code>&gt; db.books.updateMany({type: \"novel\"},{$set:{publishDate: new Date()}})\n{ \"acknowledged\" : true, \"matchedCount\" : 9, \"modifiedCount\" : 9 }\n\n&gt; db.books.find({type: \"novel\"})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e75\"), \"title\" : \"book-0\", \"type\" : \"novel\", \"tag\" : \"document\", \"favCount\" : -100, \"author\" : \"xxx0\", \"publishDate\" : ISODate(\"2022-03-26T09:17:39.729Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e81\"), \"title\" : \"book-12\", \"type\" : \"novel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx12\", \"publishDate\" : ISODate(\"2022-03-26T09:17:39.729Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e8b\"), \"title\" : \"book-22\", \"type\" : \"novel\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx22\", \"publishDate\" : ISODate(\"2022-03-26T09:17:39.729Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e96\"), \"title\" : \"book-33\", \"type\" : \"novel\", \"tag\" : \"popular\", \"favCount\" : -100, \"author\" : \"xxx33\", \"publishDate\" : ISODate(\"2022-03-26T09:17:39.729Z\") }\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#upsert","title":"\u4f7f\u7528upsert\u547d\u4ee4","text":"<p>Upsert\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u66f4\u65b0\uff0c\u5176\u8868\u73b0\u4e3a\u5982\u679c\u76ee\u6807\u6587\u6863\u4e0d\u5b58\u5728\uff0c\u5219\u6267\u884c\u63d2\u5165\u547d\u4ee4\u3002 </p> <pre><code>db.books.update( \n    {title:\"my book\"},\n    {$set:{tags:[\"nosql\",\"mongodb\"] ,type:\"none\", author:\"jacob\"}},\n    {upsert:true}\n)\n</code></pre> <pre><code>&gt; db.books.update(\n... {title:\"my book\"},\n... {$set:{tags:[\"nosql\",\"mongodb\"] ,type:\"none\", author:\"jacob\"}},\n... {upsert:true}\n... )\nWriteResult({\n    \"nMatched\" : 0,\n    \"nUpserted\" : 1,\n    \"nModified\" : 0,\n    \"_id\" : ObjectId(\"623edc883d8c8e61e23b57c3\")\n})\n</code></pre> <p>nMatched, nModified\u90fd\u4e3a0\uff0c\u8868\u793a\u6ca1\u6709\u6587\u6863\u88ab\u5339\u914d\u53ca\u66f4\u65b0\uff0c<code>nUpserted=1</code>\u63d0\u793a\u6267\u884c\u4e86<code>Upsert</code>\u52a8\u4f5c </p> <pre><code>&gt; db.books.find({title: \"my book\"})\n{ \"_id\" : ObjectId(\"623edc883d8c8e61e23b57c3\"), \"title\" : \"my book\", \"author\" : \"jacob\", \"tags\" : [ \"nosql\", \"mongodb\" ], \"type\" : \"none\" }\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#replace","title":"\u5b9e\u73b0replace\u8bed\u4e49","text":"<p>update\u547d\u4ee4\u4e2d\u7684\u66f4\u65b0\u63cf\u8ff0\uff08update)\u901a\u5e38\u7531\u64cd\u4f5c\u7b26\u63cf\u8ff0\uff0c\u5982\u679c\u66f4\u65b0\u63cf\u8ff0\u4e2d\u4e0d\u5305\u542b\u4efb\u4f55\u64cd\u4f5c\u7b26\uff0c\u90a3\u4e48MongoDB\u4f1a\u5b9e\u73b0\u6587\u6863\u7684replace\u8bed\u4e49 </p> <pre><code>db.books.update( \n    {title:\"my book\"}, \n    {justTitle:\"my first book\"} \n)\n</code></pre> <pre><code>&gt; db.books.update(\n... {title:\"my book\"},\n... {justTitle:\"my first book\"}\n... )\nWriteResult({ \"nMatched\" : 1, \"nUpserted\" : 0, \"nModified\" : 1 })\n</code></pre> <pre><code>&gt; db.books.find({justTitle:\"my first book\"})\n{ \"_id\" : ObjectId(\"623edc883d8c8e61e23b57c3\"), \"justTitle\" : \"my first book\" }\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#findandmodify","title":"findAndModify\u547d\u4ee4","text":"<p><code>findAndModify</code>\u517c\u5bb9\u4e86\u67e5\u8be2\u548c\u4fee\u6539\u6307\u5b9a\u6587\u6863\u7684\u529f\u80fd\uff0c<code>findAndModify</code>\u53ea\u80fd\u66f4\u65b0\u5355\u4e2a\u6587\u6863 </p> <pre><code>//\u5c06\u67d0\u4e2abook\u6587\u6863\u7684\u6536\u85cf\u6570\uff08favCount)\u52a01\ndb.books.findAndModify({\n    query: {_id: ObjectId(\"623b0766b815b989a2335e75\")},\n    update: {$inc:{favCount: 130}}\n})\n</code></pre> <pre><code>&gt; db.books.findAndModify({\n... query: {_id: ObjectId(\"623b0766b815b989a2335e75\")},\n... update: {$inc:{favCount: 130}}\n... })\n{\n    \"_id\" : ObjectId(\"623b0766b815b989a2335e75\"),\n    \"title\" : \"book-0\",\n    \"type\" : \"novel\",\n    \"tag\" : \"document\",\n    \"favCount\" : -100,\n    \"author\" : \"xxx0\",\n    \"publishDate\" : ISODate(\"2022-03-26T09:17:39.729Z\")\n}\n</code></pre> <p>\u8be5\u64cd\u4f5c\u4f1a\u8fd4\u56de\u7b26\u5408\u67e5\u8be2\u6761\u4ef6\u7684\u6587\u6863\u6570\u636e\uff0c\u5e76\u5b8c\u6210\u5bf9\u6587\u6863\u7684\u4fee\u6539\u3002 </p> <pre><code>db.books.find({\"_id\": ObjectId(\"623b0766b815b989a2335e75\")})\n</code></pre> <pre><code>&gt; db.books.find({\"_id\": ObjectId(\"623b0766b815b989a2335e75\")})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e75\"), \"title\" : \"book-0\", \"type\" : \"novel\", \"tag\" : \"document\", \"favCount\" : 30, \"author\" : \"xxx0\", \"publishDate\" : ISODate(\"2022-03-26T09:17:39.729Z\") }\n</code></pre> <p><code>\"favCount\" : 30, \"author\" : \"xxx0\", \"publishDate\" :</code></p> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cfindAndModify\u4f1a\u8fd4\u56de\u4fee\u6539\u524d\u7684\u201c\u65e7\u201c\u6570\u636e\u3002\u5982\u679c\u5e0c\u671b\u8fd4\u56de\u4fee\u6539\u6539\u540e\u7684\u6570\u636e\uff0c\u5219\u53ef\u4ee5\u6307\u5b9anew\u9009\u9879</p> <p><code>new: true</code></p> <pre><code>db.books.findAndModify({\n    query: {_id: ObjectId(\"623b0766b815b989a2335e75\")},\n    update: {$inc:{favCount: 130}},\n    new: true\n})\n\n&gt; db.books.findAndModify({\n... query: {_id: ObjectId(\"623b0766b815b989a2335e75\")},\n... update: {$inc:{favCount: 130}},\n... new: true\n... })\n{\n    \"_id\" : ObjectId(\"623b0766b815b989a2335e75\"),\n    \"title\" : \"book-0\",\n    \"type\" : \"novel\",\n    \"tag\" : \"document\",\n    \"favCount\" : 160,\n    \"author\" : \"xxx0\",\n    \"publishDate\" : ISODate(\"2022-03-26T09:17:39.729Z\")\n}\n</code></pre> <p>\u4e0efindAndModify\u8bed\u4e49\u76f8\u8fd1\u7684\u547d\u4ee4\u5982\u4e0b </p> <ul> <li>findOneAndUpdate:\u66f4\u65b0\u5355\u4e2a\u6587\u6863\u5e76\u8fd4\u56de\u66f4\u65b0\u524d\uff08\u6216\u66f4\u65b0\u540e\uff09\u7684\u6587\u6863\u3002 </li> <li>findOneAndReplace:\u66ff\u6362\u5355\u4e2a\u6587\u6863\u5e76\u8fd4\u56de\u66ff\u6362\u524d\uff08\u6216\u66ff\u6362\u540e\uff09\u7684\u6587\u6863\u3002 </li> </ul>"},{"location":"mongo1/4mongodb_opt/#34","title":"3.4 \u5220\u9664\u6587\u6863","text":""},{"location":"mongo1/4mongodb_opt/#remove","title":"\u4f7f\u7528remove\u5220\u9664\u6587\u6863","text":"<ul> <li>remove\u547d\u4ee4\u9700\u8981\u914d\u5408\u67e5\u8be2\u6761\u4ef6\u4f7f\u7528 </li> <li>\u5339\u914d\u67e5\u8be2\u6761\u4ef6\u7684\u6587\u6863\u4f1a\u88ab\u5220\u9664\uff1b </li> <li>\u6307\u5b9a\u4e00\u4e2a\u7a7a\u6587\u6863\u6761\u4ef6\u4f1a\u5220\u9664\u6240\u6709\u6587\u6863 </li> </ul> <p>\u793a\u4f8b </p> <pre><code>db.user.remove({age:28}) // \u5220\u9664age\u7b49\u4e8e28 \u7684\u8bb0\u5f55 \ndb.user.remove({age:{$lt:25}}) // \u5220\u9664age\u5c0f\u4e8e 25\u7684\u8bb0\u5f55 \ndb.user.remove({}) // \u5220\u9664\u6240\u6709\u8bb0\u5f55\ndb.user.remove() //\u62a5\u9519 \n</code></pre> <p>remove\u547d\u4ee4\u4f1a\u5220\u9664\u5339\u914d\u6761\u4ef6\u7684\u5168\u90e8\u6587\u6863\uff0c\u5982\u679c\u5e0c\u671b\u660e\u786e\u9650\u5b9a\u53ea\u5220\u9664\u4e00\u4e2a\u6587\u6863\uff0c\u5219\u9700\u8981\u6307<code>justOne</code>\u53c2\u6570\uff0c\u547d\u4ee4\u683c\u5f0f\u5982\u4e0b </p> <pre><code>db.collection.remove(query,justOne) \n</code></pre> <p>\u4f8b\u5982\uff1a\u5220\u9664\u6ee1\u8db3<code>type:novel</code>\u6761\u4ef6\u7684\u9996\u6761\u8bb0\u5f55 </p> <pre><code>db.books.remove({type:\"novel\"},true) \n</code></pre> <pre><code>&gt; db.books.remove({type:\"novel\"},true)\nWriteResult({ \"nRemoved\" : 1 })\n</code></pre> <pre><code>&gt; db.books.remove()\nuncaught exception: Error: remove needs a query :\nDBCollection.prototype._parseRemove@src/mongo/shell/collection.js:362:15\nDBCollection.prototype.remove@src/mongo/shell/collection.js:389:18\n@(shell):1:1\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#delete","title":"\u4f7f\u7528delete\u5220\u9664\u6587\u6863","text":"<p>\u5b98\u65b9\u63a8\u8350\u4f7f\u7528<code>deleteOne(\uff09</code>\u548c<code>deleteMany(\uff09</code>\u65b9\u6cd5\u5220\u9664\u6587\u6863\uff0c\u8bed\u6cd5\u683c\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>db.books.deleteMany({})      // \u5220\u9664\u96c6\u5408\u4e0b\u5168\u90e8\u72b6\u6001\ndb.books.deleteMany({type:\"novel\"})  // \u5220\u9664type\u7b49\u4e8enovel\u7684\u5168\u90e8\u6587\u6863 \ndb.books.deleteOne({type:\"novel\"})  /\uff0f\u5220\u9664type\u7b49\u4e8enovel\u7684\u4e00\u4e2a\u6587\u6863 \n</code></pre> <p>\u6ce8\u610f\uff1a</p> <p><code>remove</code>, <code>deleteMany</code>\u7b49\u547d\u4ee4\u9700\u8981\u5bf9\u67e5\u8be2\u8303\u56f4\u5185\u7684\u6587\u6863\u9010\u4e2a\u5220\u9664\uff0c\u5982\u679c\u5e0c\u671b\u5220\u9664\u6574\u4e2a\u96c6\u5408\uff0c\u5219\u4f7f\u7528drop\u547d\u4ee4\u4f1a\u66f4\u52a0\u9ad8\u6548</p> <pre><code>db.books.deleteOne({type:\"travel\"}) \n</code></pre> <pre><code>&gt; db.books.deleteOne({type:\"travel\"})\n{ \"acknowledged\" : true, \"deletedCount\" : 1 }\n</code></pre>"},{"location":"mongo1/4mongodb_opt/#_13","title":"\u8fd4\u56de\u88ab\u5220\u9664\u6587\u6863","text":"<p><code>remove</code>,<code>deleteOne</code>\u7b49\u547d\u4ee4\u5728\u5220\u9664\u6587\u6863\u540e\u53ea\u523d\u533a\u56de\u786e\u8ba4\u6027\u7684\u4fe1\u606f\uff0c\u5982\u679c\u5e0c\u671b\u83b7\u5f97\u88ab\u5220\u9664\u7684\u6587\u6863\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528<code>findOneAndDelete</code>\u547d\u4ee4 </p> <pre><code>db.books.findOneAndDelete({type:\"novel\"}) \n</code></pre> <pre><code>&gt; db.books.findOneAndDelete({type:\"novel\"})\n{\n    \"_id\" : ObjectId(\"623b0766b815b989a2335e81\"),\n    \"title\" : \"book-12\",\n    \"type\" : \"novel\",\n    \"tag\" : \"developer\",\n    \"favCount\" : -100,\n    \"author\" : \"xxx12\",\n    \"publishDate\" : ISODate(\"2022-03-26T09:17:39.729Z\")\n}\n</code></pre> <p>\u9664\u4e86\u5728\u7ed3\u679c\u4e2d\u8fd4\u56de\u5220\u9664\u6587\u6863\uff0cfindOneAndDelete\u547d\u4ee4\u8fd8\u5141\u8bb8\u5b9a\u4e49\"\u5220\u9664\u7684\u987a\u5e8f\"\uff0c\u5373\u6309\u7167\u6307\u5b9a\u987a\u5e8f\u5220\u9664\u627e\u5230\u7684\u7b2c\u4e00\u4e2a\u6587\u6863</p> <pre><code>db.books.findOneAndDelete({type:\"novel\"},{sort:{favCount:1}}) \n</code></pre> <p>remove, deleteOne\u7b49\u547d\u4ee4\u53ea\u80fd\u6309\u9ed8\u8ba4\u987a\u5e8f\u5220\u9664\uff0c\u5229\u7528\u8fd9\u4e2a\u7279\u6027\uff0c findOneAndDelete\u53ef\u4ee5\u5b9e\u73b0\u961f\u5217\u7684\u5148\u8fdb\u5148\u51fa\u3002 </p>"},{"location":"mongo1/5mongodb_springbboot/","title":"5 MongoDB\u6574\u5408SpringBoot","text":""},{"location":"mongo1/5mongodb_springbboot/#51","title":"5.1 \u73af\u5883\u51c6\u5907","text":""},{"location":"mongo1/5mongodb_springbboot/#1","title":"1 \u5f15\u5165\u4f9d\u8d56","text":"<pre><code>&lt;!-- spring data mongodb --\uff1e \n&lt;dependency&gt; \n    &lt;groupId&gt;org.sprintframework.boot&lt;/groupId&gt; \n    &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;\n&lt;/dependency&gt; \n</code></pre>"},{"location":"mongo1/5mongodb_springbboot/#2yml","title":"2\uff0e\u914d\u7f6eyml","text":"<pre><code>spring: \n    data: \n        mongodb: \n            uri: mongodb://jacob:jacob@192.168.65.174:27017/test?authsource=admin \n            # uri \u7b49\u540c\u4e8e\u4e0b\u9762\u7684\u914d\u7f6e \n            # database:test \n            # host:192.168.65.174 \n            # port: 27017 \n            # username:jacob \n            # password: jacob \n            # authentication-database: admin \n</code></pre> <p>\u8fde\u63a5\u914d\u7f6e\u53c2\u8003\u6587\u6863\uff1ahttps://docs.mongodb.com/manual/reference/connection-string</p>"},{"location":"mongo1/5mongodb_springbboot/#3mongolemplate","title":"3\uff0e\u4f7f\u7528\u65f6\u6ce8\u5165mongolemplate","text":"<pre><code>@Autowired \nMongoTemplate mongoTemplate;\n</code></pre>"},{"location":"mongo1/5mongodb_springbboot/#52","title":"5.2 \u96c6\u5408\u64cd\u4f5c","text":"<pre><code>@Test \npublic void testCollection(){ \n\n    boolean exists=mongoTemplate.collectionExists(\"emp\"); \n    if(exists){ \n        // \u5220\u9664\u96c6\u5408\n        mongoTemlate.dropCollection(\"emp\"); \n        }  \n        // \u521b\u5efa\u96c6\u5408 \n    mongoTemplate.createCollection(\"emp\");\n}\n</code></pre>"},{"location":"mongo1/5mongodb_springbboot/#53","title":"5.3 \u6587\u6863\u64cd\u4f5c","text":""},{"location":"mongo1/5mongodb_springbboot/#_1","title":"\u76f8\u5173\u6ce8\u89e3","text":"<ul> <li> <p><code>@Document</code></p> <ul> <li>\u4fee\u9970\u8303\u56f4\uff1a\u7528\u5728\u7c7b\u4e0a </li> <li>\u4f5c\u7528\uff1a\u7528\u6765\u6620\u5c04\u8fd9\u4e2a\u7c7b\u7684\u4e00\u4e2a\u5bf9\u8c61\u4e3amongo\u4e2d\u4e00\u6761\u6587\u6863\u6570\u636e\u3002 </li> <li>\u5c5e\u6027\uff1a<code>(value\u3001collection\uff09</code>\u7528\u6765\u6307\u5b9a\u64cd\u4f5c\u7684\u96c6\u5408\u540d\u79f0 </li> </ul> </li> <li> <p><code>@Id</code> </p> <ul> <li>\u4fee\u9970\u8303\u56f4\uff1a\u7528\u5728\u6210\u5458\u53d8\u91cf\u3001\u65b9\u6cd5\u4e0a </li> <li>\u4f5c\u7528\uff1a\u7528\u6765\u5c06\u6210\u5458\u53d8\u91cf\u7684\u503c\u6620\u5c04\u4e3a\u6587\u6863\u7684<code>_id</code>\u7684\u503c </li> </ul> </li> <li> <p><code>@Field</code> </p> <ul> <li>\u4fee\u9970\u8303\u56f4\uff1a\u7528\u5728\u6210\u5458\u53d8\u91cf\u3001\u65b9\u6cd5\u4e0a </li> <li>\u4f5c\u7528\uff1a\u7528\u6765\u5c06\u6210\u5458\u53d8\u91cf\u53ca\u5176\u503c\u6620\u5c04\u4e3a\u6587\u6863\u4e2d\u4e00\u4e2a<code>key:value</code>\u5bf9\u3002</li> <li>\u5c5e\u6027\uff1a(<code>name,value</code>\uff09\u7528\u6765\u6307\u5b9a\u5728\u6587\u6863\u4e2dkey\u7684\u540d\u79f0\uff0c\u9ed8\u8ba4\u4e3a\u6210\u5458\u53d8\u91cf\u540d </li> </ul> </li> <li> <p><code>@Transient</code></p> <ul> <li>\u4fee\u9970\u8303\u56f4\uff1a\u7528\u5728\u6210\u5458\u53d8\u91cf\u3001\u65b9\u6cd5\u4e0a </li> <li>\u4f5c\u7528\uff1a\u7528\u6765\u6307\u5b9a\u6b64\u6210\u5458\u53d8\u91cf\u4e0d\u53c2\u4e0e\u6587\u6863\u7684\u5e8f\u5217\u5316 </li> </ul> </li> </ul> <p>\u521b\u5efa\u5b9e\u4f53</p> <pre><code>@Document(\"emp\") // \u5bf9\u5e94emp\u96c6\u5408\u4e2d\u7684\u4e2a\u6587\u6863 \n@Data \n@AllArgsConstructor \n@NoArgsConstructor \npublic class Employee{ \n\n    @Id //\u6620\u5c04\u6587\u6863\u4e2d\u7684 _Id \n    private Integer id; \n    @Field(\"usernarne\") \n    private String name; \n    @Field \n    private int age; \n    @Field \n    private Double salary; \n    @Field \n    private Date birthday; \n} \n</code></pre>"},{"location":"mongo1/5mongodb_springbboot/#_2","title":"\u6dfb\u52a0\u6587\u6863","text":"<p>Insert\u65b9\u6cd5\u8fd4\u56de\u503c\u662f\u65b0\u589e\u7684<code>Document</code>\u5bf9\u8c61\uff0c\u91cc\u9762\u5305\u542b\u4e86\u65b0\u589e\u540eid\u7684\u503c\u3002\u5982\u679c\u96c6\u5408\u4e0d\u5b58\u5728\u4f1a\u81ea\u52a8\u521b\u5efa\u96c6\u5408\u3002</p> <p>\u901a\u8fc7<code>Spring Data MongoDB</code>\u8fd8\u4f1a\u7ed9\u96c6\u5408\u4e2d\u591a\u52a0\u4e00\u4e2a<code>class</code>\u7684\u5c5e\u6027\uff0c\u5b58\u50a8\u65b0\u589e\u65f6<code>Document</code>\u5bf9\u5e94<code>Java</code>\u4e2d\u7c7b\u7684\u5168\u9650\u5b9a\u8def\u5f84\u3002\u8fd9\u4e48\u505a\u4e3a\u4e86\u67e5\u8be2\u65f6\u80fd\u628a<code>Document</code>\u8f6c\u6362\u4e3a<code>Java</code>\u7c7b\u578b</p> <pre><code>@Test\npublic void testInsert(){\n    Employee employee = new Ernployee(1, \"\u5c0f\u533a\"\uff0c30, 10000.00, new Date());\n    // \u6dfb\u52a0\u6587\u6863 \n    // sava: _id \u8bb0\u5b58\u5728\u65f6\u66f4\u65b0\u6570\u636e \n    // mongoTemplate.save (employee); \n    // insert: _id\uff1a\u629b\u51fa\u5f02\u5e38 \u652f\u6301\u6279\u91cf\u64cd\u4f5c \n\nmongoTemplate.insert(employee)\uff1b\n\nList&lt;Employee&gt; list= Arrays.asList(\n    Employee(2,\"\u5f20\u4e09\", 21,5000.00,  new Date()),\n    Employee(3,\"\u674e\u56db\", 26,8000.00,  new Date()),\n    Employee(4,\"\u738b\u4e94\", 22,5000.00,  new Date()),\n    Employee(5,\"\u5f20\u9f99\", 28,6000.00,  new Date()),\n    Employee(6,\"\u8d75\u864e\", 24,7000.00,  new Date()),\n    Employee(7, \"\u8d75\u516d', 28,12000.00,  new Date());\n   // \u63d2\u5165\u591a\u6761\u6570\u636e\n   mongoTemplate.insert(list,Employee.class)\uff1b\n}\n</code></pre>"},{"location":"mongo1/5mongodb_springbboot/#_3","title":"\u67e5\u8be2\u6587\u6863","text":"<p>Criteral \u662f\u6807\u51c6\u67e5\u8be2\u7684\u63a5\u53e3\uff0c\u53ef\u4ee5\u5f15\u7528\u9759\u6001\u7684<code>Criteria.where</code>\u7684\u628a\u591a\u4e2a\u6761\u4ef6\u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u5c31\u53ef\u4ee5\u8f7b\u677e\u5730\u5c06\u591a\u4e2a\u65b9\u6cd5\u6807\u51c6\u548c\u67e5\u8be2\u8fde\u63a5\u8d77\u6765\uff0c\u65b9\u4fbf\u6211\u4eec\u64cd\u4f5c\u67e5\u8be2\u8bed\u53e5\u3002</p> <p></p> <pre><code>@Test public void testFind(){ \n    System.out.printin(\"========\u67e5\u8be2\u6587\u6863========\");\n    //\u67e5\u8be2\u6240\u6709\u6587\u6863\n    List&lt;Employee&gt; list = mongoTemplate.findAll(Employee.class);\n    list.forEach(\"System.out::println\");\n\n    System.out.printin(\"========\u6839\u636e_id\u6587\u6863========\");\n    // \u6839\u636e_id\u67e5\u8be2\n    Employees=mongoTemplate.findById(1, Employee.class); \n    System.out.printin(e); \n\n    System.out.printin(\"========findOne\u8fd4\u56de\u7b2c\u4e00\u4e2a\u6587\u6863========\");\n    //\u5982\u679c\u67e5\u8be2\u7ed3\u679c\u662f\u591a\u4e2a\uff0c\u8fd4\u56de\u5176\u4e2d\u7b2c\u4e00\u4e2a\u6587\u6863\u5bf9\u8c61\n    Employee one=mongoTemplate.findOne(new Query(), Employee.class); \n    System.out.println(one); \n\n    System.out.printin(\"========\u6761\u4ef6\u67e5\u8be2========\");\n    //new Query()\u8868\u793a\u6ca1\u6709\u6761\u4ef6\n    //\u67e5\u8be2\u85aa\u8d44\u5927\u4e8e\u7b49\u4e8e8000\u7684\u5458\u5de5 \n    // Query query=new Query(Criteria.where(\"salary\").gte(8000));\n    //\u67e5\u8be2\u85aa\u8d44\u5927\u4e8e\u7b49\u4e8e4000\u5c0f\u4e8e10000\u7684\u5458\u5de5 \n    // Query query=new Query(Criteria.where(\"salary\").gt(4000).le(10000));\n    //\u6b63\u5219\u67e5\u8be2\uff08\u6a21\u7cca\u67e5\u8be2\uff09java\u4e2d\u6b63\u5219\u4e0d\u9700\u8981\u6709// \n    //Query query=new Query(Criteria.where(\"name\").regex(\"\u5f20\")); \n\n    //and  or\u591a\u6761\u4ef6\u67e5\u8be2 \n    Criteria criteria=new Criteria(); \n    //and \u67e5\u8be2\u5e74\u9f84\u5927\u4e8e25&amp;.\u85aa\u8d44\u5c0f\u4e8e8000\u7684\u5458\u5de5 \n    //criteria.andoperator(Criteria.where(\"age\").gt(25),Criteria.where(\"salary\").gt(8000)); \n    //or \u67e5\u8be2\u59d3\u540d\u662f\u5f20\u4e09\u6216\u8005\u85aa\u8d44\u5927\u4e8e8000\u7684\u5458\u5de5\n    criteria.orOperator(Criteria.where(\"name\").is(\"\u5f20\u4e09\u201c),Criteria.where(\"salary\").gt(8000)); \n    Query query=new Query(criteria);\n\n    //sort\u6392\u5e8f \n    //query.with(Sort.by(Sort.Order.desc(\"salary'')));\n\n    //skip limit\u5206\u9875  skip\u7528\u4e8e\u6307\u5b9a\u8df3\u8fc7\u8bb0\u5f55\u6570\uff0climit\u5219\u7528\u4e8e\u9650\u5b9a\u8fd4\u56de\u7ed3\u679c\u6570\u91cf\u3002\n     query.with(Sort.by(Sort.Order.desc(\"salary\"))) \n        .skip(0) //\u6307\u5b9a\u8df3\u8fc7\u8bb0\u5f55\u6570 \n        .limit(4); //\u6bcf\u9875\u663e\u793a\u8bb0\u5f55\u6570 \n\n    //\u67e5\u8be2\u7ed3\u679c \n    List&lt;Employee&gt; employees = mongoTemplate.find( \n        query, Employee.class);\n    employees.forEach(System.out::println()); \n} \n</code></pre>"},{"location":"mongo1/5mongodb_springbboot/#43","title":"4.3 \u66f4\u65b0\u6587\u6863","text":"<p>\u5728Mongodb\u4e2d\u65e0\u8bba\u662f\u4f7f\u7528\u5ba2\u6237\u7aefAPI\u8fd8\u662f\u4f7f\u7528SpringData\uff0c\u66f4\u65b0\u8fd4\u56de\u7ed3\u679c\u4e00\u5b9a\u662f\u53d7\u884c\u6570\u5f71\u54cd\u3002\u5982\u679c\u66f4\u65b0\u540e\u7684\u7ed3\u679c\u548c\u66f4\u65b0\u524d\u7684\u7ed3\u679c\u662f\u76f8\u540c\uff0c\u8fd4\u56de0 </p> <ul> <li><code>updateFirst()</code>\u53ea\u66f4\u65b0\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u6761\u8bb0\u5f55</li> <li><code>updateMulti()</code>\u66f4\u65b0\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55 </li> <li><code>upsert()\u6ca1</code>\u6709\u7b26\u5408\u6761\u4ef6\u7684\u8bb0\u5f55\u5219\u63d2\u5165\u6570\u636e</li> </ul> <pre><code>@Test\npublic void testUpdate(){ \n    //query\u8bbe\u7f6e\u67e5\u8be2\u6761\u4ef6\n\n    Query query=new Query(Criteria.where(\"salary\").gte(15000)) \n\n    System.out.println(\"========\u66f4\u65b0\u524d========\");\n    List &lt;Employee&gt;employees = mongoTemplate.find(query, Employee.class); \n    employees.fo:Each(System.out::println);  \n\n    Update update=new Update() \n    // \u8bbe\u7f6e\u66f4\u65b0\u5c5e\u6027 \n    update.set(\"salary\", 13000); \n\n    //updateFirst()  \u53ea\u66f4\u65b0\u6ee1\u8db3\u6761\u4ef6\u7684\u7b2c\u4e00\u6761\u8bb0\u5f55 \n    //UpdateResult updateResult=mongoTemplate.updateFirst(query, update, Employee.class); \n\u66f4\u65b0\u6240\u6709\u4e0b\u4e24\u8d70\u6761\u4ef6\u7684\u8bb0\u6c42 \n    //updateMulti() // \u66f4\u65b0\u6240\u6709\u6ee1\u8db3\u6761\u4ef6\u7684\u8bb0\u5f55\n    //UpdateResult updateResult=mongoTemplate.updateMulti(query, update, Employee.class); \n\n    //upsert(\uff09\u6ca1\u6709\u7b26\u5408\u6761\u4ef6\u7684\u8bb0\u5f55\u5219\u63d2\u5165\u6570\u636e \n    //update.setOnInsert(\"id\",11);  //\u6307\u5b9a_id\n    // UpdateResult updateResult=mongoTemplate.upsert(query, update, Employee.class); \n\n    // \u8fd4\u56de\u4fee\u6539\u7684\u8bb0\u5f55\u6570 \n    System.out.println(updateResult.getModifiedCount()); \n\n    System.out.printin(\"========\u66f4\u65b0\u540e========\");\n    employees = mongoTemplate.find(query, Employee.class)\n    employees.Foreach(System.out::println);\n} \n</code></pre>"},{"location":"mongo1/5mongodb_springbboot/#44","title":"4.4 \u5220\u9664\u6587\u6863","text":"<pre><code>@Test \n\npublic void testDelete(){ \n\n    //\u5220\u9664\u6240\u6709\u6587\u6863\n    //mongoTemplate.remove(new Query(), Empioye.class);\n\n    //\u5220\u9664\u6761\u4ef6\n    Query query=new Query(Criteria.where(\"salary\").Employee.gte(10000)); \n    mongoTemplate.remove(query, Employee.class));\n} \n</code></pre>"},{"location":"mongo1/6mongodb_pip/","title":"6 MongoDB \u805a\u5408\u64cd\u4f5c","text":"<p>\u805a\u5408\u64cd\u4f5c\u5904\u7406\u6570\u636e\u8bb0\u5f55\u5e76\u8fd4\u56de\u8ba1\u7b97\u7ed3\u679c\uff08\u8bf8\u5982\u7edf\u8ba1\u5e73\u5747\u503c\uff0c\u6c42\u548c\u7b49\uff09\u3002\u805a\u5408\u64cd\u4f5c\u7ec4\u503c\u6765\u81ea\u591a\u4e2a\u6587\u6863\uff0c\u53ef\u4ee5\u5bf9\u5206\u7ec4\u6570\u636e\u6267\u884c\u5404\u79cd\u64cd\u4f5c\u4ee5\u8fd4\u56de\u5355\u4e2a\u7ed3\u679c\u3002\u805a\u5408\u64cd\u4f5c\u5305\u542b\u4e09\u7c7b\uff1a\u5355\u4e00\u4f5c\u7528\u805a\u5408\u3001\u805a\u5408\u7ba1\u9053\u3001Map Reduce</p> <ul> <li>\u5355\u4e00\u4f5c\u7528\u805a\u5408\uff1a\u63d0\u4f9b\u4e86\u5bf9\u5e38\u89c1\u805a\u5408\u8fc7\u7a0b\u7684\u7b80\u5355\u8bbf\u95ee\uff0c\u64cd\u4f5c\u90fd\u4ece\u5355\u4e2a\u96c6\u5408\u805a\u5408\u6587\u6863\u3002</li> <li>\u805a\u5408\u7ba1\u9053\u662f\u4e00\u4e2a\u6570\u636e\u805a\u5408\u7684\u6846\u67b6\uff0c\u6a21\u578b\u57fa\u4e8e\u6570\u636e\u5904\u7406\u6d41\u6c34\u7ebf\u7684\u6982\u5ff5\u3002\u6587\u6863\u8fdb\u5165\u591a\u7ea7\u7ba1\u9053\uff0c\u5c06\u6587\u6863\u8f6c\u6362\u4e3a\u805a\u5408\u7ed3\u679c\u3002</li> <li>MapReduce\u64cd\u4f5c\u5177\u6709\u4e24\u4e2a\u9636\u6bb5:  \u5904\u7406\u6bcf\u4e2a\u6587\u6863\u5e76\u5411\u6bcf\u4e2a\u8f93\u5165\u6587\u6863\u53d1\u5c04\u4e00\u4e2a\u6216\u591a\u4e2a\u5bf9\u8c61\u7684map\u9636\u6bb5\uff0c\u4ee5\u53careduce\u7ec4\u5408map\u64cd\u4f5c\u7684\u8f93\u51fa\u9636\u6bb5</li> </ul>"},{"location":"mongo1/6mongodb_pip/#61","title":"6.1 \u5355\u4e00\u4f5c\u7528\u805a\u5408","text":"<p>MongoDB\u63d0\u4f9b<code>db.collection.estimatedDocumentCount()</code>, <code>db.collection.count()</code>, <code>db.collection.distinct()</code> \u8fd9\u7c7b\u5355\u4e00\u4f5c\u7528\u7684\u805a\u5408\u51fd\u6570\u3002</p> <p>\u6240\u6709\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u805a\u5408\u6765\u81ea\u5355\u4e2a\u96c6\u5408\u7684\u6587\u6863\u3002\u867d\u7136\u8fd9\u4e9b\u64cd\u4f5c\u63d0\u4f9b\u4e86\u5bf9\u516c\u5171\u805a\u5408\u8fc7\u7a0b\u7684\u7b80\u5355\u8bbf\u95ee\uff0c\u4f46\u5b83\u4eec\u7f3a\u4e4f\u805a\u5408\u7ba1\u9053\u548c<code>map-Reduce</code>\u7684\u7075\u6d3b\u6027\u548c\u529f\u80fd\u3002 </p> <pre><code># ./mongod -f /mongodb/conf/mongo.conf\n\n[root@jabox bin]# ./mongo localhost:27017 -u appdb -p jack --authenticationDatabase=appdb\nMongoDB shell version v4.4.13\nconnecting to: mongodb://localhost:27017/test?authSource=appdb&amp;compressors=disabled&amp;gssapiServiceName=mongodb\nImplicit session: session { \"id\" : UUID(\"83295a08-879f-46bf-92a0-a36769fdded9\") }\nMongoDB server version: 4.4.13\n&gt; use appdb\nswitched to db appdb\n\n&gt;  db.books.find().count()\n48\n\n&gt; db.books.count()\n48\n\n&gt; db.books.count({type:\"travel\"})\n11\n\n&gt; db.books.estimatedDocumentCount({type:\"travel\"})\n48\n\n&gt; db.books.distinct(\"type\")\n\n\n&gt; db.books.distinct(\"type\")\n[ \"literature\", \"novel\", \"sociality\", \"technology\", \"travel\" ]\n</code></pre> <p></p> <p></p> <pre><code># \u68c0\u7d22books\u96c6\u5408\u4e2d\u6240\u6709\u6587\u6863\u7684\u8ba1\u6570\ndb.books.estimatedDocumentCount()\n\n\n# \u8ba1\u7b97\u4e0e\u67e5\u8be2\u5339\u914d\u7684\u6240\u6709\u6587\u6863\ndb.books.count({favCount:{$gt:50}})\n\n&gt; db.books.count({favCount:{$gt:50}})\n1\n\n# \u8fd4\u56de\u4e0d\u540ctype\u7684\u6570\u7ec4\n&gt; db.books.distinct(\"type\")\n\n# \u8fd4\u56de\u6536\u85cf\u6570\u5927\u4e8e20\u7684\u6587\u6863\u4e0d\u540ctype\u7684\u6570\u7ec4\n&gt; db.books.distinct(\"type\",{favCount:{$gt:20}})\n[ \"sociality\" ]\n</code></pre>"},{"location":"mongo1/6mongodb_pip/#62","title":"6.2 \u805a\u5408\u7ba1\u9053","text":""},{"location":"mongo1/6mongodb_pip/#mongodb","title":"\u4ec0\u4e48\u662fMongoDB\u805a\u5408\u6846\u67b6","text":"<p>MongoDB\u805a\u5408\u6846\u67b6\uff08Aggregation Framework\uff09\u662f\u4e00\u4e2a\u8ba1\u7b97\u6846\u67b6\uff0c\u5b83\u53ef\u4ee5\uff1a</p> <ul> <li>\u4f5c\u7528\u5728\u4e00\u4e2a\u6216\u51e0\u4e2a\u96c6\u5408\u4e0a\uff1a </li> <li>\u5bf9\u96c6\u5408\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u7684\u4e00\u7cfb\u5217\u8fd0\u7b97\uff1b </li> <li>\u5c06\u8fd9\u4e9b\u6570\u636e\u8f6c\u5316\u4e3a\u671f\u671b\u7684\u5f62\u5f0f\uff1b </li> </ul> <p>\u4ece\u6548\u679c\u800c\u8a00\uff0c\u805a\u5408\u6846\u67b6\u76f8\u5f53\u4e8eSQL\u67e5\u8be2\u4e2d\u7684<code>GROUP BY</code>\u3001<code>LEFT OUTER JOIN</code>\u3001<code>AS</code>\u7b49</p>"},{"location":"mongo1/6mongodb_pip/#pipelinestage","title":"\u7ba1\u9053\uff08Pipeline\uff09\u548c\u9636\u6bb5\uff08Stage)","text":"<p>\u6574\u4e2a\u805a\u5408\u8fd0\u7b97\u8fc7\u7a0b\u79f0\u4e3a\u7ba1\u9053\uff08Pipeline)\uff0c\u5b83\u662f\u7531\u591a\u4e2a\u9636\u6bb5\uff08Stage)\u7ec4\u6210\u7684\uff0c\u6bcf\u4e2a\u7ba1\u9053</p> <ul> <li>\u63a5\u53d7\u4e00\u7cfb\u5217\u6587\u6863\uff08\u539f\u59cb\u6570\u636e\uff09; </li> <li>\u6bcf\u4e2a\u9636\u6bb5\u5bf9\u8fd9\u4e9b\u6587\u6863\u8fdb\u884c\u4e00\u7cfb\u5217\u8fd0\u7b97\uff1b </li> <li>\u7ed3\u679c\u6587\u6863\u8f93\u51fa\u7ed9\u4e0b\u4e00\u4e2a\u9636\u6bb5\uff1b </li> </ul> <p></p> <p>\u805a\u5408\u7ba1\u9053\u64cd\u4f5c\u8bed\u6cd5 </p> <pre><code>pipeline \uff1d[$stage1, $stage2\uff0c\u2026 $stageN]; \ndb.collection.aggregate(pipeline,{options}) \n</code></pre> <ul> <li>pipelines\u4e00\u7ec4\u6570\u636e\u805a\u5408\u9636\u6bb5\u3002\u9664<code>$out</code>\u3001 <code>$Merge</code>\u548c<code>\uff04geonear</code>\u9636\u6bb5\u4e4b\u5916\u3001\u6bcf\u4e2a\u9636\u6bb5\u90fd\u53ef\u4ee5\u5728\u7ba1\u9053\u4e2d\u51fa\u73b0\u591a\u6b21\u3002 </li> <li>options\u53ef\u9009\uff0c\u805a\u5408\u64cd\u4f5c\u7684\u5176\u4ed6\u53c2\u6570\u3002\u5305\u542b\uff1a\u67e5\u8be2\u8ba1\u5212\u3001\u662f\u5426\u4f7f\u7528\u4e34\u65f6\u6587\u4ef6\u3001\u6e38\u6807\u3001\u6700\u5927\u64cd\u4f5c\u65f6\u95f4\u3001\u8bfb\u5199\u7b56\u7565\u3001\u5f3a\u5236\u7d22\u5f15\u7b49\u7b49</li> </ul> <p></p>"},{"location":"mongo1/6mongodb_pip/#_1","title":"\u5e38\u7528\u7684\u7ba1\u9053\u805a\u5408\u9636\u6bb5","text":"<p>\u805a\u53f0\u7ba1\u9053\u5305\u542b\u975e\u5e38\u4e30\u5bcc\u7684\u805a\u5408\u9636\u6bb5\uff0c\u4e0b\u9762\u662f\u6700\u5e38\u7528\u7684\u805a\u5408\u9636\u6bb5 </p> <p></p> <p>https://www.mongodb.com/docs/manual/core/aggregation-pipeline/</p>"},{"location":"mongo1/6mongodb_pip/#project","title":"\u805a\u5408\u7ba1\u9053\u4e4b<code>$project</code>","text":"<p>\u6570\u636e\u51c6\u5907</p> <p>\u51c6\u5907\u6570\u636e\u96c6\uff0c\u6267\u884c\u811a\u672c </p> <p>booksnew.js</p> <pre><code>var tags = [\"nosql\",\"mongodb\",\"document\",\"developer\",\"popular\"]; \nvar types = [\"technology\",\"sociality\",\"travel\",\"novel\",\"literature\"]; \nvar books=[];\nfor(var i=0;i&lt;50;i++){\n    var typeIdx = Math.floor(Math.random()*types.length);\n    var tagIdx = Math.floor(Math.random()*tags.length);\n    var tagIdx2 = Math.floor(Math.random()*tags.length);\n    var favCount = Math.floor(Math.random()*100);\n    var username = \"xx00\" + Math.floor(Math.random()*100);\n    var age = 20 + Math.floor(Math.random()*15);\n    var book = { \n        title: \"book-\" +i, \n        type: types[typeIdx], \n        tag: tags[tagIdx], \n        favCount: favCount, \n        author: \"xxx\"+i \n    };\n    books.push(book)\n}\ndb.books.insertMany(books);\n</code></pre> <pre><code>./mongo localhost:27017 -u fox -p fox --authenticationDatabase=admin\n&gt; show dbs\nadmin   0.000GB\nappdb   0.000GB\nconfig  0.000GB\nlocal   0.000GB\n</code></pre> <pre><code>\n&gt; use aggdemo\nswitched to db aggdemo\n\n&gt; load(\"booksnew.js\")\ntrue\n</code></pre>"},{"location":"mongo1/6mongodb_pip/#project_1","title":"<code>$project</code> \u6295\u5f71\u64cd\u4f5c","text":"<p>\u5c06\u539f\u59cb\u5b57\u6bb5\u6295\u5f71\u6210\u6307\u5b9a\u540d\u79f0\uff0c\u5982\u5c06\u96c6\u5408\u4e2d\u7684\uff1atitle\u6295\u5f71\u6210name</p> <pre><code>db.books.aggregate([{$project:{name:\"$title\"}}]) \n</code></pre> <pre><code>db.books.aggregate([{$project:{name:\"$title\"}}])\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d2\"), \"name\" : \"book-0\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d3\"), \"name\" : \"book-1\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d4\"), \"name\" : \"book-2\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d5\"), \"name\" : \"book-3\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d6\"), \"name\" : \"book-4\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d7\"), \"name\" : \"book-5\" }\n</code></pre> <p><code>$project</code>\u53ef\u4ee5\u7075\u6d3b\u63a7\u5236\u8f93\u51fa\u6587\u6863\u7684\u683c\u5f0f\uff0c\u4e5f\u53ef\u4ee5\u5254\u9664\u4e0d\u9700\u8981\u7684\u5b57\u6bb5 </p> <ul> <li>1 show the cols</li> <li>0 hide the cols</li> </ul> <pre><code>db.books.aggregate([{$project:{name:\"$title\",_id:0,type:1,author:1}}])\n</code></pre> <pre><code>&gt; db.books.aggregate([{$project:{name:\"$title\",_id:0,type:1,author:1}}])\n{ \"type\" : \"novel\", \"author\" : \"xxx0\", \"name\" : \"book-0\" }\n{ \"type\" : \"literature\", \"author\" : \"xxx1\", \"name\" : \"book-1\" }\n{ \"type\" : \"technology\", \"author\" : \"xxx2\", \"name\" : \"book-2\" }\n{ \"type\" : \"novel\", \"author\" : \"xxx3\", \"name\" : \"book-3\" }\n{ \"type\" : \"technology\", \"author\" : \"xxx4\", \"name\" : \"book-4\" }\n</code></pre> <p>\u4ece\u5d4c\u5957\u6587\u6863\u4e2d\u6392\u9664\u5b57\u6bb5 </p> <pre><code>db.books.aggregate([\n    {$project:{name:\"$title\",_id:0,type:1,\"author.name\":1}}\n])\n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$project:{name:\"$title\",_id:0,type:1,\"author.name\":1}}\n... ])\n{ \"type\" : \"novel\", \"name\" : \"book-0\" }\n{ \"type\" : \"literature\", \"name\" : \"book-1\" }\n{ \"type\" : \"technology\", \"name\" : \"book-2\" }\n{ \"type\" : \"novel\", \"name\" : \"book-3\" }\n{ \"type\" : \"technology\", \"name\" : \"book-4\" }\n</code></pre> <p>\u6216\u8005</p> <pre><code>db.books.aggregate([\n    {$project:{name:\"$title\",_id:1,type:1, author:{name:1}}}\n])\n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$project:{name:\"$title\",_id:1,type:1, author:{name:1}}}\n... ])\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d2\"), \"type\" : \"novel\", \"name\" : \"book-0\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d3\"), \"type\" : \"literature\", \"name\" : \"book-1\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d4\"), \"type\" : \"technology\", \"name\" : \"book-2\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d5\"), \"type\" : \"novel\", \"name\" : \"book-3\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d6\"), \"type\" : \"technology\", \"name\" : \"book-4\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d7\"), \"type\" : \"technology\", \"name\" : \"book-5\" }\n</code></pre>"},{"location":"mongo1/6mongodb_pip/#match","title":"<code>$match</code>","text":"<p><code>$match</code>\u7528\u4e8e\u5bf9\u6587\u6863\u8fdb\u884c\u7b5b\u9009\uff0c\u4e4b\u540e\u53ef\u4ee5\u5728\u5f97\u5230\u7684\u6587\u6863\u5b50\u96c6\u4e0a\u505a\u805a\u5408\uff0c<code>$match</code>\u53ef\u4ee5\u4f7f\u7528\u9664\u4e86\u5730\u7406\u7a7a\u95f4\u4e4b\u5916\u7684\u6240\u6709\u5e38\u89c4\u67e5\u8be2\u64cd\u4f5c\u7b26\uff0c\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\u5c3d\u53ef\u80fd\u5c06<code>$match</code>\u653e\u5728\u7ba1\u9053\u7684\u524d\u9762\u4f4d\u7f6e\u3002</p> <p>\u7c7b\u4f3c\u4e8ewhere</p> <p>\u8fd9\u6837\u6709\u4e24\u4e2a\u597d\u5904\uff1a\u4e00\u662f\u53ef\u4ee5\u5feb\u901f\u5c06\u4e0d\u9700\u8981\u7684\u6587\u6863\u8fc7\u6ee4\u6389\uff0c\u4ee5\u51cf\u5c11\u7ba1\u9053\u7684\u5de5\u4f5c\u91cf\uff1b\u4e8c\u662f\u5982\u679c\u518d\u6295\u5c04\u548c\u5206\u7ec4\u4e4b\u524d\u6267\u884c<code>\uff04match</code>\uff0c\u67e5\u8be2\u53ef\u4ee5\u4f7f\u7528\u7d22\u5f15\u3002 </p> <pre><code>db.books.aggregate([{$match:{type:\"technology\"}}])\n</code></pre> <pre><code>&gt; db.books.aggregate([{$match:{type:\"technology\"}}])\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d4\"), \"title\" : \"book-2\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : 4, \"author\" : \"xxx2\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d6\"), \"title\" : \"book-4\", \"type\" : \"technology\", \"tag\" : \"developer\", \"favCount\" : 37, \"author\" : \"xxx4\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d7\"), \"title\" : \"book-5\", \"type\" : \"technology\", \"tag\" : \"popular\", \"favCount\" : 34, \"author\" : \"xxx5\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d8\"), \"title\" : \"book-6\", \"type\" : \"technology\", \"tag\" : \"nosql\", \"favCount\" : 61, \"author\" : \"xxx6\" }\n...\n</code></pre> <p>\u7b5b\u9009\u7ba1\u9053\u64cd\u4f5c\u548c\u5176\u4ed6\u7ba1\u9053\u64cd\u4f5c\u914d\u5408\u65f6\u5019\u65f6\uff0c\u5c3d\u91cf\u653e\u5230\u5f00\u59cb\u9636\u6bb5\uff0c\u8fd9\u6837\u53ef\u4ee5\u51cf\u5c11\u540e\u7eed\u7ba1\u9053\u64cd\u4f5c\u7b26\u8981\u64cd\u4f5c\u7684\u6587\u6863\u6570\uff0c\u63d0\u5347\u6548\u7387 </p> <pre><code>db.books.aggregate([{$match:{type:\"technology\",title:/book-2/}}])\n</code></pre> <pre><code>&gt; db.books.aggregate([{$match:{type:\"technology\",title:/book-2/}}])\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d4\"), \"title\" : \"book-2\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : 4, \"author\" : \"xxx2\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55ea\"), \"title\" : \"book-24\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : 77, \"author\" : \"xxx24\" }\n</code></pre>"},{"location":"mongo1/6mongodb_pip/#count","title":"<code>$count</code>","text":"<p>\u8ba1\u6570\u5e76\u8fd4\u56de\u4e0e\u67e5\u8be2\u5339\u914d\u7684\u7ed3\u679c\u6570 </p> <pre><code>db.books.aggregate([ {$match:{type:\"technology\"}}, {$count:\"type_count\"} ])\n</code></pre> <pre><code>&gt; db.books.aggregate([ {$match:{type:\"technology\"}}, {$count:\"type_count\"} ])\n{ \"type_count\" : 13 }\n</code></pre> <ul> <li><code>$match</code>\u9636\u6bb5\u7b5b\u9009\u51fatype\u5339\u914dtechnology\u7684\u6587\u6863\uff0c\u5e76\u4f20\u5230\u4e0b\u4e00\u9636\u6bb5\uff1b </li> <li><code>$count</code>\u9636\u6bb5\u8fd4\u56de\u805a\u5408\u7ba1\u9053\u4e2d\u5269\u4f59\u6587\u6863\u7684\u8ba1\u6570\uff0c\u5e76\u5c06\u8be5\u503c\u5206\u914d\u7ed9<code>type_count</code></li> </ul>"},{"location":"mongo1/6mongodb_pip/#group","title":"<code>$group</code>","text":"<p>\u6309\u6307\u5b9a\u7684\u8868\u8fbe\u5f0f\u5bf9\u6587\u6863\u8fdb\u884c\u5206\u7ec4\uff0c\u5e76\u5c06\u6bcf\u4e2a\u4e0d\u540c\u5206\u7ec4\u7684\u6587\u6863\u8f93\u51fa\u5230\u4e0b\u4e00\u4e2a\u9636\u6bb5\u3002\u8f93\u51fa\u6587\u6863\u5305\u542b\u4e00\u4e2a<code>_id</code>\u5b57\u6bb5\uff0c\u8be5\u5b57\u6bb5\u6309\u952e\u5305\u542b\u4e0d\u540c\u7684\u7ec4\u3002 </p> <p>\u8f93\u51fa\u6587\u6863\u8fd8\u53ef\u4ee5\u5305\u542b\u8ba1\u7b97\u5b57\u6bb5\uff0c\u8be5\u5b57\u6bb5\u4fdd\u5b58\u7531<code>$group</code>\u7684<code>_Id</code>\u5b57\u6bb5\u5206\u7ec4\u7684\u4e00\u4e9b<code>accumulator</code>\u8868\u8fbe\u5f0f\u7684\u503c\u3002<code>$group</code>\u4e0d\u4f1a\u8f93\u51fa\u5177\u4f53\u7684\u6587\u6863\u800c\u53ea\u662f\u7edf\u8ba1\u4fe1\u606f\u3002 </p> <pre><code>{$group:{_id:&lt;expression&gt;, &lt;field1&gt;: {&lt;accumlator1&gt; : &lt;expression1&gt;},...}}\n</code></pre> <ul> <li>id\u5b57\u6bb5\u662f\u5fc5\u586b\u7684\uff0c\u4f46\u662f\uff0c\u53ef\u4ee5\u6307\u5b9aid\u4e3anull\u6765\u4e3a\u6574\u4e2a\u8f93\u5165\u6587\u6863\u8ba1\u7b97\u7d2f\u8ba1\u503c</li> <li>\u5269\u4f59\u7684\u8ba1\u7b97\u5b57\u6bb5\u662f\u53ef\u9009\u7684\uff0c\u5e76\u4f7f\u7528<code>\uff1caccumulator\uff1e</code>\u8fd0\u7b97\u7b26\u8fdb\u884c\u8ba1\u7b97\u3002 </li> <li><code>_id</code>\u548c<code>&lt;accumulator\uff1e</code>\u8868\u8fbe\u5f0f\u53ef\u4ee5\u63a5\u53d7\u4efb\u4f55\u6709\u6548\u7684\u8868\u8fbe\u5f0f\u3002 </li> </ul> <p>accumulator \u64cd\u4f5c\u7b26</p> <p></p> <p><code>$group</code>\u9636\u6bb5\u7684\u5185\u5b58\u9650\u5236\u4e3a<code>1OOM</code>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5982\u679c<code>stage</code>\u8d85\u8fc7\u6b64\u9650\u5236\uff0c<code>$group</code>\u5c06\u4ea7\u751f\u9519\u8bef\u3002\u4f46\u662f\uff0c\u8981\u5141\u8bb8\u5904\u7406\u5927\u578b\u6570\u636e\u96c6\uff0c\u8bf7\u5c06<code>allowDiskUse</code>\u9009\u9879\u8bbe\u7f6e\u4e3a<code>true</code>\u4ee5\u542f\u7528<code>\uff04group</code>\u64cd\u4f5c\u4ee5\u5199\u5165\u4e34\u65f6\u6587\u4ef6\u3002 </p> <p>book\u7684\u6570\u91cf\uff0c\u6536\u85cf\u603b\u6570\u548c\u5e73\u5747\u503c </p> <pre><code>db.books.aggregate([\n    {$group: {_id: null, count:{$sum:1}, pop:{$sum: \"$favCount\"}, avg:{$avg:\"$favCount\"}}} \n]) \n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$group: {_id: null, count:{$sum:1}, pop:{$sum: \"$favCount\"}, avg:{$avg:\"$favCount\"}}}\n... ])\n{ \"_id\" : null, \"count\" : 50, \"pop\" : 2415, \"avg\" : 48.3 }\n</code></pre> <p>\u7edf\u8ba1\u6bcf\u4e2a\u4f5c\u8005\u7684book\u6536\u85cf\u603b\u6570</p> <pre><code>db.books.aggregate([ \n    {$group:{_id:\"$author.name\", pop:{$sum:\"$favCount\"}}} \n]) \n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$group:{_id:\"$author.name\", pop:{$sum:\"$favCount\"}}}\n... ])\n{ \"_id\" : null, \"pop\" : 2415 }\n</code></pre> <pre><code>db.books.aggregate([ \n    {$group:{_id:\"$author.name\", types:{$addToSet:\"$type\"}}} \n]) \n</code></pre>"},{"location":"mongo1/6mongodb_pip/#unwind","title":"<code>$unwind</code>","text":"<p>\u53ef\u4ee5\u5c06\u6570\u7ec4\u62c6\u5206\u4e3a\u5355\u72ec\u7684\u6587\u6863</p> <p><code>v3.2+</code> \u652f\u6301\u5982\u4e0b\u8bed\u6cd5\uff1a </p> <pre><code>{ \n    $unwind: \n    { \n    # \u8981\u6307\u5b9a\u5b87\u6bb5\u8def\u5f84\uff0c\u5728\u5b57\u6bb5\u540d\u79f0\u524d\u52a0\u4e0a$\u7b26\u5e76\u7528\u5f15\u53f7\u62ec\u8d77\u6765\u3002 \n    path: &lt;field path&gt;, \n    # \u53ef\u9009\uff0c\u4e00\u4e2a\u65b0\u5b57\u6bb5\u7684\u540d\u79f0\u7528\u4e8e\u5b58\u653e\u5143\u7d20\u7684\u6570\u7ec4\u7d22\u5f15\u3002\u8be5\u540d\u79f0\u4e0d\u80fd\u4ee5$\u5f00\u5934\u3002 \n    includeArraylndex: &lt;string&gt;, \n    # \u53ef\u9009\uff0cdefault :false\uff0c\u82e5\u4e3atrue\uff0c\u5982\u679c\u8def\u5f84\u4e3a\u7a7a\uff0c\u7f3a\u5c11\u6216\u4e3a\u7a7a\u6570\u7ec4\uff0c\u5219`$unwind`\u8f93\u51fa\u6587\u6863 \n    preserveNullAndEmptyArrays: &lt;boolean&gt; \n}} \n</code></pre> <ul> <li><code>$unwind</code>: \u8981\u6307\u5b9a\u5b87\u6bb5\u8def\u5f84\uff0c\u5728\u5b57\u6bb5\u540d\u79f0\u524d\u52a0\u4e0a$\u7b26\u5e76\u7528\u5f15\u53f7\u62ec\u8d77\u6765</li> <li>path: \u53ef\u9009\uff0c\u4e00\u4e2a\u65b0\u5b57\u6bb5\u7684\u540d\u79f0\u7528\u4e8e\u5b58\u653e\u5143\u7d20\u7684\u6570\u7ec4\u7d22\u5f15\u3002\u8be5\u540d\u79f0\u4e0d\u80fd\u4ee5<code>$</code>\u5f00\u5934\u3002</li> <li>includeArraylndex: \u53ef\u9009\uff0cdefault :false\uff0c\u82e5\u4e3atrue\uff0c\u5982\u679c\u8def\u5f84\u4e3a\u7a7a\uff0c\u7f3a\u5c11\u6216\u4e3a\u7a7a\u6570\u7ec4\uff0c\u5219<code>$unwind</code>\u8f93\u51fa\u6587\u6863 </li> </ul> <p>\u59d3\u540d\u4e3axx0006\u7684\u4f5c\u8005\u7684book\u7684tag\u6570\u7ec4\u62c6\u5206\u4e3a\u591a\u4e2a\u6587\u6863</p> <pre><code>db.books.aggregate([\n    {$match:{\"author\": \"name\":\"xxOO6\"}}, \n    {{$unwind:\"$tag\"}\n]) \n</code></pre> <pre><code>db.books.aggregate([{$unwind:\"$tag\"}])\n</code></pre> <pre><code>&gt; db.books.aggregate([{$unwind:\"$tag\"}])\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d2\"), \"title\" : \"book-0\", \"type\" : \"novel\", \"tag\" : \"developer\", \"favCount\" : 99, \"author\" : \"xxx0\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d3\"), \"title\" : \"book-1\", \"type\" : \"literature\", \"tag\" : \"mongodb\", \"favCount\" : 22, \"author\" : \"xxx1\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d4\"), \"title\" : \"book-2\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : 4, \"author\" : \"xxx2\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d5\"), \"title\" : \"book-3\", \"type\" : \"novel\", \"tag\" : \"popular\", \"favCount\" : 93, \"author\" : \"xxx3\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d6\"), \"title\" : \"book-4\", \"type\" : \"technology\", \"tag\" : \"developer\", \"favCount\" : 37, \"author\" : \"xxx4\" }\n</code></pre> <pre><code>db.books.aggregate([{$match:{type:\"travel\"}},{$unwind:\"$tag\"}])\n</code></pre> <pre><code>&gt; db.books.aggregate([{$match:{type:\"travel\"}},{$unwind:\"$tag\"}])\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7c\"), \"title\" : \"book-7\", \"type\" : \"travel\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx7\" }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7f\"), \"title\" : \"book-10\", \"type\" : \"travel\", \"tag\" : \"nosql\", \"favCount\" : -100, \"author\" : \"xxx10\", \"publishDate\" : ISODate(\"2022-03-26T09:09:54.851Z\") }\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e85\"), \"title\" : \"book-16\", \"type\" : \"travel\", \"tag\" : \"developer\", \"favCount\" : -100, \"author\" : \"xxx16\" }\n</code></pre> <p>\u59d3\u540d\u4e3a<code>xx006</code>\u7684\u4f5c\u8005\u7684book\u7684tag\u6570\u7ec4\u62c6\u5206\u4e3a\u591a\u4e2a\u6587\u6863 </p> <pre><code>db.books.aggregate([\n    {$match:{\"author.name\":\"xxx006\"}}, \n    {$unwind:\"$tag\"}\n])\n</code></pre> <p>\u6bcf\u4e2a\u4f5c\u8005\u7684book\u7684tag\u5408\u96c6</p> <pre><code>db.books.aggregate([ \n    {$unwind: \"$tag\"},\n    {$group:{_id:\"$author.name\", types:{$addToSet:\"$tag\"}}} \n]) \n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$unwind: \"$tag\"},\n... {$group:{_id:\"$author.name\", types:{$addToSet:\"$tag\"}}}\n... ])\n{ \"_id\" : null, \"types\" : [ \"developer\", \"mongodb\", \"document\", \"popular\", \"nosql\" ] }\n</code></pre> <p>\u6848\u4f8b</p> <pre><code>db.books.insert([\n{   \"title\" : \"book-51\",\n    \"type\" : \"technology\",\n    \"favCount\": 11,\n    \"tag\": [], \n    \"author\" : { \n        \"name\" : \"fox\", \n        \"age\" : 28 \n    } \n},{\n    \"title\" : \"book-52\", \n    \"type\" : \"technology\", \n    \"favCount\" : 15, \n    \"author\" : { \n        \"name\" : \"fox\", \n        \"age\" : 28 \n    } \n},{ \n  \"title\" : \"book-53\", \n  \"type\" : \"technology\", \n  \"tag\" : [ \n    \"nosql\", \n    \"document\" \n   ], \n  \"favCount\" : 20, \n  \"author\" : { \n    \"name\" : \"fox\", \n    \"age\" : 28 \n    }\n}])\n</code></pre> <pre><code>BulkWriteResult({\n    \"writeErrors\" : [ ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 3,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\n</code></pre> <p>\u6d4b\u8bd5</p> <pre><code># \u4f7f\u7528includeArrayIndex\u9009\u9879\u6765\u8f93\u51fa\u6570\u7ec4\u5143\u7d20\u7684\u6570\u7ec4\u7d22\u5f15\ndb.books.aggregate([ \n    {$match:{\"author.name\":\"fox\"}}, \n    {$unwind: {path: \"$tag\", includeArrayIndex: \"arraylndex\"}} \n]) \n# \u4f7f\u7528 preserveNullAndEmptyArrays\u9009\u9879\u5728\u8f93\u51fa\u4e2d\u7f3a\u5c11size, null\u6216\u8005\u7a7a\u6570\u7ec4\u6587\u6863\ndb.books.aggregate([ \n    {$match: {\"author.name\":\"fox\"}}, \n    {$unwind: {path:\"$tag\", preserveNullAndEmptyArrays: true}} \n])\n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$match:{\"author.name\":\"fox\"}},\n... {$unwind: {path: \"$tag\", includeArrayIndex: \"arraylndex\"}}\n... ])\n{ \"_id\" : ObjectId(\"624d6de764f997879be8a9ee\"), \"title\" : \"book-53\", \"type\" : \"technology\", \"tag\" : \"nosql\", \"favCount\" : 20, \"author\" : { \"name\" : \"fox\", \"age\" : 28 }, \"arraylndex\" : NumberLong(0) }\n{ \"_id\" : ObjectId(\"624d6de764f997879be8a9ee\"), \"title\" : \"book-53\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : 20, \"author\" : { \"name\" : \"fox\", \"age\" : 28 }, \"arraylndex\" : NumberLong(1) }\n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$match: {\"author.name\":\"fox\"}},\n... {$unwind: {path:\"$tag\", preserveNullAndEmptyArrays: true}}\n... ])\n{ \"_id\" : ObjectId(\"624d6de764f997879be8a9ec\"), \"title\" : \"book-51\", \"type\" : \"technology\", \"favCount\" : 11, \"author\" : { \"name\" : \"fox\", \"age\" : 28 } }\n{ \"_id\" : ObjectId(\"624d6de764f997879be8a9ed\"), \"title\" : \"book-52\", \"type\" : \"technology\", \"favCount\" : 15, \"author\" : { \"name\" : \"fox\", \"age\" : 28 } }\n{ \"_id\" : ObjectId(\"624d6de764f997879be8a9ee\"), \"title\" : \"book-53\", \"type\" : \"technology\", \"tag\" : \"nosql\", \"favCount\" : 20, \"author\" : { \"name\" : \"fox\", \"age\" : 28 } }\n{ \"_id\" : ObjectId(\"624d6de764f997879be8a9ee\"), \"title\" : \"book-53\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : 20, \"author\" : { \"name\" : \"fox\", \"age\" : 28 } }\n</code></pre>"},{"location":"mongo1/6mongodb_pip/#limit","title":"<code>$limit</code>","text":"<p>\u9650\u5236\u4f20\u9012\u5230\u7ba1\u9053\u4e2d\u4e0b\u4e00\u9636\u6bb5\u7684\u6587\u6863\u6570 </p> <pre><code>db.books.aggregate([\n    {$limit : 5}\n])\n</code></pre> <p>\u6b64\u64cd\u4f5c\u4ec5\u8fd4\u56de\u7ba1\u9053\u4f20\u9012\u7ed9\u5b83\u7684\u524d5\u4e2a\u6587\u6863\u3002<code>$limt</code>\u5bf9\u5176\u4f20\u9012\u7684\u6587\u6863\u5185\u5bb9\u6ca1\u6709\u5f71\u54cd\u3002</p> <p>\u6ce8\u610f\uff1a\u5f53<code>\uff04sort</code>\u5728\u7ba1\u9053\u4e2d\u7684<code>$Iimit</code>\u4e4b\u524d\u7acb\u5373\u51fa\u73b0\u65f6\uff0c<code>$sort</code>\u64cd\u4f5c\u53ea\u4f1a\u5728\u8fc7\u7a0b\u4e2d\u7ef4\u6301\u524dn\u4e2a\u7ed3\u679c\uff0c\u5176\u4e2dn\u662f\u6307\u5b9a\u7684\u9650\u5236\uff0c\u800c<code>MongoDB</code>\u53ea\u9700\u8981\u5c06n\u4e2a\u9879\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\u3002</p>"},{"location":"mongo1/6mongodb_pip/#skip","title":"<code>$skip</code>","text":"<p>\u8df3\u8fc7\u8fdb\u5165stage\u7684\u6307\u5b9a\u6570\u91cf\u7684\u6587\u6863\uff0c\u5e76\u5c06\u5176\u4f59\u6587\u6863\u4f20\u9012\u5230\u7ba1\u9053\u4e2d\u7684\u4e0b\u4e00\u4e2a\u9636\u6bb5 </p> <pre><code>db.books.aggregate([\n    {$skip : 5}\n])\n</code></pre> <p>\u6b64\u64cd\u4f5c\u5c06\u8df3\u8fc7\u7ba1\u9053\u4f20\u9012\u7ed9\u5b83\u7684\u524d5\u4e2a\u6587\u6863\u3002<code>$skip</code>\u5bf9\u6cbf\u7740\u7ba1\u9053\u4f20\u9012\u7684\u6587\u6863\u7684\u5185\u5bb9\u6ca1\u6709\u5f71\u54cd\u3002 </p>"},{"location":"mongo1/6mongodb_pip/#sort","title":"<code>$sort</code>","text":"<p>\u5bf9\u6240\u6709\u8f93\u5165\u6587\u6863\u8fdb\u884c\u6392\u5e8f\uff0c\u5e76\u6309\u6392\u5e8f\u987a\u5e8f\u5c06\u4ed6\u4eec\u8fd4\u56de\u5230\u7ba1\u9053\u3002 \u8bed\u6cd5\uff1a </p> <pre><code>{$sort: { &lt;field1&gt;: &lt;sort order&gt;,&lt;field 2&gt;: &lt;sort order\uff1e\u2026 }} \n</code></pre> <p>\u8981\u5bf9\u5b57\u6bb5\u8fdb\u884c\u6392\u5e8f\uff0c\u8bf7\u5c06\u6392\u5e8f\u987a\u5e8f\u8bbe\u7f6e\u4e3a<code>1</code>\u6216<code>-1</code>\uff0c\u4ee5\u5206\u522b\u6307\u5b9a\u5347\u5e8f\u6216\u964d\u5e8f\u6392\u5e8f\uff0c\u5982\u4e0b\u4f8b\u6240\u793a </p> <pre><code>db.books.aggregate([ \n    {$sort: {favCount:-1, title: 1}} \n])\n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$sort: {favCount:-1, title: 1}}\n... ])\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d2\"), \"title\" : \"book-0\", \"type\" : \"novel\", \"tag\" : \"developer\", \"favCount\" : 99, \"author\" : \"xxx0\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e5601\"), \"title\" : \"book-47\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : 97, \"author\" : \"xxx47\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d5\"), \"title\" : \"book-3\", \"type\" : \"novel\", \"tag\" : \"popular\", \"favCount\" : 93, \"author\" : \"xxx3\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55ef\"), \"title\" : \"book-29\", \"type\" : \"sociality\", \"tag\" : \"document\", \"favCount\" : 91, \"author\" : \"xxx29\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55fd\"), \"title\" : \"book-43\", \"type\" : \"novel\", \"tag\" : \"nosql\", \"favCount\" : 90, \"author\" : \"xxx43\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55fb\"), \"title\" : \"book-41\", \"type\" : \"literature\", \"tag\" : \"nosql\", \"favCount\" : 87, \"author\" : \"xxx41\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55e5\"), \"title\" : \"book-19\", \"type\" : \"travel\", \"tag\" : \"document\", \"favCount\" : 86, \"author\" : \"xxx19\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55dc\"), \"title\" : \"book-10\", \"type\" : \"technology\", \"tag\" : \"developer\", \"favCount\" : 84, \"author\" : \"xxx10\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55fe\"), \"title\" : \"book-44\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : 80, \"author\" : \"xxx44\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55ea\"), \"title\" : \"book-24\", \"type\" : \"technology\", \"tag\" : \"document\", \"favCount\" : 77, \"author\" : \"xxx24\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55f5\"), \"title\" : \"book-35\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : 77, \"author\" : \"xxx35\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55df\"), \"title\" : \"book-13\", \"type\" : \"literature\", \"tag\" : \"document\", \"favCount\" : 74, \"author\" : \"xxx13\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55f0\"), \"title\" : \"book-30\", \"type\" : \"technology\", \"tag\" : \"developer\", \"favCount\" : 72, \"author\" : \"xxx30\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55fc\"), \"title\" : \"book-42\", \"type\" : \"technology\", \"tag\" : \"popular\", \"favCount\" : 71, \"author\" : \"xxx42\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55e7\"), \"title\" : \"book-21\", \"type\" : \"sociality\", \"tag\" : \"popular\", \"favCount\" : 65, \"author\" : \"xxx21\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55f3\"), \"title\" : \"book-33\", \"type\" : \"novel\", \"tag\" : \"document\", \"favCount\" : 65, \"author\" : \"xxx33\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55e1\"), \"title\" : \"book-15\", \"type\" : \"novel\", \"tag\" : \"mongodb\", \"favCount\" : 64, \"author\" : \"xxx15\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d9\"), \"title\" : \"book-7\", \"type\" : \"literature\", \"tag\" : \"document\", \"favCount\" : 63, \"author\" : \"xxx7\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55ee\"), \"title\" : \"book-28\", \"type\" : \"travel\", \"tag\" : \"mongodb\", \"favCount\" : 62, \"author\" : \"xxx28\" }\n{ \"_id\" : ObjectId(\"624a4d590617ff50cb3e55d8\"), \"title\" : \"book-6\", \"type\" : \"technology\", \"tag\" : \"nosql\", \"favCount\" : 61, \"author\" : \"xxx6\" }\n</code></pre>"},{"location":"mongo1/6mongodb_pip/#lookup","title":"<code>$lookup</code>","text":"<p>Mongodb 3.2\u7248\u672c\u65b0\u589e\uff0c\u4e3b\u8981\u7528\u6765\u5b9e\u73b0\u591a\u8868\u5173\u8054\u67e5\u8be2\uff0c\u76f8\u5f53\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e2d\u591a\u8868\u5173\u8054\u67e5\u8be2\u3002\u6bcf\u4e2a\u8f93\u5165\u5f85\u5904\u7406\u7684\u6587\u6863\u7684\u5904\u7406\uff0c\u7ecf\u8fc7\uff04lookup\u9636\u6bb5 \u7684\u9002\u914d\u6587\u6863\uff0c\u8f93\u51fa\u7684\u65b0\u6587\u6863\u4e2d\u4f1a\u5305\u542b\u4e00\u4e2a\u65b0\u751f\u6210\u7684\u6570\u7ec4(\u53ef\u6839\u636e\u9700\u8981\u547d\u540d\u65b0key)\u3002\u6570\u7ec4\u5217\u5b58\u653e\u7684\u6570\u636e\u662f\u6765\u81ea\u88ab<code>Join</code>\u96c6\u5408\uff0c\u5982\u679c\u6ca1 \u6709\uff0c\u96c6\u5408\u4e3a\u7a7a\uff08\u5373\u4e3a<code>[]</code>)</p> <p>\u8bed\u6cd5 </p> <pre><code>db.collection.aggregate([{\n    $lookup:{ \n        from: \"&lt;collection to join&gt;\" \n        localField: \"&lt;field from the input documents&gt;\"\n         foreignField: \"&lt;field from the documents of the from collection&gt;\" \n         as: \"&lt;output array field&gt;\" \n    } \n}) \n</code></pre> <p></p> <p>\u6ce8\u610f\uff1anull = null \u6b64\u4e3a\u771f</p> <p>\u5176\u8bed\u6cd5\u529f\u80fd\u7c7b\u4f3c\u4e8e\u4e0b\u9762\u7684\u4f2aSQL\u8bed\u53e5</p> <pre><code>SELECT * \uff1coutput array field&gt; \nFROM collection\nWHERE \uff1coutput array field\uff1e IN (SELECT * \n                                FROM &lt;collection to join&gt; \n                                WHERE &lt;foreignField\uff1e=\uff1ccollection.local.Field&gt;);\n</code></pre> <p>\u51c6\u5907\u6570\u636e</p> <pre><code>db.customer.insert({customerCode:1, name:\"customer1\", phone:\"13112345678\",address:\"test1\"}) db.customer.insert({customerCode:2,name:\"customer2\",phone:\"13112345679\",address:\"test2\"}) \n\ndb.order.insert({orderId:1, orderCode:\"order001\",customerCode:1, price:200})\ndb.order.insert({orderId1:2,orderCode:\"order002\",customerCode:2,price:400}) \n\n\ndb.orderitem.insert({itemId:1,productName:\"apples\",qutity:2,orderId:1}) \ndb.orderItem.insert({itemId:2, productName:\"oranges\", qutity:2, orderId:1}) \n</code></pre> <p>\u5173\u8054\u67e5\u8be2</p> <pre><code>db.customer.aggregate([ \n    {$lookup:  {\n    from: \"order\", \n    localField: \"customerId\", \n    foreignField: \"customerId\", \n    as: \"customerOrder\" \n    }\n  }\n ])\n</code></pre> <pre><code>&gt; db.customer.aggregate([\n... {$lookup:  {\n... from: \"order\",\n... localField: \"customerId\",\n... foreignField: \"customerId\",\n... as: \"customerOrder\"\n... }\n...   }\n...  ])\n{ \"_id\" : ObjectId(\"624db55c64f997879be8a9ef\"), \"customerCode\" : 1, \"name\" : \"customer1\", \"phone\" : \"13112345678\", \"address\" : \"test1\", \"customerOrder\" : [ { \"_id\" : ObjectId(\"624db5b964f997879be8a9f1\"), \"orderId\" : 1, \"orderCode\" : \"order001\", \"customerCode\" : 1, \"price\" : 200 }, { \"_id\" : ObjectId(\"624db5c064f997879be8a9f2\"), \"orderId1\" : 2, \"orderCode\" : \"order002\", \"customerCode\" : 2, \"price\" : 400 } ] }\n{ \"_id\" : ObjectId(\"624db56164f997879be8a9f0\"), \"customerCode\" : 2, \"name\" : \"customer2\", \"phone\" : \"13112345679\", \"address\" : \"test2\", \"customerOrder\" : [ { \"_id\" : ObjectId(\"624db5b964f997879be8a9f1\"), \"orderId\" : 1, \"orderCode\" : \"order001\", \"customerCode\" : 1, \"price\" : 200 }, { \"_id\" : ObjectId(\"624db5c064f997879be8a9f2\"), \"orderId1\" : 2, \"orderCode\" : \"order002\", \"customerCode\" : 2, \"price\" : 400 } ] }\n</code></pre> <p><code>$lookup</code>:</p> <pre><code>db.customer.aggregate([ \n    {$lookup:  {\n    from: \"customer\", \n    localField: \"customerCode\", \n    foreignField: \"customerCode\", \n    as: \"customer\" \n    }\n  },\n    {$lookup:  {\n        from: \"orderItem\", \n        localField: \"orderId\", \n        foreignField: \"orderId\", \n        as: \"orderItem\" \n    }\n  }  \n])\n</code></pre> <pre><code>{ \"_id\" : ObjectId(\"624db55c64f997879be8a9ef\"), \"customerCode\" : 1, \"name\" : \"customer1\", \"phone\" : \"13112345678\", \"address\" : \"test1\", \"customer\" : [ { \"_id\" : ObjectId(\"624db55c64f997879be8a9ef\"), \"customerCode\" : 1, \"name\" : \"customer1\", \"phone\" : \"13112345678\", \"address\" : \"test1\" } ], \"orderItem\" : [ ] }\n{ \"_id\" : ObjectId(\"624db56164f997879be8a9f0\"), \"customerCode\" : 2, \"name\" : \"customer2\", \"phone\" : \"13112345679\", \"address\" : \"test2\", \"customer\" : [ { \"_id\" : ObjectId(\"624db56164f997879be8a9f0\"), \"customerCode\" : 2, \"name\" : \"customer2\", \"phone\" : \"13112345679\", \"address\" : \"test2\" } ], \"orderItem\" : [ ] }\n</code></pre>"},{"location":"mongo1/7mongodb_pip2/","title":"7 \u805a\u5408\u64cd\u4f5c\u9ad8\u7ea7\u64cd\u4f5c","text":"<pre><code>./mongo localhost:27017 -u fox -p fox --authenticationDatabase=admin\n</code></pre>"},{"location":"mongo1/7mongodb_pip2/#1","title":"\u805a\u5408\u64cd\u4f5c\u793a\u4f8b1","text":"<p>\u7edf\u8ba1\u6bcf\u4e2a\u5206\u7c7b\u7684book\u6587\u6863\u6570\u91cf </p> <pre><code>db.books.aggregate([ \n    {$group: {_id: \"$type\", total:{$sum:1}}}, \n    {$sort: {total: -1 }} \n]) \n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$group: {_id: \"$type\", total:{$sum:1}}},\n... {$sort: {total: -1 }}\n... ])\n{ \"_id\" : \"technology\", \"total\" : 16 }\n{ \"_id\" : \"sociality\", \"total\" : 11 }\n{ \"_id\" : \"novel\", \"total\" : 11 }\n{ \"_id\" : \"literature\", \"total\" : 8 }\n{ \"_id\" : \"travel\", \"total\" : 7 }\n</code></pre> <p>\u6807\u7b7e\u7684\u70ed\u5ea6\u6392\u884c\uff0c\u6807\u7b7e\u7684\u70ed\u5ea6\u5219\u6309\u5176\u5173\u8054book\u6587\u6863\u7684\u6536\u85cf\u6570\uff08<code>favCount</code>)\u6765\u8ba1\u7b97</p> <pre><code>db.books.aggregate([\n    {$match: {favCount:{ $gt:0 }}}, \n    {$unwind:\"$tag\"}, \n    {$group:{_id:\"$tag\", total:{$sum:\"$favCount\"}}}, \n    {$sort: {total:-1}} \n])\n</code></pre> <pre><code>&gt; db.books.aggregate([\n... {$match: {favCount:{ $gt:0 }}},\n... {$unwind:\"$tag\"},\n... {$group:{_id:\"$tag\", total:{$sum:\"$favCount\"}}},\n... {$sort: {total:-1}}\n... ])\n{ \"_id\" : \"document\", \"total\" : 712 }\n{ \"_id\" : \"popular\", \"total\" : 665 }\n{ \"_id\" : \"developer\", \"total\" : 448 }\n{ \"_id\" : \"nosql\", \"total\" : 346 }\n{ \"_id\" : \"mongodb\", \"total\" : 284 }\n</code></pre> <ol> <li><code>$match</code>\u9636\u6bb5\uff1a\u7528\u4e8e\u8fc7\u6ee4<code>favCount=O</code>\u7684\u6587\u6863\u3002 </li> <li><code>$unwind</code>\u9636\u6bb5\uff1a\u7528\u4e8e\u5c06\u6807\u7b7e\u6570\u7ec4\u8fdb\u884c\u5c55\u5f00\uff0c\u8fd9\u6837\u4e00\u4e2a\u5305\u542b3\u4e2a\u6807\u7b7e\u7684\u6587\u6863\u4f1a\u88ab\u62c6\u89e3\u4e3a3\u4e2a\u6761\u76ee\u3002 </li> <li><code>$group</code>\u9636\u6bb5\uff1a\u5bf9\u62c6\u89e3\u540e\u7684\u6587\u6863\u8fdb\u884c\u5206\u7ec4\u8ba1\u7b97\uff0c<code>$sum: \"$favCount\"</code>\u8868\u793a\u6309<code>favCount</code> \u5b57\u6bb5\u8fdb\u884c\u7d2f\u52a0\u3002 </li> <li><code>$sort</code>\u9636\u6bb5\uff1a\u63a5\u6536\u5206\u7ec4\u8ba1\u7b97\u7684\u8f93\u51fa\uff0c\u6309<code>total</code>\u5f97\u5206\u8fdb\u884c\u6392\u5e8f\u3002 </li> </ol> <p>\u7edf\u8ba1book\u6587\u6863\u6536\u85cf\u6570 <code>[0,10),[10,60),[60,80),[80,100),[100.+~)</code></p> <p>https://www.mongodb.com/docs/manual/reference/operator/aggregation/bucket/</p> <pre><code>db.books.aggregate([{ \n    $bucket:{ \n        groupBy: \"$favCount\", \n        boundaries: [0,10,60,80,100], \n        default:\"other\", \n        output: {\"count\":{$sum:1}}\n    } \n}]) \n</code></pre> <pre><code>&gt; db.books.aggregate([{\n... $bucket:{\n... groupBy: \"$favCount\",\n... boundaries: [0,10,60,80,100],\n... default:\"other\",\n... output: {\"count\":{$sum:1}}\n... }\n... }])\n{ \"_id\" : 0, \"count\" : 7 }\n{ \"_id\" : 10, \"count\" : 25 }\n{ \"_id\" : 60, \"count\" : 12 }\n{ \"_id\" : 80, \"count\" : 9 }\n</code></pre>"},{"location":"mongo1/7mongodb_pip2/#2","title":"\u805a\u5408\u64cd\u4f5c\u793a\u4f8b2","text":"<ul> <li>\u5bfc\u5165\u90ae\u653f\u7f16\u7801\u6570\u636e\u96c6: https://media.mongodb.org/zips.json</li> <li>\u4f7f\u7528<code>mongoimport</code>\u5de5\u5177\u5bfc\u5165\u6570\u636e https://www.mongodb.com/try/download/database-tools</li> </ul> <pre><code>$ wget https://fastdl.mongodb.org/tools/db/mongodb-database-tools-rhel70-x86_64-100.5.2.tg\n$ tar -zxvf mongodb-database-tools-rhel70-x86_64-100.5.2.tgz\n$ wget https://media.mongodb.org/zips.json\n</code></pre> <pre><code>cd mongodb-database-tools-rhel70-x86_64-100.5.2/bin\n./mongoimport -h localhost:27017 -u fox -p fox --authenticationDatabase=admin -c zips --file /home/vagrant/tmp/zips.json\n</code></pre> <pre><code>[root@jabox bin]# ./mongoimport -h localhost:27017 -u fox -p fox --authenticationDatabase=admin -c zips --file /home/vagrant/tmp/zips.json\n2022-04-10T12:58:31.056+0000    connected to: mongodb://localhost:27017/\n2022-04-10T12:58:31.514+0000    29353 document(s) imported successfully. 0 document(s) failed to import.\n</code></pre> <ul> <li><code>h -host</code>\uff1a\u4ee3\u8868\u8fdc\u7a0b\u8fde\u63a5\u7684\u6570\u636e\u5e93\u5730\u5740\uff0c\u4ece\u8ba4\u8fde\u63a5\u672c\u5730<code>Mongo</code> \u6570\u636e\u5e93\uff1b</li> <li><code>--port</code>:\u4ee3\u8868\u8fdc\u7a0b\u8fde\u63a5\u7684\u6570\u636e\u5e93\u7684\u7aef\u53e3\uff0c\u9ed8\u8ba4\u8fde\u63a5\u7684\u8fdc\u7a0b\u7aef\u53e3<code>27017</code>; </li> <li><code>-u\uff0c-username</code>: \u4ee3\u8868\u8fde\u63a5\u8fdc\u7a0b\u6570\u636e\u5e93\u7684\u8d26\u53f7\uff0c\u5982\u679c\u8bbe\u7f6e\u6570\u636e\u5e93\u7684\u8ba4\u8bc1\uff0c\u9700\u8981\u6307\u5b9a\u7528\u6237\u8d26\u53f7\uff1b </li> <li><code>-p\uff0c\u4e00password</code>: \u4ee3\u8868\u8fde\u63a5\u6570\u636e\u5e93\u7684\u8d26\u53f7\u5bf9\u5e94\u7684\u5bc6\u7801\uff1b </li> <li><code>-d,  --db</code>: \u4ee3\u8868\u8fde\u63a5\u7684\u6570\u636e\u5e93\uff1b</li> <li><code>-c, --collecton</code>: \u4ee3\u8868\u8fde\u63a5\u6570\u636e\u5e93\u4e2d\u7684\u96c6\u5408\uff1a </li> <li><code>-f,  --fields</code>: \u4ee3\u8868\u5bfc\u5165\u96c6\u5408\u4e2d\u7684\u5b57\u6bb5\uff1b </li> <li><code>--type</code>\uff1a\u4ee3\u8868\u5bfc\u5165\u7684\u6587\u4ef6\u7c7b\u578b\uff0c\u5305\u62eccsv\u548c<code>json.tsv</code>\u6587\u4ef6\uff0c\u9ed8\u8ba4<code>json</code>\u683c\u5f0f\uff1b </li> <li><code>--file</code>: \u5bfc\u5165\u7684\u6587\u4ef6\u540d\u79f0 </li> <li><code>--headerline</code>: \u5bfc\u5165<code>csv</code>\u6587\u4ef6\u65f6\uff0c\u6307\u660e\u7b2c\u4e00\u884c\u662f\u5217\u540d\uff0c\u4e0d\u9700\u8981\u5bfc\u5165\uff1b </li> </ul> <pre><code>./mongo localhost:27017 -u fox -p fox --authenticationDatabase=admin\n\n&gt; db.zips.find().count()\n29353\n</code></pre> <p>\u8fd4\u56de\u4eba\u53e3\u8d85\u8fc71000\u4e07\u7684\u5dde</p> <pre><code>db.zips.aggregate([\n    { $group: { _id: \"$state\", totalPop: {$sum: \"$pop\"} } },\n    { $match: { totalPop: { $gt: 10*1000*1000 } } } \n])\n</code></pre> <pre><code>&gt; db.zips.aggregate([\n... { $group: { _id: \"$state\", totalPop: {$sum: \"$pop\"} } },\n... { $match: { totalPop: { $gt: 10*1000*1000 } } }\n... ])\n{ \"_id\" : \"FL\", \"totalPop\" : 12686644 }\n{ \"_id\" : \"IL\", \"totalPop\" : 11427576 }\n{ \"_id\" : \"OH\", \"totalPop\" : 10846517 }\n{ \"_id\" : \"NY\", \"totalPop\" : 17990402 }\n{ \"_id\" : \"TX\", \"totalPop\" : 16984601 }\n{ \"_id\" : \"CA\", \"totalPop\" : 29754890 }\n{ \"_id\" : \"PA\", \"totalPop\" : 11881643 }\n</code></pre> <p>\u8fd9\u4e2a\u805a\u5408\u64cd\u4f5c\u7684\u7b49\u4ef7SQL\u662f\uff1a </p> <pre><code>SELECT state,SUM(POP)AS totalPop \nFROM zips \nGROUP BYstate \nHAVING totalPop&gt;=(10*1000*1000) \n</code></pre> <p>\u8fd4\u56de\u5404\u5dde\u5e73\u5747\u57ce\u5e02\u4eba\u53e3</p> <pre><code>db.zips.aggregate([ \n    { $group: {_id: {state: \"$state\",  city: \"$city\"}, pop: {$sum: \"$pop\"}} },\n    { $group: {_id: \"$_id.state\", avgCityPop: {$avg: \"$pop\" }}}\n])\n</code></pre> <pre><code>&gt; db.zips.aggregate([\n... { $group: {_id: {state: \"$state\",  city: \"$city\"}, pop: {$sum: \"$pop\"}} },\n... { $group: {_id: \"$_id.state\", avgCityPop: {$avg: \"$pop\" }}}\n... ])\n{ \"_id\" : \"ID\", \"avgCityPop\" : 4320.811158798283 }\n{ \"_id\" : \"AR\", \"avgCityPop\" : 4175.355239786856 }\n{ \"_id\" : \"AZ\", \"avgCityPop\" : 20591.16853932584 }\n{ \"_id\" : \"NC\", \"avgCityPop\" : 10622.815705128205 }\n{ \"_id\" : \"PA\", \"avgCityPop\" : 8679.067202337472 }\n{ \"_id\" : \"NV\", \"avgCityPop\" : 18209.590909090908 }\n{ \"_id\" : \"WY\", \"avgCityPop\" : 3384.5373134328356 }\n{ \"_id\" : \"VA\", \"avgCityPop\" : 8526.177931034483 }\n{ \"_id\" : \"MN\", \"avgCityPop\" : 5372.21375921376 }\n{ \"_id\" : \"OR\", \"avgCityPop\" : 8262.561046511628 }\n{ \"_id\" : \"OK\", \"avgCityPop\" : 6155.743639921722 }\n{ \"_id\" : \"NH\", \"avgCityPop\" : 5232.320754716981 }\n{ \"_id\" : \"IN\", \"avgCityPop\" : 9271.130434782608 }\n{ \"_id\" : \"LA\", \"avgCityPop\" : 10465.496277915632 }\n{ \"_id\" : \"ME\", \"avgCityPop\" : 3006.4901960784314 }\n{ \"_id\" : \"NM\", \"avgCityPop\" : 5872.360465116279 }\n{ \"_id\" : \"SD\", \"avgCityPop\" : 1839.6746031746031 }\n{ \"_id\" : \"MT\", \"avgCityPop\" : 2593.987012987013 }\n{ \"_id\" : \"ND\", \"avgCityPop\" : 1645.0309278350514 }\n{ \"_id\" : \"IA\", \"avgCityPop\" : 3123.0821147356583 }\n....\n</code></pre> <p>\u6309\u5dde\u8fd4\u56de\u6700\u5927\u548c\u6700\u5c0f\u7684\u57ce\u5e02</p> <pre><code>db.zips.aggregate([ \n    {$group: \n        { _id: { state:\"$state\",  city:\"$city\"}, \n            pop: {$sum:\"$pop\"} \n        } \n    }, \n    { $sort: { pop:1 } }, \n    {$group: \n        { \n            _id: \"$_id.state\", \n            biggestCity:  {$last: \"$_id.city\" }, \n            biggestPop:  {$last:\"$pop\" }, \n            smallestCity: {$first:\" $_id.city\"}, \n            smallestPop: {$first: \"$pop\" } \n        } \n    }, \n    { $project: \n        {_id:0, \n        state:\"$_id\", \n        biggestcity: {name:\"$biggestCity\",  pop:\"$biggestPop\"},\n        smallestCity:{name:\"$smallestCity\", pop:\"$smallest Pop\"} \n}}\n])\n</code></pre> <pre><code>&gt; db.zips.aggregate([\n... {$group:\n... { _id: { state:\"$state\",  city:\"$city\"},\n... pop: {$sum:\"$pop\"}\n... }\n... },\n... { $sort: { pop:1 } },\n... {$group:\n... {\n... _id: \"$_id.state\",\n... biggestCity:  {$last: \"$_id.city\" },\n... biggestPop:  {$last:\"$pop\" },\n... smallestCity: {$first:\" $_id.city\"},\n... smallestPop: {$first: \"$pop\" }\n... }\n... },\n... { $project:\n... {_id:0,\n... state:\"$_id\",\n... biggestcity: {name:\"$biggestCity\",  pop:\"$biggestPop\"},\n... smallestCity:{name:\"$smallestCity\", pop:\"$smallest Pop\"}\n... }}\n... ])\n{ \"smallestCity\" : { \"name\" : \" $_id.city\" }, \"state\" : \"HI\", \"biggestcity\" : { \"name\" : \"HONOLULU\", \"pop\" : 396643 } }\n{ \"smallestCity\" : { \"name\" : \" $_id.city\" }, \"state\" : \"AL\", \"biggestcity\" : { \"name\" : \"BIRMINGHAM\", \"pop\" : 242606 } }\n{ \"smallestCity\" : { \"name\" : \" $_id.city\" }, \"state\" : \"VT\", \"biggestcity\" : { \"name\" : \"BURLINGTON\", \"pop\" : 39127 } }\n{ \"smallestCity\" : { \"name\" : \" $_id.city\" }, \"state\" : \"GA\", \"biggestcity\" : { \"name\" : \"ATLANTA\", \"pop\" : 609591 } }\n{ \"smallestCity\" : { \"name\" : \" $_id.city\" }, \"state\" : \"FL\", \"biggestcity\" : { \"name\" : \"MIAMI\", \"pop\" : 825232 } }\n{ \"smallestCity\" : { \"name\" : \" $_id.city\" }, \"state\" : \"WA\", \"biggestcity\" : { \"name\" : \"SEATTLE\", \"pop\" : 520096 } }\n{ \"smallestCity\" : { \"name\" : \" $_id.city\" }, \"state\" : \"AK\", \"biggestcity\" : { \"name\" : \"ANCHORAGE\", \"pop\" : 183987 } }\n</code></pre>"},{"location":"mongo1/7mongodb_pip2/#53-mapreduce","title":"5.3 MapReduce","text":"<p>Map Reduce\u64cd\u4f5c\u5c06\u5927\u91cf\u7684\u6570\u636e\u5904\u7406\u5de5\u4f5c\u62c6\u5206\u6210\u591a\u4e2a\u7ebf\u7a0b\u5e76\u884c\u5904\u7406\uff0c\u7136\u540e\u5c06\u7ed3\u679c\u5408\u5e76\u5728\u4e00\u8d77\u3002MongoDB\u63d0\u4f9b\u7684Map-Reduce\u975e\u5e38\u7075\u6d3b\uff0c\u5bf9\u4e8e\u5927\u89c4\u6a21\u6570\u636e\u5206\u6790\u4e5f\u76f8\u5f53\u5b9e\u7528\u3002 </p> <p>MapReduce\u5177\u6709\u4e24\u4e2a\u9636\u6bb5\uff1a </p> <ol> <li>\u5c06\u5177\u6709\u76f8\u540cKey\u7684\u6587\u6863\u6570\u636e\u6574\u5408\u5728\u4e00\u8d77\u7684map\u9636\u6bb5 </li> <li>\u7ec4\u5408map\u64cd\u4f5c\u7684\u7ed3\u679c\u8fdb\u884c\u7edf\u8ba1\u8f93\u51fa\u7684reduce \u9636\u6bb5 </li> </ol> <p>MapReduce\u7684\u57fa\u672c\u8bed\u6cd5</p> <pre><code>db.collection.mapReduce( \n    function() { emit(key,value); },  //map \u51fd\u6570 \n    function(key,values) { return reduceFunction }, //reduce \u51fd\u6570\n{ \n    out: &lt;collection&gt;, \n    query: &lt;document&gt;, \n    sort: &lt;document&gt;, \n    limit: &lt;number&gt;, \n    finalize: &lt;function&gt;, \n    scope: &lt;document&gt;, \n    jsMode: &lt;boolean&gt;, \n    verbose: &lt;boolean&gt;, \n    bypassDocumentvalidation: &lt;boolean&gt; \n    } \n\uff09\n</code></pre> <ul> <li>map\uff0c\u5c06\u6570\u636e\u62c6\u5206\u6210\u952e\u503c\u5bf9\uff0c\u4ea4\u7ed9reduce\u51fd\u6570 </li> <li>reduce\uff0c\u6839\u636e\u952e\u5c06\u503c\u505a\u7edf\u8ba1\u8fd0\u7b97 </li> <li>out\uff0c\u53ef\u9009\uff0c\u5c06\u7ed3\u679c\u6c47\u5165\u6307\u5b9a\u8868 </li> <li>quey\uff0c\u53ef\u9009\u7b5b\u9009\u6570\u636e\u7684\u6761\u4ef6\uff0c\u7b5b\u9009\u7684\u6570\u636e\u9001\u5165map </li> <li>sort\uff0c\u6392\u5e8f\u5b8c\u540e\uff0c\u9001\u5165map </li> <li>limit \u9650\u5236\u9001\u5165map\u7684\u6587\u6863\u6570</li> <li>finalize\uff0c\u53ef\u9009\uff0c\u4fee\u6539reduce\u7684\u7ed3\u679c\u540e\u8fdb\u884c\u8f93\u51fa </li> <li>scope\uff0c\u53ef\u9009\uff0c\u6307\u5b9amap\u3001reduce\u3001finalize\u7684\u5168\u5c40\u53d8\u91cf </li> <li>jsMode\uff0c\u53ef\u9009\uff0c\u9ed8\u8ba4false\u3002</li> <li>\u5728mapreduce\u8fc7\u7a0b\u4e2d\u662f\u5426\u5c06\u6570\u636e\u8f6c\u6362\u6210bson\u683c\u5f0f\u3002 </li> <li>verbose\uff0c\u53ef\u9009\uff0c\u662f\u5426\u5728\u7ed3\u679c\u4e2d\u663e\u793a\u65f6\u95f4\uff0c\u9ed8\u8ba4false </li> <li>bypassDocmentValidation\uff0c\u53ef\u9009\uff0c\u662f\u5426\u7565\u8fc7\u6570\u636e\u6821\u9a8c </li> </ul> <p></p> <p>\u7edf\u8ba1type\u4e3atravel\u7684\u4e0d\u540c\u4f5c\u8005\u7684book\u6587\u6863\u6536\u85cf\u6570 </p> <pre><code>db.books.mapReduce( \n    function(){emit(this.author.name, this.favCount) }, \n        function(key, values){return Array.sum(values) }, \n        { \n            query: {type:\"travel\"}, \n            out: \"books_favCount\" \n    } \n) \n</code></pre> <pre><code>&gt; db.books.mapReduce(\n... function(){emit(this.author.name, this.favCount) },\n... function(key, values){return Array.sum(values) },\n... {\n... query: {type:\"travel\"},\n... out: \"books_favCount\"\n... }\n... )\n{ \"result\" : \"books_favCount\", \"ok\" : 1 }\n</code></pre>"},{"location":"mongo1/8mongodb_view/","title":"8\uff0e\u89c6\u56fe","text":"<p>MongoDB\u89c6\u56fe\u662f\u4e00\u4e2a\u53ef\u67e5\u8be2\u7684\u5bf9\u8c61\uff0c\u5b83\u7684\u5185\u5bb9\u7531\u5176\u4ed6\u96c6\u5408\u6216\u89c6\u56fe\u4e0a\u7684\u805a\u5408\u7ba1\u9053\u5b9a\u4e49\u3002MongoDB\u4e0d\u4f1a\u5c06\u89c6\u56fe\u5185\u5bb9\u6301\u4e45\u5316\u5230\u78c1\u76d8\u3002\u5f53\u5ba2\u6237\u7aef\u67e5\u8be2\u89c6\u56fe\u65f6\u89c6\u56fe\u7684\u5185\u5bb9\u6309\u8ba1\u7b97\u3002</p> <p>MongoDB\u53ef\u4ee5\u8981\u6c42\u5ba2\u6237\u7aef\u5177\u6709\u67e5\u8be2\u89c6\u56fe\u7684\u6743\u9650\u3002MongoDB\u4e0d\u652f\u6301\u5bf9\u89c6\u56fe\u8fdb\u884c\u5199\u64cd\u4f5c\u3002 </p> <p>\u4f5c\u7528\uff1a </p> <ul> <li>\u6570\u636e\u6cb9\u8c61 </li> <li>\u4fdd\u62a4\u654f\u611f\u6570\u636e\u7684\u4e00\u79cd\u65b9\u6cd5 </li> <li>\u5c06\u654f\u611f\u6570\u636e\u6295\u5f71\u5230\u89c6\u56fe\u4e4b\u5916 </li> <li>\u53ea\u8bfb </li> <li>\u7ed3\u5408\u57fa\u4e8e\u89d2\u8272\u7684\u6388\u6743\uff0c\u53ef\u6309\u89d2\u8272\u8bbf\u95ee\u4fe1\u606f </li> </ul> <p>\u6570\u636e\u51c6\u5907</p> <p><code>srars.js</code></p> <pre><code>var orders = new Array();\nvar shipping = new Array();\nvar addresses = [\"NewYork City\",\"Hoboken\",\"Jerrsey City\",\"Brea\", \"Huston\", \"Teaxs\", \"LA\",\"Brooklyn\"];\n\nfor (var i = 10000; i &lt; 20000; i++) {\n        var orderNo = i + Math.random().toString().substr(2, 5);\n        orders[i] = { orderNo: orderNo, userId: i, price: Math.round(Math.random() * 10000) / 100, qty: Math.floor(Math.random() * 10) + 1, orderTime: new Date(new Date().setSeconds(Math.floor(Math.random() * 10000))) };\n\n        var address = addresses[Math.floor(Math.random() * 10)];\n        shipping[i] = {orderNo: orderNo, address: address, recipienter: \"Wilson\", province: address.substr(0, 3), city: address.substr(3,3) }\n}\ndb.order.insert(orders);\ndb.shipping.insert(shipping);\n\n</code></pre> <pre><code>./mongo localhost:27017 -u fox -p fox --authenticationDatabase=admin\n&gt; show dbs\n\n&gt; use viewdemo\nswitched to db viewdemo\n\n&gt; load(\"stats.js\")\ntrue\n</code></pre>"},{"location":"mongo1/8mongodb_view/#81","title":"8.1 \u521b\u5efa\u89c6\u56fe","text":"<p>\u57fa\u672c\u8bed\u6cd5\u683c\u5f0f </p> <pre><code>db.createView( \n    \"&lt;viewName&gt;\",\n  \"&lt;source&gt;\", \n  [&lt;pipeline\uff1e],\n   { \n   \"collation\" : {&lt;collation&gt;} \n    }\n)\n</code></pre> <ul> <li><code>viewName</code> \u5fc5\u987b\uff0c\u89c6\u56fe\u540d\u79f0 </li> <li><code>source</code> \u5fc5\u987b\uff0c\u6570\u636e\u6e90\uff0c\u96c6\u5408\uff0f\u89c6\u56fe </li> <li><code>[&lt;pipeline&gt;]</code>\uff1a\u53ef\u9009\uff0c\u4e00\u7ec4\u7ba1\u9053 </li> <li><code>Collation</code>:  \u53ef\u9009\uff0c\u6392\u5e8f\u89c4\u5219 </li> </ul> <p>\u5355\u4e2a\u96c6\u5408\u521b\u5efa\u89c6\u56fe</p> <p>\u5047\u8bbe\u73b0\u5728\u67e5\u770b\u5f53\u5929\u6700\u9ad8\u768410\u7b14\u8ba2\u5355\u89c6\u56fe\uff0c\u4f8b\u5982\u9700\u8981\u5b9e\u65f6\u663e\u793a\u91d1\u989d\u6700\u9ad8\u7684\u8ba2\u5355 </p> <pre><code>db.createView(\n    \u201dorderInfo\", //\u89c6\u56fe\u540d\u79f0\n    \u201dorder\",     //\u6570\u636e\u6e90\n    [\n      // \u7b5b\u9009\u7b26\u5408\u6761\u4ef6\u7684\u8ba2\u5355\uff0c\u5927\u4e8e\u5f53\u5929\uff0c\u8fd9\u91cc\u8981\u6ce8\u610f\u65f6\u533a \n      {$match: {\"orderTime\":    { $gte:ISODate(\"2022-01-26T00:00:00.000Z\u201c }}},\n    // \u6309\u91d1\u989d\u5012\u5e8f \n    {$sort: {\"price\"\uff1a-1}},\n    // \u9650\u523610\u4e2a\u6587\u6863\n    { $limit: 10 },\n    // \u9009\u62e9\u8981\u663e\u793a\u7684\u5b57\u6bb5\n    // O: \u5b89\u6392\u9664\u5b57\u6bb5\uff0c\u82e5\u5b57\u6bb5\u4e0a\u4f7f\u7528\uff08_id\u9664\u5916\uff09\u5c31\u4e0d\u80fd\u6709\u5176\u4ed6\u5305\u542b\u5b57\u6bb5\n    // 1: \u5305\u542b\u5b57\u6bb5\n     { $project: { _id:0,  orderNo: 1, price:1, orderTime: 1  } }\n ]\n)\n</code></pre> <p>\u89c6\u56fe\u521b\u5efa\u6210\u529f\u540e\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u89c6\u56fe\u67e5\u8be2\u6570\u636e </p> <p>\u591a\u4e2a\u96c6\u5408\u521b\u5efa\u89c6\u56fe </p> <p>\u8ddf\u5355\u4e2a\u662f\u96c6\u5408\u662f\u4e00\u6837\uff0c\u53ea\u662f\u591a\u4e86\uff04$Iookup\u8fde\u63a5\u64cd\u4f5c\u7b26\uff0c\u89c6\u56fe\u6839\u636e\u7ba1\u9053\u6700\u7ec8\u7ed3\u679c\u663e\u793a\uff0c\u6240\u4ee5\u53ef\u4ee5\u5173\u8054\u591a\u4e2a\u96c6\u5408 </p> <pre><code>db.orderDetail.drop() \ndb.createView(\n    \"orderDetail\",\n    \"order\",\n    [\n        {$lookup:{ from:\"shipping\", localField: \"orderNo\", foreignField:\"orderNo\", as:\"shipping\" }},\n        {$project: { \"orderNo\":1, \"price\":1, \"shipping.address\":1 }} \n    ]\n)\n</code></pre>"},{"location":"mongo1/8mongodb_view/#62","title":"6.2 \u4fee\u6539\u89c6\u56fe","text":"<pre><code>db.runCommand[{ \n    collMod: \"ordeInfo\", \n    viewOn\uff1a\"order\" \n    pipeline:[\n        {$match: {\"ordeTime\": {$gte\uff1aISODate(\"2020-04-13T16:00:00.000z\")}}}\uff0c\n        {$sort:{\"price\"\uff1a-1}}, \n        {$limit:10}, \n        // \u589e\u52a0qty \n        {$project:{ _id:0, orderNo:1, price:1, qty:1, orderTime:1}} \n]\n}) \n</code></pre>"},{"location":"mongo1/8mongodb_view/#62_1","title":"6.2 \u4fee\u6539\u89c6\u56fe","text":"<pre><code>db.orderInfo.drop()\n</code></pre>"},{"location":"mongo1/9mongodb_index/","title":"9 MongoDB\u7d22\u5f15","text":""},{"location":"mongo1/9mongodb_index/#91","title":"9.1 \u4ecb\u7ecd","text":"<p>\u7d22\u5f15\u662f\u4e00\u79cd\u7528\u6765\u5feb\u901f\u67e5\u8be2\u6570\u636e\u7684\u6570\u636e\u7ed3\u6784\u3002B+ Tree\u5c31\u662f\u4e00\u79cd\u5e38\u7528\u7684\u6570\u636e\u5e93\u7d22\u5f15\u6570\u636e\u7ed3\u6784\uff0cMongoDB\u91c7\u7528<code>B+ Tree</code>\u505a\u7d22\u5f15\uff0c\u7d22\u5f15\u521b\u5efa\u5728<code>colletions</code>\u4e0a\u3002</p> <p>MongoDB\u4e0d\u4f7f\u7528\u7d22\u5f15\u7684\u67e5\u8be2\uff0c\u5148\u626b\u63cf\u6240\u6709\u7684\u6587\u6863\uff0c\u518d\u5339\u914d\u7b26\u5408\u6761\u4ef6\u7684\u6587\u6863\u3002\u4f7f\u7528\u7d22\u5f15\u7684\u67e5\u8be2\uff0c\u901a\u8fc7\u7d22\u5f15\u627e\u5230\u6587\u6863\uff0c\u4f7f\u7528\u7d22\u5f15\u80fd\u591f\u6781\u5927\u7684\u63d0\u5347\u67e5\u8be2\u6548\u7387\u3002 </p>"},{"location":"mongo1/9mongodb_index/#mongodb","title":"MongoDB\u7d22\u5f15\u6570\u636e\u7ed3\u6784","text":"<p>\u601d\u8003\uff1aMongoDB\u7d22\u5f15\u6570\u636e\u7ed3\u6784\u662f<code>B-Tree</code>\u8fd8\u662f<code>B+ Tree</code> \uff1f</p> <p><code>B-Tree</code>\u8bf4\u6cd5\u6765\u6e90\u4e8e\u5b98\u65b9\u6587\u6863\uff0c\u7136\u540e\u5c31\u5bfc\u81f4\u4e86\u5206\u6b67\uff1a\u6709\u4eba\u8bf4<code>MongoDB</code>\u7d22\u5f15\u6570\u636e\u7ed3\u6784\u4f7f\u7528\u7684\u662f<code>B-Tree</code>\uff0c\u6709\u7684\u4eba\u53c8\u8bf4\u662f<code>B\uff0b Tree</code> </p> <p>MongoDB\u5b98\u65b9\u6587\u6863\uff1ahttps://docs.mongodb.com/manual/indexes/</p> <p>MongoDB indexes use a B-tree data structure. </p> <p></p> <p></p>"},{"location":"mongo1/9mongodb_index/#_1","title":"\u7d22\u5f15\u7684\u5206\u7c7b","text":"<ul> <li>\u6309\u7167\u7d22\u5f15\u5305\u542b\u7684\u5b57\u6bb5\u6570\u91cf\uff0c\u53ef\u4ee5\u5206\u4e3a\u5355\u952e\u7d22\u5f15\u548c\u7ec4\u5408\u7d22\u5f15\uff08\u6216\u590d\u5408\u7d22\u5f15\uff09\u3002 </li> <li>\u6309\u7167\u7d22\u5f15\u5b57\u6bb5\u7684\u7c7b\u578b\uff0c\u53ef\u4ee5\u5206\u4e3a\u4e3b\u952e\u7d22\u5f15\u548c\u975e\u4e3b\u952e\u7d22\u5f15\u3002 </li> <li>\u6309\u7167\u7d22\u5f15\u8282\u70b9\u4e0e\u7269\u7406\u8bb0\u5f55\u7684\u5bf9\u5e94\u65b9\u5f0f\u6765\u5206\uff0c\u53ef\u4ee5\u5206\u4e3a\u805a\u7c07\u7d22\u5f15\u548c\u975e\u805a\u7c07\u7d22\u5f15\uff0c\u5176\u4e2d\u805a\u7c07\u7d22\u5f15\u662f\u6307\u7d22\u5f15\u8282\u70b9\u4e0a\u76f4\u63a5\u5305\u542b\u4e86\u6570\u636e\u8bb0\u5f55\uff0c\u800c\u540e\u8005\u5219\u4ec5\u4ec5\u5305\u542b\u4e00\u4e2a\u6307\u5411\u6570\u636e\u8bb0\u5f55\u7684\u6307\u9488\u3002 </li> <li>\u6309\u7167\u7d22\u5f15\u7684\u7279\u6027\u4e0d\u540c\uff0c\u53c8\u53ef\u4ee5\u5206\u4e3a\u552f\u4e00\u7d22\u5f15\u3001\u7a00\u758f\u7d22\u5f15\u3001\u6587\u672c\u7d22\u5f15\u3001\u5730\u7406\u7a7a\u95f4\u7d22\u5f15\u7b49</li> </ul> <p>\u4e0e\u5927\u591a\u6570\u6570\u636e\u5e93\u4e00\u6837\uff0cMongoDB\u652f\u6301\u5404\u79cd\u4e30\u5bcc\u7684\u7d22\u5f15\u7c7b\u578b\uff0c\u5305\u6d3b\u5355\u952e\u7d22\u5f15\u3001\u590d\u5408\u7d22\u5f15\u552f\u4e00\u7d22\u5f15\u7b49\u4e00\u4e9b\u5e38\u7528\u7684\u7ed3\u6784\u3002</p> <p>\u7531\u4e8e\u91c7\u7528\u4e86\u7075\u6d3b\u53ef\u53d8\u7684\u6587\u6863\u7c7b\u578b\uff0c\u56e0\u6b64\u5b83\u4e5f\u540c\u6837\u652f\u6301\u5bf9\u5d4c\u5957\u5b57\u6bb5\u3001\u6570\u7ec4\u8fdb\u884c\u7d22\u5f15\u3002\u901a\u8fc7\u5efa\u7acb\u5408\u9002\u7684\u7d22\u5f15\uff0c\u6211\u4eec\u53ef\u4ee5\u6781\u5927\u5730\u63d0\u5347\u6570\u636e\u7684\u68c0\u7d22\u901f\u5ea6\u3002\u5728\u4e00\u4e9b\u7279\u6b8a\u5e94\u7528\u573a\u666f\uff0cMongoDB\u8fd8\u652f\u6301\u5730\u7406\u7a7a\u95f4\u7d22\u5f15\u3001\u6587\u672c\u68c0\u7d22\u7d22\u5f15\u3001TTL\u7d22\u5f15\u7b49\u4e0d\u540c\u7684\u7279\u6027\u3002 </p>"},{"location":"mongo1/9mongodb_index/#92","title":"9.2 \u7d22\u5f15\u64cd\u4f5c","text":""},{"location":"mongo1/9mongodb_index/#_2","title":"\u521b\u5efa\u7d22\u5f15","text":"<p>\u521b\u5efa\u7d22\u5f15\u8bed\u6cd5\u683c\u5f0f </p> <pre><code>db.collection.createIndex(keys,options) \n</code></pre> <ul> <li>Key\u503c\u4e3a\u4f60\u8981\u521b\u5efa\u7684\u7d22\u5f15\u5b57\u6bb5\uff0c1\u6309\u5347\u5e8f\u521b\u5efa\u7d22\u7d22\u5f15, -1 \u6309\u964d\u5e8f\u521b\u5efa\u7d22\u5f15</li> <li>\u53ef\u9009\u53c2\u6570\u5217\u8868\u5982\u4e0b\uff1a </li> </ul> <p></p> <p>\u6ce8\u610f\uff1a3.0.0\u7248\u672c\u524d\u521b\u5efa\u7d22\u5f15\u65b9\u6cd5\u4e3a<code>db.collection.ensurelndex()</code> </p> <pre><code>\uff03\u521b\u5efa\u7d22\u5f15\u540e\u53f0\u6267\u884c \ndb.values.createIndex({open:1, close:1}, {background:true}) \n\n\uff03\u521b\u5efa\u552f\u4e00\u7d22\u5f15 \ndb.values.createlndex({title:1}, {unique:true}) \n</code></pre> <pre><code>---\n&gt; show dbs\nadmin     0.000GB\naggdemo   0.000GB\nappdb     0.000GB\nconfig    0.000GB\nlocal     0.000GB\ntest      0.002GB\nviewdemo  0.001GB\n&gt; use appdb\nswitched to db appdb\n&gt; show tables\nbooks\nemps\nuser\n</code></pre> <pre><code>&gt; db.books.getIndexes()\n[ { \"v\" : 2, \"key\" : { \"_id\" : 1 }, \"name\" : \"_id_\" } ]\n</code></pre> <pre><code>&gt; db.books.find({title:\"book-8\"})\n{ \"_id\" : ObjectId(\"623b0766b815b989a2335e7d\"), \"title\" : \"book-8\", \"type\" : \"sociality\", \"tag\" : \"mongodb\", \"favCount\" : -100, \"author\" : \"xxx8\" \n</code></pre> <pre><code>&gt; db.books.find({title:\"book-8\"}).explain()\n{\n    \"queryPlanner\" : {\n        \"plannerVersion\" : 1,\n        \"namespace\" : \"appdb.books\",\n        \"indexFilterSet\" : false,\n        \"parsedQuery\" : {\n            \"title\" : {\n                \"$eq\" : \"book-8\"\n            }\n        },\n        \"queryHash\" : \"6E0D6672\",\n        \"planCacheKey\" : \"6E0D6672\",\n        \"winningPlan\" : {\n            \"stage\" : \"COLLSCAN\",\n    ...\n</code></pre> <pre><code>db.books.createIndex({title:1})\n</code></pre> <pre><code>&gt; db.books.createIndex({title:1})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>db.books.getIndexes()\n\n&gt; db.books.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"title\" : 1\n        },\n        \"name\" : \"title_1\"\n    }\n]\n</code></pre> <p>\u6ce8\u610f\uff1a3.0.0\u7248\u672c\u524d\u521b\u5efa\u7d22\u5f15\u65b9\u6cd5\u4e3a<code>db.collection.ensureIndex()</code></p> <pre><code>\uff03\u521b\u5efa\u7d22\u5f15\u540e\u53f0\u6267\u884c \ndb.values.createIndex({open:1, close:1}, {background:true}) \n\uff03\u521b\u5efa\u552f\u4e00\u7d22\u5f15 \ndb.values.createIndex({title:1},{unique:true}) \n</code></pre>"},{"location":"mongo1/9mongodb_index/#_3","title":"\u67e5\u770b\u7d22\u5f15","text":"<pre><code>#\u67e5\u770b\u7d22\u5f15\u4fe1\u606f \ndb.books.getIndexes() \n\n\uff03\u67e5\u770b\u7d22\u5f15\u952e \ndb.books.getIndexKeys() \n</code></pre> <pre><code>\u67e5\u770b\u7d22\u5f15\u5360\u7528\u7a7a\u95f4 \ndb.collection.totalIndexSize([is_detail]\uff09 \n</code></pre> <ul> <li><code>is_detail</code>\uff1a\u53ef\u9009\u53c2\u6570\uff0c\u4f20\u5165\u96640\u6216false\u5916\u7684\u4efb\u610f\u6570\u636e\uff0c\u90fd\u4f1a\u663e\u793a\u8be5\u96c6\u5408\u4e2d\u6bcf\u4e2a\u7d22\u5f15\u7684\u5927\u5c0f\u53ca\u603b\u5927\u5c0f\u3002\u5982\u679c\u4f20\u51650\u6216false\u5219\u53ea\u663e\u793a\u8be5\u96c6\u5408\u4e2d\u6240\u6709\u7d22\u5f15\u7684\u603b\u5927\u5c0f\u3002\u9ed8\u8ba4\u503c\u4e3afalse</li> </ul> <pre><code>&gt; db.books.getIndexKeys()\n[ { \"_id\" : 1 }, { \"title\" : 1 } ]\n\n&gt; db.books.totalIndexSize()\n57344\n\n&gt; db.books.totalIndexSize(0)\n57344\n\n&gt; db.books.totalIndexSize(1)\n_id_    36864\ntitle_1 20480\n57344\n</code></pre>"},{"location":"mongo1/9mongodb_index/#_4","title":"\u5220\u9664\u7d22\u5f15","text":"<pre><code>\uff03\u5220\u9664\u96c6\u5408\u6307\u5b9a\u7d22\u5f15 \ndb.col.dropIndex(\"\u7d22\u5f15\u540d\u79f0\") \n\n\uff03\u5220\u9664\u96c6\u5408\u6240\u6709\u7d22\u5f15 \ndb.col.dropIndexes()\n</code></pre>"},{"location":"mongo1/9mongodb_index/#93","title":"9.3 \u7d22\u5f15\u7c7b\u578b","text":""},{"location":"mongo1/9mongodb_index/#single-field-indexes","title":"\u5355\u952e\u7d22\u5f15\uff08Single Field Indexes)","text":"<p>\u5728\u67d0\u4e00\u4e2a\u7279\u5b9a\u7684\u5b57\u6bb5\u4e0a\u5efa\u7acb\u7d22\u5f15mongoDB\u5728ID\u4e0a\u5efa\u7acb\u4e86\u552f\u4e00\u7684\u5355\u952e\u7d22\u5f15\uff0c\u6240\u4ee5\u7ecf\u5e38\u4f1a\u4f7f\u7528Id\u6765\u8fdb\u884c\u67e5\u8be2\uff1b\u5728\u7d22\u5f15\u5b57\u6bb5\u4e0a\u8fdb\u884c\u7cbe\u786e\u5339\u914d\u3001 \u6392\u5e8f\u4ee5\u53ca\u8303\u56f4\u67e5\u627e\u90fd\u4f1a\u4f7f\u7528\u6b64\u7d22\u5f15 </p> <p></p> <pre><code>db.books.createIndex({title:1})\n</code></pre> <p>\u5185\u5d4c\u6587\u6863\u5b57\u6bb5\u521b\u5efa\u7d22\u5f15</p> <pre><code>db.books.createIndex({\"author.name\":1}\n\n\n&gt; db.books.createIndex({\"author.name\":1})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 2,\n    \"numIndexesAfter\" : 3,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>&gt; db.books.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"title\" : 1\n        },\n        \"name\" : \"title_1\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"author.name\" : 1\n        },\n        \"name\" : \"author.name_1\"\n    }\n]\n</code></pre>"},{"location":"mongo1/9mongodb_index/#compound-index","title":"\u590d\u5408\u7d22\u5f15\uff08Compound Index)","text":"<p>\u590d\u5408\u7d22\u5f15\u662f\u591a\u4e2a\u5b57\u6bb5\u7ec4\u5408\u800c\u6210\u7684\u754c\u5f15\uff0c\u5176\u6027\u8d28\u548c\u5355\u5b57\u6bb5\u7d22\u5f15\u7c7b\u4f3c\u3002\u4f46\u4e0d\u540c\u7684\u662f\uff0c\u590d\u5408\u7d22\u5f15\u4e2d\u5b57\u6bb5\u7684\u987a\u5e8f\u3001\u5b57\u6bb5\u7684\u5347\u964d\u5e8f\u5bf9\u67e5\u8be2\u6027\u80fd\u6709\u76f4\u63a5 \u7684\u5f71\u54cd\uff0c\u56e0\u6b64\u5728\u8bbe\u8ba1\u590d\u5408\u7d22\u5f15\u65f6\u5219\u9700\u8981\u8003\u8651\u4e0d\u540c\u7684\u67e5\u8be2\u573a\u666f\u3002 </p> <p></p> <pre><code>db.books.createIndex({type:1, favCount:1})\n</code></pre> <pre><code>&gt; db.books.createIndex({type:1, favCount:1})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 3,\n    \"numIndexesAfter\" : 4,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>&gt; db.books.getIndexes()\n...\n{\n        \"v\" : 2,\n        \"key\" : {\n            \"type\" : 1,\n            \"favCount\" : 1\n        },\n        \"name\" : \"type_1_favCount_1\"\n    }\n]\n</code></pre>"},{"location":"mongo1/9mongodb_index/#multikey-index","title":"\u591a\u952e\u7d22\u5f15\uff08Multikey Index)","text":"<p>\u5728\u6570\u7ec4\u7684\u5c5e\u6027\u4e0a\u5efa\u7acb\u7d22\u5f15\u3002\u9488\u5bf9\u8fd9\u4e2a\u6570\u5587\u7684\u4efb\u610f\u503c\u7684\u67e5\u8be2\u90fd\u4f1a\u5b9a\u4f4d\u5230\u8fd9\u4e2a\u6587\u6863\uff0c\u65e2\u591a\u4e2a\u7d22\u5f15\u5165\u53e3\u6216\u8005\u952e\u503c\u5f15\u7528\u540c\u4e00\u4e2a\u6587\u6863 </p> <p></p> <pre><code>db.inventory.insertMany([ \n    { _id: 5, type: \"food\", item: \"aaa\", ratings: [ 5, 8, 9 ] }, \n    { _id: 6, type: \"food\", item: \"bbb\", ratings: [ 5, 9 ] }, \n    { _id: 7, type: \"food\", item: \"ccc\", ratings: [ 9, 5, 8 ] }, \n    { _id: 8, type: \"food\", item: \"ddd\", ratings: [ 9, 5 ] },\n    { _id: 9, type: \"food\", item: \"eee\", ratings: [ 5, 9, 5 ] }\n]) \n</code></pre> <pre><code>&gt; db.inventory.insertMany([\n... { _id: 5, type: \"food\", item: \"aaa\", ratings: [ 5, 8, 9 ] },\n... { _id: 6, type: \"food\", item: \"bbb\", ratings: [ 5, 9 ] },\n... { _id: 7, type: \"food\", item: \"ccc\", ratings: [ 9, 5, 8 ] },\n... { _id: 8, type: \"food\", item: \"ddd\", ratings: [ 9, 5 ] },\n... { _id: 9, type: \"food\", item: \"eee\", ratings: [ 5, 9, 5 ] }\n... ])\n{ \"acknowledged\" : true, \"insertedIds\" : [ 5, 6, 7, 8, 9 ] }\n</code></pre> <p>\u521b\u5efa\u591a\u952e\u7d22\u5f15</p> <pre><code>&gt; db.inventory.createIndex({ ratings:1 })\n</code></pre> <pre><code>&gt; db.inventory.createIndex({ ratings:1 })\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <p>\u591a\u952e\u7d22\u5f15\u5f88\u5bb9\u6613\u4e0e\u590d\u5408\u7d22\u5f15\u4ea7\u751f\u6df7\u6dc6\uff0c\u590d\u5408\u7d22\u5f15\u662f\u591a\u4e2a\u5b57\u6bb5\u7684\u7ec4\u5408\uff0c\u800c\u591a\u952e\u7d22\u5f15\u5219\u4ec5\u4ec5\u662f\u5728\u4e00\u4e2a\u5b57\u6bb5\u4e0a\u51fa\u73b0\u4e86\u591a\u952e(multi key)\u3002\u800c\u5b9e\u8d28\u4e0a\uff0c\u591a\u952e\u7d22\u5f15\u4e5f\u53ef\u4ee5\u51fa\u73b0\u5728\u590d\u5408\u5b57\u6bb5\u4e0a </p> <pre><code>\uff03\u521b\u5efa\u590d\u5408\u591a\u503c\u7d22\u5f15 \ndb.inventory.createIndex({item:1, ratings:1}) \n</code></pre> <p>\u6c6a\u610f\uff1aMongoDB\u5e76\u4e0d\u652f\u6301\u4e00\u4e2a\u590d\u5408\u7d22\u5f15\u4e2d\u540c\u65f6\u51fa\u73b0\u591a\u4e2a\u6570\u7ec4\u5b57\u6bb5</p> <p>\u5d4c\u5165\u6587\u6863\u7684\u7d22\u5f15\u6570\u7ec4</p> <pre><code>&gt; db.inventory.createIndex({item:1, ratings:1})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 2,\n    \"numIndexesAfter\" : 3,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>&gt; db.inventory.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"ratings\" : 1\n        },\n        \"name\" : \"ratings_1\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"item\" : 1,\n            \"ratings\" : 1\n        },\n        \"name\" : \"item_1_ratings_1\"\n    }\n]\n</code></pre> <pre><code>db.inventory.insertMany([ \n{ \n    _id: 1, \n    item: \"abc\",\n    stock: [ \n        { size: \"S\", color: \"red\", quantity: 25 }, \n        { size: \"S\", color: \"blue\", quantity: 10 }, \n        { size: \"M\", color: \"blue\", quantity: 50 } \n    ] \n},\n{ \n    _id: 2, \n    item: \"def\",\n    stock: [ \n    { size: \"S\", color: \"blue\", quantity: 20 }, \n    { size: \"M\", color: \"blue\", quantity: 5 },\n    { size: \"M\", color: \"black\", quantity: 10 }, \n    { size: \"L\", color: \"red\", quantity: 2 } \n  ] \n},\n{\n    _id: 3, \n    item: \"def\",\n    stock: [ \n    { size: \"S\", color: \"blue\", quantity: 15 }, \n    { size: \"L\", color: \"blue\", quantity: 100 },\n    { size: \"L\", color: \"red\", quantity: 25 } \n  ] \n}\n])\n</code></pre> <pre><code>{ \"acknowledged\" : true, \"insertedIds\" : [ 1, 2, 3 ] }\n</code></pre> <pre><code>&gt; db.inventory.find()\n{ \"_id\" : 1, \"item\" : \"abc\", \"stock\" : [ { \"size\" : \"S\", \"color\" : \"red\", \"quantity\" : 25 }, { \"size\" : \"S\", \"color\" : \"blue\", \"quantity\" : 10 }, { \"size\" : \"M\", \"color\" : \"blue\", \"quantity\" : 50 } ] }\n{ \"_id\" : 2, \"item\" : \"def\", \"stock\" : [ { \"size\" : \"S\", \"color\" : \"blue\", \"quantity\" : 20 }, { \"size\" : \"M\", \"color\" : \"blue\", \"quantity\" : 5 }, { \"size\" : \"M\", \"color\" : \"black\", \"quantity\" : 10 }, { \"size\" : \"L\", \"color\" : \"red\", \"quantity\" : 2 } ] }\n{ \"_id\" : 3, \"item\" : \"def\", \"stock\" : [ { \"size\" : \"S\", \"color\" : \"blue\", \"quantity\" : 15 }, { \"size\" : \"L\", \"color\" : \"blue\", \"quantity\" : 100 }, { \"size\" : \"L\", \"color\" : \"red\", \"quantity\" : 25 } ] }\n</code></pre> <p>\u5728\u5305\u542b\u5d4c\u5957\u5bf9\u8c61\u7684\u6570\u7ec4\u5b57\u6bb5\u4e0a\u521b\u5efa\u591a\u952e\u7d22\u5f15 </p> <pre><code>db.inventory.createIndex( {\"stock.size\":1, \"stock.quantity\": 1 }) \n</code></pre> <pre><code>&gt; db.inventory.createIndex( {\"stock.size\":1, \"stock.quantity\": 1 })\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 3,\n    \"numIndexesAfter\" : 4,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>db.inventory.find( {\"stock.size\": \"S\", \"stock.quantity\": { $gt:20 } }) \n\n&gt; db.inventory.find( {\"stock.size\": \"S\", \"stock.quantity\": { $gt:20 } })\n{ \"_id\" : 1, \"item\" : \"abc\", \"stock\" : [ { \"size\" : \"S\", \"color\" : \"red\", \"quantity\" : 25 }, { \"size\" : \"S\", \"color\" : \"blue\", \"quantity\" : 10 }, { \"size\" : \"M\", \"color\" : \"blue\", \"quantity\" : 50 } ] }\n{ \"_id\" : 3, \"item\" : \"def\", \"stock\" : [ { \"size\" : \"S\", \"color\" : \"blue\", \"quantity\" : 15 }, { \"size\" : \"L\", \"color\" : \"blue\", \"quantity\" : 100 }, { \"size\" : \"L\", \"color\" : \"red\", \"quantity\" : 25 } ] }\n</code></pre>"},{"location":"mongo1/9mongodb_index/#geospatial-index","title":"\u5730\u7406\u7a7a\u95f4\u7d22\u5f15\uff08Geospatial Index)","text":"<p>\u5728\u79fb\u52a8\u4e92\u8054\u7f51\u65f6\u4ee3\uff0c\u57fa\u4e8e\u5730\u7406\u4f4d\u7f6e\u7684\u68c0\u7d22\uff08LBS)\u529f\u80fd\u51e0\u4e4e\u662f\u6240\u6709\u5e94\u7528\u7cfb\u7edf\u7684\u6807\u914d\u3002MongoDB\u4e3a\u5730\u7406\u7a7a\u95f4\u68c0\u7d22\u63d0\u4f9b\u4e86\u975e\u5e38\u65b9\u4fbf\u7684\u529f\u80fd\u3002 \u5730\u7406\u7a7a\u95f4\u7d22\u5f15(2dsphereindex\uff09\u5c31\u662f\u4e13\u95e8\u7528\u4e8e\u5b9e\u73b0\u4f4d\u7f6e\u68c0\u7d22\u7684\u4e00\u79cd\u7279\u6b8a\u7d22\u5f15\u3002 </p> <p>\u6848\u4f8b\uff1aMongoDB\u5982\u4f55\u5b9e\u73b0\u201c\u67e5\u8be2\u9644\u8fd1\u5546\u5bb6\"\uff1f </p> <p>\u5047\u8bbe\u5546\u5bb6\u7684\u6570\u636e\u6a21\u578b\u5982\u4e0b\uff1a </p> <pre><code>db.restaurant.insert({\n    restaurantld: 0, \n    restaurantName:\"KFC\", \n    location : { \n        type: \"Point\", \n        coordinates: [ -73.97, 40.77 ] \n    }\n})\n</code></pre> <pre><code>WriteResult({ \"nInserted\" : 1 })\n</code></pre> <p>\u521b\u5efa\u4e00\u4e2a2dsphere\u7d22\u5f15</p> <pre><code>db.restaurant.createIndex({location : \"2dsphere\"}) \n</code></pre> <pre><code>&gt; db.restaurant.createIndex({location : \"2dsphere\"})\n{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>&gt; db.restaurant.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"location\" : \"2dsphere\"\n        },\n        \"name\" : \"location_2dsphere\",\n        \"2dsphereIndexVersion\" : 3\n    }\n]\n</code></pre> <p>\u67e5\u8be2\u9644\u8fd110000\u7c73\u5546\u5bb6\u4fe1\u606f </p> <pre><code>db.restaurant.find({ \n    location: { \n        $near: { \n            $geometry: { \n                type: \"Point\",\n                coordinates: [-73.88, 40.78] \n        }, \n        $maxDistance: 10000 \n       } \n    } \n}) \n</code></pre> <pre><code>{ \"_id\" : ObjectId(\"62626b3261515830838dcb6e\"), \"restaurantld\" : 0, \"restaurantName\" : \"KFC\", \"location\" : { \"type\" : \"Point\", \"coordinates\" : [ -73.97, 40.77 ] } }\n</code></pre> <ul> <li><code>$near</code> \u67e5\u8be2\u64cd\u4f5c\u7b26\uff0c\u7528\u4e8e\u5b9e\u73b0\u9644\u8fd1\u5546\u5bb6\u7684\u68c0\u7d22\uff0c\u8fd4\u56de\u6570\u636e\u7ed3\u679c\u4f1a\u6309\u8ddd\u79bb\u6392\u5e8f\u3002</li> <li><code>$geometry</code>\u64cd\u4f5c\u7b26\u7528\u4e8e\u6307\u5b9a\u4e00\u4e2a<code>GeoJSON</code>\u683c\u5f0f\u7684\u5730\u7406\u7a7a\u95f4\u5bf9\u8c61\uff0c<code>type=Point</code>\u8868\u793a\u5730\u7406\u5750\u6807\u70b9\uff0c<code>coordinates</code> \u5219\u662f\u7528\u6237\u5f53\u524d\u6240\u5728\u7684\u7ecf\u7eac\u5ea6\u4f4d\u7f6e\uff1b<code>$maxDistance</code>\u9650\u5b9a\u4e86\u6700\u5927\u8ddd\u79bb\uff0c\u5355\u4f4d\u662f\u7c73\u3002 </li> </ul>"},{"location":"mongo1/9mongodb_index/#text-indexes","title":"\u5168\u6587\u7d22\u5f15(Text Indexes)","text":"<p>MongoDB\u652f\u6301\u5168\u6587\u68c0\u7d22\u529f\u80fd\uff0c\u53ef\u901a\u8fc7\u5efa\u7acb\u6587\u672c\u7d22\u5f15\u6765\u5b9e\u73b0\u7b80\u6613\u7684\u5206\u8bcd\u68c0\u7d22\u3002</p> <pre><code>db.reviews.CreateIndex({ comments:\"text\" }) \n</code></pre> <p><code>$text</code>\u64cd\u4f5c\u7b26\u53ef\u4ee5\u5728\u6709<code>text index</code>\u7684\u96c6\u5408\u4e0a\u6267\u884c\u6587\u672c\u68c0\u7d22\u3002<code>$text</code>\u5c06\u4f1a\u4f7f\u7528\u7a7a\u683c\u548c\u6807\u70b9\u7b26\u53f7\u4f5c\u4e3a\u5206\u9694\u7b26\u5bf9\u68c0\u7d22\u5b57\u7b26\u4e32\u8fdb\u884c\u5206\u8bcd\uff0c\u5e76\u4e14\u5bf9\u68c0\u7d22\u5b57\u7b26\u4e32\u4e2d\u6240\u6709\u7684\u5206\u8bcd\u7ed3\u679c\u8fdb\u884c\u4e00\u4e2a\u903b\u8f91\u4e0a\u7684<code>OR</code>\u64cd\u4f5c\u3002 </p> <p>\u5168\u6587\u7d22\u5f15\u80fd\u89e3\u51b3\u5feb\u901f\u6587\u672c\u67e5\u627e\u7684\u9700\u6c42\uff0c\u6bd4\u5982\u6709\u4e00\u4e2a\u535a\u5ba2\u6587\u7ae0\u96c6\u5408\uff0c\u9700\u8981\u6839\u636e\u535a\u5ba2\u7684\u5185\u5bb9\u6765\u5feb\u901f\u67e5\u627e\uff0c\u5219\u53ef\u4ee5\u9488\u5bf9\u535a\u5ba2\u5185\u5bb9\u5efa\u7acb\u6587\u672c\u7d22\u5f15\u3002 </p> <p>\u6848\u4f8b </p> <p>\u6570\u636e\u51c6\u5907</p> <pre><code>db.stores.insert(\n    [\n        {_id: 1, name: \"Java Hut\", description: \"Coffe and Cakes\"},\n        {_id: 2, name: \"Burger Buns\", description: \"Gourmet hamburgers\"},\n        {_id: 3, name: \"Coffee Shop\", description: \"Just Coffee\"},\n        {_id: 4, name: \"Clothes Clothes Clothes\", description: \"Discount clothing\"},\n        {_id: 5, name: \"Java Shopping\", description: \"Indonesian Goods\"},\n    ]\n)\n</code></pre> <pre><code>BulkWriteResult({\n    \"writeErrors\" : [ ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 5,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\n</code></pre> <p>\u521b\u5efaname\u548cdescription\u7684\u5168\u6587\u7d22\u5f15 </p> <pre><code>db.stores.createIndex({ name:\"text\", description:\"text\"})  \n</code></pre> <pre><code>&gt; db.stores.createIndex({ name:\"text\", description:\"text\"})\n{\n    \"createdCollectionAutomatically\" : true,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <pre><code>&gt; db.stores.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_fts\" : \"text\",\n            \"_ftsx\" : 1\n        },\n        \"name\" : \"name_text_description_text\",\n        \"weights\" : {\n            \"description\" : 1,\n            \"name\" : 1\n        },\n        \"default_language\" : \"english\",\n        \"language_override\" : \"language\",\n        \"textIndexVersion\" : 3\n    }\n]\n</code></pre> <p>\u6d4b\u8bd5</p> <p>\u901a\u8fc7<code>$text</code>\u64cd\u4f5c\u7b26\u6765\u67e5\u5bfb\u6570\u636e\u4e2d\u6240\u6709\u5305\u542b\u201ccoffee\",\"shop\",'java\"\u5217\u8868\u4e2d\u4efb\u4f55\u8bcd\u8bed\u7684\u5546\u5e97 </p> <pre><code>db.stores.find({ $text: {$search: \"java coffee shop\" }}) \n</code></pre> <p>MongoDB\u7684\u6587\u672c\u7d22\u5f15\u529f\u80fd\u5b58\u5728\u8bf8\u591a\u9650\u5236\uff0c\u800c\u5b98\u65b9\u5e76\u672a\u63d0\u4f9b\u4e2d\u6587\u5206\u8bcd\u7684\u529f\u80fd\uff0c\u8fd9\u4f7f\u5f97\u8be5\u529f\u80fd\u7684\u5e94\u7528\u573a\u666f\u5341\u5206\u53d7\u9650\u3002 </p> <pre><code>&gt; db.stores.find({ $text: {$search: \"java coffee shop\" }})\n{ \"_id\" : 3, \"name\" : \"Coffee Shop\", \"description\" : \"Just Coffee\" }\n{ \"_id\" : 5, \"name\" : \"Java Shopping\", \"description\" : \"Indonesian Goods\" }\n{ \"_id\" : 1, \"name\" : \"Java Hut\", \"description\" : \"Coffe and Cakes\" }\n</code></pre>"},{"location":"mongo1/9mongodb_index/#hashhashed-indexes","title":"Hash\u7d22\u5f15\uff08Hashed Indexes)","text":"<p>\u4e0d\u540c\u4e8e\u4f20\u7edf\u7684B-Tree\u7d22\u5f15\uff0c\u54c8\u5e0c\u7d22\u5f15\u4f7f\u7528hash\u51fd\u6570\u6765\u521b\u5efa\u7d22\u5f15\u3002\u5728\u7d22\u5f15\u5b57\u6bb5\u4e0a\u8fdb\u884c\u7cbe\u786e\u5339\u914d\uff0c\u4f46\u4e0d\u652f\u6301\u8303\u56f4\u67e5\u8be2\uff0c\u4e0d\u652f\u6301\u591a\u952ehash, Hash\u7d22 \u5f15\u4e0a\u7684\u5165\u53e3\u662f\u5747\u5300\u5206\u5e03\u7684\uff0c\u5728\u5206\u7247\u96c6\u5408\u4e2d\u975e\u5e38\u6709\u7528\uff1a </p> <pre><code>db.users.createIndex({username: 'hashed' }) \n</code></pre> <pre><code>{\n    \"createdCollectionAutomatically\" : true,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre>"},{"location":"mongo1/9mongodb_index/#wildcard-indexes","title":"\u901a\u914d\u7b26\u7d22\u5f15\uff08Wildcard Indexes)","text":"<p>MongoDB\u7684\u6587\u6863\u6a21\u5f0f\u5f02\u52a8\u6001\u53d8\u5316\u7684\uff0c\u800c\u901a\u914d\u7b26\u7d22\u5f15\u53ef\u4ee5\u5efa\u7acb\u5728\u4e00\u4e9b\u4e0d\u53ef\u9884\u77e5\u7684\u5b57\u6bb5\u4e0a, \u4ee5\u6b64\u5b9e\u73b0\u67e5\u8be2\u7684\u52a0\u901f\u3002</p> <p>\u6848\u4f8b</p> <p>MongoDB4.2\u5f15\u5165\u4e86\u901a\u914d\u7b26\u7d22\u5f15\u6765\u652f\u6301\u5bf9\u672a\u77e5\u6216\u4efb\u610f\u5b57\u6bb5\u7684\u67e5\u8be2\u3002 \u6848\u4f8b\u51c6\u5907\u5546\u54c1\u6570\u636e\uff0c\u4e0d\u540c\u5546\u54c1\u5c5e\u6027\u4e0d\u4e00\u6837</p> <p>\u6848\u4f8b</p> <p>\u51c6\u5907\u5546\u54c1\u6570\u636e\uff0c\u4e0d\u540c\u5546\u54c1\u5c5e\u6027\u4e0d\u4e00\u6837 </p> <pre><code>db.products.insert([ \n    { \n        \"product_name\" : \"Spy Coat\", \n        \"product_attributes\" : {\n             \"material\" : [ \"Tweed\", \"Wool\", \"Leather\" ], \n             \"size\" : { \n                \"length\" : 72, \n                \"units\" : \"inches\" \n    }\n }\n},{\n    \"product_name\" : \"spy Pen\", \n    \"product_attributes\" : { \n        \"colors\" : [ \"Blue\", \"Black\" ], \n        \"secret_feature\" : \n            { \"name\" : \"laser\", \n            \"power\" : \"1000\", \n            \"units\" : \"watts\", \n            }   \n        } \n    } ,\n  {\n  \"product_name\" : \"spy Book\" \n  }\n])\n</code></pre> <pre><code>BulkWriteResult({\n    \"writeErrors\" : [ ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 3,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\n</code></pre> <p>\u521b\u5efa\u901a\u914d\u7b26\u7d22\u5f15</p> <pre><code>db.products.createIndex({\"product_attributes.$**\":1}) \n</code></pre> <pre><code>{\n    \"createdCollectionAutomatically\" : false,\n    \"numIndexesBefore\" : 1,\n    \"numIndexesAfter\" : 2,\n    \"ok\" : 1\n}\n</code></pre> <p>\u6d4b\u8bd5</p> <p>\u901a\u914d\u7b26\u7d22\u5f15\u53ef\u4ee5\u652f\u6301\u4efb\u610f\u5355\u5b57\u6bb5\u67e5\u8be2<code>product_attributes</code>\u6216\u5176\u5d4c\u5165\u5b57\u6bb5 </p> <pre><code>db.products.find({\"product_attributes.size.length\" : { $gt : 60 } }) \ndb.products.find( { \"product_attributes.material\" : \"Leather\" } ) db.products.find( { \"product_attributes.secret_feature.name\" : \"laser\" }) \n</code></pre> <pre><code>&gt; db.products.getIndexes()\n[\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"_id\" : 1\n        },\n        \"name\" : \"_id_\"\n    },\n    {\n        \"v\" : 2,\n        \"key\" : {\n            \"product_attributes.$**\" : 1\n        },\n        \"name\" : \"product_attributes.$**_1\"\n    }\n]\n</code></pre> <pre><code>&gt; db.products.find( { \"product_attributes.material\" : \"Leather\" } )\n{ \"_id\" : ObjectId(\"626294ee61515830838dcb6f\"), \"product_name\" : \"Spy Coat\", \"product_attributes\" : { \"material\" : [ \"Tweed\", \"Wool\", \"Leather\" ], \"size\" : { \"length\" : 72, \"units\" : \"inches\" } } }\n</code></pre> <pre><code>&gt; db.products.find({\"product_attributes.size.length\" : { $gt : 60 } })\n{ \"_id\" : ObjectId(\"626294ee61515830838dcb6f\"), \"product_name\" : \"Spy Coat\", \"product_attributes\" : { \"material\" : [ \"Tweed\", \"Wool\", \"Leather\" ], \"size\" : { \"length\" : 72, \"units\" : \"inches\" } } }\n</code></pre> <pre><code>&gt; db.products.find( { \"product_attributes.secret_feature.name\" : \"laser\" })\n{ \"_id\" : ObjectId(\"626294ee61515830838dcb70\"), \"product_name\" : \"spy Pen\", \"product_attributes\" : { \"colors\" : [ \"Blue\", \"Black\" ], \"secret_feature\" : { \"name\" : \"laser\", \"power\" : \"1000\", \"units\" : \"watts\" } } }\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879</p> <p>\u901a\u914d\u7b26\u7d22\u5f15\u4e0d\u517c\u5bb9\u7684\u7d22\u5f15\u7c7b\u578b\u6216\u5c5e\u6027 </p> <p></p> <ul> <li>\u901a\u914d\u7b26\u7d22\u5f15\u662f\u7a00\u758f\u7684\uff0c\u4e0d\u7d22\u5f15\u7a7a\u5b57\u6bb5\u3002\u56e0\u6b64\uff0c\u901a\u914d\u7b26\u7d22\u5f15\u4e0d\u80fd\u652f\u6301\u67e5\u8be2\u5b57\u6bb5\u4e0d\u5b58\u5728\u7684\u6587\u6863\u3002 \u5de5 #j!</li> </ul> <pre><code># \u901a\u914d\u7b26\u7d22\u5f15\u7d22\u5f15\u4e0d\u80fd\u652f\u6301\u4ee5\u4e0b\u67e5\u8be2 \ndb.products.find({\"product_attributes\":{ $exists:false }}) \n</code></pre> <pre><code>db.products.aggregate([{$match:\n    {\"product_attributes\": {$exists:false}}} \n])\n</code></pre> <pre><code>{ \"_id\" : ObjectId(\"626294ee61515830838dcb71\"), \"product_name\" : \"spy Book\" }\n</code></pre> <ul> <li>\u901a\u914d\u7b26\u7d22\u5f15\u4e3a\u6587\u6863\u6216\u6570\u7ec4\u7684\u5185\u5bb9\u751f\u6210\u6761\u76ee\uff0c\u800c\u4e0d\u662f\u6587\u6863\uff0f\u6570\u5f97\u672c\u8eab\u3002\u80fd\u652f\u6301\u7cbe\u786e\u7684\u6587\u6863\uff0f\u6570\u7ec4\u76f8\u7b49\u5339\u914d\u3002 \u56e0\u6b64\u901a\u914d\u7b26\u7d22\u5f15\u53ef\u4ee5\u652f\u6301\u67e5\u8be2\u5b57\u6bb5\u7b49\u4e8e\u7a7a\u6587\u6863<code>\uff5b\uff5d</code>\u7684\u60c5\u51b5</li> </ul> <pre><code># \u901a\u914d\u7b26\u7d22\u5f15\u4e0d\u80fd\u652f\u6301\u4ee5\u4e0b\u67e5\u8be2\uff1a\ndb.products.find({\"product_attributes.color\": [\"Blue\", \"Black\"] }) \n\n\ndb.products.aggregate([{$match:\n    {\"product_attributes.color\": [\"Blue\", \"Black\"] }\n\n}])\n</code></pre>"},{"location":"mongo2/10mon_bakup_restore/","title":"10 MongoDB \u5907\u4efd\u4e0e\u6062\u590d","text":""},{"location":"mongo2/10mon_bakup_restore/#1","title":"1 \u5907\u4efd\u4e0e\u6062\u590d","text":""},{"location":"mongo2/10mon_bakup_restore/#_1","title":"\u5907\u4efd\u7684\u76ee\u7684:","text":"<ul> <li>\u9632\u6b62\u786c\u4ef6\u6545\u969c\u5f15\u8d77\u7684\u6570\u636e\u4e22\u5931 </li> <li>\u9632\u6b62\u4eba\u4e3a\u9519\u8bef\u8bef\u5220\u6570\u636e</li> <li>\u65f6\u95f4\u56de\u6eaf</li> <li>\u76d1\u7ba1\u8981\u6c42</li> </ul> <p>\u7b2c\u4e00\u70b9 MongoDB \u751f\u4ea7\u96c6\u7fa4\u5df2\u7ecf\u901a\u8fc7\u590d\u5236\u96c6\u7684\u591a\u8282\u70b9\u5b9e\u73b0\uff0c\u672c\u8bb2\u7684\u5907\u4efd\u4e3b\u8981 \u662f\u4e3a\u5176\u4ed6\u51e0\u4e2a\u76ee\u7684\u3002</p>"},{"location":"mongo2/10mon_bakup_restore/#mongodb","title":"MongoDB \u7684\u5907\u4efd","text":"<p>MongoDB \u7684\u5907\u4efd\u673a\u5236\u5206\u4e3a:</p> <ul> <li>\u5ef6\u8fdf\u8282\u70b9\u5907\u4efd</li> <li>\u5168\u91cf\u5907\u4efd + Oplog \u589e\u91cf</li> </ul> <p>\u6700\u5e38\u89c1\u7684\u5168\u91cf\u5907\u4efd\u65b9\u5f0f\u5305\u62ec:</p> <ul> <li>mongodump;</li> <li>\u590d\u5236\u6570\u636e\u6587\u4ef6; </li> <li>\u6587\u4ef6\u7cfb\u7edf\u5feb\u7167;</li> </ul>"},{"location":"mongo2/10mon_bakup_restore/#_2","title":"\u65b9\u6848\u4e00:\u5ef6\u8fdf\u8282\u70b9\u5907\u4efd","text":"<p><code>\u5b89\u5168\u8303\u56f4\u5185\u7684\u4efb\u610f\u65f6\u95f4\u70b9\u72b6\u6001 = \u5ef6\u8fdf\u4ece\u8282\u70b9\u5f53\u524d\u72b6\u6001 + \u5b9a\u91cf\u91cd\u653e oplog</code></p> <p>\u4f46\u662f\u4f1a\u4e22\u5931\u4e00\u4e2a\u5c0f\u65f6\u7684\u64cd\u4f5c</p> <p>\u5ef6\u8fdf\u5907\u4efd\u6ce8\u610f\u4e8b\u9879</p> <p>\u4e3b\u8282\u70b9\u7684 oplog \u65f6\u95f4\u7a97t\u5e94\u6ee1\u8db3: <code>t &gt;= \u5ef6\u8fdf\u65f6\u95f4 + 48\u5c0f\u65f6</code></p> <p></p>"},{"location":"mongo2/10mon_bakup_restore/#oplog","title":"\u65b9\u6848\u4e8c:\u5168\u91cf\u5907\u4efd\u52a0 oplog","text":"<ul> <li>\u6700\u8fd1\u7684 oplog \u5df2\u7ecf\u5728 <code>oplog.rs</code> \u96c6\u5408\u4e2d\uff0c\u56e0\u6b64\u53ef\u4ee5\u5728\u5b9a\u671f\u4ece\u96c6\u5408\u4e2d\u5bfc\u51fa\u4fbf\u5f97\u5230\u4e86 oplog;</li> <li>\u5982\u679c\u4e3b\u8282\u70b9\u4e0a\u7684 <code>oplog.rs</code> \u96c6\u5408\u8db3\u591f\u5927\uff0c\u5168\u91cf\u5907\u4efd\u8db3\u591f\u5bc6\u96c6\uff0c\u81ea\u7136\u4e5f\u53ef\u4ee5\u4e0d\u7528\u5907\u4efd oplog;</li> <li>\u53ea\u8981\u6709\u8986\u76d6\u6574\u4e2a\u65f6\u95f4\u6bb5\u7684 <code>oplog</code>\uff0c\u5c31\u53ef\u4ee5\u7ed3\u5408\u5168\u91cf\u5907\u4efd\u5f97\u5230\u4efb\u610f\u65f6\u95f4\u70b9\u7684\u5907\u4efd\u3002</li> </ul>"},{"location":"mongo2/10mon_bakup_restore/#_3","title":"\u590d\u5236\u6587\u4ef6\u5168\u91cf\u5907\u4efd\u6ce8\u610f\u4e8b\u9879","text":"<p>\u590d\u5236\u6570\u636e\u5e93\u6587\u4ef6:</p> <ul> <li>\u5fc5\u987b\u5148\u5173\u95ed\u8282\u70b9\u624d\u80fd\u590d\u5236\uff0c\u5426\u5219\u590d\u5236\u5230\u7684\u6587\u4ef6\u65e0\u6548;</li> <li>\u4e5f\u53ef\u4ee5\u9009\u62e9 <code>db.fsyncLock()</code> \u9501\u5b9a\u8282\u70b9\uff0c\u4f46\u5b8c\u6210\u540e\u4e0d\u8981\u5fd8\u8bb0 <code>db.fsyncUnlock()</code> \u89e3\u9501; </li> <li>\u53ef\u4ee5\u4e14\u5e94\u8be5\u5728\u4ece\u8282\u70b9\u4e0a\u5b8c\u6210;</li> <li>\u8be5\u65b9\u6cd5\u5b9e\u9645\u4e0a\u4f1a\u6682\u65f6\u5b95\u673a\u4e00\u4e2a\u4ece\u8282\u70b9\uff0c\u6240\u4ee5\u6574\u4e2a\u8fc7\u7a0b\u4e2d\u5e94\u6ce8\u610f\u6295\u7968\u8282\u70b9\u603b\u6570\u3002</li> </ul>"},{"location":"mongo2/10mon_bakup_restore/#oplog_1","title":"\u5168\u91cf\u5907\u4efd\u52a0 oplog \u6ce8\u610f\u4e8b\u9879 \u2013 \u6587\u4ef6\u7cfb\u7edf\u5feb\u7167","text":"<p>\u6587\u4ef6\u7cfb\u7edf\u5feb\u7167:</p> <ul> <li>MongoDB \u652f\u6301\u4f7f\u7528\u6587\u4ef6\u7cfb\u7edf\u5feb\u7167\u76f4\u63a5\u83b7\u53d6\u6570\u636e\u6587\u4ef6\u5728\u67d0\u4e00\u65f6\u523b\u7684\u955c\u50cf; </li> <li>\u5feb\u7167\u8fc7\u7a0b\u4e2d\u53ef\u4ee5\u4e0d\u7528\u505c\u673a;</li> <li>\u6570\u636e\u6587\u4ef6\u548c Journal \u5fc5\u987b\u5728\u540c\u4e00\u4e2a\u5377\u4e0a;</li> <li>\u5feb\u7167\u5b8c\u6210\u540e\u8bf7\u5c3d\u5feb\u590d\u5236\u6587\u4ef6\u5e76\u5220\u9664\u5feb\u7167;</li> </ul>"},{"location":"mongo2/10mon_bakup_restore/#mongodump","title":"Mongodump \u5168\u91cf\u5907\u4efd\u6ce8\u610f\u4e8b\u9879","text":"<p>mongodump:</p> <ul> <li>\u4f7f\u7528 mongodump \u5907\u4efd\u6700\u7075\u6d3b\uff0c\u4f46\u901f\u5ea6\u4e0a\u4e5f\u662f\u6700\u6162\u7684;</li> <li>mongodump \u51fa\u6765\u7684\u6570\u636e\u4e0d\u80fd\u8868\u793a\u67d0\u4e2a\u4e2a\u65f6\u95f4\u70b9\uff0c\u53ea\u662f\u67d0\u4e2a\u65f6\u95f4\u6bb5</li> </ul> <p></p> <p>\u53ef\u80fd\u51fa\u73b0\u7684\u95ee\u9898\uff1a</p> <ul> <li>Dump A (A=10) t1 -&gt; Dump A (A=10) t3 (\u7ed3\u675f)</li> <li>\u4e2d\u95f4 t2 A=20 \u5df2\u7ecf\u53d1\u751f\u4e86\u6539\u53d8</li> </ul>"},{"location":"mongo2/10mon_bakup_restore/#_4","title":"\u89e3\u51b3\u65b9\u6848:\u5e42\u7b49\u6027","text":"<p>\u5047\u8bbe\u96c6\u5408\u4e2d\u67092\u4e2a\u6587\u6863:</p> <pre><code>\u2013 {_id: 1, a: 1}\n\u2013 {_id: 2, b: 0}\n</code></pre> <p>\u8003\u8651\u4ee5\u4e0b\u4e09\u6761 oplog:</p> <ul> <li>\u5c06 <code>_id</code> \u4e3a1\u7684\u8bb0\u5f55\u7684a\u5b57\u6bb5\u66f4\u65b0\u4e3a5; </li> <li>\u5c06 <code>_id</code> \u4e3a1\u7684\u8bb0\u5f55\u7684a\u5b57\u6bb5\u66f4\u65b0\u4e3a10; </li> <li>\u5c06 <code>_id</code>\u4e3a2\u7684\u8bb0\u5f55\u7684b\u5b57\u6bb5\u66f4\u65b0\u4e3a20;</li> </ul> <p>\u8fd9\u4e09\u6761 oplog \u987a\u5e8f\u6267\u884c\uff0c\u65e0\u8bba\u6267\u884c\u591a\u5c11\u6b21\uff0c\u6700\u7ec8\u5f97 \u5230\u7684\u7ed3\u679c\u5747\u662f: <code>{_id: 1, a: 10}, {_id: 2, b: 20}</code></p> <pre><code>{\n    \"ts\": Timestamp(1546531845, 1),\n    \"t\": NumberLong(125),\n    \"h\": NumberLong(\"7330107490438995549\"),\n    \"v\": 2,\n    \"op\": \"u\",\n    \"ns\": \"test.test\",\n    \"ui\": UUID(\"efe7e331-4fe6-4a4c-a57a-d4a3c36b28d9\"), \n    \"o2\": {\n        \"_id\": 1 \n    },\n    \"wall\": ISODate(\"2019-01-03T16:10:45.557Z\"), \n    \"o\": {\n        \"$v\": 1, \"\n        $set\": {\n         \"a\": 5\n         } \n    }\n }\n</code></pre>"},{"location":"mongo2/10mon_bakup_restore/#idempotent","title":"\u5e42\u7b49\u6027(idempotent)","text":"<p>\u6709\u4e9b\u65f6\u5019\u4e3a\u4e86\u4fdd\u6301\u5e42\u7b49\u6027\uff0c\u53d8\u66f4\u8f6c\u53d8\u6210oplog\u65f6\u9700\u8981\u505a\u4e00\u4e9b\u7279\u6b8a\u5904\u7406\u3002\u4f8b\u5982:</p> <pre><code>db.coll.update({...}, {$inc: {x: 1}}); // \u5047\u8bbe\u7ed3\u679c:x=2\n</code></pre> <p>\u8fd9\u4e2a\u64cd\u4f5c\u672c\u8eab\u4e0d\u662f\u5e42\u7b49\u7684\uff0c\u6bcf\u6267\u884c\u4e00\u6b21x\u5c31\u4f1a<code>+1</code>\u3002\u800c\u4e3a\u4e86\u8ba9\u5b83\u6210\u4e3a\u5e42\u7b49\u7684\uff0c MongoDB\u5728oplog\u4e2d\u8bb0\u5f55\u7684\u5b9e\u9645\u5185\u5bb9\u662f:\u5c06x\u8d4b\u503c\u4e3a2\uff0c\u800c\u4e0d\u662f\u8ba9x\u589e\u52a01\u3002</p> <p>\u7528\u5e42\u7b49\u6027\u89e3\u51b3\u4e00\u81f4\u6027\u95ee\u9898</p> <p></p>"},{"location":"mongo2/10mon_bakup_restore/#2","title":"2 \u5907\u4efd\u548c\u6062\u590d\u64cd\u4f5c","text":""},{"location":"mongo2/10mon_bakup_restore/#_5","title":"\u5907\u4efd\u548c\u6062\u590d\u5de5\u5177\u53c2\u6570","text":"<p>\u51e0\u4e2a\u91cd\u8981\u53c2\u6570:</p> <ul> <li> <p>mongodump\uff1a </p> <ul> <li><code>--oplog</code>: \u590d\u5236 <code>mongodump</code> \u5f00\u59cb\u5230\u7ed3\u675f\u8fc7\u7a0b\u4e2d\u7684\u6240\u6709 <code>oplog</code> \u5e76\u8f93\u51fa\u5230\u7ed3\u679c\u4e2d\u3002 \u8f93\u51fa\u6587\u4ef6\u4f4d\u4e8e <code>dump/oplog.bson</code></li> <li>mongorestore</li> </ul> </li> <li> <p><code>--oplogReplay</code>: \u6062\u590d\u5b8c\u6570\u636e\u6587\u4ef6\u540e\u518d\u91cd\u653e <code>oplog</code>\u3002\u9ed8\u8ba4\u91cd\u653e <code>dump/oplog.bson =&gt; &lt;dump-directory&gt;/local/oplog.rs.bson</code>\u3002\u5982\u679c oplog \u4e0d\u5728\u8fd9\uff0c\u5219\u53ef\u4ee5:</p> <ul> <li><code>--oplogFile</code>: \u6307\u5b9a\u9700\u8981\u91cd\u653e\u7684 oplog \u6587\u4ef6\u4f4d\u7f6e</li> <li><code>--oplogLimit</code>: \u91cd\u653e oplog \u65f6\u622a\u6b62\u5230\u6307\u5b9a\u65f6\u95f4\u70b9</li> </ul> </li> </ul> <p>\u66f4\u591a\u8bf4\u660e:</p> <ul> <li>mongodump \u2014 MongoDB Manual</li> <li>mongorestore \u2014 MongoDB Manual</li> </ul> <p>\u5b9e\u9645\u64cd\u4f5c: <code>mongodump/mongorestore</code></p> <p>\u4e3a\u4e86\u6a21\u62df dump \u8fc7\u7a0b\u4e2d\u7684\u6570\u636e\u53d8\u5316\uff0c\u6211\u4eec\u5f00\u542f\u4e00\u4e2a\u5faa\u73af\u63d2\u5165\u6570\u636e\u7684\u7ebf\u7a0b:</p> <pre><code> use test\nswitched to db test\n&gt; show tables\nbooks_favCount\nlog_events\nmovies\nrestaurants\nscores\nusers\nzips\n&gt; db.random.count()\n0\n</code></pre> <pre><code>for(var i=0; i&lt;100000; i++){  db.random.insertOne({x: Math.random() * 100000}); }\n</code></pre> <p>\u5728\u53e6\u4e00\u4e2a\u7a97\u53e3\u4e2d\u6211\u4eec\u5bf9\u5176\u8fdb\u884c mongodump</p> <pre><code>mongodump -h 127.0.0.1:27017 --oplog\n</code></pre> <pre><code>2022-05-05T09:07:02.106+0000    Failed: error dumping metadata: error creating directory for metadata file dump/appdb: mkdir dump: permission denied\n</code></pre> <pre><code>sudo chmod 777 $MONGODATA/dump\n\n$ ll | grep dump\ndrwxrwxrwx. 3 root root       18 Apr 30 03:57 dump\n</code></pre> <pre><code>$ mongodump -h 127.0.0.1:27017 --oplog\n2022-05-05T09:15:09.195+0000    writing admin.system.users to dump/admin/system.users.bson\n2022-05-05T09:15:09.196+0000    done dumping admin.system.users (2 documents)\n2022-05-05T09:15:09.197+0000    writing admin.system.version to dump/admin/system.version.bson\n2022-05-05T09:15:09.197+0000    done dumping admin.system.version (2 documents)\n</code></pre> <p></p> <pre><code>[dump]$ ll dump | grep test\ndrwxrwxr-x. 2 vagrant vagrant  244 May  5 09:13 test\n[dump]$ ll dump/test | grep random\n-rw-rw-r--. 1 vagrant vagrant 173 May  5 09:15 random.metadata.json\n-rw-rw-r--. 1 vagrant vagrant 173 May  5 09:15 random.bson\n</code></pre> <p>\u5b9e\u9645\u64cd\u4f5c: <code>mongodump/mongorestore</code></p> <pre><code>&gt; db.random.count()\n100000\n</code></pre> <p>\u5f97\u5230\u4ee5\u4e0b\u76ee\u5f55:</p> <p></p>"},{"location":"mongo2/10mon_bakup_restore/#mongodumpmongorestore","title":"\u5b9e\u9645\u64cd\u4f5c:mongodump/mongorestore","text":"<p>\u4f7f\u7528<code>mongorestore</code>\u6062\u590d\u5230\u4e00\u4e2a\u65b0\u96c6\u7fa4:</p> <pre><code>mongorestore --host 127.0.0.1 --oplogReplay dump\n</code></pre> <ul> <li><code>--oplogReplay dump</code> : \u91cd\u653eoplog</li> </ul> <pre><code>2019-12-27T21:15:30.708+0800 2019-12-27T21:15:30.709+0800 2019-12-27T21:15:30.748+0800 2019-12-27T21:15:31.471+0800 2019-12-27T21:15:31.471+0800 2019-12-27T21:15:31.471+0800 2019-12-27T21:15:31.524+0800 2019-12-27T21:15:31.524+0800\npreparing collections to restore from\nreading metadata for test.random from dump/test/random.metadata.json restoring test.random from dump/test/random.bson\nno indexes to restore\nfinished restoring test.random (14324 documents, 0 failures)\nreplaying oplog\napplied 163 oplog entries\n14324 document(s) restored successfully. 0 document(s) failed to restore.\n</code></pre> <ul> <li>\u91cd\u653e\u4e86163 \u6761oplog</li> </ul>"},{"location":"mongo2/10mon_bakup_restore/#oplog_2","title":"\u66f4\u590d\u6742\u7684\u91cd\u653e oplog","text":"<p>\u5047\u8bbe\u5168\u91cf\u5907\u4efd\u5df2\u7ecf\u6062\u590d\u5230\u6570\u636e\u5e93\u4e2d(\u65e0\u8bba\u4f7f\u7528\u5feb\u7167\u3001mongodump \u6216\u590d\u5236\u6570\u636e\u6587\u4ef6\u7684\u65b9\u5f0f)\uff0c\u8981\u91cd\u653e\u4e00\u90e8\u5206\u589e\u91cf\u600e\u4e48\u529e?</p> <p>\u5bfc\u51fa\u4e3b\u8282\u70b9\u4e0a\u7684 oplog:</p> <pre><code>mongodump --host 127.0.0.1 -d local -c oplog.rs\n</code></pre> <ul> <li>\u53ef\u4ee5\u901a\u8fc7 <code>-query</code> \u53c2\u6570\u6dfb\u52a0\u65f6\u95f4\u8303\u56f4</li> </ul> <p>\u4f7f\u7528 bsondump \u67e5\u770b\u5bfc\u51fa\u7684 oplog\uff0c\u627e\u5230\u9700\u8981\u622a\u6b62\u7684\u65f6\u95f4\u70b9:</p> <pre><code>\u4f8b\u5982:{ \"ts\" : Timestamp(1577355175, 1), \"t\" : NumberLong(23), \"h\" : NumberLong(0), \"v\" : 2, \"op\" : \"c\", \"ns\" : \"foo.$cmd\", \"ui\" : UUID(\"767b3a2b-a1cd-4db8-a74a-71ce9711f368\"), \"o2\" : { \"numRecords\" : 1 }, \"wall\" : ISODate(\"2019-12-26T10:12:55.436Z\"), \"o\" : { \"drop\" : \"employees\" } }\n</code></pre> <p>\u6062\u590d\u5230\u6307\u5b9a\u65f6\u95f4\u70b9</p> <ul> <li>\u5229\u7528 <code>--oplogLimit</code> \u6307\u5b9a\u6062\u590d\u5230\u8fd9\u6761\u8bb0\u5f55\u4e4b\u524d</li> <li><code>mongorestore -h 127.0.0.1 --oplogLimit \"1577355175:1\" --oplogFile dump/local/oplog.rs &lt;\u7a7a\u6587\u4ef6\u5939&gt;</code></li> </ul> <p>bsondump\u624b\u518c: bsondump</p>"},{"location":"mongo2/10mon_bakup_restore/#_6","title":"\u5206\u7247\u96c6\u5907\u4efd","text":"<p>\u5206\u7247\u96c6\u5907\u4efd\u5927\u81f4\u4e0e\u590d\u5236\u96c6\u539f\u7406\u76f8\u540c\uff0c\u4e0d\u8fc7\u5b58\u5728\u4ee5\u4e0b\u5dee\u5f02:</p> <ul> <li>\u5e94\u5206\u522b\u4e3a\u6bcf\u4e2a\u7247\u548c config \u5907\u4efd;</li> <li>\u5206\u7247\u96c6\u5907\u4efd\u4e0d\u4ec5\u8981\u8003\u8651\u4e00\u4e2a\u5206\u7247\u5185\u7684\u4e00\u81f4\u6027\u95ee\u9898\uff0c\u8fd8\u8981\u8003\u8651\u5206\u7247\u95f4\u7684\u4e00\u81f4\u6027\u95ee\u9898\uff0c\u56e0\u6b64\u6bcf \u4e2a\u7247\u8981\u80fd\u591f\u6062\u590d\u5230\u540c\u4e00\u4e2a\u65f6\u95f4\u70b9;</li> </ul>"},{"location":"mongo2/10mon_bakup_restore/#_7","title":"\u5206\u7247\u96c6\u7684\u589e\u91cf\u5907\u4efd","text":"<p>\u5c3d\u7ba1\u7406\u8bba\u4e0a\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0e\u590d\u5236\u96c6\u540c\u6837\u7684\u65b9\u5f0f\u6765\u4e3a\u5206\u7247\u96c6\u5b8c\u6210\u589e\u91cf\u5907\u4efd\uff0c\u4f46\u5b9e\u9645\u4e0a \u5206\u7247\u96c6\u7684\u60c5\u51b5\u66f4\u52a0\u590d\u6742\u3002\u8fd9\u79cd\u590d\u6742\u6027\u6765\u81ea\u4e24\u4e2a\u65b9\u9762</p> <ul> <li>\u5404\u4e2a\u6570\u636e\u8282\u70b9\u7684\u65f6\u95f4\u4e0d\u4e00\u81f4:\u6bcf\u4e2a\u6570\u636e\u8282\u70b9\u5f88\u96be\u5b8c\u5168\u6062\u590d\u5230\u4e00\u4e2a\u771f\u6b63\u7684\u4e00\u81f4\u65f6\u95f4\u70b9\u4e0a\uff0c\u901a \u5e38\u53ea\u80fd\u505a\u5230\u5927\u81f4\u4e00\u81f4\uff0c\u800c\u8fd9\u79cd\u5927\u81f4\u4e00\u81f4\u901a\u5e38\u8db3\u591f\u597d\uff0c\u9664\u4e86\u4ee5\u4e0b\u60c5\u51b5;</li> <li>\u5206\u7247\u95f4\u7684\u6570\u636e\u8fc1\u79fb:\u5f53\u4e00\u90e8\u5206\u6570\u636e\u4ece\u4e00\u4e2a\u7247\u8fc1\u79fb\u5230\u53e6\u4e00\u4e2a\u7247\u65f6\uff0c\u6700\u7ec8\u6570\u636e\u5230\u5e95\u5728\u54ea\u91cc\u53d6\u51b3 \u4e8e config \u4e2d\u7684\u5143\u6570\u636e\u3002\u5982\u679c\u5143\u6570\u636e\u4e0e\u6570\u636e\u8282\u70b9\u4e4b\u95f4\u7684\u65f6\u95f4\u5dee\u5f02\u6b63\u597d\u5bfc\u81f4\u6570\u636e\u5b9e\u9645\u5df2\u7ecf\u8fc1 \u79fb\u5230\u65b0\u5206\u7247\u4e0a\uff0c\u800c\u5143\u6570\u636e\u4ecd\u7136\u8ba4\u4e3a\u6570\u636e\u5728\u65e7\u5206\u7247\u4e0a\uff0c\u5c31\u4f1a\u5bfc\u81f4\u6570\u636e\u4e22\u5931\u60c5\u51b5\u53d1\u751f\u3002\u867d\u7136\u8fd9 \u79cd\u60c5\u51b5\u53d1\u751f\u7684\u6982\u7387\u5f88\u5c0f\uff0c\u4f46\u4ecd\u6709\u53ef\u80fd\u5bfc\u81f4\u95ee\u9898\u3002</li> </ul> <p>\u8981\u907f\u514d\u4e0a\u8ff0\u95ee\u9898\u7684\u53d1\u751f\uff0c\u53ea\u6709\u5b9a\u671f\u505c\u6b62\u5747\u8861\u5668;\u53ea\u6709\u5728\u5747\u8861\u5668\u505c\u6b62\u671f\u95f4\uff0c\u589e\u91cf\u6062\u590d\u624d\u80fd\u4fdd\u8bc1\u6b63\u786e\u3002</p>"},{"location":"mongo2/11mon_sec/","title":"11 MongoDB \u5b89\u5168\u8bbe\u8ba1","text":""},{"location":"mongo2/11mon_sec/#mongodb","title":"MongoDB \u5b89\u5168\u67b6\u6784","text":"<p>MongoDB \u5b89\u5168\u67b6\u6784\u4e00\u89c8\u56fe</p> <p></p>"},{"location":"mongo2/11mon_sec/#mongodb_1","title":"MongoDB \u7528\u6237\u8ba4\u8bc1\u65b9\u5f0f","text":"<p>\u7528\u6237\u540d + \u5bc6\u7801</p> <ul> <li>\u9ed8\u8ba4\u8ba4\u8bc1\u65b9\u5f0f</li> <li>SCRAM-SHA-1 \u54c8\u5e0c\u7b97\u6cd5</li> <li>\u7528\u6237\u4fe1\u606f\u5b58\u4e8e MongoDB \u672c\u5730\u6570</li> </ul> <p>\u8bc1\u4e66\u65b9\u5f0f</p> <ul> <li>X.509 \u6807\u51c6</li> <li>\u670d\u52a1\u7aef\u9700\u8981\u63d0\u4f9b\u8bc1\u4e66\u6587\u4ef6\u542f\u52a8</li> <li>\u5ba2\u6237\u7aef\u9700\u8981\u8bc1\u4e66\u6587\u4ef6\u8fde\u63a5\u670d\u52a1\u7aef </li> <li>\u8bc1\u4e66\u7531\u5916\u90e8\u6216\u5185\u90e8 CA \u9881\u53d1</li> </ul> <p>LDAP \u5916\u90e8\u8ba4\u8bc1</p> <ul> <li>\u8fde\u63a5\u5230\u5916\u90e8 LDAP \u670d\u52a1\u5668</li> <li>\u4f01\u4e1a\u7248\u529f\u80fd</li> </ul> <p>Kerberos \u5916\u90e8\u8ba4\u8bc1</p> <ul> <li>\u8fde\u63a5\u5230\u5916\u90e8Kerberos\u670d\u52a1\u5668 </li> <li>\u4f01\u4e1a\u7248\u529f\u80fd</li> </ul>"},{"location":"mongo2/11mon_sec/#mongodb_2","title":"MongoDB \u96c6\u7fa4\u8282\u70b9\u8ba4\u8bc1","text":"<ul> <li>Keyfile: \u5c06\u7edf\u4e00Keyfile\u6587\u4ef6\u62f7\u8d1d\u5230\u4e0d\u540c\u7684\u8282\u70b9 Keyfile \u5c31\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32</li> </ul> <ul> <li>X.509 (\u66f4\u52a0\u5b89\u5168) \u57fa\u4e8e\u8bc1\u4e66\u7684\u8ba4\u8bc1\u6a21\u5f0f\uff0c\u63a8\u8350\u4e0d\u540c\u7684\u8282\u70b9 \u4f7f\u7528\u4e0d\u540c\u7684\u8bc1\u4e66</li> </ul>"},{"location":"mongo2/11mon_sec/#mongodb_3","title":"MongoDB \u9274\u6743 \u2013 \u57fa\u4e8e\u89d2\u8272\u7684\u6743\u9650\u673a\u5236","text":"<ul> <li>MongoDB \u6388\u6743\u57fa\u4e8e\u89d2\u8272\u7684\u6743\u9650\u63a7\u5236\uff0c\u4e0d\u540c\u7684\u6743\u9650\u7684\u7528\u6237\u5bf9\u6570\u636e\u5e93\u7684\u64cd\u4f5c\u4e0d\u540c</li> <li>\u4f8b\u5982 DBA \u53ef\u4ee5\u521b\u5efa\u7528\u6237;\u5e94\u7528\u5f00\u53d1\u8005\u53ef\u4ee5\u63d2\u5165\u6570\u636e;\u62a5\u8868\u5f00\u53d1\u8005\u53ef\u4ee5\u8bfb\u53d6\u6570\u636e\u3002</li> </ul>"},{"location":"mongo2/11mon_sec/#_1","title":"\u89d2\u8272\u7684\u7ec4\u6210","text":"<p>MongoDB \u5185\u7f6e\u89d2\u8272\u53ca\u6743\u9650\u7ee7\u627f\u5173\u7cfb</p> <p></p>"},{"location":"mongo2/11mon_sec/#_2","title":"\u81ea\u5b9a\u4e49\u89d2\u8272","text":"<p>MongoDB \u652f\u6301\u6309\u9700\u81ea\u5b9a\u4e49\u89d2\u8272\uff0c\u9002\u5408\u4e00\u4e9b\u9ad8\u5b89\u5168\u8981\u6c42\u7684\u4e1a\u52a1\u573a\u666f</p> <p></p>"},{"location":"mongo2/11mon_sec/#_3","title":"\u4f20\u8f93\u52a0\u5bc6","text":"<p>MongoDB \u652f\u6301 TLS/SSL \u6765\u52a0\u5bc6 MongoDB \u7684\u6240\u6709\u7f51\u7edc\u4f20\u8f93(\u5ba2\u6237\u7aef\u5e94\u7528\u548c\u670d\u52a1\u5668\u7aef\u4e4b\u95f4\uff0c\u5185\u90e8\u590d\u5236\u96c6\u4e4b\u95f4)\u3002 TLS/SSL \u786e\u4fdd MongoDB \u7f51\u7edc\u4f20\u8f93\u4ec5\u53ef\u7531\u5141\u8bb8\u7684\u5ba2\u6237\u7aef\u8bfb\u53d6\u3002</p> <p></p>"},{"location":"mongo2/11mon_sec/#_4","title":"\u843d\u76d8\u52a0\u5bc6","text":"<p>\u6d41\u7a0b:</p> <ol> <li>\u751f\u6210 master key\uff0c\u7528\u6765\u52a0\u5bc6\u6bcf\u4e00\u4e2a\u6570\u636e\u5e93\u7684 key\u3002</li> <li>\u751f\u6210\u6bcf\u4e00\u4e2a\u6570\u636e\u5e93\u7684 key\uff0c\u7528\u6765\u52a0\u5bc6\u5404\u81ea\u7684\u6570\u636e\u5e93\u3002</li> <li>\u57fa\u4e8e\u751f\u6210\u7684\u6570\u636e\u5e93 key \u52a0\u5bc6\u5404\u4e2a\u6570\u636e\u5e93\u4e2d\u7684\u6570\u636e\u3002</li> <li>Key \u7ba1\u7406(\u53ea\u9488\u5bf9 master key\uff0c\u6570\u636e\u5e93 key \u4fdd\u5b58 \u5728\u6570\u636e\u5e93\u5185\u90e8)\u3002</li> </ol> <p>\u52a0\u5bc6\u89e3\u5bc6\u90fd\u5728\u670d\u52a1\u7aef</p> <p></p>"},{"location":"mongo2/11mon_sec/#_5","title":"\u5b57\u6bb5\u7ea7\u52a0\u5bc6","text":"<ul> <li>\u5355\u72ec\u6587\u6863\u5b57\u6bb5\u901a\u8fc7\u81ea\u8eab\u5bc6\u94a5\u52a0\u5bc6</li> <li>\u6570\u636e\u5e93\u53ea\u770b\u89c1\u5bc6\u6587</li> <li>\u4f18\u52bf<ul> <li>\u4fbf\u6377:\u81ea\u52a8\u53ca\u900f\u660e</li> <li>\u4efb\u52a1\u5206\u5f00:(\u7b80\u5316\u57fa\u4e8e\u670d\u52a1\u7684\u7cfb\u7edf\u6b65\u9aa4\uff0c\u56e0\u4e3a\u6ca1\u6709\u670d\u52a1\u5de5\u7a0b\u5e08\u80fd\u591f\u770b\u5230\u7eaf\u6587\u672c) </li> <li>\u5408\u89c4:\u76d1\u7ba1\u201c\u88ab\u9057\u5fd8\u6743\u201d</li> <li>\u5feb\u901f:\u6700\u5c0f\u6027\u80fd\u4ee3\u507f</li> </ul> </li> </ul>"},{"location":"mongo2/11mon_sec/#_6","title":"\u5b57\u6bb5\u7ea7\u52a0\u5bc6\u67e5\u8be2\u6d41\u7a0b","text":"<p>\u52a0\u5bc6\u89e3\u5bc6\u90fd\u5728\u9a71\u52a8\u7aef</p>"},{"location":"mongo2/11mon_sec/#_7","title":"\u5ba1\u8ba1","text":"<ul> <li>\u6570\u636e\u5e93\u7b49\u8bb0\u5f55\u578b\u7cfb\u7edf\u901a\u5e38\u4f7f\u7528\u5ba1\u8ba1\u76d1\u63a7\u6570\u636e\u5e93\u76f8\u5173\u7684\u4e00\u4e9b\u6d3b\u52a8\uff0c\u4ee5\u53ca\u5bf9\u4e00\u4e9b\u53ef\u7591\u7684\u64cd\u4f5c\u8fdb\u884c\u8c03\u67e5\u3002</li> <li>\u8bb0\u5f55\u683c\u5f0f: JSON</li> <li>\u8bb0\u5f55\u65b9\u5f0f:\u672c\u5730\u6587\u4ef6 \u6216 syslog</li> <li>\u8bb0\u5f55\u5185\u5bb9:<ul> <li>Schema change (DDL)</li> <li>CRUD \u64cd\u4f5c (DML) </li> <li>\u7528\u6237\u8ba4\u8bc1</li> </ul> </li> </ul>"},{"location":"mongo2/11mon_sec/#_8","title":"\u5ba1\u8ba1\u914d\u7f6e\u53c2\u6570\u4e3e\u4f8b","text":"<ul> <li>\u5ba1\u8ba1\u65e5\u5fd7\u8bb0\u5f55\u5230 syslog\uff1a <code>--auditDestination syslog</code></li> <li>\u5ba1\u8ba1\u65e5\u5fd7\u8bb0\u5f55\u5199\u5230\u6307\u5b9a\u6587\u4ef6</li> </ul> <pre><code>--auditDestination file --auditFormat JSON --auditPath /path/to/auditLog.json\n</code></pre> <ul> <li>\u5bf9\u5220\u8868\u548c\u521b\u5efa\u8868\u52a8\u4f5c\u8fdb\u884c\u5ba1\u8ba1\u65e5\u5fd7\u8bb0\u5f55</li> </ul> <pre><code>--auditDestination file --auditFormat JSON --auditPath auditLog.json -- auditFilter '{atype: {$in: [\"createCollection\", \"dropCollection\"]}}\u2019\n</code></pre>"},{"location":"mongo2/11mon_sec/#mongodb_4","title":"MongoDB \u5b89\u5168\u67b6\u6784\u603b\u7ed3","text":""},{"location":"mongo2/11mon_sec/#2-mongodb","title":"2 MongoDB \u5b89\u5168\u52a0\u56fa\u5b9e\u8df5","text":""},{"location":"mongo2/11mon_sec/#mongodb_5","title":"MongoDB \u5b89\u5168\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li> <p>\u542f\u7528\u8eab\u4efd\u8ba4\u8bc1</p> <ul> <li>\u542f\u7528\u8bbf\u95ee\u63a7\u5236\u5e76\u5f3a\u5236</li> <li>\u6267\u884c\u8eab\u4efd\u8ba4\u8bc1</li> <li>\u4f7f\u7528\u5f3a\u5bc6\u7801</li> </ul> </li> <li> <p>\u6743\u9650\u63a7\u5236</p> <ul> <li>\u57fa\u4e8e Deny All \u539f\u5219 \u4e0d\u591a\u7ed9\u591a\u4f59\u6743\u9650.</li> </ul> </li> <li> <p>\u52a0\u5bc6\u548c\u5ba1\u8ba1</p> <ul> <li>\u542f\u7528\u4f20\u8f93\u52a0\u5bc6\u3001\u6570\u636e\u4fdd\u62a4\u548c\u6d3b\u52a8\u5ba1\u8ba1</li> </ul> </li> <li> <p>\u7f51\u7edc\u52a0\u56fa</p> <ul> <li>\u5185\u7f51\u90e8\u7f72\u670d\u52a1\u5668</li> <li>\u8bbe\u7f6e\u9632\u706b\u5899</li> <li>\u64cd\u4f5c\u7cfb\u7edf\u8bbe\u7f6e</li> </ul> </li> <li> <p>\u9075\u5faa\u5b89\u5168\u51c6\u5219</p> <ul> <li>\u9075\u5b88\u4e0d\u540c\u884c\u4e1a\u6216\u5730\u533a\u5b89\u5168\u6807\u51c6\u5408\u89c4\u6027\u8981\u6c42</li> </ul> </li> </ol>"},{"location":"mongo2/11mon_sec/#_9","title":"\u5408\u7406\u914d\u7f6e\u6743\u9650","text":"<p>\u521b\u5efa\u7ba1\u7406\u5458 / \u4f7f\u7528\u590d\u6742\u5bc6\u7801 / \u4e0d\u540c\u7528\u6237\u4e0d\u540c\u8d26\u6237 / \u5e94\u7528\u9694\u79bb / \u6700\u5c0f\u6743\u9650\u539f\u5219</p>"},{"location":"mongo2/11mon_sec/#_10","title":"\u542f\u7528\u52a0\u5bc6","text":"<ul> <li>\u4f7f\u7528 TLS \u4f5c\u4e3a\u4f20\u8f93\u534f\u8bae</li> <li>\u4f7f\u75284.2\u7248\u672c\u7684\u5b57\u6bb5\u7ea7\u52a0\u5bc6\u5bf9\u654f\u611f\u5b57\u6bb5\u52a0\u5bc6 </li> <li>\u5982\u6709\u9700\u8981\uff0c\u4f7f\u7528\u4f01\u4e1a\u7248\u8fdb\u884c\u843d\u76d8\u52a0\u5bc6</li> <li>\u5982\u6709\u9700\u8981\uff0c\u4f7f\u7528\u4f01\u4e1a\u7248\u5e76\u542f\u7528\u5ba1\u8ba1\u65e5\u5fd7</li> </ul>"},{"location":"mongo2/11mon_sec/#demo","title":"Demo: \u542f\u7528\u8ba4\u8bc1","text":"<ul> <li>\u65b9\u5f0f\u4e00: \u547d\u4ee4\u884c\u65b9\u5f0f\u901a\u8fc7 <code>--auth</code> \u53c2\u6570</li> <li>\u65b9\u5f0f\u4e8c: \u914d\u7f6e\u6587\u4ef6\u65b9\u5f0f\u5728 security \u4e0b\u6dfb\u52a0 <code>authorization: enabled</code></li> </ul> <pre><code>mongod  --auth  --port 27017 --dbpath /data/db\n</code></pre> <p>\u542f\u7528\u9274\u6743\u540e\uff0c\u65e0\u5bc6\u7801\u53ef\u4ee5\u767b\u5f55\uff0c\u4f46\u662f\u53ea\u80fd\u6267\u884c\u521b\u5efa\u7528\u6237\u64cd\u4f5c</p> <pre><code>mongo\n&gt; use admin\n&gt; db.createUser({user: \"superuser\", pwd: \"password\", roles: [{role: \"root\", db: \"admin\"}]} )\n</code></pre> <p>\u5b89\u5168\u767b\u5f55\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u67e5\u770b\u8ba4\u8bc1\u673a\u5236</p> <pre><code>mongo -u superuser -p password --authenticationDatabase admin \n\ndb.runCommand({getParameter: 1, authenticationMechanisms: 1})\n</code></pre> <pre><code>mongod --dbpath /data/db  --fork  --logpath  --port 27017   --auth \n\nmongo\n</code></pre> <p>\u4ece\u6570\u636e\u5e93\u4e2d\u67e5\u770b\u7528\u6237</p> <pre><code>db.system.users.find()\n</code></pre> <p>\u65e0\u6cd5\u8fdb\u884c\u4efb\u4f55 list, use, find \u7684\u64cd\u4f5c</p> <p></p> <p>Not authorized </p> <pre><code>db.createUser({user: \"superuser\", pwd: \"password\", roles: [{role: \"root\", db: \"admin\"}]} )\n</code></pre> <p></p> <p>\u7528\u7684admin \u767b\u5f55\u5c31\u53ef\u4ee5\u770b\u5230\u81ea\u5df1\u5bb6\u60f3\u770b\u7684db, collections\uff0c\u8fd8\u6709\u8bb0\u5f55</p> <pre><code>mongo -u superuser -p abc123 --authenticationDatabase admin\n</code></pre> <p></p>"},{"location":"mongo2/11mon_sec/#_11","title":"\u521b\u5efa\u5e94\u7528\u7528\u6237","text":"<p>\u521b\u5efa\u53ea\u8bfb\u7528\u6237</p> <pre><code>db.createUser({user: \"reader\", pwd: \"abc123\", roles: [{ role:\"read\", db: \"acme\" }]})\n</code></pre> <p>acme Reader \u53ea\u80fd\u9488\u5bf9acme\u8bfb\u8868\u6570\u636e</p> <p></p> <p>\u4e0d\u80fd\u5bf9\u5176\u4ed6collection\u64cd\u4f5c</p> <p></p> <p>\u4e0d\u80fd\u6709\u5199\u5165\u64cd\u4f5c</p> <p>\u521b\u5efa\u8bfb\u5199\u7528\u6237</p> <pre><code>db.createUser({user: \"writer\", pwd: \"abc123\", roles: [{ role:\"readWrite\", db: \"acme\" }]})\n</code></pre> <p></p> <p>\u53ea\u80fd\u5bf9acme collection\u64cd\u4f5c</p>"},{"location":"mongo2/12mon_index/","title":"12 MongoDB \u7d22\u5f15","text":""},{"location":"mongo2/12mon_index/#mongodb","title":"MongoDB \u7d22\u5f15\u673a\u5236","text":""},{"location":"mongo2/12mon_index/#1-index-key","title":"1 \u672f\u8bed \u2013 Index / Key","text":"<p>Index/Key/DataPage\u2014\u2014\u7d22\u5f15/\u952e/\u6570\u636e\u9875?</p> <p></p>"},{"location":"mongo2/12mon_index/#2-covered-query","title":"2 \u672f\u8bed \u2013 Covered Query","text":"<p>Covered Query/FETCH\u2014\u2014\u67e5\u8be2\u8986\u76d6/\u6293\u53d6?</p> <p>\u5982\u679c\u6240\u6709\u9700\u8981\u7684\u5b57\u6bb5\u90fd\u5728\u7d22\u5f15\u4e2d\uff0c\u4e0d\u9700\u8981\u989d\u5916\u7684\u5b57\u6bb5\uff0c\u5c31\u53ef \u4ee5\u4e0d\u518d\u9700\u8981\u4ece\u6570\u636e\u9875\u52a0\u8f7d\u6570\u636e\uff0c\u8fd9\u5c31\u662f\u67e5\u8be2\u8986\u76d6\u3002</p> <pre><code>db.human.createIndex({firstName: 1, lastName: 1, gender: 1, age: 1})\n</code></pre> <p></p>"},{"location":"mongo2/12mon_index/#ixscancollscan","title":"\u672f\u8bed \u2013 IXSCAN/COLLSCAN","text":"<p>IXSCAN/COLLSCAN\u2014\u2014\u7d22\u5f15\u626b\u63cf/\u96c6\u5408\u626b\u63cf</p> <p></p> <p>\u672f\u8bed \u2013 Big O Notation</p> <p></p>"},{"location":"mongo2/12mon_index/#query-shape","title":"\u672f\u8bed \u2013 Query Shape","text":"<p>Query Shape\u2014\u2014\u67e5\u8be2\u7684\u5f62\u72b6?</p> <pre><code>query Shape = {\n    \"attribute.name\": 1, \n    \"attribute.value\": 1\n}\n</code></pre> <p></p>"},{"location":"mongo2/12mon_index/#index-prefix","title":"\u672f\u8bed \u2013 Index Prefix","text":"<p><code>Index Prefix\u2014\u2014\u7d22\u5f15\u524d\u7f00</code></p> <pre><code>db.human.createIndex({firstName: 1, lastName: 1, gender: 1, age: 1})\n</code></pre> <p>\u4ee5\u4e0a\u7d22\u5f15\u7684\u5168\u90e8\u524d\u7f00\u5305\u62ec:</p> <ul> <li><code>{firstName: 1}</code></li> <li><code>{firstName: 1, lastName: 1}</code></li> <li><code>{firstName: 1, lastName: 1, gender: 1}</code></li> </ul> <p>\u6240\u6709\u7d22\u5f15\u524d\u7f00\u90fd\u53ef\u4ee5\u88ab\u8be5\u7d22\u5f15\u8986\u76d6\uff0c\u6ca1\u6709\u5fc5\u8981\u9488\u5bf9\u8fd9\u4e9b\u67e5\u8be2\u5efa\u7acb\u989d\u5916\u7684\u7d22\u5f15</p>"},{"location":"mongo2/12mon_index/#-selectivity","title":"\u672f\u8bed - Selectivity","text":"<p>Selectivity\u2014\u2014\u8fc7\u6ee4\u6027</p> <p>\u5728\u4e00\u4e2a\u670910000\u6761\u8bb0\u5f55\u7684\u96c6\u5408\u4e2d:</p> <ul> <li>\u6ee1\u8db3 <code>gender= F</code> \u7684\u8bb0\u5f55\u67094000 \u6761</li> <li>\u6ee1\u8db3 <code>city=LA</code> \u7684\u8bb0\u5f55\u6709 100 \u6761</li> <li>\u6ee1\u8db3 <code>ln='parker'</code> \u7684\u8bb0\u5f55\u6709 10 \u6761</li> </ul> <p>\u6761\u4ef6 ln \u80fd\u8fc7\u6ee4\u6389\u6700\u591a\u7684\u6570\u636e\uff0ccity \u5176\u6b21\uff0cgender \u6700\u5f31\u3002\u6240\u4ee5 ln \u7684\u8fc7 \u6ee4\u6027(selectivity)\u5927\u4e8e city \u5927\u4e8e gender\u3002</p> <p>\u5982\u679c\u8981\u67e5\u8be2\u540c\u65f6\u6ee1\u8db3:</p> <p><code>gender == F &amp;&amp; city == SZ &amp;&amp; ln == 'parker'</code></p> <p>\u7684\u8bb0\u5f55\uff0c\u4f46\u53ea\u5141\u8bb8\u4e3a <code>gender/city/ln</code> \u4e2d\u7684\u4e00\u4e2a\u5efa\u7acb\u7d22\u5f15\uff0c\u5e94\u8be5\u628a\u7d22\u5f15\u653e\u5728\u54ea\u91cc?</p> <p></p> <p>ln \u66f4\u9ad8\u6548</p>"},{"location":"mongo2/12mon_index/#b","title":"B\u6811\u7ed3\u6784","text":"<p>\u7d22\u5f15\u80cc\u540e\u662f B-\u6811\u3002\u8981\u6b63\u786e\u4f7f\u7528\u7d22\u5f15\uff0c\u5fc5\u987b\u5148\u4e86\u89e3 B-\u6811\u7684\u5de5\u4f5c\u539f\u7406\u3002</p> <p></p> <p>B- \u6811: \u57fa\u4e8eB\u6811\uff0c\u4f46\u662f\u5b50\u8282\u70b9\u6570\u91cf\u53ef\u4ee5\u8d85\u8fc72\u4e2a</p>"},{"location":"mongo2/12mon_index/#_1","title":"\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5\u590d\u4e60","text":"<p>\u7531\u4e8e B\u6811/B-\u6811\u7684\u5de5\u4f5c\u8fc7\u7a0b\u8fc7\u4e8e\u590d\u6742\uff0c\u4f46\u672c\u8d28\u4e0a\u5b83\u662f\u4e00\u4e2a\u6709\u5e8f\u7684\u6570\u636e\u7ed3\u6784\u3002\u6211\u4eec \u7528\u6570\u7ec4\u6765\u7406\u89e3\u5b83\u3002\u5047\u8bbe\u7d22\u5f15\u4e3a<code>{a: 1}(a \u5347\u5e8f)</code>:</p> <pre><code>\u6570\u636e                               \u7d22\u5f15\ndb.table.insert({a: 1})          [1]\ndb.table.insert({a: 10})         [1, 10]\ndb.table.insert({a: 5})          [1, 5, 10]\ndb.table.insert({a: 7})          [1, 5, 7, 10]\ndb.table.insert({a: 3})          [1, 3,5,7,10]\n</code></pre> <ul> <li>\u6570\u636e\u589e\u52a0/\u5220\u9664\u65f6\u59cb\u7ec8 \u4fdd\u6301\u88ab\u7d22\u5f15\u5b57\u6bb5\u6709\u5e8f</li> <li>\u6570\u7ec4\u63d2\u5165\u6548\u7387\u592a\u4f4e\uff0c\u4f46 B \u6811\u53ef\u4ee5\u9ad8\u6548\u5b9e\u73b0</li> <li>\u5728\u6709\u5e8f\u7ed3\u6784\u4e0a\u5b9e\u65bd\u4e8c\u5206\u67e5\u627e\uff0c\u53ef\u5b9e\u73b0 O(log2(n)) \u9ad8\u6548\u641c\u7d22</li> </ul>"},{"location":"mongo2/12mon_index/#2-mongodb","title":"2  MongoDB \u7d22\u5f15\u673a\u5236","text":""},{"location":"mongo2/12mon_index/#_2","title":"\u7d22\u5f15\u6267\u884c\u8ba1\u5212","text":"<p>\u5047\u8bbe\u96c6\u5408\u6709\u4e24\u4e2a\u7d22\u5f15</p> <ol> <li><code>{city: 1}</code></li> <li><code>{last_name:1 }</code></li> </ol> <p>\u67e5\u8be2:</p> <p><code>db.members.find({ city: \"LA\", last_name: \"parker\"})</code> \u95ee\u9898:\u7528\u54ea\u4e2a\u7d22\u5f15?</p>"},{"location":"mongo2/12mon_index/#explain","title":"<code>explain()</code>","text":"<pre><code>-- \u5199\u516510000\u6761\u6587\u6863\n\nfor (var i=1;i&lt;100000; i++)\n    db.col.insert({name:i, age:i, date:new Date() \n} )\n\n-- \u67e5\u8be2\ndb.col.find({name:1111}).explain(true)\n</code></pre> <pre><code>&gt;&gt;\"executionStats\" :\n{ \n    \"executionSuccess\" : true,\n    \"nReturned\" : 1,\n    \"executionTimeMillis\" : 58,\n    \"totalKeysExamined\" : 0,\n    \"totalDocsExamined\" : 99999,\n        \"executionStages\" : {\n        \"stage\" : \"COLLSCAN\",\n        \"filter\" : {\"name\" : {\"$eq\" : 1111}}, \n        \"nReturned\" : 1,\n        \"executionTimeMillisEstimate\" : 53, \n        \"works\" : 100001,\n        \"advanced\" : 1, \n        \"needTime\" : 99999, \n        \"needYield\" : 0, \n        \"saveState\" : 783, \n        \"restoreState\" : 783, \n        \"isEOF\" : 1,\n        \"invalidates\" : 0, \n        \"direction\" : \"forward\", \n        \"docsExamined\" : 99999\n</code></pre> <ul> <li><code>\"executionTimeMillis\" : 58</code></li> <li><code>\"totalDocsExamined\" : 99999</code></li> <li><code>\"stage\" : \"COLLSCAN\",</code></li> <li><code>\"docsExamined\" : 99999</code></li> </ul> <p>\u63d2\u5165\u7d22\u5f15</p> <pre><code>-- \u5199\u516510000\u6761\u6587\u6863\nfor (var i=1;i&lt;100000; i++)\n    db.col.insert(\n        {name:i, age:i, date:new Date() } \n)\n-- \u521b\u5efaname\u7d22\u5f15 \ndb.col.createIndex({name:1})\n\n-- \u67e5\u8be2 \ndb.col.find({name:1111}).explain(true)\n</code></pre> <pre><code>&gt; \"executionStats\" : {\n    \"executionSuccess\" : true, \n    \"nReturned\" : 1,\n    \"executionTimeMillis\" : 3, \n    \"totalKeysExamined\" : 1, \n    \"totalDocsExamined\" : 1, \n    \"executionStages\" : {\n        \"stage\" : \"FETCH\", \n        \"nReturned\" : 1,\n    \"executionTimeMillisEstimate\" : 0,\n        \"docsExamined\" : 1, \n        \"alreadyHasObj\" : 0, \n        \"inputStage\" : {\n            \"stage\" : \"IXSCAN\",\n            \"nReturned\" : 1,\n            \"executionTimeMillisEstimate\" : 0,\n            \"works\" : 2,\n            \"advanced\" : 1,\n         ...\n}\n</code></pre> <ul> <li><code>\"executionTimeMillis\" : 3,</code></li> <li><code>\"totalDocsExamined\" : 1,</code></li> <li><code>\"docsExamined\" : 1</code></li> <li><code>\"stage\" : \"IXSCAN\",</code></li> </ul>"},{"location":"mongo2/12mon_index/#mongodb_1","title":"MongoDB \u7d22\u5f15\u7c7b\u578b","text":"<ul> <li>\u5355\u952e\u7d22\u5f15</li> <li>\u7ec4\u5408\u7d22\u5f15</li> <li>\u591a\u503c\u7d22\u5f15</li> <li>\u5730\u7406\u4f4d\u7f6e\u7d22\u5f15</li> <li>\u5168\u6587\u7d22\u5f15</li> <li>TTL\u7d22\u5f15 </li> <li>\u90e8\u5206\u7d22\u5f15 </li> <li>\u54c8\u5e0c\u7d22\u5f15</li> </ul>"},{"location":"mongo2/12mon_index/#compound-index","title":"\u7ec4\u5408\u7d22\u5f15 \u2013 Compound Index","text":"<pre><code>db.members.find({ gender: \"F\"\uff0c age: {$gte: 18}}).sort(\"join_date:1\")\n</code></pre> <pre><code>{ gender: 1, age: 1, join_date: 1 } \n{ gender: 1, join_date:1, age: 1 } \n{ join_date: 1, gender: 1, age: 1 } \n{ join_date: 1, age: 1, gender: 1 } \n{ age: 1, join_date: 1, gender: 1} \n{ age: 1, gender: 1, join_date: 1}\n</code></pre> <p>\u8fd9\u4e48\u591a\u5019\u9009\u7684\uff0c\u7528\u54ea\u4e00\u4e2a?</p> <p>\u7ec4\u5408\u7d22\u5f15\u7684\u6700\u4f73\u65b9\u5f0f:ESR\u539f\u5219</p> <ul> <li>\u7cbe\u786e(Equal)\u5339\u914d\u7684\u5b57\u6bb5\u653e\u6700\u524d\u9762</li> <li>\u6392\u5e8f(Sort)\u6761\u4ef6\u653e\u4e2d\u95f4</li> <li>\u8303\u56f4(Range)\u5339\u914d\u7684\u5b57\u6bb5\u653e\u6700\u540e\u9762</li> </ul> <p>\u540c\u6837\u9002\u7528: ES, ER</p>"},{"location":"mongo2/12mon_index/#_3","title":"\u7ec4\u5408\u7d22\u5f15\u5de5\u4f5c\u6a21\u5f0f","text":"<pre><code>{a: 1, b: 2, c: 1} \n{a: 1, b: 2, c: 2} \n{a: 2, b: 2, c: 1} \n{a: 2, b: 2, c: 3} \n{a: 2, b: 3, c: 1} \n{a: 2, b: 3, c: 2} \n{a: 2, b: 3, c: 4}\n\ndb.test.createIndex({ \n    a: 1,\n    b: 1,\n    c: 1 \n})\n</code></pre> <p>\u7ec4\u5408\u7d22\u5f15\u5de5\u4f5c\u6a21\u5f0f: \u7cbe\u786e\u5339\u914d</p> <p><code>db.test.createIndex({a: 1, b: 1, c: 1})</code></p> <pre><code>db.test.find({\n    a: 2,\n    b: 2,\n    c: 1 \n})\n</code></pre> <p></p>"},{"location":"mongo2/12mon_index/#_4","title":"\u8303\u56f4\u7ec4\u5408\u67e5\u8be2: \u7d22\u5f15\u5b57\u6bb5\u987a\u5e8f\u7684\u5f71\u54cd","text":"<p><code>db.test.find({a: 2, b: {$gte: 2, $lte: 3}, c: 1})</code></p> <p></p> <p>EER is much better</p>"},{"location":"mongo2/12mon_index/#_5","title":"\u8303\u56f4+\u6392\u5e8f\u7ec4\u5408\u67e5\u8be2: \u7d22\u5f15\u5b57\u6bb5\u987a\u5e8f\u7684\u5f71\u54cd","text":"<p><code>db.test.find({a: 2, b: {$gte: 2, $lte: 3}).sort({c: 1})</code></p> <p></p> <p>ESR is much better</p> <p>ERS \u91cc\u9762\u5185\u5b58\u6392\u5e8f\u5c06\u4f1a\u8017\u8d39\u5927\u91cf\u7684\u5185\u5b58</p>"},{"location":"mongo2/12mon_index/#_6","title":"\u5730\u7406\u4f4d\u7f6e\u7d22\u5f15","text":"<pre><code>-- \u521b\u5efa\u7d22\u5f15\ndb.geo_col.createIndex(\n        { location: \"2d\"} ,\n        { min:-20, max: 20 , bits: 10},\n        {collation:{locale: \"simple\"} }\n)\n\ndb.geo_col.find(\n    { location :\n        { $geoWithin:  { $box : [ [ 1, 1 ] , [ 3, 3 ] ] } } }\n)\n</code></pre> <pre><code>-- \u67e5\u8be2\u7ed3\u679c\n{ \"_id\" : ObjectId(\"5c7e7a6243513eb45bf06125\"), \"location\" : [ 1, 1 ] }\n { \"_id\" : ObjectId(\"5c7e7a6643513eb45bf06126\"), \"location\" : [ 1, 2 ] } \n { \"_id\" : ObjectId(\"5c7e7a6943513eb45bf06127\"), \"location\" : [ 2, 2 ] } \n { \"_id\" : ObjectId(\"5c7e7a6d43513eb45bf06128\"), \"location\" : [ 2, 1 ] } \n { \"_id\" : ObjectId(\"5c7e7a7343513eb45bf06129\"), \"location\" : [ 3, 1 ] } \n { \"_id\" : ObjectId(\"5c7e7a7543513eb45bf0612a\"), \"location\" : [ 3, 2 ] } \n { \"_id\" : ObjectId(\"5c7e7a7743513eb45bf0612b\"), \"location\" : [ 3, 3 ] }\n</code></pre>"},{"location":"mongo2/12mon_index/#_7","title":"\u5168\u6587\u7d22\u5f15","text":"<pre><code>-- \u63d2\u5165\u6570\u636e\ndb.&lt;collection_name&gt;.insert(\n    { _id: 1, content: \"This morning I had a cup of coffee.\", about: \"beverage\", keywords: [ \"coffee\" ] } ,\n    { _id: 2, content: \"Who doesn't like cake?\", about: \"food\", keywords: [ \"cake\", \"food\", \"dessert\" ] },\n    { _id: 3, content: \"Why need coffee?\", about: \u201dfood\", keywords: [ \u201ddrink\", \"food\" ] }\n)\n\n\n-- \u521b\u5efa\u7d22\u5f15\n&gt;&gt; db.&lt;collection_name&gt;.createIndex(\n    {'content': 'text' }\n)\n\n-- \u67e5\u8be2\ndb.&lt;collection_name&gt;.find( { \n    $text :   { $search : \"cup coffee like\" }\n})\n\ndb.&lt;collection_name&gt;.find( { \n    $text:  {$search: \"a cup of coffee\" }\n})\n\n-- \u67e5\u8be2\u6392\u5e8f\ndb.&lt;collection_name&gt;.find(\n    { $text : { $search : \"coffee\"} },\n    { textScore: { $meta : \"textScore\" }} ).sort({ textScore: { $meta: \"textScore\" }} )\n</code></pre>"},{"location":"mongo2/12mon_index/#_8","title":"\u90e8\u5206\u7d22\u5f15","text":"<pre><code>-- \u521b\u5efa\u90e8\u5206\u7d22\u5f15\n&gt;&gt; db.&lt;collection_name&gt;.createIndex( \n    {'a': 1 },\n    { partialFilterExpression: \n        {a:{\n            $gte:5\n        } \n    }\n)\n\n-- \u53ea\u5bf9\u6709wechat\u5b57\u6bb5\u7684\u5efa\u7d22\u5f15:\ndb.&lt;collection_name&gt;.createIndex( \n    {'wechat': 1 },\n    { partialFilterExpression: \n        {wechat:\n            {$exists: true}\n        } \n)\n\n-- \u7d22\u5f15\u76ee\u6807\u6587\u6863\n{ \"_id\" : ObjectId(\"5c7f4d8723a59b2f55f58ca9\"), \"a\" : 5 } \n{ \"_id\" : ObjectId(\"5c7f4d8723a59b2f55f58caa\"), \"a\" : 6 } \n{ \"_id\" : ObjectId(\"5c7f4d8723a59b2f55f58cab\"), \"a\" : 7 } \n{ \"_id\" : ObjectId(\"5c7f4d8723a59b2f55f58cac\"), \"a\" : 8 }\n{ \"_id\" : ObjectId(\"5c7f4d8723a59b2f55f58cad\"), \"a\" : 9 } \n{ \"_id\" : ObjectId(\"5c7f4d8723a59b2f55f58cae\"), \"a\" : 10} \n</code></pre>"},{"location":"mongo2/12mon_index/#_9","title":"\u5176\u4ed6\u7d22\u5f15\u6280\u5de7","text":"<p>\u540e\u53f0\u521b\u5efa\u7d22\u5f15</p> <pre><code>db.member.createIndex( { city: 1}, {background: true} )\n</code></pre> <p>\u5bf9BI / \u62a5\u8868\u4e13\u7528\u8282\u70b9\u5355\u72ec\u521b\u5efa\u7d22\u5f15</p> <ul> <li>\u8be5\u4ece\u8282\u70b9priority\u8bbe\u4e3a0</li> <li>\u5173\u95ed\u8be5\u4ece\u8282\u70b9\uff0c</li> <li>\u4ee5\u5355\u673a\u6a21\u5f0f\u542f\u52a8</li> <li>\u6dfb\u52a0\u7d22\u5f15(\u5206\u6790\u7528)</li> <li>\u5173\u95ed\u8be5\u4ece\u8282\u70b9\uff0c\u4ee5\u526f\u672c\u96c6\u6a21\u5f0f\u542f\u52a8</li> </ul>"},{"location":"mongo2/13mon_perf/","title":"13 MongoDB \u6027\u80fd","text":""},{"location":"mongo2/13mon_perf/#1-mongodb","title":"1 MongoDB \u6027\u80fd\u673a\u5236","text":"<p>\u4e00\u6b21\u6570\u636e\u5e93\u8bf7\u6c42\u8fc7\u7a0b\u4e2d\u53d1\u751f\u4e86\u4ec0\u4e48?</p> <p></p>"},{"location":"mongo2/13mon_perf/#_1","title":"\u5e94\u7528\u7aef","text":""},{"location":"mongo2/13mon_perf/#-","title":"\u5e94\u7528\u7aef-\u9009\u62e9\u8282\u70b9","text":"<p>\u5bf9\u4e8e\u590d\u5236\u96c6\u8bfb\u64cd\u4f5c\uff0c\u9009\u62e9\u54ea\u4e2a\u8282\u70b9\u662f\u7531 <code>readPreference</code> \u51b3\u5b9a\u7684:</p> <ul> <li>primary/primaryPreferred</li> <li>secondary/secondaryPreferred </li> <li>nearest</li> </ul> <p>\u5982\u679c\u4e0d\u5e0c\u671b\u4e00\u4e2a\u8fdc\u8ddd\u79bb\u8282\u70b9\u88ab\u9009\u62e9\uff0c\u5e94\u505a\u5230\u4ee5\u4e0b\u4e4b\u4e00:</p> <ul> <li>\u5c06\u5b83\u8bbe\u7f6e\u4e3a\u9690\u85cf\u8282\u70b9;</li> <li>\u901a\u8fc7\u6807\u7b7e(Tag)\u63a7\u5236\u53ef\u9009\u7684\u8282\u70b9;</li> <li>\u4f7f\u7528 nearest \u65b9\u5f0f;</li> </ul> <p></p>"},{"location":"mongo2/13mon_perf/#-_1","title":"\u5e94\u7528\u7aef-\u6392\u961f\u7b49\u5f85","text":"<ul> <li>\u6392\u961f\u7b49\u5f85\u8fde\u63a5\u662f\u5982\u4f55\u53d1\u751f\u7684?<ul> <li>\u603b\u8fde\u63a5\u6570\u5927\u4e8e\u5141\u8bb8\u7684\u6700\u5927\u8fde\u63a5\u6570maxPoolSize;</li> </ul> </li> <li>\u5982\u4f55\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898?<ul> <li>\u52a0\u5927\u6700\u5927\u8fde\u63a5\u6570(\u4e0d\u4e00\u5b9a\u6709\u7528); </li> <li>\u4f18\u5316\u67e5\u8be2\u6027\u80fd;</li> </ul> </li> </ul>"},{"location":"mongo2/13mon_perf/#-_2","title":"\u5e94\u7528\u7aef-\u8fde\u63a5\u4e0e\u8ba4\u8bc1","text":"<ul> <li>\u5982\u679c\u4e00\u4e2a\u8bf7\u6c42\u9700\u8981\u7b49\u5f85\u521b\u5efa\u65b0\u8fde\u63a5\u548c\u8fdb\u884c\u8ba4\u8bc1\uff0c\u76f8\u6bd4\u76f4\u63a5\u4ece\u8fde\u63a5\u6c60\u83b7\u53d6\u8fde\u63a5\uff0c\u5b83\u5c06\u8017\u8d39\u66f4\u957f\u65f6\u95f4\u3002</li> <li>\u53ef\u80fd\u89e3\u51b3\u65b9\u6848:<ul> <li>\u8bbe\u7f6e minPoolSize(\u6700\u5c0f\u8fde\u63a5\u6570)\u4e00\u6b21\u6027\u521b\u5efa\u8db3\u591f\u7684\u8fde\u63a5;</li> <li>\u907f\u514d\u7a81\u53d1\u7684\u5927\u91cf\u8bf7\u6c42;</li> </ul> </li> </ul>"},{"location":"mongo2/13mon_perf/#_2","title":"\u6570\u636e\u5e93\u7aef","text":"<p>\u6570\u636e\u5e93\u7aef-\u6392\u961f\u7b49\u5f85</p> <ul> <li>\u7531 ticket \u4e0d\u8db3\u5f15\u8d77\u7684\u6392\u961f\u7b49\u5f85\uff0c\u95ee\u9898\u5f80\u5f80\u4e0d\u5728 ticket \u672c\u8eab\uff0c\u800c\u5728\u4e8e\u4e3a\u4ec0\u4e48\u6b63\u5728\u6267\u884c \u7684\u64cd\u4f5c\u4f1a\u957f\u65f6\u95f4\u5360\u7528 ticket\u3002</li> <li>\u53ef\u80fd\u89e3\u51b3\u65b9\u6848:<ul> <li>\u4f18\u5316 CRUD \u6027\u80fd\u53ef\u4ee5\u51cf\u5c11 ticket \u5360\u7528\u65f6\u95f4;</li> <li>zlib \u538b\u7f29\u65b9\u5f0f\u4e5f\u53ef\u80fd\u5f15\u8d77 ticket \u4e0d\u8db3\uff0c\u56e0\u4e3a zlib \u7b97\u6cd5\u672c\u8eab\u5728\u8fdb\u884c\u538b\u7f29\u3001\u89e3\u538b\u65f6\u9700\u8981\u7684\u65f6 \u95f4\u6bd4\u8f83\u957f\uff0c\u4ece\u800c\u9020\u6210\u957f\u65f6\u95f4\u7684 ticket \u5360\u7528;</li> </ul> </li> </ul>"},{"location":"mongo2/13mon_perf/#-_3","title":"\u6570\u636e\u5e93\u7aef-\u6267\u884c\u8bf7\u6c42(\u8bfb)","text":"<p>\u4e0d\u80fd\u547d\u4e2d\u7d22\u5f15\u7684\u641c\u7d22\u548c\u5185\u5b58\u6392\u5e8f\u662f\u5bfc\u81f4\u6027\u80fd\u95ee\u9898\u7684\u6700\u4e3b\u8981\u539f\u56e0</p> <p></p> <p>\u4e0d\u80fd\u547d\u4e2d\u7d22\u5f15\u7684\u641c\u7d22\u548c\u5185\u5b58\u6392\u5e8f\u662f\u5bfc\u81f4\u6027\u80fd\u95ee\u9898\u7684\u6700\u4e3b\u8981\u539f\u56e0</p>"},{"location":"mongo2/13mon_perf/#-_4","title":"\u6570\u636e\u5e93\u7aef-\u6267\u884c\u8bf7\u6c42(\u5199)","text":"<p>\u78c1\u76d8\u901f\u5ea6\u5fc5\u987b\u6bd4\u5199\u5165\u901f\u5ea6\u8981\u5feb\u624d\u80fd\u4fdd\u6301\u7f13\u5b58\u6c34\u4f4d</p>"},{"location":"mongo2/13mon_perf/#-_5","title":"\u6570\u636e\u5e93\u7aef-\u5408\u5e76\u7ed3\u679c","text":"<ul> <li>\u5982\u679c\u987a\u5e8f\u4e0d\u91cd\u8981\u5219\u4e0d\u8981\u6392\u5e8f</li> <li>\u5c3d\u53ef\u80fd\u4f7f\u7528\u5e26\u7247\u952e\u7684\u67e5\u8be2\u6761\u4ef6\u4ee5\u51cf\u5c11\u53c2\u4e0e\u67e5\u8be2\u7684\u5206\u7247\u6570</li> </ul>"},{"location":"mongo2/13mon_perf/#_3","title":"\u7f51\u7edc\u7684\u8003\u91cf","text":""},{"location":"mongo2/13mon_perf/#_4","title":"\u6027\u80fd\u74f6\u9888\u603b\u7ed3","text":"\u5e94\u7528\u7aef \u670d\u52a1\u7aef \u7f51\u7edc \u9009\u62e9\u8bbf\u95ee\u5165\u53e3\u8282\u70b9 \u6392\u961f\u7b49\u5f85ticket \u5e94\u7528/\u9a71\u52a8 - mongos \u7b49\u5f85\u6570\u636e\u5e93\u8fde\u63a5 \u6267\u884c\u8bf7\u6c42 mongos - \u7247 \u521b\u5efa\u8fde\u63a5\u548c\u5b8c\u6210\u8ba4\u8bc1 \u5408\u5e76\u6267\u884c\u7ed3\u679c"},{"location":"mongo2/13mon_perf/#2","title":"2 \u6027\u80fd\u6392\u67e5\u5de5\u5177","text":""},{"location":"mongo2/13mon_perf/#-mongostat","title":"\u95ee\u9898\u8bca\u65ad\u5de5\u5177 - mongostat","text":"<p>mongostat: \u7528\u4e8e\u4e86\u89e3 MongoDB \u8fd0\u884c\u72b6\u6001\u7684\u5de5\u5177</p>"},{"location":"mongo2/13mon_perf/#-mongotop","title":"\u95ee\u9898\u8bca\u65ad\u5de5\u5177 - mongotop","text":"<p>mongotop: \u7528\u4e8e\u4e86\u89e3\u96c6\u5408\u538b\u529b\u72b6\u6001\u7684\u5de5\u5177</p>"},{"location":"mongo2/13mon_perf/#mongod","title":"\u95ee\u9898\u8bca\u65ad \u2013 mongod \u65e5\u5fd7","text":"<p>\u65e5\u5fd7\u4e2d\u4f1a\u8bb0\u5f55\u6267\u884c\u8d85\u8fc7 100ms \u7684\u67e5\u8be2\u53ca\u5176\u6267\u884c\u8ba1\u5212(\u5173\u4e8e\u6267\u884c\u8ba1\u5212\u7684\u66f4\u8be6\u7ec6\u89e3\u91ca \u8bf7\u53c2\u8003\u6587\u6863):</p> <p></p> <pre><code>2019-10-25T11:20:30.775+0800 I COMMAND [conn12] command test.test appName: \"MongoDB Shell\" command: find { find: \"test\", filter: { i: 10000.0 }, $db: \"test\" } planSummary: COLLSCAN keysExamined:0 docsExamined:27108 cursorExhausted:1 numYields:211 nreturned:1 reslen:243 locks:{ Global: { acquireCount: { r: 424 } }, Database: { acquireCount: { r: 212 } }, Collection: { acquireCount: { r: 212 } } } protocol:op_command 19ms\n</code></pre>"},{"location":"mongo2/13mon_perf/#-mtools","title":"\u95ee\u9898\u8bca\u65ad - mtools","text":"<ul> <li>\u5b89\u88c5:pip install mtools</li> <li>\u5e38\u7528\u6307\u4ee4:<ul> <li>mplotqueries \u65e5\u5fd7\u6587\u4ef6:\u5c06\u6240\u6709\u6162\u67e5\u8be2 \u901a\u8fc7\u56fe\u8868\u5f62\u5f0f\u5c55\u73b0;</li> <li><code>mloginfo --queries</code> \u65e5\u5fd7\u6587\u4ef6:\u603b\u7ed3\u51fa \u6240\u6709\u6162\u67e5\u8be2\u7684\u6a21\u5f0f\u548c\u51fa\u73b0\u6b21\u6570\u3001\u6d88\u8017\u65f6 \u95f4\u7b49;</li> </ul> </li> </ul> <p>\u66f4\u591a\u6307\u4ee4\u53ca\u7528\u6cd5\u53c2\u8003:</p> <p>https://github.com/rueckstiess/mtools</p> <p></p>"},{"location":"mongo2/14mon_cluster/","title":"14 \u9ad8\u7ea7\u96c6\u7fa4\u8bbe\u8ba1","text":""},{"location":"mongo2/14mon_cluster/#1","title":"1 \u9ad8\u7ea7\u96c6\u7fa4\u8bbe\u8ba1:\u4e24\u5730\u4e09\u4e2d\u5fc3","text":""},{"location":"mongo2/14mon_cluster/#_1","title":"\u5bb9\u707e\u7ea7\u522b","text":"<p>RPO represents how fresh recovered data will be. In practice, the RPO indicates the amount of data (updated or created) that will be lost or need to be reentered after an outage. </p> <p>Recovery Time Objective (RTO) is the amount of downtime a business can tolerate.</p> <ul> <li>L0 \u65e0\u5907\u6e90\u4e2d\u5fc3<ul> <li>\u6ca1\u6709\u707e\u96be\u6062\u590d\u80fd\u529b\uff0c\u53ea\u5728\u672c\u5730\u8fdb\u884c\u6570\u636e\u5907\u4efd</li> <li>RPO  24\u5c0f\u65f6</li> <li>RTO  4\u5c0f\u65f6</li> </ul> </li> <li>L1 \u672c\u5730\u5907\u4efd+\u5f02\u5730\u4fdd\u5b58<ul> <li>\u672c\u5730\u5c06\u5173\u952e\u6570\u636e\u5907\u4efd\uff0c\u7136\u540e\u9001\u5230\u5f02\u5730\u4fdd\u5b58\u3002 </li> <li>\u707e\u96be\u53d1\u751f\u540e\uff0c\u6309\u9884\u5b9a\u6570\u636e\u6062\u590d\u7a0b\u5e8f\u6062\u590d\u7cfb\u7edf\u548c\u6570\u636e</li> <li>RPO 24\u5c0f\u65f6</li> <li>RTO  8\u5c0f\u65f6</li> </ul> </li> <li>L2 \u53cc\u4e2d\u5fc3\u4e3b\u5907\u6a21\u5f0f<ul> <li>\u5728\u5f02\u5730\u5efa\u7acb\u4e00\u4e2a\u70ed\u5907\u4efd\u70b9\uff0c\u901a\u8fc7\u7f51\u7edc\u8fdb\u884c\u6570\u636e\u5907\u4efd</li> <li>\u5f53\u51fa\u73b0\u707e\u96be\u65f6\uff0c\u5907\u4efd\u7ad9\u70b9\u63a5\u66ff\u4e3b\u7ad9\u70b9\u7684\u4e1a\u52a1\uff0c\u7ef4\u62a4\u4e1a\u52a1\u8fde\u7eed\u6027</li> <li>RPO \u79d2\u7ea7</li> <li>RTO \u6570\u5206\u949f\u5230\u534a\u5c0f\u65f6</li> </ul> </li> <li>L3 \u53cc\u4e2d\u5fc3\u53cc\u6d3b<ul> <li>\u5728\u76f8\u9694\u8f83\u8fdc\u7684\u5730\u65b9\u5206\u522b\u5efa\u7acb\u4e24\u4e2a\u6570\u636e\u4e2d\u5fc3\uff0c\u8fdb\u884c\u76f8\u4e92\u6570\u636e\u5907\u4efd\u3002</li> <li>\u5f53\u67d0\u4e2a\u6570\u636e\u4e2d\u5fc3\u53d1\u751f\u707e\u96be\u65f6\uff0c\u53e6\u4e00\u4e2a\u6570\u636e\u4e2d\u5fc3\u63a5\u66ff\u5176\u5de5\u4f5c\u4efb\u52a1\u3002</li> <li>RPO \u79d2\u7ea7</li> <li>RTO \u79d2\u7ea7</li> </ul> </li> <li>\u53cc\u4e2d\u5fc3\u53cc\u6d3b + \u5f02\u5730\u70ed\u5907 = \u4e24\u5730\u4e09\u4e2d\u5fc3<ul> <li>\u5728\u540c\u57ce\u5206\u522b\u5efa\u7acb\u4e24\u4e2a\u6570\u636e\u4e2d\u5fc3\uff0c\u8fdb\u884c\u76f8\u4e92\u6570\u636e\u5907\u4efd</li> <li>\u5f53\u8be5\u57ce\u5e02\u76842\u4e2a\u4e2d\u5fc3\u540c\u65f6\u4e0d\u53ef\u7528(\u5730\u9707/\u5927\u9762\u79ef\u505c\u7535/\u7f51\u7edc\u7b49)\uff0c\u5feb\u901f\u5207\u6362\u5230\u5f02\u5730</li> <li>RPO \u79d2\u7ea7</li> <li>RTO \u6570\u5206\u949f</li> </ul> </li> </ul>"},{"location":"mongo2/14mon_cluster/#_2","title":"\u53cc\u6d3b\u7684\u6280\u672f\u7ec4\u4ef6","text":""},{"location":"mongo2/14mon_cluster/#_3","title":"\u7f51\u7edc\u5c42\u89e3\u51b3\u65b9\u6848","text":"<ul> <li>Server load balancing (SLB)</li> <li>Global Server load balancing (GSLB)</li> </ul>"},{"location":"mongo2/14mon_cluster/#_4","title":"\u5e94\u7528\u5c42\u89e3\u51b3\u65b9\u6848","text":"<ul> <li>\u4f7f\u7528\u8d1f\u8f7d\u5747\u8861\u3001\u865a\u62dfIP</li> <li>\u4f7f\u7528\u540c\u4e00\u4e2aSession</li> <li>\u4f7f\u7528\u540c\u4e00\u5957\u6570\u636e</li> </ul>"},{"location":"mongo2/14mon_cluster/#_5","title":"\u6570\u636e\u5e93\u89e3\u51b3\u65b9\u6848 \u2013 \u6570\u636e\u8de8\u4e2d\u5fc3\u540c\u6b65","text":""},{"location":"mongo2/14mon_cluster/#mongodb","title":"MongoDB \u4e09\u4e2d\u5fc3\u65b9\u6848","text":"<p>\u590d\u5236\u96c6\u8de8\u4e2d\u5fc3\u90e8\u7f72:</p> <p>\u6b63\u5e38\u8fd0\u884c\u72b6\u6001\u96c6\u7fa4\u5185\u4e00\u4e2a\u4e3b\u8282\u70b9\u63a5\u53d7\u5199\uff0c\u5176\u4ed6\u8282\u70b9\u53ea\u8bfb</p> <p></p> <p>Failover</p> <p>\u4e3b\u8282\u70b9\u6545\u969c\u4e3b\u6570\u636e\u4e2d\u5fc3\u5185\u81ea\u52a8\u5207\u4e3b\u5207\u6362\u65f6\u95f45-10\u79d2</p> <p></p> <p>\u53cc\u4e2d\u5fc3\u53cc\u6d3b\uff0c\u5206\u6d41\u6a21\u5f0f\u671d\u9633\u4e2d\u5fc3\u9700\u8981\u8de8\u4e2d\u5fc3\u5199\u5230\u6d77\u6dc0\u4e2d\u5fc3\u540c\u57ce\u53cc\u4e2d\u5fc3\u9700\u8981\u4f4e\u5ef6\u8fdf\u4e13\u7ebf</p> <p></p> <ul> <li>Write: \u5199\u5165\u540c\u4e00\u4e2aprimary node</li> <li>\u8bfb\uff1a\u53ef\u4ee5\u4ece\u591a\u5730\u7684secondary node \u8bfb</li> </ul> <p>\u6b63\u5e38\u8fd0\u884c <code>writeConcern: majority</code> \u9700\u8981\u7b49\u5f85\u671d\u9633\u4e2d\u5fc3\u8fd4\u56de</p> <p></p> <p>\u9700\u8981oplog\u540c\u6b65\u5230\u591a\u4e2ashard\uff0c\u624d\u80fd\u5b8c\u6210\u7edf\u4e00\u7684\u5199\u76d8\u843d\u5730</p>"},{"location":"mongo2/14mon_cluster/#mongodb_1","title":"MongoDB \u96c6\u7fa4\u4e24\u5730\u4e09\u4e2d\u5fc3\u90e8\u7f72\u7684\u8003\u91cf\u70b9","text":"<ul> <li>\u8282\u70b9\u6570\u91cf\u5efa\u8bae\u89815\u4e2a\uff0c2+2+1\u6a21\u5f0f</li> <li>\u4e3b\u6570\u636e\u4e2d\u5fc3\u7684\u4e24\u4e2a\u8282\u70b9\u8981\u8bbe\u7f6e\u9ad8\u4e00\u70b9\u7684\u4f18\u5148\u7ea7\uff0c\u51cf\u5c11\u8de8\u4e2d\u5fc3\u6362\u4e3b\u8282\u70b9</li> <li>\u540c\u57ce\u53cc\u4e2d\u5fc3\u4e4b\u95f4\u7684\u7f51\u7edc\u8981\u4fdd\u8bc1\u4f4e\u5ef6\u8fdf\u548c\u9891\u5bbd\uff0c\u6ee1\u8db3 <code>writeConcern: Majority</code> \u7684\u53cc\u4e2d\u5fc3\u5199\u9700\u6c42</li> <li>\u4f7f\u7528 Retryable Writes and Retryable Reads \u6765\u4fdd\u8bc1\u96f6\u4e0b\u7ebf\u65f6\u95f4</li> <li>\u7528\u6237\u9700\u8981\u81ea\u884c\u5904\u7406\u597d\u4e1a\u52a1\u5c42\u7684\u53cc\u4e2d\u5fc3\u5207\u6362</li> </ul>"},{"location":"mongo2/14mon_cluster/#_6","title":"\u5b9e\u9a8c:\u642d\u5efa\u4e24\u5730\u4e09\u4e2d\u5fc3\u96c6\u7fa4","text":""},{"location":"mongo2/14mon_cluster/#_7","title":"\u5b9e\u9a8c\u76ee\u6807\u53ca\u6d41\u7a0b","text":"<ul> <li>\u76ee\u6807:\u5b66\u4e60\u5982\u4f55\u642d\u5efa\u4e00\u4e2a3\u4e2d\u5fc3\u90e8\u7f72\u7684 MongoDB \u590d\u5236\u96c6</li> <li>\u73af\u5883:3\u53f0 Linux \u865a\u62df\u673a\uff0c 2 Core 4GB</li> <li>\u6b65\u9aa4:<ul> <li>\u914d\u7f6e\u57df\u540d\u89e3\u6790</li> <li>\u5b89\u88c5 MongoDB</li> <li>\u914d\u7f6e\u590d\u5236\u96c6</li> <li>\u914d\u7f6e\u4f18\u5148\u7ea7</li> <li>\u542f\u52a8\u6301\u7eed\u5199\u811a\u672c</li> <li>\u6a21\u62df\u4ece\u6570\u636e\u4e2d\u5fc3\u6545\u969c</li> <li>\u6a21\u62df\u4e3b\u6570\u636e\u4e2d\u5fc3\u6545\u969c</li> </ul> </li> </ul>"},{"location":"mongo2/14mon_cluster/#5-mongodb","title":"\u542f\u52a85\u4e2a MongoDB \u5b9e\u4f8b","text":"<p>\u5728\u865a\u62df\u673a1\u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4 (mem1, mem2)</p> <pre><code>mkdir -p member1 member2\nmongod --dbpath ~/member1 --replSet demo --bind_ip 0.0.0.0 --port 10001 --fork --logpath member1.log \nmongod --dbpath ~/member2 --replSet demo --bind_ip 0.0.0.0 --port 10002 --fork --logpath member2.log\n</code></pre> <p>\u5728\u865a\u62df\u673a2\u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4(mem3, mem4)</p> <pre><code>mkdir -p member3 member4\nmongod --dbpath ~/member3 --replSet demo --bind_ip 0.0.0.0 --port 10003 --fork --logpath member3.log\nmongod --dbpath ~/member4 --replSet demo --bind_ip 0.0.0.0 --port 10004 --fork --logpath member4.log\n</code></pre> <p>\u5728\u865a\u62df\u673a3\u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4(mem5)</p> <pre><code>mkdir -p member5\nmongod --dbpath ~/member5 --replSet demo --bind_ip 0.0.0.0 --port 10005 --fork --logpath member5.log\n</code></pre>"},{"location":"mongo2/14mon_cluster/#_8","title":"\u521d\u59cb\u5316\u590d\u5236\u96c6","text":"<p>\u5728\u865a\u62df\u673a3\u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6d4b\u8bd5\u6240\u6709\u5b9e\u4f8b\u6b63\u5e38\u5de5\u4f5c</p> <pre><code>mongo member1.example.com:10001 \nmongo member2.example.com:10002 \nmongo member3.example.com:10003\nmongo member2.example.com:10004 \nmongo member3.example.com:10005\n</code></pre> <p>\u521d\u59cb\u5316\u590d\u5236\u96c6</p> <pre><code>mongo member1.example.com:10001 \nrs.initiate(\n        {\n        \"_id\" : \"demo\", \n        \"version\" : 1, \n        \"members\" : [\n            { \"_id\" : 0, \"host\" : \"member1.example.com:10001\" }, \n            { \"_id\" : 1, \"host\" : \"member2.example.com:10002\" }, \n            { \"_id\" : 2, \"host\" : \"member3.example.com:10003\" },\n            { \"_id\" : 3, \"host\" : \"member4.example.com:10004\" }, \n            { \"_id\" : 4, \"host\" : \"member5.example.com:10005\" }\n            ] \n        }\n    )\n</code></pre>"},{"location":"mongo2/14mon_cluster/#_9","title":"\u914d\u7f6e\u9009\u4e3e\u4f18\u5148\u7ea7","text":"<p>\u628a\u7b2c\u4e00\u53f0\u673a\u5668\u4e0a\u76842\u4e2a\u5b9e\u4f8b\u7684\u9009\u4e3e\u4f18\u5148\u7ea7\u8c03\u9ad8\u4e3a5\u548c10(\u9ed8\u8ba4\u4e3a1)</p> <pre><code>mongo member1.example.com:10001\n\ncfg = rs.conf() \ncfg.members[0].priority = 5 \ncfg.members[1].priority = 10 \nrs.reconfig(cfg)\n</code></pre> <p>\u901a\u5e38\u90fd\u6709\u4e3b\u5907\u6570\u636e\u4e2d\u5fc3\u4e4b\u5206\uff0c\u6211\u4eec\u5e0c\u671b\u7ed9\u4e3b\u6570\u636e\u4e2d\u5fc3\u66f4\u9ad8\u7684\u4f18\u5148\u7ea7</p>"},{"location":"mongo2/14mon_cluster/#2","title":"\u542f\u52a8\u6301\u7eed\u5199\u811a\u672c(\u6bcf2\u79d2\u5199\u4e00\u6761\u8bb0\u5f55)","text":"<pre><code># mongo --retryWrites mongodb://member1.example.com:10001,member2.example.com:10002,member3.example.com:10003,member4. example.com:10004,member5.example.com:10005/test?replicaSet=demo ingest-script\n</code></pre> <p><code>ingest-script</code></p> <pre><code>db.test.drop()\nfor(var i=1;i&lt;1000;i++){\n    db.test.insert({item: i});\n    inserted = db.test.findOne({item: i});\n    if(inserted)\n        print(\" Item \"+ i +\" was inserted \u201d + new Date().getTime()/1000 + );\n    else\n        print(\"Unexpected \"+ inserted)\n    sleep(2000);\n}\n</code></pre> <p></p> <p></p>"},{"location":"mongo2/14mon_cluster/#2_1","title":"\u6a21\u62df\u4ece\u6570\u636e\u4e2d\u5fc3(\u7b2c2\u53f0\u673a\u5668)\u6545\u969c","text":"<p>\u505c\u6b62\u7b2c2\u53f0\u865a\u62df\u673a\u4e0a\u6240\u6709 mongodb \u8fdb\u7a0b</p> <pre><code>pkill mongod\n</code></pre> <p></p> <p>\u89c2\u5bdf\u7b2c3\u53f0\u865a\u62df\u673a\u4e0a\u7684\u5199\u5165\u672a\u53d7\u4e2d\u65ad</p> <p></p> <p>\u6062\u590d\u7b2c2\u53f0\u865a\u62df\u673a\u4e0a\u6240\u6709 mongodb \u8fdb\u7a0b</p> <p></p>"},{"location":"mongo2/14mon_cluster/#1_1","title":"\u6a21\u62df\u4e3b\u6570\u636e\u4e2d\u5fc3(\u7b2c1\u53f0\u673a\u5668)\u6545\u969c","text":"<p>\u505c\u6b62\u7b2c1\u53f0\u865a\u62df\u673a\u4e0a\u6240\u6709 mongodb \u8fdb\u7a0b</p> <pre><code>pkill mongod\n</code></pre> <p>\u89c2\u5bdf\u7b2c3\u53f0\u865a\u62df\u673a\u4e0a\u7684\u5199\u5165\u672a\u53d7\u4e2d\u65ad</p>"},{"location":"mongo2/14mon_cluster/#mongodb_2","title":"MongoDB \u96c6\u7fa4\u4e24\u5730\u4e09\u4e2d\u5fc3\u90e8\u7f72","text":"<ul> <li>\u642d\u5efa\u7b80\u5355\uff0c\u4f7f\u7528\u590d\u5236\u96c6\u673a\u5236\uff0c\u65e0\u9700\u7b2c\u4e09\u65b9\u8f6f\u4ef6</li> <li>\u4f7f\u7528Retryable Writes\u4ee5\u540e\uff0c\u5373\u4f7f\u51fa\u73b0\u6570\u636e\u4e2d\u5fc3\u6545\u969c\uff0c\u5bf9\u524d\u7aef\u4e1a\u52a1\u6ca1\u6709\u4efb\u4f55\u4e2d\u65ad (Retryable Writes \u57284.2\u4ee5\u540e\u5c31\u662f\u9ed8\u8ba4\u8bbe\u7f6e)</li> </ul>"},{"location":"mongo2/14mon_cluster/#_10","title":"\u9ad8\u7ea7\u96c6\u7fa4\u8bbe\u8ba1:\u5168\u7403\u591a\u5199","text":"<p>MongoDB \u591a\u4e2d\u5fc3\u90e8\u7f72\u7684\u4e09\u79cd\u6a21\u5f0f</p> <p></p>"},{"location":"mongo2/14mon_cluster/#_11","title":"\u5168\u7403\u5316\u4e1a\u52a1\u9700\u6c42","text":"<ul> <li>\u67d0\u5962\u4f88\u54c1\u724c\u5382\u5546\u4e1a\u52a1\u96c6\u4e2d\u5728\u5927\u4e2d\u534e\u5730\u533a</li> <li>2020\u5e74\u7684\u76ee\u6807\u662f\u8981\u8fdb\u5165\u7f8e\u56fd\u5e02\u573a</li> <li>\u4ed6\u4eec\u7684\u4e3b\u8981\u4e1a\u52a1\u7cfb\u7edf\u90fd\u96c6\u4e2d\u5728\u9999\u6e2f</li> <li>\u5982\u4f55\u8bbe\u8ba1\u6211\u4eec\u7684\u4e1a\u52a1\u7cfb\u7edf\u6765\u4fdd\u8bc1\u6d77\u5916\u7528\u6237\u7684\u6700\u4f73\u4f53\u9a8c?</li> </ul>"},{"location":"mongo2/14mon_cluster/#_12","title":"\u8fdc\u8ddd\u79bb\u8bbf\u95ee\u65e0\u6cd5\u4fdd\u8bc1\u7528\u6237\u4f53\u9a8c","text":""},{"location":"mongo2/14mon_cluster/#mongodb_3","title":"MongoDB \u590d\u5236\u96c6 \u2013 \u53ea\u89e3\u51b3\u4e86\u8bfb\u7684\u95ee\u9898","text":"<p>MongoDB Zone Sharding \u2013 \u5168\u7403\u96c6\u7fa4</p> <p></p>"},{"location":"mongo2/14mon_cluster/#zone-sharding","title":"Zone Sharding \u8bbe\u7f6e\u6b65\u9aa4","text":"<ul> <li>\u9488\u5bf9\u6bcf\u4e2a\u8981\u5206\u7247\u7684\u6570\u636e\u96c6\u5408\uff0c\u6a21\u578b\u4e2d\u589e\u52a0\u4e00\u4e2a\u533a\u57df\u5b57\u6bb5</li> <li>\u7ed9\u96c6\u7fa4\u7684\u6bcf\u4e2a\u5206\u7247\u52a0\u533a\u57df\u6807\u7b7e</li> <li>\u7ed9\u6bcf\u4e2a\u533a\u57df\u6307\u5b9a\u5c5e\u4e8e\u8fd9\u4e2a\u533a\u57df\u7684\u5206\u7247\u5757\u8303\u56f4(chunk range)</li> </ul> <p>1. \u6570\u636e\u6a21\u578b:\u589e\u52a0\u533a\u57df\u5b57\u6bb5</p> <p></p> <p>2. \u7ed9\u5206\u7247\u6dfb\u52a0\u6807\u7b7e</p> <pre><code># mongo\n&gt; sh.addShardTag(\u201cshard0\u201d, \u201dASIA\")\n\n&gt; sh.addShardTag(\u201cshard1\u201d, \u201dAMERICA\")\n</code></pre> <p></p> <p>3. \u6807\u7b7e\u6307\u5b9a\u6570\u636e\u5757\u8303\u56f4</p> <pre><code>\n# mongo\n&gt; sh.addTagRange( \u201dcrm.orders\",\n    { \"locationCode\" : \"CN\", \"order_id\" : MinKey },\n    { \"locationCode\" : \"CN\", \"order_id\" : MaxKey } , \"ASIA\" )\n\n&gt; sh.addTagRange( \"crm.orders\",\n    { \"locationCode\" : \"US\", \u201dorder_id\" : MinKey },\n    { \"locationCode\" : \"US\", \u201dorder_id\" : MaxKey } , \"AMERICA\" )\n\n&gt; sh.addTagRange( \"crm.orders\",\n    { \"locationCode\" : \"CA\", \"order_id\" : MinKey },\n    { \"locationCode\" : \"CA\", \"order_id\" : MaxKey } , \"AMERICA\"  )\n</code></pre> <p>MongoDB Zone Sharding \u5de5\u4f5c\u539f\u7406</p> <p></p> <p>\u8bfb\u5199\u573a\u666f\u5206\u6790</p> <p></p>"},{"location":"mongo2/14mon_cluster/#_13","title":"\u72ec\u7acb\u96c6\u7fa4\u6a21\u5f0f \u2013 \u9700\u8981\u5916\u90e8\u5de5\u5177\u53cc\u5411\u540c\u6b65","text":""},{"location":"mongo2/15mon_goonline/","title":"15 MongoDB\u4e0a\u7ebf\u53ca\u5347\u7ea7","text":""},{"location":"mongo2/15mon_goonline/#mongodb","title":"MongoDB\u4e0a\u7ebf\u53d1\u5e03","text":""},{"location":"mongo2/15mon_goonline/#_1","title":"\u4e0a\u7ebf\u524d:\u6027\u80fd\u6d4b\u8bd5","text":"<ul> <li>\u6a21\u62df\u771f\u5b9e\u538b\u529b\uff0c\u5bf9\u96c6\u7fa4\u5b8c\u6210\u5145\u5206\u7684\u6027\u80fd\u6d4b\u8bd5\uff0c\u4e86\u89e3\u96c6\u7fa4\u6982\u51b5\u3002</li> <li>\u6027\u80fd\u6d4b\u8bd5\u7684\u8f93\u51fa<ul> <li>\u538b\u6d4b\u8fc7\u7a0b\u4e2d\u5404\u9879\u6307\u6807\u8868\u73b0\uff0c\u4f8b\u5982 CRUD \u8fbe\u5230\u591a\u5c11\uff0c\u8fde\u63a5\u6570\u8fbe\u5230\u591a\u5c11\u7b49\u3002 </li> <li>\u6839\u636e\u6b63\u5e38\u6307\u6807\u8303\u56f4\u914d\u7f6e\u76d1\u63a7\u9608\u503c;</li> <li>\u6839\u636e\u538b\u6d4b\u7ed3\u679c\u6309\u9700\u8c03\u6574\u786c\u4ef6\u8d44\u6e90;</li> </ul> </li> </ul>"},{"location":"mongo2/15mon_goonline/#_2","title":"\u4e0a\u7ebf\u524d:\u73af\u5883\u68c0\u67e5","text":"<p>\u6309\u7167\u6700\u4f73\u5b9e\u8df5\u8981\u6c42\u5bf9\u751f\u4ea7\u73af\u5883\u6240\u4f7f\u7528\u7684\u64cd\u4f5c\u7cfb\u7edf\u8fdb\u884c\u68c0\u67e5\u548c\u8c03\u6574\u3002\u6700\u5e38\u89c1\u7684\u9700\u8981\u8c03\u6574\u7684\u53c2\u6570\u5305\u62ec:</p> <ul> <li>\u7981\u7528 NUMA\uff0c\u5426\u5219\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\u4f1a\u5f15\u8d77\u7a81\u53d1\u5927\u91cfswap\u4ea4\u6362;</li> <li>\u7981\u7528 Transparent Huge Page\uff0c\u5426\u5219\u4f1a\u5f71\u54cd\u6570\u636e\u5e93\u6548\u7387;</li> <li><code>tcp_keepalive_time</code> \u8c03\u6574\u4e3a120\u79d2\uff0c\u907f\u514d\u4e00\u4e9b\u7f51\u7edc\u95ee\u9898;</li> <li><code>ulimit -n</code>\uff0c\u907f\u514d\u6253\u5f00\u6587\u4ef6\u53e5\u67c4\u4e0d\u8db3\u7684\u60c5\u51b5;</li> <li>\u5173\u95ed atime\uff0c\u63d0\u9ad8\u6570\u636e\u6587\u4ef6\u8bbf\u95ee\u6548\u7387;</li> </ul> <p>\u66f4\u591a\u68c0\u67e5\u9879\uff0c\u8bf7\u53c2\u8003\u6587\u6863:Production Notes</p>"},{"location":"mongo2/15mon_goonline/#_3","title":"\u4e0a\u7ebf\u540e","text":"<ul> <li>\u6027\u80fd\u76d1\u63a7</li> </ul> <p>\u4e3a\u9632\u6b62\u7a81\u53d1\u72b6\u51b5\uff0c\u5e94\u5bf9\u5e38\u89c1\u6027\u80fd\u6307\u6807\u8fdb\u884c\u76d1\u63a7\u4ee5\u53ca\u65f6\u53d1\u73b0\u95ee\u9898\u3002 \u6027\u80fd\u76d1\u63a7\u8bf7\u53c2\u8003\u524d\u8ff0\u7ae0\u8282\u7684\u5185\u5bb9</p> <ul> <li> <p>\u5b9a\u671f\u5065\u5eb7\u68c0\u67e5</p> <ul> <li>mongod \u65e5\u5fd7;</li> <li>\u73af\u5883\u8bbe\u7f6e\u662f\u5426\u6709\u53d8\u52a8;</li> <li>MongoDB \u914d\u7f6e\u662f\u5426\u6709\u53d8\u52a8;</li> </ul> </li> </ul>"},{"location":"mongo2/15mon_goonline/#mongodb_1","title":"MongoDB \u7ebf\u4e0a\u5347\u7ea7","text":""},{"location":"mongo2/15mon_goonline/#mongodb_2","title":"MongoDB \u7248\u672c\u53d1\u5e03\u89c4\u5f8b","text":""},{"location":"mongo2/15mon_goonline/#_4","title":"\u4e3b\u7248\u672c\u5347\u7ea7\u6d41\u7a0b","text":"<p>https://docs.mongodb.com/ecosystem/drivers/driver-compatibility-reference/</p>"},{"location":"mongo2/15mon_goonline/#mongodb_3","title":"MongoDB \u5355\u673a\u5347\u7ea7\u6d41\u7a0b","text":""},{"location":"mongo2/15mon_goonline/#mongodb_4","title":"MongoDB \u590d\u5236\u96c6\u5347\u7ea7\u6d41\u7a0b","text":"<pre><code>db.adminCommand( { setFeatureCompatibilityVersion: \u201d4.2\" } \n</code></pre> <p>FCV: FeatureCompatibilityVersion</p>"},{"location":"mongo2/15mon_goonline/#mongodb_5","title":"MongoDB \u5206\u7247\u96c6\u7fa4\u5347\u7ea7\u6d41\u7a0b","text":""},{"location":"mongo2/15mon_goonline/#_5","title":"\u7248\u672c\u5347\u7ea7:\u5728\u7ebf\u5347\u7ea7","text":"<ul> <li>MongoDB\u652f\u6301\u5728\u7ebf\u5347\u7ea7\uff0c\u5373\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u4e0d\u9700\u8981\u95f4\u65ad\u670d\u52a1;</li> <li>\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u867d\u7136\u4f1a\u53d1\u751f\u4e3b\u4ece\u8282\u70b9\u5207\u6362\uff0c\u5b58\u5728\u77ed\u65f6\u95f4\u4e0d\u53ef\u7528\uff0c\u4f46\u662f:<ul> <li>3.6\u7248\u672c\u5f00\u59cb\u652f\u6301\u81ea\u52a8\u5199\u91cd\u8bd5\u53ef\u4ee5\u81ea\u52a8\u6062\u590d\u4e3b\u4ece\u5207\u6362\u5f15\u8d77\u7684\u96c6\u7fa4\u6682\u65f6\u4e0d\u53ef\u5199</li> <li>4.2\u5f00\u59cb\u652f\u6301\u7684\u81ea\u52a8\u8bfb\u91cd\u8bd5\u5219\u63d0\u4f9b\u4e86\u5305\u62ec\u4e3b\u4ece\u5207\u6362\u5728\u5185\u7684\u8bfb\u95ee\u9898\u7684\u81ea\u52a8\u6062\u590d;</li> </ul> </li> </ul> <p>\u5347\u7ea7\u9700\u8981\u9010\u7248\u672c\u5b8c\u6210\uff0c\u4e0d\u53ef\u4ee5\u8df3\u7248\u672c:</p> <ul> <li>\u6b63\u786e: <code>3.2-&gt;3.4-&gt;3.6-&gt;4.0-&gt;4.2</code></li> <li>\u9519\u8bef: <code>3.2-&gt;4.2</code></li> <li>\u539f\u56e0:<ul> <li>MongoDB\u590d\u5236\u96c6\u4ec5\u4ec5\u5141\u8bb8\u76f8\u90bb\u7248\u672c\u5171\u5b58</li> <li>\u6709\u4e00\u4e9b\u5347\u7ea7\u5185\u90e8\u6570\u636e\u683c\u5f0f\u5982\u5bc6\u7801\u52a0\u5bc6\u5b57\u6bb5\uff0c\u9700\u8981\u5728\u5347\u7ea7\u8fc7\u7a0b\u4e2d\u7531mongo\u8fdb\u884c\u8f6c\u6362</li> </ul> </li> </ul>"},{"location":"mongo2/15mon_goonline/#_6","title":"\u5347\u7ea7\u6d41\u7a0b:\u964d\u7ea7","text":"<p>\u5982\u679c\u5347\u7ea7\u65e0\u8bba\u56e0\u4f55\u79cd\u539f\u56e0\u5931\u8d25\uff0c\u5219\u9700\u8981\u964d\u7ea7\u5230\u539f\u6709\u65e7\u7248\u672c\u3002\u5728\u964d\u7ea7\u8fc7\u7a0b\u4e2d:</p> <ul> <li>\u6eda\u52a8\u964d\u7ea7\u8fc7\u7a0b\u4e2d\u96c6\u7fa4\u53ef\u4ee5\u4fdd\u6301\u5728\u7ebf\uff0c\u4ec5\u5728\u5207\u6362\u8282\u70b9\u65f6\u4f1a\u4ea7\u751f\u4e00\u5b9a\u7684\u4e0d\u53ef\u5199\u65f6\u95f4;</li> <li>\u964d\u7ea7\u524d\u5e94\u5148\u53bb\u9664\u5df2\u7ecf\u7528\u5230\u7684\u65b0\u7248\u672c\u7279\u6027\u3002\u4f8b\u5982\u7528\u5230\u4e86 NumberDecimal \u5219\u5e94\u628a\u6240\u6709\u4f7f\u7528 <code>NumberDecimal</code> \u7684\u6587\u6863\u5148\u53bb\u9664\u8be5\u5b57\u6bb5;</li> <li>\u901a\u8fc7\u8bbe\u7f6e <code>FCV(Feature Compatibility Version)</code> \u53ef\u4ee5\u5728\u529f\u80fd\u4e0a\u964d\u5230\u4e0e\u65e7\u7248\u672c\u517c\u5bb9;</li> <li>FCV \u8bbe\u7f6e\u5b8c\u6210\u540e\u518d\u6eda\u52a8\u66ff\u6362\u4e3a\u65e7\u7248\u672c\u3002</li> </ul>"},{"location":"mongo2/16mon_sample/","title":"16 MongoDB \u5e94\u7528\u5b9e\u4f8b\u548c\u573a\u666f","text":""},{"location":"mongo2/16mon_sample/#1-mongodb","title":"1 MongoDB \u5e94\u7528\u573a\u666f\u53ca\u9009\u578b","text":""},{"location":"mongo2/16mon_sample/#1-1-mongodb","title":"1-1 MongoDB \u6570\u636e\u5e93\u5b9a\u4f4d","text":"<ul> <li>OLTP \u6570\u636e\u5e93</li> <li>\u539f\u5219\u4e0a Oracle \u548c MySQL \u80fd\u505a\u7684\u4e8b\u60c5\uff0cMongoDB \u90fd\u80fd\u505a(\u5305\u62ec ACID \u4e8b\u52a1)</li> <li>\u4f18\u70b9:\u6a2a\u5411\u6269\u5c55\u80fd\u529b\uff0c\u6570\u636e\u91cf\u6216\u5e76\u53d1\u91cf\u589e\u52a0\u65f6\u5019\u67b6\u6784\u53ef\u4ee5\u81ea\u52a8\u6269\u5c55</li> <li>\u4f18\u70b9:\u7075\u6d3b\u6a21\u578b\uff0c\u9002\u5408\u8fed\u4ee3\u5f00\u53d1\uff0c\u6570\u636e\u6a21\u578b\u591a\u53d8\u573a\u666f</li> <li>\u4f18\u70b9: JSON \u6570\u636e\u7ed3\u6784\uff0c\u9002\u5408\u5fae\u670d\u52a1/REST API</li> </ul>"},{"location":"mongo2/16mon_sample/#mongodb","title":"\u57fa\u4e8e\u529f\u80fd\u9009\u62e9 MongoDB","text":"<p>\u57fa\u4e8e\u573a\u666f\u9009\u62e9 MongoDB</p> <p></p>"},{"location":"mongo2/16mon_sample/#_1","title":"\u79fb\u52a8\u5e94\u7528","text":"<p>\u573a\u666f\u7279\u70b9</p> <ul> <li>\u57fa\u4e8e REST API / JSON</li> <li>\u5feb\u901f\u8fed\u4ee3\uff0c\u6570\u636e\u7ed3\u6784\u53d8\u5316\u9891\u7e41</li> <li>\u5730\u7406\u4f4d\u7f6e\u529f\u80fd</li> <li>\u7206\u53d1\u589e\u957f\u53ef\u80fd\u6027</li> <li>\u9ad8\u53ef\u7528</li> </ul> <p>MongoDB \u9009\u578b\u8003\u91cf</p> <ul> <li>\u6587\u6863\u6a21\u578b\u53ef\u4ee5\u652f\u6301\u4e0d\u540c\u7684\u7ed3\u6784</li> <li>\u539f\u751f\u5730\u7406\u4f4d\u7f6e\u529f\u80fd</li> <li>\u6a2a\u5411\u6269\u5c55\u80fd\u529b\u652f\u6491\u7206\u53d1\u589e\u957f</li> <li>\u590d\u5236\u96c6\u673a\u5236\u5feb\u901f\u63d0\u4f9b\u9ad8\u53ef\u7528</li> <li>\u6469\u62dc\u5355\u8f66 / Keep / ADP</li> </ul>"},{"location":"mongo2/16mon_sample/#_2","title":"\u5546\u54c1\u4fe1\u606f","text":"<p>\u573a\u666f\u7279\u70b9</p> <ul> <li>\u5546\u54c1\u4fe1\u606f\u5305\u7f57\u4e07\u8c61</li> <li>\u5546\u54c1\u7684\u5c5e\u6027\u4e0d\u540c\u54c1\u7c7b\u5dee\u5f02\u5f88\u5927 </li> <li>\u6570\u636e\u5e93\u6a21\u5f0f\u8bbe\u8ba1\u56f0\u96be</li> </ul> <p>MongoDB \u9009\u578b\u8003\u91cf</p> <ul> <li>\u6587\u6863\u6a21\u578b\u53ef\u4ee5\u96c6\u6210\u4e0d\u540c\u5546\u54c1\u5c5e\u6027 </li> <li>\u53ef\u53d8\u6a21\u578b\u9002\u5408\u8fed\u4ee3</li> <li>\u4eac\u4e1c\u5546\u57ce /\u5c0f\u7ea2\u4e66/ GAP</li> </ul>"},{"location":"mongo2/16mon_sample/#_3","title":"\u5185\u5bb9\u7ba1\u7406","text":"<p>\u573a\u666f\u7279\u70b9</p> <ul> <li>\u5185\u5bb9\u6570\u636e\u591a\u6837\uff0c\u6587\u672c\uff0c\u56fe\u7247\uff0c\u89c6\u9891 </li> <li>\u6269\u5c55\u56f0\u96be\uff0c\u6570\u636e\u91cf\u7206\u53d1\u589e\u957f</li> </ul> <p>MongoDB \u9009\u578b\u8003\u91cf</p> <ul> <li>JSON \u7ed3\u6784\u53ef\u4ee5\u652f\u6301\u975e\u7ed3\u6784\u5316\u6570\u636e </li> <li>\u5206\u7247\u67b6\u6784\u53ef\u4ee5\u89e3\u51b3\u6269\u5c55\u95ee\u9898</li> <li>Adobe AEM / Sitecore</li> </ul>"},{"location":"mongo2/16mon_sample/#_4","title":"\u7269\u8054\u7f51","text":"<p>\u573a\u666f\u7279\u70b9</p> <ul> <li>\u4f20\u611f\u5668\u7684\u6570\u636e\u7ed3\u6784\u5f80\u5f80\u662f\u534a\u7ed3\u6784\u5316 </li> <li>\u4f20\u611f\u5668\u6570\u91cf\u5f88\u5927\uff0c\u91c7\u96c6\u9891\u7e41</li> <li>\u6570\u636e\u91cf\u5f88\u5bb9\u6613\u589e\u957f\u5230\u6570\u4ebf\u5230\u767e\u4ebf</li> </ul> <p>MongoDB \u9009\u578b\u8003\u91cf</p> <ul> <li>JSON \u7ed3\u6784\u53ef\u4ee5\u652f\u6301\u534a\u7ed3\u6784\u5316\u6570\u636e</li> <li>\u4f7f\u7528\u5206\u7247\u80fd\u529b\u652f\u6491\u6d77\u91cf\u6570\u636e</li> <li>JSON \u6570\u636e\u66f4\u52a0\u5bb9\u6613\u548c\u5176\u4ed6\u7cfb\u7edf\u901a \u8fc7 REST API \u8fdb\u884c\u96c6\u6210</li> <li>\u534e\u4e3a / Bosch / Mindsphere</li> </ul>"},{"location":"mongo2/16mon_sample/#saas","title":"SaaS\u5e94\u7528","text":"<p>\u573a\u666f\u7279\u70b9</p> <ul> <li>\u591a\u79df\u6237\u6a21\u5f0f\uff0c \u9700\u8981\u670d\u52a1\u5f88\u591a\u5ba2\u6237 </li> <li>\u9700\u6c42\u591a\u53d8\uff0c\u8fed\u4ee3\u538b\u529b\u5927</li> <li>\u6570\u636e\u91cf\u589e\u957f\u5feb</li> </ul> <p>MongoDB \u9009\u578b\u8003\u91cf</p> <ul> <li>\u65e0\u6a21\u5f0f\u6570\u636e\u5e93\uff0c\u9002\u5408\u5feb\u901f\u8fed\u4ee3</li> <li>\u6c34\u5e73\u6269\u5c55\u80fd\u529b\u53ef\u4ee5\u652f\u6491\u5927\u91cf\u7528\u6237\u589e\u957f</li> <li>ADP / Teambition</li> </ul>"},{"location":"mongo2/16mon_sample/#_5","title":"\u4e3b\u673a\u5206\u6d41","text":"<p>\u573a\u666f\u7279\u70b9</p> <ul> <li>\u91d1\u878d\u884c\u4e1a\u4f20\u7edf\u91c7\u7528 IBM \u6216\u8005\u5c0f\u673a</li> <li>\u4f20\u7edf\u7011\u5e03\u5f00\u53d1\u6a21\u5f0f\u6d41\u7a0b\u957f\u6210\u672c\u9ad8</li> <li>\u7ed3\u6784\u4e0d\u6613\u6539\u53d8\uff0c\u96be\u4e8e\u9002\u5e94\u65b0\u9700\u6c42</li> <li>\u6839\u636e\u67d0\u94f6\u884c\u7684\u7edf\u8ba1\uff0c99%\u7684\u6570\u636e\u5e93 \u64cd\u4f5c\u4e3a\u8bfb\u6d41\u91cf</li> <li>\u57fa\u4e8e MIPS \u4ed8\u8d39\uff0c\u8bfb\u6d41\u91cf\u6210\u672c</li> </ul> <p>MongoDB \u9009\u578b\u8003\u91cf</p> <ul> <li>\u4f7f\u7528\u5b9e\u65f6\u540c\u6b65\u673a\u5236\uff0c\u5c06\u6570\u636e\u540c\u6b65\u51fa \u6765\u5230 MongoDB</li> <li>\u4f7f\u7528 MongoDB \u7684\u9ad8\u6027\u80fd\u67e5\u8be2\u80fd\u529b \u6765\u652f\u6491\u4e1a\u52a1\u7684\u8bfb\u64cd\u4f5c</li> <li>\u76f8\u6bd4\u4e8e\u5173\u7cfb\u6a21\u578b\u6570\u636e\u5e93\uff0c\u66f4\u52a0\u5bb9\u6613 \u8fc1\u5165\u6570\u636e\u5e76\u6784\u5efa\u6210 JSON \u6a21\u578b\u8fdb\u884c API \u670d\u52a1</li> </ul>"},{"location":"mongo2/16mon_sample/#_6","title":"\u5b9e\u65f6\u5206\u6790","text":"<p>\u573a\u666f\u7279\u70b9</p> <ul> <li>\u6d41\u6570\u636e\u8ba1\u7b97</li> <li>\u5feb\u901f\u8ba1\u7b97\uff0c\u79d2\u7ea7\u8fd4\u56de</li> </ul> <p>MongoDB \u9009\u578b\u8003\u91cf</p> <ul> <li>\u4f7f\u7528 MongoDB \u7f13\u5b58\u673a\u5236\uff0c\u53ef\u4ee5\u5229 \u7528\u5185\u5b58\u8ba1\u7b97\u52a0\u901f</li> <li>\u4f7f\u7528 MongoDB \u805a\u5408\u6846\u67b6\uff0c\u5b9e\u73b0\u5206 \u6790\u529f\u80fd</li> <li>\u4f7f\u7528\u5fae\u5206\u7247\u67b6\u6784\u7684\u5e76\u53d1\u8ba1\u7b97\u6765\u5927\u91cf \u7f29\u51cf\u8ba1\u7b97\u65f6\u95f4</li> </ul>"},{"location":"mongo2/16mon_sample/#_7","title":"\u5173\u7cfb\u578b\u6570\u636e\u5e93\u66ff\u6362","text":"<p>\u573a\u666f\u7279\u70b9</p> <ul> <li>\u57fa\u4e8e Oracle / MySQL/ SQLServer \u7684\u5386\u53f2\u5e94\u7528</li> <li>\u6570\u636e\u91cf\u589e\u957f\u6216\u8005\u4f7f\u7528\u8005\u53d8\u591a\u4ee5\u540e\u6027 \u80fd\u53d8\u6162</li> <li>\u5206\u5e93\u5206\u8868\u9700\u8981\u5e94\u7528\u914d\u5408</li> <li>\u7ed3\u6784\u6b7b\u677f\uff0c\u589e\u52a0\u65b0\u9700\u6c42\u590d\u6742\u56f0\u96be</li> </ul> <p>MongoDB \u9009\u578b\u8003\u91cf</p> <ul> <li>\u9ad8\u6027\u80fd\u9ad8\u5e76\u53d1\u7684\u6570\u636e\u5e93\u6027\u80fd</li> <li>\u65e0\u9700\u5e94\u7528\u5206\u5e93\u5206\u8868\uff0c\u96c6\u7fa4\u81ea\u52a8\u89e3\u51b3 \u6269\u5bb9\u95ee\u9898</li> <li>\u52a8\u6001\u6a21\u578b\u9002\u5408\u5feb\u901f\u5f00\u53d1</li> <li>\u5934\u6761/\u7f51\u6613/\u767e\u5ea6/\u4e1c\u822a/\u4e2d\u56fd\u94f6\u884c</li> </ul>"},{"location":"mongo2/16mon_sample/#mongodb_1","title":"MongoDB \u5178\u578b\u6848\u4f8b","text":""},{"location":"mongo2/16mon_sample/#360-500","title":"\u6848\u4f8b\u4e00:\u5ba2\u6237360 \u4e16\u754c500\u5f3a\u4fdd\u9669\u516c\u53f8","text":"<p>\u4e1a\u52a1\u9700\u6c42</p> <p>\u8de8\u56fd\u4fdd\u9669\u516c\u53f8\uff0c\u6765\u81ea60\u591a\u4e2a\u56fd\u5bb6\u7684 9000\u591a\u4e07\u7528\u6237\uff0c70\u591a\u5957\u4e1a\u52a1\u7cfb\u7edf\u3002\u5ba2 \u6237\u4fe1\u606f\u5206\u6563\u5728\u591a\u5957\u7cfb\u7edf\u91cc\uff0c\u5e0c\u671b\u6784\u5efa \u4e00\u4e2a\u5ba2\u6237360\u89c6\u56fe\u3002</p> <p>\u7b2c\u4e00\u9636\u6bb5\u652f\u6491\u5ba2\u670d\u90e8\u95e8\u66f4\u597d\u670d\u52a1\u5ba2\u6237\uff0c\u51cf\u5c11\u5ba2\u6237\u7b49\u5f85\u65f6\u95f4\u3002</p> <p>\u7b2c\u4e8c\u9636\u6bb5\u6784\u5efa\u5ba2\u6237\u7ba1\u7406\u624b\u673a App\uff0c\u81ea \u52a9\u7ba1\u7406\u6240\u6709\u4fdd\u5355\u3002</p> <p>\u4e3a\u4e86\u8fbe\u5230\u8fd9\u4e9b\u76ee\u7684\uff0c\u9700\u8981\u6574\u4e2a70+\u5386 \u53f2\u7cfb\u7edf\u4e2d\u7684\u5ba2\u6237\u4fe1\u606f\uff0c\u901a\u8fc7\u552f\u4e00\u5165\u53e3\u67e5\u8be2\u3002</p> <p></p> <p>\u4e1a\u52a1\u96be\u70b9</p> <ul> <li>\u6765\u81ea60\u591a\u4e2a\u56fd\u5bb6\u76849000\u591a\u4e07\u7528\u6237\uff0c\u6570\u636e\u91cf\u5927\u3002</li> <li>70\u591a\u5957\u4e0d\u540c\u7684\u4fdd\u9669\u4e1a\u52a1\u7cfb\u7edf\u7684\u6570\u636e\u9700\u8981\u6c47\u96c6\u5230\u4e00\u8d77\u3002</li> <li>\u5df2\u6709\u7cfb\u7edf\u5728\u4e0d\u65ad\u8fed\u4ee3\uff0c\u5bfc\u81f4\u6700\u7ec8\u6570\u636e\u6a21\u578b\u4e0d\u65ad\u53d8\u5316\u3002</li> <li>\u5173\u7cfb\u6570\u636e\u5e93\u7684\u7ed3\u6784\u53d8\u5316\u590d\u6742\u6027\u9ad8\uff0c\u6d41\u7a0b\u957f\uff0c\u5f80\u5f80\u4e00\u4e2a\u8fed\u4ee3\u672a\u5b8c\u6210\uff0c\u6e90\u5934\u7cfb\u7edf\u53c8\u53d8\u5316\u4e86\u3002</li> </ul> <p>\u5173\u7cfb\u578b vs MongoDB</p> <ul> <li>\u4f7f\u7528\u5173\u7cfb\u6570\u636e\u5e93\u7684\u5c1d\u8bd5:<ul> <li>\u5386\u65f62\u5e74</li> <li>\u524d\u540e\u5206\u522b\u4f7f\u75282\u4e2a\u4e0d\u540c\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0c</li> <li>\u4e24\u4e2a\u4e0d\u540c\u7684\u5382\u5546/\u56e2\u961f </li> <li>\u82b1\u8d39 $2500\u4e07\u7f8e\u5143</li> </ul> </li> </ul> <p>\u7ed3\u679c:\u5931\u8d25\uff0cschema \u592a\u590d\u6742\uff0c\u65e0\u6cd5\u6709\u6548\u7684 \u628a70\u5957\u7cfb\u7edf\u7684 schema \u878d\u5408\u6210\u4e00\u5957\u3002</p> <p>\u4f7f\u7528 MongoDB \u7684\u5c1d\u8bd5:</p> <ul> <li>\u52a8\u6001\u6570\u636e\u6a21\u578b\u8f7b\u677e\u63a5\u6536\u4e0d\u540c\u6570\u636e </li> <li>7x24\u5c0f\u65f6\u9ad8\u53ef\u7528</li> </ul> <p>\u7ed3\u679c:2\u4e2a\u661f\u671f\u505a\u539f\u578b\uff0c3\u4e2a\u6708\u4e0a\u7ebf\u3002</p> <p>MongoDB \u7684\u6570\u636e\u6a21\u578b</p> <p></p> <p></p> <p>\u4fdd\u5355: 13\u5f20\u5173\u8054\u8868 =&gt; 1\u5f20\u4fdd\u5355\u8868:\u8ba9\u5b58\u50a8\u3001\u67e5\u8be2\u53d8\u5f97\u66f4\u7b80\u5355\u548c\u7075\u6d3b\u3002</p> <p></p> <p>\u7cfb\u7edf\u67b6\u6784</p> <p></p> <p>\u7cfb\u7edf\u67b6\u6784</p> <p></p> <p>\u6848\u4f8b\u5c0f\u7ed3</p> <p>\u6b64\u6848\u4f8b\u5229\u7528\u4e86 MongoDB \u7684\u4ee5\u4e0b\u7279\u6027:</p> <ul> <li>\u53cd\u8303\u5f0f\u7684\u6570\u636e\u6a21\u578b\u4f7f\u5f97\u590d\u6742\u6570\u636e\u6574\u5408\u6210\u4e3a\u53ef\u80fd</li> <li>\u9ad8\u53ef\u7528(\u672c\u5730\u548c\u8de8\u673a\u623f)<ul> <li>\u6545\u969c\u53d1\u751f\u65f6\u5e94\u7528\u53ef\u4ee5\u81ea\u52a8\u5207\u6362\u5230\u6b63\u5e38\u7684\u8282\u70b9\u4e0a</li> <li>\u53ef\u4ee5\u5728\u79d2\u7ea7\u65f6\u95f4\u5185\u5b8c\u6210\u6545\u969c\u8f6c\u79fb\uff0c\u4f7f\u5f97\u7528\u6237\u4f53\u9a8c\u5f97\u5230\u4fdd\u8bc1</li> </ul> </li> </ul> <p>\u56e0\u4e3a\u8fd9\u4e9b\u7279\u6027\u7684\u5b58\u5728\uff0c\u4f7f\u5f97\u9879\u76ee\u6210\u529f\u3002</p>"},{"location":"mongo2/16mon_sample/#_8","title":"\u6848\u4f8b\u4e8c:\u4e3b\u673a\u5206\u6d41(\u4e3b\u673a\u4e0b\u884c)\u56fd\u5185\u56db\u5927\u884c\u4e4b\u4e00","text":"<p>\u4e1a\u52a1\u9700\u6c42</p> <p>\u4e3a\u63d0\u5347\u7528\u6237\u4f53\u9a8c\uff0c\u8be5\u94f6\u884c\u8981\u5728\u624b\u673a\u94f6\u884cAPP\u4e2d\u652f\u6301\u5b9e\u65f6\u8d26\u6237\u4ea4\u6613\u5386\u53f2\u67e5\u8be2\u3002\u6d89\u53ca\u7684\u6570\u636e\u5305\u62ec:</p> <ul> <li>\u501f\u8bb0\u5361\u4ea4\u6613\u5386\u53f2\u3002</li> <li>\u4fe1\u7528\u5361\u4ea4\u6613\u5386\u53f2\u3002</li> <li>\u540e\u7eed\u8fd8\u5c06\u652f\u6301\u80a1\u7968\u3001\u57fa\u91d1\u8d26\u6237\u7b49\u3002</li> </ul> <p>\u5bf9\u8fd9\u4e9b\u4ea4\u6613\u5386\u53f2\u8fdb\u884c\u6574\u5408\uff0c\u4f7f\u7528\u6237\u53ef\u4ee5\u770b\u5230\u81ea\u5df1\u8d26\u6237\u7684\u4ea4\u6613\u5386\u53f2\u5168\u8c8c\u3002\u6d89\u53ca\u7684\u4ea4\u6613\u6570\u636e \u91cf:</p> <ul> <li>\u7ea66000\u4e07\u4ea4\u6613\u6570\u636e/\u5929\uff0c\u7ed3\u606f\u65e5\u8fbe\u5230~5\u4ebf/\u5929\u3002</li> <li>\u5386\u53f2\u5b58\u91cf\u6570\u636e3\u5e74\uff0c\u8d85\u8fc7600\u4ebf\u3002</li> <li>\u6838\u5fc3\u7cfb\u7edf(\u4e3b\u673a)\u652f\u6301\u8fd9\u6837\u7684\u6d41\u91cf\u975e\u5e38\u56f0\u96be\uff0c\u6210\u672c\u592a\u9ad8\u3002</li> </ul> <p>\u65b9\u6848\u9009\u62e9:\u4e3b\u673a\u5206\u6d41</p> <p>\u5173\u7cfb\u578b\u6570\u636e\u5e93:</p> <ul> <li>\u8d85\u5927\u91cf\u6570\u636e\u9700\u8981\u5de8\u5927\u6570\u91cf\u7684 DB \u5b9e\u4f8b\u3002 </li> <li>\u8003\u8651\u9ad8\u53ef\u7528\uff0c\u6210\u672c\u6781\u9ad8\u3002</li> <li>\u5206\u5e93\u5206\u8868\u9020\u6210\u5f00\u53d1\u96be\u5ea6\u5927\u5e45\u4e0a\u5347\u3002</li> <li>\u6574\u5408\u4e0d\u540c\u8d26\u6237\u6570\u636e\u65f6\u8868\u7ed3\u6784\u5dee\u5f02\u5927\uff0c\u5408\u5e76\u56f0\u96be\u3002</li> </ul> <p>\u7ed3\u679c:\u8bc4\u5ba1\u671f\u88ab\u5426\u5b9a</p> <p>\u4f7f\u7528 MongoDB \u7684\u5c1d\u8bd5:</p> <ul> <li>\u52a8\u6001\u6570\u636e\u6a21\u578b\u8f7b\u677e\u63a5\u6536\u4e0d\u540c\u6570\u636e\u3002 </li> <li>\u6c34\u5e73\u6269\u5c55\u89e3\u51b3\u5927\u6570\u636e\u91cf\u95ee\u9898\u3002</li> <li>7x24\u5c0f\u65f6\u53ef\u7528</li> </ul> <p>\u7ed3\u679c:\u6210\u529f\u4e0a\u7ebf</p> <p>\u7cfb\u7edf\u67b6\u6784</p> <p></p> <p>\u6848\u4f8b\u5c0f\u7ed3</p> <p>\u4e3b\u673a\u5206\u6d41\u67b6\u6784\u7279\u70b9:</p> <ul> <li>\u5904\u7406\u63a5\u8fd1\u6bcf\u79d21\u4e07\u7684\u4ea4\u6613\u6570\u636e </li> <li>\u603b\u91cf\u6570\u767e\u4ebf</li> <li>\u67e5\u8be2\u5e73\u5747\u6027\u80fd\u6570\u6beb\u79d2</li> </ul> <p>\u672c\u6848\u4f8b\u4e2d\u5229\u7528\u4e86 MongoDB \u7684\u4ee5\u4e0b\u7279\u6027:</p> <ul> <li>\u7075\u6d3b\u6570\u636e\u6a21\u578b:\u4f7f\u6570\u636e\u6574\u5408\u66f4\u4e3a\u5bb9\u6613</li> <li>\u5f39\u6027\u6269\u5c55:\u4f7f\u5f97\u6d77\u91cf\u6570\u636e + \u4f4e\u5ef6\u8fdf\u67e5\u8be2\u6210\u4e3a\u53ef\u80fd</li> </ul>"},{"location":"mongo2/16mon_sample/#mysql","title":"\u6848\u4f8b\u4e09:MySQL \u8fc1\u79fb\u9876\u7ea7\u4e92\u8054\u7f51\u516c\u53f8","text":"<p>\u4e1a\u52a1\u573a\u666f</p> <ul> <li>\u65d7\u4e0b\u591a\u4e2a App</li> <li>DAU7\u4ebf</li> <li>42\u4e07+\u670d\u52a1\u5668</li> <li>\u6bcf\u5929\u65b0\u589e30PB\u6570\u636e(\u5305\u542b\u975e\u7ed3\u6784\u5316)</li> <li>\u6bcf\u65e5\u7ebf\u4e0a\u53d8\u66f4 6000+</li> <li>\u6807\u51c6\u6570\u636e\u65b9\u6848<ul> <li>MySQL + Redis + \u5bf9\u8c61\u5b58\u50a8</li> </ul> </li> <li>\u7ed3\u6784\u5316\u548c\u534a\u7ed3\u6784\u5316\u5728MySQL </li> <li>MySQL: \u6570\u4e07\u53f0\u670d\u52a1\u5668</li> </ul> <p>\u75db\u70b9</p> <ul> <li>\u6570\u636e\u5e93\u53d8\u66f4\u9700\u8981\u56e2\u961f\u914d\u5408\uff0c\u5bf96000+/\u5929\u7684\u9891\u7e41\u53d8\u66f4\u9020\u6210\u5f88\u5927\u963b\u788d </li> <li>MySQL \u96c6\u7fa4\u672c\u8eab\u6269\u5bb9\u6bd4\u8f83\u56f0\u96be</li> <li>\u4e2d\u95f4\u4ef6\u7684\u7ea6\u675f\u8f83\u591a</li> <li>\u8fed\u4ee3\u901f\u5ea6\u53d7\u5f71\u54cd</li> </ul> <p>\u65b0\u7684\u65b9\u5411</p> <ul> <li>MongoDB \u65e0\u987b\u4e2d\u95f4\u4ef6\uff0c\u6539\u5584\u53d8\u66f4\u6548\u7387 </li> <li>\u96c6\u7fa4\u6269\u5bb9\u5bb9\u6613</li> <li>\u7ed3\u6784\u7075\u6d3b\uff0c\u8fed\u4ee3\u5feb</li> </ul> <p>MongoDB \u4e1a\u52a1\u573a\u666f</p> <ul> <li> <p>\u5728\u7ebf TP \u4e1a\u52a1</p> <ul> <li>\u6570\u636e\u6a21\u578b\u591a\u53d8\uff0c\u65b0\u589e collection \u6bd4\u8f83\u5e38\u89c1</li> <li>\u4f4e\u65f6\u5ef6\u548c\u5c11\u6bdb\u523a</li> <li>\u8bf7\u6c42\u91cf\u5927</li> </ul> </li> <li> <p>\u4e2d\u53f0\u5143\u6570\u636e\u7ba1\u7406</p> <ul> <li>\u4e2d\u53f0\u7cfb\u7edf\uff0cschema \u9700\u8981\u5f88\u591a\u5d4c \u5165\u5f0f\u6587\u6863</li> <li>\u6570\u636e\u91cf\u5927\uff0c\u70b9\u67e5\u4e3a\u4e3b</li> </ul> </li> <li> <p>LBS \u5730\u7406\u4f4d\u7f6e</p> <ul> <li>\u8ba1\u7b97\u5bc6\u96c6\uff0c\u6570\u636e\u70b9\u5c0f\uff0c\u4f46\u662f\u91cf\u5927 </li> <li>\u5199\u5165\u66f4\u65b0\u5f02\u5e38\u9891\u7e41</li> </ul> </li> <li> <p>\u6e38\u620f</p> <ul> <li>\u6e38\u620f\u65e5\u5fd7\u5199\u5165\u91cf\u5927\uff0c\u67e5\u8be2\u91cf\u4e00\u822c </li> <li>\u5728\u7ebf\u5206\u6790\u9700\u6c42</li> </ul> </li> </ul>"},{"location":"mongo2/16mon_sample/#_9","title":"\u6848\u4f8b\u56db:\u6d77\u91cf\u6570\u636e\u5b58\u50a8\u9876\u7ea7\u4e92\u8054\u7f51\u516c\u53f8","text":"<p>\u4ebf\u7ea7\u7528\u6237\u7f51\u76d8\u5e94\u7528</p> <ul> <li> <p>\u6311\u6218</p> <ul> <li>\u7f51\u76d8\u901a\u8baf\u5f55\uff0c\u77ed\u4fe1\u5b58\u50a8\u7ba1\u7406 </li> <li>\u7f51\u76d8\u6587\u4ef6\u5143\u6570\u636e\u7ba1\u7406 </li> <li>\u7528\u6237\u64cd\u4f5c\u65e5\u5fd7</li> <li>\u6570\u4ebf\u7528\u6237\u4f53\u91cf </li> <li>MySQL\u96c6\u7fa4\u65e0\u6cd5\u652f\u6491\u6027\u80fd\u7684\u8bc9\u6c42</li> </ul> </li> <li> <p>\u89e3\u51b3\u65b9\u6848</p> <ul> <li>\u8fc1\u79fb\u5230MongoDB\u5206\u7247\u96c6\u7fa4 </li> <li>\u5feb\u901f\u589e\u957f\u65f6\u671f\u6bcf\u4e09\u4e2a\u6708\u6269\u5bb9\u4e00\u6b21</li> <li>\u7cfb\u7edf2012\u5e74\u4e0a\u7ebf\u8fd0\u884c\u81f3\u4eca </li> <li>\u6709\u529b\u652f\u6491\u4e1a\u52a1\u7684\u6301\u7eed\u53d1\u5c55\uff0c\u76ee\u524d\u652f\u6491100\u591a\u4e2a\u4e1a\u52a1 </li> <li>2PB+ \u7684\u6570\u636e\u5b58\u50a8\u91cf</li> <li>100\u591a\u4e2a\u5206\u7247</li> </ul> </li> </ul> <p>\u6280\u672f\u67b6\u6784</p> <p></p> <p>\u67b6\u6784\u7279\u70b9</p> <ul> <li>\u5206\u7247\u96c6\u7fa4</li> <li>\u7247\u952e:userid</li> <li>\u5e76\u53d15000/s/\u8282\u70b9</li> <li>\u901a\u8fc7\u81ea\u5efaproxy\u9650\u6d41</li> </ul> <p>\u786c\u4ef6\u89c4\u8303:</p> <ul> <li>CPU: 8 Core</li> <li>RAM: 48G</li> <li>Storage: 2T SSD, RAID 0</li> </ul>"},{"location":"mongo2/17mon_dms/","title":"17 \u6570\u636e\u8fc1\u79fb","text":""},{"location":"mongo2/17mon_dms/#1","title":"1 \u5173\u7cfb\u578b\u6570\u636e\u5e93\u8fc1\u79fb","text":""},{"location":"mongo2/17mon_dms/#mongodb","title":"\u4ece\u57fa\u4e8e\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5e94\u7528\u8fc1\u79fb\u5230 MongoDB \u7684\u7406\u7531","text":"<ul> <li>\u9ad8\u5e76\u53d1\u9700\u6c42 (\u6570\u5343 \u2013 \u6570\u5341\u4e07 ops) \uff0c\u5173\u7cfb\u578b\u6570\u636e\u5e93\u4e0d\u5bb9\u6613\u6269\u5c55</li> <li>\u5feb\u901f\u8fed\u4ee3 \u2013 \u5173\u7cfb\u578b\u6a21\u5f0f\u592a\u4e25\u8c28</li> <li>\u7075\u6d3b\u7684 JSON \u6a21\u5f0f</li> <li>\u5927\u6570\u636e\u91cf\u9700\u6c42</li> <li>\u5730\u7406\u4f4d\u7f6e\u67e5\u8be2</li> <li>\u591a\u6570\u636e\u4e2d\u5fc3\u8de8\u5730\u57df\u90e8\u7f72</li> </ul>"},{"location":"mongo2/17mon_dms/#_1","title":"\u5e94\u7528\u8fc1\u79fb\u96be\u5ea6","text":"<p>\u5173\u7cfb\u578b\u5230\u5173\u7cfb\u578b \u2013 \u76f8\u5bf9\u7b80\u5355</p> <ul> <li>Oracle -&gt; MySQL, Oracle \u2013 PostgreSQL</li> </ul> <p>\u5173\u7cfb\u578b\u5230\u6587\u6863\u578b \u2013 \u76f8\u5bf9\u590d\u6742</p> <ul> <li>Oracle -&gt; MongoDB</li> </ul> <p>\u9700\u8981\u8003\u8651:</p> <ul> <li>\u603b\u4f53\u67b6\u6784 (\u4ece\u5355\u4f53\u5f0f\u5230\u5206\u5e03\u5f0f)</li> <li>\u6a21\u5f0f\u8bbe\u8ba1(\u4ece\u5173\u7cfb\u6a21\u578b\u5230\u6587\u6863\u6a21\u578b)</li> <li>SQL\u8bed\u53e5/\u5b58\u50a8\u8fc7\u7a0b/JDBC/ORM</li> <li>\u6570\u636e\u8fc1\u79fb (\u5982\u4f55\u5904\u7406\u5df2\u6709\u6570\u636e?)</li> </ul>"},{"location":"mongo2/17mon_dms/#_2","title":"\u603b\u4f53\u67b6\u6784","text":"<p>\u4ece\u5355\u4f53\u5230\u5206\u5e03\u5f0f\uff0c\u9700\u8981\u8003\u8651:</p> <ul> <li>3x \u7684\u8ba1\u7b97\u8d44\u6e90</li> <li>3x \u7684\u5b58\u50a8\u8d44\u6e90 </li> <li>\u7f51\u7edc</li> </ul> <p></p> <p>\u6a21\u5f0f\u8bbe\u8ba1</p> <p>\u9488\u5bf9\u5df2\u6709\u5173\u7cfb\u6a21\u578b\uff0c\u8003\u8651\u5982\u4f55\u7528\u6587\u6863\u6a21\u578b\u8fdb\u884c\u8bbe\u8ba1</p> <p></p>"},{"location":"mongo2/17mon_dms/#_3","title":"\u8fc1\u79fb\u7684\u4e3b\u6218\u573a","text":"<ul> <li> <p>RDBMS</p> <ul> <li>\u5b58\u50a8\u8fc7\u7a0b</li> <li>\u8fd0\u7ef4\u5de5\u5177\u3001\u811a\u672c</li> <li>\u6743\u9650\u8bbe\u7f6e</li> <li>\u6570\u636e\u5e93\u76d1\u63a7\u5907\u4efd\u53ca\u6062\u590d</li> </ul> </li> <li> <p>Storage Layer</p> <ul> <li>\u5178\u578b\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u90e8\u7f72\u5728 SAN \u4e0a MongoDB\u652f\u6301 SAN, \u4f46\u662f\u4f7f\u7528\u672c\u5730\u5b58\u50a8 </li> <li>\u53ef\u4ee5\u6700\u5927\u5316\u7684\u63d0\u9ad8\u6027\u80fd</li> </ul> </li> <li> <p>JDBC</p> <ul> <li>MongoDB \u6ca1\u6709\u539f\u751f\u6001 JDBC, \u800c \u662f\u91c7\u7528\u81ea\u5e26\u7684\u9a71\u52a8\u7a0b\u5e8f:<ul> <li>\u81ea\u5e26\u8fde\u63a5\u6c60\u7ba1\u7406</li> <li>\u4e8b\u52a1\u652f\u6301</li> </ul> </li> </ul> </li> <li> <p>SQL</p> <ul> <li>MongoDB \u4e0d\u652f\u6301SQL\u7684\u589e\u5220\u6539\uff0c\u7ed3\u679c\u96c6\u4e5f\u4e0d\u662f ResultSet</li> </ul> </li> <li> <p>ORM</p> <ul> <li>ORM: Object Relational Mapping \u8f6c\u6362\u5173\u7cfb\u578b\u5230POJO\u5bf9\u8c61\u6a21\u578b</li> <li>\u4e0d\u9700\u8981\uff0c\u4f46\u662f\u53ef\u4ee5\u6709ODM</li> <li>ODM:Object Document Model<ul> <li>Spring Data</li> <li>mongoose</li> </ul> </li> </ul> </li> </ul>"},{"location":"mongo2/17mon_dms/#_4","title":"\u6570\u636e\u8fc1\u79fb","text":"<p>\u8fc1\u79fb\u65f6\u5e94\u7528\u5f80\u5f80\u5df2\u7ecf\u4e0a\u7ebf\u76f8\u5f53\u957f\u4e00\u6bb5\u65f6\u95f4\uff0c\u5982\u4f55\u8fc1\u79fb\u8fd9\u4e9b\u6570\u636e\u5230 MongoDB?</p> <ul> <li>\u6570\u636e\u5e93\u5bfc\u51fa+\u5bfc\u5165</li> <li>\u6279\u91cf\u8fc1\u79fb\u5de5\u5177</li> <li>\u5b9e\u65f6\u540c\u6b65\u5de5\u5177</li> <li>\u5e94\u7528\u4e3b\u5bfc\u8fc1\u79fb</li> </ul>"},{"location":"mongo2/17mon_dms/#2","title":"2 \u6570\u636e\u8fc1\u79fb\u65b9\u5f0f\u53ca\u5de5\u5177","text":""},{"location":"mongo2/17mon_dms/#_5","title":"\u6570\u636e\u8fc1\u79fb","text":"<p>\u5982\u4f55\u8fc1\u79fb\u5df2\u6709\u6570\u636e\u5230 MongoDB?</p> <p></p> <p>1. \u6570\u636e\u5e93\u5bfc\u51fa\u5bfc\u5165</p> <p>\u6b65\u9aa4:</p> <ul> <li>\u505c\u6b62\u73b0\u6709\u7684\u57fa\u4e8e RDBMS \u7684\u5e94\u7528</li> <li>\u4f7f\u7528 RDBMS \u7684\u6570\u636e\u5e93\u5bfc\u51fa\u5de5\u5177\uff0c\u5c06\u6570\u636e\u5e93\u8868\u5bfc\u51fa\u5230 CSV \u6216\u8005 JSON(\u5982 mysqldump)</li> <li>\u4f7f\u7528 mongoimport \u5c06 CSV \u6216\u8005 JSON \u6587\u4ef6\u5bfc\u5165 MongoDB \u6570\u636e\u5e93</li> <li>\u542f\u52a8\u65b0\u7684 MongoDB \u5e94\u7528</li> </ul> <p>\u5907\u6ce8:</p> <ul> <li>\u9002\u7528\u4e8e\u4e00\u6b21\u6027\u6570\u636e\u8fc1\u79fb</li> <li>\u9700\u8981\u5e94\u7528/\u6570\u636e\u5e93\u4e0b\u7ebf\uff0c\u8f83\u957f\u7684\u4e0b\u7ebf\u65f6\u95f4</li> </ul> <p>\u6570\u636e\u5e93\u5bfc\u51fa\u5bfc\u5165: <code>mysql - mongo</code></p> <p></p> <p><code>mysqldump</code></p> <pre><code>mysqldump -hdemodb.tapdata.net -uroot -p inventory -T /var/lib/mysql-files\n</code></pre> <p><code>-T</code>  excel :</p> <p></p> <pre><code># cat customers.txt\n\n\"1001\",\"Sally\",\"Thomas\",\"sally.thomas@acme.com\" \n\"1002\",\"George\",\"Bailey\",gbailey@foobar.com\n...\n</code></pre> <pre><code># mongoimport -d xxx -c customers --type=csv --headerline customers.txt \n# mongoimport -d xxx -c products --type=csv --headerline products.txt \n# mongoimport -d xxx -c orders --type=csv --headerline orders.txt\n</code></pre> <ul> <li><code>mongoimport -d SparkDemo -c customers --type=csv --headerline customers.txt</code></li> <li><code>mongoimport -d SparkDemo -c orders --type=csv --headerline orders.txt</code></li> <li><code>mongoimport -d SparkDemo -c products --type=csv --headerline products.txt</code></li> </ul>"},{"location":"mongo2/17mon_dms/#2_1","title":"2. \u6279\u91cf\u540c\u6b65","text":"<p>\u6b65\u9aa4:</p> <ul> <li>\u5b89\u88c5\u540c\u6b65\u5de5\u5177(\u5982 Kettle / Talend)</li> <li>\u521b\u5efa\u8f93\u5165\u6e90(\u5173\u7cfb\u578b\u6570\u636e\u5e93)</li> <li>\u521b\u5efa\u8f93\u51fa\u6e90(MongoDB)</li> <li>\u7f16\u8f91\u6570\u636e\u540c\u6b65\u4efb\u52a1</li> <li>\u6267\u884c</li> </ul> <p>\u5907\u6ce8:</p> <ul> <li>\u9002\u7528\u6279\u91cf\u540c\u6b65\uff0c\u5b9a\u671f\u66f4\u65b0, \u7279\u522b\u662f\u6bcf\u665a\u8dd1\u6279\u7684\u573a\u666f</li> <li>\u652f\u6301\u57fa\u4e8e\u65f6\u95f4\u6233\u7684\u589e\u91cf\u540c\u6b65\uff0c\u9700\u8981\u6e90\u8868\u6709\u5408\u9002\u7684\u65f6\u95f4\u6233\u652f\u6301</li> <li>\u5bf9\u6e90\u5e93\u6709\u8f83\u660e\u663e\u7684\u6027\u80fd\u5f71\u54cd\uff0c\u4e0d\u5b9c\u9891\u7e41\u67e5\u8be2</li> <li>\u4e0d\u652f\u6301\u5b9e\u65f6\u540c\u6b65</li> </ul> <p></p>"},{"location":"mongo2/17mon_dms/#3","title":"3. \u5b9e\u65f6\u540c\u6b65","text":"<p>\u6b65\u9aa4</p> <ul> <li>\u5b89\u88c5\u5b9e\u65f6\u540c\u6b65\u5de5\u5177(\u5982Informatica / Tapdata)</li> <li>\u521b\u5efa\u8f93\u5165\u6e90(\u5173\u7cfb\u578b\u6570\u636e\u5e93)</li> <li>\u521b\u5efa\u8f93\u51fa\u6e90(MongoDB)</li> <li>\u7f16\u8f91\u5b9e\u65f6\u6570\u636e\u540c\u6b65\u4efb\u52a1</li> <li>\u6267\u884c</li> </ul> <p>\u5907\u6ce8:</p> <ul> <li>\u57fa\u4e8e\u6e90\u5e93\u7684\u65e5\u5fd7\u6587\u4ef6\u89e3\u6790\u673a\u5236\uff0c\u53ef\u4ee5\u5b9e\u73b0\u79d2\u7ea7\u6570\u636e\u7684\u540c\u6b65 </li> <li>\u5bf9\u6e90\u5e93\u6027\u80fd\u5f71\u54cd\u8f83\u5c0f</li> <li>\u53ef\u4ee5\u652f\u6301\u5e94\u7528\u7684\u65e0\u7f1d\u8fc1\u79fb</li> </ul> <p></p>"},{"location":"mongo2/17mon_dms/#4","title":"4. \u5e94\u7528\u4e3b\u5bfc\u8fc1\u79fb","text":"<p>\u6b65\u9aa4</p> <ol> <li>\u5347\u7ea7\u5df2\u6709\u5e94\u7528\u652f\u6301 MongoDB</li> <li>\u6570\u636e\u63d2\u5165\u8bf7\u6c42\u76f4\u63a5\u8fdb\u5165 MongoDB</li> <li>\u6570\u636e\u67e5\u8be2\u548c\u66f4\u65b0\u8bf7\u6c42\u9996\u5148\u5b9a\u5411\u5230 MongoDB</li> <li>\u5982\u679c\u8bb0\u5f55\u4e0d\u5b58\u5728\uff0c\u4ece RDBMS \u8bfb\u51fa\u6765\u5e76\u5199\u5165\u5230 MongoDB</li> <li>\u91cd\u590d\u6b65\u9aa43</li> <li>\u5f53\u6b65\u9aa44\u5728\u9650\u5b9a\u65f6\u95f4\u6bb5(\u4e00\u661f\u671f\u3001\u4e00\u4e2a\u6708)\u6ca1\u6709\u88ab\u8c03\u7528\uff0c\u8ba4\u4e3a\u8fc1\u79fb\u5b8c\u6210</li> </ol> <p>\u5907\u6ce8:</p> <ul> <li>\u9700\u8981\u7814\u53d1\u56e2\u961f\u914d\u5408 \uff0c\u6709\u4e00\u5b9a\u5f00\u53d1\u548c\u6d4b\u8bd5\u91cf</li> <li>\u4e3a\u4fdd\u8bc1\u4e0d\u9057\u6f0f\u6570\u636e\uff0c\u4ecd\u7136\u5148\u8981\u6267\u884c\u4e00\u6b21\u6279\u91cf\u540c\u6b65</li> </ul> <p></p>"},{"location":"mongo2/17mon_dms/#5","title":"5 \u6570\u636e\u8fc1\u79fb\u65b9\u5f0f\u6bd4\u8f83","text":""},{"location":"mongo2/17mon_dms/#3-oracle","title":"3 Oracle \u8fc1\u79fb\u5b9e\u6218","text":""},{"location":"mongo2/17mon_dms/#_6","title":"\u6d4b\u8bd5\u73af\u5883","text":""},{"location":"mongo2/17mon_dms/#_7","title":"\u6b65\u9aa4","text":"<ol> <li>\u6bd4\u8f83 Oracle \u5173\u7cfb\u6a21\u578b\u548c\u76ee\u6807 JSON \u6570\u636e\u6a21\u578b</li> <li>\u6ce8\u518c&amp;\u4e0b\u8f7d Tapdata Agent</li> <li>\u521b\u5efa Oracle \u8fde\u63a5 \u548c MongoDB \u8fde\u63a5</li> <li>\u6a21\u578b\u8f6c\u6362\u8bbe\u8ba1\u548c\u540c\u6b65\u4efb\u52a1\u7f16\u8f91</li> <li>\u8fd0\u884c\u4efb\u52a1</li> <li>\u68c0\u67e5\u7ed3\u679c</li> </ol>"},{"location":"mongo2/17mon_dms/#1-oracle-json","title":"1. Oracle \u5173\u7cfb\u6a21\u578b -&gt; \u76ee\u6807 JSON \u6a21\u578b","text":""},{"location":"mongo2/17mon_dms/#2-tapdata-agent","title":"2. \u6ce8\u518c\u4e0b\u8f7d Tapdata Agent","text":"<ul> <li>http://cloud.tapdata.net</li> <li>\u6ce8\u518c\u514d\u8d39\u8d26\u53f7</li> <li>\u4e0b\u8f7d\u5ba2\u6237\u7aef</li> <li>\u652f\u6301\u6570\u636e\u5e93:MongoDB, Oracle, MySQL , SQLServer, DB2, PostgreSQL, GaussDB, GBase</li> <li>\u79d2\u7ea7\u540c\u6b65\uff0c\u591a\u8868\u5408\u4e00\u80fd\u529b</li> </ul>"},{"location":"mongo2/17mon_dms/#3-demo","title":"3. DEMO","text":"<ul> <li>\u521b\u5efa Oracle \u8fde\u63a5 \u548c MongoDB \u8fde\u63a5 </li> <li>\u6a21\u578b\u8f6c\u6362\u8bbe\u8ba1\u548c\u540c\u6b65\u4efb\u52a1\u7f16\u8f91</li> <li>\u8fd0\u884c\u4efb\u52a1</li> <li>\u68c0\u67e5\u7ed3\u679c</li> </ul> <p><code>cat application.yml</code></p> <p></p> <p></p> <p>Make sure agent is running</p> <p></p> <p>Make sure transform and connector is running</p> <p></p> <p>Add source and destination</p> <p></p> <p></p> <p></p> <p>Start Transformation</p> <p></p>"},{"location":"mongo2/18mon_spark/","title":"18 MongoDB + Spark\u5b9e\u6218","text":""},{"location":"mongo2/18mon_spark/#1-mongodb-spark","title":"1 MongoDB + Spark","text":""},{"location":"mongo2/18mon_spark/#spark","title":"\u4ec0\u4e48\u662f Spark ?","text":"<p>\u6211\u80fd\u7528\u5b83\u505a\u4ec0\u4e48?</p> <p>\u4e2a\u6027\u5316    \u4ea7\u54c1\u63a8\u8350   \u6d41\u5904\u7406   \u5546\u4e1a\u667a\u80fd</p>"},{"location":"mongo2/18mon_spark/#spark_1","title":"Spark \u751f\u6001\u7cfb\u7edf","text":""},{"location":"mongo2/18mon_spark/#hdfs-vs-mongodb","title":"HDFS vs. MongoDB","text":"<p>\u4e00\u4e2a\u65e5\u5fd7\u7684\u4f8b\u5b50</p> <p></p>"},{"location":"mongo2/18mon_spark/#spark-connector","title":"Spark Connector","text":"<p>\u8ba9 Spark \u8fde\u63a5 MongoDB \u975e\u5e38\u7b80\u5355\uff0c\u4f7f\u7528 Spark Connector\u3002 \u5f00\u53d1\u8005:MongoDB \u516c\u53f8</p> <p>https://github.com/mongodb/mongo-spark</p> <p></p>"},{"location":"mongo2/18mon_spark/#spark-mongodb","title":"Spark + MongoDB \u67b6\u6784","text":""},{"location":"mongo2/18mon_spark/#spark-mongodb_1","title":"Spark + MongoDB \u8fd0\u4ef7\u8ba1\u7b97\u53ca\u67e5\u8be2\u6848\u4f8b","text":""},{"location":"mongo2/18mon_spark/#_1","title":"\u5904\u7406\u80fd\u529b\u548c\u54cd\u5e94\u65f6\u95f4\u6bd4\u8f83","text":""},{"location":"mongo2/18mon_spark/#2-mongodb-spark","title":"2 MongoDB + Spark \u8fde\u63a5\u5b9e\u6218","text":"<p>\u573a\u666f</p> <p>\u5047\u8bbe\u6211\u4eec\u6709\u4ee5\u4e0b\u6570\u636e:</p> <ul> <li>name: \u7528\u6237\u540d;</li> <li>address: \u4f4f\u5740;</li> <li>birthday: \u51fa\u751f\u65e5\u671f;</li> <li>favouriteColor: \u6700\u559c\u6b22\u7684\u989c\u8272;</li> </ul> <p>\u6211\u4eec\u60f3\u6309\u7167\u6708\u4efd\u7edf\u8ba1\u6bcf\u4e2a\u6708\u51fa\u751f\u7684\u4eba\u4e2d\uff0c\u559c\u6b22\u7684\u4eba\u6570\u6700\u591a\u7684\u989c\u8272\u662f\u4ec0\u4e48\u3002</p> <p>\u9009\u62e9\u5408\u9002\u7684\u7248\u672c</p> <p>Spark Connector \u8981\u6c42\u4f7f\u7528\u7684 MongoDB\u4e3a2.6 \u4ee5\u4e0a\u3002\u4e3a\u4e86\u5728\u4f7f\u7528\u8fc7\u7a0b\u4e2d\u4e0d\u51fa\u73b0\u517c\u5bb9\u6027 \u95ee\u9898\uff0c\u8bf7\u6309\u7167\u4ee5\u4e0b\u7248\u672c\u5bf9\u5e94\u5173\u7cfb\u4f7f\u7528(\u66f4\u591a\u8be6\u60c5\u8bf7\u53c2\u8003\u6587\u6863)</p> <p></p>"},{"location":"mongo2/18mon_spark/#_2","title":"\u73af\u5883\u914d\u7f6e","text":"<ul> <li>JDK8: https://www.oracle.com/technetwork/java/javase/downloads/jdk8- downloads-2133151.html</li> <li>Maven3: http://maven.apache.org/install.html</li> </ul> <p>\u73af\u5883\u914d\u7f6e</p> <p>\u914d\u7f6e\u6587\u4ef6: <code>/src/main/resources/config.properties</code></p> <ul> <li>input: \u7528\u4e8e\u8ba1\u7b97\u7684\u6e90 MongoDB \u96c6\u5408;</li> <li>output: \u8ba1\u7b97\u540e\u7528\u4e8e\u5b58\u50a8\u8f93\u51fa\u7ed3\u679c\u7684\u96c6\u5408;</li> </ul> <p>\u7f16\u8bd1\u8fd0\u884c:</p> <pre><code>mvn install\nmvn package\njava -jar target/SparkConnectorDemo-1.0-SNAPSHOT-jar-with-dependencies.jar\n</code></pre>"},{"location":"mongo2/18mon_spark/#_3","title":"\u57fa\u672c\u914d\u7f6e","text":"<p>https://github.com/geektime-geekbang/geektime-mongodb-course/tree/master/spark-demo</p> <ul> <li>https://github.com/geektime-geekbang/geektime-mongodb-course/blob/master/spark-demo/src/main/resources/config.properties</li> </ul> <pre><code>input=mongodb://127.0.0.1/SparkDemo.User\noutput=mongodb://127.0.0.1/SparkDemo.FavouriteColorStat\n</code></pre> <ul> <li>https://github.com/geektime-geekbang/geektime-mongodb-course/blob/master/spark-demo/src/main/java/org/geekbang/time/spark/SparkDemo.java</li> </ul>"},{"location":"mongo2/18mon_spark/#_4","title":"\u57fa\u672c\u914d\u7f6e","text":"<pre><code>SparkSession spark = SparkSession.builder() \n    .master(\"local\")\n    .appName(\"MongoSparkConnectorIntro\") \n    .config(\"spark.mongodb.input.uri\", \"mongodb://127.0.0.1/demo.Person\") \n    .config(\"spark.mongodb.output.uri\", \"mongodb://127.0.0.1/demo.Output\") \n    .getOrCreate();\nJavaSparkContext jsc = new JavaSparkContext(spark.sparkContext());\n</code></pre> <ul> <li>master: \u6307\u5b9a Spark \u7684 Master \u8282\u70b9\u5730\u5740\u3002\u6ca1\u6709\u72ec\u7acb Spark \u96c6\u7fa4\u7684\u65f6\u5019\u53ef\u4ee5\u6307\u5b9a\u4e3a local(\u4ec5\u7528 \u4e8e\u6d4b\u8bd5\u76ee\u7684);</li> <li><code>spark.mongodb.input.uri</code>: \u6765\u6e90 MongoDB \u8fde\u63a5\u5b57\u7b26\u4e32<ul> <li>demo: \u6765\u6e90\u6570\u636e\u5e93\u540d;</li> <li>Persion: \u6765\u6e90\u96c6\u5408\u540d;</li> </ul> </li> <li><code>spark.mongodb.output.uri</code>: \u76ee\u6807 MongoDB \u8fde\u63a5\u5b57\u7b26\u4e32<ul> <li><code>demo</code>: \u8f93\u51fa\u6570\u636e\u5e93\u540d;</li> <li><code>Output</code>: \u8f93\u51fa\u96c6\u5408\u540d;</li> </ul> </li> </ul> <p>\u66f4\u591a\u914d\u7f6e\u9009\u9879\u8bf7\u53c2\u8003\u6587\u6863:  https://docs.mongodb.com/spark-connector/master/configuration/</p>"},{"location":"mongo2/18mon_spark/#readconfig-writeconfig","title":"ReadConfig \u548c WriteConfig","text":"<p>\u5728\u4f7f\u7528 Spark Connector \u7684\u65f6\u5019\uff0c\u5f88\u591a API \u4e2d\u4f1a\u51fa\u73b0\u53ef\u9009\u7684 ReadConfig \u548c WriteConfig\uff0c\u5b83\u4eec\u53ef\u4ee5\u63d0\u4f9b\u8bfb\u548c\u5199\u65b9\u9762\u7684\u5b9a\u5236\u5316\u4fee\u6539\u3002\u4f8b\u5982\u5bf9\u4e8e\u8bfb\u64cd\u4f5c:</p> <ul> <li>\u914d\u7f6e\u4e00\u4e2a\u4e0d\u540c\u4e8e <code>spark.mongodb.input.uri</code> \u4e2d\u6307\u5b9a\u7684\u6570\u636e\u5e93\u548c\u96c6\u5408;</li> <li>\u914d\u7f6e\u8bfb\u53d6\u64cd\u4f5c\u7684 <code>ReadConcern</code>;</li> <li>\u914d\u7f6e\u8bfb\u53d6\u8981\u4f7f\u7528\u7684 <code>ReadPreference</code>;</li> <li>\u66f4\u591a\u9009\u9879\u8bf7\u53c2\u8003: ReadConfig;</li> </ul> <p>\u540c\u7406\uff0c\u5bf9\u4e8e\u5199\u64cd\u4f5c\u4e5f\u6709\u4e00\u4e9b\u53ef\u5b9a\u5236\u9009\u9879\uff0c\u4f8b\u5982:</p> <ul> <li>\u914d\u7f6e\u4e00\u4e2a\u4e0d\u540c\u4e8e spark.mongodb.output.uri \u4e2d\u6307\u5b9a\u7684\u6570\u636e\u5e93\u548c\u96c6\u5408;</li> <li>\u914d\u7f6e\u5199\u64cd\u4f5c\u7684 WriteConcern;</li> <li>\u6279\u91cf\u5199\u65f6\u662f\u5426\u4fdd\u8bc1\u987a\u5e8f;</li> <li>\u66f4\u591a\u9009\u9879\u8bf7\u53c2\u8003: WriteConfig;</li> </ul>"},{"location":"mongo2/18mon_spark/#_5","title":"\u6570\u636e\u52a0\u8f7d\u548c\u8f93\u51fa","text":"<pre><code>List pipeline = Arrays.asList(\n    addFields(new Field(\"month\", new Document(\"$month\", \"$birthday\")))\n);\nJavaMongoRDD&lt;Document&gt; mgoRdd = MongoSpark.load(jsc, rc)\n    .withPipeline( pipeline ); \n\n// \u5404\u79cdSpark\u8fd0\u7b97\nMongoSpark.save(rdd, writeConfig);\n</code></pre> <ul> <li><code>MongoSpark.load</code>: \u4ece\u6765\u6e90 MongoDB \u4e2d\u52a0\u8f7d\u6570\u636e;</li> <li><code>withPipeline</code>: \u4f7f\u7528\u6307\u5b9a\u7684 Aggregation \u7ba1\u9053\u5bf9\u96c6\u5408\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u9884\u5904\u7406\u3002\u6240\u6709 Aggregation</li> <li>\u8fd0\u7b97\u7b26\u90fd\u652f\u6301;</li> <li><code>MongoSpark.save</code>: \u5c06\u7ed3\u679c\u96c6\u8f93\u51fa\u5230\u914d\u7f6e\u7684 MongoDB \u4e2d;</li> </ul>"},{"location":"mongo2/18mon_spark/#_6","title":"\u6761\u4ef6\u8f93\u51fa","text":"<p>\u4e0a\u9762\u8bb2\u5230\u7684 <code>MongoSpark.save</code> \u4f7f\u7528\u4e86\u6700\u7b80\u5355\u7684\u65b9\u5f0f\u5c06\u7ed3\u679c\u8f93\u51fa\u5230\u76ee\u6807\u96c6\u5408\u4e2d</p> <ul> <li>\u5982\u679c rdd\u4e2d\u7684 <code>_id</code> \u5728\u76ee\u6807\u96c6\u5408\u4e2d\u5b58\u5728\uff0c\u5219\u66ff\u6362\u90a3\u6761\u8bb0\u5f55;</li> <li>\u5982\u679c rdd\u4e2d\u7684 <code>_id</code> \u5728\u76ee\u6807\u96c6\u5408\u4e2d\u4e0d\u5b58\u5728\uff0c\u5219\u65b0\u589e\u4e00\u6761\u8bb0\u5f55;</li> </ul> <p>\u5982\u679c\u60f3\u6839\u636e\u5176\u4ed6\u5b57\u6bb5\u66f4\u65b0\u6570\u636e\u600e\u4e48\u529e?</p>"},{"location":"mongo2/18mon_spark/#_7","title":"\u6761\u4ef6\u8f93\u51fa","text":"<pre><code>final WriteConfig writeConfig = WriteConfig.create(jsc).withOptions(new HashMap&lt;String, String&gt;()); \nfinal ReadConfig readConfig = ReadConfig.create(jsc).withOptions(new HashMap&lt;String, String&gt;()); \n\nmgoRdd.foreachPartition(iterator -&gt; {\n    MongoConnector mc = MongoConnector.create(writeConfig.asJavaOptions());     \n    mc.withCollectionDo(readConfig, Document.class, collection -&gt; {\n        while(iterator.hasNext()) {\n            Document doc = iterator.next(); \n            collection.replaceOne(eq(\u201duser_id\", \u201d12345678\"), doc);\n}\n       return null;\n   });\n});\n</code></pre> <ul> <li>readConfig/writeConfig: \u5b9a\u4e49\u4e00\u4e9b\u8bfb\u5199\u914d\u7f6e\uff0c\u4f8b\u5982 readConcern, writeConcern, \u6216\u91cd\u5b9a\u4e49\u8f93\u5165\u8f93\u51fa\u96c6\u5408\u7b49;</li> <li>foreachPartition: \u5728\u5404\u4e2a\u5206\u533a\u904d\u5386 rdd \u4e2d\u7684\u5185\u5bb9\uff0citerator \u4e2d\u5373\u4e3a\u6bcf\u6761\u6570\u636e;</li> <li>withCollectionDo: \u4ece Spark Connector \u83b7\u5f97 MongoCollection;</li> </ul>"},{"location":"mongo2/18mon_spark/#spark-demo","title":"Spark Demo \u4ee3\u7801","text":"<p><code>mvn install package</code></p> <p></p> <p></p> <p></p> <p></p> <p></p>"},{"location":"mongo2/18mon_spark/#_8","title":"\u5c0f\u7ed3","text":"<ul> <li>MongoDB \u53ea\u662f\u4e00\u4e2a\u5b58\u50a8\uff0cSpark \u91cc\u9762\u7684\u8ba1\u7b97\u64cd\u4f5c\u57fa\u672c\u4e0d\u53d8\uff0c\u53ea\u6709\u6570\u636e\u8f93\u5165\u8f93\u51fa\u8981 \u4f7f\u7528\u7279\u5b9a API\u3002</li> <li>MongoDB \u7684\u4f18\u52bf\u662f\u53ef\u4ee5\u66f4\u52a0\u5feb\u901f\uff0c\u66f4\u52a0\u5927\u91cf\u7684\u4e3a Spark \u63d0\u4f9b\u539f\u59cb\u6570\u636e\u3002</li> </ul>"},{"location":"mongo2/19mon_sql/","title":"19 MongoDB SQL \u5957\u63a5\u4ef6","text":""},{"location":"mongo2/19mon_sql/#mongodb-sql","title":"MongoDB \u652f\u6301 SQL \u65b9\u5f0f\u67e5\u8be2\u5417?","text":"<p>Yes, \u901a\u8fc7\u4e00\u4e2a\u8f6c\u6362\u5957\u4ef6</p> <p></p> <ul> <li>\u6587\u6863\u578b\u5230\u5173\u7cfb\u578b\u6620\u5c04\u5b9a\u4e49</li> <li>\u7531\u5de5\u5177\u81ea\u52a8\u751f\u6210</li> <li>\u53ef\u4ee5\u624b\u5de5\u4fee\u6539</li> </ul> <p></p>"},{"location":"mongo2/19mon_sql/#bi","title":"\u5173\u4e8e BI \u5957\u63a5\u4ef6","text":"<ul> <li>\u72ec\u7acb\u4e8e MongoDB \u8fd0\u884c\u7684\u670d\u52a1</li> <li>MongoDB \u4f01\u4e1a\u7248\u7ec4\u4ef6</li> <li>(\u514d\u8d39\u4ec5\u9650\u5f00\u53d1\u73af\u5883)</li> <li>MySQL \u534f\u8bae\u517c\u5bb9\uff0c\u53ef\u4ee5\u4f7f\u7528 MySQL \u5ba2\u6237\u7aef\u8fde\u63a5</li> </ul>"},{"location":"mongo2/19mon_sql/#demo","title":"DEMO","text":"<p>\u4e0b\u8f7d\u5e76\u5b89\u88c5MongoDB BI Connector</p> <ul> <li>https://www.mongodb.com/docs/bi-connector/current/</li> <li>https://www.mongodb.com/try/download/bi-connector</li> </ul> <pre><code>$ wget https://info-mongodb-com.s3.amazonaws.com/mongodb-bi/v2/mongodb-bi-linux-x86_64-rhel70-v2.14.4.tgz\n\n$ tar -xvf mongodb-bi-linux-x86_64-rhel70-v2.14.4.tgz\nmongodb-bi-linux-x86_64-rhel70-v2.14.4/LICENSE\nmongodb-bi-linux-x86_64-rhel70-v2.14.4/README\nmongodb-bi-linux-x86_64-rhel70-v2.14.4/THIRD-PARTY-NOTICES\nmongodb-bi-linux-x86_64-rhel70-v2.14.4/example-mongosqld-config.yml\nmongodb-bi-linux-x86_64-rhel70-v2.14.4/bin/mongosqld\nmongodb-bi-linux-x86_64-rhel70-v2.14.4/bin/mongodrdl\nmongodb-bi-linux-x86_64-rhel70-v2.14.4/bin/mongotranslate\n\n$ cd tmp/mongodb-bi-linux-x86_64-rhel70-v2.14.4/bin\n\n$ ls\nmongodrdl  mongosqld  mongotranslate\n</code></pre> <p>\u542f\u52a8 mongosqld \u8fdb\u7a0b</p> <pre><code>mongosqld --addr localhost:3306 --mongo-uri mongodb://localhost:27017 \n</code></pre> <pre><code>$ ./mongosqld --addr localhost:3306 --mongo-uri mongodb://localhost:27017\n2022-05-08T08:23:19.329+0000 I CONTROL    [initandlisten] mongosqld starting: version=v2.14.4 pid=23141 host=jabox\n2022-05-08T08:23:19.329+0000 I CONTROL    [initandlisten] git version: df0cf0b57e9aac0ab6d545eee0d4451d11d0c6e9\n2022-05-08T08:23:19.329+0000 I CONTROL    [initandlisten] OpenSSL version OpenSSL 1.0.1e-fips 11 Feb 2013 (built with OpenSSL 1.0.1e 11 Feb 2013)\n2022-05-08T08:23:19.330+0000 I CONTROL    [initandlisten] options: {net: {bindIp: [localhost], port: 3306}}\n2022-05-08T08:23:19.330+0000 I CONTROL    [initandlisten] ** WARNING: Access control is not enabled for mongosqld.\n2022-05-08T08:23:19.330+0000 I CONTROL    [initandlisten]\n2022-05-08T08:23:19.390+0000 I NETWORK    [initandlisten] waiting for connections at 127.0.0.1:3306\n2022-05-08T08:23:19.390+0000 I NETWORK    [initandlisten] waiting for connections at /tmp/mysql.sock\n2022-05-08T08:23:19.422+0000 I SCHEMA     [sampler] sampling MongoDB for schema...\n2022-05-08T08:23:20.804+0000 I SCHEMA     [sampler] mapped schema for 24 namespaces: \"eshop\" (2): [\"students\", \"users\"]; \"mock\" (1): [\"orders\"]; \"test\" (4): [\"movies\", \"scores\", \"users\", \"zips\"]; \"viewdemo\" (2): [\"shipping\", \"order\"]; \"aggdemo\" (5): [\"orderItem\", \"orderitem\", \"customer\", \"books\", \"order\"]; \"appdb\" (10): [\"restaurants\", \"restaurant\", \"inventory\", \"products\", \"stores\", \"values\", \"books\", \"users\", \"emps\", \"user\"]\n</code></pre> <p>\u4f7f\u7528mysql \u5ba2\u6237\u7aef\u53bb\u8fde\u63a5 3306 \u7aef\u53e3</p> <pre><code># netstat -alntp | grep 3306\ntcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      23141/./mongosqld\n</code></pre> <pre><code>select * from orders;\n\nselect first_name,product_id, quantity from orders o left join customers c on o.customer_id = c.customer_id;\n\nselect count(*), customer_id from orders group by customer_id;\n</code></pre>"},{"location":"mongo2/1mon_intro_install/","title":"1 \u8ba4\u8bc6\u6587\u6863\u6570\u636e\u5e93 MongoDB &amp; \u53ca\u6570\u636e\u5b89\u88c5","text":""},{"location":"mongo2/1mon_intro_install/#mongodb","title":"\u5173\u4e8e MongoDB","text":""},{"location":"mongo2/1mon_intro_install/#mongodb-vs","title":"MongoDB vs. \u5173\u7cfb\u578b\u6570\u636e\u5e93","text":""},{"location":"mongo2/1mon_intro_install/#mongodb_1","title":"MongoDB \u7279\u8272\u53ca\u4f18\u52bf","text":"<p>\u5f00\u53d1\u6548\u7387 | \u81ea\u7136\u6a21\u578b | \u6a2a\u5411\u6269\u5c55</p>"},{"location":"mongo2/1mon_intro_install/#mongodb_2","title":"MongoDB \u4f18\u52bf:\u9762\u5411\u5f00\u53d1\u8005\u7684\u6613\u7528+\u9ad8\u6548\u6570\u636e\u5e93","text":"<ul> <li>\u7b80\u5355\u76f4\u89c2: </li> </ul> <p>\u4ee5\u81ea\u7136\u7684\u65b9\u5f0f\u6765\u5efa\u6a21\uff0c\u4ee5\u76f4\u89c2\u7684\u65b9\u5f0f\u6765\u4e0e\u6570\u636e\u5e93\u4ea4\u4e92</p> <ul> <li>\u7ed3\u6784\u7075\u6d3b:</li> </ul> <p>\u5f39\u6027\u6a21\u5f0f\u4ece\u5bb9\u54cd\u5e94\u9700\u6c42\u7684\u9891\u7e41\u53d8\u5316</p> <ul> <li>\u5feb\u901f\u5f00\u53d1:</li> </ul> <p>\u505a\u66f4\u591a\u7684\u4e8b\uff0c\u5199\u66f4\u5c11\u7684\u4ee3\u7801</p>"},{"location":"mongo2/1mon_intro_install/#_1","title":"\u4ece\u9519\u7efc\u590d\u6742\u7684\u5173\u7cfb\u6a21\u578b\u5230\u4e00\u76ee\u4e86\u7136\u7684\u5bf9\u8c61\u6a21\u578b","text":""},{"location":"mongo2/1mon_intro_install/#_2","title":"\u7075\u6d3b: \u5feb\u901f\u54cd\u5e94\u4e1a\u52a1\u53d8\u5316","text":"<ul> <li>\u591a\u5f62\u6027: \u540c\u4e00\u4e2a\u96c6\u5408\u4e2d\u53ef\u4ee5\u5305\u542b\u4e0d\u540c\u5b57\u6bb5(\u7c7b\u578b)\u7684\u6587\u6863\u5bf9\u8c61</li> <li>\u52a8\u6001\u6027: \u7ebf\u4e0a\u4fee\u6539\u6570\u636e\u6a21\u5f0f\uff0c\u4fee\u6539\u662f\u5e94\u7528\u4e0e\u6570\u636e\u5e93\u5747\u65e0\u987b\u4e0b\u7ebf</li> <li>\u6570\u636e\u6cbb\u7406: \u652f\u6301\u4f7f\u7528<code>JSON Schema</code> \u6765\u89c4\u8303\u6570\u636e\u6a21\u5f0f\u3002\u5728\u4fdd\u8bc1\u6a21\u5f0f\u7075\u6d3b\u52a8\u6001\u7684\u524d\u63d0\u4e0b\uff0c\u63d0\u4f9b \u6570\u636e\u6cbb\u7406\u80fd\u529b</li> </ul>"},{"location":"mongo2/1mon_intro_install/#_3","title":"\u5feb\u901f: \u6700\u7b80\u5355\u5feb\u901f\u7684\u5f00\u53d1\u65b9\u5f0f","text":"<p>JSON \u6a21\u578b\u4e4b\u5feb\u901f\u7279\u6027:</p> <ul> <li>\u6570\u636e\u5e93\u5f15\u64ce\u53ea\u9700\u8981\u5728\u4e00\u4e2a\u5b58\u50a8\u533a\u8bfb\u5199</li> <li>\u53cd\u8303\u5f0f\u3001\u65e0\u5173\u8054\u7684\u7ec4\u7ec7\u6781\u5927\u4f18\u5316\u67e5\u8be2 \u901f\u5ea6</li> <li>\u7a0b\u5e8f API \u81ea\u7136\uff0c\u5f00\u53d1\u5feb\u901f</li> </ul> <p>SQL:\u63d2\u5165\u4e00\u4e2a\u5ba2\u6237\u76f8\u5173\u6570\u636e</p> <p></p> <p>\u5feb\u901f: MongoDB \u53ea\u9700\u8981\u4e24\u884c\u4ee3\u7801</p> <p></p>"},{"location":"mongo2/1mon_intro_install/#mongodb_3","title":"MongoDB \u4f18\u52bf:\u539f\u751f\u7684\u9ad8\u53ef\u7528\u548c\u6a2a\u5411\u6269\u5c55\u80fd\u529b","text":"<ul> <li>Replica Set \u2013 2 to 50 \u4e2a\u6210\u5458</li> <li>\u81ea\u6062\u590d</li> <li>\u591a\u4e2d\u5fc3\u5bb9\u707e\u80fd\u529b</li> <li>\u6eda\u52a8\u670d\u52a1 \u2013 \u6700\u5c0f\u5316\u670d\u52a1\u7ec8\u7aef</li> </ul>"},{"location":"mongo2/1mon_intro_install/#mongodb_4","title":"MongoDB \u4f18\u52bf:\u6a2a\u5411\u6269\u5c55\u80fd\u529b","text":"<ul> <li>\u9700\u8981\u7684\u65f6\u5019\u65e0\u7f1d\u6269\u5c55</li> <li>\u5e94\u7528\u5168\u900f\u660e</li> <li>\u591a\u79cd\u6570\u636e\u5206\u5e03\u7b56\u7565</li> <li>\u8f7b\u677e\u652f\u6301TB\u2013PB\u6570\u91cf\u7ea7</li> </ul>"},{"location":"mongo2/1mon_intro_install/#mongodb_5","title":"MongoDB \u6280\u672f\u4f18\u52bf\u603b\u7ed3","text":"<ul> <li>JSON \u7ed3\u6784\u548c\u5bf9\u8c61\u6a21\u578b\u63a5\u8fd1\uff0c\u5f00\u53d1\u4ee3\u7801\u91cf\u4f4e</li> <li>JSON \u7684\u52a8\u6001\u6a21\u578b\u610f\u5473\u7740\u66f4\u5bb9\u6613\u54cd\u5e94\u65b0\u7684\u4e1a\u52a1\u9700\u6c42 </li> <li>\u590d\u5236\u96c6\u63d0\u4f9b 99.999% \u9ad8\u53ef\u7528</li> <li>\u5206\u7247\u67b6\u6784\u652f\u6301\u6d77\u91cf\u6570\u636e\u548c\u65e0\u7f1d\u6269\u5bb9</li> </ul>"},{"location":"mongo2/1mon_intro_install/#mongodb_6","title":"\u5b89\u88c5 MongoDB","text":"<p>\u4e0b\u8f7d\u5b89\u88c5 MongoDB | Compass</p>"},{"location":"mongo2/1mon_intro_install/#mongodb_7","title":"\u4e0b\u8f7d MongoDB","text":"<ul> <li>mongodb.com/download-center</li> <li>\u4f01\u4e1a\u7248 - \u5f00\u53d1\u73af\u5883\u514d\u8d39\u4f7f\u7528</li> <li>\u793e\u533a\u7248 - \u6240\u6709\u73af\u5883\u514d\u8d39\u4f7f\u7528</li> <li>\u9009\u62e9\u5408\u9002\u7684 OS \u7248\u672c</li> <li>GZ \u7248\u672c\u5305\u542b server mongos tools \u548c shell</li> </ul>"},{"location":"mongo2/1mon_intro_install/#linux-mongodb","title":"Linux \u4e0a\u5b89\u88c5 MongoDB","text":"<p>\u5177\u4f53\uff1alinux\u7cfb\u7edf\uff1acentos7 \u5b89\u88c5MongoDB\u793e\u533a\u7248</p> <pre><code>$ mkdir -p /data /data/db\n\n$ cd /data\n$ curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.2.1.tgz $ tar -xvf mongodb-linux-x86_64-rhel70-4.2.1.tgz\n\n$ export PATH=$PATH:/data/mongodb-linux-x86_64-rhel70-4.2.1/bin\n\n$ mongod --dbpath /data/db --port 27017 --logpath /data/db/mongod.log --fork \u2013bind_ip 0.0.0.0\n</code></pre>"},{"location":"mongo2/1mon_intro_install/#atlas","title":"\u4f7f\u7528 Atlas \u514d\u8d39\u8d26\u53f7","text":"<ul> <li>\u5b98\u65b9\u63d0\u4f9b\u7684\u4e91\u6258\u7ba1 MongoDB </li> <li>\u63d0\u4f9b\u4e00\u4e2a\u7ec8\u8eab\u514d\u8d39\u6d4b\u8bd5\u8d26\u53f7</li> <li>\u6b65\u9aa4:<ul> <li>\u6ce8\u518c\u8d26\u53f7</li> <li>\u521b\u5efa\u514d\u8d39\u96c6\u7fa4</li> <li>\u6309\u7167\u63d0\u793a\u5b8c\u6210\u521b\u5efa\u5e76\u83b7\u5f97\u8fde\u63a5\u4e32 </li> <li>\u4f7f\u7528 mongo \u547d\u4ee4\u884c\u8fde\u63a5\u96c6\u7fa4</li> </ul> </li> </ul> <p>https://account.mongodb.com/account/login</p> <p>QQ cy</p> <p></p> <p></p> <ul> <li>Connect with the MongoDB Schell</li> </ul> <pre><code>brew install mongosh\n\n$ mongosh \"mongodb+srv://cluster0.hyst4.mongodb.net/myFirstDatabase\" --apiVersion 1 --username admin\n\nEnter password: ********* (cy)\n\n...\n\nAtlas atlas-hy8mcw-shard-0 [primary] myFirstDatabase&gt; show dbs\nadmin   348 kB\nlocal  1.26 GB\nAtlas atlas-hy8mcw-shard-0 [primary] myFirstDatabase&gt;\n---\n&gt;\n</code></pre> <p></p> <ul> <li>Connect with the MongoDB Compass</li> </ul> <pre><code>mongodb+srv://admin:&lt;password&gt;@cluster0.hyst4.mongodb.net/test\n</code></pre> <p></p> <p>\u5bfc\u5165\u6837\u672c\u6570\u636e</p> <ul> <li>curl -O -k https://raw.githubusercontent.com/tapdata/geektime-mongodb-course/master/aggregation/dump.tar.gz</li> <li><code>tar -xvf dump.tar.gz</code></li> <li><code>mongorestore -h localhost:27017</code></li> </ul> <p></p> <pre><code>curl -O -k https://raw.githubusercontent.com/tapdata/geektime-mongodb-course/master/aggregation/dump.tar.gz\ncp dump.tar.gz  /mongodb/data/\ntar -xvf dump.tar.gz\n\n# ll | grep dump\ndrwxr-xr-x. 3 root root       18 Apr 30 03:57 dump\n\n# mongorestore\n\n2022-04-30T04:22:13.866+0000    using default 'dump' directory\n2022-04-30T04:22:13.866+0000    preparing collections to restore from\n2022-04-30T04:22:13.866+0000    reading metadata for mock.orders from dump/mock/orders.metadata.json\n2022-04-30T04:22:13.874+0000    restoring mock.orders from dump/mock/orders.bson\n2022-04-30T04:22:15.935+0000    finished restoring mock.orders (100000 documents, 0 failures)\n2022-04-30T04:22:15.935+0000    no indexes to restore for collection mock.orders\n2022-04-30T04:22:15.935+0000    100000 document(s) restored successfully. 0 document(s) failed to restore.\n\n# mongo\n\n---\n&gt; show dbs\nadmin     0.000GB\naggdemo   0.000GB\nappdb     0.001GB\nconfig    0.000GB\nlocal     0.000GB\nmock      0.048GB\ntest      0.002GB\nviewdemo  0.001GB\n</code></pre> <pre><code>&gt; use mock\nswitched to db mock\n\n&gt; show collections\norders\n\n&gt; db.orders.find()\n{ \"_id\" : ObjectId(\"5dbe7a545368f69de2b4d36e\"), \"street\" : \"493 Hilll Curve\", \"city\" : \"Champlinberg\", \"state\" : \"Texas\", \"country\" : \"Malaysia\", \"zip\" : \"24344-1715\", \"phone\" : \"425.956.7743 x4621\", \"name\" : \"Destinee Schneider\", \"userId\" : 3573, \"orderDate\" : ISODate(\"2019-03-26T03:20:08.805Z\"), \"status\" : \"created\", \"shippingFee\" : NumberDecimal(\"8.00\"), \"orderLines\" : [ { \"product\" : \"Refined Fresh Tuna\", \"sku\" : \"2057\", \"qty\" : 25, \"price\" : NumberDecimal(\"56.00\"), \"cost\" : NumberDecimal(\"46.48\") }, { \"product\" : \"Refined Concrete Ball\", \"sku\" : \"1738\", \"qty\" : 61, \"price\" : NumberDecimal(\"47.00\"), \"cost\" : NumberDecimal(\"47\") }, { \"product\" : \"Rustic Granite Towels\", \"sku\" : \"500\", \"qty\" : 62, \"price\" : NumberDecimal(\"74.00\"), \"cost\" : NumberDecimal(\"62.16\") }, { \"product\" : \"Refined Rubber Salad\", \"sku\" : \"1400\", \"qty\" : 73, \"price\" : NumberDecimal(\"93.00\"), \"cost\" : NumberDecimal(\"87.42\") }, { \"product\" : \"Intelligent Wooden Towels\", \"sku\" : \"5674\", \"qty\" : 72, \"price\" : NumberDecimal(\"84.00\"), \"cost\" : NumberDecimal(\"68.88\") }, { \"product\" : \"Refined Steel Bacon\", \"sku\" : \"5009\", \"qty\" : 8, \"price\" : NumberDecimal(\"53.00\"), \"cost\" : NumberDecimal(\"50.35\") } ], \"total\" : NumberDecimal(\"407\") }\n...\n</code></pre>"},{"location":"mongo2/1mon_intro_install/#mongodb-compass","title":"\u4e0b\u8f7d\u5e76\u5b89\u88c5 MongoDB Compass","text":"<ul> <li>\u5b98\u65b9\u63d0\u4f9b\u7684\u514d\u8d39 GUI \u7ba1\u7406\u5de5\u5177</li> <li>\u6570\u636e\u7ba1\u7406(\u589e\u5220\u6539\u67e5)</li> <li>Schema \u7ba1\u7406</li> <li>\u7d22\u5f15\u7ba1\u7406</li> <li>\u6027\u80fd\u6392\u67e5</li> <li>\u5b9e\u65f6\u6027\u80fd\u76d1\u63a7</li> </ul> <p>\u4f7f\u7528 MongoDB Compass(demo)</p> <p><code>mongodb://192.168.1.44:27017/</code></p> <p></p> <ul> <li>\u8fde\u63a5</li> <li>\u6570\u636e\u5e93/\u96c6\u5408\u5217\u8868 </li> <li>\u96c6\u5408\u7edf\u8ba1</li> <li>\u6570\u636e\u6a21\u5f0f</li> <li>\u67e5\u8be2\u89e3\u91ca\u5668</li> <li>\u7d22\u5f15</li> <li>\u5b9e\u65f6\u6027\u80fd\u76d1\u63a7</li> </ul> <p></p> <pre><code>/** \n* Paste one or more documents here\n*/\n{\n  \"street\": \"493 Hilll Curve\",\n  \"city\": \"Champlinberg\",\n  \"state\": \"Texas\",\n  \"country\": \"Malaysia\",\n  \"zip\": \"24344-1715\",\n  \"phone\": \"425.956.7743 x4621\",\n  \"name\": \"Destinee Schneider\",\n  \"userId\": 3573,\n  \"orderDate\": {\n    \"$date\": {\n      \"$numberLong\": \"1553570408805\"\n    }\n  },\n  \"status\": \"created\",\n  \"shippingFee\": {\n    \"$numberDecimal\": \"8.00\"\n  },\n  \"orderLines\": [\n    ...\n    {\n      \"product\": \"Rustic Granite Towels\",\n      \"sku\": \"500\",\n      \"qty\": 62,\n      \"price\": {\n        \"$numberDecimal\": \"74.00\"\n      },\n      \"cost\": {\n        \"$numberDecimal\": \"62.16\"\n      }\n    },\n    ...    }\n  ],\n  \"total\": {\n    \"$numberDecimal\": \"407\"\n  }\n}\n</code></pre> <p>Schema</p> <p></p> <p>Rules:</p> <p></p>"},{"location":"mongo2/20MongoDB_mico_middle_service/","title":"20 MongoDB \u4e0e\u5fae\u670d\u52a1 &amp; \u6570\u636e\u4e2d\u53f0","text":""},{"location":"mongo2/20MongoDB_mico_middle_service/#1-mongodb","title":"1 MongoDB \u4e0e\u5fae\u670d\u52a1","text":""},{"location":"mongo2/20MongoDB_mico_middle_service/#vs-soa-vs","title":"\u5fae\u670d\u52a1 vs SOA vs \u5355\u4f53\u5e94\u7528","text":"<p>The microservices architectural style is an approach to develop a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API. These services are built around business capabilities and independently deployable by fully automated deployment machinery...</p> <p>\u5fae\u670d\u52a1\u7684\u4f18\u52bf</p> <p>\u5f00\u53d1\u901f\u5ea6\u5feb \u53d8\u5316\u54cd\u5e94\u5feb \u6613\u7ef4\u62a4 \u6269\u5bb9\u7b80\u5355</p> <p>\u5fae\u670d\u52a1\u67b6\u6784\u8bbe\u8ba1\u8981\u7d20</p> <p></p> <p>\u5fae\u670d\u52a1\u7684\u6570\u636e\u67b6\u6784\u8bbe\u8ba1\u8003\u91cf\u70b9</p> <ul> <li>\u4e00\u670d\u4e00\u5e93\u8fd8\u662f\u591a\u670d\u4e00\u5e93</li> <li>\u6df7\u5408\u6301\u4e45\u5316\u8fd8\u662f\u591a\u6a21\u6570\u636e\u5e93 </li> <li>\u6269\u5bb9\u4fbf\u6377\u6027</li> </ul>"},{"location":"mongo2/20MongoDB_mico_middle_service/#_1","title":"\u591a\u4e2a\u5fae\u670d\u52a1\u5171\u4eab\u4e00\u4e2a\u6570\u636e\u5e93","text":"<ul> <li>\u5355\u70b9\u6545\u969c\uff0c\u4e00\u4e2a\u6027\u80fd\u95ee\u9898\u53ef\u80fd\u62d6\u57ae \u6574\u4e2a\u670d\u52a1\u96c6\u7fa4</li> <li>\u5bb9\u6613\u5f15\u8d77\u5f3a\u5173\u8054\uff0c\u4e0d\u5229\u89e3\u8026</li> <li>\u96be\u4ee5\u4e3a\u67d0\u4e00\u4e2a\u5fae\u670d\u52a1\u5355\u72ec\u6269\u5bb9</li> </ul> <p>\u53cd\u8303\u5f0f \u4e00\u4e2a(\u903b\u8f91)\u6570\u636e\u5e93\u4e3a\u6240\u6709\u5fae\u670d\u52a1\u4f7f\u7528</p>"},{"location":"mongo2/20MongoDB_mico_middle_service/#_2","title":"\u5173\u952e\u5fae\u670d\u52a1\u4f7f\u7528\u81ea\u5df1\u4e13\u7528\u7684\u6570\u636e\u5e93","text":"<ul> <li>\u6bcf\u4e2a\u5fae\u670d\u52a1\u4f7f\u7528\u4e00\u4e2a\u903b\u8f91\u5e93</li> <li>\u6570\u636e\u5e93\u53d8\u52a8\u65f6\u5019\u4e0d\u5f71\u54cd\u5176\u4ed6\u670d\u52a1</li> </ul> <p>\u6df7\u5408\u6301\u4e45\u5316</p> <p></p> <p>\u5b66\u4e60\uff0c\u7ba1\u7406\u548c\u786c\u4ef6\u6210\u672c</p> <p></p> <ul> <li>\u4e00\u79cd\u6570\u636e\u5e93\uff0c\u591a\u79cd\u6a21\u5f0f</li> <li>\u4e00\u79cd\u6280\u672f\uff0c\u5b66\u4e60\u53ca\u7ba1\u7406\u7b80\u5355</li> <li>\u53ef\u4ee5\u5355\u72ec\u4f18\u5316</li> </ul> <p>\u662f\u5426\u53ef\u4ee5\u5feb\u901f\u6269\u5bb9</p> <ul> <li>X-axis\u6c34\u5e73\u6269\u5c55\u5e94\u7528 </li> <li>Y-axis\u5fae\u670d\u52a1\u5316</li> <li>Z-axis\u6570\u636e\u6269\u5bb9</li> </ul> <p>MongoDB \u7684\u6269\u5bb9\u80fd\u529b</p> <p>Elastic scalability \u5f39\u6027\u4f38\u7f29   /  Auto Balancing \u81ea\u52a8\u5747\u8861</p> <p>MongoDB \u5bb9\u5668\u5316\u90e8\u7f72</p> <p>MongoDB \u662f\u4e00\u4e2a\u6709\u72b6\u6001\u7684\u670d\u52a1\uff0c\u5728\u5bb9\u5668\u5316\u90e8\u7f72 \u65f6\u5019\u8981\u7279\u522b\u6ce8\u610f</p> <ul> <li>\u590d\u5236\u96c6\u8282\u70b9\u8981\u80fd\u591f\u4e92\u76f8\u901a\u8baf:\u914d\u7f6e\u7684\u65f6\u5019\u8981\u4f7f\u7528\u670d \u52a1\u540d\uff0c\u6216\u8005\u56fa\u5b9a\u7684\u670d\u52a1 IP \u5730\u5740</li> <li>\u4f7f\u7528 Persistent Volume \u6216\u7c7b\u4f3c\u7684\u957f\u4e45\u5b58\u50a8</li> <li>\u4f7f\u7528Ops Manager\u8fdb\u884c\u96c6\u7fa4\u7ba1\u7406(\u800c\u4e0d\u662f K8S/Openshift)</li> </ul> <p></p>"},{"location":"mongo2/20MongoDB_mico_middle_service/#mongodb","title":"\u4e3a\u4f55 MongoDB \u9002\u5408\u5fae\u670d\u52a1","text":"<ul> <li>\u6613\u6269\u5c55\uff0c\u7b26\u5408\u5fae\u670d\u52a1\u7684\u6613\u6269\u5c55\u7279\u6027</li> <li>\u6a21\u5f0f\u7075\u6d3b\uff0c\u8fed\u4ee3\u5feb\uff0c\u7b26\u5408\u5fae\u670d\u52a1\u67b6\u6784\u7684\u7406\u5ff5 </li> <li>\u591a\u6a21\u6570\u636e\u5e93\uff0c \u53ef\u4ee5\u4e3a\u4e0d\u540c\u7684\u5fae\u670d\u52a1\u63d0\u4f9b\u4e1a\u52a1</li> </ul>"},{"location":"mongo2/20MongoDB_mico_middle_service/#mongodb_1","title":"MongoDB \u4e0e\u6570\u636e\u4e2d\u53f0","text":"<p>\u6211\u4eec\u5904\u4e8e\u4e00\u4e2a\u6570\u636e\u65f6\u4ee3</p> <p></p> <p>\u6570\u636e\u5373\u4ef7\u503c</p>"},{"location":"mongo2/20MongoDB_mico_middle_service/#_3","title":"\u73b0\u4ee3\u4f01\u4e1a\u7684\u6570\u636e\u75db\u70b9","text":"<ul> <li>\u6570\u636e\u5b64\u5c9b</li> </ul> <p>\u67d0\u822a\u7a7a\u516c\u53f8\u7684\u4e58\u5ba2\u76f8\u5173\u7cfb\u7edf: \u95e8\u6237\uff0c\u7535\u5546\uff0c\u5e38\u65c5\u5ba2\uff0c\u5730\u52e4\uff0c \u67dc\u670d\uff0c\u5ba2\u670d\uff0c\u8425\u9500\u7b49\u5341\u6765\u5957\u3002 \u8fd9\u4e9b\u76f8\u4e92\u9694\u79bb\u7684\u7cfb\u7edf\u90fd\u548c\u5ba2\u6237 \u4fe1\u606f\u76f8\u5173\uff0c\u4f46\u662f\u76f8\u4e92\u9694\u79bb\u3002</p> <ul> <li>\u7cfb\u7edf\u91cd\u590d</li> </ul> <p>\u67d0\u534a\u5bfc\u4f53\u5236\u9020\u4f01\u4e1a\u4e00\u5957\u8f6f \u4ef6\u91cd\u590d\u90e8\u7f72\u4e8652\u5957\uff0c\u56e0 \u4e3a\u5173\u7cfb\u578b\u6570\u636e\u5e93\u5e93\u4e0d\u80fd\u652f \u6491\u6027\u80fd\u8981\u6c42\uff0c\u6240\u4ee5\u6bcf\u4e0a\u4e00 \u4e2a\u65b0\u7684\u4e1a\u52a1\u5c31\u9700\u8981\u91cd\u590d\u90e8 \u7f72\u4e00\u5957\u7cfb\u7edf</p> <ul> <li>\u4e1a\u52a1\u5f00\u53d1\u4f4e\u6548</li> </ul> <p>\u67d0\u6559\u80b2\u7cfb\u7edf\u4e0d\u65ad\u9700\u8981\u6784\u5efa \u4e00\u4e9b\u57fa\u4e8e\u6559\u5e08\u548c\u5b66\u751f\u7684\u4e1a \u52a1\u573a\u666f\uff0c\u4f46\u662f\u6bcf\u4e2a\u4e1a\u52a1\u90fd \u9700\u8981\u5927\u91cf\u7684\u524d\u540e\u7aef\u5f00\u53d1\uff0c \u4e0d\u4ec5\u6210\u672c\u96be\u4ee5\u63a7\u5236\uff0c\u5468\u671f \u4e5f\u96be\u4ee5\u63a7\u5236\u3002</p> <p>\u6570\u636e\u5b64\u5c9b:\u9ad8\u6210\u672c\uff0c\u4f4e\u6548\u7387</p> <ul> <li>\u6570\u636e\u5b64\u5c9b\u7684\u5f62\u6210\u6839\u56e0<ul> <li>\u57fa\u4e8e\u90e8\u95e8\u4e1a\u52a1\u7279\u6027\u6784\u5efaIT\u7cfb\u7edf</li> <li>80\u5e74\u4ee3\u6570\u636e\u5e93\u6280\u672f\u65e0\u6cd5\u6269\u5c55</li> </ul> </li> <li>\u5f71\u54cd<ul> <li>\u4e1a\u52a1\u7cfb\u7edf\u843d\u5730\u56f0\u96be\uff0c\u9700\u8981\u82b1\u5f88\u591a\u65f6 \u95f4\u8fdb\u884c\u6570\u636e\u9002\u914d</li> <li>\u6570\u636e\u4e0d\u5b8c\u6574\uff0c\u5f71\u54cd\u5ba2\u6237\u4f53\u9a8c</li> <li>\u8d44\u6e90\u6d6a\u8d39\u4e25\u91cd\uff0c\u91cd\u590d\u5efa\u8bbe\u6210\u672c\u9ad8</li> </ul> </li> </ul>"},{"location":"mongo2/20MongoDB_mico_middle_service/#_4","title":"\u5df2\u6709\u6570\u4ed3\u53ca\u5927\u6570\u636e\u65b9\u6848\u4e4b\u4e0d\u8db3","text":"<ul> <li>\u5e76\u975e\u4e3a\u6253\u901a\u7cfb\u7edf\u4e3a\u4e3b\u8981 \u76ee\u6807\uff0c\u4ecd\u7136\u4ee5\u67d0\u4e2a\u6570\u636e \u4e1a\u52a1\u4e3a\u6838\u5fc3</li> <li>\u65e0\u6570\u636e\u8d44\u4ea7\u7ba1\u7406\uff0c\u96be\u4ee5 \u8d77\u5230\u4f01\u4e1a\u5185\u6709\u6548\u5171\u4eab</li> <li>\u6570\u636e\u4e0d\u53ca\u65f6\uff0c\u591a\u4e3a\u6279\u91cf\u5bfc\u5165\uff0c\u4ef7\u503c\u53d7\u9650</li> <li>\u4ea4\u4ed8\u65b9\u5f0f\u591a\u4e3a\u6279\u91cf\uff0c\u96be \u4ee5\u6ee1\u8db3API\u5f0f\u4ea4\u4e92\u9700\u6c42</li> </ul>"},{"location":"mongo2/20MongoDB_mico_middle_service/#_5","title":"\u6570\u636e\u4e2d\u53f0\u7684\u4e00\u4e2a\u5b9a\u4e49","text":"<ul> <li>\u4ee5\u6253\u901a\u90e8\u95e8\u6216\u6570\u636e\u5b64\u5c9b\u7684\u7edf\u4e00\u6570\u636e\u5e73\u53f0\u4e3a\u57fa\u7840\uff0c\u6784\u5efa\u7edf\u4e00</li> <li>\u6570\u636e\u8d44\u4ea7\u4f53\u7cfb\uff0c\u5e76\u4ee5 API \u670d\u52a1\u65b9\u5f0f\u4e3a\u5168\u6e20\u9053\u4e1a\u52a1(\u5206\u6790+\u5e94\u7528) \u63d0\u4f9b\u5373\u65f6\u4ea4\u4ed8\u80fd\u529b\u7684 \u4f01\u4e1a\u7ea7\u6570\u636e\u67b6\u6784</li> </ul>"},{"location":"mongo2/20MongoDB_mico_middle_service/#_6","title":"\u6570\u636e\u4e2d\u53f0\u6280\u672f\u9700\u6c42","text":""},{"location":"mongo2/20MongoDB_mico_middle_service/#_7","title":"\u6570\u636e\u4e2d\u53f0\u6280\u672f\u6a21\u5757","text":"<p>\u6570\u636e\u5e73\u53f0\u9009\u578b \u2013 Gartner 3V \u6807\u51c6</p> <p></p>"},{"location":"mongo2/20MongoDB_mico_middle_service/#mongodb_2","title":"MongoDB \u4f5c\u4e3a\u4e2d\u53f0\u5185\u6570\u636e\u5e73\u53f0\u65b9\u6848\u7684\u6280\u672f\u4f18\u52bf","text":""},{"location":"mongo2/20MongoDB_mico_middle_service/#3-mongodb","title":"3 MongoDB \u6570\u636e\u4e2d\u53f0\u6848\u4f8b","text":""},{"location":"mongo2/20MongoDB_mico_middle_service/#_8","title":"\u6570\u636e\u5b64\u5c9b\u53ca\u91cd\u590d\u7684\u7cfb\u7edf","text":"<ul> <li>\u6bcf\u4e2a\u5730\u533a\u6709\u81ea\u5df1\u7684\u9500\u552e\u548c\u5e93\u5b58\u7cfb\u7edf\uff0c\u4ea7\u54c1\u548c\u9500 \u552e\u6570\u636e\u5728\u5f88\u591a\u5957 Oracle \u7cfb\u7edf\u3002\u6570\u636e\u901a\u8fc7\u961f\u5217 \u7cfb\u7edf\u4ea4\u4e92\uff0c\u6613\u9519\u96be\u8ffd\u8e2a</li> <li>\u96be\u4ee5\u5feb\u901f\u63d0\u4f9b\u4e00\u4e2a\u51c6\u786e\u7684\u5e93\u5b58\u53ca\u9500\u552e\uff0c \u5f71\u54cd\u4e1a\u52a1\u90e8\u95e8\u51b3\u7b56</li> <li>\u6784\u5efa\u4e00\u4e9b\u6570\u636e API \u4e3a\u524d\u7aef\u4e1a\u52a1\u63d0\u4f9b\u652f\u6301\u7684\u65f6\u5019\uff0c \u9700\u8981\u8fdb\u884c\u7e41\u7410\u7684\u6570\u636e\u5bf9\u63a5\u548c\u6574\u5408\uff0c\u7136\u540e\u518d\u5f00\u53d1</li> </ul>"},{"location":"mongo2/20MongoDB_mico_middle_service/#mongodb_3","title":"MongoDB: \u5f00\u59cb\u53ea\u662f\u4e00\u4e24\u4e2a\u5b64\u7acb\u7684\u5e94\u7528","text":""},{"location":"mongo2/20MongoDB_mico_middle_service/#mongodb_4","title":"\u7528 MongoDB \u6765\u642d\u5efa\u4e2d\u53f0\u7b2c\u4e00\u6b65:\u8bfb\u5199\u5206\u79bb\u6a21\u5f0f\u652f\u6491\u67e5\u8be2\u4e1a\u52a1","text":"<p>\u4f20\u7edf\u5173\u7cfb\u6a21\u578b vs \u4e2d\u53f0\u4e1a\u52a1\u6a21\u578b:</p> <ul> <li>Oracle Schema: 40+ \u5f20\u8868</li> <li>MongoDB\u4e2d\u53f0: 4\u4e2a\u4e1a\u52a1\u6a21\u578b</li> </ul>"},{"location":"mongo2/20MongoDB_mico_middle_service/#mongodb_5","title":"MongoDB \u4e2d\u53f0\u5efa\u8bbe\u7b2c\u4e8c\u6b65:\u652f\u6491\u5199\u5165","text":"<p>\u8bf4\u660e</p> <ul> <li>\u4f7f\u7528\u5b9e\u65f6\u540c\u6b65\u6280\u672f\uff0c\u5c06 Oracle \u5185\u6240\u6709\u4e3b\u6570 \u636e(\u4ea7\u54c1\uff0c\u4f1a\u5458\u7b49)\u548c\u4ea4\u6613(\u8ba2\u5355\uff0c\u5e93\u5b58\uff0c \u65e5\u5fd7)\u6570\u636e\u590d\u5236\u5230 MongoDB\u3002</li> <li>\u5229\u7528\u7684 MongoDB \u7684\u7075\u6d3b\u6a21\u578b\u5feb\u901f\u6784\u5efa\u65b0 \u4e1a\u52a1\u9700\u8981\u7684\u4e1a\u52a1\u6a21\u578b\u3002</li> <li>\u901a\u8fc7\u4e2d\u53f0\u63d0\u4f9b\u7684 REST API \u4e3a\u5fae\u670d\u52a1\u63d0\u4f9b\u5546 \u54c1\u67e5\u8be2\uff0c\u68c0\u7d22\u53ca\u8ba2\u5355\u5904\u7406\u80fd\u529b</li> <li>\u8ba2\u5355\u5fae\u670d\u52a1\u63a5\u53d7\u8ba2\u5355\uff0c\u76f4\u63a5\u8c03\u7528\u4e2d\u53f0 API \u4fee\u6539\u5e93\u5b58\u3002</li> <li>\u4e2d\u53f0\u5c06\u5e93\u5b58\u4fee\u6539\u4fe1\u606f\u901a\u8fc7\u53cd\u5411 CDC \u53d1\u9001\u5230 \u9700\u8981\u7684\u539f\u4e1a\u52a1\u5e93\uff0c\u6bd4\u5982\u62a5\u8868\u7cfb\u7edf\u6216\u8005\u8ba2\u5355 \u901a\u77e5\u7cfb\u7edf</li> </ul> <p></p>"},{"location":"mongo2/20MongoDB_mico_middle_service/#system-of-records","title":"\u7b2c\u4e09\u9636\u6bb5:\u4f5c\u4e3a System of Records \u7684\u4e3b\u6570\u636e\u5e73\u53f0","text":"<ul> <li>\u8fde\u63a5\u4f01\u4e1a\u6570\u636e\u5b64\u5c9b</li> <li>\u6784\u5efa\u7edf\u4e00\u6570\u636e\u8d44\u4ea7\u4f53\u7cfb:\u5546\u54c1\uff0c\u4f1a\u5458\uff0c\u8ba2\u5355\u7b49</li> <li>\u4f01\u4e1a\u4e3b\u6570\u636e\u7684\u66f4\u65b0\u7edf\u4e00\u5728 \u4e2d\u53f0\u53d1\u751f\uff0c\u4fdd\u8bc1\u4e2d\u53f0\u6570\u636e \u7684\u6743\u5a01\u6027\uff0c\u4e00\u81f4\u6027\u548c\u53ef\u9760\u6027</li> </ul>"},{"location":"mongo2/20MongoDB_mico_middle_service/#_9","title":"\u6280\u672f\u67b6\u6784\u56fe","text":"<ul> <li>\u540c\u65f6\u652f\u6301\u4e2d\u6e2f\u7f8e\u4e09\u5730</li> <li>\u672a\u6765\u66f4\u591a\u5730\u533a\u652f\u6301</li> </ul>"},{"location":"mongo2/2mon_command/","title":"2 MongoDB \u57fa\u672c\u64cd\u4f5c\u53ca\u805a\u5408\u64cd\u4f5c\u5b9e\u6218","text":"<p>\u589e\u5220\u6539\u67e5\u64cd\u4f5c</p>"},{"location":"mongo2/2mon_command/#1-insert","title":"1 \u4f7f\u7528 insert \u5b8c\u6210\u63d2\u5165\u64cd\u4f5c","text":"<p>\u64cd\u4f5c\u683c\u5f0f:</p> <pre><code>db.&lt;\u96c6\u5408&gt;.insertOne(&lt;JSON\u5bf9\u8c61&gt;) \n\ndb.&lt;\u96c6\u5408&gt;.insertMany([&lt;JSON 1&gt;, &lt;JSON 2&gt;, ...&lt;JSON n&gt;])\n</code></pre> <p>\u793a\u4f8b:</p> <pre><code>db.fruit.insertOne({name: \"apple\"})\n</code></pre> <pre><code>db.fruit.insertMany([\n    {name: \"apple\"},\n    {name: \"pear\"},\n    {name: \"orange\"}\n])\n</code></pre>"},{"location":"mongo2/2mon_command/#find","title":"\u4f7f\u7528 find \u67e5\u8be2\u6587\u6863","text":""},{"location":"mongo2/2mon_command/#find_1","title":"\u5173\u4e8e find:","text":"<ul> <li>find \u662f MongoDB \u4e2d\u67e5\u8be2\u6570\u636e\u7684\u57fa\u672c\u6307\u4ee4\uff0c\u76f8\u5f53\u4e8e SQL \u4e2d\u7684 SELECT \u3002</li> <li>find \u8fd4\u56de\u7684\u662f\u6e38\u6807\u3002</li> </ul> <p>find \u793a\u4f8b:</p> <pre><code>db.movies.find( { \"year\" : 1975 } ) //\u5355\u6761\u4ef6\u67e5\u8be2\n\ndb.movies.find( { \"year\" : 1989, \"title\" : \"Batman\" } ) //\u591a\u6761\u4ef6and\u67e5\u8be2\n\ndb.movies.find( { $and : [ {\"title\" : \"Batman\"}, { \"category\" : \"action\" }] } ) // and\u7684\u53e6\u4e00\u79cd\u5f62\u5f0f \n\ndb.movies.find( { $or: [{\"year\" : 1989}, {\"title\" : \"Batman\"}] } ) //\u591a\u6761\u4ef6or\u67e5\u8be2 \n\ndb.movies.find( { \"title\" : /^B/} ) //\u6309\u6b63\u5219\u8868\u8fbe\u5f0f\u67e5\u627e\n</code></pre> <p>\u67e5\u8be2\u6761\u4ef6\u5bf9\u7167\u8868</p> <p></p> <p>\u67e5\u8be2\u903b\u8f91\u5bf9\u7167\u8868</p> <p></p> <p>\u67e5\u8be2\u903b\u8f91\u8fd0\u7b97\u7b26</p> <ul> <li><code>$lt</code>: \u5b58\u5728\u5e76\u5c0f\u4e8e</li> <li><code>$lte</code>: \u5b58\u5728\u5e76\u5c0f\u4e8e\u7b49\u4e8e</li> <li><code>$gt</code>: \u5b58\u5728\u5e76\u5927\u4e8e</li> <li><code>$gte</code>: \u5b58\u5728\u5e76\u5927\u4e8e\u7b49\u4e8e</li> <li><code>$ne</code>: \u4e0d\u5b58\u5728\u6216\u5b58\u5728\u4f46\u4e0d\u7b49\u4e8e</li> <li><code>$in</code>: \u5b58\u5728\u5e76\u5728\u6307\u5b9a\u6570\u7ec4\u4e2d</li> <li><code>$nin</code>: \u4e0d\u5b58\u5728\u6216\u4e0d\u5728\u6307\u5b9a\u6570\u7ec4\u4e2d</li> <li><code>$or</code>: \u5339\u914d\u4e24\u4e2a\u6216\u591a\u4e2a\u6761\u4ef6\u4e2d\u7684\u4e00\u4e2a</li> <li><code>$and</code>: \u5339\u914d\u5168\u90e8\u6761\u4ef6</li> </ul> <p>\u4f7f\u7528 find \u641c\u7d22\u5b50\u6587\u6863</p> <ul> <li>find \u652f\u6301\u4f7f\u7528 <code>field.sub_field</code> \u7684\u5f62\u5f0f\u67e5\u8be2\u5b50\u6587\u6863\u3002\u5047\u8bbe\u6709\u4e00\u4e2a\u6587\u6863:</li> </ul> <pre><code> db.fruit.insertOne({\n        name: \"apple\",\n        from: {\n            country: \"China\",\n            province: \"Guangdon\"\n} })\n</code></pre> <p>\u8003\u8651\u4ee5\u4e0b\u67e5\u8be2\u7684\u610f\u4e49:</p> <pre><code>db.fruit.find( { \"from.country\" : \"China\" } )\n</code></pre> <pre><code>&gt; db.fruit.find( { \"from.country\" : \"China\" } )\n{ \"_id\" : ObjectId(\"626d0d3c23c7ad7cc7cb0e40\"), \"name\" : \"apple\", \"from\" : { \"country\" : \"China\", \"province\" : \"Guangdon\" } }\n</code></pre> <pre><code>db.fruit.find( { \"from\" : {country: \"China\"} } )\n&gt;\n</code></pre> <p>Nothing</p>"},{"location":"mongo2/2mon_command/#find_2","title":"\u4f7f\u7528 find \u641c\u7d22\u6570\u7ec4","text":"<p>find \u652f\u6301\u5bf9\u6570\u7ec4\u4e2d\u7684\u5143\u7d20\u8fdb\u884c\u641c\u7d22\u3002\u5047\u8bbe\u6709\u4e00\u4e2a\u6587\u6863:</p> <pre><code> db.fruit.insert([\n      { \"name\" : \"Apple\", color: [\"red\", \"green\" ] },\n      { \"name\" : \"Mango\", color: [\"yellow\", \"green\"] }\n])\n</code></pre> <p>\u8003\u8651\u4ee5\u4e0b\u67e5\u8be2\u7684\u610f\u4e49:</p> <pre><code>&gt; db.fruit.find({color: \"red\"})\n{ \"_id\" : ObjectId(\"626d19c123c7ad7cc7cb0e41\"), \"name\" : \"Apple\", \"color\" : [ \"red\", \"green\" ] }\n</code></pre> <pre><code>db.fruit.find({$or: [{color: \"red\"}, {color: \"yellow\"}]} )\n</code></pre> <pre><code>{ \"_id\" : ObjectId(\"626d19c123c7ad7cc7cb0e41\"), \"name\" : \"Apple\", \"color\" : [ \"red\", \"green\" ] }\n{ \"_id\" : ObjectId(\"626d19c123c7ad7cc7cb0e42\"), \"name\" : \"Mango\", \"color\" : [ \"yellow\", \"green\" ] }\n</code></pre>"},{"location":"mongo2/2mon_command/#find_3","title":"\u4f7f\u7528 find \u641c\u7d22\u6570\u7ec4\u4e2d\u7684\u5bf9\u8c61","text":"<p>\u8003\u8651\u4ee5\u4e0b\u6587\u6863\uff0c\u5728\u5176\u4e2d\u641c\u7d22</p> <pre><code>db.movies.insertOne( {\n          \"title\" : \"Raiders of the Lost Ark\",\n          \"filming_locations\" : [\n              { \"city\" : \"Los Angeles\", \"state\" : \"CA\", \"country\" : \"USA\" },  \n              { \"city\" : \"Rome\", \"state\" : \"Lazio\", \"country\" : \"Italy\" },\n              { \"city\" : \"Florence\", \"state\" : \"SC\", \"country\" : \"USA\" }\n          ]\n})\n</code></pre> <pre><code>// \u67e5\u627e\u57ce\u5e02\u662f Rome \u7684\u8bb0\u5f55\ndb.movies.find({\"filming_locations.city\": \"Rome\"})\n</code></pre> <pre><code>{ \"_id\" : ObjectId(\"626d1f1323c7ad7cc7cb0e43\"), \"title\" : \"Raiders of the Lost Ark\", \"filming_locations\" : [ { \"city\" : \"Los Angeles\", \"state\" : \"CA\", \"country\" : \"USA\" }, { \"city\" : \"Rome\", \"state\" : \"Lazio\", \"country\" : \"Italy\" }, { \"city\" : \"Florence\", \"state\" : \"SC\", \"country\" : \"USA\" } ] }\n</code></pre>"},{"location":"mongo2/2mon_command/#find_4","title":"\u4f7f\u7528 find \u641c\u7d22\u6570\u7ec4\u4e2d\u7684\u5bf9\u8c61","text":"<p>\u5728\u6570\u7ec4\u4e2d\u641c\u7d22\u5b50\u5bf9\u8c61\u7684\u591a\u4e2a\u5b57\u6bb5\u65f6\uff0c\u5982\u679c\u4f7f\u7528 <code>$elemMatch</code>\uff0c\u5b83\u8868\u793a\u5fc5\u987b\u662f\u540c\u4e00\u4e2a \u5b50\u5bf9\u8c61\u6ee1\u8db3\u591a\u4e2a\u6761\u4ef6\u3002\u8003\u8651\u4ee5\u4e0b\u4e24\u4e2a\u67e5\u8be2:</p> <pre><code> db.getCollection('movies').find({\n       \"filming_locations.city\": \"Rome\",\n       \"filming_locations.country\": \"USA\"\n      })\n</code></pre> <pre><code>{ \"_id\" : ObjectId(\"626d1f1323c7ad7cc7cb0e43\"), \"title\" : \"Raiders of the Lost Ark\", \"filming_locations\" : [ { \"city\" : \"Los Angeles\", \"state\" : \"CA\", \"country\" : \"USA\" }, { \"city\" : \"Rome\", \"state\" : \"Lazio\", \"country\" : \"Italy\" }, { \"city\" : \"Florence\", \"state\" : \"SC\", \"country\" : \"USA\" } ] }\n</code></pre> <pre><code> db.getCollection('movies').find({\n       \"filming_locations\": {\n       $elemMatch:{\"city\":\"Rome\", \"country\": \"USA\"}\n} })\n</code></pre>"},{"location":"mongo2/2mon_command/#find_5","title":"\u63a7\u5236 find \u8fd4\u56de\u7684\u5b57\u6bb5","text":"<ul> <li><code>find</code>\u53ef\u4ee5\u6307\u5b9a\u53ea\u8fd4\u56de\u6307\u5b9a\u7684\u5b57\u6bb5;</li> <li><code>_id</code>\u5b57\u6bb5\u5fc5\u987b\u660e\u786e\u6307\u660e\u4e0d\u8fd4\u56de\uff0c\u5426\u5219\u9ed8\u8ba4\u8fd4\u56de;</li> <li>\u5728 MongoDB \u4e2d\u6211\u4eec\u79f0\u8fd9\u4e3a\u6295\u5f71(projection);</li> <li><code>db.movies.find({\"category\": \"action\"},{\"_id\":0, title:1})</code><ul> <li><code>\"_id\":0</code> :  \u4e0d\u8fd4\u56de<code>_id</code></li> <li><code>title:1</code>: \u8fd4\u56detitle </li> </ul> </li> </ul>"},{"location":"mongo2/2mon_command/#remove","title":"\u4f7f\u7528 remove \u5220\u9664\u6587\u6863","text":"<ul> <li>remove \u547d\u4ee4\u9700\u8981\u914d\u5408\u67e5\u8be2\u6761\u4ef6\u4f7f\u7528;</li> <li>\u5339\u914d\u67e5\u8be2\u6761\u4ef6\u7684\u7684\u6587\u6863\u4f1a\u88ab\u5220\u9664;</li> <li>\u6307\u5b9a\u4e00\u4e2a\u7a7a\u6587\u6863\u6761\u4ef6\u4f1a\u5220\u9664\u6240\u6709\u6587\u6863;</li> <li>\u4ee5\u4e0b\u793a\u4f8b:</li> </ul> <pre><code>db.testcol.remove( { a : 1 } ) // \u5220\u9664a \u7b49\u4e8e1\u7684\u8bb0\u5f55 \n\ndb.testcol.remove( { a : { $lt : 5 } } ) // \u5220\u9664a \u5c0f\u4e8e5\u7684\u8bb0\u5f55 \n\ndb.testcol.remove( { } ) // \u5220\u9664\u6240\u6709\u8bb0\u5f55 db.testcol.remove() //\u62a5\u9519\n\ndb.testcol.remove() //\u62a5\u9519\n</code></pre>"},{"location":"mongo2/2mon_command/#update","title":"\u4f7f\u7528 update \u66f4\u65b0\u6587\u6863","text":"<p>Update \u64cd\u4f5c\u6267\u884c\u683c\u5f0f:<code>db.&lt;\u96c6\u5408&gt;.update(&lt;\u67e5\u8be2\u6761\u4ef6&gt;, &lt;\u66f4\u65b0\u5b57\u6bb5&gt;)</code></p> <p>\u4ee5\u4ee5\u4e0b\u6570\u636e\u4e3a\u4f8b:</p> <pre><code>  db.fruit.insertMany([\n        {name: \"apple\"},\n        {name: \"pear\"},\n        {name: \"orange\"}\n])\n</code></pre> <pre><code>db.fruit.updateOne({name: \"apple\"}, {$set: {from: \"China\"}})\n</code></pre> <ul> <li>\u67e5\u8be2 name \u4e3a apple \u7684\u8bb0\u5f55</li> <li>\u5c06\u627e\u5230\u8bb0\u5f55\u7684 from \u8bbe\u7f6e\u4e3a China</li> </ul> <pre><code>&gt; db.fruit.updateOne({name: \"apple\"}, {$set: {from: \"China\"}})\n{ \"acknowledged\" : true, \"matchedCount\" : 1, \"modifiedCount\" : 1 }\n</code></pre> <pre><code>&gt; db.fruit.find({name: \"apple\"}).pretty()\n{\n    \"_id\" : ObjectId(\"626d26f023c7ad7cc7cb0e44\"),\n    \"name\" : \"apple\",\n    \"from\" : \"China\"\n}\n</code></pre>"},{"location":"mongo2/2mon_command/#update_1","title":"\u4f7f\u7528 update \u66f4\u65b0\u6587\u6863","text":"<ul> <li>\u4f7f\u7528 updateOne \u8868\u793a\u65e0\u8bba\u6761\u4ef6\u5339\u914d\u591a\u5c11\u6761\u8bb0\u5f55\uff0c\u59cb\u7ec8\u53ea\u66f4\u65b0\u7b2c\u4e00\u6761;</li> <li>\u4f7f\u7528 updateMany \u8868\u793a\u6761\u4ef6\u5339\u914d\u591a\u5c11\u6761\u5c31\u66f4\u65b0\u591a\u5c11\u6761;</li> <li><code>updateOne/updateMany</code> \u65b9\u6cd5\u8981\u6c42\u66f4\u65b0\u6761\u4ef6\u90e8\u5206\u5fc5\u987b\u5177\u6709\u4ee5\u4e0b\u4e4b\u4e00\uff0c\u5426\u5219\u5c06\u62a5\u9519:<ul> <li><code>$set/$unset</code></li> <li><code>$push/$pushAll/$pop</code></li> <li><code>$pull/$pullAll</code></li> <li><code>$addToSet</code></li> </ul> </li> </ul> <pre><code>db.fruit.updateOne({name: \"apple\"}, {from: \"China\"})\n</code></pre> <pre><code>// \u62a5\u9519\nuncaught exception: Error: the update operation document must contain atomic operators :\nDBCollection.prototype.updateOne@src/mongo/shell/crud_api.js:565:19\n@(shell):1:1\n</code></pre>"},{"location":"mongo2/2mon_command/#update_2","title":"\u4f7f\u7528 update \u66f4\u65b0\u6570\u7ec4","text":"<ul> <li><code>$push</code>: \u589e\u52a0\u4e00\u4e2a\u5bf9\u8c61\u5230\u6570\u7ec4\u5e95\u90e8</li> <li><code>$pushAll</code>: \u589e\u52a0\u591a\u4e2a\u5bf9\u8c61\u5230\u6570\u7ec4\u5e95\u90e8</li> <li><code>$pop</code>: \u4ece\u6570\u7ec4\u5e95\u90e8\u5220\u9664\u4e00\u4e2a\u5bf9\u8c61</li> <li><code>$pull</code>: \u5982\u679c\u5339\u914d\u6307\u5b9a\u7684\u503c\uff0c\u4ece\u6570\u7ec4\u4e2d\u5220\u9664\u76f8\u5e94\u7684\u5bf9\u8c61</li> <li><code>$pullAll</code>: \u5982\u679c\u5339\u914d\u4efb\u610f\u7684\u503c\uff0c\u4ece\u6570\u636e\u4e2d\u5220\u9664\u76f8\u5e94\u7684\u5bf9\u8c61</li> <li><code>$addToSet</code>: \u5982\u679c\u4e0d\u5b58\u5728\u5219\u589e\u52a0\u4e00\u4e2a\u503c\u5230\u6570\u7ec4</li> </ul>"},{"location":"mongo2/2mon_command/#drop","title":"\u4f7f\u7528 drop \u5220\u9664\u96c6\u5408","text":"<ul> <li>\u4f7f\u7528 <code>db.&lt;\u96c6\u5408&gt;.drop()</code> \u6765\u5220\u9664\u4e00\u4e2a\u96c6\u5408</li> <li>\u96c6\u5408\u4e2d\u7684\u5168\u90e8\u6587\u6863\u90fd\u4f1a\u88ab\u5220\u9664</li> <li>\u96c6\u5408\u76f8\u5173\u7684\u7d22\u5f15\u4e5f\u4f1a\u88ab\u5220\u9664</li> </ul> <pre><code>db.colToBeDropped.drop()\n</code></pre> <pre><code>&gt; db.fruit.drop()\ntrue\n</code></pre>"},{"location":"mongo2/2mon_command/#dropdatabase","title":"\u4f7f\u7528 dropDatabase \u5220\u9664\u6570\u636e\u5e93","text":"<ul> <li>\u4f7f\u7528 <code>db.dropDatabase()</code> \u6765\u5220\u9664\u6570\u636e\u5e93</li> <li>\u6570\u636e\u5e93\u76f8\u5e94\u6587\u4ef6\u4e5f\u4f1a\u88ab\u5220\u9664\uff0c\u78c1\u76d8\u7a7a\u95f4\u5c06\u88ab\u91ca\u653e</li> </ul> <pre><code>use tempDB\n\ndb.dropDatabase()\n\nshow collections // No collections\nshow dbs // The db is gone\n</code></pre>"},{"location":"mongo2/2mon_command/#2-hello-world-python","title":"2 Hello World \u7a0b\u5e8f\u5f00\u53d1\uff08Python)","text":""},{"location":"mongo2/2mon_command/#2-1-python-mongodb","title":"2-1 \u5b89\u88c5 Python MongoDB \u9a71\u52a8\u7a0b\u5e8f","text":"<p>\u5b89\u88c5 MongoDB \u9a71\u52a8</p> <p>\u5728 Python \u4e2d\u4f7f\u7528 MongoDB \u4e4b\u524d\u5fc5\u987b\u5148\u5b89\u88c5\u7528\u4e8e\u8bbf\u95ee\u6570\u636e\u5e93\u7684\u9a71\u52a8\u7a0b\u5e8f:</p> <p><code>pip install pymongo</code></p> <p>\u68c0\u67e5\u9a71\u52a8\u7a0b\u5e8f</p> <p>\u5728 python \u4ea4\u4e92\u6a21\u5f0f\u4e0b\u5bfc\u5165 pymongo\uff0c\u68c0\u67e5\u9a71\u52a8\u662f\u5426\u5df2\u6b63\u786e\u5b89\u88c5:</p> <pre><code>import pymongo \n\npymongo.version\n</code></pre>"},{"location":"mongo2/2mon_command/#2-2","title":"2-2 \u521b\u5efa\u8fde\u63a5","text":"<p>\u786e\u5b9a MongoDB \u8fde\u63a5\u4e32</p> <p>\u4f7f\u7528\u9a71\u52a8\u8fde\u63a5\u5230 MongoDB \u96c6\u7fa4\u53ea\u9700\u8981\u6307\u5b9a MongoDB \u8fde\u63a5\u5b57\u7b26\u4e32\u5373\u53ef\u3002\u5176\u57fa\u672c\u683c\u5f0f\u53ef \u4ee5\u53c2\u8003\u6587\u6863: Connection String URI Format \u6700\u7b80\u5355\u7684\u5f62\u5f0f\u662f</p> <ul> <li><code>mongodb://\u6570\u636e\u5e93\u670d\u52a1\u5668\u4e3b\u673a\u5730\u5740:\u7aef\u53e3\u53f7</code></li> <li>\u5982:<code>mongodb://127.0.0.1:27017</code></li> </ul> <p>\u521d\u59cb\u5316\u6570\u636e\u5e93\u8fde\u63a5</p> <pre><code>from pymongo import MongoClient\nuri = \"mongodb://192.168.1.44:27017\"\nclient = MongoClient(uri)\nprint(client)\n</code></pre> <pre><code>$ python3 mongo.py \nMongoClient(host=['192.168.1.44:27017'], document_class=dict, tz_aware=False, connect=True)\n</code></pre>"},{"location":"mongo2/2mon_command/#2-3","title":"2-3 \u6570\u636e\u5e93\u64cd\u4f5c:\u63d2\u5165\u7528\u6237","text":"<p>\u521d\u59cb\u5316\u6570\u636e\u5e93\u548c\u96c6\u5408</p> <pre><code>db = client[\"eshop\"] \nuser_coll = db[\"users\"]\n</code></pre> <p>\u63d2\u5165\u4e00\u6761\u65b0\u7684\u7528\u6237\u6570\u636e</p> <pre><code>new_user = {\"username\": \"nina\", \"password\": \"xxxx\", \"email\":\n      \"123456@qq.com \"}\nresult = user_coll.insert_one(new_user)\nprint result\n</code></pre> <pre><code>from pymongo import MongoClient\nuri = \"mongodb://192.168.1.44:27017\"\nclient = MongoClient(uri)\ndb = client[\"eshop\"]\nuser_coll = db[\"users\"]\nnew_user = {\"username\":\"nina\", \"password\":\"xxxx\", \"email\": \"123456@qq.com\"}\nresult = user_coll.insert_one(new_user)\n\nresult\n</code></pre> <pre><code>show dbs;\nadmin     0.000GB\naggdemo   0.000GB\nappdb     0.001GB\nconfig    0.000GB\neshop     0.000GB\n...\n\n&gt; use eshop;\nswitched to db eshop\n\n&gt; show collections;\nusers\n&gt; db.users.find()\n{ \"_id\" : ObjectId(\"626d3ec17157426c6e22abcf\"), \"username\" : \"nina\", \"password\" : \"xxxx\", \"email\" : \"123456@qq.com\" }\n</code></pre> <p>\u6ce8\u610f:\u6211\u4eec\u5e76\u6ca1\u6709\u63d0\u524d\u521b\u5efa\u6570\u636e\u5e93\u548c\u8868/\u96c6\u5408</p>"},{"location":"mongo2/2mon_command/#2-4","title":"2-4 \u66f4\u65b0\u7528\u6237","text":"<p>\u9700\u6c42\u53d8\u5316\uff0c\u8981\u6c42\u4fee\u6539\u7528\u6237\u5c5e\u6027\uff0c\u589e\u52a0\u5b57\u6bb5phone</p> <pre><code>result = user_coll.update_one({ \"username\": \"nina\"}, \n         { \"$set\": { \"phone\": \"123456789\"} }\n        )\n      print result\n</code></pre> <p>\u6ce8\u610f:\u6211\u4eec\u5e76\u6ca1\u6709\u53bb\u6570\u636e\u5e93\u4fee\u6539\u8868\u7ed3\u6784</p> <pre><code>from pymongo import MongoClient\nuri = \"mongodb://192.168.1.44:27017\"\nclient = MongoClient(uri)\n\ndb = client[\"eshop\"]\nuser_coll = db[\"users\"]\n# new_user = {\"username\":\"nina\", \"password\":\"xxxx\", \"email\": \"123456@qq.com\"}\n# result = user_coll.insert_one(new_user)\n\nresult = user_coll.update_one({\"username\": \"nina\"},\n    { \"$set\": { \"phone\": \"123456789\"} }\n)\nresult\n</code></pre> <pre><code>&gt; db.users.find()\n{ \"_id\" : ObjectId(\"626d3ec17157426c6e22abcf\"), \"username\" : \"nina\", \"password\" : \"xxxx\", \"email\" : \"123456@qq.com\", \"phone\" : \"123456789\" }\n</code></pre>"},{"location":"mongo2/2mon_command/#2-5","title":"2-5 \u603b\u7ed3","text":"<ul> <li>\u4f7f\u7528 MongoDB \u9a71\u52a8\u7a0b\u5e8f\u64cd\u4f5c MongoDB \u7684 API \u7b80\u5355\u6613\u884c\u3002</li> <li>\u5c3d\u7ba1\u5927\u5bb6\u4f7f\u7528\u7684\u7f16\u7a0b\u8bed\u8a00\u53ef\u80fd\u5404\u4e0d\u76f8\u540c\uff0c\u4f46 MongoDB \u9a71\u52a8\u7684\u8bbe\u8ba1\u662f\u4f9d\u7167\u7edf\u4e00\u7684\u89c4 \u8303\u5236\u5b9a\uff0c\u65e0\u8bba\u4f7f\u7528\u54ea\u79cd\u8bed\u8a00\uff0c\u5176\u539f\u7406\u548c API \u65b9\u6cd5\u90fd\u975e\u5e38\u76f8\u4f3c\u3002\u56e0\u6b64\u53ea\u8981\u638c\u63e1\u4e00\u79cd\u8bed \u8a00\u7684\u9a71\u52a8\uff0c\u5207\u6362\u5230\u5176\u4ed6\u8bed\u8a00\u5c06\u5341\u5206\u5bb9\u6613\u3002</li> </ul>"},{"location":"mongo2/2mon_command/#3","title":"3 \u805a\u5408\u67e5\u8a62","text":""},{"location":"mongo2/2mon_command/#3-1-mongodb","title":"3-1 \u4ec0\u4e48\u662f MongoDB \u805a\u5408\u6846\u67b6","text":"<p>MongoDB \u805a\u5408\u6846\u67b6(Aggregation Framework)\u662f\u4e00\u4e2a\u8ba1\u7b97\u6846\u67b6\uff0c\u5b83\u53ef\u4ee5:</p> <ul> <li>\u4f5c\u7528\u5728\u4e00\u4e2a\u6216\u51e0\u4e2a\u96c6\u5408\u4e0a;</li> <li>\u5bf9\u96c6\u5408\u4e2d\u7684\u6570\u636e\u8fdb\u884c\u7684\u4e00\u7cfb\u5217\u8fd0\u7b97;</li> <li>\u5c06\u8fd9\u4e9b\u6570\u636e\u8f6c\u5316\u4e3a\u671f\u671b\u7684\u5f62\u5f0f;</li> </ul> <p>\u4ece\u6548\u679c\u800c\u8a00\uff0c\u805a\u5408\u6846\u67b6\u76f8\u5f53\u4e8e SQL \u67e5\u8be2\u4e2d\u7684:</p> <ul> <li>GROUP BY</li> <li>LEFT OUTER JOIN</li> <li>AS\u7b49</li> </ul>"},{"location":"mongo2/2mon_command/#3-2-pipelinestage","title":"3-2 \u7ba1\u9053(Pipeline)\u548c\u6b65\u9aa4(Stage)","text":"<p>\u6574\u4e2a\u805a\u5408\u8fd0\u7b97\u8fc7\u7a0b\u79f0\u4e3a\u7ba1\u9053(Pipeline)\uff0c\u5b83\u662f\u7531\u591a\u4e2a\u6b65\u9aa4(Stage)\u7ec4\u6210\u7684\uff0c \u6bcf\u4e2a\u7ba1\u9053:</p> <ul> <li>\u63a5\u53d7\u4e00\u7cfb\u5217\u6587\u6863(\u539f\u59cb\u6570\u636e);</li> <li>\u6bcf\u4e2a\u6b65\u9aa4\u5bf9\u8fd9\u4e9b\u6587\u6863\u8fdb\u884c\u4e00\u7cfb\u5217\u8fd0\u7b97;</li> <li>\u7ed3\u679c\u6587\u6863\u8f93\u51fa\u7ed9\u4e0b\u4e00\u4e2a\u6b65\u9aa4</li> </ul> <p></p> <p>\u805a\u5408\u8fd0\u7b97\u7684\u57fa\u672c\u683c\u5f0f</p> <pre><code>pipeline = [$stage1, $stage2, ...$stageN];\n\ndb.&lt;COLLECTION&gt;.aggregate(\n       pipeline,\n{ options } );\n</code></pre> <p>\u5e38\u89c1\u6b65\u9aa4</p> <p></p> <p>\u5e38\u89c1\u6b65\u9aa4\u4e2d\u7684\u8fd0\u7b97\u7b26</p> <p></p> <p>\u5e38\u89c1\u6b65\u9aa4</p> <p></p>"},{"location":"mongo2/2mon_command/#3-3","title":"3-3 \u805a\u5408\u8fd0\u7b97\u7684\u4f7f\u7528\u573a\u666f","text":"<p>\u805a\u5408\u67e5\u8be2\u53ef\u4ee5\u7528\u4e8eOLAP\u548cOLTP\u573a\u666f\u3002\u4f8b\u5982:</p> <p></p>"},{"location":"mongo2/2mon_command/#3-4-mql-sql","title":"3-4 MQL \u5e38\u7528\u6b65\u9aa4\u4e0e SQL \u5bf9\u6bd4","text":"<pre><code>SELECT\nFIRST_NAME AS `\u540d`, LAST_NAME AS `\u59d3`\nFROM Users\nWHERE GENDER = '\u7537'\nSKIP 100 LIMIT 20\n</code></pre> <pre><code>db.users.aggregate([\n            {$match: {gender: \u2019\u2019\u7537\u201d}},\n            {$skip: 100}, \n            {$limit: 20}, \n            {$project: {\n                    '\u540d': '$first_name', \n                    '\u59d3': '$last_name'\n       }} \n ]);\n</code></pre> <pre><code>SELECT DEPARTMENT, \n    COUNT(NULL) AS EMP_QTY\nFROM Users\nWHERE GENDER = '\u5973'\nGROUP BY DEPARTMENT \nHAVING COUNT(*) &lt; 10\n</code></pre> <pre><code>db.users.aggregate([\n    {$match: {gender: '\u5973'}},\n    {$group: {\n        _id: '$DEPARTMENT\u2019, \n        emp_qty: {$sum: 1}\n    }},\n    {$match: {emp_qty: {$lt: 10}}}\n ]);\n</code></pre>"},{"location":"mongo2/2mon_command/#mql-unwind","title":"MQL \u7279\u6709\u6b65\u9aa4 <code>$unwind</code>","text":"<pre><code>db.students.insertOne(\n{\n    name:'\u5f20\u4e09', \n    score:[\n        {subject:'\u8bed\u6587',score:84},\n        {subject:'\u6570\u5b66',score:90}, \n        {subject:'\u5916\u8bed',score:69}\n]\n})\n</code></pre> <pre><code>&gt; db.students.findOne()\n{\n    \"_id\" : ObjectId(\"626dead023c7ad7cc7cb0e47\"),\n    \"name\" : \"\u5f20\u4e09\",\n    \"score\" : [\n        {\n            \"subject\" : \"\u8bed\u6587\",\n            \"score\" : 84\n        },\n        {\n            \"subject\" : \"\u6570\u5b66\",\n            \"score\" : 90\n        },\n        {\n            \"subject\" : \"\u5916\u8bed\",\n            \"score\" : 69\n        }\n    ]\n}\n</code></pre> <pre><code>db.students.aggregate([{$unwind: '$score'}]) \n\n{ \"_id\" : ObjectId(\"626dead023c7ad7cc7cb0e47\"), \"name\" : \"\u5f20\u4e09\", \"score\" : { \"subject\" : \"\u8bed\u6587\", \"score\" : 84 } }\n{ \"_id\" : ObjectId(\"626dead023c7ad7cc7cb0e47\"), \"name\" : \"\u5f20\u4e09\", \"score\" : { \"subject\" : \"\u6570\u5b66\", \"score\" : 90 } }\n{ \"_id\" : ObjectId(\"626dead023c7ad7cc7cb0e47\"), \"name\" : \"\u5f20\u4e09\", \"score\" : { \"subject\" : \"\u5916\u8bed\", \"score\" : 69 } }\n</code></pre>"},{"location":"mongo2/2mon_command/#mql-bucket","title":"MQL \u7279\u6709\u6b65\u9aa4 <code>$bucket</code>","text":"<pre><code>db.products.aggregate([{ \n    $bucket:{\n        groupBy: \"$price\", \n        boundaries: [0,10,20,30,40], \n        default: \"Other\", \n        output:{\"count\":{$sum:1}}\n} \n}])\n</code></pre>"},{"location":"mongo2/2mon_command/#mql-facet","title":"MQL \u7279\u6709\u6b65\u9aa4 <code>$facet</code>","text":"<pre><code>db.products.aggregate([{ \n    $facet:{\n        price:{ \n            $bucket:{...}\n        }, year:{\n            $bucket:{...} \n        }\n    } \n}])\n</code></pre>"},{"location":"mongo2/2mon_command/#3_1","title":"3 \u805a\u5408\u67e5\u8be2\u5b9e\u9a8c","text":"<p>\u805a\u5408\u5b9e\u9a8c\u6570\u636e\u6a21\u578b</p> <p></p>"},{"location":"mongo2/2mon_command/#3-1","title":"3-1 \u805a\u5408\u5b9e\u9a8c\u4e00:\u603b\u9500\u91cf","text":"<p>\u8ba1\u7b97\u5230\u76ee\u524d\u4e3a\u6b62\u7684\u6240\u6709\u8ba2\u5355\u7684\u603b\u9500\u552e\u989d</p> <pre><code>db.orders.aggregate([\n    { $group: \n        {\n            _id: null,\n            total: { $sum: \"$total\" }\n          }\n    } \n])\n</code></pre> <pre><code>{ \"_id\" : null, \"total\" : NumberDecimal(\"44019609\") }\n</code></pre>"},{"location":"mongo2/2mon_command/#3-2","title":"3-2 \u805a\u5408\u5b9e\u9a8c\u4e8c:\u8ba2\u5355\u91d1\u989d\u6c47\u603b","text":"<p>\u67e5\u8be22019\u5e74\u7b2c\u4e00\u5b63\u5ea6(1\u67081\u65e5~3\u670831\u65e5)\u5df2\u5b8c\u6210\u8ba2\u5355(completed)\u7684\u8ba2\u5355\u603b\u91d1 \u989d\u548c\u8ba2\u5355\u603b\u6570</p> <pre><code>db.orders.aggregate([ \n            // \u6b65\u9aa41:\u5339\u914d\u6761\u4ef6\n            { $match: { status: \"completed\", orderDate: {\n                                            $gte: ISODate(\"2019-01-01\"),\n                                        $lt: ISODate(\"2019-04-01\") } } }, \n         // \u6b65\u9aa4\u4e8c:\u805a\u5408\u8ba2\u5355\u603b\u91d1\u989d\u3001\u603b\u8fd0\u8d39\u3001\u603b\u6570\u91cf\n            { $group: {\n                       _id: null,\n                      total: { $sum: \"$total\" },\n                      shippingFee: { $sum: \"$shippingFee\" },\n                      count: { $sum: 1 }  } },\n        { $project: {\n        // \u8ba1\u7b97\u603b\u91d1\u989d\n        grandTotal: { $add: [\"$total\", \"$shippingFee\"] }, \n        count: 1,\n        _id: 0 } }\n])\n</code></pre> <pre><code>{ \"count\" : 5875, \"grandTotal\" : NumberDecimal(\"2636376.00\") }\n</code></pre>"},{"location":"mongo2/2mon_command/#3-3-run-with-compass-aggregation","title":"3-3 Run with compass Aggregation","text":"<p><code>$match</code></p> <pre><code>{status: \"completed\", \norderDate: {\n    $gte: ISODate(\"2019-01-01\"),\n        $lt: ISODate(\"2019-04-01\") \n  } \n} \n</code></pre> <p></p> <p><code>$group</code></p> <pre><code>{\n   _id: null,\n  total: { $sum: \"$total\" },\n  shippingFee: { $sum: \"$shippingFee\" },\n  count: { $sum: 1 }  \n} \n</code></pre> <p></p> <p><code>$group</code></p> <pre><code> {\n    // \u8ba1\u7b97\u603b\u91d1\u989d\n    grandTotal: { $add: [\"$total\", \"$shippingFee\"] }, \n    count: 1,\n    _id: 0 \n}\n</code></pre> <p></p> <p>Export: python3 and ....</p> <p></p>"},{"location":"mongo2/3mon_rep/","title":"3 \u590d\u5236\u96c6\u673a\u5236\u53ca\u539f\u7406 &amp; \u5b9e\u73b0","text":""},{"location":"mongo2/3mon_rep/#1","title":"1 \u590d\u5236\u96c6\u7684\u4f5c\u7528","text":"<ul> <li>MongoDB \u590d\u5236\u96c6\u7684\u4e3b\u8981\u610f\u4e49\u5728\u4e8e\u5b9e\u73b0\u670d\u52a1\u9ad8\u53ef\u7528</li> <li>\u5b83\u7684\u73b0\u5b9e\u4f9d\u8d56\u4e8e\u4e24\u4e2a\u65b9\u9762\u7684\u529f\u80fd:<ul> <li>\u6570\u636e\u5199\u5165\u65f6\u5c06\u6570\u636e\u8fc5\u901f\u590d\u5236\u5230\u53e6\u4e00\u4e2a\u72ec\u7acb\u8282\u70b9\u4e0a</li> <li>\u5728\u63a5\u53d7\u5199\u5165\u7684\u8282\u70b9\u53d1\u751f\u6545\u969c\u65f6\u81ea\u52a8\u9009\u4e3e\u51fa\u4e00\u4e2a\u65b0\u7684\u66ff\u4ee3\u8282\u70b9</li> </ul> </li> </ul>"},{"location":"mongo2/3mon_rep/#_1","title":"\u590d\u5236\u96c6\u7684\u4f5c\u7528","text":"<p>\u5728\u5b9e\u73b0\u9ad8\u53ef\u7528\u7684\u540c\u65f6\uff0c\u590d\u5236\u96c6\u5b9e\u73b0\u4e86\u5176\u4ed6\u51e0\u4e2a\u9644\u52a0\u4f5c\u7528:</p> <ul> <li>\u6570\u636e\u5206\u53d1: \u5c06\u6570\u636e\u4ece\u4e00\u4e2a\u533a\u57df\u590d\u5236\u5230\u53e6\u4e00\u4e2a\u533a\u57df\uff0c\u51cf\u5c11\u53e6\u4e00\u4e2a\u533a\u57df\u7684\u8bfb\u5ef6\u8fdf</li> <li>\u8bfb\u5199\u5206\u79bb:\u4e0d\u540c\u7c7b\u578b\u7684\u538b\u529b\u5206\u522b\u5728\u4e0d\u540c\u7684\u8282\u70b9\u4e0a\u6267\u884c</li> <li>\u5f02\u5730\u5bb9\u707e:\u5728\u6570\u636e\u4e2d\u5fc3\u6545\u969c\u65f6\u5019\u5feb\u901f\u5207\u6362\u5230\u5f02\u5730</li> </ul> <p>\u5178\u578b\u590d\u5236\u96c6\u7ed3\u6784</p> <p>\u4e00\u4e2a\u5178\u578b\u7684\u590d\u5236\u96c6\u75313\u4e2a\u4ee5\u4e0a\u5177\u6709\u6295\u7968\u6743\u7684\u8282\u70b9\u7ec4\u6210\uff0c\u5305\u62ec:</p> <ul> <li>\u4e00\u4e2a\u4e3b\u8282\u70b9(PRIMARY): \u63a5\u53d7\u5199\u5165\u64cd\u4f5c\u548c\u9009\u4e3e\u65f6\u6295\u7968</li> <li>\u4e24\u4e2a(\u6216\u591a\u4e2a)\u4ece\u8282\u70b9(SECONDARY): \u590d\u5236\u4e3b\u8282\u70b9\u4e0a\u7684\u65b0\u6570\u636e\u548c\u9009\u4e3e\u65f6\u6295\u7968 </li> <li>\u4e0d\u63a8\u8350\u4f7f\u7528 Arbiter(\u6295\u7968\u8282\u70b9)</li> </ul> <p></p>"},{"location":"mongo2/3mon_rep/#_2","title":"\u6570\u636e\u662f\u5982\u4f55\u590d\u5236\u7684?","text":"<ul> <li>\u5f53\u4e00\u4e2a\u4fee\u6539\u64cd\u4f5c\uff0c\u65e0\u8bba\u662f\u63d2\u5165\u3001\u66f4\u65b0\u6216\u5220\u9664\uff0c\u5230\u8fbe\u4e3b\u8282\u70b9\u65f6\uff0c\u5b83\u5bf9\u6570\u636e\u7684\u64cd\u4f5c\u5c06\u88ab\u8bb0\u5f55\u4e0b\u6765(\u7ecf\u8fc7\u4e00\u4e9b\u5fc5\u8981\u7684\u8f6c\u6362)\uff0c\u8fd9\u4e9b\u8bb0\u5f55\u79f0\u4e3a oplog\u3002</li> <li>\u4ece\u8282\u70b9\u901a\u8fc7\u5728\u4e3b\u8282\u70b9\u4e0a\u6253\u5f00\u4e00\u4e2a tailable \u6e38\u6807\u4e0d\u65ad\u83b7\u53d6\u65b0\u8fdb\u5165\u4e3b\u8282\u70b9\u7684 oplog\uff0c\u5e76\u5728\u81ea\u5df1\u7684\u6570\u636e\u4e0a\u56de\u653e\uff0c\u4ee5\u6b64\u4fdd\u6301\u8ddf\u4e3b\u8282\u70b9\u7684\u6570\u636e\u4e00\u81f4\u3002</li> </ul>"},{"location":"mongo2/3mon_rep/#_3","title":"\u901a\u8fc7\u9009\u4e3e\u5b8c\u6210\u6545\u969c\u6062\u590d","text":"<ul> <li>\u5177\u6709\u6295\u7968\u6743\u7684\u8282\u70b9\u4e4b\u95f4\u4e24\u4e24\u4e92\u76f8\u53d1\u9001\u5fc3\u8df3;</li> <li>\u5f535\u6b21\u5fc3\u8df3\u672a\u6536\u5230\u65f6\u5224\u65ad\u4e3a\u8282\u70b9\u5931\u8054;</li> <li>\u5982\u679c\u5931\u8054\u7684\u662f\u4e3b\u8282\u70b9\uff0c\u4ece\u8282\u70b9\u4f1a\u53d1\u8d77\u9009\u4e3e\uff0c\u9009\u51fa\u65b0\u7684\u4e3b\u8282\u70b9;</li> <li>\u5982\u679c\u5931\u8054\u7684\u662f\u4ece\u8282\u70b9\u5219\u4e0d\u4f1a\u4ea7\u751f\u65b0\u7684\u9009\u4e3e;</li> <li>\u9009\u4e3e\u57fa\u4e8e RAFT\u4e00\u81f4\u6027\u7b97\u6cd5 \u5b9e\u73b0\uff0c\u9009\u4e3e\u6210\u529f\u7684\u5fc5\u8981\u6761\u4ef6\u662f\u5927\u591a\u6570\u6295\u7968\u8282\u70b9\u5b58\u6d3b;</li> <li>\u590d\u5236\u96c6\u4e2d\u6700\u591a\u53ef\u4ee5\u670950\u4e2a\u8282\u70b9\uff0c\u4f46\u5177\u6709\u6295\u7968\u6743\u7684\u8282\u70b9\u6700\u591a7\u4e2a\u3002</li> </ul> <p>\u5f71\u54cd\u9009\u4e3e\u7684\u56e0\u7d20</p> <ul> <li>\u6574\u4e2a\u96c6\u7fa4\u5fc5\u987b\u6709\u5927\u591a\u6570\u8282\u70b9\u5b58\u6d3b;</li> <li>\u88ab\u9009\u4e3e\u4e3a\u4e3b\u8282\u70b9\u7684\u8282\u70b9\u5fc5\u987b<ul> <li>\u80fd\u591f\u4e0e\u591a\u6570\u8282\u70b9\u5efa\u7acb\u8fde\u63a5</li> <li>\u5177\u6709\u8f83\u65b0\u7684 oplog</li> <li>\u5177\u6709\u8f83\u9ad8\u7684\u4f18\u5148\u7ea7(\u5982\u679c\u6709\u914d\u7f6e)</li> </ul> </li> </ul>"},{"location":"mongo2/3mon_rep/#_4","title":"\u5e38\u89c1\u9009\u9879","text":"<p>\u590d\u5236\u96c6\u8282\u70b9\u6709\u4ee5\u4e0b\u5e38\u89c1\u7684\u9009\u914d\u9879:</p> <ul> <li>\u662f\u5426\u5177\u6709\u6295\u7968\u6743(v \u53c2\u6570):\u6709\u5219\u53c2\u4e0e\u6295\u7968;</li> <li>\u4f18\u5148\u7ea7(priority \u53c2\u6570):\u4f18\u5148\u7ea7\u8d8a\u9ad8\u7684\u8282\u70b9\u8d8a\u4f18\u5148\u6210\u4e3a\u4e3b\u8282\u70b9\u3002\u4f18\u5148\u7ea7\u4e3a0\u7684\u8282\u70b9\u65e0\u6cd5\u6210 \u4e3a\u4e3b\u8282\u70b9;</li> <li>\u9690\u85cf(hidden \u53c2\u6570):\u590d\u5236\u6570\u636e\uff0c\u4f46\u5bf9\u5e94\u7528\u4e0d\u53ef\u89c1\u3002\u9690\u85cf\u8282\u70b9\u53ef\u4ee5\u5177\u6709\u6295\u7968\u4ec5\uff0c\u4f46\u4f18\u5148\u7ea7\u5fc5\u987b\u4e3a0;</li> <li>\u5ef6\u8fdf(slaveDelay \u53c2\u6570):\u590d\u5236 n \u79d2\u4e4b\u524d\u7684\u6570\u636e\uff0c\u4fdd\u6301\u4e0e\u4e3b\u8282\u70b9\u7684\u65f6\u95f4\u5dee\u3002</li> </ul> <p></p>"},{"location":"mongo2/3mon_rep/#_5","title":"\u590d\u5236\u96c6\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5173\u4e8e\u786c\u4ef6:</p> <ul> <li>\u56e0\u4e3a\u6b63\u5e38\u7684\u590d\u5236\u96c6\u8282\u70b9\u90fd\u6709\u53ef\u80fd\u6210\u4e3a\u4e3b\u8282\u70b9\uff0c\u5b83\u4eec\u7684\u5730\u4f4d\u662f\u4e00\u6837\u7684\uff0c\u56e0\u6b64\u786c\u4ef6\u914d\u7f6e\u4e0a\u5fc5\u987b\u4e00\u81f4;</li> <li>\u4e3a\u4e86\u4fdd\u8bc1\u8282\u70b9\u4e0d\u4f1a\u540c\u65f6\u5b95\u673a\uff0c\u5404\u8282\u70b9\u4f7f\u7528\u7684\u786c\u4ef6\u5fc5\u987b\u5177\u6709\u72ec\u7acb</li> </ul> <p>\u5173\u4e8e\u8f6f\u4ef6:</p> <p>\u590d\u5236\u96c6\u5404\u8282\u70b9\u8f6f\u4ef6\u7248\u672c\u5fc5\u987b\u4e00\u81f4\uff0c\u4ee5\u907f\u514d\u51fa\u73b0\u4e0d\u53ef\u9884\u77e5\u7684\u95ee\u9898\u3002</p> <p>\u589e\u52a0\u8282\u70b9\u4e0d\u4f1a\u589e\u52a0\u7cfb\u7edf\u5199\u6027\u80fd!</p>"},{"location":"mongo2/3mon_rep/#2-mongodb","title":"2 \u5b9e\u9a8c:\u642d\u5efa MongoDB \u590d\u5236\u96c6","text":""},{"location":"mongo2/3mon_rep/#1_1","title":"1. \u51c6\u5907","text":"<ul> <li>\u5b89\u88c5\u6700\u65b0\u7684 MongoDB \u7248\u672c</li> <li>Windows \u7cfb\u7edf\u8bf7\u4e8b\u5148\u914d\u7f6e\u597d MongoDB \u53ef\u6267\u884c\u6587\u4ef6\u7684\u73af\u5883\u53d8\u91cf</li> <li>Linux \u548c Mac \u7cfb\u7edf\u8bf7\u914d\u7f6e PATH \u53d8\u91cf</li> <li>\u786e\u4fdd\u6709 10GB \u4ee5\u4e0a\u7684\u786c\u76d8\u7a7a\u95f4</li> </ul>"},{"location":"mongo2/3mon_rep/#2","title":"2.\u521b\u5efa\u6570\u636e\u76ee\u5f55","text":"<p>MongoDB \u542f\u52a8\u65f6\u5c06\u4f7f\u7528\u4e00\u4e2a\u6570\u636e\u76ee\u5f55\u5b58\u653e\u6240\u6709\u6570\u636e\u6587\u4ef6\u3002\u6211\u4eec\u5c06\u4e3a3\u4e2a\u590d\u5236\u96c6\u8282 \u70b9\u521b\u5efa\u5404\u81ea\u7684\u6570\u636e\u76ee\u5f55\u3002</p> <ul> <li>Linux/MacOS:</li> </ul> <p><code>mkdir -p /data/db{1,2,3}</code></p> <ul> <li>Windows:</li> </ul> <pre><code>md c:\\data\\db1 \nmd c:\\data\\db2 \nmd c:\\data\\db3\n</code></pre>"},{"location":"mongo2/3mon_rep/#3_1","title":"3. \u51c6\u5907\u914d\u7f6e\u6587\u4ef6","text":"<p>\u590d\u5236\u96c6\u7684\u6bcf\u4e2amongod\u8fdb\u7a0b\u5e94\u8be5\u4f4d\u4e8e\u4e0d\u540c\u7684\u670d\u52a1\u5668\u3002\u6211\u4eec\u73b0\u5728\u5728\u4e00\u53f0\u673a\u5668\u4e0a\u8fd0\u884c3\u4e2a\u8fdb\u7a0b\uff0c\u56e0\u6b64\u8981 \u4e3a\u5b83\u4eec\u5404\u81ea\u914d\u7f6e</p> <p>\u4e0d\u540c\u7684\u7aef\u53e3\u3002\u793a\u4f8b\u4e2d\u5c06\u4f7f\u7528<code>28017/28018/28019</code></p> <p>\u4e0d\u540c\u7684\u6570\u636e\u76ee\u5f55\u3002\u793a\u4f8b\u4e2d\u5c06\u4f7f\u7528</p> <pre><code>/data/db1\u6216c:\\data\\db1 \n/data/db2\u6216c:\\data\\db2 \n/data/db3\u6216c:\\data\\db3\n</code></pre> <p>\u4e0d\u540c\u65e5\u5fd7\u6587\u4ef6\u8def\u5f84\u3002\u793a\u4f8b\u4e2d\u5c06\u4f7f\u7528:</p> <pre><code>/data/db1/mongod.log\u6216c:\\data\\db1\\mongod.log \n/data/db2/mongod.log\u6216c:\\data\\db2\\mongod.log \n/data/db3/mongod.log\u6216c:\\data\\db3\\mongod.log\n</code></pre>"},{"location":"mongo2/3mon_rep/#4","title":"4 \u51c6\u5907\u914d\u7f6e\u6587\u4ef6(\u7eed)","text":"<p>Linux/MacOS</p> <pre><code># /data/db1/mongod.conf\nsystemLog:\n  destination: file\n  path: /data/db1/mongod.log    # log path\n  logAppend: true\nstorage:\n  dbPath: /data/db1                 # data directory\nnet:\n  bindIp: 0.0.0.0\n  port: 28017                           # port\nreplication:\n  replSetName: rs0\nprocessManagement:\n  fork: true\n</code></pre> <p>Windows</p> <pre><code># c:\\data\\db1\\mongod.conf\nsystemLog:\n    destination: file\n     path: c:\\data1\\mongod.log    # \u65e5\u5fd7\u6587\u4ef6\u8def\u5f84\n     logAppend: true\nstorage:\n    dbPath: c:\\data1                  # \u6570\u636e\u76ee\u5f55\nnet:\n    bindIp: 0.0.0.0 \n    port: 28017                         # \u7aef\u53e3\nreplication: \n    replSetName: rs0\n</code></pre>"},{"location":"mongo2/3mon_rep/#mongodb","title":"\u542f\u52a8 MongoDB \u8fdb\u7a0b","text":"<p>Linux/Mac:</p> <pre><code>mongod -f /data/db1/mongod.conf \nmongod -f /data/db2/mongod.conf \nmongod -f /data/db3/mongod.conf\n</code></pre> <p>\u6ce8\u610f:\u5982\u679c\u542f\u7528\u4e86 SELinux\uff0c\u53ef\u80fd\u963b\u6b62\u4e0a\u8ff0\u8fdb\u7a0b\u542f\u52a8\u3002\u7b80\u5355\u8d77\u89c1\u8bf7\u5173\u95ed SELinux\u3002</p> <p>Windows:</p> <pre><code>mongod -f c:\\data1\\mongod.conf \nmongod -f c:\\data2\\mongod.conf \nmongod -f c:\\data3\\mongod.conf\n</code></pre> <p></p> <p>\u56e0\u4e3a Windows \u4e0d\u652f\u6301 fork\uff0c\u4ee5\u4e0a\u547d\u4ee4\u9700\u8981\u57283\u4e2a\u4e0d\u540c\u7684\u7a97\u53e3\u6267\u884c\uff0c\u6267\u884c\u540e\u4e0d\u53ef\u5173\u95ed\u7a97\u53e3\u5426\u5219 \u8fdb\u7a0b\u5c06\u76f4\u63a5\u7ed3\u675f\u3002</p> <p></p>"},{"location":"mongo2/3mon_rep/#_6","title":"\u914d\u7f6e\u590d\u5236\u96c6","text":"<p>\u65b9\u6cd51</p> <pre><code># mongo --port 28017\n &gt; rs.initiate()\n</code></pre> <p></p> <p><code>SECONDARY -&gt; PRIMARY</code>:  in 1S</p> <p>\u67e5\u770brs state</p> <p></p> <pre><code>&gt; rs.add(\"HOSTNAME:28018\") \n&gt; rs.add(\"HOSTNAME:28019\")\n</code></pre> <p>\u6ce8\u610f:\u6b64\u65b9\u5f0f<code>hostname</code>\u9700\u8981\u80fd\u88ab\u89e3\u6790</p> <p></p> <p>\u65b9\u6cd52</p> <pre><code># mongo --port 28017\n&gt; rs.initiate({\n    _id: \"rs0\",\n    members: [{\n       _id: 0,\n      host: \"localhost:28017\" \n},{\n      _id: 1,\n       host: \"localhost:28018\" \n},{\n        _id: 2,\n        host: \"localhost:28019\" \n    }]\n})\n</code></pre>"},{"location":"mongo2/3mon_rep/#_7","title":"\u9a8c\u8bc1","text":"<p>MongoDB \u4e3b\u8282\u70b9\u8fdb\u884c\u5199\u5165 &amp; MongoDB \u4ece\u8282\u70b9\u8fdb\u884c\u8bfb</p> <p>\u4e3b\u8282\u70b9</p> <pre><code> # mongo localhost:28017\n &gt; db.test.insert({ a:1 })\n</code></pre> <pre><code> &gt; db.test.insert({ a:2 });\n</code></pre> <p></p> <p>\u4ece\u8282\u70b9</p> <p></p> <pre><code># mongo localhost:28018\n&gt; rs.slaveOk()\n&gt; db.test.find()\n</code></pre> <p></p> <pre><code>&gt; db.test.find()\n</code></pre> <p></p>"},{"location":"mongo2/4mon_tools/","title":"4 MongoDB \u5168\u5bb6\u6876","text":"<p>MongoDB \u7cfb\u5217\u8f6f\u4ef6\u53ca\u5de5\u5177</p>"},{"location":"mongo2/4mon_tools/#mongodb","title":"MongoDB \u5168\u5bb6\u6876","text":"<p>mongodump / mongorestore</p> <ul> <li>\u7c7b\u4f3c\u4e8e MySQL \u7684 dump/restore \u5de5\u5177</li> <li>\u53ef\u4ee5\u5b8c\u6210\u5168\u5e93 dump:\u4e0d\u52a0\u6761\u4ef6</li> <li>\u4e5f\u53ef\u4ee5\u6839\u636e\u6761\u4ef6 dump \u90e8\u5206\u6570\u636e:-q \u53c2\u6570</li> <li>Dump \u7684\u540c\u65f6\u8ddf\u8e2a\u6570\u636e\u5c31\u66f4: <code>--oplog</code></li> </ul> <p>Restore \u662f\u53cd\u64cd\u4f5c\uff0c\u628a mongodump \u7684\u8f93\u51fa\u5bfc\u5165\u5230 mongodb</p> <pre><code>mongodump -h 127.0.0.1:27017 -d test -c test \n\nmongorestore -h 127.0.0.1:27017 -d test -c test xxx.bson\n</code></pre>"},{"location":"mongo2/4mon_tools/#atlas-mongodb","title":"Atlas \u2013 MongoDB \u516c\u6709\u4e91\u6258\u7ba1\u670d\u52a1","text":""},{"location":"mongo2/4mon_tools/#mongodb-bi-connector","title":"MongoDB BI Connector","text":""},{"location":"mongo2/4mon_tools/#mongodb-ops-manager-","title":"MongoDB Ops Manager - \u96c6\u7fa4\u7ba1\u7406\u5e73\u53f0","text":"<p>\u4e3b\u8981\u529f\u80fd</p> <ul> <li>\u81ea\u52a8\u5316\u7ba1\u7406:\u8865\u4e01\u3001\u5347\u7ea7\u3001\u5728\u7ebf\u6269\u5bb9 </li> <li>\u76d1\u63a7\u53ca\u62a5\u8b66</li> <li>\u6301\u7eed\u5907\u4efd\u53ca\u4efb\u610f\u65f6\u95f4\u70b9\u6062\u590d</li> <li>Kubernetes \u96c6\u6210</li> </ul>"},{"location":"mongo2/4mon_tools/#mongodb-charts","title":"MongoDB Charts","text":"<ul> <li>\u6258\u62c9\u62fd\u521b\u5efa MongoDB \u56fe\u8868</li> <li>\u521b\u5efa\u3001\u5206\u4eab\u548c\u5d4c\u5165 MongoDB \u6570\u636e\u53ef\u89c6\u5316\u7684\u6700\u5feb\u3001\u6700\u4fbf\u6377\u65b9\u5f0f</li> <li>\u4e13\u4e3a MongoDB \u6587\u6863\u6a21\u578b\u8bbe\u8ba1</li> <li>\u4e00\u884c\u4ee3\u7801\u5728\u4f60\u7f51\u9875\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5d4c\u5165\u56fe\u8868</li> </ul>"},{"location":"mongo2/5mon_design/","title":"5 Mongo \u6a21\u578b\u8bbe\u8ba1","text":""},{"location":"mongo2/5mon_design/#1","title":"1 \u6a21\u578b\u8bbe\u8ba1\u57fa\u7840","text":""},{"location":"mongo2/5mon_design/#_1","title":"\u6570\u636e\u6a21\u578b","text":"<p>\u4ec0\u4e48\u662f\u6570\u636e\u6a21\u578b?</p> <p>\u6570\u636e\u6a21\u578b\u662f\u4e00\u7ec4\u7531\u7b26\u53f7\u3001\u6587\u672c\u7ec4\u6210\u7684\u96c6\u5408\uff0c\u7528\u4ee5\u51c6\u786e\u8868\u8fbe\u4fe1\u606f\uff0c\u8fbe\u5230\u6709\u6548\u4ea4\u6d41\u3001\u6c9f\u901a\u7684\u76ee\u7684\u3002</p> <p>Steve Hoberman \u970d\u4f2f\u66fc. \u6570\u636e\u5efa\u6a21\u7ecf\u5178\u6559\u7a0b</p>"},{"location":"mongo2/5mon_design/#_2","title":"\u6570\u636e\u6a21\u578b\u8bbe\u8ba1\u7684\u5143\u7d20","text":"<p>\u5b9e\u4f53 Entity</p> <ul> <li>\u63cf\u8ff0\u4e1a\u52a1\u7684\u4e3b\u8981\u6570\u636e\u96c6\u5408</li> <li>\u8c01\uff0c\u4ec0\u4e48\uff0c\u4f55\u65f6\uff0c\u4f55\u5730\uff0c\u4e3a\u4f55\uff0c\u5982\u4f55</li> </ul> <p>\u5c5e\u6027 Attribute</p> <ul> <li>\u63cf\u8ff0\u5b9e\u4f53\u91cc\u9762\u7684\u5355\u4e2a\u4fe1\u606f</li> </ul> <p>\u5173\u7cfb Relationship</p> <ul> <li>\u63cf\u8ff0\u5b9e\u4f53\u4e0e\u5b9e\u4f53\u4e4b\u95f4\u7684\u6570\u636e\u89c4\u5219</li> <li>\u7ed3\u6784\u89c4\u5219:1-N\uff0c N-1, N-N</li> <li>\u5f15\u7528\u89c4\u5219:\u7535\u8bdd\u53f7\u7801\u4e0d\u80fd\u5355\u72ec\u5b58\u5728</li> </ul> <p></p>"},{"location":"mongo2/5mon_design/#_3","title":"\u4f20\u7edf\u6a21\u578b\u8bbe\u8ba1:\u4ece\u6982\u5ff5\u5230\u903b\u8f91\u5230\u7269\u7406","text":"<p>\u4ece\u5f00\u53d1\u8005\u7684\u89c6\u89d2:\u6982\u5ff5\u6a21\u578b</p> <p>Contact -&gt; Group</p> <p>\u4ece\u5f00\u53d1\u8005\u7684\u89c6\u89d2:\u903b\u8f91\u6a21\u578b</p> <p></p> <p>\u4ece\u5f00\u53d1\u8005\u7684\u89c6\u89d2:\u7b2c\u4e09\u8303\u5f0f\u4e0b\u7684\u7269\u7406\u6a21\u578b</p> <p></p>"},{"location":"mongo2/5mon_design/#_4","title":"\u6a21\u578b\u8bbe\u8ba1\u5c0f\u7ed3","text":"<p>\u6570\u636e\u6a21\u578b\u7684\u4e09\u8981\u7d20:</p> <p>\u5b9e\u4f53 /\u5c5e\u6027 / \u5173\u7cfb</p> <p>\u6570\u636e\u6a21\u578b\u7684\u4e09\u5c42\u6df1\u5ea6:</p> <ul> <li>\u6982\u5ff5\u6a21\u578b\uff0c\u903b\u8f91\u6a21\u578b\uff0c\u7269\u7406\u6a21\u578b</li> <li>\u4e00\u4e2a\u6a21\u578b\u9010\u6b65\u7ec6\u5316\u7684\u8fc7\u7a0b</li> </ul>"},{"location":"mongo2/5mon_design/#2-json","title":"2 JSON \u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u7279\u70b9","text":""},{"location":"mongo2/5mon_design/#mongodb","title":"MongoDB \u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u7684\u4e09\u4e2a\u8bef\u533a","text":"<ul> <li>\u4e0d\u9700\u8981\u6a21\u578b\u8bbe\u8ba1</li> <li>MongoDB \u5e94\u8be5\u7528\u4e00\u4e2a\u8d85\u7ea7\u5927\u6587\u6863\u6765\u7ec4\u7ec7\u6240\u6709\u6570\u636e </li> <li>MongoDB \u4e0d\u652f\u6301\u5173\u8054\u6216\u8005\u4e8b\u52a1</li> </ul> <p>\u4e0a\u8ff0\u5747\u4e3a\u9519</p>"},{"location":"mongo2/5mon_design/#json","title":"\u5173\u4e8e JSON \u6587\u6863\u6a21\u578b\u8bbe\u8ba1","text":"<ul> <li>\u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u5904\u4e8e\u662f\u7269\u7406\u6a21\u578b\u8bbe\u8ba1\u9636\u6bb5 (PDM) </li> <li>JSON \u6587\u6863\u6a21\u578b\u901a\u8fc7\u5185\u5d4c\u6570\u7ec4\u6216\u5f15\u7528\u5b57\u6bb5\u6765\u8868\u793a\u5173\u7cfb </li> <li>\u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u4e0d\u9075\u4ece\u7b2c\u4e09\u8303\u5f0f\uff0c\u5141\u8bb8\u5197\u4f59\u3002</li> </ul>"},{"location":"mongo2/5mon_design/#mongodb_1","title":"\u4e3a\u4ec0\u4e48\u4eba\u4eec\u90fd\u8bf4 MongoDB \u662f\u65e0\u6a21\u5f0f?","text":"<ul> <li>\u4e25\u683c\u6765\u8bf4\uff0cMongoDB \u540c\u6837\u9700\u8981\u6982\u5ff5/\u903b\u8f91\u5efa\u6a21 </li> <li>\u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u7684\u7269\u7406\u5c42\u7ed3\u6784\u53ef\u4ee5\u548c\u903b\u8f91\u5c42\u7c7b\u4f3c </li> </ul> <p>MongoDB \u65e0\u6a21\u5f0f\u7531\u6765: \u53ef\u4ee5\u7701\u7565\u7269\u7406\u5efa\u6a21\u7684\u5177\u4f53\u8fc7\u7a0b</p> <p></p>"},{"location":"mongo2/5mon_design/#json_1","title":"\u903b\u8f91\u6a21\u578b \u2013 JSON \u6a21\u578b","text":"<p>\u6587\u6863\u6a21\u578b\u7684\u8bbe\u8ba1\u539f\u5219:\u6027\u80fd\u548c\u6613\u7528</p> <p></p>"},{"location":"mongo2/5mon_design/#vs","title":"\u5173\u7cfb\u6a21\u578b vs \u6587\u6863\u6a21\u578b","text":""},{"location":"mongo2/5mon_design/#3","title":"3 \u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u4e4b\u4e00:\u57fa\u7840\u8bbe\u8ba1","text":""},{"location":"mongo2/5mon_design/#3-1-mongodb","title":"3-1 MongoDB \u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u4e09\u6b65\u66f2","text":"<p>\u7b2c\u4e00\u6b65:\u5efa\u7acb\u57fa\u7840\u6587\u6863\u6a21\u578b</p> <ol> <li>\u6839\u636e\u6982\u5ff5\u6a21\u578b\u6216\u8005\u4e1a\u52a1\u9700\u6c42\u63a8\u5bfc\u51fa\u903b\u8f91\u6a21\u578b \u2013 \u627e\u5230\u5bf9\u8c61 </li> <li>\u5217\u51fa\u5b9e\u4f53\u4e4b\u95f4\u7684\u5173\u7cfb(\u53ca\u57fa\u6570) - \u660e\u786e\u5173\u7cfb</li> <li>\u5957\u7528\u903b\u8f91\u8bbe\u8ba1\u539f\u5219\u6765\u51b3\u5b9a\u5185\u5d4c\u65b9\u5f0f \u2013 \u8fdb\u884c\u5efa\u6a21</li> <li>\u5b8c\u6210\u57fa\u7840\u6a21\u578b\u6784\u5efa</li> </ol> <p></p>"},{"location":"mongo2/5mon_design/#_5","title":"\u4e00\u4e2a\u8054\u7cfb\u4eba\u7ba1\u7406\u5e94\u7528\u7684\u4f8b\u5b50","text":"<p>1. \u627e\u5230\u5bf9\u8c61</p> <ul> <li>Contacts</li> <li>Groups</li> <li>Address</li> <li>Portraits</li> </ul> <p>2. \u660e\u786e\u5173\u7cfb</p> <ul> <li>\u4e00\u4e2a\u8054\u7cfb\u4eba\u6709\u4e00\u4e2a\u5934\u50cf (1-1)</li> <li>\u4e00\u4e2a\u8054\u7cfb\u4eba\u53ef\u4ee5\u6709\u591a\u4e2a\u5730\u5740(1-N )</li> <li>\u4e00\u4e2a\u8054\u7cfb\u4eba\u53ef\u4ee5\u5c5e\u4e8e\u591a\u4e2a\u7ec4\uff0c\u4e00\u4e2a\u7ec4\u53ef\u4ee5\u6709\u591a\u4e2a\u8054\u7cfb\u4eba (N \u2013 N)</li> </ul> <p></p> <p>1-1 \u5173\u7cfb\u5efa\u6a21: portraits</p> <ul> <li>\u57fa\u672c\u539f\u5219\uff1a<ul> <li>\u4e00\u5bf9\u4e00\u5173\u7cfb\u4ee5\u5185\u5d4c\u4e3a\u4e3b </li> <li>\u4f5c\u4e3a\u5b50\u6587\u6863\u5f62\u5f0f \u6216\u8005\u76f4\u63a5\u5728\u9876\u7ea7 </li> <li>\u4e0d\u6d89\u53ca\u5230\u6570\u636e\u5197\u4f59</li> </ul> </li> <li>\u4f8b\u5916\u60c5\u51b5<ul> <li>\u5982\u679c\u5185\u5d4c\u540e\u5bfc\u81f4\u6587\u6863\u5927\u5c0f\u8d85\u8fc716MB</li> </ul> </li> </ul> <p></p> <p>1-N \u5173\u7cfb\u5efa\u6a21: Addresses</p> <ul> <li>\u57fa\u672c\u539f\u5219<ul> <li>\u4e00\u5bf9\u591a\u5173\u7cfb\u540c\u6837\u4ee5\u5185\u5d4c\u4e3a\u4e3b</li> <li>\u7528\u6570\u7ec4\u6765\u8868\u793a\u4e00\u5bf9\u591a</li> <li>\u4e0d\u6d89\u53ca\u5230\u6570\u636e\u5197\u4f59</li> </ul> </li> <li>\u4f8b\u5916\u60c5\u51b5<ul> <li>\u5185\u5d4c\u540e\u5bfc\u81f4\u6587\u6863\u5927\u5c0f\u8d85\u8fc716MB </li> <li>\u6570\u7ec4\u957f\u5ea6\u592a\u5927(\u6570\u4e07\u6216\u66f4\u591a) </li> <li>\u6570\u7ec4\u957f\u5ea6\u4e0d\u786e\u5b9a</li> </ul> </li> </ul> <p></p> <p>N-N \u5173\u7cfb\u5efa\u6a21:\u5185\u5d4c\u6570\u7ec4\u6a21\u5f0f</p> <ul> <li>\u57fa\u672c\u539f\u5219<ul> <li>\u4e0d\u9700\u8981\u6620\u5c04\u8868 </li> <li>\u4e00\u822c\u7528\u5185\u5d4c\u6570\u7ec4\u6765\u8868\u793a\u4e00\u5bf9\u591a </li> <li>\u901a\u8fc7\u5197\u4f59\u6765\u5b9e\u73b0N-N</li> </ul> </li> <li>\u4f8b\u5916\u60c5\u51b5<ul> <li>\u5185\u5d4c\u540e\u5bfc\u81f4\u6587\u6863\u5927\u5c0f\u8d85\u8fc716MB </li> <li>\u6570\u7ec4\u957f\u5ea6\u592a\u5927(\u6570\u4e07\u6216\u66f4\u591a) </li> <li>\u6570\u7ec4\u957f\u5ea6\u4e0d\u786e\u5b9a</li> </ul> </li> </ul> <pre><code>Contacts\n    name: \"TJ Tang\", \n    company: \u201dTAPDATA\" \n    title: \" CTO\"\n    portraits: {\n       mimetype: xxx\n      data: xxxx \n     }\uff0c\n   addresses: [\n     { type: home, ... },\n     { type: work, ... }\n    ]\uff0c \n   groups: [\n      {name:  \u201dFriends\u201d },\n      {name:  \u201dSurfers\u201d },\n   ]\n</code></pre>"},{"location":"mongo2/5mon_design/#_6","title":"\u5c0f\u7ed3","text":"<ul> <li>90:10 \u89c4\u5219: \u5927\u90e8\u5206\u65f6\u5019\u4f60\u4f1a\u4f7f\u7528\u5185\u5d4c\u6765\u8868\u793a 1-1\uff0c1-N\uff0cN-N </li> <li>\u5185\u5d4c\u7c7b\u4f3c\u4e8e\u9884\u5148\u805a\u5408(\u5173\u8054) </li> <li>\u5185\u5d4c\u540e\u5bf9\u8bfb\u64cd\u4f5c\u901a\u5e38\u6709\u4f18\u52bf(\u51cf\u5c11\u5173\u8054)</li> </ul>"},{"location":"mongo2/5mon_design/#4","title":"4 \u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u4e4b\u4e8c:\u5de5\u51b5\u7ec6\u5316","text":""},{"location":"mongo2/5mon_design/#_7","title":"\u7b2c\u4e8c\u6b65:\u6839\u636e\u8bfb\u5199\u5de5\u51b5\u7ec6\u5316","text":"<ul> <li>\u6700\u9891\u7e41\u7684\u6570\u636e\u67e5\u8be2\u6a21\u5f0f </li> <li>\u6700\u5e38\u7528\u7684\u67e5\u8be2\u53c2\u6570</li> <li>\u6700\u9891\u7e41\u7684\u6570\u636e\u5199\u5165\u6a21\u5f0f </li> <li>\u8bfb\u5199\u64cd\u4f5c\u7684\u6bd4\u4f8b</li> <li>\u6570\u636e\u91cf\u7684\u5927\u5c0f</li> <li>\u57fa\u4e8e\u5185\u5d4c\u7684\u6587\u6863\u6a21\u578b</li> <li>\u6839\u636e\u4e1a\u52a1\u9700\u6c42\uff0c<ul> <li>\u4f7f\u7528\u5f15\u7528\u6765\u907f\u514d\u6027\u80fd\u74f6\u9888</li> <li>\u4f7f\u7528\u5197\u4f59\u6765\u4f18\u5316\u8bbf\u95ee\u6027\u80fd</li> </ul> </li> </ul>"},{"location":"mongo2/5mon_design/#_8","title":"\u8054\u7cfb\u4eba\u7ba1\u7406\u5e94\u7528\u7684\u5206\u7ec4\u9700\u6c42","text":"<ol> <li>\u7528\u4e8e\u5ba2\u6237\u8425\u9500</li> <li>\u6709\u5343\u4e07\u7ea7\u8054\u7cfb\u4eba</li> <li>\u9700\u8981\u9891\u7e41\u53d8\u52a8\u5206\u7ec4(group) \u7684\u4fe1\u606f\uff0c\u5982\u589e\u52a0\u5206\u7ec4\u53ca\u4fee\u6539\u540d\u79f0\u53ca\u63cf\u8ff0\u4ee5\u53ca\u8425\u9500\u72b6\u6001</li> <li>\u4e00\u4e2a\u5206\u7ec4\u53ef\u4ee5\u6709\u767e\u4e07\u7ea7\u8054\u7cfb\u4eba</li> </ol>"},{"location":"mongo2/5mon_design/#group","title":"\u89e3\u51b3\u65b9\u6848: Group \u4f7f\u7528\u5355\u72ec\u7684\u96c6\u5408","text":"<ol> <li>\u7c7b\u4f3c\u4e8e\u5173\u7cfb\u578b\u8bbe\u8ba1</li> <li>\u7528 id \u6216\u8005\u552f\u4e00\u952e\u5173\u8054</li> <li>\u4f7f\u7528 <code>$lookup</code> \u6765\u63d0\u4f9b\u4e00\u6b21\u67e5\u8be2\u591a\u8868 \u7684\u80fd\u529b(\u7c7b\u4f3c\u5173\u8054\uff09</li> </ol>"},{"location":"mongo2/5mon_design/#_9","title":"\u5f15\u7528\u6a21\u5f0f\u4e0b\u7684\u5173\u8054\u67e5\u8be2","text":"<p>https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/</p> <pre><code>db.contacts.aggregate([\n   {\n$lookup:\n       {\n         from: \"groups\",\n         localField: \"group_ids\",\n         foreignField: \"group_id\",\n         as: \"groups\"\n} }\n])\n</code></pre> <ul> <li><code>from: &lt;collection to join&gt;,</code></li> <li><code>localField: &lt;field from the input documents&gt;,</code></li> <li><code>foreignField: &lt;field from the documents of the \"from\" collection&gt;,</code></li> <li><code>as: &lt;output array field&gt;</code></li> </ul> <p>\u8054\u7cfb\u4eba\u7684\u5934\u50cf: \u5f15\u7528\u6a21\u5f0f</p> <ol> <li>\u5934\u50cf\u4f7f\u7528\u9ad8\u4fdd\u771f\uff0c\u5927\u5c0f\u5728 5MB- 10MB</li> <li>\u5934\u50cf\u4e00\u65e6\u4e0a\u4f20\uff0c\u4e00\u4e2a\u6708\u4e0d\u53ef\u66f4\u6362</li> <li>\u57fa\u7840\u4fe1\u606f\u67e5\u8be2(\u4e0d\u542b\u5934\u50cf)\u548c \u5934 \u50cf\u67e5\u8be2\u7684\u6bd4\u4f8b\u4e3a 9 :1</li> <li>\u5efa\u8bae: \u4f7f\u7528\u5f15\u7528\u65b9\u5f0f\uff0c\u628a\u5934\u50cf\u6570 \u636e\u653e\u5230\u53e6\u5916\u4e00\u4e2a\u96c6\u5408\uff0c\u53ef\u4ee5\u663e\u8457\u63d0 \u5347 90% \u7684\u67e5\u8be2\u6548\u7387</li> </ol> <p></p>"},{"location":"mongo2/5mon_design/#_10","title":"\u4ec0\u4e48\u65f6\u5019\u8be5\u4f7f\u7528\u5f15\u7528\u65b9\u5f0f?","text":"<ul> <li>\u5185\u5d4c\u6587\u6863\u592a\u5927\uff0c\u6570 MB \u6216\u8005\u8d85\u8fc7 16MB </li> <li>\u5185\u5d4c\u6587\u6863\u6216\u6570\u7ec4\u5143\u7d20\u4f1a\u9891\u7e41\u4fee\u6539 </li> <li>\u5185\u5d4c\u6570\u7ec4\u5143\u7d20\u4f1a\u6301\u7eed\u589e\u957f\u5e76\u4e14\u6ca1\u6709\u5c01\u9876</li> </ul>"},{"location":"mongo2/5mon_design/#mongodb_2","title":"MongoDB \u5f15\u7528\u8bbe\u8ba1\u7684\u9650\u5236","text":"<ul> <li>MongoDB \u5bf9\u4f7f\u7528\u5f15\u7528\u7684\u96c6\u5408\u4e4b\u95f4\u5e76\u65e0\u4e3b\u5916\u952e\u68c0\u67e5 </li> <li>MongoDB \u4f7f\u7528\u805a\u5408\u6846\u67b6\u7684 </li> <li><code>$lookup</code> \u6765\u6a21\u4eff\u5173\u8054\u67e5\u8be2 <code>$lookup</code> \u53ea\u652f\u6301 left outer join</li> <li><code>$lookup</code> \u7684\u5173\u8054\u76ee\u6807(from)\u4e0d\u80fd\u662f\u5206\u7247\u8868</li> </ul>"},{"location":"mongo2/5mon_design/#5","title":"5 \u6587\u6863\u6a21\u578b\u8bbe\u8ba1\u4e4b\u4e09:\u6a21\u5f0f\u5957\u7528","text":""},{"location":"mongo2/5mon_design/#_11","title":"\u7b2c\u4e09\u6b65:\u5957\u7528\u8bbe\u8ba1\u6a21\u5f0f","text":"<ul> <li>\u6587\u6863\u6a21\u578b: \u65e0\u8303\u5f0f\uff0c\u65e0\u601d\u7ef4\u5b9a\u5f0f\uff0c\u5145\u5206\u53d1\u6325\u60f3\u8c61\u529b </li> <li>\u8bbe\u8ba1\u6a21\u5f0f:\u5b9e\u6218\u8fc7\u5c61\u8bd5\u4e0d\u723d\u7684\u8bbe\u8ba1\u6280\u5de7\uff0c\u5feb\u901f\u5e94\u7528</li> <li>\u4e3e\u4f8b:\u4e00\u4e2a IoT \u573a\u666f\u7684\u5206\u6876\u8bbe\u8ba1\u6a21\u5f0f\uff0c\u53ef\u4ee5\u5e2e\u52a9\u628a\u5b58\u50a8\u7a7a\u95f4\u964d\u4f4e 10 \u500d\u5e76\u4e14\u67e5\u8be2\u6548\u7387\u63d0 \u5347\u6570\u5341\u500d.</li> </ul> <p>\u95ee\u9898: \u7269\u8054\u7f51\u573a\u666f\u4e0b\u7684\u6d77\u91cf\u6570\u636e\u5904\u7406 \u2013 \u98de\u673a\u76d1\u63a7\u6570\u636e</p> <pre><code>{\n\"_id\" : \"20160101050000:CA2790\",\n\"icao\" : \"CA2790\",\n\"callsign\" : \"CA2790\",\n\"ts\" : ISODate(\"2016-01-01T05:00:00.000+0000\"), \n\"events\" : {\n        \"a\" : 31418,\n        \"b\" : 173,\n        \"p\" : [115, -134],\n        \"s\" : 91,\n        \"v\" : 80\n  } \n}\n</code></pre>"},{"location":"mongo2/5mon_design/#52010tb","title":"520\u4ebf\u6761\uff0c10TB \u2013 \u6d77\u91cf\u6570\u636e","text":"<ul> <li>10\u4e07\u67b6\u98de\u673a </li> <li>1\u5e74\u7684\u6570\u636e </li> <li>\u6bcf\u5206\u949f\u4e00\u6761</li> </ul> <p>\u89e3\u51b3\u65b9\u6848: \u5206\u6876\u8bbe\u8ba1</p> <p>\u4e00\u4e2a\u6587\u6863:\u4e00\u67b6\u98de\u673a\u4e00\u4e2a\u5c0f\u65f6\u7684\u6570\u636e</p> <p>60 Events == 1 \u5c0f\u65f6\u6570\u636e</p> <pre><code>{\n    \"_id\" : \"20160101050000:WG9943\",\n    \"icao\" : \"WG9943\",\n    \"ts\" : ISODate(\"2016-01-01T05:00:00.000+0000\"), \n    \"events\" : [\n        {\n            \"a\" : 24293, \"b\" : 319, \"p\" : [41, 70], \"s\" : 56,\n            \"t\" : ISODate(\"2016-01-01T05:00:00.000+0000\u201c)\n            }, {\n            \"a\" : 33663, \"b\" : 134, \"p\" : [-38, -30], \"s\" : 385,\n            \"t\" : ISODate(\"2016-01-01T05:00:01.000+0000\u201c)\n        },\n    ... \n    ]\n}\n</code></pre>"},{"location":"mongo2/5mon_design/#52010tb_1","title":"520\u4ebf\u6761\uff0c10TB \u2013 \u6d77\u91cf\u6570\u636e","text":"<p>\u53ef\u89c6\u5316\u8868\u73b0 24 \u5c0f\u65f6\u7684\u98de\u884c\u6570\u636e   1440 \u6b21\u8bfb </p> <p></p>"},{"location":"mongo2/5mon_design/#_12","title":"\u6a21\u5f0f\u5c0f\u7ed3:\u5206\u6876","text":"<p>\u672c\u8bb2\u5c0f\u7ed3</p> <p>\u4e00\u4e2a\u597d\u7684\u8bbe\u8ba1\u6a21\u5f0f\u53ef\u4ee5\u663e\u8457\u5730: </p> <ul> <li>\u63d0\u5347\u6570\u636e\u8bfb\u5199\u7684\u6548\u7387</li> <li>\u964d\u4f4e\u8d44\u6e90\u7684\u9700\u6c42</li> </ul> <p>\u66f4\u591a\u7684 MongoDB \u8bbe\u8ba1\u6a21\u5f0f:</p> <p></p>"},{"location":"mongo2/5mon_design/#6","title":"6 \u8bbe\u8ba1\u6a21\u5f0f\u96c6\u9526","text":""},{"location":"mongo2/5mon_design/#1_1","title":"\u95ee\u98981 : \u5927\u6587\u6863\uff0c\u5f88\u591a\u5b57\u6bb5\uff0c\u5f88\u591a\u7d22\u5f15","text":"<pre><code>{\n    title: \"Dunkirk\",\n    ...\n    release_USA: \"2017/07/23\",\n    release_UK: \"2017/08/01\",\n    release_France: \"2017/08/01\",\n    release_Festival_San_Jose:\n      \"2017/07/22\"\n}\n</code></pre> <p>\u9700\u8981\u5f88\u591a\u7d22\u5f15</p> <pre><code>{ release_USA: 1 }\n{ release_UK: 1 }\n{ release_France: 1 }\n...\n{ release_Festival_San_Jose: 1 }\n...\n</code></pre>"},{"location":"mongo2/5mon_design/#_13","title":"\u89e3\u51b3\u65b9\u6848: \u5217\u8f6c\u884c","text":"<pre><code>{\n  title: \"Dunkirk\",\n  ...\n  releases: [\n    { country: \u201cUSA\u201d, date:\u201d2017/07/23\u201d},\n    { country: \u201cUK\u201d, date:\u201d2017/08/01\u201d}\n ]\n}\n</code></pre> <pre><code>db.movies.createIndex({\u201creleases.country\u201d:1, \u201creleases.date\u201d:1})\n</code></pre>"},{"location":"mongo2/5mon_design/#_14","title":"\u6a21\u5f0f\u5c0f\u7ed3: \u5217\u8f6c\u884c","text":""},{"location":"mongo2/5mon_design/#2","title":"\u95ee\u98982: \u6a21\u578b\u7075\u6d3b\u4e86\uff0c\u5982\u4f55\u7ba1\u7406\u6587\u6863\u4e0d\u540c\u7248\u672c?","text":"<p>2019.01 \u7248\u672c1.0</p> <pre><code>{\n    \"_id\" : ObjectId(\"5de26f197edd62c5d388babb\"), \n    \"name\" : \"TJ\",\n    \"company\" : \"Tapdata\",\n}\n</code></pre> <p>2019.03 \u7248\u672c2.0</p> <pre><code>{\n    \"_id\" : ObjectId(\"5de26f197edd62c5d388babb\"), \"name\" : \"TJ\",\n    \"company\" : \"Tapdata\",\n    \"wechat\": \"tjtang826\"\n}\n</code></pre>"},{"location":"mongo2/5mon_design/#_15","title":"\u89e3\u51b3\u65b9\u6848: \u589e\u52a0\u4e00\u4e2a\u7248\u672c\u5b57\u6bb5","text":"<pre><code>{\n    \"_id\" : ObjectId(\"5de26f197edd62c5d388babb\"), \"name\" : \"TJ\",\n    \"company\" : \"Tapdata\",\n    \"wechat\": \"tjtang826\u201d\uff0c\n    \"schema_version\": \"2.0\"\n}\n</code></pre> <p><code>\"schema_version\": \"2.0\"</code></p>"},{"location":"mongo2/5mon_design/#_16","title":"\u6a21\u5f0f\u5c0f\u7ed3: \u7248\u672c\u5b57\u6bb5","text":""},{"location":"mongo2/5mon_design/#3_1","title":"\u95ee\u98983: \u7edf\u8ba1\u7f51\u9875\u70b9\u51fb\u6d41\u91cf","text":"<ul> <li>\u6bcf\u8bbf\u95ee\u4e00\u4e2a\u9875\u9762\u90fd\u4f1a\u4ea7\u751f\u4e00\u6b21\u6570\u636e\u5e93\u8ba1\u6570\u66f4\u65b0\u64cd\u4f5c</li> <li>\u7edf\u8ba1\u6570\u5b57\u51c6\u786e\u6027\u5e76\u4e0d\u5341\u5206\u91cd\u8981</li> </ul>"},{"location":"mongo2/5mon_design/#_17","title":"\u89e3\u51b3\u65b9\u6848: \u7528\u8fd1\u4f3c\u8ba1\u7b97","text":"<p>\u6bcf\u969410 (X)\u6b21\u5199\u4e00\u6b21  <code>Increment by 10(X)</code></p> <p></p>"},{"location":"mongo2/5mon_design/#_18","title":"\u6a21\u5f0f\u5c0f\u7ed3:\u8fd1\u4f3c\u8ba1\u7b97","text":""},{"location":"mongo2/5mon_design/#4_1","title":"\u95ee\u98984: \u4e1a\u7ee9\u6392\u540d\uff0c\u6e38\u620f\u6392\u540d\uff0c\u5546\u54c1\u7edf\u8ba1\u7b49\u7cbe\u786e\u7edf\u8ba1","text":"<ul> <li>\u70ed\u9500\u699c:\u67d0\u4e2a\u5546\u54c1\u4eca\u5929\u5356\u4e86\u591a\u5c11\uff0c\u8fd9\u4e2a\u661f\u671f\u5356\u4e86\u591a\u5c11\uff0c\u8fd9\u4e2a\u6708\u5356\u4e86\u591a\u5c11?</li> <li>\u7535\u5f71\u6392\u884c:\u89c2\u5f71\u8005\uff0c\u573a\u6b21\u7edf\u8ba1</li> <li>\u4f20\u7edf\u89e3\u51b3\u65b9\u6848:\u901a\u8fc7\u805a\u5408\u8ba1\u7b97</li> <li>\u75db\u70b9:\u6d88\u8017\u8d44\u6e90\u591a\uff0c\u805a\u5408\u8ba1\u7b97\u65f6\u95f4\u957f</li> </ul> <p>\u89e3\u51b3\u65b9\u6848: \u7528\u9884\u805a\u5408\u5b57\u6bb5</p> <pre><code>{\n  product: \u201dBike\",\n  sku: \u201cabc123456\u201d,\n  quantitiy: 20394,\n  daily_sales: 40,\n  weekly_sales: 302,\n  monthly_sales: 1419\n}\n</code></pre> <pre><code>db.inventory.update({_id:123},\n{$inc: {\n    quantity: -1, \n    daily_sales: 1, \n    weekly_sales: 1\uff0c \n    monthly_sales: 1\uff0c\n    }\n)\n</code></pre>"},{"location":"mongo2/5mon_design/#_19","title":"\u6a21\u5f0f\u5c0f\u7ed3:\u9884\u805a\u5408","text":""},{"location":"mongo2/6mon_red_write/","title":"6 MongoDB \u4e8b\u52a1\u5f00\u53d1","text":""},{"location":"mongo2/6mon_red_write/#1","title":"1 \u4e8b\u52a1\u5f00\u53d1:\u5199\u64cd\u4f5c\u4e8b\u52a1","text":""},{"location":"mongo2/6mon_red_write/#writeconcern","title":"\u4ec0\u4e48\u662f writeConcern ?","text":"<p>writeConcern \u51b3\u5b9a\u4e00\u4e2a\u5199\u64cd\u4f5c\u843d\u5230\u591a\u5c11\u4e2a\u8282\u70b9\u4e0a\u624d\u7b97\u6210\u529f\u3002writeConcern \u7684\u53d6\u503c\u5305\u62ec:</p> <ul> <li>0: \u53d1\u8d77\u5199\u64cd\u4f5c\uff0c\u4e0d\u5173\u5fc3\u662f\u5426\u6210\u529f;</li> <li>1~\u96c6\u7fa4\u6700\u5927\u6570\u636e\u8282\u70b9\u6570: \u5199\u64cd\u4f5c\u9700\u8981\u88ab\u590d\u5236\u5230\u6307\u5b9a\u8282\u70b9\u6570\u624d\u7b97\u6210\u529f;</li> <li>majority: \u5199\u64cd\u4f5c\u9700\u8981\u88ab\u590d\u5236\u5230\u5927\u591a\u6570\u8282\u70b9\u4e0a\u624d\u7b97\u6210\u529f\u3002</li> </ul> <p>\u53d1\u8d77\u5199\u64cd\u4f5c\u7684\u7a0b\u5e8f\u5c06\u963b\u585e\u5230\u5199\u64cd\u4f5c\u5230\u8fbe\u6307\u5b9a\u7684\u8282\u70b9\u6570\u4e3a\u6b62</p>"},{"location":"mongo2/6mon_red_write/#_1","title":"\u9ed8\u8ba4\u884c\u4e3a","text":"<p>3 \u8282\u70b9\u590d\u5236\u96c6\u4e0d\u4f5c\u4efb\u4f55\u7279\u522b\u8bbe\u5b9a(\u9ed8\u8ba4\u503c):</p> <p></p>"},{"location":"mongo2/6mon_red_write/#w-majority","title":"<code>w: \"majority\"</code>","text":"<p>\u5927\u591a\u6570\u8282\u70b9\u786e\u8ba4\u6a21\u5f0f</p> <p></p>"},{"location":"mongo2/6mon_red_write/#w-all","title":"<code>w: \"all\"</code>","text":"<p>\u5168\u90e8\u8282\u70b9\u786e\u8ba4\u6a21\u5f0f</p> <p></p>"},{"location":"mongo2/6mon_red_write/#jtrue","title":"<code>j:true</code>","text":"<p><code>writeConcern</code> \u53ef\u4ee5\u51b3\u5b9a\u5199\u64cd\u4f5c\u5230\u8fbe\u591a\u5c11\u4e2a\u8282\u70b9\u624d\u7b97\u6210\u529f\uff0cjournal \u5219\u5b9a\u4e49\u5982\u4f55\u624d\u7b97\u6210\u529f\u3002\u53d6\u503c\u5305\u62ec:</p> <ul> <li>true:\u5199\u64cd\u4f5c\u843d\u5230<code>journal</code>\u6587\u4ef6\u4e2d\u624d\u7b97\u6210\u529f;</li> <li>false:\u5199\u64cd\u4f5c\u5230\u8fbe\u5185\u5b58\u5373\u7b97\u4f5c\u6210\u529f\u3002</li> </ul> <p></p>"},{"location":"mongo2/6mon_red_write/#writeconcern_1","title":"writeConcern \u7684\u610f\u4e49","text":"<p>\u5bf9\u4e8e5\u4e2a\u8282\u70b9\u7684\u590d\u5236\u96c6\u6765\u8bf4\uff0c\u5199\u64cd\u4f5c\u843d\u5230\u591a\u5c11\u4e2a\u8282\u70b9\u4e0a\u624d\u7b97\u662f\u5b89\u5168\u7684?</p> <ul> <li>1</li> <li>2 </li> <li>3\u2713</li> <li>4\u2713</li> <li>5\u2713</li> <li>majority \u2713</li> </ul>"},{"location":"mongo2/6mon_red_write/#writeconcern_2","title":"writeConcern \u5b9e\u9a8c","text":"<p>\u5728\u590d\u5236\u96c6\u6d4b\u8bd5writeConcern\u53c2\u6570</p> <p></p> <pre><code>db.test.insert( {count: 1}, {writeConcern: {w: \"majority\"}}) \n\ndb.test.insert( {count: 1}, {writeConcern: {w: 3 }}) \n\ndb.test.insert( {count: 1}, {writeConcern: {w: 4 }})\n</code></pre> <p></p> <p></p> <p></p> <p>\u67e5\u770b\u96c6\u7fa4\u6210\u5458</p> <p><code>conf.members</code></p> <p></p> <p>\u914d\u7f6e\u5ef6\u8fdf\u8282\u70b9\uff0c\u6a21\u62df\u7f51\u7edc\u5ef6\u8fdf(\u590d\u5236\u5ef6\u8fdf)</p> <pre><code>conf=rs.conf() \n\nconf.members[2].slaveDelay = 5 \nconf.members[2].priority = 0 \n\nrs.reconfig(conf)\n</code></pre> <p></p> <p></p> <p>10s \u540e\u5ef6\u8fdf\u63d2\u5165</p> <p></p> <p>\u89c2\u5bdf\u590d\u5236\u5ef6\u8fdf\u4e0b\u7684\u5199\u5165\uff0c\u4ee5\u53catimeout\u53c2\u6570</p> <pre><code>db.test.insert( {count: 1}, {writeConcern: {w: 3}})\n\ndb.test.insert( {count: 1}, {writeConcern: {w: 3, wtimeout:3000 }})\n</code></pre> <p></p>"},{"location":"mongo2/6mon_red_write/#_2","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u867d\u7136\u591a\u4e8e\u534a\u6570\u7684<code>writeConcern</code>\u90fd\u662f\u5b89\u5168\u7684\uff0c\u4f46\u901a\u5e38\u53ea\u4f1a\u8bbe\u7f6e<code>majority</code>\uff0c\u56e0\u4e3a\u8fd9\u662f\u7b49\u5f85\u5199\u5165\u5ef6\u8fdf\u65f6\u95f4\u6700\u77ed\u7684\u9009\u62e9;</li> <li>\u4e0d\u8981\u8bbe\u7f6e<code>writeConcern</code>\u7b49\u4e8e\u603b\u8282\u70b9\u6570\uff0c\u56e0\u4e3a\u4e00\u65e6\u6709\u4e00\u4e2a\u8282\u70b9\u6545\u969c\uff0c\u6240\u6709\u5199\u64cd\u4f5c\u90fd\u5c06\u5931\u8d25;</li> <li><code>writeConcern</code>\u867d\u7136\u4f1a\u589e\u52a0\u5199\u64cd\u4f5c\u5ef6\u8fdf\u65f6\u95f4\uff0c\u4f46\u5e76\u4e0d\u4f1a\u663e\u8457\u589e\u52a0\u96c6\u7fa4\u538b\u529b\uff0c\u56e0\u6b64\u65e0\u8bba\u662f\u5426\u7b49\u5f85\uff0c\u5199\u64cd\u4f5c\u6700\u7ec8\u90fd\u4f1a\u590d\u5236\u5230\u6240\u6709\u8282\u70b9\u4e0a\u3002\u8bbe\u7f6e <code>writeConcern</code> \u53ea\u662f\u8ba9\u5199\u64cd\u4f5c \u7b49\u5f85\u590d\u5236\u540e\u518d\u8fd4\u56de\u800c\u5df2;</li> <li>\u5e94\u5bf9\u91cd\u8981\u6570\u636e\u5e94\u7528<code>{w:\u201cmajority\u201d}</code>\uff0c\u666e\u901a\u6570\u636e\u53ef\u4ee5\u5e94\u7528<code>{w:1}</code>\u4ee5\u786e\u4fdd\u6700\u4f73\u6027\u80fd\u3002</li> </ul>"},{"location":"mongo2/6mon_red_write/#2-readpreference","title":"2 \u4e8b\u52a1\u5f00\u53d1:\u8bfb\u64cd\u4f5c\u4e8b\u52a1\u4e4b\u4e00 <code>readPreference</code>","text":""},{"location":"mongo2/6mon_red_write/#_3","title":"\u7efc\u8ff0","text":"<p>\u5728\u8bfb\u53d6\u6570\u636e\u7684\u8fc7\u7a0b\u4e2d\u6211\u4eec\u9700\u8981\u5173\u6ce8\u4ee5\u4e0b\u4e24\u4e2a\u95ee\u9898: </p> <ul> <li>\u4ece\u54ea\u91cc\u8bfb?</li> <li> <p>\u4ec0\u4e48\u6837\u7684\u6570\u636e\u53ef\u4ee5\u8bfb?</p> </li> <li> <p>\u7b2c\u4e00\u4e2a\u95ee\u9898\u662f\u662f\u7531 readPreference \u6765\u89e3\u51b3 </p> </li> <li>\u7b2c\u4e8c\u4e2a\u95ee\u9898\u5219\u662f\u7531 readConcern \u6765\u89e3\u51b3</li> </ul>"},{"location":"mongo2/6mon_red_write/#readpreference","title":"\u4ec0\u4e48\u662f readPreference?","text":"<p><code>readPreference</code> \u51b3\u5b9a\u4f7f\u7528\u54ea\u4e00\u4e2a\u8282\u70b9\u6765\u6ee1\u8db3 \u6b63\u5728\u53d1\u8d77\u7684\u8bfb\u8bf7\u6c42\u3002\u53ef\u9009\u503c\u5305\u62ec:</p> <ul> <li>primary:\u53ea\u9009\u62e9\u4e3b\u8282\u70b9;</li> <li>primaryPreferred:\u4f18\u5148\u9009\u62e9\u4e3b\u8282\u70b9\uff0c\u5982\u679c\u4e0d\u53ef\u7528\u5219\u9009\u62e9\u4ece\u8282\u70b9;</li> <li>secondary:\u53ea\u9009\u62e9\u4ece\u8282\u70b9;</li> <li><code>secondaryPreferred:</code>\u4f18\u5148\u9009\u62e9\u4ece\u8282\u70b9\uff0c \u5982\u679c\u4ece\u8282\u70b9\u4e0d\u53ef\u7528\u5219\u9009\u62e9\u4e3b\u8282\u70b9;</li> <li>nearest:\u9009\u62e9\u6700\u8fd1\u7684\u8282\u70b9;</li> </ul> <p></p>"},{"location":"mongo2/6mon_red_write/#readpreference_1","title":"readPreference \u573a\u666f\u4e3e\u4f8b","text":"<ul> <li>\u7528\u6237\u4e0b\u8ba2\u5355\u540e\u9a6c\u4e0a\u5c06\u7528\u6237\u8f6c\u5230\u8ba2\u5355\u8be6\u60c5\u9875\u2014\u2014primary/primaryPreferred\u3002\u56e0\u4e3a\u6b64\u65f6\u4ece\u8282\u70b9\u53ef\u80fd\u8fd8\u6ca1\u590d\u5236\u5230\u65b0\u8ba2\u5355;</li> <li>\u7528\u6237\u67e5\u8be2\u81ea\u5df1\u4e0b\u8fc7\u7684\u8ba2\u5355\u2014\u2014secondary/secondaryPreferred\u3002\u67e5\u8be2\u5386\u53f2\u8ba2\u5355\u5bf9 \u65f6\u6548\u6027\u901a\u5e38\u6ca1\u6709\u592a\u9ad8\u8981\u6c42;</li> <li>\u751f\u6210\u62a5\u8868\u2014\u2014secondary\u3002\u62a5\u8868\u5bf9\u65f6\u6548\u6027\u8981\u6c42\u4e0d\u9ad8\uff0c\u4f46\u8d44\u6e90\u9700\u6c42\u5927\uff0c\u53ef\u4ee5\u5728\u4ece\u8282\u70b9 \u5355\u72ec\u5904\u7406\uff0c\u907f\u514d\u5bf9\u7ebf\u4e0a\u7528\u6237\u9020\u6210\u5f71\u54cd;</li> <li>\u5c06\u7528\u6237\u4e0a\u4f20\u7684\u56fe\u7247\u5206\u53d1\u5230\u5168\u4e16\u754c\uff0c\u8ba9\u5404\u5730\u7528\u6237\u80fd\u591f\u5c31\u8fd1\u8bfb\u53d6\u2014\u2014nearest\u3002\u6bcf\u4e2a\u5730\u533a \u7684\u5e94\u7528\u9009\u62e9\u6700\u8fd1\u7684\u8282\u70b9\u8bfb\u53d6\u6570\u636e\u3002</li> </ul>"},{"location":"mongo2/6mon_red_write/#readpreference-tag","title":"readPreference \u4e0e Tag","text":"<p>readPreference \u53ea\u80fd\u63a7\u5236\u4f7f\u7528\u4e00\u7c7b\u8282\u70b9\u3002Tag \u5219\u53ef\u4ee5\u5c06\u8282\u70b9\u9009\u62e9\u63a7\u5236 \u5230\u4e00\u4e2a\u6216\u51e0\u4e2a\u8282\u70b9\u3002\u8003\u8651\u4ee5\u4e0b\u573a\u666f:</p> <ul> <li>\u4e00\u4e2a5\u4e2a\u8282\u70b9\u7684\u590d\u5236\u96c6;</li> <li>3\u4e2a\u8282\u70b9\u786c\u4ef6\u8f83\u597d\uff0c\u4e13\u7528\u4e8e\u670d\u52a1\u7ebf\u4e0a\u5ba2\u6237;</li> <li>2\u4e2a\u8282\u70b9\u786c\u4ef6\u8f83\u5dee\uff0c\u4e13\u7528\u4e8e\u751f\u6210\u62a5\u8868</li> </ul> <p>\u53ef\u4ee5\u4f7f\u7528 Tag \u6765\u8fbe\u5230\u8fd9\u6837\u7684\u63a7\u5236\u76ee\u7684:</p> <ul> <li>\u4e3a3\u4e2a\u8f83\u597d\u7684\u8282\u70b9\u6253\u4e0a<code>{purpose:\"online\"}</code>;</li> <li>\u4e3a2\u4e2a\u8f83\u5dee\u7684\u8282\u70b9\u6253\u4e0a<code>{purpose:\"analyse\"}</code>;</li> <li>\u5728\u7ebf\u5e94\u7528\u8bfb\u53d6\u65f6\u6307\u5b9aonline\uff0c\u62a5\u8868\u8bfb\u53d6\u65f6\u6307\u5b9areporting\u3002</li> </ul> <p>\u66f4\u591a\u4fe1\u606f\u8bf7\u53c2\u8003\u6587\u6863: readPreference</p> <p></p>"},{"location":"mongo2/6mon_red_write/#readpreference_2","title":"readPreference \u914d\u7f6e","text":"<p>\u901a\u8fc7 MongoDB \u7684\u8fde\u63a5\u4e32\u53c2\u6570:</p> <p><code>mongodb://host1:27107,host2:27107,host3:27017/?replicaSet=rs&amp;readPreference=secondary</code></p> <p>\u901a\u8fc7 MongoDB \u9a71\u52a8\u7a0b\u5e8f API:</p> <pre><code>MongoCollection.withReadPreference(ReadPreferencereadPref)\n</code></pre> <p>Mongo Shell:</p> <pre><code>db.collection.find({}).readPref(\"secondary\")\n</code></pre>"},{"location":"mongo2/6mon_red_write/#readpreference_3","title":"readPreference \u5b9e\u9a8c: \u4ece\u8282\u70b9\u8bfb","text":"<ul> <li>\u4e3b\u8282\u70b9\u5199\u5165<code>{x:1}</code>,\u89c2\u5bdf\u8be5\u6761\u6570\u636e\u5728\u5404\u4e2a\u8282\u70b9\u5747\u53ef\u89c1</li> </ul> <p>On primary to read secondary: Okay</p> <p></p> <ul> <li>\u5728\u4e24\u4e2a\u4ece\u8282\u70b9\u5206\u522b\u6267\u884c <code>db.fsyncLock()</code> \u6765\u9501\u5b9a\u5199\u5165(\u540c\u6b65)</li> </ul> <p></p> <ul> <li>\u4e3b\u8282\u70b9\u5199\u5165<code>{x:2}</code></li> </ul> <p></p> <ul> <li>\u6b21\u8282\u70b9\u65e0\u6cd5\u8bfb\u5230\u65b0\u7684\u65b0\u63d2\u5165\u7684\u6570\u636e\uff0c \u4f46\u662f\u4e3b\u8282\u70b9\u53ef\u4ee5\u8bfb\u5230</li> </ul> <p></p> <p></p> <ul> <li><code>db.test.find({a:123})</code></li> <li><code>db.test.find({a:123}).readPref(\"secondary\")</code> </li> </ul> <p></p> <ul> <li>\u89e3\u9664\u4ece\u8282\u70b9\u9501\u5b9a<code>db.fsyncUnlock()</code></li> </ul> <p></p> <ul> <li><code>db.test.find({a:123}).readPref(\"secondary\u201d)</code></li> </ul> <p></p> <p></p>"},{"location":"mongo2/6mon_red_write/#_4","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u6307\u5b9areadPreference\u65f6\u4e5f\u5e94\u6ce8\u610f\u9ad8\u53ef\u7528\u95ee\u9898\u3002\u4f8b\u5982\u5c06readPreference\u6307\u5b9aprimary\uff0c\u5219\u53d1\u751f\u6545\u969c\u8f6c\u79fb\u4e0d\u5b58\u5728 primary \u671f\u95f4\u5c06\u6ca1\u6709\u8282\u70b9\u53ef\u8bfb\u3002\u5982\u679c\u4e1a\u52a1\u5141\u8bb8\uff0c\u5219\u5e94\u9009\u62e9 primaryPreferred;</li> <li>\u4f7f\u7528Tag\u65f6\u4e5f\u4f1a\u9047\u5230\u540c\u6837\u7684\u95ee\u9898\uff0c\u5982\u679c\u53ea\u6709\u4e00\u4e2a\u8282\u70b9\u62e5\u6709\u4e00\u4e2a\u7279\u5b9aTag\uff0c\u5219\u5728\u8fd9\u4e2a\u8282\u70b9\u5931\u6548\u65f6 \u5c06\u65e0\u8282\u70b9\u53ef\u8bfb\u3002\u8fd9\u5728\u6709\u65f6\u5019\u662f\u671f\u671b\u7684\u7ed3\u679c\uff0c\u6709\u65f6\u5019\u4e0d\u662f\u3002\u4f8b\u5982:<ul> <li>\u5982\u679c\u62a5\u8868\u4f7f\u7528\u7684\u8282\u70b9\u5931\u6548\uff0c\u5373\u4f7f\u4e0d\u751f\u6210\u62a5\u8868\uff0c\u901a\u5e38\u4e5f\u4e0d\u5e0c\u671b\u5c06\u62a5\u8868\u8d1f\u8f7d\u8f6c\u79fb\u5230\u5176\u4ed6\u8282\u70b9\u4e0a\uff0c\u6b64\u65f6\u53ea\u6709\u4e00\u4e2a \u8282\u70b9\u6709\u62a5\u8868 Tag \u662f\u5408\u7406\u7684\u9009\u62e9;</li> <li>\u5982\u679c\u7ebf\u4e0a\u8282\u70b9\u5931\u6548\uff0c\u901a\u5e38\u5e0c\u671b\u6709\u66ff\u4ee3\u8282\u70b9\uff0c\u6240\u4ee5\u5e94\u8be5\u4fdd\u6301\u591a\u4e2a\u8282\u70b9\u6709\u540c\u6837\u7684Tag;</li> </ul> </li> <li>Tag\u6709\u65f6\u9700\u8981\u4e0e\u4f18\u5148\u7ea7\u3001\u9009\u4e3e\u6743\u7efc\u5408\u8003\u8651\u3002\u4f8b\u5982\u505a\u62a5\u8868\u7684\u8282\u70b9\u901a\u5e38\u4e0d\u4f1a\u5e0c\u671b\u5b83\u6210\u4e3a\u4e3b\u8282\u70b9\uff0c\u5219 \u4f18\u5148\u7ea7\u5e94\u4e3a 0</li> </ul>"},{"location":"mongo2/6mon_red_write/#3","title":"3 \u4e8b\u52a1\u5f00\u53d1:\u8bfb\u64cd\u4f5c\u4e8b\u52a1\u4e4b\u4e8c","text":""},{"location":"mongo2/6mon_red_write/#readconcern","title":"\u4ec0\u4e48\u662f readConcern?","text":"<p>\u5728 readPreference \u9009\u62e9\u4e86\u6307\u5b9a\u7684\u8282\u70b9\u540e\uff0creadConcern \u51b3\u5b9a\u8fd9\u4e2a\u8282\u70b9\u4e0a\u7684\u6570\u636e\u54ea\u4e9b \u662f\u53ef\u8bfb\u7684\uff0c\u7c7b\u4f3c\u4e8e\u5173\u7cfb\u6570\u636e\u5e93\u7684\u9694\u79bb\u7ea7\u522b\u3002\u53ef\u9009\u503c\u5305\u62ec:</p> <ul> <li>available:\u8bfb\u53d6\u6240\u6709\u53ef\u7528\u7684\u6570\u636e;</li> <li>local:\u8bfb\u53d6\u6240\u6709\u53ef\u7528\u4e14\u5c5e\u4e8e\u5f53\u524d\u5206\u7247\u7684\u6570\u636e;</li> <li>majority:\u8bfb\u53d6\u5728\u5927\u591a\u6570\u8282\u70b9\u4e0a\u63d0\u4ea4\u5b8c\u6210\u7684\u6570\u636e; </li> <li>linearizable:\u53ef\u7ebf\u6027\u5316\u8bfb\u53d6\u6587\u6863;</li> <li>snapshot:\u8bfb\u53d6\u6700\u8fd1\u5feb\u7167\u4e2d\u7684\u6570\u636e;</li> </ul>"},{"location":"mongo2/6mon_red_write/#readconcern-local-available","title":"readConcern: local \u548c available","text":"<p>\u5728\u590d\u5236\u96c6\u4e2d local \u548c available \u662f\u6ca1\u6709\u533a\u522b\u7684\u3002\u4e24\u8005\u7684\u533a\u522b\u4e3b\u8981\u4f53\u73b0\u5728\u5206\u7247\u96c6\u4e0a\u3002\u8003\u8651\u4ee5\u4e0b\u573a\u666f:</p> <ul> <li>\u4e00\u4e2a<code>chunkx</code>\u6b63\u5728\u4ece<code>shard1</code>\u5411<code>shard2</code>\u8fc1\u79fb;</li> <li>\u6574\u4e2a\u8fc1\u79fb\u8fc7\u7a0b\u4e2d<code>chunkx</code>\u4e2d\u7684\u90e8\u5206\u6570\u636e\u4f1a\u5728<code>shard1</code>\u548c<code>shard2</code>\u4e2d\u540c\u65f6\u5b58\u5728\uff0c\u4f46\u6e90\u5206\u7247<code>shard1</code>\u4ecd\u7136\u662f chunk x \u7684\u8d1f\u8d23\u65b9:<ul> <li>\u6240\u6709\u5bf9<code>chunkx</code>\u7684\u8bfb\u5199\u64cd\u4f5c\u4ecd\u7136\u8fdb\u5165<code>shard1</code>;</li> <li><code>config</code>\u4e2d\u8bb0\u5f55\u7684\u4fe1\u606fchunkx\u4ecd\u7136\u5c5e\u4e8e<code>shard1</code>;</li> </ul> </li> <li>\u6b64\u65f6\u5982\u679c\u8bfbshard2\uff0c\u5219\u4f1a\u4f53\u73b0\u51falocal\u548cavailable\u7684\u533a\u522b:<ul> <li><code>local</code> :\u53ea\u53d6\u5e94\u8be5\u7531shard2\u8d1f\u8d23\u7684\u6570\u636e(\u4e0d\u5305\u62ecx);</li> <li><code>available:shard2</code>\u4e0a\u6709\u4ec0\u4e48\u5c31\u8bfb\u4ec0\u4e48(\u5305\u62ecx);</li> </ul> </li> </ul> <p></p> <p>\u6ce8\u610f\u4e8b\u9879:</p> <ul> <li>\u867d\u7136\u770b\u4e0a\u53bb\u603b\u662f\u5e94\u8be5\u9009\u62e9local\uff0c\u4f46\u6bd5\u7adf\u5bf9\u7ed3\u679c\u96c6\u8fdb\u884c\u8fc7\u6ee4\u4f1a\u9020\u6210\u989d\u5916\u6d88\u8017\u3002\u5728\u4e00\u4e9b\u65e0\u5173\u7d27\u8981\u7684\u573a\u666f(\u4f8b\u5982\u7edf\u8ba1)\u4e0b\uff0c\u4e5f\u53ef\u4ee5\u8003\u8651 available;</li> <li><code>MongoDB&lt;=3.6</code>\u4e0d\u652f\u6301\u5bf9\u4ece\u8282\u70b9\u4f7f\u7528<code>{readConcern:\"local\"}</code>;</li> <li>\u4ece\u4e3b\u8282\u70b9\u8bfb\u53d6\u6570\u636e\u65f6\u9ed8\u8ba4<code>readConcern</code>\u662f<code>local</code>\uff0c\u4ece\u4ece\u8282\u70b9\u8bfb\u53d6\u6570\u636e\u65f6\u9ed8\u8ba4<code>readConcern</code> \u662f <code>available</code>(\u5411\u524d\u517c\u5bb9\u539f\u56e0)\u3002</li> </ul>"},{"location":"mongo2/6mon_red_write/#readconcern-majority","title":"<code>readConcern: majority</code>","text":"<p>\u53ea\u8bfb\u53d6\u5927\u591a\u6570\u636e\u8282\u70b9\u4e0a\u90fd\u63d0\u4ea4\u4e86\u7684\u6570\u636e\u3002\u8003\u8651\u5982\u4e0b\u573a\u666f:</p> <ul> <li>\u96c6\u5408\u4e2d\u539f\u6709\u6587\u6863 <code>{x: 0}</code>;</li> <li>\u5c06x\u503c\u66f4\u65b0\u4e3a 1;</li> </ul> <p>\u5982\u679c\u5728\u5404\u8282\u70b9\u4e0a\u5e94\u7528<code>{readConcern: \"majority\"}</code>\u6765\u8bfb\u53d6\u6570\u636e:</p> <p></p> <p></p>"},{"location":"mongo2/6mon_red_write/#readconcern-majority_1","title":"<code>readConcern: majority</code> \u7684\u5b9e\u73b0\u65b9\u5f0f","text":"<p>\u8003\u8651 t3 \u65f6\u523b\u7684 <code>Secondary1</code>\uff0c\u6b64\u65f6:</p> <ul> <li>\u5bf9\u4e8e\u8981\u6c42<code>majority</code>\u7684\u8bfb\u64cd\u4f5c\uff0c\u5b83\u5c06\u8fd4\u56de<code>x=0</code>;</li> <li>\u5bf9\u4e8e\u4e0d\u8981\u6c42<code>majority</code>\u7684\u8bfb\u64cd\u4f5c\uff0c\u5b83\u5c06\u8fd4\u56de<code>x=1</code>;</li> </ul> <p>\u5982\u4f55\u5b9e\u73b0?</p> <ul> <li>\u8282\u70b9\u4e0a\u7ef4\u62a4\u591a\u4e2a x \u7248\u672c\uff0cMVCC \u673a\u5236</li> <li>MongoDB \u901a\u8fc7\u7ef4\u62a4\u591a\u4e2a\u5feb\u7167\u6765\u94fe\u63a5\u4e0d\u540c\u7684\u7248\u672c:<ul> <li>\u6bcf\u4e2a\u88ab\u5927\u591a\u6570\u8282\u70b9\u786e\u8ba4\u8fc7\u7684\u7248\u672c\u90fd\u5c06\u662f\u4e00\u4e2a\u5feb\u7167</li> <li>\u5feb\u7167\u6301\u7eed\u5230\u6ca1\u6709\u4eba\u4f7f\u7528\u4e3a\u6b62\u624d\u88ab\u5220\u9664;</li> </ul> </li> </ul> <p></p>"},{"location":"mongo2/6mon_red_write/#readconcern-majority-vs-local","title":"\u5b9e\u9a8c: <code>readConcern : \"majority\" vs \"local\"</code>","text":"<ul> <li>\u5b89\u88c53\u8282\u70b9\u590d\u5236\u96c6\u3002</li> <li>\u6ce8\u610f\u914d\u7f6e\u6587\u4ef6\u5185server\u53c2\u6570<code>enableMajorityReadConcern</code></li> </ul> <ul> <li>\u5c06\u590d\u5236\u96c6\u4e2d\u7684\u4e24\u4e2a\u4ece\u8282\u70b9\u4f7f\u7528<code>db.fsyncLock()</code>\u9501\u4f4f\u5199\u5165(\u6a21\u62df\u540c\u6b65\u5ef6\u8fdf)</li> </ul>"},{"location":"mongo2/6mon_red_write/#readconcern_1","title":"readConcern \u9a8c\u8bc1","text":"<p>\u56e0\u4e3a\u4ece\u8282\u70b9\u88ab\u9501\u7684\u539f\u56e0\uff0c findConcern(\"majority\") \u4f1a\u5361\u4f4f</p> <ul> <li>\u5728\u67d0\u4e00\u4e2a\u4ece\u8282\u70b9\u4e0a\u6267\u884c<code>db.fsyncUnlock()</code></li> </ul> <p></p> <p>\u7ed3\u8bba:</p> <ul> <li>\u4f7f\u7528local\u53c2\u6570\uff0c\u5219\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2\u5230\u5199\u5165\u6570\u636e</li> <li>\u4f7f\u7528majority\uff0c\u53ea\u80fd\u67e5\u8be2\u5230\u5df2\u7ecf\u88ab\u591a\u6570\u8282\u70b9\u786e\u8ba4\u8fc7\u7684\u6570\u636e </li> <li>update\u4e0eremove\u4e0e\u4e0a\u540c\u7406\u3002</li> </ul>"},{"location":"mongo2/6mon_red_write/#readconcern-majority_2","title":"readConcern: majority \u4e0e\u810f\u8bfb","text":"<p>MongoDB \u4e2d\u7684\u56de\u6eda:</p> <ul> <li>\u5199\u64cd\u4f5c\u5230\u8fbe\u5927\u591a\u6570\u8282\u70b9\u4e4b\u524d\u90fd\u662f\u4e0d\u5b89\u5168\u7684\uff0c\u4e00\u65e6\u4e3b\u8282\u70b9\u5d29\u6e83\uff0c\u800c\u4ece\u8282\u8fd8\u6ca1\u590d\u5236\u5230\u8be5 \u6b21\u64cd\u4f5c\uff0c\u521a\u624d\u7684\u5199\u64cd\u4f5c\u5c31\u4e22\u5931\u4e86;</li> <li>\u628a\u4e00\u6b21\u5199\u64cd\u4f5c\u89c6\u4e3a\u4e00\u4e2a\u4e8b\u52a1\uff0c\u4ece\u4e8b\u52a1\u7684\u89d2\u5ea6\uff0c\u53ef\u4ee5\u8ba4\u4e3a\u4e8b\u52a1\u88ab\u56de\u6eda\u4e86\u3002</li> </ul> <p>\u6240\u4ee5\u4ece\u5206\u5e03\u5f0f\u7cfb\u7edf\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u4e8b\u52a1\u7684\u63d0\u4ea4\u88ab\u63d0\u5347\u5230\u4e86\u5206\u5e03\u5f0f\u96c6\u7fa4\u7684\u591a\u4e2a\u8282\u70b9\u7ea7\u522b\u7684\u201c\u63d0\u4ea4\u201d\uff0c\u800c\u4e0d\u518d\u662f\u5355\u4e2a\u8282\u70b9\u4e0a\u7684\u201c\u63d0\u4ea4\u201d\u3002</p> <p>\u5728\u53ef\u80fd\u53d1\u751f\u56de\u6eda\u7684\u524d\u63d0\u4e0b\u8003\u8651\u810f\u8bfb\u95ee\u9898:</p> <ul> <li>\u5982\u679c\u5728\u4e00\u6b21\u5199\u64cd\u4f5c\u5230\u8fbe\u5927\u591a\u6570\u8282\u70b9\u524d\u8bfb\u53d6\u4e86\u8fd9\u4e2a\u5199\u64cd\u4f5c\uff0c\u7136\u540e\u56e0\u4e3a\u7cfb\u7edf\u6545\u969c\u8be5\u64cd\u4f5c \u56de\u6eda\u4e86\uff0c\u5219\u53d1\u751f\u4e86\u810f\u8bfb\u95ee\u9898;</li> </ul> <p>\u4f7f\u7528 <code>{readConcern: \"majority\"}</code>\u53ef\u4ee5\u6709\u6548\u907f\u514d\u810f\u8bfb</p>"},{"location":"mongo2/6mon_red_write/#readconcern_2","title":"readConcern: \u5982\u4f55\u5b9e\u73b0\u5b89\u5168\u7684\u8bfb\u5199\u5206\u79bb","text":"<p>\u8003\u8651\u5982\u4e0b\u573a\u666f:</p> <ul> <li>\u5411\u4e3b\u8282\u70b9\u5199\u5165\u4e00\u6761\u6570\u636e;</li> <li>\u7acb\u5373\u4ece\u4ece\u8282\u70b9\u8bfb\u53d6\u8fd9\u6761\u6570\u636e\u3002</li> </ul> <p>\u5982\u4f55\u4fdd\u8bc1\u81ea\u5df1\u80fd\u591f\u8bfb\u5230\u521a\u521a\u5199\u5165\u7684\u6570\u636e?</p> <p></p> <p>\u4e0b\u8ff0\u65b9\u5f0f\u6709\u53ef\u80fd\u8bfb\u4e0d\u5230\u521a\u5199\u5165\u7684\u8ba2\u5355</p> <pre><code>db.orders.insert({ oid: 101, sku: \"kite\", q: 1}) \n\ndb.orders.find({oid:101}).readPref(\"secondary\")\n</code></pre> <p>\u4f7f\u7528 <code>writeConcern + readConcern majority</code> \u6765\u89e3\u51b3</p> <pre><code>db.orders.insert({ oid: 101, sku: \"kiteboar\", q: 1}, {writeConcern:{w: \"majority\"}}) \n\ndb.orders.find({oid:101}).readPref(\"secondary\").readConcern(\"majority\")\n</code></pre> <p></p> <pre><code>&gt; db.tx.insert([{x:1},{x:2}])\nBulkWriteResult({\n    \"writeErrors\" : [ ],\n    \"writeConcernErrors\" : [ ],\n    \"nInserted\" : 2,\n    \"nUpserted\" : 0,\n    \"nMatched\" : 0,\n    \"nModified\" : 0,\n    \"nRemoved\" : 0,\n    \"upserted\" : [ ]\n})\n</code></pre> <pre><code>&gt; db.tx.find()\n{ \"_id\" : ObjectId(\"6270754123c7ad7cc7cb0e48\"), \"x\" : 1 }\n{ \"_id\" : ObjectId(\"6270754123c7ad7cc7cb0e49\"), \"x\" : 2 }\n</code></pre> <pre><code>&gt; var session = db.getMongo().startSession()\n&gt; session.startTransaction()\n&gt; var coll = session.getDatabase(\"test\").getCollection(\"txt\")\n&gt; coll.update({x:1}, {$set: {y:1}})\nWriteCommandError({\n    \"ok\" : 0,\n    \"errmsg\" : \"Transaction numbers are only allowed on a replica set member or mongos\",\n    \"code\" : 20,\n    \"codeName\" : \"IllegalOperation\"\n})\n</code></pre> <p>Transaction numbers are only allowed on a replica set member or mongos</p> <p></p> <p></p> <p></p>"},{"location":"mongo2/6mon_red_write/#_5","title":"\u5c0f\u6d4b\u8bd5","text":"<p>readConcern \u4e3b\u8981\u5173\u6ce8\u8bfb\u7684\u9694\u79bb\u6027\uff0c ACID \u4e2d\u7684 Isolation\uff0c \u4f46\u662f\u662f\u5206\u5e03\u5f0f\u6570\u636e\u5e93\u91cc\u7279\u6709\u7684\u6982\u5ff5</p> <p>readCocnern: majority \u5bf9\u5e94\u4e8e\u4e8b\u52a1\u4e2d\u9694\u79bb\u7ea7\u522b\u4e2d\u7684\u54ea\u4e00\u7ea7?</p> <ul> <li>Read Uncommited </li> <li>Read Committed </li> <li>Repeatable </li> <li>Read Seriazable</li> </ul>"},{"location":"mongo2/6mon_red_write/#readconcern-linearizable","title":"readConcern: linearizable","text":"<p>\u53ea\u8bfb\u53d6\u5927\u591a\u6570\u8282\u70b9\u786e\u8ba4\u8fc7\u7684\u6570\u636e\u3002\u548c majority \u6700\u5927\u5dee\u522b\u662f\u4fdd\u8bc1\u7edd\u5bf9\u7684\u64cd\u4f5c\u7ebf\u6027\u987a\u5e8f \u2013 \u5728\u5199\u64cd\u4f5c\u81ea\u7136\u65f6\u95f4\u540e\u9762\u7684\u53d1\u751f\u7684\u8bfb\uff0c\u4e00\u5b9a\u53ef\u4ee5\u8bfb\u5230\u4e4b\u524d\u7684\u5199</p> <ul> <li>\u53ea\u5bf9\u8bfb\u53d6\u5355\u4e2a\u6587\u6863\u65f6\u6709\u6548;</li> <li>\u53ef\u80fd\u5bfc\u81f4\u975e\u5e38\u6162\u7684\u8bfb\uff0c\u56e0\u6b64\u603b\u662f\u5efa\u8bae\u914d\u5408\u4f7f\u7528 maxTimeMS;</li> </ul> <p>\u53ea\u8bfb\u53d6\u5927\u591a\u6570\u8282\u70b9\u786e\u8ba4\u8fc7\u7684\u6570\u636e\u3002\u548c majority \u6700\u5927\u5dee\u522b\u662f\u4fdd\u8bc1\u7edd\u5bf9\u7684\u64cd\u4f5c\u7ebf\u6027\u987a\u5e8f \u2013 \u5728\u5199\u64cd\u4f5c\u81ea\u7136\u65f6\u95f4\u540e\u9762\u7684\u53d1\u751f\u7684\u8bfb\uff0c\u4e00\u5b9a\u53ef\u4ee5\u8bfb\u5230\u4e4b\u524d\u7684\u5199</p> <ul> <li>\u53ea\u5bf9\u8bfb\u53d6\u5355\u4e2a\u6587\u6863\u65f6\u6709\u6548;</li> <li>\u53ef\u80fd\u5bfc\u81f4\u975e\u5e38\u6162\u7684\u8bfb\uff0c\u56e0\u6b64\u603b\u662f\u5efa\u8bae\u914d\u5408\u4f7f\u7528 maxTimeMS;</li> </ul> <p></p>"},{"location":"mongo2/6mon_red_write/#readconcern-snapshot","title":"readConcern: snapshot","text":"<p><code>{readConcern: \u201csnapshot\u201d}</code>\u53ea\u5728\u591a\u6587\u6863\u4e8b\u52a1\u4e2d\u751f\u6548\u3002\u5c06\u4e00\u4e2a\u4e8b\u52a1\u7684 readConcern \u8bbe\u7f6e\u4e3a snapshot\uff0c\u5c06\u4fdd\u8bc1\u5728\u4e8b\u52a1\u4e2d\u7684\u8bfb:</p> <ul> <li>\u4e0d\u51fa\u73b0\u810f\u8bfb;</li> <li>\u4e0d\u51fa\u73b0\u4e0d\u53ef\u91cd\u590d\u8bfb;</li> <li>\u4e0d\u51fa\u73b0\u5e7b\u8bfb\u3002</li> </ul> <p>\u56e0\u4e3a\u6240\u6709\u7684\u8bfb\u90fd\u5c06\u4f7f\u7528\u540c\u4e00\u4e2a\u5feb\u7167\uff0c\u76f4\u5230\u4e8b\u52a1\u63d0\u4ea4\u4e3a\u6b62\u8be5\u5feb\u7167\u624d\u88ab\u91ca\u653e\u3002</p>"},{"location":"mongo2/6mon_red_write/#readconcern_3","title":"readConcern: \u5c0f\u7ed3","text":"<ul> <li>available:\u8bfb\u53d6\u6240\u6709\u53ef\u7528\u7684\u6570\u636e</li> <li>local:\u8bfb\u53d6\u6240\u6709\u53ef\u7528\u4e14\u5c5e\u4e8e\u5f53\u524d\u5206\u7247\u7684\u6570\u636e\uff0c\u9ed8\u8ba4\u8bbe\u7f6e</li> <li>majority:\u6570\u636e\u8bfb\u4e00\u81f4\u6027\u7684\u5145\u5206\u4fdd\u8bc1\uff0c\u53ef\u80fd\u4f60\u6700\u9700\u8981\u5173\u6ce8\u7684</li> <li>linearizable:\u589e\u5f3a\u5904\u7406majority\u60c5\u51b5\u4e0b\u4e3b\u8282\u70b9\u5931\u8054\u65f6\u5019\u7684\u4f8b\u5916\u60c5\u51b5 </li> <li>snapshot:\u6700\u9ad8\u9694\u79bb\u7ea7\u522b\uff0c\u63a5\u8fd1\u4e8eSeriazable</li> </ul>"},{"location":"mongo2/6mon_red_write/#4","title":"4 \u4e8b\u52a1\u5f00\u53d1:\u591a\u6587\u6863\u4e8b\u52a1","text":"<p>\u5f00\u59cb\u4e4b\u524d......</p> <p>MongoDB \u867d\u7136\u5df2\u7ecf\u5728 4.2 \u5f00\u59cb\u5168\u9762\u652f\u6301\u4e86\u591a\u6587\u6863\u4e8b\u52a1\uff0c\u4f46\u5e76\u4e0d\u4ee3\u8868\u5927\u5bb6\u5e94\u8be5\u6beb\u65e0\u8282\u5236 \u5730\u4f7f\u7528\u5b83\u3002\u76f8\u53cd\uff0c\u5bf9\u4e8b\u52a1\u7684\u4f7f\u7528\u539f\u5219\u5e94\u8be5\u662f:\u80fd\u4e0d\u7528\u5c3d\u91cf\u4e0d\u7528\u3002</p> <p>\u901a\u8fc7\u5408\u7406\u5730\u8bbe\u8ba1\u6587\u6863\u6a21\u578b\uff0c\u53ef\u4ee5\u89c4\u907f\u7edd\u5927\u90e8\u5206\u4f7f\u7528\u4e8b\u52a1\u7684\u5fc5\u8981\u6027 </p> <p>\u4e3a\u4ec0\u4e48?\u4e8b\u52a1 = \u9501\uff0c\u8282\u70b9\u534f\u8c03\uff0c\u989d\u5916\u5f00\u9500\uff0c\u6027\u80fd\u5f71\u54cd</p>"},{"location":"mongo2/6mon_red_write/#mongodb-acid","title":"MongoDB ACID \u591a\u6587\u6863\u4e8b\u52a1\u652f\u6301","text":"<p>\u4f7f\u7528\u65b9\u6cd5</p> <p>MongoDB \u591a\u6587\u6863\u4e8b\u52a1\u7684\u4f7f\u7528\u65b9\u5f0f\u4e0e\u5173\u7cfb\u6570\u636e\u5e93\u975e\u5e38\u76f8\u4f3c:</p> <pre><code>try (ClientSession clientSession = client.startSession()) { \n    clientSession.startTransaction(); \n    collection.insertOne(clientSession, docOne); \n    collection.insertOne(clientSession, docTwo); \n    clientSession.commitTransaction();\n}\n</code></pre>"},{"location":"mongo2/6mon_red_write/#_6","title":"\u4e8b\u52a1\u7684\u9694\u79bb\u7ea7\u522b","text":"<ul> <li>\u4e8b\u52a1\u5b8c\u6210\u524d\uff0c\u4e8b\u52a1\u5916\u7684\u64cd\u4f5c\u5bf9\u8be5\u4e8b\u52a1\u6240\u505a\u7684\u4fee\u6539\u4e0d\u53ef\u8bbf\u95ee</li> <li>\u5982\u679c\u4e8b\u52a1\u5185\u4f7f\u7528 <code>{readConcern: \"snapshot\"}</code>\uff0c\u5219\u53ef\u4ee5\u8fbe\u5230\u53ef\u91cd\u590d\u8bfb <code>Repeatable Read</code></li> </ul>"},{"location":"mongo2/6mon_red_write/#_7","title":"\u5b9e\u9a8c:\u542f\u7528\u4e8b\u52a1\u540e\u7684\u9694\u79bb\u6027","text":"<pre><code>db.tx.insertMany([{ x: 1 }, { x: 2 }]);\n\nvar session = db.getMongo().startSession(); \n\nsession.startTransaction();\n\nvar coll = session.getDatabase('test').getCollection(\"tx\");\n</code></pre> <pre><code>session.abortTransaction();\n</code></pre>"},{"location":"mongo2/6mon_red_write/#repeatable-read","title":"\u5b9e\u9a8c:\u53ef\u91cd\u590d\u8bfb Repeatable Read","text":"<p>MongoDB \u7684\u4e8b\u52a1\u9519\u8bef\u5904\u7406\u673a\u5236\u4e0d\u540c\u4e8e\u5173\u7cfb\u6570\u636e\u5e93:</p> <ul> <li>\u5f53\u4e00\u4e2a\u4e8b\u52a1\u5f00\u59cb\u540e\uff0c\u5982\u679c\u4e8b\u52a1\u8981\u4fee\u6539\u7684\u6587\u6863\u5728\u4e8b\u52a1\u5916\u90e8\u88ab\u4fee\u6539\u8fc7\uff0c\u5219\u4e8b\u52a1\u4fee\u6539\u8fd9\u4e2a \u6587\u6863\u65f6\u4f1a\u89e6\u53d1 Abort \u9519\u8bef\uff0c\u56e0\u4e3a\u6b64\u65f6\u7684\u4fee\u6539\u51b2\u7a81\u4e86;</li> <li>\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u53ea\u9700\u8981\u7b80\u5355\u5730\u91cd\u505a\u4e8b\u52a1\u5c31\u53ef\u4ee5\u4e86;</li> <li>\u5982\u679c\u4e00\u4e2a\u4e8b\u52a1\u5df2\u7ecf\u5f00\u59cb\u4fee\u6539\u4e00\u4e2a\u6587\u6863\uff0c\u5728\u4e8b\u52a1\u4ee5\u5916\u5c1d\u8bd5\u4fee\u6539\u540c\u4e00\u4e2a\u6587\u6863\uff0c\u5219\u4e8b\u52a1\u4ee5 \u5916\u7684\u4fee\u6539\u4f1a\u7b49\u5f85\u4e8b\u52a1\u5b8c\u6210\u624d\u80fd\u7ee7\u7eed\u8fdb\u884c\u3002</li> </ul>"},{"location":"mongo2/6mon_red_write/#_8","title":"\u5b9e\u9a8c:\u5199\u51b2\u7a81","text":"<p>\u7ee7\u7eed\u4f7f\u7528\u4e0a\u4e2a\u5b9e\u9a8c\u7684tx\u96c6\u5408</p> <p>\u5f00\u4e24\u4e2a mongo shell \u5747\u6267\u884c\u4e0b\u8ff0\u8bed\u53e5</p> <pre><code>var session = db.getMongo().startSession(); \n\nsession.startTransaction({ readConcern: {level: \"snapshot\"},\n    writeConcern: {w: \"majority\"}});\n\nvar coll = session.getDatabase('test').getCollection(\"tx\");\n</code></pre> <p>\u7a97\u53e31:</p> <pre><code>coll.updateOne({x: 1}, {$set: {y: 1}});  // \u6b63\u5e38\u7ed3\u675f\n</code></pre> <p>\u7a97\u53e32:</p> <pre><code>coll.updateOne({x: 1}, {$set: {y: 2}}); // \u5f02\u5e38 \u2013 \u89e3\u51b3\u65b9\u6848:\u91cd\u542f\u4e8b\u52a1\n</code></pre> <p>\u7a97\u53e31:\u7b2c\u4e00\u4e2a\u4e8b\u52a1\uff0c\u6b63\u5e38\u63d0\u4ea4</p> <pre><code>coll.updateOne({x: 1}, {$set: {y: 1}});\n</code></pre> <p>\u7a97\u53e32:\u53e6\u4e00\u4e2a\u4e8b\u52a1\u66f4\u65b0\u540c\u4e00\u6761\u6570\u636e\uff0c\u5f02\u5e38</p> <pre><code>coll.updateOne({x: 1}, {$set: {y: 2}});\n</code></pre> <p>\u7a97\u53e33:\u4e8b\u52a1\u5916\u66f4\u65b0\uff0c\u9700\u7b49\u5f85</p> <pre><code>db.tx.updateOne({x: 1}, {$set: {y: 3}});\n</code></pre> <p></p> <p></p> <p></p>"},{"location":"mongo2/6mon_red_write/#_9","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u53ef\u4ee5\u5b9e\u73b0\u548c\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7c7b\u4f3c\u7684\u4e8b\u52a1\u573a\u666f</li> <li>\u5fc5\u987b\u4f7f\u7528\u4e0eMongoDB4.2\u517c\u5bb9\u7684\u9a71\u52a8;</li> <li>\u4e8b\u52a1\u9ed8\u8ba4\u5fc5\u987b\u572860\u79d2(\u53ef\u8c03)\u5185\u5b8c\u6210\uff0c\u5426\u5219\u5c06\u88ab\u53d6\u6d88;</li> <li>\u6d89\u53ca\u4e8b\u52a1\u7684\u5206\u7247\u4e0d\u80fd\u4f7f\u7528\u4ef2\u88c1\u8282\u70b9;</li> <li>\u4e8b\u52a1\u4f1a\u5f71\u54cdchunk\u8fc1\u79fb\u6548\u7387\u3002\u6b63\u5728\u8fc1\u79fb\u7684chunk\u4e5f\u53ef\u80fd\u9020\u6210\u4e8b\u52a1\u63d0\u4ea4\u5931\u8d25(\u91cd\u8bd5 \u5373\u53ef);</li> <li>\u591a\u6587\u6863\u4e8b\u52a1\u4e2d\u7684\u8bfb\u64cd\u4f5c\u5fc5\u987b\u4f7f\u7528\u4e3b\u8282\u70b9\u8bfb;</li> <li>readConcern\u53ea\u5e94\u8be5\u5728\u4e8b\u52a1\u7ea7\u522b\u8bbe\u7f6e\uff0c\u4e0d\u80fd\u8bbe\u7f6e\u5728\u6bcf\u6b21\u8bfb\u5199\u64cd\u4f5c\u4e0a\u3002</li> </ul>"},{"location":"mongo2/7mon_changestream_bestdesign/","title":"7 MongoDB Change Stream &amp; \u5f00\u53d1\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"mongo2/7mon_changestream_bestdesign/#1-change-stream","title":"1 Change Stream","text":""},{"location":"mongo2/7mon_changestream_bestdesign/#change-stream","title":"\u4ec0\u4e48\u662f Change Stream","text":"<p>Change Stream \u662f MongoDB \u7528\u4e8e\u5b9e\u73b0\u53d8\u66f4\u8ffd\u8e2a\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u7c7b\u4f3c\u4e8e\u5173\u7cfb\u6570\u636e\u5e93\u7684\u89e6\u53d1\u5668\uff0c\u4f46\u539f\u7406\u4e0d\u5b8c\u5168\u76f8\u540c:</p> <p></p>"},{"location":"mongo2/7mon_changestream_bestdesign/#change-stream_1","title":"Change Stream \u7684\u5b9e\u73b0\u539f\u7406","text":"<p>Change Stream \u662f\u57fa\u4e8e oplog \u5b9e\u73b0\u7684\u3002\u5b83\u5728 oplog \u4e0a\u5f00\u542f\u4e00\u4e2a <code>tailable cursor</code> \u6765\u8ffd\u8e2a\u6240\u6709\u590d\u5236\u96c6\u4e0a\u7684\u53d8\u66f4\u64cd\u4f5c\uff0c\u6700\u7ec8\u8c03\u7528\u5e94\u7528\u4e2d\u5b9a\u4e49\u7684\u56de\u8c03\u51fd\u6570\u3002</p> <p>\u88ab\u8ffd\u8e2a\u7684\u53d8\u66f4\u4e8b\u4ef6\u4e3b\u8981\u5305\u62ec:</p> <ul> <li>insert/update/delete: \u63d2\u5165\u3001\u66f4\u65b0\u3001\u5220\u9664;</li> <li>drop: \u96c6\u5408\u88ab\u5220\u9664;</li> <li>rename:       \u96c6\u5408\u88ab\u91cd\u547d\u540d;</li> <li>dropDatabase: \u6570\u636e\u5e93\u88ab\u5220\u9664;</li> <li>invalidate: <code>drop/rename/dropDatabase</code>\u5c06\u5bfc\u81f4invalidate\u88ab\u89e6\u53d1\uff0c \u5e76\u5173\u95ed <code>change stream</code>;</li> </ul> <p></p>"},{"location":"mongo2/7mon_changestream_bestdesign/#change-stream_2","title":"Change Stream \u4e0e\u53ef\u91cd\u590d\u8bfb","text":"<p>Change Stream \u53ea\u63a8\u9001\u5df2\u7ecf\u5728\u5927\u591a\u6570\u8282\u70b9\u4e0a\u63d0\u4ea4\u7684\u53d8\u66f4\u64cd\u4f5c\u3002\u5373\u201c\u53ef\u91cd\u590d\u8bfb\u201d\u7684\u53d8\u66f4\u3002 \u8fd9\u4e2a\u9a8c\u8bc1\u662f\u901a\u8fc7 <code>{readConcern: \"majority\"}</code> \u5b9e\u73b0\u7684\u3002\u56e0\u6b64:</p> <ul> <li>\u672a\u5f00\u542f majorityreadConcern \u7684\u96c6\u7fa4\u65e0\u6cd5\u4f7f\u7528ChangeStream;</li> <li>\u5f53\u96c6\u7fa4\u65e0\u6cd5\u6ee1\u8db3<code>{w:\"majority\"}</code>\u65f6\uff0c\u4e0d\u4f1a\u89e6\u53d1ChangeStream(\u4f8b\u5982PSA\u67b6\u6784 \u4e2d\u7684 S \u56e0\u6545\u969c\u5b95\u673a)\u3002</li> </ul> <p></p>"},{"location":"mongo2/7mon_changestream_bestdesign/#change-stream_3","title":"Change Stream \u53d8\u66f4\u8fc7\u6ee4","text":"<p>\u5982\u679c\u53ea\u5bf9\u67d0\u4e9b\u7c7b\u578b\u7684\u53d8\u66f4\u4e8b\u4ef6\u611f\u5174\u8da3\uff0c\u53ef\u4ee5\u4f7f\u7528\u4f7f\u7528\u805a\u5408\u7ba1\u9053\u7684\u8fc7\u6ee4\u6b65\u9aa4\u8fc7\u6ee4\u4e8b\u4ef6\u3002</p> <p>\u4f8b\u5982:</p> <pre><code>var cs = db.collection.watch([{\n    $match: {\n        operationType: {\n            $in: ['insert', 'delete']\n    } \n   }\n}])\n</code></pre>"},{"location":"mongo2/7mon_changestream_bestdesign/#change-stream_4","title":"Change Stream \u793a\u4f8b","text":"<p>Console 1</p> <pre><code>&gt; db.collection.watch([],\n{maxAwaitTimeMS: 30000}).pretty()\n</code></pre> <p>Console 2</p> <pre><code>&gt; db.collection.insert({\n    _id: 1,\n    text: \"hello\"\n  })\n</code></pre> <pre><code>{\n    _id : (resumeToken), \n    operationType : \"insert\", \n    ...\n    fullDocument : {\n        _id : 1,\n        text: \"hello\" \n    }\n}\n</code></pre> <p></p> <p></p> <p></p> <p></p>"},{"location":"mongo2/7mon_changestream_bestdesign/#change-stream_5","title":"Change Stream \u6545\u969c\u6062\u590d","text":"<p>\u5047\u8bbe\u5728\u4e00\u7cfb\u5217\u5199\u5165\u64cd\u4f5c\u7684\u8fc7\u7a0b\u4e2d\uff0c\u8ba2\u9605 Change Stream \u7684\u5e94\u7528\u5728\u63a5\u6536\u5230\u201c\u51993\u201d\u4e4b\u540e \u4e8e t0 \u65f6\u523b\u5d29\u6e83\uff0c\u91cd\u542f\u540e\u540e\u7eed\u7684\u53d8\u66f4\u600e\u4e48\u529e?</p> <p></p> <p>\u60f3\u8981\u4ece\u4e0a\u6b21\u4e2d\u65ad\u7684\u5730\u65b9\u7ee7\u7eed\u83b7\u53d6\u53d8\u66f4\u6d41\uff0c\u53ea\u9700\u8981\u4fdd\u7559\u4e0a\u6b21 \u53d8\u66f4\u901a\u77e5\u4e2d\u7684 <code>_id</code> \u5373\u53ef\u3002</p> <p>\u6240\u793a\u662f\u4e00\u6b21 Change Stream \u56de\u8c03\u6240\u8fd4\u56de\u7684\u6570\u636e\u3002\u6bcf \u6761\u8fd9\u6837\u7684\u6570\u636e\u90fd\u5e26\u6709\u4e00\u4e2a <code>_id</code>\uff0c\u8fd9\u4e2a <code>_id</code> \u53ef\u4ee5\u7528\u4e8e\u65ad\u70b9\u6062 \u590d\u3002\u4f8b\u5982</p> <pre><code>var cs = db.collection.watch([], {resumeAfter: &lt;_id&gt;})\n</code></pre> <p>\u5373\u53ef\u4ece\u4e0a\u4e00\u6761\u901a\u77e5\u4e2d\u65ad\u5904\u7ee7\u7eed\u83b7\u53d6\u540e\u7eed\u7684\u53d8\u66f4\u901a\u77e5\u3002</p> <pre><code>{\n    id : { \"_data\" : BinData(0,\"gl3dBycAAAABRmRfaWQAZF3dB ycMPJGagxioigBaEASFV+UNaJtBdbJ2j5fOD+3 GBA==\") },\n\n    operationType : \"insert\", \n    ns : {\n        db : \"test\",\n        coll : \"collection\"\n    }, \n    documentKey : { \n        _id:1\n    },\n    fullDocument : \n    { \n        _id : 1,\n        text: \"hello\"\n    } \n}\n</code></pre>"},{"location":"mongo2/7mon_changestream_bestdesign/#change-stream_6","title":"Change Stream \u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u8de8\u96c6\u7fa4\u7684\u53d8\u66f4\u590d\u5236\u2014\u2014\u5728\u6e90\u96c6\u7fa4\u4e2d\u8ba2\u9605ChangeStream\uff0c\u4e00\u65e6\u5f97\u5230\u4efb\u4f55\u53d8\u66f4\u7acb\u5373\u5199\u5165\u76ee\u6807\u96c6\u7fa4\u3002</li> <li>\u5fae\u670d\u52a1\u8054\u52a8\u2014\u2014\u5f53\u4e00\u4e2a\u5fae\u670d\u52a1\u53d8\u66f4\u6570\u636e\u5e93\u65f6\uff0c\u5176\u4ed6\u5fae\u670d\u52a1\u5f97\u5230\u901a\u77e5\u5e76\u505a\u51fa\u76f8\u5e94\u7684\u53d8\u66f4\u3002</li> <li>\u5176\u4ed6\u4efb\u4f55\u9700\u8981\u7cfb\u7edf\u8054\u52a8\u7684\u573a\u666f\u3002</li> </ul>"},{"location":"mongo2/7mon_changestream_bestdesign/#_1","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li><code>ChangeStream</code>\u4f9d\u8d56\u4e8e<code>oplog</code>\uff0c\u56e0\u6b64\u4e2d\u65ad\u65f6\u95f4\u4e0d\u53ef\u8d85\u8fc7<code>oplog</code>\u56de\u6536\u7684\u6700\u5927\u65f6\u95f4\u7a97; </li> <li>\u5728\u6267\u884c<code>update</code>\u64cd\u4f5c\u65f6\uff0c\u5982\u679c\u53ea\u66f4\u65b0\u4e86\u90e8\u5206\u6570\u636e\uff0c\u90a3\u4e48<code>ChangeStream</code>\u901a\u77e5\u7684\u4e5f \u662f\u589e\u91cf\u90e8\u5206;</li> <li>\u540c\u7406\uff0c\u5220\u9664\u6570\u636e\u65f6\u901a\u77e5\u7684\u4ec5\u662f\u5220\u9664\u6570\u636e\u7684<code>_id</code>\u3002</li> </ul>"},{"location":"mongo2/7mon_changestream_bestdesign/#2-mongodb","title":"2 MongoDB \u5f00\u53d1\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"mongo2/7mon_changestream_bestdesign/#mongodb","title":"\u8fde\u63a5\u5230 MongoDB","text":"<p>\u5173\u4e8e\u9a71\u52a8\u7a0b\u5e8f:\u603b\u662f\u9009\u62e9\u4e0e\u6240\u7528\u4e4bMongoDB\u76f8\u517c\u5bb9\u7684\u9a71\u52a8\u7a0b\u5e8f\u3002\u8fd9\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u4ece\u9a71\u52a8 \u517c\u5bb9\u5bf9\u7167\u8868\u4e2d\u67e5\u5230;</p> <ul> <li>\u5982\u679c\u4f7f\u7528\u7b2c\u4e09\u65b9\u6846\u67b6(\u5982SpringData)\uff0c\u5219\u8fd8\u9700\u8981\u8003\u8651\u6846\u67b6\u7248\u672c\u4e0e\u9a71\u52a8\u7684\u517c\u5bb9\u6027;</li> </ul> <p>\u5173\u4e8e\u8fde\u63a5\u5bf9\u8c61MongoClient:\u4f7f\u7528MongoClient\u5bf9\u8c61\u8fde\u63a5\u5230MongoDB\u5b9e\u4f8b\u65f6\u603b\u662f\u5e94\u8be5  \u4fdd\u8bc1\u5b83\u5355\u4f8b\uff0c\u5e76\u4e14\u5728\u6574\u4e2a\u751f\u547d\u5468\u671f\u4e2d\u90fd\u4ece\u5b83\u83b7\u53d6\u5176\u4ed6\u64cd\u4f5c\u5bf9\u8c61</p> <ul> <li>\u5173\u4e8e\u8fde\u63a5\u5b57\u7b26\u4e32:\u8fde\u63a5\u5b57\u7b26\u4e32\u4e2d\u53ef\u4ee5\u914d\u7f6e\u5927\u90e8\u5206\u8fde\u63a5\u9009\u9879\uff0c\u5efa\u8bae\u603b\u662f\u5728\u8fde\u63a5\u5b57\u7b26\u4e32\u4e2d\u914d\u7f6e \u8fd9\u4e9b\u9009\u9879;</li> </ul> <pre><code>// \u8fde\u63a5\u5230\u590d\u5236\u96c6 \nmongodb://\u8282\u70b91,\u8282\u70b92,\u8282\u70b93.../database?[options]\n\n// \u8fde\u63a5\u5230\u5206\u7247\u96c6\n mongodb://mongos1,mongos2,mongos3.../database?[options]\n</code></pre> <p>\u5e38\u89c1\u8fde\u63a5\u5b57\u7b26\u4e32\u53c2\u6570</p> <ul> <li>maxPoolSize:  \u8fde\u63a5\u6c60\u5927\u5c0f</li> <li>MaxWaitTime: \u5efa\u8bae\u8bbe\u7f6e\uff0c\u81ea\u52a8\u6740\u6389\u592a\u6162\u7684\u67e5\u8be2</li> <li>WriteConcern:  \u5efa\u8baemajority\u4fdd\u8bc1\u6570\u636e\u5b89\u5168</li> <li>ReadConcern: \u5bf9\u4e8e\u6570\u636e\u4e00\u81f4\u6027\u8981\u6c42\u9ad8\u7684\u573a\u666f\u9002\u5f53\u4f7f\u7528</li> </ul> <p>\u8fde\u63a5\u5b57\u7b26\u4e32\u8282\u70b9\u548c\u5730\u5740</p> <ul> <li> <p>\u65e0\u8bba\u5bf9\u4e8e\u590d\u5236\u96c6\u6216\u5206\u7247\u96c6\uff0c\u8fde\u63a5\u5b57\u7b26\u4e32\u4e2d\u90fd\u5e94\u5c3d\u53ef\u80fd\u591a\u5730\u63d0\u4f9b\u8282\u70b9\u5730\u5740\uff0c\u5efa\u8bae\u5168\u90e8\u5217\u51fa;</p> <ul> <li>\u590d\u5236\u96c6\u5229\u7528\u8fd9\u4e9b\u5730\u5740\u53ef\u4ee5\u66f4\u6709\u6548\u5730\u53d1\u73b0\u96c6\u7fa4\u6210\u5458;</li> <li>\u5206\u7247\u96c6\u5229\u7528\u8fd9\u4e9b\u5730\u5740\u53ef\u4ee5\u66f4\u6709\u6548\u5730\u5206\u6563\u8d1f\u8f7d;</li> </ul> </li> <li> <p>\u8fde\u63a5\u5b57\u7b26\u4e32\u4e2d\u5c3d\u53ef\u80fd\u4f7f\u7528\u4e0e\u590d\u5236\u96c6\u5185\u90e8\u914d\u7f6e\u76f8\u540c\u7684\u57df\u540d\u6216IP;</p> </li> </ul>"},{"location":"mongo2/7mon_changestream_bestdesign/#_2","title":"\u4f7f\u7528\u57df\u540d\u8fde\u63a5\u96c6\u7fa4","text":"<p>\u5728\u914d\u7f6e\u96c6\u7fa4\u65f6\u4f7f\u7528\u57df\u540d\u53ef\u4ee5\u4e3a\u96c6\u7fa4\u53d8\u66f4\u65f6\u63d0\u4f9b\u4e00\u5c42\u989d\u5916\u7684\u4fdd\u62a4\u3002\u4f8b\u5982\u9700\u8981\u5c06\u96c6\u7fa4\u6574\u4f53 \u8fc1\u79fb\u5230\u65b0\u7f51\u6bb5\uff0c\u76f4\u63a5\u4fee\u6539\u57df\u540d\u89e3\u6790\u5373\u53ef\u3002</p> <p>\u53e6\u5916\uff0cMongoDB \u63d0\u4f9b\u7684 <code>mongodb+srv://</code> \u534f\u8bae\u53ef\u4ee5\u63d0\u4f9b\u989d\u5916\u4e00\u5c42\u7684\u4fdd\u62a4\u3002\u8be5\u534f\u8bae\u5141\u8bb8\u901a\u8fc7\u57df\u540d\u89e3\u6790\u5f97\u5230\u6240\u6709 mongos \u6216\u8282\u70b9\u7684\u5730\u5740\uff0c\u800c\u4e0d\u662f\u5199\u5728\u8fde\u63a5\u5b57\u7b26\u4e32\u4e2d\u3002</p> <pre><code>mongodb+srv://server.example.com/\nRecord TTL Class Priority Weight Port Target _mongodb._tcp.server.example.com. 86400 IN SRV 0 5 27317 mongodb1.example.com.\n_mongodb._tcp.server.example.com. 86400 IN SRV 0 5 27017 mongodb2.example.com.\n</code></pre>"},{"location":"mongo2/7mon_changestream_bestdesign/#mongos","title":"\u4e0d\u8981\u5728 mongos \u524d\u9762\u4f7f\u7528\u8d1f\u8f7d\u5747\u8861","text":"<p>\u57fa\u4e8e\u524d\u9762\u63d0\u5230\u7684\u539f\u56e0\uff0c\u9a71\u52a8\u5df2\u7ecf\u77e5\u6653\u5728\u4e0d\u540c\u7684 mongos \u4e4b\u95f4\u5b9e\u73b0\u8d1f\u8f7d\u5747\u8861\uff0c\u800c\u590d\u5236\u96c6 \u5219\u9700\u8981\u6839\u636e\u8282\u70b9\u7684\u89d2\u8272\u6765\u9009\u62e9\u53d1\u9001\u8bf7\u6c42\u7684\u76ee\u6807\u3002\u5982\u679c\u5728 mongos \u6216\u590d\u5236\u96c6\u4e0a\u5c42\u90e8\u7f72\u8d1f \u8f7d\u5747\u8861:</p> <ul> <li>\u9a71\u52a8\u4f1a\u65e0\u6cd5\u63a2\u6d4b\u5177\u4f53\u54ea\u4e2a\u8282\u70b9\u5b58\u6d3b\uff0c\u4ece\u800c\u65e0\u6cd5\u5b8c\u6210\u81ea\u52a8\u6545\u969c\u6062\u590d; </li> <li>\u9a71\u52a8\u4f1a\u65e0\u6cd5\u5224\u65ad\u6e38\u6807\u662f\u5728\u54ea\u4e2a\u8282\u70b9\u521b\u5efa\u7684\uff0c\u4ece\u800c\u904d\u5386\u6e38\u6807\u65f6\u51fa\u9519;</li> </ul> <p>\u7ed3\u8bba:\u4e0d\u8981\u5728 mongos \u6216\u590d\u5236\u96c6\u4e0a\u5c42\u653e\u7f6e\u8d1f\u8f7d\u5747\u8861\u5668\uff0c\u8ba9\u9a71\u52a8\u5904\u7406\u8d1f\u8f7d\u5747\u8861\u548c\u81ea\u52a8\u6545\u969c\u6062\u590d\u3002</p>"},{"location":"mongo2/7mon_changestream_bestdesign/#_3","title":"\u6e38\u6807\u4f7f\u7528","text":"<p>\u5982\u679c\u4e00\u4e2a\u6e38\u6807\u5df2\u7ecf\u904d\u5386\u5b8c\uff0c\u5219\u4f1a\u81ea\u52a8\u5173\u95ed;\u5982\u679c\u6ca1\u6709\u904d\u5386\u5b8c\uff0c\u5219\u9700\u8981\u624b\u52a8\u8c03\u7528 <code>close()</code>\u65b9\u6cd5\uff0c\u5426\u5219\u8be5\u6e38\u6807\u5c06\u5728\u670d\u52a1\u5668\u4e0a\u5b58\u5728 10 \u5206\u949f(\u9ed8\u8ba4\u503c)\u540e\u8d85\u65f6\u91ca\u653e\uff0c\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u8d44\u6e90\u6d6a\u8d39\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u4e0d\u80fd\u904d\u5386\u5b8c\u4e00\u4e2a\u6e38\u6807\uff0c\u901a\u5e38\u610f\u5473\u7740\u67e5\u8be2\u6761\u4ef6\u592a\u5bbd\u6cdb\uff0c\u66f4\u5e94\u8be5\u8003\u8651\u7684\u95ee\u9898\u662f \u5982\u4f55\u5c06\u6761\u4ef6\u6536\u7d27\u3002</p>"},{"location":"mongo2/7mon_changestream_bestdesign/#_4","title":"\u5173\u4e8e\u67e5\u8be2\u53ca\u7d22\u5f15","text":"<ul> <li>\u6bcf\u4e00\u4e2a\u67e5\u8be2\u90fd\u5fc5\u987b\u8981\u6709\u5bf9\u5e94\u7684\u7d22\u5f15</li> <li>\u5c3d\u91cf\u4f7f\u7528\u8986\u76d6\u7d22\u5f15 Covered Indexes (\u53ef\u4ee5\u907f\u514d\u8bfb\u6570\u636e\u6587\u4ef6)</li> <li>\u4f7f\u7528 projection \u6765\u51cf\u5c11\u8fd4\u56de\u5230\u5ba2\u6237\u7aef\u7684\u7684\u6587\u6863\u7684\u5185\u5bb9</li> </ul>"},{"location":"mongo2/7mon_changestream_bestdesign/#_5","title":"\u5173\u4e8e\u5199\u5165","text":"<ul> <li>\u5728 update \u8bed\u53e5\u91cc\u53ea\u5305\u62ec\u9700\u8981\u66f4\u65b0\u7684\u5b57\u6bb5 </li> <li>\u5c3d\u53ef\u80fd\u4f7f\u7528\u6279\u91cf\u63d2\u5165\u6765\u63d0\u5347\u5199\u5165\u6027\u80fd</li> <li>\u4f7f\u7528TTL\u81ea\u52a8\u8fc7\u671f\u65e5\u5fd7\u7c7b\u578b\u7684\u6570\u636e</li> </ul>"},{"location":"mongo2/7mon_changestream_bestdesign/#_6","title":"\u5173\u4e8e\u6587\u6863\u7ed3\u6784","text":"<ul> <li>\u9632\u6b62\u4f7f\u7528\u592a\u957f\u7684\u5b57\u6bb5\u540d(\u6d6a\u8d39\u7a7a\u95f4)</li> <li>\u9632\u6b62\u4f7f\u7528\u592a\u6df1\u7684\u6570\u7ec4\u5d4c\u5957(\u8d85\u8fc72\u5c42\u64cd\u4f5c\u6bd4\u8f83\u590d\u6742) </li> <li>\u4e0d\u4f7f\u7528\u4e2d\u6587\uff0c\u6807\u70b9\u7b26\u53f7\u7b49\u975e\u62c9\u4e01\u5b57\u6bcd\u4f5c\u4e3a\u5b57\u6bb5\u540d</li> </ul>"},{"location":"mongo2/7mon_changestream_bestdesign/#count","title":"\u5904\u7406\u5206\u9875\u95ee\u9898 \u2013 \u907f\u514d\u4f7f\u7528 count","text":"<p>\u5c3d\u53ef\u80fd\u4e0d\u8981\u8ba1\u7b97\u603b\u9875\u6570\uff0c\u7279\u522b\u662f\u6570\u636e\u91cf\u5927\u548c\u67e5\u8be2\u6761\u4ef6\u4e0d\u80fd\u5b8c\u6574\u547d\u4e2d\u7d22\u5f15\u65f6\u3002 \u8003\u8651\u4ee5\u4e0b\u573a\u666f:\u5047\u8bbe\u96c6\u5408\u603b\u5171\u6709 1000w \u6761\u6570\u636e\uff0c\u5728\u6ca1\u6709\u7d22\u5f15\u7684\u60c5\u51b5\u4e0b\u8003\u8651\u4ee5\u4e0b\u67e5\u8be2:</p> <pre><code>db.coll.find({x: 100}).limit(50);\n\ndb.coll.count({x: 100});\n</code></pre> <ul> <li>\u524d\u8005\u53ea\u9700\u8981\u904d\u5386\u524dn\u6761\uff0c\u76f4\u5230\u627e\u523050\u6761\u961f\u4f0dx=100\u7684\u6587\u6863\u5373\u53ef\u7ed3\u675f; </li> <li>\u540e\u8005\u9700\u8981\u904d\u5386\u5b8c1000w\u6761\u627e\u5230\u6240\u6709\u7b26\u5408\u8981\u6c42\u7684\u6587\u6863\u624d\u80fd\u5f97\u5230\u7ed3\u679c\u3002</li> </ul>"},{"location":"mongo2/7mon_changestream_bestdesign/#_7","title":"\u5904\u7406\u5206\u9875\u95ee\u9898 \u2013 \u5de7\u5206\u9875","text":"<p>\u907f\u514d\u4f7f\u7528skip/limit\u5f62\u5f0f\u7684\u5206\u9875\uff0c\u7279\u522b\u662f\u6570\u636e\u91cf\u5927\u7684\u65f6\u5019; </p> <p>\u66ff\u4ee3\u65b9\u6848:\u4f7f\u7528\u67e5\u8be2\u6761\u4ef6+\u552f\u4e00\u6392\u5e8f\u6761\u4ef6;</p> <p>\u4f8b\u5982:</p> <ul> <li>\u7b2c\u4e00\u9875:  <code>db.posts.find({}).sort({_id: 1}).limit(20)</code>;</li> <li>\u7b2c\u4e8c\u9875:  <code>db.posts.find({_id: {$gt: &lt;\u7b2c\u4e00\u9875\u6700\u540e\u4e00\u4e2a_id&gt;}}).sort({_id: 1}).limit(20)</code>; </li> <li>\u7b2c\u4e09\u9875:  <code>db.posts.find({_id: {$gt: &lt;\u7b2c\u4e8c\u9875\u6700\u540e\u4e00\u4e2a_id&gt;}}).sort({_id: 1}).limit(20)</code>;</li> </ul> <p>......</p>"},{"location":"mongo2/7mon_changestream_bestdesign/#_8","title":"\u5173\u4e8e\u4e8b\u52a1","text":"<p>\u4f7f\u7528\u4e8b\u52a1\u7684\u539f\u5219:</p> <ul> <li>\u65e0\u8bba\u4f55\u65f6\uff0c\u4e8b\u52a1\u7684\u4f7f\u7528\u603b\u662f\u80fd\u907f\u514d\u5219\u907f\u514d;</li> <li>\u6a21\u578b\u8bbe\u8ba1\u5148\u4e8e\u4e8b\u52a1\uff0c\u5c3d\u53ef\u80fd\u7528\u6a21\u578b\u8bbe\u8ba1\u89c4\u907f\u4e8b\u52a1;</li> <li>\u4e0d\u8981\u4f7f\u7528\u8fc7\u5927\u7684\u4e8b\u52a1(\u5c3d\u91cf\u63a7\u5236\u57281000\u4e2a\u6587\u6863\u66f4\u65b0\u4ee5\u5185);</li> <li>\u5f53\u5fc5\u987b\u4f7f\u7528\u4e8b\u52a1\u65f6\uff0c\u5c3d\u53ef\u80fd\u8ba9\u6d89\u53ca\u4e8b\u52a1\u7684\u6587\u6863\u5206\u5e03\u5728\u540c\u4e00\u4e2a\u5206\u7247\u4e0a\uff0c\u8fd9 \u5c06\u6709\u6548\u5730\u63d0\u9ad8\u6548\u7387;</li> </ul>"},{"location":"mongo2/8mon_shard/","title":"8 Mongo Shards","text":""},{"location":"mongo2/8mon_shard/#1","title":"1 \u5206\u7247\u96c6\u7fa4\u673a\u5236\u53ca\u539f\u7406","text":""},{"location":"mongo2/8mon_shard/#mongodb","title":"MongoDB \u5e38\u89c1\u90e8\u7f72\u67b6\u6784","text":"<p>\u4e3a\u4ec0\u4e48\u8981\u4f7f\u7528\u5206\u7247\u96c6\u7fa4?</p> <ul> <li>\u6570\u636e\u5bb9\u91cf\u65e5\u76ca\u589e\u5927\uff0c\u8bbf\u95ee\u6027\u80fd\u65e5\u6e10\u964d\u4f4e\uff0c\u600e\u4e48\u7834? </li> <li>\u65b0\u54c1\u4e0a\u7ebf\u5f02\u5e38\u706b\u7206\uff0c\u5982\u4f55\u652f\u6491\u66f4\u591a\u7684\u5e76\u53d1\u7528\u6237?</li> <li>\u5355\u5e93\u5df2\u6709 10TB \u6570\u636e\uff0c\u6062\u590d\u9700\u89811-2\u5929\uff0c\u5982\u4f55\u52a0\u901f? </li> <li>\u5730\u7406\u5206\u5e03\u6570\u636e</li> </ul>"},{"location":"mongo2/8mon_shard/#_1","title":"\u5206\u7247\u5982\u4f55\u89e3\u51b3?","text":"<p>\u628a\u6570\u636e\u5206\u6210\u4e24\u534a\uff0c\u653e\u52302\u4e2a\u5e93\u7269\u7406\u91cc</p> <p></p> <p>\u628a\u6570\u636e\u5206\u62104\u90e8\u5206\uff0c\u653e\u52304\u4e2a\u7269\u7406\u5e93\u91cc</p> <p></p> <p>\u5b8c\u6574\u7684\u5206\u7247\u96c6\u7fa4</p> <p></p>"},{"location":"mongo2/8mon_shard/#mongos","title":"\u5206\u7247\u96c6\u7fa4\u89e3\u5256:\u8def\u7531\u8282\u70b9 mongos","text":"<p>\u8def\u7531\u8282\u70b9</p> <ul> <li>\u63d0\u4f9b\u96c6\u7fa4\u5355\u4e00\u5165\u53e3</li> <li>\u8f6c\u53d1\u5e94\u7528\u7aef\u8bf7\u6c42</li> <li>\u9009\u62e9\u5408\u9002\u6570\u636e\u8282\u70b9\u8fdb\u884c\u8bfb\u5199</li> <li>\u5408\u5e76\u591a\u4e2a\u6570\u636e\u8282\u70b9\u7684\u8fd4\u56de</li> </ul> <p>\u65e0\u72b6\u6001 \u5efa\u8bae\u81f3\u5c112\u4e2a</p> <p></p>"},{"location":"mongo2/8mon_shard/#mongod","title":"\u5206\u7247\u96c6\u7fa4\u89e3\u5256:\u914d\u7f6e\u8282\u70b9 mongod","text":"<ul> <li>\u914d\u7f6e(\u76ee\u5f55)\u8282\u70b9</li> <li>\u63d0\u4f9b\u96c6\u7fa4\u5143\u6570\u636e\u5b58\u50a8\u5206\u7247\u6570\u636e\u5206\u5e03\u7684\u6620\u5c04</li> <li>\u666e\u901a\u590d\u5236\u96c6\u67b6\u6784</li> </ul>"},{"location":"mongo2/8mon_shard/#mongod_1","title":"\u5206\u7247\u96c6\u7fa4\u89e3\u5256:\u6570\u636e\u8282\u70b9 mongod","text":"<p>\u6570\u636e\u8282\u70b9</p> <ul> <li>\u4ee5\u590d\u5236\u96c6\u4e3a\u5355\u4f4d\u6a2a\u5411\u6269\u5c55 </li> <li>\u6700\u59271024\u5206\u7247 </li> <li>\u5206\u7247\u4e4b\u95f4\u6570\u636e\u4e0d\u91cd\u590d </li> <li>\u6240\u6709\u5206\u7247\u5728\u4e00\u8d77\u624d\u53ef\u5b8c\u6574\u5de5\u4f5c</li> </ul> <p></p>"},{"location":"mongo2/8mon_shard/#mongodb_1","title":"MongoDB \u5206\u7247\u96c6\u7fa4\u7279\u70b9","text":"<ul> <li>\u5e94\u7528\u5168\u900f\u660e\uff0c\u65e0\u7279\u6b8a\u5904\u7406 </li> <li>\u6570\u636e\u81ea\u52a8\u5747\u8861</li> <li>\u52a8\u6001\u6269\u5bb9\uff0c\u65e0\u987b\u4e0b\u7ebf</li> <li>\u63d0\u4f9b\u4e09\u79cd\u5206\u7247\u65b9\u5f0f</li> </ul> <p>\u5206\u7247\u96c6\u7fa4\u6570\u636e\u5206\u5e03\u65b9\u5f0f</p> <ul> <li>\u57fa\u4e8e\u8303\u56f4</li> <li>\u57fa\u4e8e Hash</li> <li>\u57fa\u4e8e zone / tag</li> </ul> <p>\u5206\u7247\u96c6\u7fa4\u6570\u636e\u5206\u5e03\u65b9\u5f0f \u2013 \u57fa\u4e8e\u8303\u56f4</p> <p></p> <p>\u5206\u7247\u96c6\u7fa4\u6570\u636e\u5206\u5e03\u65b9\u5f0f \u2013 \u57fa\u4e8e\u54c8\u5e0c</p> <p></p> <p>\u5206\u7247\u96c6\u7fa4\u6570\u636e\u5206\u5e03\u65b9\u5f0f \u2013 \u81ea\u5b9a\u4e49Zone</p> <p></p> <p>\u5c0f\u7ed3</p> <ul> <li>\u5206\u7247\u96c6\u7fa4\u53ef\u4ee5\u6709\u6548\u89e3\u51b3\u6027\u80fd\u74f6\u9888\u53ca\u7cfb\u7edf\u6269\u5bb9\u95ee\u9898</li> <li>\u5206\u7247\u989d\u5916\u6d88\u8017\u8f83\u591a\uff0c\u7ba1\u7406\u590d\u6742\uff0c\u80fd\u4e0d\u5206\u7247\u5c3d\u91cf\u4e0d\u8981\u5206\u7247 </li> <li>\u5982\u679c\u5b9e\u5728\u8981\u7528\uff0c\u8bf7\u4ed4\u7ec6\u5b66\u4e60\u4e0b\u4e00\u8bb2</li> </ul>"},{"location":"mongo2/8mon_shard/#2","title":"2 \u5206\u7247\u96c6\u7fa4\u8bbe\u8ba1","text":""},{"location":"mongo2/8mon_shard/#_2","title":"\u5982\u4f55\u7528\u597d\u5206\u7247\u96c6\u7fa4","text":""},{"location":"mongo2/8mon_shard/#_3","title":"\u5408\u7406\u7684\u67b6\u6784 \u2013 \u5206\u7247\u5927\u5c0f","text":"<p>\u5206\u7247\u7684\u57fa\u672c\u6807\u51c6:</p> <ul> <li>\u5173\u4e8e\u6570\u636e:\u6570\u636e\u91cf\u4e0d\u8d85\u8fc73TB\uff0c\u5c3d\u53ef\u80fd\u4fdd\u6301\u57282TB\u4e00\u4e2a\u7247; </li> <li>\u5173\u4e8e\u7d22\u5f15:\u5e38\u7528\u7d22\u5f15\u5fc5\u987b\u5bb9\u7eb3\u8fdb\u5185\u5b58;</li> </ul> <p>\u6309\u7167\u4ee5\u4e0a\u6807\u51c6\u521d\u6b65\u786e\u5b9a\u5206\u7247\u540e\uff0c\u8fd8\u9700\u8981\u8003\u8651\u4e1a\u52a1\u538b\u529b\uff0c\u968f\u7740\u538b\u529b\u589e\u5927\uff0cCPU\u3001RAM\u3001 \u78c1\u76d8\u4e2d\u7684\u4efb\u4f55\u4e00\u9879\u51fa\u73b0\u74f6\u9888\u65f6\uff0c\u90fd\u53ef\u4ee5\u901a\u8fc7\u6dfb\u52a0\u66f4\u591a\u5206\u7247\u6765\u89e3\u51b3\u3002</p>"},{"location":"mongo2/8mon_shard/#_4","title":"\u5408\u7406\u7684\u67b6\u6784 \u2013 \u9700\u8981\u591a\u5c11\u4e2a\u5206\u7247","text":"<ul> <li><code>A = \u6240\u9700\u5b58\u50a8\u603b\u91cf / \u5355\u670d\u52a1\u5668\u53ef\u6302\u8f7d\u5bb9\u91cf</code>  \uff088TB / 2TB = 4\uff09</li> <li><code>B = \u5de5\u4f5c\u96c6\u5927\u5c0f / \u5355\u670d\u52a1\u5668\u5185\u5b58\u5bb9\u91cf</code> (400GB / (256G * 0.6) = 3)</li> <li><code>C = \u5e76\u53d1\u91cf\u603b\u6570 / (\u5355\u670d\u52a1\u5668\u5e76\u53d1\u91cf * 0.7)</code> <code>30000 / (9000*0.7) = 6</code></li> </ul> <p><code>\u5206\u7247\u6570\u91cf = max(A, B, C) = 6</code></p>"},{"location":"mongo2/8mon_shard/#_5","title":"\u5408\u7406\u7684\u67b6\u6784 \u2013 \u5176\u4ed6\u9700\u6c42","text":"<p>\u8003\u8651\u5206\u7247\u7684\u5206\u5e03:</p> <ul> <li>\u662f\u5426\u9700\u8981\u8de8\u673a\u623f\u5206\u5e03\u5206\u7247? </li> <li>\u662f\u5426\u9700\u8981\u5bb9\u707e?</li> <li>\u9ad8\u53ef\u7528\u7684\u8981\u6c42\u5982\u4f55?</li> </ul>"},{"location":"mongo2/8mon_shard/#_6","title":"\u6b63\u786e\u7684\u59ff\u52bf \u5404\u79cd\u6982\u5ff5\u7531\u5c0f\u5230\u5927:","text":"<ul> <li>\u7247\u952e shard key:\u6587\u6863\u4e2d\u7684\u4e00\u4e2a\u5b57\u6bb5</li> <li>\u6587\u6863 doc :\u5305\u542b shard key \u7684\u4e00\u884c\u6570\u636e</li> <li>\u5757 Chunk :\u5305\u542b n \u4e2a\u6587\u6863</li> <li>\u5206\u7247 Shard:\u5305\u542b n \u4e2a chunk</li> <li>\u96c6\u7fa4 Cluster: \u5305\u542b n \u4e2a\u5206\u7247</li> </ul>"},{"location":"mongo2/8mon_shard/#_7","title":"\u9009\u62e9\u5408\u9002\u7247\u952e","text":"<p>\u5f71\u54cd\u7247\u952e\u6548\u7387\u7684\u4e3b\u8981\u56e0\u7d20:</p> <ul> <li>\u53d6\u503c\u57fa\u6570(Cardinality);</li> <li>\u53d6\u503c\u5206\u5e03;</li> <li>\u5206\u6563\u5199\uff0c\u96c6\u4e2d\u8bfb;</li> <li>\u88ab\u5c3d\u53ef\u80fd\u591a\u7684\u4e1a\u52a1\u573a\u666f\u7528\u5230; </li> <li>\u907f\u514d\u5355\u8c03\u9012\u589e\u6216\u9012\u51cf\u7684\u7247\u952e;</li> </ul>"},{"location":"mongo2/8mon_shard/#-","title":"\u6b63\u786e\u7684\u59ff\u52bf - \u9009\u62e9\u57fa\u6570\u5927\u7684\u7247\u952e","text":"<p>\u5bf9\u4e8e\u5c0f\u57fa\u6570\u7684\u7247\u952e:</p> <ul> <li>\u56e0\u4e3a\u5907\u9009\u503c\u6709\u9650\uff0c\u90a3\u4e48\u5757\u7684\u603b\u6570\u91cf\u5c31\u6709\u9650; </li> <li>\u968f\u7740\u6570\u636e\u589e\u591a\uff0c\u5757\u7684\u5927\u5c0f\u4f1a\u8d8a\u6765\u8d8a\u5927;</li> <li>\u6c34\u5e73\u6269\u5c55\u65f6\u79fb\u52a8\u5757\u4f1a\u975e\u5e38\u56f0\u96be;</li> </ul> <p>\u4f8b\u5982:\u5b58\u50a8\u4e00\u4e2a\u9ad8\u4e2d\u7684\u5e08\u751f\u6570\u636e\uff0c\u4ee5\u5e74\u9f84(\u5047\u8bbe\u5e74\u9f84\u8303\u56f4\u4e3a15~65\u5c81)\u4f5c\u4e3a\u7247\u952e\uff0c \u90a3\u4e48:</p> <ul> <li>15&lt;=\u5e74\u9f84&lt;=65\uff0c\u4e14\u53ea\u4e3a\u6574\u6570 </li> <li>\u6700\u591a\u53ea\u4f1a\u670951\u4e2a chunk</li> </ul> <p>\u7ed3\u8bba:\u53d6\u503c\u57fa\u6570\u8981\u5927!</p>"},{"location":"mongo2/8mon_shard/#_8","title":"\u6b63\u786e\u7684\u59ff\u52bf \u2013 \u9009\u62e9\u5206\u5e03\u5747\u5300\u7684\u7247\u952e","text":"<p>\u5bf9\u4e8e\u5206\u5e03\u4e0d\u5747\u5300\u7684\u7247\u952e:</p> <ul> <li>\u9020\u6210\u67d0\u4e9b\u5757\u7684\u6570\u636e\u91cf\u6025\u5267\u589e\u5927</li> <li>\u8fd9\u4e9b\u5757\u538b\u529b\u968f\u4e4b\u589e\u5927</li> <li>\u6570\u636e\u5747\u8861\u4ee5 chunk \u4e3a\u5355\u4f4d\uff0c\u6240\u4ee5\u7cfb\u7edf\u65e0\u80fd\u4e3a\u529b</li> </ul> <p>\u4f8b\u5982:\u5b58\u50a8\u4e00\u4e2a\u5b66\u6821\u7684\u5e08\u751f\u6570\u636e\uff0c\u4ee5\u5e74\u9f84(\u5047\u8bbe\u5e74\u9f84\u8303\u56f4\u4e3a15~65\u5c81)\u4f5c\u4e3a\u7247\u952e\uff0c</p> <ul> <li>15&lt;=\u5e74\u9f84&lt;=65\uff0c\u4e14\u53ea\u4e3a\u6574\u6570</li> <li>\u5927\u90e8\u5206\u4eba\u7684\u5e74\u9f84\u8303\u56f4\u4e3a15~18\u5c81(\u5b66\u751f)</li> <li>15\u300116\u300117\u300118\u56db\u4e2a chunk \u7684\u6570\u636e\u91cf\u3001\u8bbf\u95ee\u538b\u529b\u8fdc\u5927\u4e8e\u5176\u4ed6 chunk</li> </ul> <p>\u7ed3\u8bba:\u53d6\u503c\u5206\u5e03\u5e94\u5c3d\u53ef\u80fd\u5747\u5300</p>"},{"location":"mongo2/8mon_shard/#email","title":"\u4e00\u4e2a email \u7cfb\u7edf\u7684\u7247\u952e\u4f8b\u5b50","text":"<pre><code>{\n     _id: ObjectId(),\n    user: 123,\n    time: Date(),\n    subject: \"...\",\n    recipients: [],\n    body: \"...\",\n    attachments: []\n}\n</code></pre> <p>\u7247\u952e: <code>{ _id: 1}</code></p> <p></p> <p>\u8bfb\u5199\u4f1a\u6839\u636eid \u96c6\u4e2d\u5728\u67d0\u4e2ashard,\u5bfc\u81f4\u538b\u529b\u8fc7\u5927</p> <p>\u7247\u952e: <code>{ user_id: 1 }</code></p> <p></p> <p>\u67d0\u4e2achunck \u8fc7\u5927</p> <p>\u7247\u952e: <code>{ user_id: 1, time:1 }</code></p> <p></p> <p>\u590d\u5408\u952e\u662f\u6700\u597d\u7684\u9009\u62e9</p>"},{"location":"mongo2/8mon_shard/#_9","title":"\u8db3\u591f\u7684\u8d44\u6e90","text":"<ul> <li>mongos \u4e0e config \u901a\u5e38\u6d88\u8017\u5f88\u5c11\u7684\u8d44\u6e90\uff0c\u53ef\u4ee5\u9009\u62e9\u4f4e\u89c4\u683c\u865a\u62df\u673a;</li> <li>\u8d44\u6e90\u7684\u91cd\u70b9\u5728\u4e8e shard \u670d\u52a1\u5668:<ul> <li>\u9700\u8981\u8db3\u4ee5\u5bb9\u7eb3\u70ed\u6570\u636e\u7d22\u5f15\u7684\u5185\u5b58;</li> <li>\u6b63\u786e\u521b\u5efa\u7d22\u5f15\u540e CPU \u901a\u5e38\u4e0d\u4f1a\u6210\u4e3a\u74f6\u9888\uff0c\u9664\u975e\u6d89\u53ca\u975e\u5e38\u591a\u7684\u8ba1\u7b97;</li> <li>\u78c1\u76d8\u5c3d\u91cf\u9009\u7528 SSD;</li> </ul> </li> <li>\u6700\u540e\uff0c\u5b9e\u9645\u6d4b\u8bd5\u662f\u6700\u597d\u7684\u68c0\u9a8c\uff0c\u6765\u770b\u4f60\u7684\u8d44\u6e90\u914d\u7f6e\u662f\u5426\u5b8c\u5907\u3002</li> <li>\u5373\u4f7f\u9879\u76ee\u521d\u671f\u5df2\u7ecf\u5177\u5907\u4e86\u8db3\u591f\u7684\u8d44\u6e90\uff0c\u4ecd\u7136\u9700\u8981\u8003\u8651\u5728\u5408\u9002\u7684\u65f6\u5019\u6269\u5c55\u3002\u5efa\u8bae\u76d1\u63a7 \u5404\u9879\u8d44\u6e90\u4f7f\u7528\u60c5\u51b5\uff0c\u65e0\u8bba\u54ea\u4e00\u9879\u8fbe\u523060%\u4ee5\u4e0a\uff0c\u5219\u5f00\u59cb\u8003\u8651\u6269\u5c55\uff0c\u56e0\u4e3a:<ul> <li>\u6269\u5c55\u9700\u8981\u65b0\u7684\u8d44\u6e90\uff0c\u7533\u8bf7\u65b0\u8d44\u6e90\u9700\u8981\u65f6\u95f4;</li> <li>\u6269\u5c55\u540e\u6570\u636e\u9700\u8981\u5747\u8861\uff0c\u5747\u8861\u9700\u8981\u65f6\u95f4\u3002\u5e94\u4fdd\u8bc1\u65b0\u6570\u636e\u5165\u5e93\u901f\u5ea6\u6162\u4e8e\u5747\u8861\u901f\u5ea6 </li> <li>\u5747\u8861\u9700\u8981\u8d44\u6e90\uff0c\u5982\u679c\u8d44\u6e90\u5373\u5c06\u6216\u5df2\u7ecf\u8017\u5c3d\uff0c\u5747\u8861\u4e5f\u662f\u4f1a\u5f88\u4f4e\u6548\u7684\u3002</li> </ul> </li> </ul>"},{"location":"mongo2/8mon_shard/#_10","title":"\u5c0f\u7ed3","text":"<ul> <li>\u5408\u7406\u7684\u67b6\u6784 \u2013 \u9009\u62e9\u5408\u9002\u7684\u5206\u7247\u5927\u5c0f\u4e0e\u6570\u91cf</li> <li>\u6b63\u786e\u7684\u59ff\u52bf \u2013 \u9009\u62e9\u5408\u9002\u7684\u7247\u952e</li> <li>\u8db3\u591f\u7684\u8d44\u6e90 \u2013 \u7ed9\u8db3\u591f\u7684\u5b58\u50a8\u548c\u5185\u5b58\u8d44\u6e90\u4e2a\u5206\u7247\u670d\u52a1\u5668</li> </ul>"},{"location":"mongo2/8mon_shard/#3","title":"3 \u5b9e\u9a8c:\u5206\u7247\u96c6\u7fa4\u642d\u5efa\u53ca\u6269\u5bb9","text":""},{"location":"mongo2/8mon_shard/#_11","title":"\u5b9e\u9a8c\u76ee\u6807\u53ca\u6d41\u7a0b","text":"<ul> <li>\u76ee\u6807:\u5b66\u4e60\u5982\u4f55\u642d\u5efa\u4e00\u4e2a2\u5206\u7247\u7684\u5206\u7247\u96c6\u7fa4</li> <li>\u73af\u5883:3\u53f0 Linux \u865a\u62df\u673a\uff0c 4 Core 8 GB</li> <li>\u6b65\u9aa4</li> </ul> <p>\u5b9e\u9a8c\u67b6\u6784</p> <p></p> <ul> <li>6 MongoD (SHARD)</li> <li>3 Config Server</li> <li>1~3 MongoS (Routing node)</li> </ul> <p>\u5b9e\u9a8c\u67b6\u6784</p> <p></p> <ul> <li> <p>geekdemo1</p> <ul> <li>member1.example.com </li> <li>member2.example.com</li> </ul> </li> <li> <p>geekdemo2 </p> <ul> <li>member3.example.com </li> <li>member4.example.com</li> </ul> </li> <li> <p>geekdemo3 </p> <ul> <li>member5.example.com </li> <li>member6.example.com</li> </ul> </li> </ul>"},{"location":"mongo2/8mon_shard/#1_1","title":"1. \u914d\u7f6e\u57df\u540d\u89e3\u6790","text":"<p>\u57283\u53f0\u865a\u62df\u673a\u4e0a\u5206\u522b\u6267\u884c\u4ee5\u4e0b3\u6761\u547d\u4ee4\uff0c\u6ce8\u610f\u66ff\u6362\u5b9e\u9645 IP \u5730\u5740</p> <pre><code>echo \"192.168.1.1 geekdemo1 member1.example.com member2.example.com\" &gt;&gt; /etc/hosts \n\necho \"192.168.1.2 geekdemo2 member3.example.com member4.example.com\" &gt;&gt; /etc/hosts \n\necho \"192.168.1.3 geekdemo3 member5.example.com member6.example.com\" &gt;&gt; /etc/hosts\n</code></pre> <p></p>"},{"location":"mongo2/8mon_shard/#2_1","title":"2. \u51c6\u5907\u5206\u7247\u76ee\u5f55","text":"<p>\u5728\u5404\u670d\u52a1\u5668\u4e0a\u521b\u5efa\u6570\u636e\u76ee\u5f55\uff0c\u6211\u4eec\u4f7f\u7528 <code>/data</code>\uff0c\u8bf7\u6309\u81ea\u5df1\u9700\u8981\u4fee\u6539\u4e3a\u5176\u4ed6\u76ee\u5f55:</p> <ul> <li>\u5728member1 / member3 / member5 \u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4:</li> </ul> <pre><code>mkdir -p /data/shard1/ \nmkdir -p /data/config/\n</code></pre> <p>\u5728member2 / member4 / member6 \u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4:</p> <pre><code>mkdir -p /data/shard2/ \nmkdir -p /data/mongos/\n</code></pre> <p>Node1</p> <p></p> <p>Node2</p> <p></p> <p>Node3</p> <p></p>"},{"location":"mongo2/8mon_shard/#3_1","title":"3. \u521b\u5efa\u7b2c\u4e00\u4e2a\u5206\u7247\u7528\u7684\u590d\u5236\u96c6","text":"<p>\u5728 member1 / member3 / member5 \u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002</p> <pre><code>mongod --bind_ip 0.0.0.0 --replSet shard1 --dbpath /data/shard1 --logpath /data/shard1/mongod.log --port 27010 --fork --shardsvr --wiredTigerCacheSizeGB 1\n</code></pre> <ul> <li><code>--shardsvr</code>  is required to configure an instance as a shard</li> <li><code>--wiredTigerCacheSizeGB</code>\uff1a Defines the maximum size of the internal cache that WiredTiger will use for all data. The memory consumed by an index build is separate from the WiredTiger cache memory. Values can range from 0.25 GB to 10000 GB.</li> </ul> <p>Node1, Node2, node3 all run the same mongod command</p> <p></p> <p></p>"},{"location":"mongo2/8mon_shard/#4","title":"4. \u521d\u59cb\u5316\u7b2c\u4e00\u4e2a\u5206\u7247\u590d\u5236\u96c6","text":"<p>Node1</p> <p><code>mongo --host member1.example.com:27010</code></p> <p></p> <pre><code>rs.initiate({\n    _id: \"shard1\",\n    \"members\" : [\n    { \n        \"_id\": 0,\n         \"host\" : \"member1.example.com:27010\"\n    },\n    {\n         \"_id\": 1,\n         \"host\" : \"member3.example.com:27010\"\n    }, \n    { \n        \"_id\": 2,\n        \"host\" : \"member5.example.com:27010\"\n    }\n   ]    \n});\n</code></pre> <p></p>"},{"location":"mongo2/8mon_shard/#5-config-server","title":"5. \u521b\u5efa config server \u590d\u5236\u96c6","text":"<p>\u5728 member1 / member3 / member5 \u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002</p> <p>Node1 / Node2 / Node3</p> <pre><code>mongod --bind_ip 0.0.0.0 --replSet config --dbpath /data/config --logpath /data/config/mongod.log --port 27019 --fork --configsvr --wiredTigerCacheSizeGB 1\n</code></pre> <ul> <li>config</li> <li><code>--configsvr</code>  is required to configure an instance as a config server </li> </ul> <p></p> <p>\u53ef\u4ee5\u7528<code>rs.status()</code>\u67e5\u770b\u8c01\u62a2\u5230\u4e86primary \u5728 config servers\u4e2d</p>"},{"location":"mongo2/8mon_shard/#7-mongos","title":"7. \u5728\u7b2c\u4e09\u53f0\u673a\u5668\u4e0a\u642d\u5efa mongos","text":"<p>\u4e00\u822c\u81f3\u5c11\u8d77\u4e24\u53f0\u505a\u9ad8\u53ef\u7528</p> <p>Node1</p> <pre><code># mongos --bind_ip 0.0.0.0 --logpath /data/mongos/mongos.log --port 27017 --fork\n--configdb config/member1.example.com:27019,member3.example.com:27019,member5.example.com:27019\n</code></pre> <p>Node2</p> <pre><code># mongos --bind_ip 0.0.0.0 --logpath /data/mongos/mongos.log --port 27017 --fork\n--configdb config/member1.example.com:27019,member3.example.com:27019,member5.example.com:27019\n</code></pre> <p>Node3</p> <pre><code># mongos --bind_ip 0.0.0.0 --logpath /data/mongos/mongos.log --port 27017 --fork\n--configdb config/member1.example.com:27019,member3.example.com:27019,member5.example.com:27019\n</code></pre> <p></p> <p></p> <p></p> <pre><code># \u8fde\u63a5\u5230mongos, \u6dfb\u52a0\u5206\u7247\n# mongo --host member1.example.com:27017\n</code></pre> <pre><code>mongos &gt; sh.addShard(\"shard1/member1.example.com:27010,member3.example.com:27010,member5 .example.com:27010\");\n</code></pre> <p></p> <p><code>sh.status()</code></p> <p></p>"},{"location":"mongo2/8mon_shard/#8","title":"8. \u521b\u5efa\u5206\u7247\u8868","text":"<pre><code># \u8fde\u63a5\u5230mongos, \u521b\u5efa\u5206\u7247\u96c6\u5408\n# mongo --host member1.example.com:27017\nmongos &gt; sh.status()\nmongos &gt; sh.enableSharding(\"foo\");\nmongos &gt; sh.shardCollection(\"foo.bar\", {_id: 'hashed'}); \n\n\nmongos &gt; sh.status();\n</code></pre> <pre><code># \u63d2\u5165\u6d4b\u8bd5\u6570\u636e\nuse foo\nfor (var i = 0; i &lt; 10000; i++) {\n    db.bar.insert({i: i}); \n}\n</code></pre>"},{"location":"mongo2/8mon_shard/#9-2","title":"9. \u521b\u5efa\u7b2c2\u4e2a\u5206\u7247\u7684\u590d\u5236\u96c6","text":"<p>\u5728 member2 / member4 / member6 \u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u3002</p> <p>Node1, Node2, Node3</p> <pre><code>mongod --bind_ip 0.0.0.0 --replSet shard2 --dbpath /data/shard2 --logpath /data/shard2/mongod.log --port 27011 --fork --shardsvr --wiredTigerCacheSizeGB 1\n</code></pre>"},{"location":"mongo2/8mon_shard/#10","title":"10. \u521d\u59cb\u5316\u7b2c\u4e8c\u4e2a\u5206\u7247\u7684\u590d\u5236\u96c6","text":"<p><code>Node3</code></p> <pre><code># mongo --host member2.example.com:27011\n\nrs.initiate({\n    _id: \"shard2\",\n    \"members\" : [\n    { \n        \"_id\": 0,\n         \"host\" : \"member1.example.com:27011\"\n    },\n    {\n         \"_id\": 1,\n         \"host\" : \"member3.example.com:27011\"\n    }, \n    { \n        \"_id\": 2,\n        \"host\" : \"member5.example.com:27011\"\n    }\n   ]    \n});\n</code></pre>"},{"location":"mongo2/8mon_shard/#11-2","title":"11. \u52a0\u5165\u7b2c2\u4e2a\u5206\u7247","text":"<pre><code># \u8fde\u63a5\u5230mongos, \u6dfb\u52a0\u5206\u7247\n# mongo --host member1.example.com:27017\n\n\nmongos &gt; sh.addShard(\"shard2/member2.example.com:27011,member4.example.com:27011, member6.example.com:27011\");\n\nmongos &gt; sh.status()\n</code></pre>"},{"location":"mongo2/9mon_monitor/","title":"9 MongoDB \u76d1\u63a7\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"mongo2/9mon_monitor/#_1","title":"\u5e38\u7528\u7684\u76d1\u63a7\u5de5\u5177\u53ca\u624b\u6bb5","text":"<ul> <li>MongoDB Ops Manager </li> <li>Percona</li> <li>\u901a\u7528\u76d1\u63a7\u5e73\u53f0</li> <li>\u7a0b\u5e8f\u811a\u672c</li> </ul>"},{"location":"mongo2/9mon_monitor/#_2","title":"\u5982\u4f55\u83b7\u53d6\u76d1\u63a7\u6570\u636e","text":"<p>\u76d1\u63a7\u4fe1\u606f\u7684\u6765\u6e90:</p> <ul> <li><code>db.serverStatus()</code>(\u4e3b\u8981)</li> <li><code>db.isMaster()</code>(\u6b21\u8981)</li> <li><code>mongostats</code> \u547d\u4ee4\u884c\u5de5\u5177(\u53ea\u6709\u90e8\u5206\u4fe1\u606f)</li> </ul> <p>\u6ce8\u610f:<code>db.serverStatus()</code>\u5305\u542b\u7684\u76d1\u63a7\u4fe1\u606f\u662f\u4ece\u4e0a\u6b21\u5f00\u673a\u5230\u73b0\u5728\u4e3a\u6b62\u7684\u7d2f\u8ba1\u6570\u636e\uff0c \u56e0\u6b64\u4e0d\u80fd\u7b80\u5355\u4f7f\u7528\u3002</p>"},{"location":"mongo2/9mon_monitor/#serverstatus-output","title":"serverStatus() Output","text":"<pre><code>\u2022 host\n\u2022 version\n\u2022 process\n\u2022 pid\n\u2022 uptime\n\u2022 uptimeMillis\n\u2022 uptimeEstimate \n\u2022 localTime\n\u2022 asserts\n\u2022 connections\n\u2022 electionMetrics \n\u2022 extra_info\n\u2022 flowControl\n\u2022 freeMonitoring \n\u2022 flowControl\n\u2022 freeMonitoring \n\u2022 globalLock\n\u2022 locks\n\u2022 network\n\u2022 opLatencies\n\u2022 opReadConcernCounters \n\u2022 opcounters\n\u2022 opcountersRepl\n\u2022 oplogTruncation\n\u2022 repl\n\u2022 storageEngine\n\u2022 tcmalloc\n\u2022 trafficRecording \n\u2022 transactions\n\u2022 transportSecurity \n\u2022 wiredTiger\n</code></pre>"},{"location":"mongo2/9mon_monitor/#serverstatus","title":"<code>serverStatus()</code> \u4e3b\u8981\u4fe1\u606f","text":"<ul> <li> <p>wiredTiger: \u5305\u542b\u5927\u91cf WirdTiger \u6267\u884c\u60c5\u51b5\u7684\u4fe1\u606f:</p> <ul> <li><code>block-manager: WT</code> \u6570\u636e\u5757\u7684\u8bfb\u5199\u60c5\u51b5;</li> <li><code>session</code>: session \u4f7f\u7528\u6570\u91cf;</li> <li><code>concurrentTransactions</code>: Ticket \u4f7f\u7528\u60c5\u51b5;</li> </ul> </li> <li> <p>mem: \u5185\u5b58\u4f7f\u7528\u60c5\u51b5;</p> </li> <li>metrics: \u4e00\u7cfb\u5217\u6027\u80fd\u6307\u6807\u7edf\u8ba1\u4fe1\u606f; </li> <li>\u66f4\u591a\u6307\u6807\u4ecb\u7ecd\u8bf7\u53c2\u8003:serverStatus</li> </ul>"},{"location":"mongo2/9mon_monitor/#_3","title":"\u76d1\u63a7\u62a5\u8b66\u7684\u8003\u91cf","text":"<ul> <li>\u5177\u5907\u4e00\u5b9a\u7684\u5bb9\u9519\u673a\u5236\u4ee5\u51cf\u5c11\u8bef\u62a5\u7684\u53d1\u751f; </li> <li>\u603b\u7ed3\u5e94\u7528\u5404\u6307\u6807\u5cf0\u503c;</li> <li>\u9002\u65f6\u8c03\u6574\u62a5\u8b66\u9608\u503c;</li> <li>\u7559\u51fa\u8db3\u591f\u7684\u5904\u7406\u65f6\u95f4;</li> </ul>"},{"location":"mongo2/9mon_monitor/#_4","title":"\u5efa\u8bae\u76d1\u63a7\u6307\u6807","text":"\u6307\u6807 \u610f\u4e49 \u83b7\u53d6 opcounters(\u64cd\u4f5c\u8ba1\u6570\u5668) \u67e5\u8be2\u3001\u66f4\u65b0\u3001\u63d2\u5165\u3001\u5220\u9664\u3001getmore \u548c\u5176 \u4ed6\u547d\u4ee4\u7684\u7684\u6570\u91cf\u3002 db.serverStatus().opcounters tickets(\u4ee4\u724c) \u5bf9 WiredTiger \u5b58\u50a8\u5f15\u64ce\u7684\u8bfb/\u5199\u4ee4\u724c\u6570\u91cf \u3002\u4ee4\u724c\u6570\u91cf\u8868\u793a\u4e86\u53ef\u4ee5\u8fdb\u5165\u5b58\u50a8\u5f15\u64ce\u7684\u5e76 \u53d1\u64cd\u4f5c\u6570\u91cf\u3002 db.serverStatus().wiredTiger.c oncurrentTransactions replication lag(\u590d\u5236\u5ef6\u8fdf) \u8fd9\u4e2a\u6307\u6807\u4ee3\u8868\u4e86\u5199\u64cd\u4f5c\u5230\u8fbe\u4ece\u7ed3\u70b9\u6240\u9700\u8981 \u7684\u6700\u5c0f\u65f6\u95f4\u3002\u8fc7\u9ad8\u7684 replication lag \u4f1a \u51cf\u5c0f\u4ece\u7ed3\u70b9\u7684\u4ef7\u503c\u5e76\u4e14\u4e0d\u5229\u4e8e\u914d\u7f6e\u4e86\u5199\u5173 \u6ce8 w&gt;1 \u7684\u90a3\u4e9b\u64cd\u4f5c\u3002 db.adminCommand({'replSet GetStatus': 1}) oplog window (\u590d\u5236\u65f6\u95f4\u7a97) \u8fd9\u4e2a\u6307\u6807\u4ee3\u8868oplog\u53ef\u4ee5\u5bb9\u7eb3\u591a\u957f\u65f6\u95f4\u7684\u5199 \u64cd\u4f5c\u3002\u5b83\u8868\u793a\u4e86\u4e00\u4e2a\u4ece\u7ed3\u70b9\u53ef\u4ee5\u79bb\u7ebf\u591a\u957f\u65f6 \u95f4\u4ecd\u80fd\u591f\u8ffd\u4e0a\u4e3b\u8282\u70b9\u3002\u901a\u5e38\u5efa\u8bae\u8be5\u503c\u5e94\u5927\u4e8e 24\u5c0f\u65f6\u4e3a\u4f73\u3002 db.oplog.rs.find().sort({$natura l: -1}).limit(1).next().ts - db.oplog.rs.find().sort({$natura l: 1}).limit(1).next().ts connections(\u8fde\u63a5\u6570) \u8fde\u63a5\u6570\u5e94\u4f5c\u4e3a\u76d1\u63a7\u6307\u6807\u7684\u4e00\u90e8\u5206\uff0c\u56e0\u4e3a\u6bcf\u4e2a \u8fde\u63a5\u90fd\u5c06\u6d88\u8017\u8d44\u6e90\u3002\u5e94\u8be5\u8ba1\u7b97\u4f4e\u5cf0/\u6b63\u5e38/\u9ad8 \u5cf0\u65f6\u95f4\u7684\u8fde\u63a5\u6570\uff0c\u5e76\u5236\u5b9a\u5408\u7406\u7684\u62a5\u8b66\u9608\u503c\u8303\u56f4\u3002 db.serverStatus().connections Query targeting (\u67e5\u8be2\u4e13\u6ce8\u5ea6) \u7d22\u5f15\u952e/\u6587\u6863\u626b\u63cf\u6570\u91cf\u6bd4\u8fd4\u56de\u7684\u6587\u6863\u6570\u91cf\uff0c \u6309\u79d2\u5e73\u5747\u3002\u5982\u679c\u8be5\u503c\u6bd4\u8f83\u9ad8\u8868\u793a\u67e5\u8be2\u7cfb\u9700\u8981 \u8fdb\u884c\u5f88\u591a\u4f4e\u6548\u7684\u626b\u63cf\u6765\u6ee1\u8db3\u67e5\u8be2\u3002\u8fd9\u4e2a\u60c5\u51b5 \u901a\u5e38\u4ee3\u8868\u4e86\u7d22\u5f15\u4e0d\u5f53\u6216\u7f3a\u5c11\u7d22\u5f15\u6765\u652f\u6301\u67e5\u8be2 var status = db.serverStatus() status.metrics.queryExecutor.scanned / status.metrics.document.returned status.metrics.queryExecutor.scannedO bjects / status.metrics.document.returned Scan and Order(\u626b\u63cf\u548c\u6392\u5e8f) \u6bcf\u79d2\u5185\u5185\u5b58\u6392\u5e8f\u64cd\u4f5c\u6240\u5360\u7684\u5e73\u5747\u6bd4\u4f8b\u3002\u5185\u5b58\u6392\u5e8f\u53ef\u80fd\u4f1a\u5341\u5206\u6602\u8d35\uff0c\u56e0\u4e3a\u5b83\u4eec\u901a\u5e38\u8981\u6c42\u7f13\u51b2\u5927\u91cf\u6570\u636e\u3002\u5982\u679c\u6709\u9002\u5f53\u7d22\u5f15\u7684\u60c5\u51b5\u4e0b\uff0c\u5185\u5b58\u6392\u5e8f\u662f\u53ef\u4ee5\u907f\u514d\u7684\u3002 var status = db.serverStatus() status.metrics.operation.scanA ndOrder / status.opcounters.query \u8282\u70b9\u72b6\u6001 \u6bcf\u4e2a\u8282\u70b9\u7684\u8fd0\u884c\u72b6\u6001\u3002\u5982\u679c\u8282\u70b9\u72b6\u6001\u4e0d\u662f PRIMARY\u3001SECONDARY\u3001ARBITER \u4e2d\u7684 \u4e00\u4e2a\uff0c\u6216\u65e0\u6cd5\u6267\u884c\u4e0a\u8ff0\u547d\u4ee4\u5219\u62a5\u8b66 db.runCommand(\"isMaster\") dataSize(\u6570\u636e\u5927\u5c0f) \u6574\u4e2a\u5b9e\u4f8b\u6570\u636e\u603b\u91cf(\u538b\u7f29\u524d) \u6bcf\u4e2a DB \u6267\u884c db.stats(); StorageSize(\u78c1\u76d8\u7a7a\u95f4\u5927\u5c0f) \u5df2\u4f7f\u7528\u7684\u78c1\u76d8\u7a7a\u95f4\u5360\u603b\u7a7a\u95f4\u7684\u767e\u5206\u6bd4\u3002"},{"location":"pg1/1pg_int/","title":"PostgreSQL Interview Questions 2022","text":""},{"location":"pg1/1pg_int/#1-what-is-the-process-of-splitting-a-large-table-into-smaller-pieces-called-in-postgresql","title":"1. What is the process of splitting a large table into smaller pieces called in PostgreSQL?","text":"<p>It is called table partitioning.</p>"},{"location":"pg1/1pg_int/#2-what-is-a-partitioned-table-in-postgresql","title":"2. What is a partitioned table in PostgreSQL?","text":"<p>The partitioned table is a logical structure. It is used to split a large table into smaller pieces, which are called partitions.</p>"},{"location":"pg1/1pg_int/#3-what-purpose-does-pgadmin-in-postgresql-server","title":"3. What purpose does pgAdmin in PostgreSQL server?","text":"<p>The pgAdmin in PostgreSQL is a data administration tool. It serves the purpose of retrieving, developing, testing, and maintaining databases.</p>"},{"location":"pg1/1pg_int/#4how-can-you-avoid-unnecessary-locking-of-a-database","title":"4.How can you avoid unnecessary locking of a database?","text":"<p>We can use MVCC (Multi-version concurrency control) to avoid unnecessary locking of a database.</p>"},{"location":"pg1/1pg_int/#5-what-is-plpython","title":"5. What is PL/Python?","text":"<p>PL/Python is a procedural language to which PostgreSQL provides support.</p>"},{"location":"pg1/1pg_int/#6-which-are-the-methods-postgresql-provides-to-create-a-new-database","title":"6. Which are the methods PostgreSQL provides to create a new database?","text":"<p>PostgreSQL provides the following methods to create a new database:</p> <ul> <li>Using CREATE DATABASE, an SQL command</li> <li>Using created a command-line executable</li> </ul>"},{"location":"pg1/1pg_int/#7-how-do-you-delete-the-database-in-postgresql","title":"7 How do you delete the database in PostgreSQL?","text":"<p>We can delete the database by using any one of the below options:</p> <ul> <li>Using DROP DATABASE, an SQL command</li> <li>Using dropdb a command-line executable</li> </ul>"},{"location":"pg1/1pg_int/#8-what-does-a-schema-contain","title":"8 What does a schema contain?","text":"<p>A schema contains tables along with data types, views, indexes, operators, sequences, and functions.</p>"},{"location":"pg1/1pg_int/#9-what-are-the-different-operators-in-postgresql","title":"9 What are the different operators in PostgreSQL?","text":"<p>The PostgreSQL operators include - Arithmetic operators, Comparison operators, Logical operators, and Bitwise operators.</p>"},{"location":"pg1/1pg_int/#10-what-are-database-callback-functions-called-what-is-its-purpose","title":"10. What are database callback functions called? What is its purpose?","text":"<p>The database callback functions are called PostgreSQL Triggers. When a specified database event occurs, the PostgreSQL Triggers are performed or invoked automatically.</p>"},{"location":"pg1/1pg_int/#11-what-indexes-are-used","title":"11. What indexes are used?","text":"<p>Indexes are used by the search engine to speed up data retrieval.</p>"},{"location":"pg1/1pg_int/#12-what-does-a-cluster-index-do","title":"12. What does a Cluster index do?","text":"<p>Cluster index sorts table data rows based on their key values.</p>"},{"location":"pg1/1pg_int/#13-what-are-the-benefits-of-specifying-data-types-in-columns-while-creating-a-table","title":"13. What are the benefits of specifying data types in columns while creating a table?","text":"<p>Some of these benefits include consistency, compactness, validation, and performance.</p>"},{"location":"pg1/1pg_int/#14-what-do-you-need-to-do-to-update-statistics-in-postgresql","title":"14. What do you need to do to update statistics in PostgreSQL?","text":"<p>To update statistics in PostgreSQL, we need to use a special function called a vacuum.</p>"},{"location":"pg1/1pg_int/#15-what-is-the-disadvantage-of-the-drop-table-command-in-deleting-complete-data-from-an-existing-table","title":"15. What is the disadvantage of the DROP TABLE command in deleting complete data from an existing table?","text":"<p>Though the DROP TABLE command has the ability to delete complete data from an existing table, the disadvantage with it is - it removes complete table structure from the database. </p> <p>Due to this, we need to re-create a table to store data.</p>"},{"location":"pg1/1pg_int/#16-how-can-you-delete-complete-data-from-an-existing-table","title":"16. How can you delete complete data from an existing table?","text":"<p>We can delete complete data from an existing table using the PostgreSQL TRUNCATE TABLE command.</p>"},{"location":"pg1/1pg_int/#17-what-are-the-different-properties-of-a-transaction-in-postgresql-which-acronym-is-used-to-refer-to-them","title":"17 What are the different properties of a transaction in PostgreSQL? Which acronym is used to refer to them?","text":"<p>The properties of a transaction in PostgreSQL include Atomicity, Consistency, Isolation, and Durability. These are referred to by the acronym, namely ACID. </p>"},{"location":"pg1/1pg_int/#18-what-purpose-does-the-ctids-field-serve","title":"18 What purpose does the CTIDs field serve?","text":"<p>The CTIDs field identifies the specific physical rows in a table according to their block and offsets positions in that table.</p>"},{"location":"pg1/1pg_int/#19-which-are-the-commands-used-to-control-transactions-in-postgresql","title":"19. Which are the commands used to control transactions in PostgreSQL?","text":"<p>The commands used to control transactions in PostgreSQL are BEGIN TRANSACTION, COMMIT, and ROLLBACK.</p>"},{"location":"pg1/1pg_int/#20what-are-the-main-differences-between-sql-and-postgresql","title":"20.What are the main differences between SQL and PostgreSQL?","text":"<p>PostgreSQL is an advanced version of SQL.  Some of the differences between these two include the following:</p> <ul> <li>Unlike SQL, views in PostgreSQL are not updatable.</li> <li>Another difference is whereas SQL provides computed columns; the same cannot be expected from PostgreSQL.</li> <li>Unlike SQL, in PostgreSQL, you don\u2019t need to create a DLL to see the code what it is doing.</li> <li>PostgreSQL supports dynamic actions whereas SQL doesn\u2019t support them.</li> </ul>"},{"location":"pg1/1pg_int/#21how-is-security-ensured-in-postgresql","title":"21.How is security ensured in PostgreSQL?","text":"<p>PostgreSQL uses SSL connections to encrypt client or server communications so that security will be ensured.</p>"},{"location":"pg1/1pg_int/#22-what-is-the-function-of-the-atomicity-property-in-postgresql","title":"22. What is the function of the Atomicity property in PostgreSQL?","text":"<p>Atomicity property ensures the successful completion of all the operations in a work unit.</p>"},{"location":"pg1/1pg_int/#23-what-are-the-advantages-of-postgresql","title":"23. What are the advantages of PostgreSQL?","text":"<p>Some of the advantages of PostgreSQL are open-source DBMS, community support, ACID compliance, diverse indexing techniques, full-text search, a variety of replication methods, and diversified extension functions, etc.</p>"},{"location":"pg1/1pg_int/#24-what-does-write-ahead-logging-do","title":"24 What does Write-Ahead Logging do?","text":"<p>The Write-Ahead Logging enhances database reliability by logging changes before any changes or updates are made to the database</p>"},{"location":"pg1/1pg_int/#25-what-are-some-of-the-important-data-administration-tools-supported-by-postgresql","title":"25. What are some of the important data administration tools supported by PostgreSQL?","text":"<p>Some of the important data administration tools supported by PostgreSQL are Psql,  Pgadmin, and Phppgadmin.</p>"},{"location":"pg1/1pg_int/#26-how-can-you-store-the-binary-data-in-postgresql","title":"26. How can you store the binary data in PostgreSQL?","text":"<p>We can store the binary data in PostgreSQL either by using bytes or by using the large object feature.</p>"},{"location":"pg1/1pg_int/#27-what-is-a-non-clustered-index","title":"27. What is a non-clustered index?","text":"<p>In a non-clustered index, the index rows order doesn\u2019t match the order in actual data.</p>"},{"location":"pg1/1pg_int/#28-what-is-the-purpose-of-table-space-in-postgresql","title":"28. What is the purpose of table space in PostgreSQL?","text":"<p>It is a location in the disk. In this, PostgreSQL stores the data files, which contain indices and tables, etc.</p>"},{"location":"pg1/1pg_int/#29-are-there-any-disadvantages-with-postgresql","title":"29 Are there any disadvantages with  PostgreSQL?","text":"<p>Yes. There are a few disadvantages. Some of these include the following:</p> <ul> <li>It is slower than MySQL on the performance front.</li> <li>It doesn\u2019t have the support of a good number of open source applications when compared to MySQL.</li> <li>Since it focuses more on compatibility, changes made to improve the speed need more work.</li> </ul>"},{"location":"pg1/1pg_int/#30-what-does-a-token-representation-in-a-sql-statement","title":"30 What does a token representation in a SQL Statement?","text":"<p>In a SQL Statement, a token represents an identifier, keyword, quoted identifier, special character symbol, or a constant.</p>"},{"location":"pg1/2pg_intall/","title":"1 PostgreSQL\u4ecb\u7ecd&amp;\u5b89\u88c5&amp;\u94fe\u63a5\u7ba1\u7406&amp;\u7528\u6237\u6743\u9650\u7ba1\u7406","text":"<p>PostgreSQL\uff0c\u7b80\u79f0PG\u6216PGSQL. c\u548cc+\uff0b\u5f00\u53d1\u3002\u5f00\u6e90\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7cfb\u7edf\u3002 \u652f\u6301\u591a\u79cd\u64cd\u4f5c\u7cfb\u7edf\u5e73\u53f0\u3002 </p> <ul> <li>\u5b98\u7f51\uff1awww.postgres.org </li> <li>\u4e2d\u6587\u793e\u533a http://www.postgres.cn </li> </ul>"},{"location":"pg1/2pg_intall/#2","title":"2\u3001\u6e90\u7801\u5305\u5b89\u88c5\u914d\u7f6e","text":""},{"location":"pg1/2pg_intall/#21","title":"2.1 \u7cfb\u7edf\u7f51\u7edc\u3001\u9632\u706b\u5899\u914d\u7f6e","text":""},{"location":"pg1/2pg_intall/#22","title":"2.2 \u521b\u5efa\u6570\u636e\u5e93\u7528\u6237\u548c\u7ec4","text":"<pre><code>sudo -i\nuseradd postgres \npasswd postgres \n</code></pre> <p>12345</p> <pre><code># passwd postgres\nChanging password for user postgres.\nNew password:\nBAD PASSWORD: The password is shorter than 8 characters\nRetype new password:\npasswd: all authentication tokens updated successfully.\n</code></pre>"},{"location":"pg1/2pg_intall/#23","title":"2.3 \u5b89\u88c5\u4f9d\u8d56\u5305","text":"<pre><code>yum groupinstall -y \"Development Tools\" \"Legacy UNIX Compatibility\"\nyum install -y bison flex readline* zlib-devel gcc* gmake\n</code></pre>"},{"location":"pg1/2pg_intall/#24","title":"2.4 \u521b\u5efa\u76ee\u5f55\u5e76\u6388\u6743","text":"<pre><code>mkdir -p /usr/local/pg12\nmkdir -p /pgdata/12/data\nchown -R postgres. /pgdata\nchown -R postgres. /usr/local/pg12\nchmod 700 /pgdata/12/data -R\n</code></pre>"},{"location":"pg1/2pg_intall/#25","title":"2.5 \u7cfb\u7edf\u53c2\u6570\u4f18\u5316","text":"<pre><code># vi /etc/sysctl.conf \n\nkernel.shmmax = 68719476736 \nkernel.shmall = 4294967296 \nkernel.shmmni = 4096 \nkernel.sem = 50100 64128000 50100 1280 \nfs.file-max = 7672460 \nnet.ipv4.ip_local_port_range = 9000 65000 \nnet.core.rmem_default = 1048576 \nnet.core.rmem_max = 4194304 \nnet.core.wmem_default = 262144 \nnet.core.wmem_max = 10485761 \n\n# sysctl -p \n\n\n# vi /etc/security/limits.conf \n* soft nofile 131072 \n* hard nofile 131072 \n* soft nproc 131072 \n* hard nproc 131072 \n* soft core unlimited \n* hard core unlimited \n* soft memlock 50000000 \n* hard memlock 50000000 \n\n\u5efa\u8bae\u5173\u95ednuma \u8bbe\u7f6e\u3002\u7b56\u7565\u4e3adeadline(\u673a\u68b0)\u6216\u8005noop(SSD) \n</code></pre> <pre><code># sysctl -p\nkernel.shmmax = 68719476736\nkernel.shmall = 4294967296\nkernel.shmmni = 4096\nkernel.sem = 50100 64128000 50100 1280\nfs.file-max = 7672460\nnet.ipv4.ip_local_port_range = 9000 65000\nnet.core.rmem_default = 1048576\nnet.core.rmem_max = 4194304\nnet.core.wmem_default = 262144\nnet.core.wmem_max = 10485761\n</code></pre>"},{"location":"pg1/2pg_intall/#26-pg","title":"2.6 \u6e90\u7801\u5b89\u88c5pg","text":"<p>2.6.1 \u4e0b\u8f7d\u8f6f\u4ef6\u81f3/opt\uff0c\u5e76\u89e3\u538b </p> <p>https://www.postgresql.org/ftp/source/v12.6/</p> <pre><code>cd /opt/\n[root@jabox opt]#\n\nwget --no-check-certificate https://ftp.postgresql.org/pub/source/v12.6/postgresql-12.6.tar.gz\n\n# ls\npostgresql-12.6.tar.gz\n\n[opt]# tar xf postgresql-12.6.tar.gz\n[opt]# cd postgresql-12.6/\n[postgresql-12.6]# ./configure --prefix=/usr/local/pg12 --with-pgport=1921\n\n[postgresql-12.6]# gmake world\n[postgresql-12.6]# gmake install-world\n</code></pre>"},{"location":"pg1/2pg_intall/#27","title":"2.7 \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf","text":"<pre><code>[postgresql-12.6]# su - postgres\n# vim .bash_profile\n\nexport PGDATA=/pgdata/12/data \nexport LANG=en_US.utf8 \nexport PGHOME=/usr/local/pg12 \nexport LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH \nexport DATE=`date +\"%Y%m%d%H%M\"` \nexport PATH=$PGHOME/bin:$PATH:. \nexport MANPATH=$PGHOME/share/man:$MANPATH \nexport PGUSER=postgres \n\nsource /etc/profile \n</code></pre> <pre><code>[~]$ psql --version\npsql (PostgreSQL) 12.6\n</code></pre>"},{"location":"pg1/2pg_intall/#28","title":"2.8 \u521d\u59cb\u5316\u6570\u636e","text":"<pre><code># su - postgres\n# \u7b80\u6613\u521d\u59cb\u5316\ninitdb -D /pgdata/12/data -W\n# \u751f\u4ea7\u5efa\u8bae\ninitdb -A md5 -D $PGDATA -E utf8 --local=C -W\n</code></pre> <pre><code>$ initdb -D /pgdata/12/data -W\nThe files belonging to this database system will be owned by user \"postgres\".\nThis user must also own the server process.\n\nThe database cluster will be initialized with locale \"en_US.utf8\".\nThe default database encoding has accordingly been set to \"UTF8\".\nThe default text search configuration will be set to \"english\".\n\nData page checksums are disabled.\n\nEnter new superuser password:  12345\nEnter it again: 12345\n\nfixing permissions on existing directory /pgdata/12/data ... ok\ncreating subdirectories ... ok\nselecting dynamic shared memory implementation ... posix\nselecting default max_connections ... 100\nselecting default shared_buffers ... 128MB\nselecting default time zone ... UTC\ncreating configuration files ... ok\nrunning bootstrap script ... ok\nperforming post-bootstrap initialization ... ok\nsyncing data to disk ... ok\n\ninitdb: warning: enabling \"trust\" authentication for local connections\nYou can change this by editing pg_hba.conf or using the option -A, or\n--auth-local and --auth-host, the next time you run initdb.\n\nSuccess. You can now start the database server using\n</code></pre> <p><code>pg_ctl -D /pgdata/12/data -l logfile start</code></p> <pre><code># pg_ctl start\n\nwaiting for server to start....2022-04-24 03:59:25.840 UTC [25554] LOG:  starting PostgreSQL 12.6 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit\n2022-04-24 03:59:25.843 UTC [25554] LOG:  listening on IPv6 address \"::1\", port 1921\n2022-04-24 03:59:25.843 UTC [25554] LOG:  listening on IPv4 address \"127.0.0.1\", port 1921\n2022-04-24 03:59:25.845 UTC [25554] LOG:  listening on Unix socket \"/tmp/.s.PGSQL.1921\"\n2022-04-24 03:59:25.858 UTC [25555] LOG:  database system was shut down at 2022-04-24 03:58:27 UTC\n2022-04-24 03:59:25.859 UTC [25554] LOG:  database system is ready to accept connections\n done\nserver started\n</code></pre>"},{"location":"pg1/2pg_intall/#29-pg","title":"2.9 PG\u521d\u4f53\u9a8c","text":"<pre><code>$ psql\npsql (12.6)\nType \"help\" for help.\n\npostgres=#\n\npostgres=# create database pg1;\nCREATE DATABASE\npostgres=# \\c pg1\nYou are now connected to database \"pg1\" as user \"postgres\".\npg1=# create table t1 (id int);\nCREATE TABLE\npg1=# insert into t1 values(1);\nINSERT 0 1\npg1=# select * from t1;\n id\n----\n  1\n(1 row)\n\npg1=# \\l\n                                 List of databases\n   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges\n-----------+----------+----------+------------+------------+-----------------------\n pg1       | postgres | UTF8     | en_US.utf8 | en_US.utf8 |\n postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |\n template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +\n           |          |          |            |            | postgres=CTc/postgres\n template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +\n           |          |          |            |            | postgres=CTc/postgres\n(4 rows)\n\npg1=# \\d\n        List of relations\n Schema | Name | Type  |  Owner\n--------+------+-------+----------\n public | t1   | table | postgres\n(1 row)\n\npg1=# \\dt\n        List of relations\n Schema | Name | Type  |  Owner\n--------+------+-------+----------\n public | t1   | table | postgres\n(1 row)\n</code></pre>"},{"location":"pg1/2pg_intall/#3","title":"3\u3001\u542f\u52a8\u5173\u95ed","text":""},{"location":"pg1/2pg_intall/#31","title":"3.1 \u624b\u5de5\u65b9\u5f0f","text":"<pre><code>$ pg_ctl --help\n...\nShutdown modes are:\n  smart       quit after all clients have disconnected\n  fast        quit directly, with proper shutdown (default)\n  immediate   quit without complete shutdown; will lead to recovery on restart\n\nAllowed signal names for kill:\n  ABRT HUP INT KILL QUIT TERM USR1 USR2\n</code></pre> <pre><code>pg_ctl -D /pgdata/12/data\uff0f -l logfile start pg_ctl -D /pgdata/12/data/ stop -ms \npg_ctl -D /pgdata/12/data/ stop -mf \npg_ctl -D /pgdata/12/data/ stop -mi \n\npg_ctl restart -mf \n</code></pre>"},{"location":"pg1/2pg_intall/#32","title":"3.2 \u811a\u672c\u65b9\u5f0f","text":"<pre><code>sudo -i\n</code></pre> <pre><code>/opt/postgresql-12.6/contrib/start-scripts/linux\n</code></pre> <pre><code>$ pg_ctl restart -mf\nwaiting for server to shut down....2022-04-24 06:38:03.063 UTC [25554] LOG:  received fast shutdown request\n2022-04-24 06:38:03.064 UTC [25554] LOG:  aborting any active transactions\n2022-04-24 06:38:03.065 UTC [25554] LOG:  background worker \"logical replication launcher\" (PID 25561) exited with exit code 1\n2022-04-24 06:38:03.066 UTC [25556] LOG:  shutting down\n2022-04-24 06:38:03.072 UTC [25554] LOG:  database system is shut down\n done\nserver stopped\nwaiting for server to start....2022-04-24 06:38:03.174 UTC [26062] LOG:  starting PostgreSQL 12.6 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit\n2022-04-24 06:38:03.175 UTC [26062] LOG:  listening on IPv6 address \"::1\", port 1921\n2022-04-24 06:38:03.175 UTC [26062] LOG:  listening on IPv4 address \"127.0.0.1\", port 1921\n2022-04-24 06:38:03.176 UTC [26062] LOG:  listening on Unix socket \"/tmp/.s.PGSQL.1921\"\n2022-04-24 06:38:03.191 UTC [26063] LOG:  database system was shut down at 2022-04-24 06:38:03 UTC\n2022-04-24 06:38:03.193 UTC [26062] LOG:  database system is ready to accept connections\n done\nserver started\n</code></pre>"},{"location":"pg1/2pg_intall/#4","title":"4\u3001\u57fa\u7840\u7ba1\u7406","text":""},{"location":"pg1/2pg_intall/#41","title":"4.1 \u8fde\u63a5\u7ba1\u7406","text":"<p>4.1.0 \u8fde\u63a5\u547d\u4ee4 </p> <p>Socket \u94fe\u63a5</p> <pre><code>[~]$ psql\npsql (12.6)\nType \"help\" for help.\n\npostgres=# exit\n</code></pre> <pre><code>2022-04-24 03:59:25.843 UTC [25554] LOG:  listening on IPv6 address \"::1\", port 1921\n</code></pre> <p>TCP \u8fdc\u7a0b\u94fe\u63a5</p> <pre><code>$ ip addr\n....\n inet 192.168.1.43/24 brd 192.168.1.255 scope global noprefixroute dynamic eth1\n</code></pre> <p><code>192.168.1.43/24</code> : <code>192.168.1.0/24</code></p> <pre><code>psql -d postgres -h 192.168.1.43 -p 1921 -U postgres\n</code></pre> <pre><code>$ psql -d postgres -h 192.168.1.43 -p 1921 -U postgres\npsql: error: could not connect to server: Connection refused\n    Is the server running on host \"103.109.147.26\" and accepting\n    TCP/IP connections on port 1921?\n</code></pre> <p>4.1.1 pg\u9632\u706b\u5899\u4ecb\u7ecd </p> <p><code>pg_hba.conf</code> \u6587\u4ef6\u4e3aPG\u5b9e\u4f8b\u7684\u9632\u706b\u5899\u914d\u7f6e\u6587\u4ef6\u3002 \u914d\u7f6e\u6587\u4ef6\u5206\u4e3a5\u90e8\u5206\uff1a </p> <p>\u914d\u7f6e\u793a\u4f8b\uff1a </p> <pre><code># TYPE DATABASE USER ADDRESS  METHOD\nhost    all    all  192.168.1.0/24       md5\n\n# TYPE DATABASE USER ADDRESS  METHOD\nhost    test    pstest  0.0.0.0/0      md5\n</code></pre> <pre><code>$ cd $PGDATA\n[postgres]$ pwd\n/pgdata/12/data\n# vim pg_hba.conf\n\n# TYPE  DATABASE        USER            ADDRESS                 METHOD\n\n# \"local\" is for Unix domain socket connections only\nlocal   all             all                                     trust\n# IPv4 local connections:\nhost    all             all             127.0.0.1/32            trust\nhost    all             all             192.168.1.0/24         md5\n</code></pre> <p>\u6ce8\u610f\uff0c\u521a\u88c5\u5b8cPG\uff0c\u9ed8\u8ba4\u76d1\u542clocal,\u5982\u679c\u8981\u8fdc\u7a0b\u94fe\u63a5\uff0c\u9700\u8981\u76d1\u542c\u5bf9\u5916\u63d0\u4f9b\u670d\u52a1\u7684\u5730\u5740</p> <pre><code>vim postgresql.conf\n\n# - Connection Settings -\n\nlisten_addresses = '0.0.0.0'            # what IP address(es) to listen on;\n                                        # comma-separated list of addresses;\n                                        # defaults to 'localhost'; use '*' for all\n                                        # (change requires restart)\n</code></pre> <p>\u91cd\u542f\u6570\u636e\u5e93</p> <pre><code>pg_ctl restart -mf\n</code></pre> <pre><code>$ psql -d postgres -h 192.168.1.43 -p 1921 -U postgres\nPassword for user postgres:\npsql (12.6)\nType \"help\" for help.\n\npostgres=#\n</code></pre>"},{"location":"pg1/2pg_intall/#42","title":"4.2 \u7528\u6237","text":"<p>4.2.1 \u7528\u6237\u4f5c\u7528</p> <p>\u7528\u6765\u767b\u5f55\u6570\u636e\u5e93\u5b9e\u4f8b\uff0c \u7ba1\u7406\u6570\u636e\u5e93\u5bf9\u8c61</p> <p>4.2.1 \u7528\u6237\u5b9a\u4e49\u7684\u65b9\u6cd5</p> <pre><code>create user\ncreate role\ndrop user\n</code></pre> <pre><code>postgres=# \\help create user;\nCommand:     CREATE USER\nDescription: define a new database role\nSyntax:\nCREATE USER name [ [ WITH ] option [ ... ] ]\n\nwhere option can be:\n\n      SUPERUSER | NOSUPERUSER\n    | CREATEDB | NOCREATEDB\n    | CREATEROLE | NOCREATEROLE\n    | INHERIT | NOINHERIT\n    | LOGIN | NOLOGIN\n    | REPLICATION | NOREPLICATION\n    | BYPASSRLS | NOBYPASSRLS\n    | CONNECTION LIMIT connlimit\n    | [ ENCRYPTED ] PASSWORD 'password' | PASSWORD NULL\n    | VALID UNTIL 'timestamp'\n    | IN ROLE role_name [, ...]\n    | IN GROUP role_name [, ...]\n    | ROLE role_name [, ...]\n    | ADMIN role_name [, ...]\n    | USER role_name [, ...]\n    | SYSID uid\n\nURL: https://www.postgresql.org/docs/12/sql-createuser.html\n</code></pre> <p>\u4f8b\u5b50</p> <pre><code>CREATE USER admin with SUPERUSER password 'admin';\nCREATE ROLE\n</code></pre> <pre><code>$ psql -d postgres -h 192.168.1.43 -p 1921 -U admin\nPassword for user admin:\npsql (12.6)\nType \"help\" for help.\n\npostgres=#\n</code></pre> <p>Create role must with login option</p> <pre><code>CREATE USER test1 WITH PASSWORD 'test1';\nCREATE ROLE test2 WITH  LOGIN PASSWORD 'test2' VALID UNTIL '2022-12-31';\nCREATE ROLE admin WITH SUPERUSER LOGIN 'admin';\nCREATE USER repl  REPLICATION LOGIN ENCRYPTED PASSWORD 'repl';\n\ndrop user username;\nalter user username with password '1234';\n</code></pre> <pre><code>$ psql -d postgres -h 192.168.1.43 -p 1921 -U test1\nPassword for user test1:\npsql (12.6)\nType \"help\" for help.\n</code></pre> <pre><code>$ psql -d postgres -h 192.168.1.43 -p 1921 -U test2\nPassword for user test2:\npsql (12.6)\nType \"help\" for help.\n</code></pre> <pre><code>[postgres@jabox data]$ psql -d postgres -h 192.168.1.43 -p 1921 -U admin\nPassword for user admin:\npsql (12.6)\nType \"help\" for help.\n\npostgres=# drop user test2;\nDROP ROLE\n</code></pre> <pre><code>postgres=# alter user test1 with password 'test';\nALTER ROLE\n</code></pre> <pre><code>postgres=# CREATE ROLE test2 WITH  PASSWORD 'test2' VALID UNTIL '2022-12-31';\nCREATE ROLE\n</code></pre> <pre><code>postgres=# \\du\n                                   List of roles\n Role name |                         Attributes                         | Member of\n-----------+------------------------------------------------------------+-----------\n admin     | Superuser                                                  | {}\n postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}\n repl      | Replication                                                | {}\n test1     |                                                            | {}\n test2     | Cannot login                                              +| {}\n           | Password valid until 2022-12-31 00:00:00+00                |\n</code></pre>"},{"location":"pg1/2pg_intall/#43","title":"4.3 \u6743\u9650\u7ba1\u7406","text":"<p>4.3.1 \u6743\u9650\u7ea7\u522b </p> <ul> <li>cluster\u6743\u9650\uff1a\u5b9e\u4f8b\u6743\u9650\u901a\u8fc7<code>pg_hba.com</code>\u914d\u7f6e\u3002 </li> <li>database\u6743\u9650\uff1a\u6570\u636e\u5e93\u6743\u9650\u901a\u8fc7<code>grant</code>\u548c<code>revoke</code>\u64cd\u4f5c<code>schema</code>\u914d\u7f6e\u3002 </li> <li>TBS\u6743\u9650\uff1a\u8868\u7a7a\u95f4\u6743\u9650\u901a\u8fc7grant\u548crevoke\u64cd\u4f5c\u8868\u3001\u7269\u5316\u89c6\u56fe\u3001\u7d22\u5f15\u3001\u4e34\u65f6\u8868\u914d\u7f6e\u3002 </li> <li>schema\u6743\u9650\uff1a\u6a21\u5f0f\u6743\u9650\u901a\u8fc7grant\u548crevoke\u64cd\u4f5c\u6a21\u5f0f\u4e0b\u7684\u5bf9\u8c61\u914d\u7f6e\u3002 </li> <li>object\u6743\u9650\uff1a\u5bf9\u8c61\u6743\u9650\u901a\u8fc7grant\u548crevoke\u914d\u7f6e\u3002 </li> </ul> <p></p> <p>4.3.2 \u6743\u9650\u5b9a\u4e49</p> <ul> <li>database\u6743\u9650\u8bbe\u7f6e</li> </ul> <pre><code>grant create on database test to test1\n</code></pre> <ul> <li>schema\u6743\u9650 </li> </ul> <pre><code>ALTER SCHEMA abc OWNER to abc; \n\nGRANT select, insert, update, delete ON ALL TABLES IN SCHEMA abc to abc; \n</code></pre> <ul> <li>object\u6743\u9650</li> </ul> <pre><code>grant select, insert, update, delete on a.b to u; \n</code></pre> <pre><code>postgres=# create database jam;\nCREATE DATABASE\n\npostgres=# \\c jam\nYou are now connected to database \"jam\" as user \"admin\".\n\njam=# create schema dwp;\nCREATE SCHEMA\n\njam=# create user jam with password 'jam';\nCREATE ROLE\n\njam=# ALTER SCHEMA dwp OWNER to jam;\nALTER SCHEMA\n\njam=# GRANT select,insert,update,delete ON ALL TABLES IN SCHEMA dwp to jam;\nGRANT\n</code></pre>"},{"location":"pg1/3pg_cmd/","title":"2 \u5e38\u7528\u57fa\u7840\u547d\u4ee4\u4ecb\u7ecd","text":"<pre><code>\\?\n\\l\n\\d\n\\d t1\n\\c dbname\n\\help\n\\help create user\n\\du\n\\x\n</code></pre> <pre><code>postgres=# \\?\nGeneral\n  \\copyright             show PostgreSQL usage and distribution terms\n  \\crosstabview [COLUMNS] execute query and display results in crosstab\n  \\errverbose            show most recent error message at maximum verbosity\n  \\g [FILE] or ;         execute query (and send results to file or |pipe)\n  \\gdesc                 describe result of query, without executing it\n  \\gexec                 execute query, then execute each value in its result\n  \\gset [PREFIX]         execute query and store results in psql variables\n  \\gx [FILE]             as \\g, but forces expanded output mode\n  \\q                     quit psql\n  \\watch [SEC]           execute query every SEC seconds\n...\n</code></pre> <pre><code>postgres=# \\h\nAvailable help:\n  ABORT                            ALTER ROLE                       CHECKPOINT                       CREATE OPERATOR                  CREATE USER                      DROP MATERIALIZED VIEW           DROP TRIGGER                     RESET\n  ALTER AGGREGATE                  ALTER ROUTINE                    CLOSE                            CREATE OPERATOR CLASS            CREATE USER MAPPING              DROP OPERATOR                    DROP TYPE                        REVOKE\n</code></pre> <p>show databases;</p> <pre><code>\\l\n</code></pre> <pre><code>postgres=# \\l\n                                 List of databases\n   Name    |  Owner   | Encoding |  Collate   |   Ctype    |   Access privileges\n-----------+----------+----------+------------+------------+-----------------------\n jam       | admin    | UTF8     | en_US.utf8 | en_US.utf8 |\n pg1       | postgres | UTF8     | en_US.utf8 | en_US.utf8 |\n postgres  | postgres | UTF8     | en_US.utf8 | en_US.utf8 |\n template0 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +\n           |          |          |            |            | postgres=CTc/postgres\n template1 | postgres | UTF8     | en_US.utf8 | en_US.utf8 | =c/postgres          +\n           |          |          |            |            | postgres=CTc/postgres\n(5 rows)\n</code></pre> <p>Use database</p> <pre><code>\\c pg1\nYou are now connected to database \"pg1\" as user \"postgres\".\npg1=# \\d\n        List of relations\n Schema | Name | Type  |  Owner\n--------+------+-------+----------\n public | t1   | table | postgres\n(1 row)\n\npg1=# \\dt\n        List of relations\n Schema | Name | Type  |  Owner\n--------+------+-------+----------\n public | t1   | table | postgres\n(1 row)\n\npg1=# \\d t1\n                 Table \"public.t1\"\n Column |  Type   | Collation | Nullable | Default\n--------+---------+-----------+----------+---------\n id     | integer |           |          |\n\npg1=# \\dt t1\n        List of relations\n Schema | Name | Type  |  Owner\n--------+------+-------+----------\n public | t1   | table | postgres\n(1 row)\n\n</code></pre> <pre><code>pg1=# select * from pg_tables;\n     schemaname     |        tablename        | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity\n--------------------+-------------------------+------------+------------+------------+----------+-------------+-------------\n public             | t1                      | postgres   |            | f          | f        | f           | f\n pg_catalog         | pg_statistic            | postgres   |            | t          | f        | f           | f\n pg_catalog         | pg_type                 | postgres   |            | t          | f        | f           | f\n pg_catalog         | pg_foreign_server       | postgres   |            | t          | f        | f           | f\n</code></pre> <pre><code>pg1=# select  * from pg_tables where schemaname != 'pg_catalog';\n     schemaname     |        tablename        | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity\n--------------------+-------------------------+------------+------------+------------+----------+-------------+-------------\n public             | t1                      | postgres   |            | f          | f        | f           | f\n information_schema | sql_packages            | postgres   |            | f          | f        | f           | f\n information_schema | sql_features            | postgres   |            | f          | f        | f           | f\n information_schema | sql_implementation_info | postgres   |            | f          | f        | f           | f\n information_schema | sql_parts               | postgres   |            | f          | f        | f           | f\n information_schema | sql_languages           | postgres   |            | f          | f        | f           | f\n information_schema | sql_sizing              | postgres   |            | f          | f        | f           | f\n information_schema | sql_sizing_profiles     | postgres   |            | f          | f        | f           | f\n</code></pre> <pre><code>pg1=# select  * from pg_tables where schemaname not in ('pg_catalog','information_schema');\n schemaname | tablename | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity\n------------+-----------+------------+------------+------------+----------+-------------+-------------\n public     | t1        | postgres   |            | f          | f        | f           | f\n(1 row)\n</code></pre> <pre><code>pg1=# \\x\nExpanded display is on.\npg1=# select  * from pg_tables where schemaname not in ('pg_catalog','information_schema');\n-[ RECORD 1 ]---------\nschemaname  | public\ntablename   | t1\ntableowner  | postgres\ntablespace  |\nhasindexes  | f\nhasrules    | f\nhastriggers | f\nrowsecurity | f\n</code></pre>"},{"location":"pg1/4pg_logs/","title":"3 Online WAL[Write Head Log]\u65e5\u5fd7\uff08redo)","text":""},{"location":"pg1/4pg_logs/#online-wal","title":"\u5173\u4e8eOnline WAL\u65e5\u5fd7","text":"<p>\u8fd9\u4e2a\u65e5\u5fd7\u5b58\u5728\u7684\u76ee\u7684\u662f\u4e3a\u4e86\u4fdd\u8bc1\u5d29\u6e83\u540e\u7684\u5b89\u5168\uff0c\u5982\u679c\u7cfb\u7edf\u5d29\u6e83\uff0c\u53ef\u4ee5\"\u91cd\u653e\"\u4ece\u6700\u540e\u4e00\u6b21\u68c0\u67e5\u70b9\u4ee5\u6765\u7684\u65e5\u5fd7\u9879\u6765\u6062\u590d\u6570\u636e\u5e93\u7684\u4e00\u81f4\u6027\u3002 \u4f46\u662f\u4e5f\u5b58\u5728\u65e5\u5fd7\u81a8\u80c0\u95ee\u9898 </p>"},{"location":"pg1/4pg_logs/#online-wal_1","title":"\u8bbe\u7f6e<code>Online WAL</code>\u65e5\u5fd7","text":"<p>pg\u63d0\u4f9b\u5982\u4e0b\u53c2\u6570\u63a7\u5236wal\u65e5\u5fd7\u7684\u5927\u5c0f </p> <pre><code>max_wal_size=1GB \nmin_wal_size=8OMB\n</code></pre> <ul> <li><code>max_wal_size</code>(integer)</li> </ul> <p>\u5728\u81ea\u52a8WAL\u68c0\u67e5\u70b9\u4e4b\u95f4\u5141\u8bb8WAL\u589e\u957f\u5230\u7684\u6700\u5927\u5c3a\u5bf8\u3002\u8fd9\u662f\u4e00\u4e2a\u8f6f\u9650\u5236\uff0c\u5728\u7279\u6b8a\u7684\u60c5\u51b5\u4e0bWAL\u5c3a\u5bf8\u53ef\u80fd\u4f1a\u8d85\u8fc7<code>max_wal_size</code>\uff0c \u4f8b\u5982\u5728\u91cd\u5ea6\u8d1f\u8377\u4e0b\u3001<code>archive_command</code>\u5931\u8d25\u6216\u8005\u9ad8\u7684<code>wal_keep_segments</code>\u8bbe\u7f6e\u3002 </p> <p>\u5982\u679c\u6307\u5b9a\u503c\u65f6\u6ca1\u6709\u5355\u4f4d\uff0c\u5219\u4ee5\u5146\u5b57\u8282\u4e3a\u5355\u4f4d\u3002\u9ed8\u8ba4\u4e3a1GB\u3002\u589e\u52a0\u8fd9\u4e2a\u53c2\u6570\u53ef\u80fd\u5bfc\u81f4\u5d29\u6e83\u6062\u590d\u6240\u9700\u7684\u65f6\u95f4\u3002\u8fd9\u4e2a\u53c2\u6570\u53ea\u80fd\u5728<code>postgresql.conf</code>\u4e2d\u8bbe\u7f6e\u6216\u8005\u670d\u52a1\u5668\u547d\u4ee4\u884c\u4e2d\u8bbe\u7f6e\u3002 </p> <ul> <li><code>min_wal_size</code>(integer)</li> </ul> <p>\u53ea\u8981WAL\u78c1\u76d8\u7528\u91cf\u4fdd\u6301\u5728\u8fd9\u4e2a\u8bbe\u7f6e\u4e4b\u4e0b\uff0c\u5728\u68c0\u67e5\u70b9\u65f6\u65e7\u7684WAL\u6587\u4ef6\u603b\u662f\u88ab\u56de\u6536\u4ee5\u4fbf\u672a\u6765\u4f7f\u7528\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u88ab\u5220\u9664\u3002\u8fd9\u53ef\u4ee5\u88ab\u7528\u6765\u786e\u4fdd\u6709\u8db3\u591f\u7684WAL\u7a7a\u95f4\u88ab\u4fdd\u7559\u6765\u5e94\u4ed8WAL\u4f7f\u7528\u7684\u9ad8\u5cf0\uff0c\u4f8b\u5982\u8fd0\u884c\u5927\u578b\u7684\u6279\u5904\u7406\u4efb\u52a1\u3002</p> <p>\u5982\u679c\u6307\u5b9a\u503c\u65f6\u6ca1\u6709\u5355\u4f4d\uff0c\u5219\u4ee5\u5146\u5b57\u8282\u4e3a\u5355\u4f4d\u3002\u9ed8\u8ba4\u662f<code>80 MB</code>\u8fd9\u4e2a\u53c2\u6570\u53ea\u80fd\u5728<code>postgresql.conf</code>\u6216\u8005\u670d\u52a1\u5668\u547d\u4ee4\u884c\u4e2d\u8bbe\u7f6e\u3002 </p> <ul> <li>wal\u4f4d\u7f6e</li> </ul> <p><code>wal</code>\u5728<code>\uff04PGDATA/pg_wal</code>\u4e0b\u300210\u4e4b\u524d\u4e3a<code>pg_xlog</code> </p> <pre><code>cd /pgdata/12/data/pg_wal\n[pg_wal]$ ls -trl\ntotal 16384\ndrwx------. 2 postgres postgres        6 Apr 24 03:58 archive_status\n-rw-------. 1 postgres postgres 16777216 Apr 26 04:42 000000010000000000000001\n</code></pre> <ul> <li>wal\u547d\u540d\u683c\u5f0f </li> </ul> <p>\u6587\u4ef6\u540d\u79f0\u4e3a16\u8fdb\u5236\u768424\u4e2a\u5b57\u7b26\u7ec4\u6210\uff0c\u6bcf8\u4e2a\u5b57\u7b26\u4e00\u7ec4\uff0c\u6bcf\u7ec4\u7684\u610f\u4e49\u5982\u4e0b\uff1a</p> <pre><code>00000001 00000000 00000001 \n\u65f6\u95f4\u7ebf    \u903b\u8f91id    \u7269\u7406id\n</code></pre> <ul> <li>\u67e5\u770bWAL\u65f6\u95f4 </li> </ul> <pre><code>postgres=# select pg_walfile_name(pg_current_wal_lsn());\n     pg_walfile_name\n--------------------------\n 000000010000000000000001\n(1 row)\n\npostgres=# select * from pg_ls_waldir() order by modification asc;\n           name           |   size   |      modification\n--------------------------+----------+------------------------\n 000000010000000000000001 | 16777216 | 2022-04-26 04:42:31+00\n(1 row)\n</code></pre> <pre><code>postgres=# select pg_current_wal_lsn();\n pg_current_wal_lsn\n--------------------\n 0/1654A38\n(1 row)\n</code></pre> <ul> <li><code>pg_current_wal_lsn()</code> is a system function returning the current write-ahead log write location.</li> <li><code>pg_walfile_name()</code> : is a system function for obtaining the name of the WAL file corresponding to the provided LSN( Log Sequence Number).</li> <li> <p><code>pg_ls_waldir()</code>: returns a list of all files in the <code>pg_wal</code> directory together with their size and modification timestamp.</p> </li> <li> <p>\u5207\u6362WAL\u65e5\u5fd7 </p> </li> </ul> <pre><code>postgres=# select pg_switch_wal();\n pg_switch_wal\n---------------\n 0/1654A50\n(1 row)\n\npostgres=# select * from pg_ls_waldir() order by modification asc;\n           name           |   size   |      modification\n--------------------------+----------+------------------------\n 000000010000000000000001 | 16777216 | 2022-04-26 09:28:21+00\n 000000010000000000000002 | 16777216 | 2022-04-26 09:28:22+00\n(2 rows)\n</code></pre> <ul> <li> <p><code>pg_switch_wal</code>: is a system function which forces PostgreSQL to switch to a new WAL file. <code>pg_switch_wal() \u2192 pg_lsn</code></p> </li> <li> <p><code>pg_waldump</code>\u67e5\u770b wal </p> </li> </ul> <p><code>pg_waldump</code>\u53ef\u4ee5\u67e5\u770bwal\u7684\u5177\u4f53\u5185\u5bb9 </p> <pre><code>postgres=# select pg_walfile_name(pg_current_wal_lsn());\n     pg_walfile_name\n--------------------------\n 000000010000000000000002\n(1 row)\n\npostgres=# select * from pg_ls_waldir() order by modification asc;\n           name           |   size   |      modification\n--------------------------+----------+------------------------\n 000000010000000000000003 | 16777216 | 2022-04-26 09:28:21+00\n 000000010000000000000002 | 16777216 | 2022-04-26 09:32:37+00\n(2 rows)\n</code></pre> <pre><code>$ pg_waldump  000000010000000000000002\nrmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/02000028, prev 0/01654A38, desc: RUNNING_XACTS nextXid 501 latestCompletedXid 500 oldestRunningXid 501\nrmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/02000060, prev 0/02000028, desc: RUNNING_XACTS nextXid 501 latestCompletedXid 500 oldestRunningXid 501\nrmgr: XLOG        len (rec/tot):    114/   114, tx:          0, lsn: 0/02000098, prev 0/02000060, desc: CHECKPOINT_ONLINE redo 0/2000060; tli 1; prev tli 1; fpw true; xid 0:501; oid 16396; multi 1; offset 0; oldest xid 480 in DB 1; oldest multi 1 in DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 501; online\nrmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/02000110, prev 0/02000098, desc: RUNNING_XACTS nextXid 501 latestCompletedXid 500 oldestRunningXid 501\npg_waldump: fatal: error in WAL record at 0/2000110: invalid record length at 0/2000148: wanted 24, got 0\n</code></pre> <pre><code>postgres=# \\c pg1\nYou are now connected to database \"pg1\" as user \"postgres\".\n\npg1=# \\dt\n        List of relations\n Schema | Name | Type  |  Owner\n--------+------+-------+----------\n public | t1   | table | postgres\n(1 row)\n\npg1=# insert into t1 values(2);\nINSERT 0 1\n</code></pre> <pre><code>$ cd /pgdata/12/data/pg_wal\n[pg_wal]$ pg_waldump  000000010000000000000002\n...\nrmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/02000110, prev 0/02000098, desc: RUNNING_XACTS nextXid 501 latestCompletedXid 500 oldestRunningXid 501\nrmgr: Heap        len (rec/tot):     54/   150, tx:        501, lsn: 0/02000148, prev 0/02000110, desc: INSERT off 2 flags 0x00, blkref #0: rel 1663/16384/16385 blk 0 FPW\nrmgr: Transaction len (rec/tot):     34/    34, tx:        501, lsn: 0/020001E0, prev 0/02000148, desc: COMMIT 2022-04-26 09:41:34.914619 UTC\nrmgr: Standby     len (rec/tot):     54/    54, tx:          0, lsn: 0/02000208, prev 0/020001E0, desc: RUNNING_XACTS nextXid 502 latestCompletedXid 500 oldestRunningXid 501; 1 xacts: 501\n</code></pre>"},{"location":"pg1/4pg_logs/#10-arch-wal-log","title":"10 ARCH WAL log","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u6570\u636e\u9ad8\u53ef\u7528\u6027\uff0c\u901a\u5e38\u9700\u8981\u8bbe\u7f6e\u5f52\u6863\uff0c\u6240\u8c13\u7684\u5f52\u6863\uff0c\u5176\u5b9e\u5c31\u662f\u628a<code>pg_wal</code>\u91cc\u9762\u7684\u65e5\u5fd7\u5907\u4efd\u51fa\u6765\uff0c\u5f53\u7cfb\u7edf\u6545\u969c\u540e\u53ef\u4ee5\u901a\u8fc7\u5f52 \u6863\u7684\u65e5\u5fd7\u6587\u4ef6\u5bf9\u6570\u636e\u8fdb\u7259\u7433\u590d\u3002\u914d\u7f6e\u5f52\u6863\u8981\u5f00\u542f\u5982\u4e0b\u53c2\u6570\uff1a </p> <ul> <li><code>wal_level=replica</code> (pg13\u9ed8\u8ba4\u5df2\u7ecf\u5f00\u542freplica) </li> </ul> <p>\u8be5\u53c2\u6570\u7684\u53ef\u9009\u7684\u503c\u6709minimal,replica\u548c logical, wal\u7684\u7ea7\u522b\u4f9d\u6b21\u589e\u9ad8\uff0c\u5728wal\u7684\u4fe1\u606f\u4e5f\u8d8a\u591a\u3002\u7531\u4e8eminimal\u8fd9\u4e00\u7ea7\u522b\u7684wal\u4e0d\u5305\u542b\u4ece\u57fa\u7840\u7684\u5907\u4efd\u548cwal\u65e5\u5fd7\u91cd\u5efa\u6570\u636e\u7684\u8db3\u591f\u4fe1\u606f\uff0c\u5728\u8be5\u6a21\u5f0f\u4e0b\uff0c\u65e0\u6cd5\u5f00\u542fwal\u65e5\u5fd7\u5f52\u6863 </p> <ul> <li><code>archive_mode=on</code> </li> </ul> <p>\u4e0a\u8ff0\u53c2\u6570\u4e3a on\uff0c\u8868\u793a\u6253\u5f00\u5f52\u6863\u5907\u4efd\uff0c\u53ef\u9009\u7684\u53c2\u6570\u4e3aon, off, always\u9ed8\u8ba4\u503c\u4e3aoff\uff0c\u6240\u4ee5\u8981\u624b\u52a8\u6253\u5f00 </p> <ul> <li><code>archive_command= 'test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f'</code> </li> </ul> <p>\u8be5\u53c2\u6570\u7684\u9ed8\u8ba4\u503c\u662f\u4e00\u4e2a\u7a7a\u5b57\u7b26\u4e32\uff0c\u4ed6\u7684\u503c\u53ef\u4ee5\u662f\u4e00\u6761shell\u547d\u4ee4\u6216\u8005\u4e00\u4e2a\u590d\u6742\u7684shell\u811a\u672c\u3002\u5728shell\u6708\u5374\u672c\u6216\u547d\u4ee4\u4e2d\u53ef\u4ee5\u7528\"%p\"\u8868\u793a\u5c06\u8981\u5f52\u6863\u7684wal\u6587\u4ef6\u5305\u542b\u5b8c\u6574\u8def\u5f84\u7684\u4fe1\u606f\u7684\u6587\u4ef6\u540d\uff0c\u7528\"%f\"\u4ee3\u8868\u4e0d\u5305\u542b\u8def\u5f84\u4fe1\u606f\u7684wal\u6587\u4ef6\u7684\u6587\u4ef6\u540d</p> <p>\u6ce8\u610f\uff1a<code>wal_level</code>\u548c<code>archive_mode</code>\u53c2\u6570\u4fee\u6539\u90fd\u9700\u8981\u91cd\u65b0\u542f\u52a8\u6570\u636e\u5e93\u624d\u53ef\u4ee5\u751f\u6548\u3002\u800c\u4fee\u6539archive command\u5219\u4e0d\u9700\u8981\u3002\u6240\u4ee5\u4e00\u822c\u914d\u7f6e\u65b0\u7cfb \u7edf\u65f6\uff0c\u65e0\u8bba\u5f53\u65f6\u662f\u5426\u9700\u8981\u5f52\u6863\uff0c\u8fd9\u8981\u5efa\u8bae\u5c06\u8fd9\u4e24\u4e2a\u53c2\u6570\u5f00\u542f</p> <pre><code>#------------------------------------------------------------------------------\n# WRITE-AHEAD LOG\n#------------------------------------------------------------------------------\n\n# - Settings -\n\nwal_level = replica                     # minimal, replica, or logical\n                                        # (change requires restart)\nfsync = on                              # flush data to disk for crash safety\n                                        # (turning this off can cause\n                                        # unrecoverable data corruption)\nsynchronous_commit = on         # synchronization level;\n                                        # off, local, remote_write, remote_apply, or on\nwal_sync_method = fsync         # the default is the first option\n...\n\n# - Checkpoints -\n\n#checkpoint_timeout = 5min              # range 30s-1d\nmax_wal_size = 1GB\nmin_wal_size = 80MB\n#checkpoint_completion_target = 0.5     # checkpoint target duration, 0.0 - 1.0\n...\n# - Archiving -\n\narchive_mode = on               # enables archiving; off, on, or always\n                                # (change requires restart)\narchive_command =  'test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f'             # command to use to archive a logfile segment\n                                # placeholders: %p = path of file to archive\n                                #               %f = file name only\n</code></pre> <p>\u914d\u7f6e\u53c2\u6570</p> <pre><code># - Archiving -\n\narchive_mode = on               # enables archiving; off, on, or always\n                                # (change requires restart)\narchive_command =  'test ! -f /mnt/server/archivedir/%f &amp;&amp; cp %p /mnt/server/archivedir/%f'             # command to use to archive a logfile \n</code></pre> <p>\u91cd\u542f\u6570\u636e\u5e93</p> <pre><code>$ pg_ctl restart -mf\nwaiting for server to shut down.... done\nserver stopped\nwaiting for server to start....2022-04-26 11:47:06.581 UTC [9661] LOG:  starting PostgreSQL 12.6 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit\n2022-04-26 11:47:06.582 UTC [9661] LOG:  listening on IPv4 address \"0.0.0.0\", port 1921\n2022-04-26 11:47:06.583 UTC [9661] LOG:  listening on Unix socket \"/tmp/.s.PGSQL.1921\"\n2022-04-26 11:47:06.596 UTC [9661] LOG:  redirecting log output to logging collector process\n2022-04-26 11:47:06.596 UTC [9661] HINT:  Future log output will appear in directory \"log\".\n done\nserver started\n</code></pre> <pre><code>$ sudo -i\n[root@jabox ~]# mkdir /archive\n[root@jabox ~]# chown -R postgres. /archive\n</code></pre> <p>\u63d2\u5165\u6570\u636e\uff0c\u53c2\u770b\u5f52\u6863</p> <pre><code>$ psql\npsql (12.6)\nType \"help\" for help.\n\npostgres=#\\c pg1\nYou are now connected to database \"pg1\" as user \"postgres\".\npg1=# insert into t1 values(generate_series(1,10000000));\nINSERT 0 10000000\n</code></pre> <pre><code>pg1=# select pg_switch_wal();\n pg_switch_wal\n---------------\n 0/4F428450\n(1 row)\n\npg1=# select pg_switch_wal();\n pg_switch_wal\n---------------\n 0/50000078\n(1 row)\n</code></pre>"},{"location":"pg1/4pg_stru/","title":"4 \u4f53\u7cfb\u7ed3\u6784\u4ecb\u7ecd","text":""},{"location":"pg1/4pg_stru/#1","title":"1 \u6574\u4f53\u7ed3\u6784\u53ca\u8fdb\u7a0b\u7ed3\u6784","text":""},{"location":"pg1/4pg_stru/#cs","title":"C/S\u7ed3\u6784","text":"<pre><code>PG\u662f\u4e00\u4e2a\u5178\u578b\u7684C/S\u6a21\u578b\u3002 \n</code></pre>"},{"location":"pg1/4pg_stru/#_1","title":"\u4f53\u7cfb\u7ed3\u6784\u6982\u89c8","text":"<p>\u4f53\u7cfb\u7ed3\u6784\uff1d\u5b9e\u4f8b\uff0b\u5b58\u50a8\u7ed3\u6784 </p> <p>\u5b9e\u4f8b\uff1d\u8fdb\u7a0b\uff0b\u5185\u5b58\u7ed3\u6784 </p> <p>Process and Memory Architecture</p> <p></p> <p>\u7ed3\u6784\u5b9e\u4f8b </p> <p></p> <ul> <li>Master process </li> <li>A postgres server process is a parent of all processes related to a database cluster management.</li> <li>Each backend process handles all queries and statements issued by a connected client.</li> <li>Various background processes perform processes of each feature (e.g., VACUUM and CHECKPOINT processes) for database management.</li> </ul> <p></p>"},{"location":"pg1/4pg_stru/#_2","title":"\u8fdb\u7a0b\u7ed3\u6784","text":"<pre><code>$ ps -ef | grep postgres\npostgres  3094 26286  0 04:40 pts/0    00:00:00 ps -ef\npostgres  3095 26286  0 04:40 pts/0    00:00:00 grep --color=auto postgres\nroot     26027 25478  0 Apr24 pts/0    00:00:00 su - postgres\npostgres 26031 26027  0 Apr24 pts/0    00:00:00 -bash\nroot     26282 26031  0 Apr24 pts/0    00:00:00 su - postgres\npostgres 26286 26282  0 Apr24 pts/0    00:00:00 -bash\npostgres 26404     1  0 Apr24 ?        00:00:01 /usr/local/pg12/bin/postgres\npostgres 26406 26404  0 Apr24 ?        00:00:00 postgres: checkpointer\npostgres 26407 26404  0 Apr24 ?        00:00:02 postgres: background writer\npostgres 26408 26404  0 Apr24 ?        00:00:02 postgres: walwriter\npostgres 26409 26404  0 Apr24 ?        00:00:02 postgres: autovacuum launcher\npostgres 26410 26404  0 Apr24 ?        00:00:03 postgres: stats collector\npostgres 26411 26404  0 Apr24 ?        00:00:00 postgres: logical replication launcher\n</code></pre> <ul> <li>PM \u8fdb\u7a0b </li> </ul> <p>PostMaster\u8fdb\u7a0b\uff0c\u63d0\u4f9b\u76d1\u542c\u3001\u8fde\u63a5\u534f\u8bae\u3001\u9a8c\u8bc1\u529f\u80fd\uff0cfork\u5176\u4ed6\u8fdb\u7a0b\u3002\u76d1\u542c\u54ea\u4e2aIP\u662f\u53d7\u5230postgressql.conf\u5f71\u54cd\u7684\u3002\u9ed8\u8ba4\u63d0\u4f9bsocket\u548cTCP/IP\u65b9\u5f0f\u8fde\u63a5\u3002 </p> <p>\u9a8c\u8bc1\u529f\u80fd\uff0c\u901a\u8fc7<code>pg_hba.conf</code>\u548c\u7528\u6237\u9a8c\u8bc1\u6a21\u5757\u6765\u63d0\u4f9b\u3002 </p> <ul> <li>SP\u8fdb\u7a0b </li> </ul> <p><code>Session Processors</code>\uff0c\u4f1a\u8bdd\u8fdb\u7a0b\u3002\u7528\u6237\u4e00\u65e6\u9a8c\u8bc1\u6210\u529f\u5c31\u4f1afork\u4e00\u4e2a\u65b0\u7684\u8fdb\u7a0b\u3002</p> <ul> <li>BGW\u8fdb\u7a0b </li> </ul> <p><code>background writer</code> \u8fdb\u7a0b\u3002\u4e3b\u8981\u8d1f\u8d23\u540e\u53f0\u5237\u65b0\u810f\u9875\u3002 </p> <ul> <li>Sysloger\u8fdb\u7a0b </li> </ul> <p>\u4e3b\u8981\u8d1f\u8d23\u6570\u636e\u5e93\u72b6\u6001\u7684\u4fe1\u606f\u65e5\u5fd7\u8bb0\u5f55\u3002 </p> <ul> <li>CKPT </li> </ul> <p>\u68c0\u67e5\u70b9\u8fdb\u7a0b</p> <ul> <li>WALW </li> </ul> <p>walwriter\u8fdb\u7a0b\uff0eWAL (Redo)\u65e5\u5fd7\u5237\u5199\u8fdb\u7a0b\u3002 </p> <ul> <li>ARCH </li> </ul> <p>WAL\u65e5\u5fd7\u7684\u5f52\u6863\u65e5\u5fd7\u3002 </p> <p></p> <ul> <li>WM: worker Memory</li> </ul>"},{"location":"pg1/4pg_stru/#_3","title":"\u5185\u5b58\u7ed3\u6784","text":"<p>Architecture and Tuning of Memory in PostgreSQL Databases</p> <p></p> <p></p> <p>Memory in PostgreSQL can be classified into two categories:</p> <ul> <li>Local Memory area: It is allocated by each backend process for its own use.</li> <li> <p>Shared memory area: It is used by all processes of a PostgreSQL server.</p> </li> <li> <p>Shared buffer pool</p> <ul> <li>XLOG: WAL(Write HEAD Log) buffer - PostgreSQL loads pages within tables and indexes from persistent storage to a shared buffer pool, and then operates on them directly.</li> </ul> </li> </ul> <p><code>cat /pgdata/12/data/postgresql.conf</code></p> <pre><code># - Memory -\n\nshared_buffers = 128MB                  # min 128kB\n                                        # (change requires restart)\n</code></pre> <pre><code># Caution: it is not advisable to set max_prepared_transactions nonzero unless\n# you actively intend to use prepared transactions.\n#work_mem = 4MB                         # min 64kB\n#maintenance_work_mem = 64MB            # min 1MB\n</code></pre>"},{"location":"pg1/4pg_stru/#_4","title":"\u5b58\u50a8\u7ed3\u6784","text":""},{"location":"pg1/4pg_stru/#2","title":"2 \u91cd\u70b9\u6587\u4ef6\u4ecb\u7ecd","text":""},{"location":"pg1/4pg_stru/#21","title":"2.1 \u65e5\u5fd7\u6587\u4ef6\u79cd\u7c7b","text":"<ul> <li><code>$PGDATA/log</code> \u8fd0\u884c\u65e5\u5fd7(pg10\u4e4b\u524d\u4e3a<code>$PGDATA/pg_log</code>)</li> <li><code>$PGDATA/pg_wal</code> \u91cd\u505a\u65e5\u5fd7\uff08pg10\u4e4b\u524d\u4e3a<code>$PGDATA/pg_xlog</code>)</li> <li><code>$PGDATA/pg_xact</code> \u4e8b\u52a1\u63d0\u4ea4\u65e5\u5fd7\uff08pg10\u4e4b\u524d\u4e3a<code>$PGDATA/pg_clog</code>)</li> <li>\u670d\u52a1\u5668\u65e5\u5fd7\uff0c\u53ef\u4ee5\u5728\u542f\u52a8\u7684\u65f6\u6307\u5b9a\uff0c\u6bd4\u5982<code>pg_ctl start -l ./alert.log</code> </li> </ul>"},{"location":"pg1/4pg_stru/#22","title":"2.2 \u8fd0\u884c\u65e5\u5fd7\u53c2\u6570","text":""},{"location":"pg1/4pg_stru/#23-csv","title":"2.3 CSV\u65e5\u5fd7\u5165\u5e93\u5b58\u50a8","text":"<pre><code>CREATE TABLE pg_log ( \n    log_time timestamp(3) with time zone, \n    user_name text, \n    database_name text, \n    process_id integer, \n    connection_from text, \n    session_id text, \n    session_line_num bigint, \n    command_tag text, \n    session_start_time timestamp with time zone, \n    virtual_transaction_id text, \n    transaction_id bigint, \n    error_severity text, \n    sql_state_code text, \n    message text, \n    detail text, \n    hint text, \n    internal_query text, \n    internal_query_pos integer, \n    context text, \n    query text, \n    query_pos integer, \n    location text, \n    application_name text, \n    PRIMARY KEY (session_id, session_line_num) \n); \n\n# copy pg_log from '$PGLOG/postgresql-16.csv' with csv; \nCOPY 3 \n</code></pre> <pre><code># - Where to Log -\n\nlog_destination = 'csvlog'              # Valid values are combinations of\n                                        # stderr, csvlog, syslog, and eventlog,\n                                        # depending on platform.  csvlog\n                                        # requires logging_collector to be on.\n\n# This is used when logging to stderr:\nlogging_collector = on          # Enable capturing of stderr and csvlog\n                                        # into log files. Required to be on for\n                                        # csvlogs.\n                                        # (change requires restart)\n\n# These are only used if logging_collector is on:\nlog_directory = 'log'                   # directory where log files are written,\n                                        # can be absolute or relative to PGDATA\nlog_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,\n                                        # can include strftime() escapes\nlog_file_mode = 0600                    # creation mode for log files,\n                                        # begin with 0 to use octal notation\nlog_truncate_on_rotation = on           # If on, an existing log file with the\n                                        # same name as the new log file will be\n                                        # truncated rather than appended to.\n                                        # But such truncation only occurs on\n                                        # time-driven rotation, not on restarts\n                                        # or size-driven rotation.  Default is\n                                        # off, meaning append to existing files\n                                        # in all cases.\nlog_rotation_age = 1d                   # Automatic rotation of logfiles will\n                                        # happen after that time.  0 disables.\nlog_rotation_size = 100MB               # Automatic rotation of logfiles will\n                                        # happen after that much log output.\n</code></pre> <pre><code>[postgres@jabox data]$ pg_ctl restart -mf\nwaiting for server to shut down....2022-04-25 14:46:01.274 UTC [26404] LOG:  received fast shutdown request\n2022-04-25 14:46:01.275 UTC [26404] LOG:  aborting any active transactions\n2022-04-25 14:46:01.284 UTC [26404] LOG:  background worker \"logical replication launcher\" (PID 26411) exited with exit code 1\n2022-04-25 14:46:01.284 UTC [26406] LOG:  shutting down\n2022-04-25 14:46:01.293 UTC [26404] LOG:  database system is shut down\n done\nserver stopped\nwaiting for server to start....2022-04-25 14:46:01.388 UTC [5186] LOG:  starting PostgreSQL 12.6 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-44), 64-bit\n2022-04-25 14:46:01.389 UTC [5186] LOG:  listening on IPv4 address \"0.0.0.0\", port 1921\n2022-04-25 14:46:01.391 UTC [5186] LOG:  listening on Unix socket \"/tmp/.s.PGSQL.1921\"\n2022-04-25 14:46:01.408 UTC [5186] LOG:  redirecting log output to logging collector process\n2022-04-25 14:46:01.408 UTC [5186] HINT:  Future log output will appear in directory \"log\".\n done                                       # 0 disables.\n</code></pre> <pre><code>$ pwd\n/pgdata/12/data/log\n\n-rw-------. 1 postgres postgres 499 Apr 25 14:46 postgresql-2022-04-25_144601.csv\n-rw-------. 1 postgres postgres 166 Apr 25 14:46 postgresql-2022-04-25_144601.log\n-rw-------. 1 postgres postgres   0 Apr 26 00:00 postgresql-2022-04-26_000000.csv\n-rw-------. 1 postgres postgres   0 Apr 26 00:00 postgresql-2022-04-26_000000.log\n</code></pre>"},{"location":"pg1/4pg_stru/#24-postgresqlconf","title":"2.4 postgresql.conf","text":""},{"location":"pg1/4pg_stru/#25-pg_hbaconf","title":"2.5 <code>pg_hba.conf</code>","text":""},{"location":"pg1/4pg_stru/#26-pg_identconf","title":"2.6 <code>pg_ident.conf</code>","text":"<p><code>pg_ident.conf</code> \u662f\u7528\u6237\u6620\u5c04\u914d\u7f6e\u6587\u4ef6\u3002\u7ed3\u5408<code>pg_ident.conf</code>\u4e2d\uff0c<code>method</code>\u4e3a<code>ident</code>\u53ef\u4ee5\u7528\u7279\u5b9a\u7684\u64cd\u4f5c\u7cfb\u7edf\u7528\u6237\u548c\u6307\u5b9a\u7684\u6570\u636e\u5e93\u7528\u6237\u767b\u5f55\u6570\u636e\u5e93\u3002\u5982\u4e0b\uff1a<code>pg_ident.conf</code>\u5982\u4e0b\uff1a </p> <pre><code># MAPNAME  SYSTEM-USERNAME  PG-USERNAME\nmapll      test               sa\n</code></pre> <p><code>pg_hba.conf</code></p> <pre><code># TYPE DATABASE USER CIDR-ADDRESS METHOD  \nlocal  all       all  ident       map=mapll\n</code></pre>"},{"location":"pg1/4pg_stru/#27","title":"2.7 \u63a7\u5236\u6587\u4ef6","text":"<p><code>pg_controldata</code>\u53ef\u4ee5\u67e5\u770b\u63a7\u5236\u6587\u4ef6\u7684\u5185\u5bb9 </p> <pre><code>$ pg_controldata $PGDATA\npg_control version number:            1201\nCatalog version number:               201909212\nDatabase system identifier:           7090014790075388876   #dbid\nDatabase cluster state:               in production    # primary\npg_control last modified:             Mon 25 Apr 2022 02:51:01 PM UTC\nLatest checkpoint location:           0/16547F0\nLatest checkpoint's REDO location:    0/16547B8          # redo \u4f4d\u7f6e\nLatest checkpoint's REDO WAL file:    000000010000000000000001\nLatest checkpoint's TimeLineID:       1\nLatest checkpoint's PrevTimeLineID:   1\nLatest checkpoint's full_page_writes: on\nLatest checkpoint's NextXID:          0:501              #\u4e0b\u4e00\u4e2a\u4e8b\u52a1ID\nLatest checkpoint's NextOID:          16396             #\u4e0b\u4e00\u4e2aOID\nLatest checkpoint's NextMultiXactId:  1\nLatest checkpoint's NextMultiOffset:  0\nLatest checkpoint's oldestXID:        480\nLatest checkpoint's oldestXID's DB:   1\nLatest checkpoint's oldestActiveXID:  501\nLatest checkpoint's oldestMultiXid:   1\nLatest checkpoint's oldestMulti's DB: 1\nLatest checkpoint's oldestCommitTsXid:0\nLatest checkpoint's newestCommitTsXid:0\nTime of latest checkpoint:            Mon 25 Apr 2022 02:51:01 PM UTC\nFake LSN counter for unlogged rels:   0/3E8\nMinimum recovery ending location:     0/0\nMin recovery ending loc's timeline:   0\nBackup start location:                0/0\nBackup end location:                  0/0\nEnd-of-backup record required:        no\nwal_level setting:                    replica         # wal\u7ea7\u522b\nwal_log_hints setting:                off\nmax_connections setting:              100             #\u6700\u5927\u8fde\u63a5\u6570\nmax_worker_processes setting:         8\nmax_wal_senders setting:              10\nmax_prepared_xacts setting:           0\nmax_locks_per_xact setting:           64\ntrack_commit_timestamp setting:       off\nMaximum data alignment:               8\nDatabase block size:                  8192            # wal\u6570\u636e\u5757\u5927\u5c0f\nBlocks per segment of large relation: 131072          # \u5355\u4e2awal\u5927\u5c0f\nWAL block size:                       8192\nBytes per WAL segment:                16777216\nMaximum length of identifiers:        64\nMaximum columns in an index:          32\nMaximum size of a TOAST chunk:        1996\nSize of a large-object chunk:         2048\nDate/time type storage:               64-bit integers\nFloat4 argument passing:              by value\nFloat8 argument passing:              by value\nData page checksum version:           0\nMock authentication nonce:            275b911fecb018c400d191d95acff4b55984ebca021220fbf2ab4f9f994bf67c\n</code></pre>"},{"location":"pg1/4pg_stru/#28","title":"2.8 \u6570\u636e\u6587\u4ef6","text":"<p>pg\u4e2d\uff0c\u6bcf\u4e2a\u7d22\u5f15\u548c\u8868\u90fd\u662f\u4e00\u4e2a\u5355\u72ec\u7684\u6587\u4ef6\uff0cpg\u4e2d\u53eb\u505apage.\u9ed8\u8ba4\u662f\u6bcf\u4e2a\u5927\u4e8e1G\u7684page\u4f1a\u88ab\u5206\u5272<code>pg_class.relfilenode.1</code>\u8fd9\u6837\u7684\u6587\u4ef6\u3002page\u7684\u5927\u5c0f\u5728<code>initdb</code>\u7684\u65f6\u5019\u6307\u5b9a\uff08<code>--with-seg size</code>)\u3002 </p> <p>page\u7269\u7406\u4f4d\u7f6e </p> <p>page\u7684\u7269\u7406\u4f4d\u7f6e\u5728<code>\uff04PGDATA/BASE/DATABASE_OID/PG_CLASS.RELFILENODE</code></p> <pre><code>$ psql\npsql (12.6)\nType \"help\" for help.\npostgres-# \\c pg1\nYou are now connected to database \"pg1\" as user \"postgres\".\npg1-# \\dt\n        List of relations\n Schema | Name | Type  |  Owner\n--------+------+-------+----------\n public | t1   | table | postgres\n(1 row)\n\npg1=# select relfilenode from pg_class where relname='t1';\n relfilenode\n-------------\n       16385\n(1 row)\n\npg1=# select pg_relation_filepath('t1');\n pg_relation_filepath\n----------------------\n base/16384/16385\n(1 row)\n\n\npg1=# select relfilenode from pg_class where relname='t1';\n relfilenode\n-------------\n       16385\n(1 row)\n\npg1=# select pg_relation_filepath('t1');\n pg_relation_filepath\n----------------------\n base/16384/16385\n(1 row)\n\npg1=# show data_directory;\n data_directory\n-----------------\n /pgdata/12/data\n(1 row)\n\npg1=# \\q\n\n[data]$ pwd\n/pgdata/12/data\n[postgres@jabox data]$ ls -ltr  base/16384/16385\n-rw-------. 1 postgres postgres 8192 Apr 24 04:05 base/16384/16385\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c<code>pg_class.relfilenode</code>\u7c7b\u4f3c<code>dba_objects.data_object_id</code>, <code>truncate</code>\u8868\u4e4b\u540e<code>relfilenode</code>\u4f1a\u53d8\u3002\u5bf9\u5e94\u7684\u7269\u7406\u6587\u4ef6\u540d\u5b57\u4e5f\u4f1a\u53d8\u3002</p>"},{"location":"pg1/5pg_bak/","title":"5 \u5907\u4efd\u6062\u590d","text":""},{"location":"pg1/5pg_bak/#51","title":"5.1\u3001\u9700\u8981\u5907\u4efd\u4ec0\u4e48\uff1f","text":"<p>\u6570\u636e / WAL\u65e5\u5fd7 / \u5f52\u6863\u65e5\u5fd7 </p>"},{"location":"pg1/5pg_bak/#52","title":"5.2\u3001\u5907\u4efd\u65b9\u5f0f","text":""},{"location":"pg1/5pg_bak/#521","title":"5.2.1 \u903b\u8f91\u5907\u4efd\u5de5\u5177","text":"<p><code>pg_dump</code> /  <code>pg_dumpall</code></p>"},{"location":"pg1/5pg_bak/#522","title":"5.2.2 \u7269\u7406\u5907\u4efd\u5de5\u5177","text":"<p><code>pg_basebak up</code> </p>"},{"location":"pg1/5pg_bak/#53-pg_basebackup","title":"5.3. <code>pg_basebackup</code>\u7269\u7406\u5907\u4efd\u5de5\u5177\u5e94\u7528","text":""},{"location":"pg1/5pg_bak/#531","title":"5.3.1 \u5907\u4efd","text":"<pre><code>pg_basebackup -D /pgdata/pg_back -Ft -Pv -Upostgres -h 192.168.1.44 -p 1921 -R\n</code></pre> <pre><code>cd $PGDATA\n$ pg_dump -d pg1 &gt; /tmp/pg1.sql\n$ cd /tmp\n$ ll\ntotal 154084\n-rw-rw-r--. 1 postgres postgres 157778626 Apr 27 00:44 pg1.sql\n</code></pre> <pre><code>$ psql &lt; /tmp/pg1.sql\nSET\nSET\nSET\nSET\nSET\n set_config\n------------\n\n(1 row)\n\nSET\nSET\nSET\nSET\nSET\nSET\nCREATE TABLE\nALTER TABLE\nCOPY 20000002\n</code></pre>"},{"location":"pg1/5pg_bak/#532","title":"5.3.2 \u6062\u590d","text":"<pre><code>$ cd /pgdata/\n$ mkdir pg_backup\n$ chown -R postgres. pg_backup/\n\n$ ll -lt\ntotal 0\ndrwxrwxr-x. 2 postgres postgres  6 Apr 27 01:56 pg_backup\n</code></pre> <p><code>vim pg_hba.conf</code></p> <p>add </p> <pre><code>...\nhost    replication     all             0.0.0.0/0               trust\n</code></pre> <pre><code>$ pg_ctl restart -mf\n</code></pre> <pre><code>pg_basebackup -D /pgdata/pg_back -Ft -Pv -Upostgres -h 192.168.1.44 -p 1921 -R\n\n\n$ pg_basebackup -D /pgdata/pg_back -Ft -Pv -Upostgres -h 192.168.1.44 -p 1921 -R\npg_basebackup: initiating base backup, waiting for checkpoint to complete\npg_basebackup: checkpoint completed\npg_basebackup: write-ahead log start point: 0/61000028 on timeline 1\npg_basebackup: starting background WAL receiver\npg_basebackup: created temporary replication slot \"pg_basebackup_18222\"\n1458149/1458149 kB (100%), 1/1 tablespace\npg_basebackup: write-ahead log end point: 0/61000138\npg_basebackup: waiting for background process to finish streaming ...\npg_basebackup: syncing data to disk ...\npg_basebackup: base backup completed\n</code></pre> <pre><code>$ cd /pgdata/pg_back\n$ ls\nbase.tar  pg_wal.tar\n</code></pre> <p>Demo</p> <pre><code>pg_ctl stop -mf\nrm -rf $PGDATA/*\nrm -rf /archive/*\n\ncp base.tar $PGDATA/\ncp pg_wal.tar $PGDATA/archive/\n\ntar xf base.tar -C $PGDATA/12/data\ntar xf pg_wal.tar-C /archive/\n\n\n# vim postgresql.auto.conf\nrestore_command = 'cp /archive/%f %p'\nrecovery_target = 'immediate'\n\npg_ctl start -mf\ntouch $PGDATA/recovery.signal\n</code></pre> <pre><code>select pg_wal_replay_resume()\n</code></pre>"},{"location":"pg1/5pg_bak/#54-pitr","title":"5.4 PITR\u5b9e\u6218\u5e94\u7528","text":""},{"location":"pg1/5pg_bak/#541","title":"5.4.1 \u573a\u666f\u4ecb\u7ecd","text":"<ul> <li>\u6bcf\u592923: 00 PBK\u5907\u4efd\uff0c\u5468\u4e8c\u4e0b\u534814: 00\u8bef\u5220\u9664\u6570\u636e\uff0c\u5982\u4f55\u6062\u590d\uff1f <ul> <li>\u6062\u590d\u5168\u5907\u6570\u636e<code>tar xf -c</code></li> <li>\u5f52\u6863\u6062\u590d\uff1a\u5907\u4efd\u5f52\u6863<code>\uff0b23-14</code>\u533a\u95f4\u7684\u5f52\u6863+\u5728\u7ebfredo </li> </ul> </li> </ul> <pre><code>create database pit;\n\\c pit\n\ncreate table t1(id int);\n\ninsert into t1 values(1);\ninsert into t1 values(111);\ninsert into t1 values(1111);\n\ncreate table t2(id int);\ninsert into t2 values(1);\ninsert into t2 values(2);\n\ndrop database pit;  # drop the table\n</code></pre> <pre><code># change to new log \nselect pg_switch_wal()\n</code></pre> <p>stop server and back up</p> <pre><code>pg_ctl stop -mf\n\nrm -rf $PGDATA/*\nrm -rf /archive/*\n\n\n$ pg_basebackup -D /pgdata/pg_back -Ft -Pv -Upostgres -h 192.168.1.44 -p 1921 -R\ntar xf base.tar -C $PGDATA/12/data\ntar xf pg_wal.tar-C /archive/\n</code></pre> <p>check the XID\uff08traction ID\uff09before the drop action</p> <pre><code>cd /archive/\n\npg_waldump 0000000....XXX\n# the XID before drop is 498\n\n# vim postgresql.auto.conf\nrestore_command = 'cp /archive/%f %p'\nrecovery_target = '498'\n</code></pre> <pre><code>pg_ctl start \n\npostgres=# create database aaaa; ERROR: \ncannot execute CREATE DATABASE in a read-only transaction \n\npostgres=# select  pg_wal_replay_resume(); \npg_wal_replay_resume \n------------------\n(1 row) \n</code></pre>"},{"location":"pg1/5pg_bak/#542","title":"5.4.2 \u5bf9\u4e8e\u98ce\u9669\u6781\u5927\u7684\u64cd\u4f5c\uff0c\u53ef\u4ee5\u9884\u5148\u6267\u884c\u4e00\u4e2a\u7279\u6b8a\u5907\u4efd","text":"<pre><code>postgres=# select pg_create_restore_point('test-before-delete'); \n</code></pre>"},{"location":"pg1/6pg_repl/","title":"6 Master-Slave\u6d41\u590d\u5236","text":""},{"location":"pg1/6pg_repl/#61","title":"6.1 \u57fa\u7840\u73af\u5883\u51c6\u5907","text":"<p>\u89d2\u8272</p> <p></p>"},{"location":"pg1/6pg_repl/#62","title":"6.2 \u8bbe\u7f6e\u914d\u7f6e\u6587\u4ef6","text":"<p>Master\u8282\u70b9 </p> <pre><code>\uff03\u521b\u5efa\u7528\u6237 \ncreate role replica with replication login password '123456'\naleter user replica with password '123456'\n\n\n\uff03\u4fee\u6539pg_hba.conf \nhost replication replica 0.0.0.0/0 md5 \n\n\n\uff03\u4fee\u6539\u914d\u7f6e\uff1a \nwal_level = replica       #\u8fd9\u4e2a\u662f\u8bbe\u7f6e\u4e3b\u4e3awal\u7684\u4e3b\u673a\nmax_wal_sender = 5        #\u8fd9\u4e2a\u8bbe\u7f6e\u4e86\u53ef\u4ee5\u6700\u591a\u6709\u51e0\u4e2a\u6d41\u590d\u5236\u8fde\u63a5\uff0c\u5dee\u4e0d\u591a\u6709\u51e0\u4e2a\u4ece\uff0c\u5c31\u8bbe\u7f6e\u51e0\u4e2a \nwal_keep_segments = 128  \uff03\u8bbe\u7f6e\u6d41\u590d\u5236\u4fdd\u7559\u7684\u6700\u591a\u7684xlog\u6570\u76ee \nwal_sender_timeout = 60s \uff03\u8bbe\u7f6e\u6d41\u590d\u5236\u4e3b\u673a\u53d1\u9001\u6570\u636e\u7684\u8d85\u65f6\u65f6\u95f4 \nmax_connections=200      \uff03\u4e00\u822c\u67e5\u591a\u4e8e\u5199\u7684\u5e94\u7528\u4ece\u5e93\u7684\u6700\u5927\u8fde\u63a5\u6570\u8981\u6bd4\u8f83\u5927 \nhot_standby=on           \uff03 \u8bf4\u660e\u8fd9\u53f0\u673a\u5668\u4e0d\u4ec5\u4ec5\u662f\u7528\u4e8e\u6570\u636e\u5f52\u6863\uff0c\u4e5f\u7528\u4e8e\u6570\u636e\u67e5\u8be2 \nmax_standby_streaming_delay=30s  \uff03\u6570\u636e\u6d41\u5907\u4efd\u5206\u7684\u6700\u5927\u5ef6\u8fdf\u65f6\u95f4 \nwal_receiver_status_interval=10s \uff03\u591a\u4e45\u5411\u62a5\u544a\u4e00\u6b21\u4ece\u7684\u72b6\u6001\uff0c\u5f53\u7136\u4ece\u6bcf\u6b21\u6570\u636e\u590d\u5236\u90fd\u4f1a\u5411\u4e3b\u62a5\u544a\u72b6\u6001\uff0c\u8fd9\u91cc\u53ea\u662f\u8bbe\u7f6e\u6700\u957f\u7684\u95f4\u9694\u65f6\u95f4 \nhot_stand_feedback = on   \uff03\u5982\u679c\u6709\u9519\u8bef\u7684\u6570\u636e\u590d\u5236\uff0c\u662f\u5426\u5411\u738b\u8fdb\u884c\u53cd\u9988 \nwal_log_hints = on        #also do full page writes of non-critical updates \n</code></pre> <p>standby\u8282\u70b9 </p> <pre><code>\uff03\u6e05\u7a7a\u6570\u636e\u548c\u5f52\u6863 \nrm -rf /pgdata/12/data/* \nrm -rf /archive/* \n\n\uff03\u5907\u4efd\u4e3b\u5e93\u6570\u636e\u5230\u5907\u5e93 \npg_basebackup -D /pgdata/pg_back -Ft -Pv -Upostgres -h 192.168.1.44 -p 1921 -R\n\n\n\uff03\u89e3\u538b\u6570\u636e \n[pg_back] tar xf base.tar -C /pgdata/12/data/\n[pg_back] tar xf pg_wal.tar -C /archive/ \n\n\uff03\u4fee\u6539standby.signal\u6587\u4ef6\uff1a \nstandby_mode = 'on' \n\n\uff03\u4fee\u6539postgresql.conf\u6587\u4ef6\uff1a \nprimary_conninfo = 'host=192.168.1.44 port=1921 user=replica password=123456'\nrecovery_target_timeline = latest  \uff03\u9ed8\u8ba4 \nmax_connection = 120  \uff03\u5927\u4e8e\u7b49\u4e8e\u4e3b\u8282\u70b9\uff0c\u6b63\u5f0f\u73af\u5883\u5e94\u5f53\u91cd\u65b0\u8003\u8651\u6b64\u503c\u7684\u5927\u5c0f \nhot_standby = on\nmax_standby_streaming_delay = 30s \nwal_receiver_status_interval = 1Os \nhot_standby_feedback = on \nmax_wal_senders = 15 \nlogging_collector = on\nlog_directory = 'pg_log' \nlog_filename = 'postgresgl-%Y-%m-%d_%H%M%S.log' \n</code></pre> <pre><code># \u4fee\u6539 postgresql.auto.conf \nrestore_command = 'cp /archive/%f %p' \nprimary_conninfo = 'user=postgres password=123456 host=192.168.1.44 port=1921 sslmode=disable sslcompression=0 gssencmode=disable krbsrvname=postgres target_session_attrs=any' \n</code></pre>"},{"location":"pg1/6pg_repl/#63","title":"6.3 \u76d1\u63a7\u72b6\u6001","text":"<pre><code># \u4e3b\u5e93\npostgres=# select pid,state,client_addr,sync_priority,sync_state from pg_stat_replication; \n\n\n# \u4ece\u5e93\npsql -c \"\\x\" -c \"SELECT * FROM pg_stat_wal_receiver;\" \n</code></pre>"},{"location":"pg1/7pg_ops/","title":"7 \u6709\u7528\u7684\u7cfb\u7edf\u51fd\u6570","text":""},{"location":"pg1/7pg_ops/#7","title":"7 \u6709\u7528\u7684\u7cfb\u7edf\u51fd\u6570","text":"<pre><code>\u67e5\u770b\u5f53\u524d\u65e5\u5fd7\u6587\u4ef6lsn\u4f4d\u7f6e\uff1a \nselect pg_current_xlog_location(); \nselect pg_current_wal_lsn(); \n\n\n\u5f53\u524dxlog buffet \u4e2d\u7684insert\u4f4d\u7f6e\uff0c\u6ce8\u610f\u548c\u4e0a\u9762pg_current_xlog_location()\u7684\u533a\u522b\uff1a \nselect pg_current_xlog_insert_location(); \n\n\n\u67e5\u770b\u67d0\u4e2alsn\u5bf9\u5e94\u7684\u65e5\u5fd7\u540d\uff1a \nselect pg_xlogfile_name(lsn)\nselect pg_walfile_name(lsn)\n\n\n\u67e5\u770b\u67d0\u4e2alsn\u5728\u65e5\u5fd7\u4e2d\u7684\u504f\u79fb\u91cf\uff1a \nselect pg_xlogfile_name_offset('lsn'); \nselect pg_walfile_name_offset('lsn'); \n\n\n\u67e5\u770b\u4e24\u4e2alsn\u4f4d\u7f6e\u7684\u5dee\u8ddd\uff1a \nselect pg_xlog_location_diff('lsn','lsn');\nselect pg_wal_lsn_diff('lsn','lsn');\n\n\n\u67e5\u770b\u5907\u5e93\u63a5\u6536\u5230\u7684lsn\u4f4d\u7f6e\uff1a \nselect pg_last_xlog_receive_location(); \nselect pg_last_wal_receive_lsn(); \n\n\n\u67e5\u770b\u5907\u5e93\u653e\u56delsn\u4f4d\u7f6e\uff1a \nselect pg_last_xlog_relay_location(); \nselect pg_last_xact_replay_timestamp(); \n\n\n\u521b\u5efa\u8fd8\u539f\u70b9\uff1a \nselect pg_create_restore_point('20201111'); \n\n\u67e5\u770b\u8868\u7684\u6570\u636e\u6587\u4ef6\u8def\u5f84\uff0cfilenode: \nselect pg_relation_filepath('test'::regclass); \nselect pg_relation_filenode('test'); \n\n\n\u67e5\u770b\u8868\u7684oid: \nselect 'test'::reglass::oid; \n\n\u67e5\u770b\u5f53\u524d\u4f1a\u8bddpid: \nselect pg_backenk_pid(); \n\n\u751f\u6210\u5e8f\u5217\uff1a \nselect gernate_series(1,8,2); \n\n\u751f\u6210uuid(pg13\u65b0\u7279\u6027\uff09 \nselect gen_randonm_uuid(); \n\n\u91cd\u8f7d\u914d\u7f6e\u6587\u4ef6\u4fe1\u606f \nselect pg_reload_conf(); \n\n\u67e5\u770b\u6570\u636e\u5e93\u542f\u52a8\u65f6\u95f4\uff1a \nselect pg_postmaster_start_time(); \n\n\u67e5\u770b\u7528\u6237\u8868\u3001\u5217\u7b49\u6743\u9650\u4fe1\u606f\uff1a \nselect has_any_column_privilege(user, table, privilege); \nselect has_any_column_privilege(table, privilege); \n\n\u67e5\u770b\u5f53\u524d\u5feb\u7167\u4fe1 \nselect txid_current_snapshot() \n\n\u5207\u6362\u4e00\u4e2a\u8fd0\u884c\u65e5\u5fd7\uff1a \nselect pg_rotate_logfile(); \n\n\u6682\u505c\u3001\u6062\u590d\u56de\u8bbf\u8fdb\u7a0b\uff1a \nselect pg_xlog_replay_pause(); \nselect pg_xlog_replay_resume(); \n\n\u5bfc\u51fa\u4e00\u4e2a\u5feb\u7167\uff1a \nselect pg_export_snapshot(); \n\n\u67e5\u770b\u5bf9\u8c61\u7684\u5927\u5c0f\u4fe1\u606f\uff1a \nselect pg_relation_size(); \nselect pg_table_size(); \nselect pg_total_relation_size(); \n\n\u7269\u7406\u3001\u903b\u8f91\u590d\u5236\u69fd\uff1a \npg_create/drop_physical_replication_slot(slotname); \npg_create_logical_replication_slot(slotname, decodingname); \npg_logical_slot_get_changes(); \n</code></pre>"}]}